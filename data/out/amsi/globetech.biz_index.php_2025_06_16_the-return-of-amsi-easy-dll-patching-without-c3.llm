Title:
The Return of AMSI: Easy DLL Patching Without C3

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post analyzes newer Microsoft Defender/MDE detections (late 2024+) that flag common AMSI and ETW patching patterns used by loaders (notably Donut-based) and C2 frameworks.  
- The author finds detections are strongly tied to static byte signatures—especially patches that write `RET` (`0xC3`) into `amsi!AmsiScanBuffer` or `ntdll!EtwEventWrite`—rather than the general act of writing memory.  
- It presents alternative “return without RET” patch primitives such as `pop reg; jmp reg` (e.g., `58 FF E0`) and obfuscated variants, which preserve the effect (early function exit) while avoiding the flagged bytes.  
- Additional techniques include short/near JMPs to an existing nearby `C3` in the module (so you execute a RET without writing one) and a CALL-based approach using a ROP-style `pop reg; ret` gadget.  
- The post highlights version-specific differences in `amsi.dll` layout (Win10 vs Win11/24H2), motivating automation to locate suitable gadgets/RET targets dynamically.  
- It culminates in releasing BOF tooling (“AutoPatch”) for Cobalt Strike/Sliver to read/write function bytes and automatically find a nearby `C3` and compute the required JMP displacement.  
- Useful for red teams and pentesters who rely on in-memory .NET post-ex tooling and need AMSI/ETW bypasses that evade modern signature-based detections.

Technical Focus:
- AMSI patching of `AmsiScanBuffer` without writing `RET (0xC3)`
- ETW patching of `ntdll!EtwEventWrite`
- Instruction-level patch alternatives: `pop; jmp`, short/near JMP displacement, CALL + ROP gadget (`pop reg; ret`)
- Static signature evasion via byte-level patch variation/obfuscation
- Windows DLL version/layout differences (Win10 22H2 vs Win11 24H2)
- BOF-based automation for memory read/write and patch generation

Use Cases:
- Patch AMSI/ETW in a beacon/implant process while avoiding Defender’s common patch signatures
- Enable in-memory loading/execution of C# tooling (e.g., Rubeus/SharpHound/Certify) under MDE
- Automate discovery of safe JMP/ROP targets near sensitive functions across Windows versions
- Build/validate defensive detections for suspicious `amsi.dll` loading or memory patch behaviors

Keywords:
AMSI, AmsiScanBuffer, ETW, EtwEventWrite, Microsoft Defender for Endpoint, MDE, Donut, Cobalt Strike, Sliver, BOF, in-memory patching, opcode 0xC3, RET evasion, pop jmp gadget, short jump EB, near jump E9, ROP gadget, DLL exports spoofing, amsi.dll version differences