Title:
Patchless AMSI Bypass via Page Guard Exceptions

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post presents a “patchless” AMSI bypass that uses PAGE_GUARD memory protection on the page containing `AmsiScanBuffer` to trigger exceptions whenever the function is executed.  
- A Vectored Exception Handler (VEH) catches `STATUS_GUARD_PAGE_VIOLATION`, sets the out-parameter `AMSI_RESULT*` to `AMSI_RESULT_CLEAN`, and forces an early return by manipulating `RSP`/`RIP` to skip AMSI’s scanning logic.  
- Because guard pages are one-shot, the technique sets the CPU single-step flag to generate `STATUS_SINGLE_STEP` and reapply `PAGE_GUARD` via `NtProtectVirtualMemory`.  
- The author provides a position-independent shellcode PoC (dynamic API resolution via PEB parsing, waits for `amsi.dll` to load) and an “in-PowerShell” variant implemented by compiling C# with `Add-Type`.  
- It’s primarily useful for red teamers/pentesters and offensive tool developers looking for AMSI evasion methods that avoid classic inline patching patterns and can reduce certain EDR detections.

Technical Focus:
- PAGE_GUARD / guard page exceptions (`STATUS_GUARD_PAGE_VIOLATION`)
- Vectored Exception Handling (VEH) and exception-chain ordering
- Single-step flag / `STATUS_SINGLE_STEP` for re-arming guard pages
- `AmsiScanBuffer` calling convention and stack-based parameter manipulation
- `NtProtectVirtualMemory`, `RtlAddVectoredExceptionHandler` (ntdll) and PEB-based API resolution
- Shellcode constraints (position independence, no globals) vs. managed C# implementation details (GC pinning/delegate lifetime)

Use Cases:
- Bypassing AMSI scanning in PowerShell-hosted payload execution
- Shellcode-based AMSI evasion inside AMSI-consuming processes without inline patching
- Researching/validating EDR telemetry around guard pages, VEHs, and abnormal control-flow returns
- Building alternative AMSI bypass primitives for loaders/implants (e.g., reflective .NET assembly execution)

Keywords:
AMSI, AmsiScanBuffer, PAGE_GUARD, STATUS_GUARD_PAGE_VIOLATION, STATUS_SINGLE_STEP, Vectored Exception Handler, VEH, EFLAGS trap flag, NtProtectVirtualMemory, RtlAddVectoredExceptionHandler, ntdll.dll, PEB parsing, VirtualProtect, control-flow manipulation, RIP/RSP, shellcode, PowerShell Add-Type, C# interop, Microsoft Defender for Endpoint, reflective assembly load