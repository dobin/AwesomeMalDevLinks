Title:
Refining Detection: New Perspectives on ETW Patching Telemetry

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post revisits ETW patching (disabling ETW by patching functions like `ntdll!EtwEventWrite` / `ntdll!NtTraceEvent`) and focuses on practical detection telemetry rather than the patch bytes themselves.  
- It explains that local ETW patching typically requires changing page protections (e.g., RX → RWX) via `VirtualProtect` because `ntdll` code sections are not writable by default.  
- The author highlights ETW Threat Intelligence (TI) provider events that expose these protection changes, especially EID 7 for local `VirtualProtect` activity, including metadata like base address, region size, protection masks, and call stack.  
- A key detection angle is spotting unusually small protection changes (e.g., 2 bytes for a common `RET` patch `0xC3 0x00`) and/or a suspicious “flip-flop” sequence (RX→RWX→RX) on the same address.  
- For remote patching, the post maps the typical sequence (`NtProtectVirtualMemory` + `NtWriteVirtualMemory`/`WriteProcessMemory`) to TI provider telemetry (e.g., EID 2 for remote protect and EID 14 for remote writes) and suggests correlating these events in order.  
- It’s most useful for detection engineers/blue teams building ETW-based analytics, and for red teams to understand what telemetry their ETW-disabling tradecraft may generate.

Technical Focus:
- ETW patching of `EtwEventWrite` / `NtTraceEvent` in `ntdll.dll`
- Memory protection transitions (PAGE_EXECUTE_READ ↔ PAGE_EXECUTE_READWRITE / PAGE_READWRITE)
- ETW Threat Intelligence provider telemetry (EIDs 7, 2, 14)
- Local vs remote process patching mechanics
- Call stack/contextual correlation of protection-change + write sequences
- RegionSize heuristics (small-byte patches vs page-sized changes)

Use Cases:
- Build detections for ETW tampering via protection-mask change telemetry
- Correlate RX→RWX→RX patterns on sensitive code regions (e.g., `ntdll` ETW APIs)
- Detect remote patching / injection workflows using protect+write+revert sequences
- Create hunting queries keyed on small RegionSize changes and suspicious call stacks
- Validate EDR telemetry coverage using tools like ETWInspector/TelemetrySource

Keywords:
ETW, ETW patching, ntdll.dll, EtwEventWrite, NtTraceEvent, VirtualProtect, NtProtectVirtualMemory, WriteProcessMemory, NtWriteVirtualMemory, PAGE_EXECUTE_READ, PAGE_EXECUTE_READWRITE, PAGE_READWRITE, memory protection, function patching, process injection, ETW Threat Intelligence provider, THREATINT_PROTECTVM_LOCAL, EID 7, EID 2, EID 14, call stack, RegionSize, telemetry correlation