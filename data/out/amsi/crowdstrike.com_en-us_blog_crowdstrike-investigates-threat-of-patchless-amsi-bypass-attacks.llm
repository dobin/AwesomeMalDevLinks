Title:
CrowdStrike Researchers Investigate the Threat of Patchless AMSI Bypass Attacks

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post analyzes “patchless” AMSI bypass techniques that avoid in-memory patching of `AmsiScanBuffer` and instead redirect execution flow to evade common integrity/telemetry detections.  
- It explains how attackers combine hardware breakpoints (DR0–DR3) with Windows Vectored Exception Handling (VEH) to intercept `AmsiScanBuffer` via `EXCEPTION_SINGLE_STEP` and return a benign scan result without modifying code pages.  
- The authors show that many public implementations rely on `SetThreadContext`/`NtSetContextThread` to set debug registers, which is detectable via ETW (`Microsoft-Windows-Kernel-Audit-API-Calls`, Event ID 4).  
- They introduce a quieter variant, “VEH²”, which sets the hardware breakpoint by editing the current thread’s `CONTEXT` inside a first VEH triggered by `DebugBreak` (`EXCEPTION_BREAKPOINT`), avoiding `NtSetContextThread` entirely.  
- The post provides a hunting PoC using ETW to detect `NtSetContextThread` usage and discusses why this telemetry remains useful even when user-mode hooks are removed.  
- It’s most useful for red teamers/malware researchers studying AMSI evasion tradecraft and for defenders building detections around exception-flow and context-manipulation behaviors.

Technical Focus:
- AMSI internals and `AmsiScanBuffer` interception
- Hardware breakpoints (x86/x64 debug registers DR0–DR3)
- Vectored Exception Handling (VEH), `EXCEPTION_SINGLE_STEP`, `EXCEPTION_BREAKPOINT`
- Thread `CONTEXT` manipulation, `SetThreadContext` / `NtSetContextThread`, `NtContinue`
- ETW-based detection using `Microsoft-Windows-Kernel-Audit-API-Calls`
- NTDLL exception dispatch flow (`KiUserExceptionDispatcher`, `RtlDispatchException`, `RtlGuardRestoreContext`)

Use Cases:
- Detecting patchless AMSI bypass attempts by monitoring `NtSetContextThread` via ETW
- Building behavioral detections for VEH registration + debug-exception patterns
- Red team research into lower-noise AMSI bypass primitives (execution-flow manipulation vs memory patching)
- Threat hunting for tools that abuse thread context changes (injection, thread hijacking, HWBP-based hooks)

Keywords:
AMSI, Antimalware Scan Interface, AmsiScanBuffer, patchless bypass, hardware breakpoint, DR0, DR1, DR2, DR3, Vectored Exception Handler, VEH, EXCEPTION_SINGLE_STEP, EXCEPTION_BREAKPOINT, DebugBreak, CONTEXT, RIP, SetThreadContext, NtSetContextThread, NtContinue, ETW, Microsoft-Windows-Kernel-Audit-API-Calls, KiUserExceptionDispatcher, RtlDispatchException, T1562.001