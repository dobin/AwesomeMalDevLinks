# https://patchmypc.com/blog/windows-11-24h2-applocker-powershell-constrained-language-broken/

<!DOCTYPE html><html lang="en-US">

<body class="wp-singular post-template-default single single-post postid-140840 single-format-standard wp-theme-pmpc-theme mega-menu-main clth-show-icon-mobile clth-show-icon-desktop"><div id="hs-web-interactives-top-push-anchor" class="go3670563033"></div>

        
        
                
    
        
        
            <main id="page" class="site">

                
                <div id="page-content" class="">

                        
                        
	<div id="primary" class="content-area">

		
<article role="article" id="post-140840" class="post-140840 post type-post status-publish format-standard has-post-thumbnail hentry category-blog">

	
    <div class="entry-content">
        <div class="container">
            <div class="row">
	                                <div class="col-12 col-lg-4 order-lg-2">
			            <div id="post-table-of-contents" style="display: block;">
	<div class="post-toc-widget-header">
		<div class="post-toc-widget-title">
			Table of Contents		</div>
		<div class="post-toc-widget-toggle active">
			<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none">
				<path d="M13.4992 11.6251C13.4005 11.6257 13.3026 11.6067 13.2112 11.5694C13.1199 11.5321 13.0367 11.4771 12.9667 11.4076L9.53166 7.9651C9.46194 7.89481 9.37899 7.83901 9.2876 7.80094C9.1962 7.76286 9.09817 7.74326 8.99916 7.74326C8.90015 7.74326 8.80212 7.76286 8.71073 7.80094C8.61934 7.83901 8.53639 7.89481 8.46666 7.9651L5.03166 11.4076C4.89043 11.5488 4.69889 11.6282 4.49916 11.6282C4.29944 11.6282 4.10789 11.5488 3.96666 11.4076C3.82543 11.2664 3.74609 11.0748 3.74609 10.8751C3.74609 10.7762 3.76557 10.6783 3.80342 10.5869C3.84126 10.4955 3.89673 10.4125 3.96666 10.3426L7.40916 6.90761C7.83662 6.49693 8.4064 6.26758 8.99916 6.26758C9.59193 6.26758 10.1617 6.49693 10.5892 6.90761L14.0317 10.3426C14.102 10.4123 14.1578 10.4953 14.1958 10.5867C14.2339 10.6781 14.2535 10.7761 14.2535 10.8751C14.2535 10.9741 14.2339 11.0721 14.1958 11.1635C14.1578 11.2549 14.102 11.3379 14.0317 11.4076C13.9616 11.4771 13.8785 11.5321 13.7871 11.5694C13.6957 11.6067 13.5979 11.6257 13.4992 11.6251Z" fill="#ABADCF"></path>
			</svg>
		</div>
	</div>
	<div class="post-toc-widget-body active">
                    <div class="post-toc-heading-item">
                        <div class="post-toc-heading-item-title">
                            <div class="post-toc-heading-item-link" data-anchor="note-this-also-affects-windows-server">⚠️ Note: This Also Affects Windows Server</div>
                        </div>
                    </div>
                
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="h-applocker-why-application-control-matters">Applocker: Why Application Control Matters</div>
                        
                    </div>
                    </div>
            
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="h-full-language-mode-vs-constrained-language-mode-in-powershell">Full Language Mode vs Constrained Language Mode in PowerShell</div>
                        
                    </div>
                    </div>
            
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="h-how-powershell-determines-language-mode-based-on-applocker-script-rules">How PowerShell Determines Language Mode Based on AppLocker Script Rules</div>
                        
                    </div>
                    </div>
            
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="h-constrained-language-mode-windows-11-24h2-and-applocker">Constrained Language Mode Windows 11 24H2 and Applocker</div>
                        
                    </div>
                    </div>
            
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="h-system-management-automation-dll-in-windows-11-24h2">System.Management.Automation.dll in Windows 11 24h2</div>
                        
                    </div>
                    </div>
            
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="h-windows-11-24h2-a-closer-look-at-wldpcanexecutefile">Windows 11 24H2: A Closer Look at WLDPCanExecuteFile</div>
                        
                    </div>
                    </div>
            
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="h-how-wldpcanexecutefile-changes-script-evaluation-in-applocker">How WldpCanExecuteFile Changes Script Evaluation in Applocker</div>
                        
                    </div>
                    </div>
            
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="h-why-applocker-script-enforcement-breaks">Why AppLocker Script Enforcement Breaks</div>
                        
                    </div>
                    </div>
            
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="h-a-note-about-powershell-5-1-and-wldp">A Note About PowerShell 5.1 and WLDP</div>
                        
                    </div>
                    </div>
            
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="h-a-quick-note-about-powershell-7">A Quick Note About PowerShell 7</div>
                        
                    </div>
                    </div>
            
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="h-why-manual-dll-replacement-is-not-a-real-solution">Why Manual DLL Replacement Is Not a Real Solution</div>
                        
                    </div>
                    </div>
            
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="h-moving-to-windows-defender-application-control-wdac">Moving to Windows Defender Application Control (WDAC)</div>
                        
                    </div>
                    </div>
            
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="how-microsoft-fixed-the-broken-enforcement">How Microsoft Fixed the Broken Enforcement</div>
                        
                    </div>
                    </div>
            
                <div class="post-toc-heading-item">
                    <div class="post-toc-heading-item-title">
                        <div class="post-toc-heading-item-link" data-anchor="h-conclusion">Conclusion:</div>
                        
                    </div>
                    </div>
            </div>
</div>

                        <div class="d-none d-lg-block">
				            				                                    </div>
                    </div>
	                            <div class="col-12 col-lg-8 order-lg-1">
	                                        <div class="post-thumbnail">
                            <picture class="attachment-full size-full wp-post-image" decoding="async" fetchpriority="high">
<source type="image/webp" srcset="https://patchmypc.com/app/uploads/2025/05/Windows-11-24H2-AppLocker-script-enforcement-broken-scaled-e1745743841369.jpg.webp 640w, https://patchmypc.com/app/uploads/2025/05/Windows-11-24H2-AppLocker-script-enforcement-broken-scaled-e1745743841369-300x169.jpg.webp 300w" sizes="(max-width: 640px) 100vw, 640px">
<img width="640" height="360" src="https://patchmypc.com/app/uploads/2025/05/Windows-11-24H2-AppLocker-script-enforcement-broken-scaled-e1745743841369.jpg" alt="Windows 11 24H2 AppLocker script enforcement broken" decoding="async" fetchpriority="high">
</picture>
                        </div>
	                
                    <div class="post-content">
	                    <p>If you are moving devices to <strong>Windows 11 24H2</strong>, there is a <strong>critical security problem</strong> you should know about. On Windows 11 24H2, Constrained Language Mode is no longer enforced correctly when using AppLocker Script Rules. </p>



<p>PowerShell scripts that should be heavily restricted now run fully unrestricted in Full Language Mode. This opens up a major security enforcement gap that administrators need to understand and mitigate before upgrading to Windows 24h2.</p>



<h3 class="wp-block-heading" id="note-this-also-affects-windows-server">⚠️ Note: This Also Affects Windows Server<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h3>



<p>This enforcement issue isn’t limited to Windows 11 24H2. It also affects <strong>Windows Server editions based on the same 24H2 build</strong>, such as <strong>Windows Server 2025</strong>. If you’re using AppLocker script rules to lock down PowerShell on Windows Server 2025, be aware: <strong>PowerShell scripts will also run in Full Language Mode</strong>, bypassing the expected Constrained Language Mode restrictions.<br></p>



<h2 class="wp-block-heading" id="h-applocker-why-application-control-matters">Applocker: Why Application Control Matters<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>Application control is a critical part of securing Windows environments. Blocking unauthorized code from running is one of the most effective ways to reduce attack surface, prevent lateral movement, and stop exploits that rely on executing new or modified binaries. AppLocker allows organizations to define exactly which executables, installers, and scripts are permitted. In addition to managing traditional applications, AppLocker can also apply control over scripts such as PowerShell scripts and batch files.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;6995993696916&quot;}" data-wp-interactive="core/image" data-wp-key="6995993696916" class="wp-block-image size-full is-resized "><a href="https://patchmypc.com/app/uploads/2025/05/image-15-1.png" data-fancybox="post-gallery" data-caption="applocker script rules configured"><img decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://patchmypc.com/app/uploads/2025/05/image-15-1.png" alt="applocker script rules configured" class="wp-image-130624" style="width:413px;height:auto"></a></figure>



<p>By enforcing AppLocker script rules, administrators can ensure that only trusted, intended automation runs across devices, reducing the risk of abuse through scripting engines like PowerShell. This is achieved by enforcing Constrained Language Mode inside PowerShell. Let’s zoom in on that first!</p>



<h2 class="wp-block-heading" id="h-full-language-mode-vs-constrained-language-mode-in-powershell">Full Language Mode vs Constrained Language Mode in PowerShell<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>When PowerShell scripts are allowed to run without restriction, PowerShell operates in Full Language Mode. In this mode, scripts have access to the full capabilities of the platform, including .NET libraries, direct API calls, and dynamic code execution. </p>



<p>Constrained Language Mode provides a much more limited environment. Scripts running under CLM are restricted to basic cmdlets and approved types. They cannot create new .NET objects, access external libraries, or perform advanced operations that could compromise a device. This mode is critical for ensuring that even if a script runs, privileges cannot be escalated easily.</p>



<figure class="wp-block-table"><table class="has-fixed-layout"><tbody><tr><th colspan="1" rowspan="1"><p>Feature</p></th><th colspan="1" rowspan="1"><p>Full Language Mode</p></th><th colspan="1" rowspan="1"><p>Constrained Language Mode</p></th></tr><tr><td colspan="1" rowspan="1"><p>Access to .NET APIs</p></td><td colspan="1" rowspan="1"><p>Full access</p></td><td colspan="1" rowspan="1"><p>Blocked</p></td></tr><tr><td colspan="1" rowspan="1"><p>Create custom types</p></td><td colspan="1" rowspan="1"><p>Allowed</p></td><td colspan="1" rowspan="1"><p>Blocked</p></td></tr><tr><td colspan="1" rowspan="1"><p>P/Invoke and native calls</p></td><td colspan="1" rowspan="1"><p>Allowed</p></td><td colspan="1" rowspan="1"><p>Blocked</p></td></tr><tr><td colspan="1" rowspan="1"><p>Reflection and dynamic code</p></td><td colspan="1" rowspan="1"><p>Allowed</p></td><td colspan="1" rowspan="1"><p>Blocked</p></td></tr><tr><td colspan="1" rowspan="1"><p>Use basic cmdlets</p></td><td colspan="1" rowspan="1"><p>Allowed</p></td><td colspan="1" rowspan="1"><p>Allowed</p></td></tr></tbody></table></figure>



<p>For a deeper technical explanation of how Constrained Language Mode works, refer to the <a href="https://patchmypc.com/constrained-language-mode-and-custom-detection-scripts" target="_self" rel="noopener noreferrer">Patch My PC blog here.</a></p>



<h2 class="wp-block-heading" id="h-how-powershell-determines-language-mode-based-on-applocker-script-rules">How PowerShell Determines Language Mode Based on AppLocker Script Rules<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>When PowerShell starts, it checks whether<strong><a href="https://call4cloud.nl/deploying-applocker-intune-powershell/"> AppLocker Script Enforcement </a></strong>Rules are present. It does this by simulating the execution of a test PowerShell script placed in the user’s temporary folder and evaluating it against the system’s policies. As shown below, the DLL (System.Management.Automation.dll) responsible for PowerShell shows this behavior.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;6995993696ba8&quot;}" data-wp-interactive="core/image" data-wp-key="6995993696ba8" class="wp-block-image "><a href="https://patchmypc.com/app/uploads/2025/05/7719df1b-38ef-49fa-ac19-1b5299d3cc75.png" data-fancybox="post-gallery" data-caption="the function for the psscriptpolicytest in powershell"><img decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://patchmypc.com/app/uploads/2025/05/7719df1b-38ef-49fa-ac19-1b5299d3cc75.png" alt="the function for the psscriptpolicytest in powershell"></a></figure>



<p>This means that if AppLocker’s rules block or restrict the test PS1 file, PowerShell automatically switches into Constrained Language Mode. </p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;6995993696d13&quot;}" data-wp-interactive="core/image" data-wp-key="6995993696d13" class="wp-block-image "><a href="https://patchmypc.com/app/uploads/2025/05/a5342d7d-9961-4c20-8363-e2228a4b7421.png" data-fancybox="post-gallery" data-caption="applocker checking the test powershell script to determine if it needs to run in Constrained Language Mode"><picture decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles">
<source type="image/webp" srcset="https://patchmypc.com/app/uploads/2025/05/a5342d7d-9961-4c20-8363-e2228a4b7421.png.webp">
<img decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://patchmypc.com/app/uploads/2025/05/a5342d7d-9961-4c20-8363-e2228a4b7421.png" alt="applocker checking the test powershell script to determine if it needs to run in Constrained Language Mode">
</picture>
</a></figure>



<p>If no restrictions apply, PowerShell Scripts will be executed in full language mode. This automatic detection has worked reliably for years and has been a simple way to enforce script safety without needing extra configuration inside PowerShell itself.</p>



<h2 class="wp-block-heading" id="h-constrained-language-mode-windows-11-24h2-and-applocker">Constrained Language Mode Windows 11 24H2 and Applocker<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>With Windows 11 24H2, this behavior has quietly changed. Even with AppLocker Script Rules correctly configured and enforced, PowerShell scripts are no longer executed in contained language mode but in Full language mode,  which creates a significant security concern.</p>



<p>To find out what changed, we performed some tests.  We first executed this PowerShell command from a user session with Applocker script enforcement active.</p>



<pre class="wp-block-code" style="position: relative;"><code>$ExecutionContext.SessionState.LanguageMode
[System.Console]::WriteLine("Hello")</code><button class="copy-code-button" type="button">Copy</button></pre>



<p>As shown below, it first indeed showed us that constrainedlanguage was active and it blocked the WriteLine command, mentioning that the method invocation is not supported.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;6995993696efa&quot;}" data-wp-interactive="core/image" data-wp-key="6995993696efa" class="wp-block-image "><a href="https://patchmypc.com/app/uploads/2025/05/2ce4f404-fe4b-4f26-956b-a498f37e14ac.png" data-fancybox="post-gallery" data-caption="Constrained Language Mode is NOT active when running a powershell script in windows 11 24h2 with applocker enforcement turned on"><picture decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles">
<source type="image/webp" srcset="https://patchmypc.com/app/uploads/2025/05/2ce4f404-fe4b-4f26-956b-a498f37e14ac.png.webp">
<img decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://patchmypc.com/app/uploads/2025/05/2ce4f404-fe4b-4f26-956b-a498f37e14ac.png" alt="Constrained Language Mode is NOT active when running a powershell script in windows 11 24h2 with applocker enforcement turned on">
</picture>
</a></figure>



<p>But!!! As shown above, executing a PowerShell script with the same PowerShell command from that same user session showed us that it was running FullLanguage. With the PowerShell script running in full language mode, it indeed also showed the Hello output! That’s not good data at all and not expected behavior!</p>



<p>During the second test, the same default AppLocker policies behaved correctly on Windows 11 23H2, making it clear that the change was specific to the new Windows 11 24h2 version. </p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;699599369705b&quot;}" data-wp-interactive="core/image" data-wp-key="699599369705b" class="wp-block-image "><a href="https://patchmypc.com/app/uploads/2025/05/7ab340aa-bc35-4220-a61a-eabb2c53dc90.png" data-fancybox="post-gallery" data-caption="Constrained Language Mode is active when running a powershell script on windows 11 23h2 when applocker is active"><picture decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles">
<source type="image/webp" srcset="https://patchmypc.com/app/uploads/2025/05/7ab340aa-bc35-4220-a61a-eabb2c53dc90.png.webp">
<img decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://patchmypc.com/app/uploads/2025/05/7ab340aa-bc35-4220-a61a-eabb2c53dc90.png" alt="Constrained Language Mode is active when running a powershell script on windows 11 23h2 when applocker is active">
</picture>
</a></figure>



<p>As shown above, AppLocker’s contained language mode enforcement still worked; executing scripts were executed in constrained language mode.</p>



<p>At first, I had the idea that Microsoft changed something in the Applocker code, but given that Microsoft is not putting any effort into updating Applocker anymore (it is deprecated), it was clear that we needed to start looking at how PowerShell was dealing with Applocker.</p>



<h2 class="wp-block-heading" id="h-system-management-automation-dll-in-windows-11-24h2">System.Management.Automation.dll in Windows 11 24h2<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>To find the root cause, we decided to do something stupid. We started the test by replacing the newer System.Management.Automation.dll from Windows 11 24H2 with the older version from a Windows 11 23H2 build. We did so by using the Recovery Environment, as the file was always in use by Windows itself.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;699599369721d&quot;}" data-wp-interactive="core/image" data-wp-key="699599369721d" class="wp-block-image "><a href="https://patchmypc.com/app/uploads/2025/05/6bd726e8-61bd-4b40-9d18-d0a79367a89c.png" data-fancybox="post-gallery" data-caption="replacing the system.management.automation.dll  windows 11 24h2 file with one from 23h2"><picture decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles">
<source type="image/webp" srcset="https://patchmypc.com/app/uploads/2025/05/6bd726e8-61bd-4b40-9d18-d0a79367a89c.png.webp">
<img decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://patchmypc.com/app/uploads/2025/05/6bd726e8-61bd-4b40-9d18-d0a79367a89c.png" alt="replacing the system.management.automation.dll  windows 11 24h2 file with one from 23h2">
</picture>
</a></figure>



<p>After we replaced the system.management.automation.dll with an older version, we re-ran the same test. This time, after running the PowerShell script, PowerShell immediately returned to its expected behavior: <strong>enforcing Constrained Language Mode when AppLocker Script Rules were active</strong>.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;699599369734a&quot;}" data-wp-interactive="core/image" data-wp-key="699599369734a" class="wp-block-image is-resized "><a href="https://patchmypc.com/app/uploads/2025/05/15ad3cf4-97e9-4ace-85fa-24488db0fe7f.png" data-fancybox="post-gallery" data-caption="after replacing the system.management.automation.dll  constrained language mode is now active on windows 11 24h2"><picture decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" style="width:698px;height:auto">
<source type="image/webp" srcset="https://patchmypc.com/app/uploads/2025/05/15ad3cf4-97e9-4ace-85fa-24488db0fe7f.png.webp">
<img decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://patchmypc.com/app/uploads/2025/05/15ad3cf4-97e9-4ace-85fa-24488db0fe7f.png" alt="after replacing the system.management.automation.dll  constrained language mode is now active on windows 11 24h2">
</picture>
</a></figure>



<p>This confirmed that the replaced DLL was responsible for breaking the enforcement of constrained language mode. </p>



<h2 class="wp-block-heading" id="h-windows-11-24h2-a-closer-look-at-wldpcanexecutefile">Windows 11 24H2: A Closer Look at WLDPCanExecuteFile<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>After discovering that the DLL update caused the behavioral change, a deeper investigation into the system’s evaluation flow revealed a second important change. Windows 11 24H2 introduced a new API inside the Security.SystemPolicy PowerShell Function.</p>



<figure class="wp-block-image size-full"><a href="https://patchmypc.com/app/uploads/2025/05/image-17-1.png" data-fancybox="post-gallery"><img decoding="async" src="https://patchmypc.com/app/uploads/2025/05/image-17-1.png" alt="" class="wp-image-130636"></a></figure>



<p>If we zoom into SystemPolicy a bit more, we will notice that before checking lockdown policies, the system now first calls a new method named <code>WldpCanExecuteFile</code>. This change modifies how PowerShell determines whether a script is allowed to run under restrictions.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;699599369755a&quot;}" data-wp-interactive="core/image" data-wp-key="699599369755a" class="wp-block-image "><a href="https://patchmypc.com/app/uploads/2025/05/e9602191-2334-45b1-ad7f-ecd952bed87f.png" data-fancybox="post-gallery" data-caption="wldpcanexecuteavailable function in powershell"><img decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://patchmypc.com/app/uploads/2025/05/e9602191-2334-45b1-ad7f-ecd952bed87f.png" alt="wldpcanexecuteavailable function in powershell"></a></figure>



<h2 class="wp-block-heading" id="h-how-wldpcanexecutefile-changes-script-evaluation-in-applocker">How WldpCanExecuteFile Changes Script Evaluation in Applocker<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>If WldpCanExecuteFile allows the script to execute, PowerShell immediately runs in Full Language Mode without consulting the lockdown policy. Only if execution is blocked by CanExecuteFile does the system fall back to evaluating the lockdown policy.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959936976a8&quot;}" data-wp-interactive="core/image" data-wp-key="69959936976a8" class="wp-block-image "><a href="https://patchmypc.com/app/uploads/2025/05/f775e025-6186-469d-83f6-9bbc592e43cf.png" data-fancybox="post-gallery" data-caption="comparing the 23h2  systempolicy function in powershell with one from windows 11 24h2"><picture decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles">
<source type="image/webp" srcset="https://patchmypc.com/app/uploads/2025/05/f775e025-6186-469d-83f6-9bbc592e43cf.png.webp">
<img decoding="async" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://patchmypc.com/app/uploads/2025/05/f775e025-6186-469d-83f6-9bbc592e43cf.png" alt="comparing the 23h2  systempolicy function in powershell with one from windows 11 24h2">
</picture>
</a></figure>



<p>This small change in flow has major consequences. By trusting the result of <code>CanExecuteFile</code> directly, PowerShell bypasses the expected fallback to AppLocker Script Rules for enforcing Constrained Language Mode.</p>



<h2 class="wp-block-heading" id="h-why-applocker-script-enforcement-breaks">Why AppLocker Script Enforcement Breaks<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>Somehow, it feels like with the additional WLDP functionality being added, Microsoft unintentionally broke how AppLocker enforces Constrained Language Mode. Instead of properly falling back to AppLocker evaluation when WDAC allows a script, PowerShell assumes that no further restriction is needed. This leads to scripts being executed fully unrestricted, even when AppLocker Script Rules are active.</p>



<p>One thing is certain: the detection of whether the system lockdown policy (through AppLocker) is active no longer works correctly when running PowerShell scripts on Windows 11 24H2.</p>



<h2 class="wp-block-heading" id="h-a-note-about-powershell-5-1-and-wldp">A Note About PowerShell 5.1 and WLDP<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>As shown below, Microsoft mentions that Windows PowerShell 5.1 does not officially support the <code>WldpCanExecuteFile</code> API. However, when running on Windows 11 24H2, PowerShell 5.1 seems to use this API if it is available in the underlying operating system.</p>



<p>This happens because PowerShell’s internal <code>SystemPolicy</code> logic checks at runtime whether <strong>the WldpCanExecuteFile</strong> API exists. If it does, PowerShell 5.1 calls it and trusts the result to determine how scripts should be executed.</p>



<p>In other words, even though PowerShell 5.1 was not recompiled to “support” this new API, its flexible detection logic allows it to use the updated WLDP enforcement behavior when exposed by the platform. This is why script enforcement behavior has changed on Windows 11 24H2, even though the same PowerShell 5.1 version number is used.</p>



<figure class="wp-block-image size-full"><a href="https://patchmypc.com/app/uploads/2025/05/image-19-1.png" data-fancybox="post-gallery" data-caption="windows 11 24h2 powershell 5.1 doesn't support the wldpcanexecutefile api even when it's in the code"><picture decoding="async" class="wp-image-130638">
<source type="image/webp" srcset="https://patchmypc.com/app/uploads/2025/05/image-19-1.png.webp">
<img decoding="async" src="https://patchmypc.com/app/uploads/2025/05/image-19-1.png" alt="windows 11 24h2 powershell 5.1 doesn't support the wldpcanexecutefile api even when it's in the code">
</picture>
</a></figure>



<p><strong>Please note:</strong> This conclusion is partly based on observed behavior and reverse engineering. However, it fits the change introduced in Windows 11 24H2 and how PowerShell now determines language mode during script execution.</p>



<h2 class="wp-block-heading" id="h-a-quick-note-about-powershell-7">A Quick Note About PowerShell 7<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>While analyzing the issue, we also noticed that a related fix was submitted to the PowerShell GitHub repository.</p>



<p>The Pull Request addresses the same detection problem by ensuring that PowerShell 7.x correctly falls back to lockdown policy checks when needed.</p>



<p>This confirms that the issue with WldpCanExecuteFile and script enforcement is known, and is being corrected for PowerShell 7.</p>



<p>However, since Windows PowerShell 5.1 is built into Windows 11 24H2 and remains in maintenance mode, it will continue to be affected. : Related GitHub Pull Request: <a class="" href="https://github.com/PowerShell/PowerShell/pull/25305">PowerShell PR #25305</a></p>



<h2 class="wp-block-heading" id="h-why-manual-dll-replacement-is-not-a-real-solution">Why Manual DLL Replacement Is Not a Real Solution<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>Even though replacing the DLL temporarily restores expected behavior, Windows File Protection mechanisms and servicing updates will eventually overwrite unauthorized changes. Tampering with protected system components risks system instability and breaks the official Windows update path. A real solution must work within the supported platform model.</p>



<h2 class="wp-block-heading" id="h-moving-to-windows-defender-application-control-wdac">Moving to Windows Defender Application Control (WDAC)<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>The sustainable way forward is to move from relying on AppLocker alone to using <a rel="noopener noreferrer" href="https://patchmypc.com/wdac-intune" target="_self">Windows Defender Application Control (WDAC)</a>. WDAC operates deeper in the Windows security model and can enforce Constrained Language Mode through trusted code integrity policies. WDAC guarantees that scripts run in restricted environments, even if underlying system behaviors like CanExecuteFile checks are introduced. Although implementing WDAC requires careful planning and testing, it provides stronger guarantees than AppLocker alone, especially on evolving platforms like Windows 11 24H2.</p>



<h2 class="wp-block-heading" id="how-microsoft-fixed-the-broken-enforcement">How Microsoft Fixed the Broken Enforcement<span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>With the 2025-05 May Security Update, Microsoft seems to have fixed this Constrained Language Mode issue.</p>



<figure class="wp-block-image size-full"><a href="https://patchmypc.com/app/uploads/2025/05/image-23-1.png" data-fancybox="post-gallery" data-caption="constrained language working in 24h2 26100.4061"><picture decoding="async" class="wp-image-131025">
<source type="image/webp" srcset="https://patchmypc.com/app/uploads/2025/05/image-23-1.png.webp">
<img decoding="async" src="https://patchmypc.com/app/uploads/2025/05/image-23-1.png" alt="constrained language working in 24h2 26100.4061">
</picture>
</a></figure>



<p>They fixed it by not really changing PowerShell itself, but by correcting the logic inside the <strong>Windows Lockdown Policy (WLDP)</strong> runtime. When a script is meant to be restricted, WldpCanExecuteFile now correctly returns RequireSandbox. PowerShell then maps that result to Constrained Language Mode using an internal enum (SystemScriptFileEnforcement).</p>



<p>This behavior is only active when a specific feature flag is enabled: Feature_832843065. </p>



<figure class="wp-block-image size-full"><a href="https://patchmypc.com/app/uploads/2025/05/image-24-1.png" data-fancybox="post-gallery" data-caption="832843065"><img decoding="async" src="https://patchmypc.com/app/uploads/2025/05/image-24-1.png" alt="832843065" class="wp-image-131026"></a></figure>



<p>When that flag is on, PowerShell stops relying on global lockdown policies and temporary test files, and instead switches to evaluating script files individually. The result from WldpCanExecuteFile is passed through a method called <strong>ConvertToModernFileEnforcement</strong>, which translates it into the correct enforcement behavior:</p>



<figure class="wp-block-image size-full"><a href="https://patchmypc.com/app/uploads/2025/05/image-25-1.png" data-fancybox="post-gallery"><img decoding="async" src="https://patchmypc.com/app/uploads/2025/05/image-25-1.png" alt="" class="wp-image-131027"></a></figure>



<ul class="wp-block-list">
<li><code>Allowed</code> → Full Language Mode</li>



<li><code>RequireSandbox</code> → Constrained Language Mode</li>



<li><code>Blocked</code> → Execution denied</li>
</ul>



<p>So, while PowerShell already had the plumbing in place, the real fix came from WLDP returning the correct information and the feature flag enabling this modernized logic path. Once that was aligned, enforcement started working again, just as administrators expected.</p>



<figure class="wp-block-image size-full"><a href="https://patchmypc.com/app/uploads/2025/05/image-26.png" data-fancybox="post-gallery"><img decoding="async" src="https://patchmypc.com/app/uploads/2025/05/image-26.png" alt="" class="wp-image-131030"></a></figure>



<h2 class="wp-block-heading" id="h-conclusion">Conclusion: <span class="clth-copy-icon" style="background-image: url(&quot;https://patchmypc.com/app/plugins/copy-link-to-heading/images/link-icon.png&quot;); display: inline-block;"><span class="clth-tooltip">Copy Link to Heading</span></span></h2>



<p>Windows 11 24H2 introduces a serious but subtle change that affects environments relying on AppLocker Script Rules to control PowerShell. Organizations relying on AppLocker should treat script lockdown enforcement as unreliable on Windows 11 24H2 and plan mitigation strategies accordingly.</p>
                    </div>

                    
                    <div class="d-block d-lg-none">
		                		                                    </div>
                </div>
            </div>
        </div>
    </div><!-- .entry-content -->

	<!-- .entry-footer -->
</article><!-- #post-140840 -->

	</div><!-- #primary -->



<div class="pmpc-scroll-up">
	<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="chevron-up" class="svg-inline--fa fa-chevron-up fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
		<path fill="#ffffff" d="M240.971 130.524l194.343 194.343c9.373 9.373 9.373 24.569 0 33.941l-22.667 22.667c-9.357 9.357-24.522 9.375-33.901.04L224 227.495 69.255 381.516c-9.379 9.335-24.544 9.317-33.901-.04l-22.667-22.667c-9.373-9.373-9.373-24.569 0-33.941L207.03 130.525c9.372-9.373 24.568-9.373 33.941-.001z"></path>
	</svg>
</div>

</div><!-- #page-content -->


    <div id="page-footer">

                
        

			<div class="footer-sidebar-row footer-widget-area text-white">
                <div class="container">
                    <div class="footer-widgets">
                        <div class="row">

                                                                                                                                <div class="col-12 col-md-4 col-xl">
                                        <div class="footer-widget"><div class="widget-title">Getting Started</div><div class="menu-getting-started-footer-container"></div></div>                                    </div>
                                                                    <div class="col-12 col-md-4 col-xl">
                                        <div class="footer-widget"><div class="widget-title">Products</div><div class="menu-products-footer-container"></div></div>                                    </div>
                                                                    <div class="col-12 col-md-4 col-xl">
                                        <div class="footer-widget"><div class="widget-title">Company</div><div class="menu-company-footer-container"></div></div>                                    </div>
                                                                    <div class="col-12 col-md-4 col-xl">
                                        <div class="footer-widget"><div class="widget-title">Resources</div><div class="menu-resources-footer-container"></div></div>                                    </div>
                                                                    <div class="col-12 col-md-4 col-xl">
                                        <div class="footer-widget"><div class="widget-title">Additional resources</div><div class="menu-additional-resources-footer-col2-container"></div></div>                                    </div>
                                                            
                        </div>
                    </div>
                </div>
			</div><!-- .row -->

		
                
    </div>

</main><!-- #page -->






<link rel="modulepreload" href="https://patchmypc.com/wp/wp-includes/js/dist/script-modules/interactivity/index.min.js?ver=66c613f68580994bb00a" id="@wordpress/interactivity-js-modulepreload" fetchpriority="low">















		<div class="wp-lightbox-overlay zoom" data-wp-interactive="core/image" data-wp-router-region="{ &quot;id&quot;: &quot;core/image-overlay&quot;, &quot;attachTo&quot;: &quot;body&quot; }" data-wp-key="wp-lightbox-overlay" data-wp-context="{}" data-wp-bind--role="state.roleAttribute" data-wp-bind--aria-label="state.currentImage.ariaLabel" data-wp-bind--aria-modal="state.ariaModal" data-wp-class--active="state.overlayEnabled" data-wp-class--show-closing-animation="state.overlayOpened" data-wp-watch="callbacks.setOverlayFocus" data-wp-on--keydown="actions.handleKeydown" data-wp-on--touchstart="actions.handleTouchStart" data-wp-on--touchmove="actions.handleTouchMove" data-wp-on--touchend="actions.handleTouchEnd" data-wp-on--click="actions.hideLightbox" data-wp-on-window--resize="callbacks.setOverlayStyles" data-wp-on-window--scroll="actions.handleScroll" data-wp-bind--style="state.overlayStyles" tabindex="-1">
				<button type="button" aria-label="Close" style="fill: #000" class="close-button">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false"><path d="m13.06 12 6.47-6.47-1.06-1.06L12 10.94 5.53 4.47 4.47 5.53 10.94 12l-6.47 6.47 1.06 1.06L12 13.06l6.47 6.47 1.06-1.06L13.06 12Z"></path></svg>
				</button>
				<div class="lightbox-image-container">
					<figure data-wp-bind--class="state.currentImage.figureClassNames" data-wp-bind--style="state.figureStyles">
						<img data-wp-bind--alt="state.currentImage.alt" data-wp-bind--class="state.currentImage.imgClassNames" data-wp-bind--style="state.imgStyles" data-wp-bind--src="state.currentImage.currentSrc" alt="" src="https://patchmypc.com/blog/windows-11-24h2-applocker-powershell-constrained-language-broken/">
					</figure>
				</div>
				<div class="lightbox-image-container">
					<figure data-wp-bind--class="state.currentImage.figureClassNames" data-wp-bind--style="state.figureStyles">
						<img data-wp-bind--alt="state.currentImage.alt" data-wp-bind--class="state.currentImage.imgClassNames" data-wp-bind--style="state.imgStyles" data-wp-bind--src="state.enlargedSrc" alt="" src="https://patchmypc.com/blog/windows-11-24h2-applocker-powershell-constrained-language-broken/">
					</figure>
				</div>
				<div class="scrim" style="background-color: #fff" aria-hidden="true"></div>
		</div>

































<!-- Modal -->

<div class="page-overlay"></div>


<div id="tidio-chat-code" title="Tidio Chat code" style="display: none;" data-original-tag="iframe"></div>
<div class="go2933276541 go2369186930" id="hs-web-interactives-top-anchor"><div id="hs-interactives-modal-overlay" class="go1632949049"></div></div>
<div class="go2933276541 go1348078617" id="hs-web-interactives-bottom-anchor"></div>
<div id="hs-web-interactives-floating-container">
  <div id="hs-web-interactives-floating-top-left-anchor" class="go2417249464 go613305155">
  </div>
  <div id="hs-web-interactives-floating-top-right-anchor" class="go2417249464 go471583506">
  </div>
  <div id="hs-web-interactives-floating-bottom-left-anchor" class="go2417249464 go3921366393">
  </div>
  <div id="hs-web-interactives-floating-bottom-right-anchor" class="go2417249464 go3967842156">
  </div>
</div>
<div owner="archetype" title="archetype" style="display: none; visibility: hidden;" data-original-tag="iframe"></div><span class="algolia-autocomplete" style="position: absolute; z-index: 100; display: none; direction: ltr;"><span class="aa-dropdown-menu" role="listbox" id="algolia-autocomplete-listbox-0" style="display: block; left: 0px; right: auto;"><div class="aa-empty" style="display: none;"></div><div class="aa-dataset-1"></div><div class="aa-dataset-2"></div><div class="aa-dataset-3"></div><div class="aa-dataset-4"></div></span></span></body></html>