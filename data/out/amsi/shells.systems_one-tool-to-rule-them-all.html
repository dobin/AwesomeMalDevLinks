# https://shells.systems/one-tool-to-rule-them-all/

<!DOCTYPE html><html lang="en-US" class="">
<body class="post-template-default single single-post postid-2656 single-format-standard custom-background">
    <div class="search-popup">
        <span class="search-popup-close"><i class="fa fa-times"></i></span>
        
<form action="https://shells.systems/" method="get" role="search" id="searchform_topbar" class="search-top-bar-popup search-form">
	<label>
		<span class="screen-reader-text">Search for:</span>
		<input type="search" class="search-field-top-bar" id="search-field-top-bar" placeholder="Search ‚Ä¶" value="" name="s">
	</label>
	<button type="submit" class="search-submit search-top-bar-submit" id="search-top-bar-submit">
        <span class="fa fa-search header-search-icon"></span>
        <span class="screen-reader-text">
            Search        </span>
    </button>
</form>
    </div><!-- .search-popup -->

<div id="page" class="site">
    <div class="site-inner">
        <a class="skip-link screen-reader-text" href="https://shells.systems/one-tool-to-rule-them-all/#content">Skip to content</a>

        

        <div id="content" class="site-content container">


	<div id="primary" class="content-area row">
		<main id="main" class="site-main col-md-8 col-sm-12 col-md-offset-2" role="main">

			
<article id="post-2656" class="post-2656 post type-post status-publish format-standard hentry category-red-team tag-lolbas">

	

	
	<div class="entry-content">
		<span class="span-reading-time rt-reading-time" style="display: block;"><span class="rt-label rt-prefix">Estimated Reading Time: </span> <span class="rt-time"> 9</span> <span class="rt-label rt-postfix">minutes</span></span>
<p></p>



<p><strong><em>AMSI, CLM and ETW ‚Äì defeated</em></strong><sup><strong><em>*</em></strong></sup><strong><em> with one Microsoft signed tool </em></strong></p>



<p>Let‚Äôs start with AMSI ‚Äì everyone loves bypassing AMSI!</p>



<p>In recent years, many (not all) antivirus products have
begun to rely on Antimalware Scan Interface (AMSI) to detect more advanced
malicious activity. </p>



<p>Today, it captures every PowerShell, Jscript, VBScript, VBA &nbsp;or .NET command or script at run-time and passes it to the registered security product for inspection ‚Äì here I am working with Defender for Endpoint.</p>



<p>Now, in 2025, most decent EDRs will get a bit squirrely when you start poking around in the memory space used by amsi.dll. </p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-21.jpg" alt="" class="wp-image-2683"></figure>



<p>Unfortunately, the days are past when a simple PowerShell
one-liner was all you needed to be free of the constraints of AMSI</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image.jpg" alt="" class="wp-image-2657"><figcaption> Figure 1 ‚Äì It was a simpler, happier, precedented time </figcaption></figure>



<p>This bypass sets amsiInitFailed&nbsp;to a Boolean&nbsp;True&nbsp;so that the initialization fails resulting in no scans at all being performed for the current process.</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-8.jpg" alt="" class="wp-image-2669"><figcaption> Figure 2 ‚Äì This doesn‚Äôt work anymore ‚Äì sad face </figcaption></figure>



<p style="text-align:center" class="has-small-font-size">(BTW ‚Äì The
above image is from <a href="https://s3cur3th1ssh1t.github.io/Bypass_AMSI_by_manual_modification/">https://s3cur3th1ssh1t.github.io/Bypass_AMSI_by_manual_modification/</a> ‚Äì definitely check out this and the
author‚Äôs other work.)</p>



<p>However, all is not lost. There have been some great
bypasses found recently that don‚Äôt rely on needing to have RW on amsi.dll such
as this awesome piece of research by Vixx : <a href="https://www.offsec.com/blog/amsi-write-raid-0day-vulnerability/">AMSI
Write Raid Bypass Vulnerability | OffSec</a> which has spawned quite a few ‚Äòrelated‚Äô
bypasses.</p>



<p>The functions responsible for checking for malicious content are AmsiScanBuffer() and AmsiScanString(). AmsiScanString() is a small function which uses AmsiScanBuffer() underneath. So, if we can bypass the checks performed by AmsiScanBuffer(), we can also bypass AmsiScanString(). The majority of bypasses patch the function, through various means, to always return 0x80070057. 0x80070057 is an HRESULT return code for E_INVALIDARG. The actual scan result for this is 0 ‚Äî often interpreted as AMSI_RESULT_CLEAN. </p>



<p>Initially, a lot of the signature-based checks were bypassed
by fiddling with the actual result value ‚Äì instead of passing the 0x80070057
value immediately, it was manipulated through various means (XOR, ADD, SUB etc)
until EAX ultimately contained the correct value and the carried on</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-1.jpg" alt="" class="wp-image-2658"><figcaption> Figure 3 ‚Äì Me? No Mr EDR, I‚Äôm not moving 0x80070057 into EAX </figcaption></figure>



<p>And the eternal cat and mouse game continued to defeat signature-based
detections.</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-2.jpg" alt="" class="wp-image-2659"><figcaption> Figure 4 ‚Äì More obfuscation-ing </figcaption></figure>



<p>But what if we look at the method rather than the exact
execution ‚Äì all we need to do is somehow force the return of a value from a
call ‚Äì either by altering the actual routine in amsi.dll or redirecting that
call to a routine of our own. Ideally without having a million hoops to jump
through.</p>



<p><strong><em>Enter CDB/NTSD</em></strong></p>



<p>Microsoft provides these two console-based debuggers
(meaning they are signed by Microsoft) as part of the Windows 10 debugging
tools. CDB and NTSD are identical in every way, except that NTSD spawns a new
text window when it is started, whereas CDB inherits the Command Prompt window
from which it was invoked. For now, I‚Äôm using CDB.</p>



<p>One of the huge benefits of CDB is that you can script it.
This means that you can take a file, feed it into you console debugger and
script actions to take place, breakpoints, dumps, assembly etc. &nbsp;With no interaction. </p>



<p>What do we need to accomplish ‚Äì</p>



<ul><li>Load PowerShell</li><li>Set a BP on AmsiScanBuffer</li><li>Wait until that BP is hit</li><li>Manipulate the data at that address</li><li>Remove the BP</li><li>Continue execution</li></ul>



<p>Seems pretty easy ‚Äì how do we do this with a CDB script file</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-11.jpg" alt="" class="wp-image-2673"><figcaption> Figure 5 ‚Äì commented script to see what everything is doing </figcaption></figure>



<p>Hopefully the comments next to the commands make sense ‚Äì
please note that the actual file does not have comments and gaps (bar the blank
line to exit assembly). It actually looks like</p>



<div class="wp-block-image"><figure class="aligncenter"><img src="https://shells.systems/wp-content/uploads/2025/05/image-3.png" alt="" class="wp-image-2667"><figcaption>Figure 6 ‚Äì What it actually looks like (for x86) </figcaption></figure></div>



<p>Now we can save this as bypass.txt and execute CDB with the
-cf flag which will pass it a script.</p>



<p><em>‚ÄúC:\Program Files (x86)\Windows Kits\10\Debuggers\x64\cdb.exe‚Äù
-cf bypass.txt ‚ÄúC:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe‚Äù</em></p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-4.jpg" alt="" class="wp-image-2660"><figcaption> Figure 7 ‚Äì No AMSI <img draggable="false" class="emoji" alt="üôÇ" src="https://s.w.org/images/core/emoji/11/svg/1f642.svg" width="16" height="16"> You can avoid the CDB output interfering with your console app by using -2 when launching CDB </figcaption></figure>



<p>Happy days <img draggable="false" class="emoji" alt="üòä" src="https://s.w.org/images/core/emoji/11/svg/1f60a.svg" width="16" height="16"></p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-3.jpg" alt="" class="wp-image-2661"></figure>



<p>What else can we do with this?</p>



<p>We have control over the Powershell.exe prior to loading any
modules, before it starts initialising its environment. In theory, it would be
possible to set a BP on load of System.Management.Automation.dll and then do
some memory manipulation. It would be a case of identifying the correct memory
area for System.Management.Automation.Security.SystemPolicy.GetSystemLockdownPolicy()
(for example) and manipulating that to always return<em>&nbsp;SystemEnforcementMode.None</em>.
</p>



<p>That is less scriptable (IMHO) due to the lack of CDB
support for variables ‚Äì i.e. you can‚Äôt do search a range and return the value
i.e. $var = s 0x00400000 0x0040FFFF 90 90 90 90 or something and then pass that
to e $var 00 00 00 00 to zero the NOPs we just searched for.<br>
<br>
Let‚Äôs try manually and have a look at the PowerShell code</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-7.jpg" alt="" class="wp-image-2668"><figcaption> Figure 8 ‚Äì GetSystemLockdownPolicy() </figcaption></figure>



<p>But this only goes to check if the SystemPolicy.systemLockdownPolicy
hasn‚Äôt been initialised yet, or if there was a debugging override which then
checks for the presence of WDAC/Applocker policies here</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-6.jpg" alt="" class="wp-image-2663"></figure>



<p>Plenty of opportunities here to force a return of SystemPolicy.systemLockdownPolicy.None
&nbsp;‚Äì it is just a question of returning 0
from the GetLockDownPolicy. Everytime this function is called, it is only
because the current lockdown policy != none. So we would want it to look a
little something along the lines of</p>



<div class="wp-block-image"><figure class="aligncenter"><img src="https://shells.systems/wp-content/uploads/2025/05/image-2.png" alt="" class="wp-image-2666"><figcaption> Figure 9 ‚Äì GetLockDownPolicy ‚Äì always called after an if(SystemPolicy.GetSystemLockdownPolicy() != SystemEnforcementMode.None) </figcaption></figure></div>



<p>What does this look like to actually try? Well first we need
to find the file offset in the DLL to figure out where we are patching. For the
version I am working with it is here :</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-14.jpg" alt="" class="wp-image-2677"><figcaption> Figure 11 ‚Äì the file offsets are in green preceded by /* </figcaption></figure>



<p>Looks like we need to start over writing at 0x000D8344. What
do we need to overwrite with? Well it needs to be CIL (Common Intermediate
Language), also known as MSIL (Microsoft Intermediate Language). It‚Äôs the
low-level, stack-based instruction set used in .NET assemblies before JIT
compilation. So we need to use the correct instructions prior to the CLR
compilation. That looks like :</p>



<blockquote class="wp-block-quote"><p>ldc.i4.0</p><p>ret</p></blockquote>



<p>Will always return an Int with the value of zero. In raw
bytes this is:</p>



<p>0x16 0x2A</p>



<p>Let‚Äôs patch this manually for now and see what happens. Fire
up your preferred Hex-Editor, navigate to 0xD8344 and drop those in</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image.png" alt="" class="wp-image-2662"><figcaption> Figure 12 ‚Äì Mine is HxD for simple things like this </figcaption></figure>



<p>Let‚Äôs reanalyse the file</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-5.jpg" alt="" class="wp-image-2665"><figcaption> Figure 13 ‚Äì More happy days <img draggable="false" class="emoji" alt="üôÇ" src="https://s.w.org/images/core/emoji/11/svg/1f642.svg" width="16" height="16"></figcaption></figure>



<p>Can we do this using scripts in CDB? Not as far as I can
tell due to the lack of variables. </p>



<p>However, in CDB, you can issue a .loadby sos clr command. Loading
sos.dll with .loadby sos clr gives you access to .NET-specific debugging
commands in CDB, like inspecting managed objects, call stacks, and JIT-compiled
methods. It ties into the right CLR version automatically.</p>



<p>Using this, let‚Äôs see if we can manipulate the return value of
GetSystemLockdownPolicy</p>



<p>I start PowerShell and run the following commands to check
the current status. I wasn‚Äôt testing this in a restricted environment, so let‚Äôs
see if we can enforce a policy rather than bypass it.</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-12.jpg" alt="" class="wp-image-2674"><figcaption> Figure 14 ‚Äì Result from calling GetSystemLockdownStatus the first time </figcaption></figure>



<p>None is as expected. Let‚Äôs patch it to always return 2 and
thus enforced. </p>



<p>After connecting to the PID with CDB we run the following
commands</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-20.jpg" alt="" class="wp-image-2682"><figcaption> Figure 15 ‚Äì Getting details for System.Management.Automation.Security.Systempolicy </figcaption></figure>



<p>!name2ee allows us to retrieve the details for the bit we
are interested in (System.Management.Automation.Security.SystemPolicy)</p>



<p>From there we can take the MethodTable and dump the contents</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-18.jpg" alt="" class="wp-image-2680"><figcaption> Figure 16 ‚Äì identifying the correct address for GetSystemLockdownPolicy() </figcaption></figure>



<p>We can see that in the results you have </p>



<p><em>079c3088 079a16cc&nbsp;&nbsp;&nbsp; JIT System.Management.Automation.Security.SystemPolicy.GetSystemLockdownPolicy()</em></p>



<p>We have the start address for the function we are looking at. If we assemble at that address to always return 2 (for Enforce) then we should be able to see if our technique is viable. Note that this time, since it has been compiled, we can overwrite it with the usual assembly code rather than CIL.</p>



<div class="wp-block-image"><figure class="aligncenter"><img src="https://shells.systems/wp-content/uploads/2025/05/image-1.png" alt="" class="wp-image-2664"><figcaption> Figure 17 ‚Äì patching at the function address (x86) </figcaption></figure></div>



<p>A quick check for sanity‚Äôs sake to ensure that everything
has taken</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-9.jpg" alt="" class="wp-image-2670"><figcaption> Figure 18 ‚Äì Checking patch has taken (x86) </figcaption></figure>



<p>And let‚Äôs see what the result is for a call to that function
now</p>



<div class="wp-block-image"><figure class="aligncenter"><img src="https://shells.systems/wp-content/uploads/2025/05/image-4.png" alt="" class="wp-image-2671"><figcaption> Figure 19 ‚Äì Success! </figcaption></figure></div>



<p>Now let‚Äôs try from the very beginning rather than attaching
to a PID and see if we can fool it into ConstrainedLanguage mode. This involves
patching the appropriate methods with the raw bytes to always return <em>Enforced
</em>prior to them being compiled. I have to admit, this all feels a little
strange trying to enforce a lockdown!</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-19.jpg" alt="" class="wp-image-2681"><figcaption> Figure 20 ‚Äì I‚Äôve forced myself into ConstrainedLanguage mode. I think I‚Äôm meant to be happy about this! (x64) </figcaption></figure>



<p>Success and given the fact that you are running a Microsoft
signed binary, default&nbsp; SRP/Applocker/WDAC/whatever_MS_is_calling_it_this_month
rules shouldn‚Äôt be a problem.<br></p>



<div class="wp-block-image"><figure class="aligncenter"><img src="https://shells.systems/wp-content/uploads/2025/05/image-10.jpg" alt="" class="wp-image-2672"></figure></div>



<p>With some tweaking, this method could be used for multiple bypasses
‚Äì including disabling ETW (kind of ‚Äì I‚Äôm not looking at kernel patching for EtwTraceKernelEvent
etc)</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-15.jpg" alt="" class="wp-image-2676"><figcaption> Figure 21 ‚Äì simply patching EtwEventWrite to return 0 ‚Äì No this won‚Äôt  work IRL (hint 0x7755182e ‚Äì I keep swapping between x64 and x86 in this article)</figcaption></figure>



<p>Blindly copying the example above won‚Äôt work (read image
comments!) ‚Äì but doing this correctly does work. &nbsp;I can trigger an entry into the event log with
an ID of 4103 (executing pipeline) when using Add-Type from the console which
results in an entry in the Event Log like this </p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-16.jpg" alt="" class="wp-image-2679"><figcaption> Figure 22 ‚Äì 14:55 :36 ‚Äì EventID 4103 Executing Pipeline </figcaption></figure>



<p>Open our prepped and patched PowerShell instance with ETW
patched out (hint : you‚Äôll need more than just EtwEventWrite patching) and
let‚Äôs try the same thing :</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-13.jpg" alt="" class="wp-image-2675"><figcaption> Figure 23 ‚Äì Add-Type being executed with time stamps </figcaption></figure>



<p>This now results in ‚Ä¶</p>



<figure class="wp-block-image"><img src="https://shells.systems/wp-content/uploads/2025/05/image-17.jpg" alt="" class="wp-image-2678"><figcaption> Figure 24 ‚Äì No Event Logs for the same operation ‚Äì next recorded entry is at 15:17:55 </figcaption></figure>



<p><strong>Conclusion</strong></p>



<p>Image hardening is your friend ‚Äì remove unwanted and
unnecessary tooling from your hosts and help avoid these issues. If your
organisation is sufficiently mature, look at whitelisting for applications, at
least for the vast majority of the estate (there will always be outliers like
Security Testing ‚Ä¶ wait what?)</p>



<p>ETW and AMSI can be combined into one script ‚Äì for CLM
though, there was a little bit more manual intervention than I had hoped, but
being able to change language mode, disable ETW and AMSI all from one MS Signed
binary seems like a win to me. </p>



<p>*Have fun, play nice and remember, even if you don‚Äôt see an
alert, it doesn‚Äôt mean you‚Äôre not being seen ‚Äì there are many ways to detect
this behaviour<img draggable="false" class="emoji" alt="üòä" src="https://s.w.org/images/core/emoji/11/svg/1f60a.svg" width="16" height="16"></p>
	</div><!-- .entry-content -->

	</article>

	
<div id="comments" class="comments-area">

	
	
		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://shells.systems/one-tool-to-rule-them-all/#respond" style="display:none;">Cancel reply</a></small></h3>			<form action="https://shells.systems/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate="">
				<p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" required="required"></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" required="required"></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="url" value="" size="30" maxlength="200"></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment"> 

</p><p style="display: none;"></p><p style="display: none !important;"><label>Œî<textarea name="ak_hp_textarea" cols="45" rows="8" maxlength="100"></textarea></label></p>			</form>
			</div><!-- #respond -->
	
</div><!-- .comments-area -->
		</main><!-- .site-main -->
			</div><!-- content-area -->

        </div><!-- .site-content -->
        
                
        
    </div><!-- site-inner -->
</div><!-- site -->

    
    







			
		

</body></html>