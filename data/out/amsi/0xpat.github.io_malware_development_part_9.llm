Title:
Malware development part 9 – hosting CLR and managed code injection

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how a native (unmanaged) Windows process can host the .NET CLR and execute managed code, including loading a .NET assembly directly from memory.  
- It first covers straightforward CLR hosting via `mscoree.dll` and `ICLRRuntimeHost::ExecuteInDefaultAppDomain` for executing assemblies from disk, then pivots to in-memory execution using the deprecated `ICorRuntimeHost` API.  
- The core technique uses COM interop with `mscorlib` to obtain the default `_AppDomain`, call `_AppDomain::Load_3()` with a `SAFEARRAY` of bytes, resolve types via `_Assembly::GetType_2()`, and invoke methods via `_Type::InvokeMember_3()`.  
- It details the practical COM/OLE plumbing required (TLB export with `tlbexp.exe`, interface discovery with `oleview.exe`, `SAFEARRAY`/`VARIANT` construction) to reproduce common “managed injection” patterns in C++.  
- The post notes that `AppDomain.Load(byte[])` triggers AMSI scanning, which impacts offensive use and requires consideration for evasion.  
- Useful for red teamers, malware developers, and defenders wanting to understand CLR-hosted in-memory execution tradecraft and its detection surface.

Technical Focus:
- CLR hosting (`mscoree.dll`, `ICLRMetaHost`, `ICLRRuntimeInfo`, `ICLRRuntimeHost`, `ICorRuntimeHost`)
- In-memory .NET assembly loading via `_AppDomain::Load_3()` and COM interop
- COM/OLE Automation types: `SAFEARRAY`, `VARIANT`, `_bstr_t`
- Reflection-style invocation from native code (`_Type::InvokeMember_3`, `BindingFlags`)
- Type library generation and interface inspection (`tlbexp.exe`, `oleview.exe`)
- AMSI interaction with `AppDomain.Load(byte[])`

Use Cases:
- Execute .NET payloads from a native loader without dropping assemblies to disk
- Build mixed-mode implants where native code bootstraps managed modules
- Research/detect CLR hosting and COM-based managed execution in endpoint telemetry
- Prototype “managed injection” loaders for red team simulations
- Validate AMSI coverage points for in-memory .NET loading paths

Keywords:
CLR hosting, mscoree.dll, ICLRRuntimeHost, ICorRuntimeHost, ICLRMetaHost, ICLRRuntimeInfo, ExecuteInDefaultAppDomain, COM interop, mscorlib, _AppDomain, Load_3, SAFEARRAY, VARIANT, oleview.exe, tlbexp.exe, reflection, InvokeMember, BindingFlags, AMSI, in-memory assembly loading