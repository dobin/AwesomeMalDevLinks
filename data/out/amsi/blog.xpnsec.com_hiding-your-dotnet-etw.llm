Title:
Hiding your .NET – ETW

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how defenders detect in-memory/external .NET assembly execution (e.g., Cobalt Strike `execute-assembly`) using Event Tracing for Windows (ETW) telemetry from the CLR.  
- It walks through how unmanaged processes host the CLR via `ICLRMetaHost`, `ICLRRuntimeInfo`, and `ICLRRuntimeHost`, then execute assemblies with `ExecuteInDefaultAppDomain`.  
- The author demonstrates building an ETW consumer to capture CLR loader events (assembly load) and method load events, showing how tools like SharpHound can be identified even if the assembly name is changed.  
- It then reverse engineers where CLR emits ETW events and shows they ultimately call user-mode `ntdll!EtwEventWrite`.  
- The core evasion technique is patching `EtwEventWrite` in-process (x86 example) to immediately return, suppressing CLR ETW events and breaking ETW-based visibility (including ProcessHacker-style enumeration).  
- Useful for red teams and malware developers to understand ETW-based .NET detections and common bypass patterns; also relevant to blue teams to understand ETW trust limitations and tamper opportunities.

Technical Focus:
- CLR hosting from unmanaged code (ICLRMetaHost/ICLRRuntimeHost)
- ETW CLR provider consumption (keywords/events like Loader/Assembly events)
- Assembly/method load telemetry and hunting signals
- User-mode ETW emission path (`ntdll!EtwEventWrite`) and call sites in `clr.dll`
- In-memory patching/unhooking via `VirtualProtect` + `memcpy`/`Marshal.Copy`
- x86 patch primitive (`ret 0x14`) to neuter ETW writes

Use Cases:
- Detecting `execute-assembly`-style tradecraft via CLR ETW events (defensive)
- Building custom ETW consumers for .NET assembly/method load monitoring
- Red team evasion by disabling or tampering with ETW emission in-process
- Assessing EDR/SIEM reliance on ETW and designing compensating detections
- Demonstrating why renamed/obfuscated assemblies may still be fingerprinted via method/namespace telemetry

Keywords:
ETW, CLR, .NET Framework, Cobalt Strike, execute-assembly, ICLRMetaHost, ICLRRuntimeInfo, ICLRRuntimeHost, CLRCreateInstance, ExecuteInDefaultAppDomain, clr.dll, ntdll.dll, EtwEventWrite, EnableTraceEx, StartTrace, ProcessTrace, VirtualProtect, in-memory patching, ProcessHacker, SharpHound, Ghidra, WinDBG