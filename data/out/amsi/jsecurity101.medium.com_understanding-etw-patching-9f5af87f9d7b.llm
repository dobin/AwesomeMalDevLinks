Title:
Understanding ETW Patching

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains “ETW patching” as a practical application of generic function patching to suppress Windows telemetry generated by Event Tracing for Windows (ETW).  
- It clarifies which ETW providers/functions can realistically be patched in user mode versus kernel mode, emphasizing that kernel ETW providers (e.g., Threat Intelligence) require kernel code execution to tamper with.  
- The author walks through common patching mechanics: resolving function pointers (via GetProcAddress or manual RVA-to-VA calculation), changing page protections (VirtualProtect), and overwriting prolog bytes (e.g., forcing an immediate return).  
- It highlights operational constraints: patching must occur in the process context that emits the events, and remote-process patching typically implies WriteProcessMemory/process injection tradeoffs and detection risk.  
- Concrete examples show that patching EtwEventWrite can suppress some user-mode provider telemetry (e.g., .NET), but does not stop kernel-provider events like ETW-TI logging ReadProcessMemory during LSASS dumping.  
- For defenders, it discusses the difficulty of reliably detecting patching and suggests focusing detections on telemetry sources less susceptible to in-process patching.

Technical Focus:
- ETW architecture (user-mode vs kernel-mode providers)
- Function patching/in-memory code modification (prolog patching, RET stubs)
- API-based vs manual function resolution (GetProcAddress vs RVA/offset)
- Memory protection changes (VirtualProtect) and code overwrites
- Remote patching tradeoffs (WriteProcessMemory, process injection detections)
- Call-chain transitions across PowerShell/WMI/COM/RPC affecting where logging occurs

Use Cases:
- Suppress specific user-mode ETW provider telemetry inside an implant/sacrificial process
- Evaluate which telemetry remains visible when common ETW write APIs are patched
- Design detections resilient to ETW patching by leveraging kernel or out-of-process telemetry
- Threat hunting/IR validation: confirm whether missing ETW events could be due to patching
- Research Windows logging call paths to identify where patching would need to occur (local vs remote process)

Keywords:
ETW, Event Tracing for Windows, ETW provider, user-mode, kernel-mode, Threat Intelligence provider, ETW-TI, EtwEventWrite, NtTraceEvent, EtwTiLogReadWriteVm, AmsiScanBuffer, VirtualProtect, GetProcAddress, LoadLibrary, WriteProcessMemory, function patching, in-memory patch, RVA, wldap32.dll, Microsoft-Windows-LDAP-Client, ReadProcessMemory, LSASS dumping, COM, RPC, WMI, svchost.exe, schedsvc.dll