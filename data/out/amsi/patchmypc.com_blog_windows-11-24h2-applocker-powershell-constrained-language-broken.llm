Title:
Windows 11 24H2: AppLocker PowerShell Constrained Language Mode Broken

Type:
Blog Post

Short Summary (4–8 sentences max):
- This write-up analyzes a Windows 11 24H2 (and Server 24H2-based builds like Windows Server 2025) regression where AppLocker Script Rules no longer reliably force PowerShell into Constrained Language Mode (CLM).  
- As a result, PowerShell scripts that should be restricted can execute in Full Language Mode, restoring access to .NET, reflection, and other high-risk capabilities despite AppLocker being configured.  
- The author traces the behavior change to updates in `System.Management.Automation.dll` and a new execution decision path that calls `WldpCanExecuteFile` (WLDP) before evaluating traditional lockdown/AppLocker policy.  
- Because PowerShell trusts the WLDP result, it can skip the fallback that previously triggered CLM under AppLocker script enforcement.  
- The post notes PowerShell 7 has an upstream fix (PR #25305), while Windows PowerShell 5.1 inherits the platform behavior at runtime.  
- Microsoft later fixed the issue in the 2025-05 security update by correcting WLDP’s return values (e.g., `RequireSandbox`) and enabling a feature flag that modernizes per-file enforcement mapping back to CLM.  
- This is most useful for Windows defenders, endpoint management teams, and red teams validating application control assumptions during upgrades.

Technical Focus:
- PowerShell language modes (FullLanguage vs ConstrainedLanguage)
- AppLocker Script Rules and script enforcement behavior
- `System.Management.Automation.dll` behavior changes across Windows builds
- Windows Lockdown Policy (WLDP) and `WldpCanExecuteFile`
- Enforcement decision flow / fallback logic for script policy evaluation
- Microsoft fix via WLDP logic + feature flag (Feature_832843065)

Use Cases:
- Validate whether AppLocker-based PowerShell hardening still works after moving to Windows 11 24H2 / Server 2025
- Identify upgrade-induced gaps where scripts regain Full Language capabilities
- Build detection/assessment checks for `$ExecutionContext.SessionState.LanguageMode` discrepancies between interactive and script execution
- Guide migration planning from AppLocker to WDAC for stronger, more reliable application control
- Red team verification of “CLM enforced” assumptions in target environments

Keywords:
Windows 11 24H2, Windows Server 2025, AppLocker, PowerShell 5.1, PowerShell 7, Constrained Language Mode, Full Language Mode, System.Management.Automation.dll, WLDP, Windows Lockdown Policy, WldpCanExecuteFile, script enforcement, application control, WDAC, RequireSandbox, ConvertToModernFileEnforcement, feature flag 832843065, PR #25305, lockdown policy