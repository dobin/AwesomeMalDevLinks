# https://research.checkpoint.com/2024/net-hooking-harmonizing-managed-territory/

<!DOCTYPE html><html lang="en-US">
<body class="wp-singular post-template-default single single-post postid-29314 single-format-standard wp-theme-research-th">
 

 

<div class="container container-wide">
	<div class="mobile-categories-nav">
		<div class="sidebar-post-categories">
	<div class="text font-blue">
			<h2>CATEGORIES</h2>
		</div>
					<ul class="post-category">
			 
			<li> 
				<a href="https://research.checkpoint.com/category/android-malware/">
					<input type="checkbox" id="10457" class="cat-filter" value="10457">
					<label for="10457"> Android Malware</label>
					<span>23</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/artificial-intelligence-2/">
					<input type="checkbox" id="10621" class="cat-filter" value="10621">
					<label for="10621"> Artificial Intelligence</label>
					<span>4</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/chatgpt/">
					<input type="checkbox" id="10637" class="cat-filter" value="10637">
					<label for="10637"> ChatGPT</label>
					<span>3</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/threat-research/">
					<input type="checkbox" id="10441" class="cat-filter" value="10441">
					<label for="10441"> Check Point Research Publications</label>
					<span>443</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/cloud-security/">
					<input type="checkbox" id="10634" class="cat-filter" value="10634">
					<label for="10634"> Cloud Security</label>
					<span>1</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/cpradio/">
					<input type="checkbox" id="10539" class="cat-filter" value="10539">
					<label for="10539"> CPRadio</label>
					<span>44</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/crypto/">
					<input type="checkbox" id="10655" class="cat-filter" value="10655">
					<label for="10655"> Crypto</label>
					<span>2</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/data-threat-intelligence/">
					<input type="checkbox" id="10643" class="cat-filter" value="10643">
					<label for="10643"> Data &amp; Threat Intelligence</label>
					<span>1</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/data-analysis/">
					<input type="checkbox" id="10645" class="cat-filter" value="10645">
					<label for="10645"> Data Analysis</label>
					<span>0</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/demos/">
					<input type="checkbox" id="10062" class="cat-filter" value="10062">
					<label for="10062"> Demos</label>
					<span>22</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/threat-intelligence-reports/">
					<input type="checkbox" id="10060" class="cat-filter" value="10060">
					<label for="10060"> Global Cyber Attack Reports</label>
					<span>395</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/how-to-guides/">
					<input type="checkbox" id="10475" class="cat-filter" value="10475">
					<label for="10475"> How To Guides</label>
					<span>13</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/ransomware/">
					<input type="checkbox" id="10622" class="cat-filter" value="10622">
					<label for="10622"> Ransomware</label>
					<span>3</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/russo-ukrainian-war/">
					<input type="checkbox" id="10624" class="cat-filter" value="10624">
					<label for="10624"> Russo-Ukrainian War</label>
					<span>1</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/security-report/">
					<input type="checkbox" id="10656" class="cat-filter" value="10656">
					<label for="10656"> Security Report</label>
					<span>1</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/threat-and-data-analysis/">
					<input type="checkbox" id="10644" class="cat-filter" value="10644">
					<label for="10644"> Threat and data analysis</label>
					<span>0</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/threat-research-2/">
					<input type="checkbox" id="10458" class="cat-filter" value="10458">
					<label for="10458"> Threat Research</label>
					<span>173</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/web3/">
					<input type="checkbox" id="10653" class="cat-filter" value="10653">
					<label for="10653"> Web 3.0 Security</label>
					<span>11</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/wipers/">
					<input type="checkbox" id="10623" class="cat-filter" value="10623">
					<label for="10623"> Wipers</label>
					<span>0</span>
				</a>	
			</li>
					</ul>
		</div>

	</div>
</div>
<section id="single-post" class="blog-post-wrapper single-blog-wrapper section-padding background-blue ">
	<div class="container container-wide">
		
		<div class="flex-row align-items-start">
			<div class="flex-8 font-white">
				<div class="blog-post-wrap">
					<div class="flex-row">
						<div class="flex-12">
														<div class="image">
								<img src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId20.png" alt="">
							</div>
													</div>
						<div class="flex-9">
							<div class="text">
								<h1 class="h3">.NET Hooking – Harmonizing Managed Territory</h1>
								<div class="date">
									<svg xmlns="http://www.w3.org/2000/svg" width="14.012" height="14.012" viewBox="0 0 14.012 14.012"><path id="Path_149" data-name="Path 149" d="M1.752,4.379v7.882H12.261V4.379Zm9.634-2.627h1.752a.827.827,0,0,1,.876.876V13.137a.827.827,0,0,1-.876.876H.876A.827.827,0,0,1,0,13.137V2.627a.827.827,0,0,1,.876-.876H2.627V.876A.827.827,0,0,1,3.5,0a.827.827,0,0,1,.876.876v.876H9.634V.876a.876.876,0,1,1,1.752,0Zm-.876,8.758H8.758V8.758h1.752Zm-2.627,0H6.13V8.758H7.882Zm2.627-2.627H8.758V6.13h1.752Zm-2.627,0H6.13V6.13H7.882ZM5.255,10.509H3.5V8.758H5.255Z" fill="#fff" fill-rule="evenodd"></path></svg>									
									January 8, 2024								</div>
							</div>
						</div>
						<div class="flex-3">
							<div class="social-button">
		<div class="icon-sharing-links">
			<a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://research.checkpoint.com/2024/net-hooking-harmonizing-managed-territory/%20-%20%20https://research.checkpoint.com/?p=29314;source=LinkedIn" title="Share on LinkedIn!"><svg style="fill: currentColor;" id="Group_185773" data-name="Group 185773" xmlns="http://www.w3.org/2000/svg" width="15.863" height="15.697" viewBox="0 0 15.863 15.697"><path id="Path_28" data-name="Path 28" d="M41.342,107.835H38.107V97.622c2.039-.532,2.921-.341,3.249.629a10.413,10.413,0,0,1,2.275-1.038c2.6-.5,4.128.657,4.565,3.306a7.793,7.793,0,0,1,.128,1.212c.014,1.986.006,3.973.006,6.07H45.04c0-1.073,0-2.147,0-3.22,0-.724.016-1.449-.015-2.173-.075-1.7-.606-2.4-1.771-2.4-1.211.006-1.861.8-1.9,2.469C41.31,104.241,41.342,106,41.342,107.835Z" transform="translate(-32.47 -92.138)" fill="currentColor"></path><path id="Path_29" data-name="Path 29" d="M31.482,97.555h3.156v10.359H31.482Z" transform="translate(-31.164 -92.228)" fill="currentColor"></path> <path id="Path_30" data-name="Path 30" d="M32.993,94.694a1.862,1.862,0,0,1-1.907-1.862,1.891,1.891,0,0,1,1.88-1.912,1.867,1.867,0,0,1,1.889,1.885A1.816,1.816,0,0,1,32.993,94.694Z" transform="translate(-31.086 -90.92)" fill="currentColor"></path></svg></a>
			
			<a target="blank" href="http://www.facebook.com/sharer.php?u=https://research.checkpoint.com/2024/net-hooking-harmonizing-managed-territory/%20-%20https://research.checkpoint.com/?p=29314" title="Share on Facebook!"><svg style="fill: currentColor;" id="WKND-icon" xmlns="http://www.w3.org/2000/svg" width="14.347" height="14.347" viewBox="0 0 14.347 14.347"><rect id="background" width="14.347" height="14.347" transform="translate(0 0)" fill="transparent"></rect><g id="Dribbble-Light-Preview" transform="translate(3.966 0.077)"><g id="icons"><path id="facebook-_176_" data-name="facebook-[#176]" d="M333.867,7253.27v-6.422h1.95l.318-2.854h-2.268V7242.6c0-.735.019-1.465,1.046-1.465h1.04V7239.1a11.584,11.584,0,0,0-1.8-.1c-1.888,0-3.07,1.183-3.07,3.354v1.641H329v2.854h2.086v6.422Z" transform="translate(-329 -7239)" fill="currentColor" fill-rule="evenodd"></path> </g></g></svg></a>
			
			<a target="blank" href="http://twitter.com/home/?status=.NET%20Hooking%20%E2%80%93%20Harmonizing%20Managed%20Territory%20-%20https://research.checkpoint.com/?p=29314%20via%20@kenmata" title="Tweet this!"><svg style="fill: currentColor;" id="WKND-icon" xmlns="http://www.w3.org/2000/svg" width="14.515" height="14.347" viewBox="0 0 14.515 14.347"><rect id="background" width="14.347" height="14.347" transform="translate(0 0)" fill="transparent"></rect><g id="Dribbble-Light-Preview" transform="translate(0.245 1.504)"><g id="icons"><path id="twitter-_154_" data-name="twitter-[#154]" d="M8.488,7372.416a8.206,8.206,0,0,0,8.33-8.2c0-.125,0-.25-.009-.373a5.9,5.9,0,0,0,1.461-1.492,5.926,5.926,0,0,1-1.681.453,2.9,2.9,0,0,0,1.287-1.595,5.9,5.9,0,0,1-1.859.7,2.964,2.964,0,0,0-4.143-.125,2.858,2.858,0,0,0-.847,2.754,8.364,8.364,0,0,1-6.034-3.011,2.857,2.857,0,0,0,.907,3.847,2.942,2.942,0,0,1-1.329-.36v.036a2.9,2.9,0,0,0,2.349,2.825,2.954,2.954,0,0,1-1.321.049,2.924,2.924,0,0,0,2.735,2,5.929,5.929,0,0,1-3.636,1.236,5.847,5.847,0,0,1-.7-.041,8.379,8.379,0,0,0,4.488,1.292" transform="translate(-4 -7361)" fill="currentColor" fill-rule="evenodd"></path></g></g></svg></a>
		
			<a title="Copy this!"><svg style="fill: currentColor;" xmlns="http://www.w3.org/2000/svg" width="18.7" height="18.7" viewBox="0 0 18.7 18.7"><g id="Group_185774" data-name="Group 185774" transform="translate(-591.15 -798.097)"><g id="copy" transform="translate(592 798.947)"><rect id="Rectangle_147602" data-name="Rectangle 147602" width="11" height="11" rx="2" transform="translate(6 6)" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.7"></rect><path id="Path_83125" data-name="Path 83125" d="M4.542,13.016H3.695A1.7,1.7,0,0,1,2,11.321V3.695A1.7,1.7,0,0,1,3.695,2h7.626a1.7,1.7,0,0,1,1.695,1.695v.847" transform="translate(-2 -2)" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.7"></path></g></g></svg></a>
			<div id="29314" style="display: none;">https://research.checkpoint.com/2024/net-hooking-harmonizing-managed-territory/</div>
		
		</div>
		<div class="icon-sharing"></div>	
</div>						</div>
					</div>
										
					<div class="text border-bottom">
						
<p class="wp-block-paragraph"><strong>Research by:</strong> Jiri Vinopal</p>



<h2 class="wp-block-heading" id="key-points">Key Points</h2>



<ul class="wp-block-list">
<li><em><strong>Check Point Research (CPR) provides an introduction to .NET managed hooking using the Harmony library.</strong></em></li>



<li><em><strong>We cover the most common examples of implementation using different types of Harmony patches.</strong></em></li>



<li><em><strong>The practical example using Harmony hooking to defeat the notorious “ConfuserEx2” obfuscator results in the “ConfuserEx2_String_Decryptor” tool.</strong></em></li>



<li><em><strong>CPR reveals a neat trick how to combine both debugging and hooking using the Harmony library (Harmony hooking from the dnSpyEx debugging context).</strong></em></li>
</ul>



<h2 class="wp-block-heading" id="introduction">Introduction</h2>



<p class="wp-block-paragraph">For a malware researcher, analyst, or reverse engineer, the ability to alter the functionality of certain parts of code is a crucial step, often necessary to reach a meaningful result during the analysis process. This kind of code instrumentation is usually reached by debugging, DBI (Dynamic Binary Instrumentation), or a simple hooking framework.</p>



<p class="wp-block-paragraph">Managing the code execution of the desired process has always worked well for non-managed, native code. We have many useful tools and frameworks that are proven to be very effective.</p>



<p class="wp-block-paragraph">The situation is a little bit different when we start to talk about altering the functionality of managed code, more specifically, applications that run on top of .NET. The ability to instrument the code on the managed layer is limited by the small number of tools that can safely do so. One that stands head and shoulders above the rest is the&nbsp;<strong><a href="https://github.com/pardeike/Harmony">Harmony</a>,</strong>&nbsp;an open-source library for patching, replacing, and decorating .NET methods&nbsp;<strong>during runtime</strong>.</p>



<p class="wp-block-paragraph">In some cases, it is possible to use other specific libraries and frameworks to modify the code of .NET Assemblies with direct patching or a complete rebuild of those files on disk, but such a solution is not always feasible. It becomes even less so as the logic of the original code becomes more fragile and sophisticated.</p>



<p class="wp-block-paragraph">This is an especially sore point when dealing with malware samples that are protected and obfuscated in a way that touching them on the disk could easily destroy the original structure, causing undesirable behavior changes or a complete loss of functionality. Especially in these cases, modifying the code logic in memory&nbsp;<strong>during runtime</strong>&nbsp;is the convenient solution.</p>



<p class="wp-block-paragraph">In this article, we introduce the concept of .NET managed hooking using the&nbsp;<strong>Harmony</strong>&nbsp;library, its internals, and common examples of implementation using different types of Harmony patches. We show how useful Harmony hooking can be in a practical exercise of defeating the notorious obfuscator “<strong>ConfuserEx2</strong>” that resulted in the release of the “<strong>ConfuserEx2_String_Decryptor</strong>” tool. The last section reveals a neat trick how to combine debugging and hooking using the Harmony library, or in other words, using Harmony hooking from the dnSpyEx debugging context.</p>



<h2 class="wp-block-heading" id="introduction-to-.net-managed-hooking-using-harmony">Introduction to .NET Managed Hooking Using Harmony</h2>



<p class="wp-block-paragraph">In one of our previous publications, we introduced a way to hook the native layer of .NET to alter the functionality of certain WIN API functions. See&nbsp;<a href="https://research.checkpoint.com/2023/dotrunpex-demystifying-new-virtualized-net-injector-used-in-the-wild/">dotRunpeX</a>&nbsp;(<strong>Invoke-DotRunpeXextract</strong>&nbsp;– preinjection of a native hooking library).</p>



<p class="wp-block-paragraph">Generally, the managed hooking of .NET works a little bit differently than the hooking of its native layer, as we are targeting the higher level of the code representation (<strong>Intermediate Language</strong>) that resides on the managed layer. This results in a similar instrumentation but with significantly better control over all executed instructions.</p>



<p class="wp-block-paragraph">Most .NET-managed hooking tools work like simple patching libraries, allowing the original method to be replaced. This is the reason why we decided to go with the&nbsp;<a href="https://harmony.pardeike.net/index.html">Harmony2 library</a>, which goes one step further and gives us the ability to:</p>



<ol class="wp-block-list">
<li>Keep the original method intact.</li>



<li>Execute code before and/or after the original method.</li>



<li>Modify the original IL code of the method with IL code processors.</li>



<li>Multiple co-existing hooks/patches that don´t conflict with each other.</li>
</ol>



<p class="wp-block-paragraph">The Harmony2 is a hooking library written in C# for patching, replacing, and decorating .NET methods during runtime. It uses a variation of hooking and focuses only on in-memory changes that don’t affect files on disk. It supports&nbsp;<strong>Mono</strong>&nbsp;and&nbsp;<strong>.NET</strong>&nbsp;environments on Windows, Unix, and macOS, targeting all programming languages that compile to&nbsp;<a href="https://wikipedia.org/wiki/Common_Intermediate_Language">CIL</a>&nbsp;(also known as&nbsp;<strong>Intermediate Language</strong>,&nbsp;<strong>IL code</strong>,&nbsp;<strong>MSIL</strong>).</p>



<p class="wp-block-paragraph">One of the main advantages of the Harmony library is that it operates only on in-memory code, so it does not touch the files on disk in any way. This comes in very handy, especially in cases where we are dealing with dotnet malware protected by some obfuscator in a way that the deobfuscation via .NET Assembly rebuilding is time-consuming and needs to be done very carefully so as not to destroy the original structure, which can lead to a complete loss of functionality.</p>



<p class="wp-block-paragraph">The other advantage is that we are not limited to only hook .NET methods defined in the scope of one specific .NET Assembly, but we can alter the functionality of all referenced assemblies, especially those that come with and build the .NET Runtime.</p>



<p class="wp-block-paragraph"><strong>Bootstrapping and Injection</strong></p>



<p class="wp-block-paragraph">It is important to note that the Harmony library does not provide the functionality to run our own code within an application that is not designed to execute foreign code. We need a way to inject at least the few lines that start the Harmony patching. This is usually done with a loader/injector (e.g., the GUI-based tool&nbsp;<a href="https://github.com/wwh1004/ExtremeDumper#inject-net-assemblies">ExtremeDumper</a>&nbsp;can be used to inject the Harmony library into the .NET process) but can also be easily reached by using&nbsp;<a href="https://learn.microsoft.com/en-us/dotnet/framework/reflection-and-codedom/reflection">Reflection</a>.</p>



<h3 class="wp-block-heading" id="types-of-patches">Types of Patches</h3>



<p class="wp-block-paragraph">For .NET method hooking, the Harmony library provides several types of patches:&nbsp;<strong>Prefix</strong>,&nbsp;<strong>Postfix</strong>,&nbsp;<strong>Transpiler</strong>,&nbsp;<strong>Finalizer</strong>, and&nbsp;<strong>Reverse Patch</strong>. Each of them serves a different purpose and gives different capabilities. The Prefix, Postfix, Transpiler, and Reverse Patch are the main subjects of this article, but we briefly explain all types below.</p>



<p class="wp-block-paragraph"><strong>Prefix</strong></p>



<p class="wp-block-paragraph">A Prefix is a method that is executed&nbsp;<strong>before</strong>&nbsp;the original method. It is commonly used to:</p>



<ul class="wp-block-list">
<li>Access and edit the arguments of the original method.</li>



<li>Skip the original method.</li>



<li>Set the result of the original method – skipping the original is necessary.</li>



<li>Set a custom state that can be recalled in the Postfix.</li>



<li>Run a piece of code at the beginning that is guaranteed to be executed.</li>
</ul>



<p class="wp-block-paragraph"><strong>Postfix</strong></p>



<p class="wp-block-paragraph">A Postfix is a method that is executed&nbsp;<strong>after</strong>&nbsp;the original method. It is commonly used to:</p>



<ul class="wp-block-list">
<li>Read or change the result of the original method.</li>



<li>Access the arguments of the original method.</li>



<li>Read a custom state from the Prefix.</li>
</ul>



<p class="wp-block-paragraph"><strong>Transpiler</strong></p>



<p class="wp-block-paragraph">This method defines the Transpiler that&nbsp;<strong>modifies</strong>&nbsp;the code of the original method. It is supposed to be used in advanced cases where we need to modify the IL Code of the original method body. Transpilers are called in an earlier stage where the instructions of the original method are fed into them for processing, changing them to a final output of the instruction set that builds the new “<em><strong>original</strong></em>” method. Transpilers are commonly used to:</p>



<ul class="wp-block-list">
<li>Modify the original method in detail (on the level of its IL Code).</li>



<li>Change the whole logic of the original method.</li>



<li>Change certain IL instructions.</li>
</ul>



<p class="wp-block-paragraph"><strong>Finalizer</strong></p>



<p class="wp-block-paragraph">A Finalizer is a method that&nbsp;<strong>handles exceptions</strong>&nbsp;and can change them. It is executed after all Postfixes. It wraps the original, all Prefixes, and Postfixes in a try/catch logic and is either called with&nbsp;<code>null</code>&nbsp;(no exception) or with an exception if one occurred. It is commonly used to:</p>



<ul class="wp-block-list">
<li>Run a piece of code at the end that is guaranteed to be executed.</li>



<li>Handle exceptions and suppress them.</li>



<li>Handle exceptions and alter them.</li>
</ul>



<p class="wp-block-paragraph"><strong>Reverse Patch</strong></p>



<p class="wp-block-paragraph">A Reverse Patch method is different from the previous types in that it&nbsp;<strong>patches our own</strong>&nbsp;methods instead of foreign original ones. It is a stub method in our code that “<em><strong>becomes</strong></em>” the original or part of the original (via&nbsp;<strong>Reverse Patch Transpiler</strong>) method so we can use it or call it independently. The defined stub method needs to look like the original in some way (the same method signature). A Reverse Patch is commonly used to:</p>



<ul class="wp-block-list">
<li>Provide the&nbsp;<strong>unmodified</strong>&nbsp;original method (not affected by any applied patches) that can be called from our code, patches, or even from the patches that are applied to the method from which the Reverse Patch is created.</li>



<li>Provide a&nbsp;<strong>snapshot</strong>&nbsp;of the method that is constructed from the original method and all the applied Transpilers.</li>



<li>Provide a part of the original method by using the Reverse Patch Transpiler.</li>



<li>Easily call private methods.</li>
</ul>



<p class="wp-block-paragraph">The simplified hooking logic summary of the Harmony library is shown below:</p>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img fetchpriority="high" decoding="async" width="1024" height="580" src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId31-2-1024x580.png" alt="" class="wp-image-29333"><figcaption class="wp-element-caption">Figure 1: Harmony library – Hooking logic (Source: “https://harmony.pardeike.net/articles/intro.html”).</figcaption></figure>
</div>


<h2 class="wp-block-heading" id="common-examples-of-implementation">Common Examples of Implementation</h2>



<p class="wp-block-paragraph">In this section, we go through simple examples of implementation, focusing on the four most commonly used types of patches:&nbsp;<strong>Prefix</strong>,&nbsp;<strong>Postfix</strong>,&nbsp;<strong>Transpiler</strong>, and&nbsp;<strong>Reverse Patch</strong>. These patches are used for typical scenarios like reading and changing the arguments of the method, changing the result (return value), modifying the IL code of the original method, and as a way to call the unmodified version of the original method.</p>



<p class="wp-block-paragraph">There are two common ways of creating and organizing patches using the Harmony library. One of them is using&nbsp;<a href="https://harmony.pardeike.net/articles/annotations.html">annotation</a>&nbsp;– Patch Class – that simplifies patching by assuming that we set up annotated classes and define patch methods inside them. This is usually used to better organize patches and perform more types of patches on a single original method (combination of Prefix, Postfix, etc.).</p>



<p class="wp-block-paragraph">The second one –&nbsp;<a href="https://harmony.pardeike.net/articles/basics.html#manual-patching">Manual Patching</a>&nbsp;– gives us more control to put patches wherever we like as we refer to them ourselves, but we must rely greatly on the direct use of the reflection. For simplicity, in the common examples of implementation below, only&nbsp;<strong>Manual Patching</strong>&nbsp;is used.</p>



<p class="wp-block-paragraph">Before we jump to hooking with the Harmony library, we need to create our sample application that will be a target for hooking and used in all the examples of common implementation. For that purpose, we can build a simple C#, Console App using .NET Framework (Release – x86) as shown below:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">namespace Example</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    internal </span><span class="enlighter-k1">class</span><span class="enlighter-text"> Program</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        public static int </span><span class="enlighter-m0">Sum</span><span class="enlighter-g1">(</span><span class="enlighter-text">int a, int b</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"> </span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">return</span><span class="enlighter-text"> a + b;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        static </span><span class="enlighter-k1">void</span><span class="enlighter-text"> </span><span class="enlighter-m0">Main</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook Me If You Can!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span></div></div><div class=""><div><span class="enlighter-text">            int result = </span><span class="enlighter-m0">Sum</span><span class="enlighter-g1">(</span><span class="enlighter-n1">333</span><span class="enlighter-text">, </span><span class="enlighter-n1">333</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-text">$</span><span class="enlighter-s0">"Result of the Sum: {result}"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">namespace Example
{
    internal class Program
    {
        public static int Sum(int a, int b) 
        { 
            return a + b;
        }

        static void Main()
        {
            Console.WriteLine("Hook Me If You Can!!!");
            
            int result = Sum(333, 333);
            Console.WriteLine($"Result of the Sum: {result}");
        }
    }
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">namespace Example
{
    internal class Program
    {
        public static int Sum(int a, int b) 
        { 
            return a + b;
        }

        static void Main()
        {
            Console.WriteLine("Hook Me If You Can!!!");
            
            int result = Sum(333, 333);
            Console.WriteLine($"Result of the Sum: {result}");
        }
    }
}</pre>



<p class="wp-block-paragraph">Checking the compiled binary and its execution in&nbsp;<a href="https://github.com/dnSpyEx/dnSpy">dnSpyEx</a>:</p>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId39.png" alt="Figure 2: The sample compiled application that will be used as a
target for hooking - dnSpyEx execution."><figcaption class="wp-element-caption">Figure 2: The sample compiled application that will be used as a target for hooking – dnSpyEx execution.</figcaption></figure>
</div>


<p class="wp-block-paragraph">As we noted previously, the Harmony library does not provide the functionality to run our own code within an application that is not designed to execute foreign code. Therefore, we need to create a loader/injector that will execute the hooking logic inside of the sample targeted application. The simplest and most straightforward solution is for us to use&nbsp;<a href="https://learn.microsoft.com/en-us/dotnet/framework/reflection-and-codedom/reflection">Reflection</a>.</p>



<p class="wp-block-paragraph">By using reflection, we can simply create a loader – another C#, Console App using .NET Framework (Release – x86) – that directly loads the target application (using reflection) and implements the hooking logic with the use of Harmony library. Such a loader is used in all examples below where it is mainly the hooking logic that changes.</p>



<h3 class="wp-block-heading" id="prefix---changing-the-methods-arguments-and-executing">Prefix – Changing the Method´s Arguments and Executing</h3>



<p class="wp-block-paragraph">One of the most common practical cases is just a simple hook that modifies the original arguments and continues the execution of the original method. For this purpose, we need to use the Prefix type of patch. The original method that is going to be hooked by a Prefix type of patch is not a method implemented by our targeted application itself but is a referenced method that resides inside of&nbsp;<code>System.Console.dll</code>&nbsp;Assembly with a signature:&nbsp;<code>void WriteLine(System.String)</code>.</p>



<p class="wp-block-paragraph"><strong>Step-by-Step Guide:</strong></p>



<ol class="wp-block-list">
<li>Implement Harmony patch for Prefix “Manual Patching”&nbsp;<code>PreFix_WriteLine</code>&nbsp;– To change the argument value, it needs to be passed by reference, so adding the&nbsp;<code>ref</code>&nbsp;keyword is necessary. The return&nbsp;<code>bool</code>&nbsp;value of the Prefix patch method&nbsp;<code>PreFix_WriteLine</code>&nbsp;signals if the execution of the original method should be skipped (<code>false</code>&nbsp;– skip,&nbsp;<code>true</code>&nbsp;– do not skip).</li>



<li>Load the targeted application using reflection.</li>



<li>Install the Prefix patch for method&nbsp;<code>void Console.WriteLine(System.String)</code>.</li>



<li>Execute the&nbsp;<code>EntryPoint</code>&nbsp;of the targeted application (method&nbsp;<code>Example.Program.Main()</code>).</li>
</ol>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">using System;</span></div></div><div class=""><div><span class="enlighter-text">using System.</span><span class="enlighter-m3">Reflection</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">using HarmonyLib;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">namespace CaptainHook</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    internal </span><span class="enlighter-k1">class</span><span class="enlighter-text"> Hook</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        static </span><span class="enlighter-k1">void</span><span class="enlighter-text"> </span><span class="enlighter-m0">Main</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Loading the targeted application using reflection</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            Assembly assembly = Assembly.</span><span class="enlighter-m3">LoadFile</span><span class="enlighter-g1">(</span><span class="enlighter-text">@</span><span class="enlighter-s0">"C:\Example.exe"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Installing the Prefix patch for method "void Console.WriteLine(System.String)"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            MethodInfo target = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">Console</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"WriteLine"</span><span class="enlighter-text">, </span><span class="enlighter-k1">new</span><span class="enlighter-g1">[]</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"> </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">string</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">})</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">target == </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                throw </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Exception</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Could not resolve Console.WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            Harmony harmony = </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Harmony</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            MethodInfo patch = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">Hook</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"PreFix_WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            harmony.</span><span class="enlighter-m3">Patch</span><span class="enlighter-g1">(</span><span class="enlighter-text">target, </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">HarmonyMethod</span><span class="enlighter-g1">(</span><span class="enlighter-text">patch</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Executing the targeted application</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            assembly.</span><span class="enlighter-m3">EntryPoint</span><span class="enlighter-text">.</span><span class="enlighter-m3">Invoke</span><span class="enlighter-g1">(</span><span class="enlighter-k1">null</span><span class="enlighter-text">, </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Implementation of Harmony patch used for Prefix "Manual Patching" </span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        public static bool </span><span class="enlighter-m0">PreFix_WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-text">ref string value</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">value.</span><span class="enlighter-m3">Contains</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook"</span><span class="enlighter-g1">))</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"> value = </span><span class="enlighter-s0">"Captain Hook Was Here!!!"</span><span class="enlighter-text">; </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-k1">true</span><span class="enlighter-text">; </span><span class="enlighter-c0">// Do not skip executing original Console.WriteLine()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">using System;
using System.Reflection;
using HarmonyLib;

namespace CaptainHook
{
    internal class Hook
    {
        static void Main()
        {
            // Loading the targeted application using reflection
            Assembly assembly = Assembly.LoadFile(@"C:\Example.exe");

            // Installing the Prefix patch for method "void Console.WriteLine(System.String)"
            MethodInfo target = typeof(Console).GetMethod("WriteLine", new[] { typeof(string) });
            if (target == null)
                throw new Exception("Could not resolve Console.WriteLine");

            Harmony harmony = new Harmony("WriteLine");
            MethodInfo patch = typeof(Hook).GetMethod("PreFix_WriteLine");
            harmony.Patch(target, new HarmonyMethod(patch));

            // Executing the targeted application
            assembly.EntryPoint.Invoke(null, null);
        }

        // Implementation of Harmony patch used for Prefix "Manual Patching" 
        public static bool PreFix_WriteLine(ref string value)
        {
            if (value.Contains("Hook")) { value = "Captain Hook Was Here!!!"; }
            return true; // Do not skip executing original Console.WriteLine()
        }
    }
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">using System;
using System.Reflection;
using HarmonyLib;

namespace CaptainHook
{
    internal class Hook
    {
        static void Main()
        {
            // Loading the targeted application using reflection
            Assembly assembly = Assembly.LoadFile(@"C:\Example.exe");

            // Installing the Prefix patch for method "void Console.WriteLine(System.String)"
            MethodInfo target = typeof(Console).GetMethod("WriteLine", new[] { typeof(string) });
            if (target == null)
                throw new Exception("Could not resolve Console.WriteLine");

            Harmony harmony = new Harmony("WriteLine");
            MethodInfo patch = typeof(Hook).GetMethod("PreFix_WriteLine");
            harmony.Patch(target, new HarmonyMethod(patch));

            // Executing the targeted application
            assembly.EntryPoint.Invoke(null, null);
        }

        // Implementation of Harmony patch used for Prefix "Manual Patching" 
        public static bool PreFix_WriteLine(ref string value)
        {
            if (value.Contains("Hook")) { value = "Captain Hook Was Here!!!"; }
            return true; // Do not skip executing original Console.WriteLine()
        }
    }
}</pre>



<p class="wp-block-paragraph">As we can see below, the method&nbsp;<code>void Console.WriteLine(System.String)</code>&nbsp;was successfully hooked, and all its invocations were intercepted by the implemented Prefix patch&nbsp;<code>PreFix_WriteLine</code>. It only changed when the original argument contained the string value “<strong>Hook</strong>” (e.g., “<strong>Hook Me If You Can!!!</strong>” → “<strong>Captain Hook Was Here!!!</strong>”).</p>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId42.png" alt="Figure 3: Prefix hook - Changing the arguments of the
“Console.WriteLine()” method."><figcaption class="wp-element-caption">Figure 3: Prefix hook – Changing the arguments of the “Console.WriteLine()” method.</figcaption></figure>
</div>


<h3 class="wp-block-heading" id="prefix---changing-the-result-and-skipping-the-original">Prefix – Changing the Result and Skipping the Original</h3>



<p class="wp-block-paragraph">It can sometimes be useful to completely skip the original method and simply set the result (the return value) for all its invocations. To skip the execution of the original method, we need to choose the Prefix type of patch as it is the one that is going to be executed before the original and can easily skip the original´s execution. The original method&nbsp;<code>Sum()</code>&nbsp;that is going to be hooked by a Prefix type of patch is now a method implemented by our targeted application itself with a signature:&nbsp;<code>System.Int32 Example.Program.Sum(System.Int32, System.Int32)</code>.</p>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId46.png" alt="Figure 4: The dnSpyEx view of the compiled original method “Sum()” -
the target for hooking."><figcaption class="wp-element-caption">Figure 4: The dnSpyEx view of the compiled original method “Sum()” – the target for hooking.</figcaption></figure>
</div>


<p class="wp-block-paragraph">Currently, this case is slightly different in the sense that we are hooking an original method that is part of the targeted application´s type –&nbsp;<strong>runtime type</strong>. The steps will change a little as well.</p>



<p class="wp-block-paragraph"><strong>Step-by-Step Guide:</strong></p>



<ol class="wp-block-list">
<li>Implement Harmony patch for Prefix “Manual Patching”&nbsp;<code>PreFix_Sum</code>&nbsp;– To change the return value, the argument called&nbsp;<code>__result</code>&nbsp;(the type must match the return type of the original or be assignable from it) must be added to the original method´s parameters and passed by reference. Therefore, it is necessary to add the&nbsp;<code>ref</code>&nbsp;keyword to it. The return&nbsp;<code>bool</code>&nbsp;value (<code>false</code>) of the Prefix patch method&nbsp;<code>PreFix_Sum</code>&nbsp;signals that the execution of the original method should be skipped (<code>false</code>&nbsp;– skip,&nbsp;<code>true</code>&nbsp;– do not skip).</li>



<li>Load the targeted application using reflection.</li>



<li>Install the Prefix patch for method&nbsp;<code>System.Int32 Example.Program.Sum(System.Int32, System.Int32)</code>&nbsp;– As the targeted method is a part of the runtime type (loaded Assembly), we can´t use the&nbsp;<code>typeof()</code>&nbsp;operator or the&nbsp;<code>nameof()</code>&nbsp;expression, but we can use the Harmony&nbsp;<a href="https://harmony.pardeike.net/articles/utilities.html#accesstools">AccessTools</a>&nbsp;as a shortcut for reflection to quickly locate it.</li>



<li>Execute the&nbsp;<code>EntryPoint</code>&nbsp;of the targeted application (method&nbsp;<code>Example.Program.Main()</code>).</li>
</ol>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">using System;</span></div></div><div class=""><div><span class="enlighter-text">using System.</span><span class="enlighter-m3">Reflection</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">using HarmonyLib;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">namespace CaptainHook</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    internal </span><span class="enlighter-k1">class</span><span class="enlighter-text"> Hook</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        static </span><span class="enlighter-k1">void</span><span class="enlighter-text"> </span><span class="enlighter-m0">Main</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Loading the targeted application using reflection</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            Assembly assembly = Assembly.</span><span class="enlighter-m3">LoadFile</span><span class="enlighter-g1">(</span><span class="enlighter-text">@</span><span class="enlighter-s0">"C:\Example.exe"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Installing the Prefix patch for method "int Example.Program.Sum(int, int)"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// The targeted method resides in a runtime type - loaded Assembly</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// We can use the Harmony AccessTools as a shortcut for reflection</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            MethodInfo target = AccessTools.</span><span class="enlighter-m3">Method</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Example.Program:Sum"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">target == </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                throw </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Exception</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Could not resolve Example.Program.Sum"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            Harmony harmony = </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Harmony</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Sum"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            MethodInfo patch = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">Hook</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"PreFix_Sum"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            harmony.</span><span class="enlighter-m3">Patch</span><span class="enlighter-g1">(</span><span class="enlighter-text">target, </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">HarmonyMethod</span><span class="enlighter-g1">(</span><span class="enlighter-text">patch</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Executing the targeted application</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            assembly.</span><span class="enlighter-m3">EntryPoint</span><span class="enlighter-text">.</span><span class="enlighter-m3">Invoke</span><span class="enlighter-g1">(</span><span class="enlighter-k1">null</span><span class="enlighter-text">, </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Implementation of Harmony patch used for Prefix "Manual Patching"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        public static bool </span><span class="enlighter-m0">PreFix_Sum</span><span class="enlighter-g1">(</span><span class="enlighter-text">ref int __result, int a, int b</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            __result = a + b + </span><span class="enlighter-n1">666000</span><span class="enlighter-text">; </span><span class="enlighter-c0">// Setting the result - return value</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-k1">false</span><span class="enlighter-text">; </span><span class="enlighter-c0">// Skip executing the original Example.Program.Sum()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">using System;
using System.Reflection;
using HarmonyLib;

namespace CaptainHook
{
    internal class Hook
    {
        static void Main()
        {
            // Loading the targeted application using reflection
            Assembly assembly = Assembly.LoadFile(@"C:\Example.exe");

            // Installing the Prefix patch for method "int Example.Program.Sum(int, int)"
            // The targeted method resides in a runtime type - loaded Assembly
            // We can use the Harmony AccessTools as a shortcut for reflection
            MethodInfo target = AccessTools.Method("Example.Program:Sum");
            if (target == null)
                throw new Exception("Could not resolve Example.Program.Sum");

            Harmony harmony = new Harmony("Sum");
            MethodInfo patch = typeof(Hook).GetMethod("PreFix_Sum");
            harmony.Patch(target, new HarmonyMethod(patch));

            // Executing the targeted application
            assembly.EntryPoint.Invoke(null, null);
        }

        // Implementation of Harmony patch used for Prefix "Manual Patching"
        public static bool PreFix_Sum(ref int __result, int a, int b)
        {
            __result = a + b + 666000; // Setting the result - return value
            return false; // Skip executing the original Example.Program.Sum()
        }
    }
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">using System;
using System.Reflection;
using HarmonyLib;

namespace CaptainHook
{
    internal class Hook
    {
        static void Main()
        {
            // Loading the targeted application using reflection
            Assembly assembly = Assembly.LoadFile(@"C:\Example.exe");

            // Installing the Prefix patch for method "int Example.Program.Sum(int, int)"
            // The targeted method resides in a runtime type - loaded Assembly
            // We can use the Harmony AccessTools as a shortcut for reflection
            MethodInfo target = AccessTools.Method("Example.Program:Sum");
            if (target == null)
                throw new Exception("Could not resolve Example.Program.Sum");

            Harmony harmony = new Harmony("Sum");
            MethodInfo patch = typeof(Hook).GetMethod("PreFix_Sum");
            harmony.Patch(target, new HarmonyMethod(patch));

            // Executing the targeted application
            assembly.EntryPoint.Invoke(null, null);
        }

        // Implementation of Harmony patch used for Prefix "Manual Patching"
        public static bool PreFix_Sum(ref int __result, int a, int b)
        {
            __result = a + b + 666000; // Setting the result - return value
            return false; // Skip executing the original Example.Program.Sum()
        }
    }
}</pre>



<p class="wp-block-paragraph">The method&nbsp;<code>System.Int32 Example.Program.Sum(System.Int32, System.Int32)</code>&nbsp;was successfully hooked, and its invocation was intercepted by the implemented Prefix patch&nbsp;<code>PreFix_Sum</code>. The execution of the original method was skipped, and the result (return value) was altered in a way that worked with the original arguments but modified the result as we wished (e.g., from “<strong>Sum(333, 333) → 666</strong>” to “<strong>Sum(333, 333) → 666 + 666000 → 666666</strong>”).</p>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId50.png" alt="Figure 5: Prefix hook - Changing the result of the
“Example.Program.Sum()” and skipping its execution."><figcaption class="wp-element-caption">Figure 5: Prefix hook – Changing the result of the “Example.Program.Sum()” and skipping its execution.</figcaption></figure>
</div>


<h3 class="wp-block-heading" id="postfix---changing-the-result-of-the-original">Postfix – Changing the Result of the Original</h3>



<p class="wp-block-paragraph">Another case is when we want to let the original method execute and instrument the execution with logic that depends on its result (return value). To do so, we use the Postfix type of patch, as that one is executed right after the original. Based on the returned result, we can implement different logic that either sets a new result or leaves it as is. The original method&nbsp;<code>Sum()</code>&nbsp;that is going to be hooked by a Postfix type of patch is a method implemented by our targeted application itself with a signature:&nbsp;<code>System.Int32 Example.Program.Sum(System.Int32, System.Int32)</code>.</p>



<p class="wp-block-paragraph"><strong>Step-by-Step Guide:</strong></p>



<ol class="wp-block-list">
<li>Implement Harmony patch for Postfix “Manual Patching”&nbsp;<code>PostFix_Sum</code>&nbsp;– To change the return value, the argument called&nbsp;<code>__result</code>&nbsp;(the type must match the return type of the original or be assignable from it) must be added to the original method´s parameters and passed by reference. Therefore, adding the&nbsp;<code>ref</code>&nbsp;keyword to it is necessary.</li>



<li>Load the targeted application using reflection.</li>



<li>Install the Postfix patch for method&nbsp;<code>System.Int32 Example.Program.Sum(System.Int32, System.Int32)</code>&nbsp;– As the targeted method is a part of the runtime type (loaded Assembly), we can´t use the&nbsp;<code>typeof()</code>&nbsp;operator or the&nbsp;<code>nameof()</code>&nbsp;expression, but we can use the Harmony&nbsp;<a href="https://harmony.pardeike.net/articles/utilities.html#accesstools">AccessTools</a>&nbsp;as a shortcut for reflection to quickly locate it.</li>



<li>Execute the&nbsp;<code>EntryPoint</code>&nbsp;of the targeted application (method&nbsp;<code>Example.Program.Main()</code>).</li>
</ol>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">using System;</span></div></div><div class=""><div><span class="enlighter-text">using System.</span><span class="enlighter-m3">Reflection</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">using HarmonyLib;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">namespace CaptainHook</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    internal </span><span class="enlighter-k1">class</span><span class="enlighter-text"> Hook</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        static </span><span class="enlighter-k1">void</span><span class="enlighter-text"> </span><span class="enlighter-m0">Main</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Loading the targeted application using reflection</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            Assembly assembly = Assembly.</span><span class="enlighter-m3">LoadFile</span><span class="enlighter-g1">(</span><span class="enlighter-text">@</span><span class="enlighter-s0">"C:\Example.exe"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Installing the Postfix patch for method "int Example.Program.Sum(int, int)"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// The targeted method resides in a runtime type - loaded Assembly</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// We can use the Harmony AccessTools as a shortcut for reflection</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            MethodInfo target = AccessTools.</span><span class="enlighter-m3">Method</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Example.Program:Sum"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">target == </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                throw </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Exception</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Could not resolve Example.Program.Sum"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            Harmony harmony = </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Harmony</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Sum"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            MethodInfo patch = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">Hook</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"PostFix_Sum"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            harmony.</span><span class="enlighter-m3">Patch</span><span class="enlighter-g1">(</span><span class="enlighter-text">target, postfix: </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">HarmonyMethod</span><span class="enlighter-g1">(</span><span class="enlighter-text">patch</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Executing the targeted application</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            assembly.</span><span class="enlighter-m3">EntryPoint</span><span class="enlighter-text">.</span><span class="enlighter-m3">Invoke</span><span class="enlighter-g1">(</span><span class="enlighter-k1">null</span><span class="enlighter-text">, </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Implementation of Harmony patch used for Postfix "Manual Patching" </span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        public static </span><span class="enlighter-k1">void</span><span class="enlighter-text"> </span><span class="enlighter-m0">PostFix_Sum</span><span class="enlighter-g1">(</span><span class="enlighter-text">ref int __result, int a, int b</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text">   </span><span class="enlighter-c0">// Checking the result of the original Example.Program.Sum()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">__result == </span><span class="enlighter-n1">666</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-g1">{</span><span class="enlighter-text"> </span></div></div><div class=""><div><span class="enlighter-text">                __result = a + b + </span><span class="enlighter-n1">666000</span><span class="enlighter-text">; </span><span class="enlighter-c0">// Setting the result - return value      </span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">using System;
using System.Reflection;
using HarmonyLib;

namespace CaptainHook
{
    internal class Hook
    {
        static void Main()
        {
            // Loading the targeted application using reflection
            Assembly assembly = Assembly.LoadFile(@"C:\Example.exe");

            // Installing the Postfix patch for method "int Example.Program.Sum(int, int)"
            // The targeted method resides in a runtime type - loaded Assembly
            // We can use the Harmony AccessTools as a shortcut for reflection
            MethodInfo target = AccessTools.Method("Example.Program:Sum");
            if (target == null)
                throw new Exception("Could not resolve Example.Program.Sum");

            Harmony harmony = new Harmony("Sum");
            MethodInfo patch = typeof(Hook).GetMethod("PostFix_Sum");
            harmony.Patch(target, postfix: new HarmonyMethod(patch));

            // Executing the targeted application
            assembly.EntryPoint.Invoke(null, null);
        }

        // Implementation of Harmony patch used for Postfix "Manual Patching" 
        public static void PostFix_Sum(ref int __result, int a, int b)
        {   // Checking the result of the original Example.Program.Sum()
            if (__result == 666)
            { 
                __result = a + b + 666000; // Setting the result - return value      
            }
        }
    }
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">using System;
using System.Reflection;
using HarmonyLib;

namespace CaptainHook
{
    internal class Hook
    {
        static void Main()
        {
            // Loading the targeted application using reflection
            Assembly assembly = Assembly.LoadFile(@"C:\Example.exe");

            // Installing the Postfix patch for method "int Example.Program.Sum(int, int)"
            // The targeted method resides in a runtime type - loaded Assembly
            // We can use the Harmony AccessTools as a shortcut for reflection
            MethodInfo target = AccessTools.Method("Example.Program:Sum");
            if (target == null)
                throw new Exception("Could not resolve Example.Program.Sum");

            Harmony harmony = new Harmony("Sum");
            MethodInfo patch = typeof(Hook).GetMethod("PostFix_Sum");
            harmony.Patch(target, postfix: new HarmonyMethod(patch));

            // Executing the targeted application
            assembly.EntryPoint.Invoke(null, null);
        }

        // Implementation of Harmony patch used for Postfix "Manual Patching" 
        public static void PostFix_Sum(ref int __result, int a, int b)
        {   // Checking the result of the original Example.Program.Sum()
            if (__result == 666)
            { 
                __result = a + b + 666000; // Setting the result - return value      
            }
        }
    }
}</pre>



<p class="wp-block-paragraph">As we can see below, the method&nbsp;<code>System.Int32 Example.Program.Sum(System.Int32, System.Int32)</code>&nbsp;was successfully hooked, and its invocation was intercepted by the implemented Postfix patch&nbsp;<code>PostFix_Sum</code>. The original method was executed, and the result (return value) was altered only when it was equal to “<strong>666</strong>” (e.g., “<strong>666</strong>”&nbsp;<strong>→</strong>&nbsp;“<strong>666 + 666000</strong>”&nbsp;<strong>→</strong>&nbsp;“<strong>666666</strong>”).</p>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId54.png" alt="Figure 6: Postfix hook - Changing the specific result of the
“Example.Program.Sum()”."><figcaption class="wp-element-caption">Figure 6: Postfix hook – Changing the specific result of the “Example.Program.Sum()”.</figcaption></figure>
</div>


<h3 class="wp-block-heading" id="transpiler---changing-the-il-code-of-the-original">Transpiler – Changing the IL Code of the Original</h3>



<p class="wp-block-paragraph">For the more advanced cases where we can´t reach certain instrumentation via patch types like Prefix or Postfix, and we want to work on the IL code level of the targeted method, the Transpiler type of patch comes into play.</p>



<p class="wp-block-paragraph">We can think about the Transpiler as a post-compiler stage that can alter the “source code” of the original method, except that at runtime, it’s the IL code that changes. We can use the Transpiler to simply patch a few instructions or completely change the logic of the targeted method – all during runtime.</p>



<p class="wp-block-paragraph">The IL code of the original method&nbsp;<code>Example.Program.Sum()</code>&nbsp;that is going to be altered by a Transpiler type of patch is a method implemented by our targeted application itself with an original IL code as follows:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-c1">/* 0x00000251 02 */</span><span class="enlighter-text">  IL_0000: ldarg.</span><span class="enlighter-m3">0</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c1">/* 0x00000252 03 */</span><span class="enlighter-text">  IL_0001: ldarg.</span><span class="enlighter-m3">1</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c1">/* 0x00000253 58 */</span><span class="enlighter-text">  IL_0002: add</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c1">/* 0x00000254 2A */</span><span class="enlighter-text">  IL_0003: ret</span></div></div></div><div class="enlighter-raw">/* 0x00000251 02 */  IL_0000: ldarg.0
/* 0x00000252 03 */  IL_0001: ldarg.1
/* 0x00000253 58 */  IL_0002: add
/* 0x00000254 2A */  IL_0003: ret</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">/* 0x00000251 02 */  IL_0000: ldarg.0
/* 0x00000252 03 */  IL_0001: ldarg.1
/* 0x00000253 58 */  IL_0002: add
/* 0x00000254 2A */  IL_0003: ret</pre>



<p class="wp-block-paragraph">As we want to slightly change the logic of this method, the IL code altered by our Transpiler patch should change in memory into:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-c1">/* 0x00000000 02 */</span><span class="enlighter-text">  IL_0000: ldarg.</span><span class="enlighter-m3">0</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c1">/* 0x00000001 03 */</span><span class="enlighter-text">  IL_0001: ldarg.</span><span class="enlighter-m3">1</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c1">/* 0x00000002 59 */</span><span class="enlighter-text">  IL_0002: sub</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c1">/* 0x00000003 17 */</span><span class="enlighter-text">  IL_0003: ldc.</span><span class="enlighter-m3">i4</span><span class="enlighter-text">.</span><span class="enlighter-m3">1</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c1">/* 0x00000004 58 */</span><span class="enlighter-text">  IL_0004: add</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c1">/* 0x00000005 2A */</span><span class="enlighter-text">  IL_0005: ret</span></div></div></div><div class="enlighter-raw">/* 0x00000000 02 */  IL_0000: ldarg.0
/* 0x00000001 03 */  IL_0001: ldarg.1
/* 0x00000002 59 */  IL_0002: sub
/* 0x00000003 17 */  IL_0003: ldc.i4.1
/* 0x00000004 58 */  IL_0004: add
/* 0x00000005 2A */  IL_0005: ret</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">/* 0x00000000 02 */  IL_0000: ldarg.0
/* 0x00000001 03 */  IL_0001: ldarg.1
/* 0x00000002 59 */  IL_0002: sub
/* 0x00000003 17 */  IL_0003: ldc.i4.1
/* 0x00000004 58 */  IL_0004: add
/* 0x00000005 2A */  IL_0005: ret</pre>



<p class="wp-block-paragraph"><strong>Step-by-Step Guide:</strong></p>



<ol class="wp-block-list">
<li>Implement Harmony patch for Transpiler “Manual Patching”&nbsp;<code>Transpiler_Sum</code>&nbsp;– To define our stub method as Transpiler, both the return and argument types must be of type&nbsp;<code>IEnumerable&lt;CodeInstruction&gt;</code>.</li>



<li>Load the targeted application using reflection.</li>



<li>Install the Transpiler patch for the method&nbsp;<code>System.Int32 Example.Program.Sum(System.Int32, System.Int32)</code>&nbsp;– As the targeted method is a part of the runtime type (loaded Assembly), we can´t use the&nbsp;<code>typeof()</code>&nbsp;operator or the&nbsp;<code>nameof()</code>&nbsp;expression, but we can use the Harmony&nbsp;<a href="https://harmony.pardeike.net/articles/utilities.html#accesstools">AccessTools</a>&nbsp;as a shortcut for reflection to quickly locate it.</li>



<li>Execute the&nbsp;<code>EntryPoint</code>&nbsp;of the targeted application (method&nbsp;<code>Example.Program.Main()</code>).</li>
</ol>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">using System;</span></div></div><div class=""><div><span class="enlighter-text">using System.</span><span class="enlighter-m3">Collections</span><span class="enlighter-text">.</span><span class="enlighter-m3">Generic</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">using System.</span><span class="enlighter-m3">Linq</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">using System.</span><span class="enlighter-m3">Reflection</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">using System.</span><span class="enlighter-m3">Reflection</span><span class="enlighter-text">.</span><span class="enlighter-m3">Emit</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">using HarmonyLib;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">namespace CaptainHook</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    internal </span><span class="enlighter-k1">class</span><span class="enlighter-text"> Hook</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        static </span><span class="enlighter-k1">void</span><span class="enlighter-text"> </span><span class="enlighter-m0">Main</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Loading the targeted application using reflection</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            Assembly assembly = Assembly.</span><span class="enlighter-m3">LoadFile</span><span class="enlighter-g1">(</span><span class="enlighter-text">@</span><span class="enlighter-s0">"C:\Example.exe"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Installing the Transpiler patch for method "int Example.Program.Sum(int, int)"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// The targeted method resides in a runtime type - loaded Assembly</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// We can use the Harmony AccessTools as a shortcut for reflection</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            MethodInfo target = AccessTools.</span><span class="enlighter-m3">Method</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Example.Program:Sum"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">target == </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                throw </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Exception</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Could not resolve Example.Program.Sum"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            Harmony harmony = </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Harmony</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Sum"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            MethodInfo patch = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">Hook</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Transpiler_Sum"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            harmony.</span><span class="enlighter-m3">Patch</span><span class="enlighter-g1">(</span><span class="enlighter-text">target, transpiler: </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">HarmonyMethod</span><span class="enlighter-g1">(</span><span class="enlighter-text">patch</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Executing the targeted application</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            assembly.</span><span class="enlighter-m3">EntryPoint</span><span class="enlighter-text">.</span><span class="enlighter-m3">Invoke</span><span class="enlighter-g1">(</span><span class="enlighter-k1">null</span><span class="enlighter-text">, </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Implementation of Harmony patch used for Transpiler "Manual Patching"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        public static IEnumerable</span><span class="enlighter-g1">&lt;</span><span class="enlighter-text">CodeInstruction</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> </span><span class="enlighter-m0">Transpiler_Sum</span><span class="enlighter-g1">(</span><span class="enlighter-text">IEnumerable</span><span class="enlighter-g1">&lt;</span><span class="enlighter-text">CodeInstruction</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> codes</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text">   </span><span class="enlighter-c0">// Changing the IL code of the original Example.Program.Sum()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// (a + b) will turn into (a - b + 1)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            var instructions = </span><span class="enlighter-k1">new</span><span class="enlighter-text"> List</span><span class="enlighter-g1">&lt;</span><span class="enlighter-text">CodeInstruction</span><span class="enlighter-g1">&gt;(</span><span class="enlighter-text">codes</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">for</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">var i = </span><span class="enlighter-n1">0</span><span class="enlighter-text">; i </span><span class="enlighter-g1">&lt;</span><span class="enlighter-text"> instructions.</span><span class="enlighter-m3">Count</span><span class="enlighter-text">; i++</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">instructions</span><span class="enlighter-g1">[</span><span class="enlighter-text">i</span><span class="enlighter-g1">]</span><span class="enlighter-text">.</span><span class="enlighter-m3">opcode</span><span class="enlighter-text"> == OpCodes.</span><span class="enlighter-m3">Add</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                    instructions.</span><span class="enlighter-m3">Insert</span><span class="enlighter-g1">(</span><span class="enlighter-text">i, </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">CodeInstruction</span><span class="enlighter-g1">(</span><span class="enlighter-text">OpCodes.</span><span class="enlighter-m3">Sub</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">                    instructions.</span><span class="enlighter-m3">Insert</span><span class="enlighter-g1">(</span><span class="enlighter-text">i + </span><span class="enlighter-n1">1</span><span class="enlighter-text">, </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">CodeInstruction</span><span class="enlighter-g1">(</span><span class="enlighter-text">OpCodes.</span><span class="enlighter-m3">Ldc_I4_1</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">                    break;                  </span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">return</span><span class="enlighter-text"> instructions.</span><span class="enlighter-m3">AsEnumerable</span><span class="enlighter-g1">()</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Reflection.Emit;
using HarmonyLib;

namespace CaptainHook
{
    internal class Hook
    {
        static void Main()
        {
            // Loading the targeted application using reflection
            Assembly assembly = Assembly.LoadFile(@"C:\Example.exe");

            // Installing the Transpiler patch for method "int Example.Program.Sum(int, int)"
            // The targeted method resides in a runtime type - loaded Assembly
            // We can use the Harmony AccessTools as a shortcut for reflection
            MethodInfo target = AccessTools.Method("Example.Program:Sum");
            if (target == null)
                throw new Exception("Could not resolve Example.Program.Sum");

            Harmony harmony = new Harmony("Sum");
            MethodInfo patch = typeof(Hook).GetMethod("Transpiler_Sum");
            harmony.Patch(target, transpiler: new HarmonyMethod(patch));

            // Executing the targeted application
            assembly.EntryPoint.Invoke(null, null);
        }

        // Implementation of Harmony patch used for Transpiler "Manual Patching"
        public static IEnumerable&lt;CodeInstruction&gt; Transpiler_Sum(IEnumerable&lt;CodeInstruction&gt; codes)
        {   // Changing the IL code of the original Example.Program.Sum()
            // (a + b) will turn into (a - b + 1)
            var instructions = new List&lt;CodeInstruction&gt;(codes);
            for (var i = 0; i &lt; instructions.Count; i++)
            {
                if (instructions[i].opcode == OpCodes.Add)
                {
                    instructions.Insert(i, new CodeInstruction(OpCodes.Sub));
                    instructions.Insert(i + 1, new CodeInstruction(OpCodes.Ldc_I4_1));
                    break;                  
                }
            }
            return instructions.AsEnumerable();
        }
    }
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Reflection.Emit;
using HarmonyLib;

namespace CaptainHook
{
    internal class Hook
    {
        static void Main()
        {
            // Loading the targeted application using reflection
            Assembly assembly = Assembly.LoadFile(@"C:\Example.exe");

            // Installing the Transpiler patch for method "int Example.Program.Sum(int, int)"
            // The targeted method resides in a runtime type - loaded Assembly
            // We can use the Harmony AccessTools as a shortcut for reflection
            MethodInfo target = AccessTools.Method("Example.Program:Sum");
            if (target == null)
                throw new Exception("Could not resolve Example.Program.Sum");

            Harmony harmony = new Harmony("Sum");
            MethodInfo patch = typeof(Hook).GetMethod("Transpiler_Sum");
            harmony.Patch(target, transpiler: new HarmonyMethod(patch));

            // Executing the targeted application
            assembly.EntryPoint.Invoke(null, null);
        }

        // Implementation of Harmony patch used for Transpiler "Manual Patching"
        public static IEnumerable&lt;CodeInstruction&gt; Transpiler_Sum(IEnumerable&lt;CodeInstruction&gt; codes)
        {   // Changing the IL code of the original Example.Program.Sum()
            // (a + b) will turn into (a - b + 1)
            var instructions = new List&lt;CodeInstruction&gt;(codes);
            for (var i = 0; i &lt; instructions.Count; i++)
            {
                if (instructions[i].opcode == OpCodes.Add)
                {
                    instructions.Insert(i, new CodeInstruction(OpCodes.Sub));
                    instructions.Insert(i + 1, new CodeInstruction(OpCodes.Ldc_I4_1));
                    break;                  
                }
            }
            return instructions.AsEnumerable();
        }
    }
}</pre>



<p class="wp-block-paragraph">We can see that the IL code of the original&nbsp;<code>System.Int32 Example.Program.Sum(System.Int32, System.Int32)</code>&nbsp;was successfully altered by the implemented Transpiler patch&nbsp;<code>Transpiler_Sum</code>&nbsp;and changed its logic from&nbsp;<strong>(a + b)</strong>&nbsp;to&nbsp;<strong>(a – b + 1)</strong>: “<strong>Sum(333, 333) → (333 – 333 + 1) → 1</strong>”.</p>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId58.png" alt="Figure 7: Transpiler patch - Changing the IL code of the
“Example.Program.Sum()”."><figcaption class="wp-element-caption">Figure 7: Transpiler patch – Changing the IL code of the “Example.Program.Sum()”.</figcaption></figure>
</div>


<h3 class="wp-block-heading" id="reverse-patch-and-unpatching---calling-the-original">Reverse Patch and Unpatching – Calling the Original</h3>



<p class="wp-block-paragraph">As we already covered the most common types of patches (<strong>Prefix</strong>,&nbsp;<strong>Postfix</strong>,&nbsp;<strong>Transpiler</strong>) and we know that all of them modify the original targeted method in some way, a few important questions come to mind:</p>



<ol class="wp-block-list">
<li>How to remove patches applied to the targeted method so it can become the original again?</li>



<li>How to call the intact original method that is not affected by any implanted patches?</li>
</ol>



<p class="wp-block-paragraph">Answering the first question is quite easy, as one of the most useful features of the Harmony library is the ability to keep the original method content that is not affected by any applied patches. This original method content can be used for the reconstruction to remove all applied patches or, in other words, “<strong>unpatching</strong>”.</p>



<p class="wp-block-paragraph">Once a method is patched, the original method is destroyed, and all future versions will come from&nbsp;<strong>Harmony</strong>&nbsp;(using the original IL code). Therefore, the “<strong>unpatching</strong>” is not a real unpatching but instead a patching with zero patches. It can completely remove all patches, or patches that are related to certain Harmony instances, or only a specific single patch. The different implementations of unpatching are trivial and can be demonstrated in the code below:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-c0">// Loading the targeted application using reflection</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">Assembly assembly = Assembly.</span><span class="enlighter-m3">LoadFile</span><span class="enlighter-g1">(</span><span class="enlighter-text">@</span><span class="enlighter-s0">"C:\Example.exe"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c0">// Installing the Prefix patch for method "void Console.WriteLine(System.String)"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">MethodInfo target = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">Console</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"WriteLine"</span><span class="enlighter-text">, </span><span class="enlighter-k1">new</span><span class="enlighter-g1">[]</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"> </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">string</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">})</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">target == </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    throw </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Exception</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Could not resolve Console.WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">Harmony harmony = </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Harmony</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">MethodInfo patch = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">Hook</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"PreFix_WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">harmony.</span><span class="enlighter-m3">Patch</span><span class="enlighter-g1">(</span><span class="enlighter-text">target, </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">HarmonyMethod</span><span class="enlighter-g1">(</span><span class="enlighter-text">patch</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c0">// Executing the targeted application - Console.WriteLine() is PATCHED</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">assembly.</span><span class="enlighter-m3">EntryPoint</span><span class="enlighter-text">.</span><span class="enlighter-m3">Invoke</span><span class="enlighter-g1">(</span><span class="enlighter-k1">null</span><span class="enlighter-text">, </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">----------------------------------------------------------------------------</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c0">// Unpatching completely all applied patches</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">harmony.</span><span class="enlighter-m3">UnpatchAll</span><span class="enlighter-g1">()</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c0">// Unpatching all applied patches of one specific Hramony instance</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">harmony.</span><span class="enlighter-m3">UnpatchAll</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c0">// Unpatching specific method from all applied Prefix patches</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">harmony.</span><span class="enlighter-m3">Unpatch</span><span class="enlighter-g1">(</span><span class="enlighter-text">target, HarmonyPatchType.</span><span class="enlighter-m3">Prefix</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c0">// Removing specific patch from specific method</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">harmony.</span><span class="enlighter-m3">Unpatch</span><span class="enlighter-g1">(</span><span class="enlighter-text">target, patch</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">----------------------------------------------------------------------------</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c0">// Executing the targeted application - Console.WriteLine() is UNPATCHED</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">assembly.</span><span class="enlighter-m3">EntryPoint</span><span class="enlighter-text">.</span><span class="enlighter-m3">Invoke</span><span class="enlighter-g1">(</span><span class="enlighter-k1">null</span><span class="enlighter-text">, </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c0">// Implementation of Harmony patch used for Prefix "Manual Patching" </span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">public static bool </span><span class="enlighter-m0">PreFix_WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-text">ref string value</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    value = </span><span class="enlighter-s0">"Captain Hook Was Here!!!"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-k1">true</span><span class="enlighter-text">; </span><span class="enlighter-c0">// Do not skip executing original Console.WriteLine()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">// Loading the targeted application using reflection
Assembly assembly = Assembly.LoadFile(@"C:\Example.exe");
// Installing the Prefix patch for method "void Console.WriteLine(System.String)"
MethodInfo target = typeof(Console).GetMethod("WriteLine", new[] { typeof(string) });
if (target == null)
    throw new Exception("Could not resolve Console.WriteLine");

Harmony harmony = new Harmony("WriteLine");
MethodInfo patch = typeof(Hook).GetMethod("PreFix_WriteLine");
harmony.Patch(target, new HarmonyMethod(patch));
// Executing the targeted application - Console.WriteLine() is PATCHED
assembly.EntryPoint.Invoke(null, null);
----------------------------------------------------------------------------
// Unpatching completely all applied patches
harmony.UnpatchAll();
// Unpatching all applied patches of one specific Hramony instance
harmony.UnpatchAll("WriteLine");
// Unpatching specific method from all applied Prefix patches
harmony.Unpatch(target, HarmonyPatchType.Prefix);
// Removing specific patch from specific method
harmony.Unpatch(target, patch);
----------------------------------------------------------------------------
// Executing the targeted application - Console.WriteLine() is UNPATCHED
assembly.EntryPoint.Invoke(null, null);

// Implementation of Harmony patch used for Prefix "Manual Patching" 
public static bool PreFix_WriteLine(ref string value)
{
    value = "Captain Hook Was Here!!!";
    return true; // Do not skip executing original Console.WriteLine()
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">// Loading the targeted application using reflection
Assembly assembly = Assembly.LoadFile(@"C:\Example.exe");
// Installing the Prefix patch for method "void Console.WriteLine(System.String)"
MethodInfo target = typeof(Console).GetMethod("WriteLine", new[] { typeof(string) });
if (target == null)
    throw new Exception("Could not resolve Console.WriteLine");

Harmony harmony = new Harmony("WriteLine");
MethodInfo patch = typeof(Hook).GetMethod("PreFix_WriteLine");
harmony.Patch(target, new HarmonyMethod(patch));
// Executing the targeted application - Console.WriteLine() is PATCHED
assembly.EntryPoint.Invoke(null, null);
----------------------------------------------------------------------------
// Unpatching completely all applied patches
harmony.UnpatchAll();
// Unpatching all applied patches of one specific Hramony instance
harmony.UnpatchAll("WriteLine");
// Unpatching specific method from all applied Prefix patches
harmony.Unpatch(target, HarmonyPatchType.Prefix);
// Removing specific patch from specific method
harmony.Unpatch(target, patch);
----------------------------------------------------------------------------
// Executing the targeted application - Console.WriteLine() is UNPATCHED
assembly.EntryPoint.Invoke(null, null);

// Implementation of Harmony patch used for Prefix "Manual Patching" 
public static bool PreFix_WriteLine(ref string value)
{
    value = "Captain Hook Was Here!!!";
    return true; // Do not skip executing original Console.WriteLine()
}</pre>



<p class="wp-block-paragraph">Noteworthy is that we can even process the unpatching from inside the patch itself. In that case, the first call to the targeted hooked method is intercepted by the patch executing all applied logic, but all subsequent calls are processed by the original.</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-c0">// Implementation of Harmony patch used for Prefix "Manual Patching" </span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">public static bool </span><span class="enlighter-m0">PreFix_WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-text">ref string value</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Unpatching completely all applied patches even this one</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">(</span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Harmony</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"ItDoesNotMatter"</span><span class="enlighter-g1">))</span><span class="enlighter-text">.</span><span class="enlighter-m3">UnpatchAll</span><span class="enlighter-g1">()</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    value = </span><span class="enlighter-s0">"Captain Hook Was Here!!!"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-k1">true</span><span class="enlighter-text">; </span><span class="enlighter-c0">// Do not skip executing original Console.WriteLine()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">// Implementation of Harmony patch used for Prefix "Manual Patching" 
public static bool PreFix_WriteLine(ref string value)
{
    // Unpatching completely all applied patches even this one
    (new Harmony("ItDoesNotMatter")).UnpatchAll();
    value = "Captain Hook Was Here!!!";
    return true; // Do not skip executing original Console.WriteLine()
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">// Implementation of Harmony patch used for Prefix "Manual Patching" 
public static bool PreFix_WriteLine(ref string value)
{
    // Unpatching completely all applied patches even this one
    (new Harmony("ItDoesNotMatter")).UnpatchAll();
    value = "Captain Hook Was Here!!!";
    return true; // Do not skip executing original Console.WriteLine()
}</pre>



<p class="wp-block-paragraph">The “<strong>unpatching</strong>” is usually the best way to go if we want to either completely remove the applied patches for any reason or just remove a single patch instance. There is another much more convenient solution when it comes to using the original form of the method. If we need something like a copy of the original method, untouched by any kind of patches, that can be used and independently called from any location, even from its patch itself, and still not have to touch the applied patches in any way, a specific type of patch called “<strong>Reverse Patch</strong>” is the right solution.</p>



<p class="wp-block-paragraph">The&nbsp;<strong>Reverse Patch</strong>&nbsp;is a way to create a copy of the original method that we can later use and call ourselves. We can call it from our code, or patches, or even from the patches that are applied to the method from which the Reverse Patch is created. This kind of patch is different than the previous types in that it patches our own methods instead of foreign original ones. It is a stub method in our own code that “<em><strong>becomes</strong></em>” the original method.</p>



<p class="wp-block-paragraph">To be honest, we don’t have another way to go. What could possibly go wrong if we take the example from the section “<strong>Prefix – Changing the Method´s Arguments and Executing</strong>” that applied a Prefix patch to the method&nbsp;<code>void WriteLine(System.String)</code>&nbsp;that resides in&nbsp;<code>System.Console.dll</code>&nbsp;Assembly and try to print some “string” to the console from the patch itself?</p>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId62.png" alt="Figure 8: Calling the patched method from the patch itself -
StackOverflowException."><figcaption class="wp-element-caption">Figure 8: Calling the patched method from the patch itself – StackOverflowException.</figcaption></figure>
</div>


<p class="wp-block-paragraph">If we take the same example but implement the Reverse Patch for the original method&nbsp;<code>void Console.WriteLine(System.String)</code>, we should be able to use it without any limitation causing similar exceptions.</p>



<p class="wp-block-paragraph"><strong>Step-by-Step Guide:</strong></p>



<ol class="wp-block-list">
<li>Implement Harmony patch for Prefix “Manual Patching”&nbsp;<code>PreFix_WriteLine</code>&nbsp;– To change the argument value, it needs to be passed by reference, so adding the&nbsp;<code>ref</code>&nbsp;keyword is necessary. The return&nbsp;<code>bool</code>&nbsp;value of the Prefix patch method&nbsp;<code>PreFix_WriteLine</code>&nbsp;signals if the execution of the original method should be skipped (<code>false</code>&nbsp;– skip,&nbsp;<code>true</code>&nbsp;– do not skip).</li>



<li>Implement Harmony patch for Reverse Patch “Manual Patching”&nbsp;<code>MyWriteLine</code>&nbsp;– An empty stub method that needs to match the method signature of the original&nbsp;<code>void Console.WriteLine(System.String)</code>.</li>



<li>Load the targeted application using reflection.</li>



<li>Install the Prefix patch for the method&nbsp;<code>void Console.WriteLine(System.String)</code>.</li>



<li>Install the Reverse Patch for the method&nbsp;<code>void Console.WriteLine(System.String)</code>.</li>



<li>Execute the&nbsp;<code>EntryPoint</code>&nbsp;of the targeted application (method&nbsp;<code>Example.Program.Main()</code>).</li>
</ol>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">using System;</span></div></div><div class=""><div><span class="enlighter-text">using System.</span><span class="enlighter-m3">Reflection</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">using HarmonyLib;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">namespace CaptainHook</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    internal </span><span class="enlighter-k1">class</span><span class="enlighter-text"> Hook</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        static </span><span class="enlighter-k1">void</span><span class="enlighter-text"> </span><span class="enlighter-m0">Main</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Loading the targeted application using reflection</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            Assembly assembly = Assembly.</span><span class="enlighter-m3">LoadFile</span><span class="enlighter-g1">(</span><span class="enlighter-text">@</span><span class="enlighter-s0">"C:\Example.exe"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Installing the Prefix patch for method "void Console.WriteLine(System.String)"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            MethodInfo target = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">Console</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"WriteLine"</span><span class="enlighter-text">, </span><span class="enlighter-k1">new</span><span class="enlighter-g1">[]</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"> </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">string</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">})</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">target == </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                throw </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Exception</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Could not resolve Console.WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            Harmony harmony = </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Harmony</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            MethodInfo patch = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">Hook</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"PreFix_WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            harmony.</span><span class="enlighter-m3">Patch</span><span class="enlighter-g1">(</span><span class="enlighter-text">target, </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">HarmonyMethod</span><span class="enlighter-g1">(</span><span class="enlighter-text">patch</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Installing the Reverse Patch for method "void Console.WriteLine(System.String)"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            MethodInfo rPatch = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">Hook</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"MyWriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            var rPatcher = harmony.</span><span class="enlighter-m3">CreateReversePatcher</span><span class="enlighter-g1">(</span><span class="enlighter-text">target, </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">HarmonyMethod</span><span class="enlighter-g1">(</span><span class="enlighter-text">rPatch</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            rPatcher.</span><span class="enlighter-m3">Patch</span><span class="enlighter-g1">()</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Executing the targeted application</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            assembly.</span><span class="enlighter-m3">EntryPoint</span><span class="enlighter-text">.</span><span class="enlighter-m3">Invoke</span><span class="enlighter-g1">(</span><span class="enlighter-k1">null</span><span class="enlighter-text">, </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Calling the Reverse Patch for Console.WriteLine()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">MyWriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Reverse Patch for Console.WriteLine() from Main!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Implementation of Harmony patch used for Reverse Patch "Manual Patching"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        public static </span><span class="enlighter-k1">void</span><span class="enlighter-text"> </span><span class="enlighter-m0">MyWriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-text">string value</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"> </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Implementation of Harmony patch used for Prefix "Manual Patching" </span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        public static bool </span><span class="enlighter-m0">PreFix_WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-text">ref string value</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text">   </span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Calling the Reverse Patch for Console.WriteLine() from PreFix_WriteLine</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">MyWriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Reverse Patch for Console.WriteLine() from PreFix_WriteLine!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">value.</span><span class="enlighter-m3">Contains</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook"</span><span class="enlighter-g1">))</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"> value = </span><span class="enlighter-s0">"Captain Hook Was Here!!!"</span><span class="enlighter-text">; </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-k1">true</span><span class="enlighter-text">; </span><span class="enlighter-c0">// Do not skip executing original Console.WriteLine()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">using System;
using System.Reflection;
using HarmonyLib;

namespace CaptainHook
{
    internal class Hook
    {
        static void Main()
        {
            // Loading the targeted application using reflection
            Assembly assembly = Assembly.LoadFile(@"C:\Example.exe");

            // Installing the Prefix patch for method "void Console.WriteLine(System.String)"
            MethodInfo target = typeof(Console).GetMethod("WriteLine", new[] { typeof(string) });
            if (target == null)
                throw new Exception("Could not resolve Console.WriteLine");

            Harmony harmony = new Harmony("WriteLine");
            MethodInfo patch = typeof(Hook).GetMethod("PreFix_WriteLine");
            harmony.Patch(target, new HarmonyMethod(patch));

            // Installing the Reverse Patch for method "void Console.WriteLine(System.String)"
            MethodInfo rPatch = typeof(Hook).GetMethod("MyWriteLine");
            var rPatcher = harmony.CreateReversePatcher(target, new HarmonyMethod(rPatch));
            rPatcher.Patch();

            // Executing the targeted application
            assembly.EntryPoint.Invoke(null, null);

            // Calling the Reverse Patch for Console.WriteLine()
            MyWriteLine("Reverse Patch for Console.WriteLine() from Main!!!");
        }

        // Implementation of Harmony patch used for Reverse Patch "Manual Patching"
        public static void MyWriteLine(string value) { }

        // Implementation of Harmony patch used for Prefix "Manual Patching" 
        public static bool PreFix_WriteLine(ref string value)
        {   
            // Calling the Reverse Patch for Console.WriteLine() from PreFix_WriteLine
            MyWriteLine("Reverse Patch for Console.WriteLine() from PreFix_WriteLine!!!");

            if (value.Contains("Hook")) { value = "Captain Hook Was Here!!!"; }
            return true; // Do not skip executing original Console.WriteLine()
        }
    }
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">using System;
using System.Reflection;
using HarmonyLib;

namespace CaptainHook
{
    internal class Hook
    {
        static void Main()
        {
            // Loading the targeted application using reflection
            Assembly assembly = Assembly.LoadFile(@"C:\Example.exe");

            // Installing the Prefix patch for method "void Console.WriteLine(System.String)"
            MethodInfo target = typeof(Console).GetMethod("WriteLine", new[] { typeof(string) });
            if (target == null)
                throw new Exception("Could not resolve Console.WriteLine");

            Harmony harmony = new Harmony("WriteLine");
            MethodInfo patch = typeof(Hook).GetMethod("PreFix_WriteLine");
            harmony.Patch(target, new HarmonyMethod(patch));

            // Installing the Reverse Patch for method "void Console.WriteLine(System.String)"
            MethodInfo rPatch = typeof(Hook).GetMethod("MyWriteLine");
            var rPatcher = harmony.CreateReversePatcher(target, new HarmonyMethod(rPatch));
            rPatcher.Patch();

            // Executing the targeted application
            assembly.EntryPoint.Invoke(null, null);

            // Calling the Reverse Patch for Console.WriteLine()
            MyWriteLine("Reverse Patch for Console.WriteLine() from Main!!!");
        }

        // Implementation of Harmony patch used for Reverse Patch "Manual Patching"
        public static void MyWriteLine(string value) { }

        // Implementation of Harmony patch used for Prefix "Manual Patching" 
        public static bool PreFix_WriteLine(ref string value)
        {   
            // Calling the Reverse Patch for Console.WriteLine() from PreFix_WriteLine
            MyWriteLine("Reverse Patch for Console.WriteLine() from PreFix_WriteLine!!!");

            if (value.Contains("Hook")) { value = "Captain Hook Was Here!!!"; }
            return true; // Do not skip executing original Console.WriteLine()
        }
    }
}</pre>



<p class="wp-block-paragraph">The method&nbsp;<code>void Console.WriteLine(System.String)</code>&nbsp;was successfully hooked, and all its invocations were intercepted by the implemented Prefix patch&nbsp;<code>PreFix_WriteLine</code>. It only changed when the original argument contained the string value “<strong>Hook</strong>” (e.g., “<strong>Hook Me If You Can!!!</strong>” → “<strong>Captain Hook Was Here!!!</strong>”). Furthermore, we can independently use the Reverse Patch&nbsp;<code>MyWriteLine</code>&nbsp;for the original&nbsp;<code>void Console.WriteLine(System.String)</code>&nbsp;and call it even from the Prefix patch&nbsp;<code>PreFix_WriteLine</code>&nbsp;that was applied to it.</p>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId65.png" alt="Figure 9: Reverse Patch - Calling the original method
“Console.WriteLine()”."><figcaption class="wp-element-caption">Figure 9: Reverse Patch – Calling the original method “Console.WriteLine()”.</figcaption></figure>
</div>


<p class="wp-block-paragraph">It is worth noting that during our walk-through of all common implementation examples, we tried to make it simple but still worked quite hard with the “<a href="https://harmony.pardeike.net/articles/basics.html#manual-patching"><strong>Manual Patching</strong></a>” to create and organize patches using the Harmony library (avoiding the usage of “<a href="https://harmony.pardeike.net/articles/annotations.html"><strong>Annotations</strong></a>”) as it highly relies on the reflection. Furthermore, we mostly directly used the reflection to get runtime types, methods, etc. The Harmony library also provides some&nbsp;<a href="https://harmony.pardeike.net/articles/utilities.html">utilities</a>&nbsp;that can simplify a lot of things – e.g., a helper class&nbsp;<code>AccessTools</code>&nbsp;(wrapper that simplifies the reflection),&nbsp;<code>Traverse</code>&nbsp;(like a LINQ wrapper for classes), and more.</p>



<h2 class="wp-block-heading" id="practical-harmony-usage---confuserex2-string-decryptor">Practical Harmony Usage – ConfuserEx2 String Decryptor</h2>



<p class="wp-block-paragraph">Encouraged by the knowledge from the previous sections, we can move forward to a simple, practical example that results in the creation of the&nbsp;<a href="https://github.com/Dump-GUY/ConfuserEx2_String_Decryptor"><strong>ConfuserEx2 String Decryptor</strong></a>&nbsp;tool.</p>



<p class="wp-block-paragraph">Usually, when we are dealing with obfuscated dotnet malware, the first thing we target are encrypted constants, specifically string objects. Reconstruction of the original strings can often be a “shortcut” for revealing the crucial functionality, configuration, and other important aspects of the malware.</p>



<p class="wp-block-paragraph">A significant amount of malware samples come in the form of obfuscated or protected code. Currently, there are more than a hundred known dotnet obfuscators that are either commercially or freely available as open-source projects. One of the most used protectors from the second group is the notorious&nbsp;<a href="https://mkaring.github.io/ConfuserEx/">ConfuserEx2</a>. This protector evolved from the first release known as Confuser to&nbsp;<a href="https://github.com/yck1509/ConfuserEx">ConfuserEx</a>, which later resulted in a fork introduced as&nbsp;<a href="https://github.com/mkaring/ConfuserEx">ConfuserEx2</a>.</p>



<p class="wp-block-paragraph">While the vanilla version of ConfuserEx2 is heavily used by commodity malware, it is not so unusual to see it being used by advanced threat actors in a form that is slightly customized but enough to disable the functionality of freely available, known deobfuscators.</p>



<p class="wp-block-paragraph">Even in the case of the vanilla version of ConfuserEx2, there are no publicly available, dedicated deobfuscators that can reliably allow the reconstruction of constants (mainly&nbsp;<code>string</code>&nbsp;objects and&nbsp;<code>char[]</code>&nbsp;arrays) protected by this obfuscator. In this section, we show how to create one such tool that uses the Harmony library to bypass some of the ConfuserEx2 checks, allowing us to proceed with the deobfuscation logic.</p>



<p class="wp-block-paragraph">To find out how the ConfuserEx2 constants protection works, where the main problem is, and how we can defeat it, we built a simple C#, Console App using .NET Framework that became the target for the obfuscation.</p>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId75.png" alt="Figure 10: Example program as a target for the ConfuserEx2
obfuscation (dnSpyEx view)."><figcaption class="wp-element-caption">Figure 10: Example program as a target for the ConfuserEx2 obfuscation (dnSpyEx view).</figcaption></figure>
</div>


<p class="wp-block-paragraph">After applying ConfuserEx2 constants protection, our original example program turns into the obfuscated code that holds all&nbsp;<code>string</code>&nbsp;objects and&nbsp;<code>char[]</code>&nbsp;arrays in an encrypted form.</p>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId78.png" alt="Figure 11: ConfuserEx2 obfuscated example program - constants
protected."><figcaption class="wp-element-caption">Figure 11: ConfuserEx2 obfuscated example program – constants protected.</figcaption></figure>
</div>


<p class="wp-block-paragraph">One of the most straightforward ways to deobfuscate and reconstruct the original constants is based on a dynamic approach using reflection to simply invoke all the constants’ decryption functions with proper arguments. But once we check such decryption functions in a ConfuserEx2-protected binary, we can immediately spot something that protects the function invocation in exactly the way we want to do so.</p>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId81.png" alt="Figure 12: One of the constants’ decryption functions."><figcaption class="wp-element-caption">Figure 12: One of the constants’ decryption functions.</figcaption></figure>
</div>


<p class="wp-block-paragraph">Notice the&nbsp;<code>Assembly.GetExecutingAssembly().Equals(Assembly.GetCallingAssembly())</code>&nbsp;check compares the .NET Assembly containing the currently executing code with the .NET Assembly that invoked the currently executing method and expects them to be equal. Of course, the dynamic approach using reflection to get rid of the obfuscation will fail to pass this check.</p>



<p class="wp-block-paragraph">This is the exact moment where the Harmony library comes into play. We can implement a Prefix type of patch for the original method&nbsp;<code>GetCallingAssembly()</code>&nbsp;that hooks this function in a way that always returns the obfuscated .NET Assembly, no matter which assembly was originally responsible for the function invocation. This patch allows us to bypass the check and continue with our dynamic approach.</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-c0">// Targeted obfuscated .NET Assembly loaded via Reflection</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">static Assembly LoadedAssembly;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c0">// Installing the Prefix patch for method "Assembly GetCallingAssembly()"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">private static </span><span class="enlighter-k1">void</span><span class="enlighter-text"> </span><span class="enlighter-m0">InstallHook</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    var target = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">Assembly</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"GetCallingAssembly"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">target == </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        throw </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Exception</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Could not resolve Assembly.GetCallingAssembly"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    var harmony = </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Harmony</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"GetCallingAssembly"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    var stub = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">Program</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"PreFix_GetCallingAssembly"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    harmony.</span><span class="enlighter-m3">Patch</span><span class="enlighter-g1">(</span><span class="enlighter-text">target, </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">HarmonyMethod</span><span class="enlighter-g1">(</span><span class="enlighter-text">stub</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c0">// Implementation of Harmony patch used for Prefix "Manual Patching" </span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">public static bool </span><span class="enlighter-m0">PreFix_GetCallingAssembly</span><span class="enlighter-g1">(</span><span class="enlighter-text">ref Assembly __result</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    __result = LoadedAssembly; </span><span class="enlighter-c0">// Setting the result - return value</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-k1">false</span><span class="enlighter-text">; </span><span class="enlighter-c0">// Skip executing the original GetCallingAssembly()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">// Targeted obfuscated .NET Assembly loaded via Reflection
static Assembly LoadedAssembly;

// Installing the Prefix patch for method "Assembly GetCallingAssembly()"
private static void InstallHook()
{
    var target = typeof(Assembly).GetMethod("GetCallingAssembly");
    if (target == null)
        throw new Exception("Could not resolve Assembly.GetCallingAssembly");

    var harmony = new Harmony("GetCallingAssembly");
    var stub = typeof(Program).GetMethod("PreFix_GetCallingAssembly");
    harmony.Patch(target, new HarmonyMethod(stub));
}

// Implementation of Harmony patch used for Prefix "Manual Patching" 
public static bool PreFix_GetCallingAssembly(ref Assembly __result)
{
    __result = LoadedAssembly; // Setting the result - return value
    return false; // Skip executing the original GetCallingAssembly()
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">// Targeted obfuscated .NET Assembly loaded via Reflection
static Assembly LoadedAssembly;

// Installing the Prefix patch for method "Assembly GetCallingAssembly()"
private static void InstallHook()
{
    var target = typeof(Assembly).GetMethod("GetCallingAssembly");
    if (target == null)
        throw new Exception("Could not resolve Assembly.GetCallingAssembly");

    var harmony = new Harmony("GetCallingAssembly");
    var stub = typeof(Program).GetMethod("PreFix_GetCallingAssembly");
    harmony.Patch(target, new HarmonyMethod(stub));
}

// Implementation of Harmony patch used for Prefix "Manual Patching" 
public static bool PreFix_GetCallingAssembly(ref Assembly __result)
{
    __result = LoadedAssembly; // Setting the result - return value
    return false; // Skip executing the original GetCallingAssembly()
}</pre>



<p class="wp-block-paragraph">Enriching the Prefix patch implementation above with a .NET Assembly parsing logic (using&nbsp;<a href="https://github.com/Washi1337/AsmResolver">AsmResolver</a>&nbsp;library) to properly find all invocations of constants’ decryption functions with corresponding arguments, and further invoking them via reflection, allows us to obtain the decrypted form of constants that helps to rebuild the deobfuscated sample. The complete source code is available&nbsp;<a href="https://github.com/Dump-GUY/ConfuserEx2_String_Decryptor/blob/main/ConfuserEx2_String_Decryptor/ConfuserEx2_String_Decryptor/Program.cs">here</a>&nbsp;and results in a tool called “<strong>ConfuserEx2_String_Decryptor</strong>”.</p>



<p class="wp-block-paragraph">Using this tool to deobfuscate our example ConfuserEx2 protected program is shown below (40s GIF):</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img decoding="async" width="1919" height="1079" src="https://research.checkpoint.com/wp-content/uploads/2024/01/rId86-1.gif" alt="" class="wp-image-29334"><figcaption class="wp-element-caption">Figure 13: Deobfuscation with the “<strong>ConfuserEx2_String_Decryptor</strong>” tool (40s GIF).</figcaption></figure>
</div>


<h2 class="wp-block-heading" id="harmony-hooking-from-the-dnspyex-debugging-context">Harmony Hooking from the DnSpyEx Debugging Context</h2>



<p class="wp-block-paragraph">Regarding the instrumentation of the .NET code, the Harmony library has already proved to be very useful for some specific tasks (shown in the “<strong>Common Examples of Implementation</strong>” section), especially when it comes to automating. However, we still do not have the best and easiest control over the exact moment when the Harmony patches are installed and uninstalled.</p>



<p class="wp-block-paragraph">Let’s take an example code like the one shown below and imagine altering the functionality of the 5th → 8th invocations of the&nbsp;<code>void Console.WriteLine(System.String)</code>&nbsp;method.</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">static </span><span class="enlighter-k1">void</span><span class="enlighter-text"> </span><span class="enlighter-m0">Main</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook Me If You Can!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook Me If You Can!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook Me If You Can!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook Me If You Can!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook Me If You Can!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">; </span><span class="enlighter-c0">// Alter This</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook Me If You Can!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">; </span><span class="enlighter-c0">// Alter This</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook Me If You Can!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">; </span><span class="enlighter-c0">// Alter This</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook Me If You Can!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">; </span><span class="enlighter-c0">// Alter This</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook Me If You Can!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook Me If You Can!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook Me If You Can!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    Console.</span><span class="enlighter-m3">WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Hook Me If You Can!!!"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">static void Main()
{
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!"); // Alter This
    Console.WriteLine("Hook Me If You Can!!!"); // Alter This
    Console.WriteLine("Hook Me If You Can!!!"); // Alter This
    Console.WriteLine("Hook Me If You Can!!!"); // Alter This
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!");
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">static void Main()
{
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!"); // Alter This
    Console.WriteLine("Hook Me If You Can!!!"); // Alter This
    Console.WriteLine("Hook Me If You Can!!!"); // Alter This
    Console.WriteLine("Hook Me If You Can!!!"); // Alter This
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!");
    Console.WriteLine("Hook Me If You Can!!!");
}</pre>



<p class="wp-block-paragraph">In this simple case, we can very likely come up with some clumsy solution using just the Harmony library, but this will not work in much more complex situations.</p>



<p class="wp-block-paragraph">Usually, when we want to have absolute control over the instrumentation of .NET code, using a managed debugger like&nbsp;<a href="https://github.com/dnSpyEx/dnSpy">dnSpyEx</a>&nbsp;is the most convenient way. The main disadvantage is that in the case of a non-scriptable debugger, altering the functionality of certain parts of the code becomes a manual, time-consuming piece of work, far removed from automation.</p>



<p class="wp-block-paragraph">If there was a way to effectively combine the debugging of dnSpyEx with the hooking features of the Harmony library, we could harness the strengths of both tools to their fullest extent. And the exciting part is, it’s already a reality.</p>



<p class="wp-block-paragraph">First, we prepare the Harmony hooking library that is going to be used from the dnSpyEx debugging context. This example library hooks the&nbsp;<code>void Console.WriteLine(System.String)</code>&nbsp;function using the Prefix type of patch and contains two other methods,&nbsp;<code>InstallHook()</code>&nbsp;and&nbsp;<code>UninstallHook()</code>, that invoke the patching and unpatching.</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">using System;</span></div></div><div class=""><div><span class="enlighter-text">using System.</span><span class="enlighter-m3">Reflection</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">using HarmonyLib;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">namespace Captain_HooK</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    public </span><span class="enlighter-k1">class</span><span class="enlighter-text"> HooK</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        public static </span><span class="enlighter-k1">void</span><span class="enlighter-text"> </span><span class="enlighter-m0">UninstallHook</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-g1">(</span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Harmony</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"ItDoesNotMatter"</span><span class="enlighter-g1">))</span><span class="enlighter-text">.</span><span class="enlighter-m3">UnpatchAll</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        public static </span><span class="enlighter-k1">void</span><span class="enlighter-text"> </span><span class="enlighter-m0">InstallHook</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            MethodInfo target = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">Console</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"WriteLine"</span><span class="enlighter-text">, </span><span class="enlighter-k1">new</span><span class="enlighter-g1">[]</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"> </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">string</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">})</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">target == </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                throw </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Exception</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Could not resolve Console.WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            Harmony harmony = </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">Harmony</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            MethodInfo stub = </span><span class="enlighter-m0">typeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">HooK</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"PreFix_WriteLine"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            harmony.</span><span class="enlighter-m3">Patch</span><span class="enlighter-g1">(</span><span class="enlighter-text">target, </span><span class="enlighter-k1">new</span><span class="enlighter-text"> </span><span class="enlighter-m0">HarmonyMethod</span><span class="enlighter-g1">(</span><span class="enlighter-text">stub</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        public static bool </span><span class="enlighter-m0">PreFix_WriteLine</span><span class="enlighter-g1">(</span><span class="enlighter-text">ref string value</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            value = </span><span class="enlighter-s0">"Captain Hook Was Here!!!"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-k1">true</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">using System;
using System.Reflection;
using HarmonyLib;

namespace Captain_HooK
{
    public class HooK
    {
        public static void UninstallHook()
        {
            (new Harmony("ItDoesNotMatter")).UnpatchAll("WriteLine");
        }

        public static void InstallHook()
        {
            MethodInfo target = typeof(Console).GetMethod("WriteLine", new[] { typeof(string) });
            if (target == null)
                throw new Exception("Could not resolve Console.WriteLine");

            Harmony harmony = new Harmony("WriteLine");
            MethodInfo stub = typeof(HooK).GetMethod("PreFix_WriteLine");
            harmony.Patch(target, new HarmonyMethod(stub));
        }

        public static bool PreFix_WriteLine(ref string value)
        {
            value = "Captain Hook Was Here!!!";
            return true;
        }
    }
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">using System;
using System.Reflection;
using HarmonyLib;

namespace Captain_HooK
{
    public class HooK
    {
        public static void UninstallHook()
        {
            (new Harmony("ItDoesNotMatter")).UnpatchAll("WriteLine");
        }

        public static void InstallHook()
        {
            MethodInfo target = typeof(Console).GetMethod("WriteLine", new[] { typeof(string) });
            if (target == null)
                throw new Exception("Could not resolve Console.WriteLine");

            Harmony harmony = new Harmony("WriteLine");
            MethodInfo stub = typeof(HooK).GetMethod("PreFix_WriteLine");
            harmony.Patch(target, new HarmonyMethod(stub));
        }

        public static bool PreFix_WriteLine(ref string value)
        {
            value = "Captain Hook Was Here!!!";
            return true;
        }
    }
}</pre>



<p class="wp-block-paragraph">Next, we need to be able to load our prepared Harmony library from the dnSpyEx debugger and invoke the&nbsp;<code>InstallHook()</code>&nbsp;and&nbsp;<code>UninstallHook()</code>&nbsp;functions in the context of the debugged process. For that purpose, we can use the “<strong>Watch Window</strong>” in the dnSpyEx debugger that has the ability to evaluate C# expressions in the context of the debugged application. An example of such expression evaluation is shown below.</p>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/01/7YRZ5D22HF-rId90.png" alt="Figure 14: DnSpyEx debugger - Example of expression evaluation via
“Watch Window”."><figcaption class="wp-element-caption">Figure 14: DnSpyEx debugger – Example of expression evaluation via “Watch Window”.</figcaption></figure>
</div>


<p class="wp-block-paragraph">The last thing we need to prepare is the magic incantations that will use the expression evaluation to invoke the functions&nbsp;<code>InstallHook()</code>&nbsp;and&nbsp;<code>UninstallHook()</code>&nbsp;at the precise moment we want to do so.</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-c0">// Invoke InstallHook()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">((</span><span class="enlighter-text">System.</span><span class="enlighter-m3">Reflection</span><span class="enlighter-text">.</span><span class="enlighter-m3">Assembly</span><span class="enlighter-text">.</span><span class="enlighter-m3">LoadFile</span><span class="enlighter-g1">(</span><span class="enlighter-text">@</span><span class="enlighter-s0">"C:\Captain_HooK.dll"</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetType</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Captain_HooK.HooK"</span><span class="enlighter-g1">))</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"InstallHook"</span><span class="enlighter-g1">))</span><span class="enlighter-text">.</span><span class="enlighter-m3">Invoke</span><span class="enlighter-g1">(</span><span class="enlighter-k1">null</span><span class="enlighter-text">, </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c0">// Invoke UninstallHook()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">((</span><span class="enlighter-text">System.</span><span class="enlighter-m3">Reflection</span><span class="enlighter-text">.</span><span class="enlighter-m3">Assembly</span><span class="enlighter-text">.</span><span class="enlighter-m3">LoadFile</span><span class="enlighter-g1">(</span><span class="enlighter-text">@</span><span class="enlighter-s0">"C:\Captain_HooK.dll"</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetType</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Captain_HooK.HooK"</span><span class="enlighter-g1">))</span><span class="enlighter-text">.</span><span class="enlighter-m3">GetMethod</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"UninstallHook"</span><span class="enlighter-g1">))</span><span class="enlighter-text">.</span><span class="enlighter-m3">Invoke</span><span class="enlighter-g1">(</span><span class="enlighter-k1">null</span><span class="enlighter-text">, </span><span class="enlighter-k1">null</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">// Invoke InstallHook()
((System.Reflection.Assembly.LoadFile(@"C:\Captain_HooK.dll").GetType("Captain_HooK.HooK")).GetMethod("InstallHook")).Invoke(null, null);

// Invoke UninstallHook()
((System.Reflection.Assembly.LoadFile(@"C:\Captain_HooK.dll").GetType("Captain_HooK.HooK")).GetMethod("UninstallHook")).Invoke(null, null);</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">// Invoke InstallHook()
((System.Reflection.Assembly.LoadFile(@"C:\Captain_HooK.dll").GetType("Captain_HooK.HooK")).GetMethod("InstallHook")).Invoke(null, null);

// Invoke UninstallHook()
((System.Reflection.Assembly.LoadFile(@"C:\Captain_HooK.dll").GetType("Captain_HooK.HooK")).GetMethod("UninstallHook")).Invoke(null, null);</pre>



<p class="wp-block-paragraph">Putting it all together, using the dnSpyEx “<strong>Watch Window</strong>” expression evaluation to perform the Harmony hooking from the debugging context is shown below (45s GIF):</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img decoding="async" width="1919" height="1079" src="https://research.checkpoint.com/wp-content/uploads/2024/01/rId93-2.gif" alt="" class="wp-image-29336"><figcaption class="wp-element-caption">Figure 15: Harmony hooking from the dnSpyEx debugging context (45s GIF).</figcaption></figure>
</div>


<h2 class="wp-block-heading" id="conclusion">Conclusion</h2>



<p class="wp-block-paragraph">In this article, we introduced .NET managed hooking using the&nbsp;<strong>Harmony</strong>&nbsp;library and its internals. We presented examples of implementations that covered the most common usage of the Harmony library and its different types of patches.</p>



<p class="wp-block-paragraph">These examples demonstrate how powerful .NET hooking can be and more importantly, how easy and straightforward it is to implement .NET instrumentation once we use the Harmony library.</p>



<p class="wp-block-paragraph">We showed how useful the Harmony hooking is in a practical example involving the notorious obfuscator “ConfuserEx2” that results in the release of the publicly available tool “<strong>ConfuserEx2_String_Decryptor</strong>”.</p>



<p class="wp-block-paragraph">Finally, we revealed a neat trick how to use the Harmony hooking from the dnSpyEx debugging context. This combination of debugging and hooking gave us the ability to automate the instrumentation of .NET code, still preserving full control over its state of execution.</p>



<p class="wp-block-paragraph">One of the main advantages of the .NET hooking is that it operates only on in-memory code, so it does not touch the files on disk in any way. This comes in very handy, especially in cases where we are dealing with dotnet malware protected by an obfuscator in a way that the deobfuscation via .NET Assembly rebuilding is time-consuming and needs to be done very carefully so as not to destroy the original structure, which can later lead to a complete loss of functionality.</p>



<p class="wp-block-paragraph">The other advantage is that we are not only limited to hook .NET methods defined in the scope of one specific .NET Assembly, but we can alter the functionality of&nbsp;<em>all</em>&nbsp;referenced assemblies, especially those that come with and build the .NET Runtime.</p>



<p class="wp-block-paragraph">Even though we mostly focused on the basics of .NET hooking and just briefly touched on its practical uses, our readers gained a lot of information on how to construct a shortcut for malware analysis in areas like: .NET Instrumentation, Tracing, Deobfuscation, etc.</p>



<h2 class="wp-block-heading" id="references">References</h2>



<p class="wp-block-paragraph">Harmony Library:&nbsp;<a href="https://github.com/pardeike/Harmony">https://github.com/pardeike/Harmony</a></p>



<p class="wp-block-paragraph">Harmony Library – Documentation:&nbsp;<a href="https://harmony.pardeike.net/">https://harmony.pardeike.net/</a></p>



<p class="wp-block-paragraph">ExtremeDumper:&nbsp;<a href="https://github.com/wwh1004/ExtremeDumper">https://github.com/wwh1004/ExtremeDumper</a></p>



<p class="wp-block-paragraph">DnSpyEx:&nbsp;<a href="https://github.com/dnSpyEx/dnSpy">https://github.com/dnSpyEx/dnSpy</a></p>



<p class="wp-block-paragraph">ConfuserEx2 Protector:&nbsp;<a href="https://github.com/mkaring/ConfuserEx">https://github.com/mkaring/ConfuserEx</a></p>



<p class="wp-block-paragraph">AsmResolver:&nbsp;<a href="https://github.com/Washi1337/AsmResolver">https://github.com/Washi1337/AsmResolver</a></p>



<p class="wp-block-paragraph">ConfuserEx2 String Decryptor:&nbsp;<a href="https://github.com/Dump-GUY/ConfuserEx2_String_Decryptor">https://github.com/Dump-GUY/ConfuserEx2_String_Decryptor</a></p>
					</div>			
				</div>
				 
				<div class="back-to-top">
					<a href="https://research.checkpoint.com/2024/net-hooking-harmonizing-managed-territory/#single-post">
										<div class="image center">
						<img src="https://research.checkpoint.com/wp-content/uploads/2022/10/back_arrow.svg" alt="" width="300" height="150">
					</div>
										
											GO UP							
					</a>
				</div>
										<div class="button-wrap center">
						<a class="button background-skyblue font-white skyblue-border" href="https://research.checkpoint.com/latest-publications/">BACK TO ALL POSTS</a>
					</div>
						

			</div>
			 
				<div class="flex-4">
					
<div class="sidebar-post-wrapper">
		<div class="sidebar-post-inner">
					</div>
				<div class="sidebar-post-categories popular">
				<div class="aside-box">
					<h2>POPULAR POSTS</h2>
				<div class="blog-most-popular font-white">
									<div class="blog-most-popular-row relative">
										<a class="background-image" href="https://research.checkpoint.com/2023/opwnai-cybercriminals-starting-to-use-chatgpt/" style="background-image: url(https://research.checkpoint.com/wp-content/uploads/2023/01/AI-1059x529-copy.jpg);">
						<img src="https://research.checkpoint.com/wp-content/uploads/2023/01/AI-1059x529-copy.jpg" alt="">						</a>
								<div class="title">
					<ul class="top-content category-wraper">
													<li>Artificial Intelligence</li>													<li>ChatGPT</li>													<li>Check Point Research Publications</li>											</ul>
					<a href="https://research.checkpoint.com/2023/opwnai-cybercriminals-starting-to-use-chatgpt/">OPWNAI : Cybercriminals Starting to Use ChatGPT</a>
				</div>
			</div>
									<div class="blog-most-popular-row relative">
										<a class="background-image" href="https://research.checkpoint.com/2019/hacking-fortnite/" style="background-image: url(https://research.checkpoint.com/wp-content/uploads/2019/01/Fortnite_1021x580.jpg);">
						<img src="https://research.checkpoint.com/wp-content/uploads/2019/01/Fortnite_1021x580.jpg" alt="">						</a>
								<div class="title">
					<ul class="top-content category-wraper">
													<li>Check Point Research Publications</li>													<li>Threat Research</li>											</ul>
					<a href="https://research.checkpoint.com/2019/hacking-fortnite/">Hacking Fortnite Accounts</a>
				</div>
			</div>
									<div class="blog-most-popular-row relative">
										<a class="background-image" href="https://research.checkpoint.com/2022/opwnai-ai-that-can-save-the-day-or-hack-it-away/" style="background-image: url(https://research.checkpoint.com/wp-content/uploads/2022/12/OpenAIchatGPT_header.jpg);">
						<img src="https://research.checkpoint.com/wp-content/uploads/2022/12/OpenAIchatGPT_header.jpg" alt="">						</a>
								<div class="title">
					<ul class="top-content category-wraper">
													<li>Artificial Intelligence</li>													<li>ChatGPT</li>													<li>Check Point Research Publications</li>											</ul>
					<a href="https://research.checkpoint.com/2022/opwnai-ai-that-can-save-the-day-or-hack-it-away/">OpwnAI: AI That Can Save the Day or HACK it Away</a>
				</div>
			</div>
					</div>
	</div>
		</div>
		</div>  
				</div>
						
		</div>
	</div>
		
		 

<div class="aside-box">
	<div class="container container-wide">
	<div class="text font-blue-- section-title">
		<h3>BLOGS AND PUBLICATIONS</h3>
	</div>
	</div>
					<div class="blog-most-recent font-white slick-initialized slick-slider slick-dotted" role="toolbar">
														<div aria-live="polite" class="slick-list draggable" style="padding: 0px 30px; height: 164.438px;"><div class="slick-track" role="listbox" style="opacity: 1; width: 15000px; transform: translate3d(-204px, 0px, 0px);"><div class="blog-slide slick-slide slick-cloned" data-slick-index="-2" id="" aria-hidden="true" tabindex="-1">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2017/the-next-wannacry-vulnerability-is-here/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2017/08/WannaCry-Post-No-Image-1021x450.jpg')" tabindex="-1">
								<img src="https://research.checkpoint.com/wp-content/uploads/2017/08/WannaCry-Post-No-Image-1021x450.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>															</ul>
							<div class="text">
								<span class="date small-font">August 11, 2017</span>
								<h3>“The Next WannaCry” Vulnerability is Here</h3>
							</div>
						</div>
					</div><div class="blog-slide slick-slide slick-cloned" data-slick-index="-1" id="" aria-hidden="true" tabindex="-1">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2018/rubyminer-cryptominer-affects-30-ww-networks/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2018/01/rubyminer.jpg')" tabindex="-1">
								<img src="https://research.checkpoint.com/wp-content/uploads/2018/01/rubyminer.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>															</ul>
							<div class="text">
								<span class="date small-font">January 11, 2018</span>
								<h3>‘RubyMiner’ Cryptominer Affects 30% of WW Networks</h3>
							</div>
						</div>
					</div><div class="blog-slide slick-slide slick-current slick-active slick-center" data-slick-index="0" aria-hidden="false" tabindex="-1" role="option" aria-describedby="slick-slide00">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2020/the-turkish-rat-distributes-evolved-adwind-in-a-massive-ongoing-phishing-campaign/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2020/02/CheckPointResearchTurkishRat_blog_header.jpg')" tabindex="0">
								<img src="https://research.checkpoint.com/wp-content/uploads/2020/02/CheckPointResearchTurkishRat_blog_header.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>																	<li>Global Cyber Attack Reports</li>																	<li>Threat Research</li>															</ul>
							<div class="text">
								<span class="date small-font">February 17, 2020</span>
								<h3>“The Turkish Rat” Evolved Adwind in a Massive Ongoing Phishing Campaign</h3>
							</div>
						</div>
					</div><div class="blog-slide slick-slide" data-slick-index="1" aria-hidden="true" tabindex="-1" role="option" aria-describedby="slick-slide01">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2017/the-next-wannacry-vulnerability-is-here/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2017/08/WannaCry-Post-No-Image-1021x450.jpg')" tabindex="-1">
								<img src="https://research.checkpoint.com/wp-content/uploads/2017/08/WannaCry-Post-No-Image-1021x450.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>															</ul>
							<div class="text">
								<span class="date small-font">August 11, 2017</span>
								<h3>“The Next WannaCry” Vulnerability is Here</h3>
							</div>
						</div>
					</div><div class="blog-slide slick-slide" data-slick-index="2" aria-hidden="true" tabindex="-1" role="option" aria-describedby="slick-slide02">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2018/rubyminer-cryptominer-affects-30-ww-networks/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2018/01/rubyminer.jpg')" tabindex="-1">
								<img src="https://research.checkpoint.com/wp-content/uploads/2018/01/rubyminer.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>															</ul>
							<div class="text">
								<span class="date small-font">January 11, 2018</span>
								<h3>‘RubyMiner’ Cryptominer Affects 30% of WW Networks</h3>
							</div>
						</div>
					</div><div class="blog-slide slick-slide slick-cloned slick-center" data-slick-index="3" id="" aria-hidden="true" tabindex="-1">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2020/the-turkish-rat-distributes-evolved-adwind-in-a-massive-ongoing-phishing-campaign/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2020/02/CheckPointResearchTurkishRat_blog_header.jpg')" tabindex="-1">
								<img src="https://research.checkpoint.com/wp-content/uploads/2020/02/CheckPointResearchTurkishRat_blog_header.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>																	<li>Global Cyber Attack Reports</li>																	<li>Threat Research</li>															</ul>
							<div class="text">
								<span class="date small-font">February 17, 2020</span>
								<h3>“The Turkish Rat” Evolved Adwind in a Massive Ongoing Phishing Campaign</h3>
							</div>
						</div>
					</div><div class="blog-slide slick-slide slick-cloned" data-slick-index="4" id="" aria-hidden="true" tabindex="-1">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2017/the-next-wannacry-vulnerability-is-here/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2017/08/WannaCry-Post-No-Image-1021x450.jpg')" tabindex="-1">
								<img src="https://research.checkpoint.com/wp-content/uploads/2017/08/WannaCry-Post-No-Image-1021x450.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>															</ul>
							<div class="text">
								<span class="date small-font">August 11, 2017</span>
								<h3>“The Next WannaCry” Vulnerability is Here</h3>
							</div>
						</div>
					</div></div></div>
														
														
								
			<ul class="slick-dots" style="" role="tablist"><li class="slick-active" aria-hidden="false" role="presentation" aria-selected="true" aria-controls="navigation00" id="slick-slide00"><button type="button" data-role="none" role="button" tabindex="0">1</button></li><li aria-hidden="true" role="presentation" aria-selected="false" aria-controls="navigation01" id="slick-slide01"><button type="button" data-role="none" role="button" tabindex="0">2</button></li><li aria-hidden="true" role="presentation" aria-selected="false" aria-controls="navigation02" id="slick-slide02"><button type="button" data-role="none" role="button" tabindex="0">3</button></li></ul></div>
			<div class="progress blog-most-recent-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
				<span class="slider__label sr-only blog-recent-bar"> </span>
			</div>
		</div>	
</section>






<div id="cookies-notice" class="cookies-notice background-white" style="display: block;">
	<div class="container container-wide">
		<div class="flex-row">
			<div class="flex-8">
				<div class="text text-black"><h2>We value your privacy!</h2>
<p>BFSI uses cookies on this site. We use cookies to enable faster and easier experience for you. By continuing to visit this website you agree to our use of cookies.</p>
				</div>
			</div>
			<div class="flex-4">
				<div class="button-wrap justify-content-end">
					<div id="cn-accept-cookies" class="button font-white background-skyblue skyblue-border margin-right">ACCEPT</div>
					<div class="button transparent cookie-close font-white skyblue-border skyblue-font">REJECT</div>
				</div>
			</div>
			<div class="close-button cookie-close svg">
				<svg xmlns="http://www.w3.org/2000/svg" width="16.828" height="16.828" viewBox="0 0 16.828 16.828">
					<g id="Group_163304" data-name="Group 163304" transform="translate(1.414 1.414)"><line id="Line_323" data-name="Line 323" x2="14" y2="14" fill="none" stroke="#fff" stroke-linecap="round" stroke-width="2"></line><line id="Line_324" data-name="Line 324" x1="14" y2="14" fill="none" stroke="#fff" stroke-linecap="round" stroke-width="2"></line></g></svg>
				</div>
			</div>
		</div>
	</div>
















</body></html>