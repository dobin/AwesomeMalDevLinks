Title:
WorstFit: Unveiling Hidden Transformers in Windows ANSI

Type:
Blog Post

Short Summary (4–8 sentences max):
- This research analyzes Windows “Best-Fit” Unicode→ANSI conversion behavior and reframes it as a systemic attack surface (“WorstFit”) when software uses ANSI APIs/CRT paths.  
- It shows how implicit conversions (e.g., `RtlUnicodeStringToAnsiString`, `WideCharToMultiByte`, `GetCommandLineA`, `GetEnvironmentVariableA`, and CRT `main()` startup) can transform benign-looking Unicode into security-significant ASCII characters like `"`, `\`, `/`, space, or `-`.  
- The post details three exploit classes: Filename Smuggling (path traversal via converted slashes), Argument Splitting (injecting new CLI args despite proper escaping), and Environment Variable Confusion (WAF/validation bypass and path ambiguity via CGI env vars).  
- It includes real-world case studies and CVEs, notably PHP-CGI argument injection bypass (CVE-2024-4577) and a 1-click Excel chain leveraging argument splitting into NTLM relay (CVE-2024-49026), plus impacts across tools like tar, curl builds, OpenSSL, SVN, plink, and legacy Python ecosystems.  
- The work is useful for red teams/pentesters finding Windows-specific injection primitives, and for defenders/developers auditing ANSI API usage and locale/code-page dependent behavior.  
- It’s important because it breaks the assumption that “proper escaping” at the app/library layer is sufficient when the OS later mutates strings during ANSI conversion.

Technical Focus:
- Windows code pages (ACP/OEMCP) and Best-Fit mapping tables
- ANSI vs Unicode Windows APIs (`*A` vs `*W`) and implicit conversion routines
- Command-line construction/parsing on Windows (`CreateProcess*`, `GetCommandLineA`, CRT parsing rules)
- Path canonicalization and traversal via Unicode→ANSI slash/backslash transformations
- CGI environment variables and cross-component interpretation mismatches (e.g., `PATH_INFO`, `PATH_TRANSLATED`)
- Locale-dependent exploitability and mitigation via UTF-8 system locale / wide-char entrypoints (`wmain`, `_wgetenv`, `_wgetcwd`)

Use Cases:
- Identify argument-injection/RCE paths in Windows apps that spawn CLI tools even when using “safe” argument escaping
- Craft path traversal payloads via Unicode filenames/working directories that collapse into `../` or separators under ANSI APIs
- Bypass WAF/routing rules by exploiting Best-Fit transformations in CGI environment variables
- Audit binaries for ANSI entrypoints (`main` vs `wmain`) and `*A` API usage to prioritize remediation
- Build detection rules around suspicious Unicode characters that Best-Fit to metacharacters under specific ACPs

Keywords:
Best-Fit, WorstFit, Windows ANSI, ACP, code page 1252, code page 932, code page 936, code page 950, `GetCommandLineA`, `GetEnvironmentVariableA`, `RtlUnicodeStringToAnsiString`, `WideCharToMultiByte`, `CreateProcessW`, `CommandLineToArgvW`, MSVCRT, UCRT, `mainCRTStartup`, argument injection, argument splitting, path traversal, filename smuggling, CGI, PATH_INFO, CVE-2024-4577, CVE-2024-49026, NTLM relay