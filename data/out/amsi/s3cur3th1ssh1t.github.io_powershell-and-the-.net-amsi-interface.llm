Title:
Powershell and the .NET AMSI Interface

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains why some PowerShell AMSI bypasses appear to work for script content but still fail when the script loads a .NET assembly via `[System.Reflection.Assembly]::Load()`.  
- The “incorrect format”/assembly load exception is shown to be a symptom of AMSI scanning the in-memory .NET binary, not a genuine loader/architecture issue.  
- It distinguishes PowerShell-specific bypasses (tweaking `System.Management.Automation.AmsiUtils` / disabling script logging) from process-wide bypasses that affect AMSI for the entire process.  
- The author demonstrates that patching `amsi.dll` in-memory (e.g., patching `AmsiScanBuffer`) bypasses both script scanning and .NET assembly-load scanning in the same process.  
- It also highlights common detection points in public bypass code (API imports, strings like `amsi.dll`/`AmsiScanBuffer`, patch bytes) and shows simple obfuscation/randomization approaches (e.g., amsi.fail payload generation).  
- Useful for red teamers/pentesters troubleshooting PowerSharpPack-style loaders and for defenders understanding why certain AMSI bypasses fail/succeed depending on scope.

Technical Focus:
- AMSI architecture differences: PowerShell script scanning vs .NET assembly load scanning
- `System.Management.Automation.AmsiUtils`-based bypasses and their limitations
- In-memory patching of `amsi.dll` (process-wide AMSI bypass)
- P/Invoke usage: `LoadLibrary`, `GetProcAddress`, `VirtualProtect`
- Patching `AmsiScanBuffer` and byte-level stub replacement
- Obfuscation/randomization of bypass code to evade static signatures

Use Cases:
- Troubleshoot PowerShell loaders that decode/decompress and `Assembly.Load()` .NET payloads
- Implement process-wide AMSI bypasses for in-process .NET execution scenarios
- Modify/obfuscate known AMSI bypass PoCs to reduce static detections
- Blue team validation: reproduce and detect AMSI patching behaviors in memory

Keywords:
AMSI, amsi.dll, .NET AMSI interface, PowerShell, System.Management.Automation, AmsiUtils, AmsiScanBuffer, Assembly.Load, reflection, in-memory patching, VirtualProtect, LoadLibrary, GetProcAddress, P/Invoke, PowerSharpPack, amsi.fail, script block logging, obfuscation, dynamic methods assembly