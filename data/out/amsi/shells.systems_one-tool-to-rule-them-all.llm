Title:
AMSI, CLM and ETW – defeated with one Microsoft signed tool

Type:
Blog Post

Short Summary (4–8 sentences max):
- The post demonstrates using Microsoft-signed console debuggers (CDB/NTSD from Windows Debugging Tools) to bypass or manipulate multiple Windows security controls from a single “trusted” binary.  
- It shows an AMSI bypass by launching PowerShell under CDB, setting a breakpoint on `AmsiScanBuffer`, and patching execution/return values so scans effectively return “clean” (e.g., forcing `0x80070057`).  
- It explores Constrained Language Mode (CLM) manipulation by targeting `System.Management.Automation.Security.SystemPolicy.GetSystemLockdownPolicy()`, including patching managed code (CIL/MSIL bytes `ldc.i4.0; ret`) and using SOS (`.loadby sos clr`) to locate and patch JIT-compiled method addresses.  
- It also discusses suppressing PowerShell-related ETW telemetry by patching ETW-related routines (noting that naïvely patching `EtwEventWrite` alone is insufficient) and validates impact via missing Event Log entries (e.g., 4103 pipeline events).  
- The technique is primarily useful for red teams/pentesters and malware tradecraft research because it leverages a Microsoft-signed debugger to perform in-memory patching and policy manipulation that may evade basic application control assumptions.  
- It’s interesting because it consolidates AMSI/ETW/CLM tampering into debugger scripting and highlights the defensive need for image hardening and restricting/debugger tooling.

Technical Focus:
- CDB/NTSD debugger scripting (`-cf`), breakpoints, and automated patching
- AMSI internals (`AmsiScanBuffer`, HRESULT manipulation)
- PowerShell CLM / WDAC/AppLocker policy evaluation (`GetSystemLockdownPolicy`)
- .NET debugging with SOS (`.loadby sos clr`, `!name2ee`, method tables, JIT addresses)
- Managed (CIL/MSIL) vs native patching (post-JIT assembly edits)
- ETW suppression concepts and PowerShell eventing (Event ID 4103)

Use Cases:
- Automate AMSI bypass for a spawned PowerShell process without direct RW patching of `amsi.dll`
- Modify/force PowerShell language mode behavior (CLM enforcement/bypass research)
- Disable or reduce PowerShell ETW/event log visibility during execution
- Tradecraft development using “living-off-the-land” signed Microsoft tooling (debuggers)
- Defensive validation: detect/alert on debugger-driven tampering of AMSI/ETW/PowerShell internals

Keywords:
AMSI, AmsiScanBuffer, AmsiScanString, E_INVALIDARG, 0x80070057, PowerShell, ConstrainedLanguageMode, CLM, System.Management.Automation, GetSystemLockdownPolicy, WDAC, AppLocker, CDB, NTSD, Windows Debugging Tools, breakpoint, in-memory patching, SOS.dll, !name2ee, JIT, CIL, MSIL, ETW, EtwEventWrite, Event ID 4103, Defender for Endpoint