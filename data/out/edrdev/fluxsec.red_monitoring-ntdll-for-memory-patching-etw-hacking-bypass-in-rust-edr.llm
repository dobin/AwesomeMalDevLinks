Title:
Monitoring NTDLL for in-memory patching (ETW hacking/bypass) in Rust

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes a user-mode integrity check to detect in-memory patching of `ntdll.dll`, a common evasion technique used by malware (e.g., ETW patching to blind telemetry).  
- The approach locates the `.text` section of NTDLL in the current process by parsing PE headers, then periodically re-reads that memory region and hashes it to detect modifications.  
- It explains PE fundamentals (DOS header, NT headers, section headers) and why `IMAGE_SECTION_HEADER.Misc.VirtualSize` is a better in-memory size indicator than `OptionalHeader.SizeOfCode`.  
- A dedicated OS thread recomputes an MD5 hash on an interval (example: 1s) and reports when the hash changes, demonstrated by detecting an ETW patching test malware.  
- The author notes limitations against short-lived “hot patching” and suggests stronger follow-ups like monitoring memory-protection changes (`VirtualProtect`) or write APIs (`NtWriteVirtualMemory`) and signaling an EDR controller (e.g., via named pipe).  
- Useful for EDR/defensive tooling developers and red teamers studying detection vs. ETW/NTDLL patch-based evasion.

Technical Focus:
- PE header parsing to locate `.text` (DOS/NT headers, section headers, RVA vs VA)
- In-memory module inspection via `GetModuleHandleA` and pointer arithmetic
- Hash-based integrity monitoring of code sections (`.text`) in `ntdll.dll`
- ETW patching as an evasion technique and detection implications
- Multi-threaded periodic scanning in Rust (Windows user-mode)

Use Cases:
- Detect user-mode ETW patching and other NTDLL `.text` modifications in a process
- Add a lightweight integrity monitor component to an EDR/agent DLL
- Validate whether “unhook/unpatch” techniques modify NTDLL in-memory
- Research tradeoffs between periodic integrity checks vs. API/protection-change monitoring

Keywords:
ntdll.dll, ETW patching, Event Tracing for Windows, in-memory patching, PE headers, IMAGE_DOS_HEADER, IMAGE_NT_HEADERS64, IMAGE_SECTION_HEADER, .text section, BaseOfCode, VirtualSize, RVA, VA, GetModuleHandleA, VirtualProtect, NtWriteVirtualMemory, Rust, pointer arithmetic, MD5 hashing, EDR detection