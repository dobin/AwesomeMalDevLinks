# https://medium.com/@matterpreter/mimidrv-in-depth-4d273d19e148

<!DOCTYPE html><html lang="en" data-rh="lang" dir="ltr"><body><div id="root"><div class="a b c"><a href="https://medium.com/sitemap/sitemap.xml" class="d">Sitemap</a><div class="e f g h i j k l"></div><div></div><div class="m c"><div class="m n o p c" style="transform: translateY(0px);"><div class="q r s t u v w x y j e z ab"><a class="eb ai ec bg am b ao ap aq ar as at au av t v x j e r ed ab" href="https://play.google.com/store/apps/details?id=com.medium.reader&amp;referrer=utm_source%3DmobileNavBar&amp;source=post_page---top_nav_layout_nav-----------------------------------------" rel="noopener follow">Open in app<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="none" viewBox="0 0 10 10" class="ea"><path fill="currentColor" d="M.985 8.485a.375.375 0 1 0 .53.53zM8.75 1.25h.375A.375.375 0 0 0 8.75.875zM8.375 6.5a.375.375 0 1 0 .75 0zM3.5.875a.375.375 0 1 0 0 .75zm-1.985 8.14 7.5-7.5-.53-.53-7.5 7.5zm6.86-7.765V6.5h.75V1.25zM3.5 1.625h5.25v-.75H3.5z"></path></svg></a><div class="ac r"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><button class="bg b ee ef ep eg eh eq ei ej er es el et eu eo ev ew ex ey ez fa fb fc fd fe ff fg fh fi fj fk bn fl fm" data-testid="headerSignUpButton">Sign up</button></span></p><div class="fn m"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerSignInButton" rel="noopener follow" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Fmedium.com%2F%40matterpreter%2Fmimidrv-in-depth-4d273d19e148&amp;source=post_page---top_nav_layout_nav-----------------------global_nav------------------" data-discover="true">Sign in</a></span></p></div></div></div><div class="q r s ac ae af"><div class="ac r ag"><a class="ah ai aj ak al am an ao ap aq ar as at au av ac" aria-label="Homepage" data-testid="headerMediumLogo" rel="noopener follow" href="https://medium.com/?source=post_page---top_nav_layout_nav-----------------------------------------" data-discover="true"><svg xmlns="http://www.w3.org/2000/svg" width="719" height="160" fill="none" aria-labelledby="wordmark-medium-desc" viewBox="0 0 719 160" class="aw ax ay"><desc id="wordmark-medium-desc">Medium Logo</desc><path fill="#242424" d="m174.104 9.734.215-.047V8.02H130.39L89.6 103.89 48.81 8.021H1.472v1.666l.212.047c8.018 1.81 12.09 4.509 12.09 14.242V137.93c0 9.734-4.087 12.433-12.106 14.243l-.212.047v1.671h32.118v-1.665l-.213-.048c-8.018-1.809-12.089-4.509-12.089-14.242V30.586l52.399 123.305h2.972l53.925-126.743V140.75c-.687 7.688-4.721 10.062-11.982 11.701l-.215.05v1.652h55.948v-1.652l-.215-.05c-7.269-1.639-11.4-4.013-12.087-11.701l-.037-116.774h.037c0-9.733 4.071-12.432 12.087-14.242m25.555 75.488c.915-20.474 8.268-35.252 20.606-35.507 3.806.063 6.998 1.312 9.479 3.714 5.272 5.118 7.751 15.812 7.368 31.793zm-.553 5.77h65.573v-.275c-.186-15.656-4.721-27.834-13.466-36.196-7.559-7.227-18.751-11.203-30.507-11.203h-.263c-6.101 0-13.584 1.48-18.909 4.16-6.061 2.807-11.407 7.003-15.855 12.511-7.161 8.874-11.499 20.866-12.554 34.343q-.05.606-.092 1.212a50 50 0 0 0-.065 1.151 85.807 85.807 0 0 0-.094 5.689c.71 30.524 17.198 54.917 46.483 54.917 25.705 0 40.675-18.791 44.407-44.013l-1.886-.664c-6.557 13.556-18.334 21.771-31.738 20.769-18.297-1.369-32.314-19.922-31.042-42.395m139.722 41.359c-2.151 5.101-6.639 7.908-12.653 7.908s-11.513-4.129-15.418-11.63c-4.197-8.053-6.405-19.436-6.405-32.92 0-28.067 8.729-46.22 22.24-46.22 5.657 0 10.111 2.807 12.236 7.704zm43.499 20.008c-8.019-1.897-12.089-4.722-12.089-14.951V1.309l-48.716 14.353v1.757l.299-.024c6.72-.543 11.278.386 13.925 2.83 2.072 1.915 3.082 4.853 3.082 8.987v18.66c-4.803-3.067-10.516-4.56-17.448-4.56-14.059 0-26.909 5.92-36.176 16.672-9.66 11.205-14.767 26.518-14.767 44.278-.003 31.72 15.612 53.039 38.851 53.039 13.595 0 24.533-7.449 29.54-20.013v16.865h43.711v-1.746zM424.1 19.819c0-9.904-7.468-17.374-17.375-17.374-9.859 0-17.573 7.632-17.573 17.374s7.721 17.374 17.573 17.374c9.907 0 17.375-7.47 17.375-17.374m11.499 132.546c-8.019-1.897-12.089-4.722-12.089-14.951h-.035V43.635l-43.714 12.551v1.705l.263.024c9.458.842 12.047 4.1 12.047 15.152v81.086h43.751v-1.746zm112.013 0c-8.018-1.897-12.089-4.722-12.089-14.951V43.635l-41.621 12.137v1.71l.246.026c7.733.813 9.967 4.257 9.967 15.36v59.279c-2.578 5.102-7.415 8.131-13.274 8.336-9.503 0-14.736-6.419-14.736-18.073V43.638l-43.714 12.55v1.703l.262.024c9.459.84 12.05 4.097 12.05 15.152v50.17a56.3 56.3 0 0 0 .91 10.444l.787 3.423c3.701 13.262 13.398 20.197 28.59 20.197 12.868 0 24.147-7.966 29.115-20.43v17.311h43.714v-1.747zm169.818 1.788v-1.749l-.213-.05c-8.7-2.006-12.089-5.789-12.089-13.49v-63.79c0-19.89-11.171-31.761-29.883-31.761-13.64 0-25.141 7.882-29.569 20.16-3.517-13.01-13.639-20.16-28.606-20.16-13.146 0-23.449 6.938-27.869 18.657V43.643L545.487 55.68v1.715l.263.024c9.345.829 12.047 4.181 12.047 14.95v81.784h40.787v-1.746l-.215-.053c-6.941-1.631-9.181-4.606-9.181-12.239V66.998c1.836-4.289 5.537-9.37 12.853-9.37 9.086 0 13.692 6.296 13.692 18.697v77.828h40.797v-1.746l-.215-.053c-6.94-1.631-9.18-4.606-9.18-12.239V75.066a42 42 0 0 0-.578-7.26c1.947-4.661 5.86-10.177 13.475-10.177 9.214 0 13.691 6.114 13.691 18.696v77.828z"></path></svg></a><div class="az i"><div class="ac ak ba bb bc r bd be"><div class="bn" aria-describedby="searchResults" aria-labelledby="searchResults" aria-haspopup="listbox" role="listbox"></div><div class="bo bp ac"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg></div><input role="combobox" aria-controls="searchResults" aria-expanded="false" aria-label="search" data-testid="headerSearchInput" tabindex="0" class="ak bf bg bh ab bi bj bk bl bm" placeholder="Search" value=""></div></div></div><div class="i l x fp fq"><span data-dd-action-name="Susi presentation tracker new_post_topnav"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerWriteButton" rel="noopener follow" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2Fnew-story&amp;source=---top_nav_layout_nav-----------------------new_post_topnav------------------" data-discover="true"><div class="bg b bh ab eb fr fs ac r ft fu fv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M14 4a.5.5 0 0 0 0-1zm7 6a.5.5 0 0 0-1 0zm-7-7H4v1h10zM3 4v16h1V4zm1 17h16v-1H4zm17-1V10h-1v10zm-1 1a1 1 0 0 0 1-1h-1zM3 20a1 1 0 0 0 1 1v-1zM4 3a1 1 0 0 0-1 1h1z"></path><path stroke="currentColor" d="m17.5 4.5-8.458 8.458a.25.25 0 0 0-.06.098l-.824 2.47a.25.25 0 0 0 .316.316l2.47-.823a.25.25 0 0 0 .098-.06L19.5 6.5m-2-2 2.323-2.323a.25.25 0 0 1 .354 0l1.646 1.646a.25.25 0 0 1 0 .354L19.5 6.5m-2-2 2 2"></path></svg>Write</div></a></span></div><div class="l k j e"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerSearchButton" rel="noopener follow" href="https://medium.com/search?source=post_page---top_nav_layout_nav-----------------------------------------" data-discover="true"><div class="bg b bh ab eb fr fs ac r ft fu fv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Search</span></div></a></div><div class="ge i l k"><div class="ac r"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><button class="bg b ee ef ep eg eh eq ei ej er es el et eu eo ev ew ex ey ez fa fb fc fd fe ff fg fh fi fj fk bn fl fm" data-testid="headerSignUpButton">Sign up</button></span></p><div class="fn m"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerSignInButton" rel="noopener follow" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Fmedium.com%2F%40matterpreter%2Fmimidrv-in-depth-4d273d19e148&amp;source=post_page---top_nav_layout_nav-----------------------global_nav------------------" data-discover="true">Sign in</a></span></p></div></div></div><div class="m"><div><div class="bn" role="tooltip" aria-describedby="1" aria-labelledby="1"><div tabindex="-1" class="bf"><button class="ak gf ao ac r aq fr gg gh gi" aria-label="user options menu" data-testid="headerUserIcon"><div class="m fr"><img alt="" class="m fk by bz ca de" width="32" height="32" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fill:32:32/1*dmbNkD5D-u45r44go_cf0g.png"><div class="gj by m bz ca fw o ak gk"></div></div></button></div></div></div></div></div></div><div class="ac"><div class="cb i l k j cc" style="width: 0px;"></div><div class="cd bi ce cf cg ch" style="width: calc(100% + 0px);"><div class="m"><div data-focus-guard="true" tabindex="-1" style="width: 1px; height: 0px; padding: 0px; overflow: hidden; position: fixed; top: 1px; left: 1px;"></div><div data-focus-lock-disabled="disabled"><div class="uu" role="dialog" aria-modal="true" tabindex="-1"><div class="yw yx bi ed yy yz za aq zb hd zc" aria-hidden="true" role="presentation"></div><div class="zd yy ze zf zg yw ed fk zh zi zj lq zk zl zm zn zo zp zq zr zs zt ac cv zu" aria-hidden="true"><div class="zv gy"></div></div></div></div><div data-focus-guard="true" tabindex="-1" style="width: 1px; height: 0px; padding: 0px; overflow: hidden; position: fixed; top: 1px; left: 1px;"></div><div class="gl gm gn go gp m"><div class="ac ci"><div class="cp bi gq gr gs gt"></div></div><article><div class="m"><div class="m"><span class="m"></span><section><div><div class="fw gz zw hb hc hd"></div><div class="he hf hg hh hi"><div class="ac ci"><div class="cp bi gq gr gs gt"><div><h1 id="7040" class="pw-post-title hj hk hl bg hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il bl" data-testid="storyTitle" data-selectable-paragraph="">Mimidrv In Depth: Exploring Mimikatz’s Kernel Driver</h1><div><div class="speechify-ignore ac cw"><div class="speechify-ignore bi m"><div class="ac im in io ip iq ir is it iu iv iw"><div class="ac r iw"><div class="ac ix"><div><div class="bn" aria-describedby="3" aria-labelledby="3" role="tooltip"><div tabindex="-1" class="bf"><a rel="noopener follow" href="https://medium.com/@matterpreter?source=post_page---byline--4d273d19e148---------------------------------------" data-discover="true"><div class="m iy iz by ja jb"><div class="m fr"><img alt="Matt Hand" class="m fk by bz ca de" width="32" height="32" loading="lazy" data-testid="authorPhoto" src="https://miro.medium.com/v2/resize:fill:32:32/2*HFgLEKa86-RKIOoc4CfbOA.png"><div class="jc by m bz ca fw o jd gk"></div></div></div></a></div></div></div></div><span class="bg b bh ab bl"><div class="je ac r"><div class="ac r jf"><div class="ac r"><div><div class="bn" aria-describedby="4" aria-labelledby="4" role="tooltip"><div tabindex="-1" class="bf"><span class="bg b bh ab bl"><a class="ah ai aj fo al am an ao ap aq ar as at jg" data-testid="authorName" rel="noopener follow" href="https://medium.com/@matterpreter?source=post_page---byline--4d273d19e148---------------------------------------" data-discover="true">Matt Hand</a></span></div></div></div></div><div class="jh ji m"><div class="ac jj"><div class="ac"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 16 16"><path fill="#437AFF" d="M15.163 8c0 .65-.459 1.144-.863 1.575-.232.244-.471.5-.563.719s-.086.543-.092.875c-.006.606-.018 1.3-.49 1.781-.47.481-1.15.494-1.744.5-.324.006-.655.013-.857.094s-.465.337-.704.575c-.422.412-.906.881-1.542.881-.637 0-1.12-.469-1.543-.881-.239-.238-.49-.482-.704-.575-.214-.094-.532-.088-.857-.094-.593-.006-1.273-.019-1.744-.5s-.484-1.175-.49-1.781c-.006-.332-.012-.669-.092-.875-.08-.207-.33-.475-.563-.719-.404-.431-.863-.925-.863-1.575s.46-1.144.863-1.575c.233-.244.472-.5.563-.719.092-.219.086-.544.092-.875.006-.606.019-1.3.49-1.781s1.15-.494 1.744-.5c.325-.006.655-.012.857-.094.202-.081.465-.337.704-.575C7.188 1.47 7.671 1 8.308 1s1.12.469 1.542.881c.239.238.49.481.704.575s.533.088.857.094c.594.006 1.273.019 1.745.5.47.481.483 1.175.49 1.781.005.331.011.669.091.875s.33.475.563.719c.404.431.863.925.863 1.575"></path><path fill="#fff" d="M7.328 10.5c.195 0 .381.08.519.22.137.141.215.331.216.53 0 .066.026.13.072.177a.24.24 0 0 0 .346 0 .25.25 0 0 0 .071-.177c.001-.199.079-.389.216-.53a.73.73 0 0 1 .519-.22h1.959c.13 0 .254-.053.346-.146a.5.5 0 0 0 .143-.354V6a.5.5 0 0 0-.143-.354.49.49 0 0 0-.346-.146h-1.47c-.324 0-.635.132-.865.366-.23.235-.359.552-.359.884v2.5c0 .066-.025.13-.071.177a.24.24 0 0 1-.346 0 .25.25 0 0 1-.072-.177v-2.5c0-.332-.13-.65-.359-.884A1.21 1.21 0 0 0 6.84 5.5h-1.47a.49.49 0 0 0-.346.146A.5.5 0 0 0 4.88 6v4c0 .133.051.26.143.354a.49.49 0 0 0 .347.146z"></path></svg></div></div></div><div class="jk bn"></div><button class="abq abv aq ac ci r abw abx aby" style="border: 1px solid rgba(8, 8, 8, 0.23);"><span class="bg b bh ab bl bi"><span class="bn abz">Follow</span></span></button></div></div></span></div><div class="ac r jl"><span class="bg b bh ab eb"><div class="ac ag"><span data-testid="storyReadTime">29 min read</span><div class="jm jn m" aria-hidden="true"><span class="m" aria-hidden="true"><span class="bg b bh ab eb">·</span></span></div><span data-testid="storyPublishDate">Jan 13, 2020</span></div></span></div></div><div class="ac cw jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd"><div class="i l x fp fq r"><div class="kt m"><div class="ac r ku kv"><div class="pw-multi-vote-icon fr kw kx ky kz"><span data-dd-action-name="Susi presentation tracker clap_footer"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerClapButton" rel="noopener follow" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2F4d273d19e148&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40matterpreter%2Fmimidrv-in-depth-4d273d19e148&amp;user=Matt+Hand&amp;userId=43fe4a5cc44&amp;source=---header_actions--4d273d19e148---------------------clap_footer------------------" data-discover="true"><div><div class="bn" aria-describedby="5" aria-labelledby="5" role="tooltip"><div tabindex="-1" class="bf"><div class="la aq lb lc ld le ao lf lg lh kz" role="presentation"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></div></div></div></a></span></div><div class="pw-multi-vote-count m li lj lk ll lm ln lo"><div><div class="bn" aria-describedby="73" aria-labelledby="73" role="tooltip"><div tabindex="-1" class="bf"><p class="bg b ec ab eb"><button class="ah ai aj fo al am an ao ap aq ar as at au av aca lw">128<span class="m i h g uz va"></span></button></p></div></div></div></div></div></div><div><div class="bn" aria-describedby="6" aria-labelledby="6" role="tooltip"><div tabindex="-1" class="bf"><button class="aq la lq lr ac r fs ls lt" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="lu"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"></path></svg></button></div></div></div></div><div class="ac r ke kf kg kh ki kj kk kl km kn ko kp kq kr ks"><div class="lv l k j e"></div><div class="i l"><div><div class="bn" aria-describedby="7" aria-labelledby="7" role="tooltip"><div tabindex="-1" class="bf"><span data-dd-action-name="Susi presentation tracker bookmark_footer"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerBookmarkButton" rel="noopener follow" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F4d273d19e148&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40matterpreter%2Fmimidrv-in-depth-4d273d19e148&amp;source=---header_actions--4d273d19e148---------------------bookmark_footer------------------" data-discover="true"><span class=""><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25" class="eb lw" aria-label="Add to list bookmark button"><path fill="currentColor" d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .805.396L12.5 17l5.695 4.396A.5.5 0 0 0 19 21v-8.5a.5.5 0 0 0-1 0v7.485l-5.195-4.012a.5.5 0 0 0-.61 0L7 19.985z"></path></svg></span></a></span></div></div></div></div><div class="fk lx cu"><div class="m ag"><div class="ac ci"><div class="ly lz ma mb mc md cp bi"><div class="ac"><span data-dd-action-name="Susi presentation tracker post_audio_button"><a class="ah ai aj fo al am an ao ap aq ar as at au av" rel="noopener follow" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2Fplans%3Fdimension%3Dpost_audio_button%26postId%3D4d273d19e148&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40matterpreter%2Fmimidrv-in-depth-4d273d19e148&amp;source=---header_actions--4d273d19e148---------------------post_audio_button------------------" data-discover="true"><div><div class="bn" aria-describedby="56" aria-labelledby="56" role="tooltip"><div tabindex="-1" class="bf"><button aria-label="Listen" data-testid="audioPlayButton" class="ah fs aj fo al am an me ap aq ar fe mf mg lt mh mi mj mk ml t mm mn mo mp mq mr ms v mt mu mv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"></path></svg><div class="k j e"><p class="bg b bh ab eb">Listen</p></div></button></div></div></div></a></span></div></div></div></div></div><div class="bn" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bn" aria-describedby="9" aria-labelledby="9" role="tooltip"><div tabindex="-1" class="bf"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="ah fs aj fo al am an me ap aq ar fe mf mg lt mh mi mj mk ml t mm mn mo mp mq mr ms v mt mu mv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"></path></svg><div class="k j e"><p class="bg b bh ab eb">Share</p></div></button></div></div></div></div></div></div></div></div></div></div><p id="fcd0" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Mimikatz provides the opportunity to leverage kernel mode functions through the included driver, Mimidrv. Mimidrv is a <a class="ah nu" href="https://twitter.com/gentilkiwi/status/1038700097557671936?lang=en" rel="noopener ugc nofollow" target="_blank">signed</a> Windows Driver Model (<a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/windows-driver-model" rel="noopener ugc nofollow" target="_blank">WDM</a>) kernel mode software driver meant to be used with the standard Mimikatz executable by prefixing relevant commands with an exclamation point (<code class="de nv nw nx ny b">!</code>). Mimidrv is undocumented and relatively underutilized, but provides a very interesting look into what we can do while operating at ring 0.</p><p id="a6dd" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">The goals of this post is to familiarize operators with the capability that Mimidrv provides, put forth some documentation to be used as a reference, introduce those who haven’t had much time working with the kernel to some core concepts, and provide defensive recommendations for mitigating driver-based threats.</p><h2 id="2d54" class="nz oa hl bg ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot ou ov ow bl" data-selectable-paragraph="">Why use Mimidrv?</h2><p id="9f40" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">Simply put, the kernel is king. There are some Windows functionalities available that can’t be called from user mode, such as modifying running processes’ attributes and interacting directly with other loaded drivers. As we will delve into a later in this post, the driver provides us with a method to call these functions via a user mode application.</p><h2 id="4832" class="nz oa hl bg ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot ou ov ow bl" data-selectable-paragraph="">Loading Mimidrv</h2><p id="e59b" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The first step in using Mimikatz’s driver is to issue the command <code class="de nv nw nx ny b">!+</code>. This command <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/kuhl_m_kernel.c#L56" rel="noopener ugc nofollow" target="_blank">implants and starts the driver from user mode</a> and requires that your current token has <code class="de nv nw nx ny b">SeLoadDriverPrivilege</code> assigned.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd pe"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*8z-vK9A3LIVkkLaK2kxifA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*8z-vK9A3LIVkkLaK2kxifA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*8z-vK9A3LIVkkLaK2kxifA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*8z-vK9A3LIVkkLaK2kxifA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*8z-vK9A3LIVkkLaK2kxifA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*8z-vK9A3LIVkkLaK2kxifA.png 1100w, https://miro.medium.com/v2/resize:fit:1190/format:webp/1*8z-vK9A3LIVkkLaK2kxifA.png 1190w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 595px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*8z-vK9A3LIVkkLaK2kxifA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*8z-vK9A3LIVkkLaK2kxifA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*8z-vK9A3LIVkkLaK2kxifA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*8z-vK9A3LIVkkLaK2kxifA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*8z-vK9A3LIVkkLaK2kxifA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*8z-vK9A3LIVkkLaK2kxifA.png 1100w, https://miro.medium.com/v2/resize:fit:1190/1*8z-vK9A3LIVkkLaK2kxifA.png 1190w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 595px"><img alt="" class="bi md pl c" width="595" height="201" loading="eager" role="presentation" src="https://miro.medium.com/v2/resize:fit:595/1*8z-vK9A3LIVkkLaK2kxifA.png"></picture></div></figure><p id="0932" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Mimikatz first checks if the driver exists in the current working directory, and if it finds the driver on disk, it begins <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/modules/kull_m_service.c#L138" rel="noopener ugc nofollow" target="_blank">creating the service</a>. Service creation is done via the <a class="ah nu" href="https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-openscmanagera" rel="noopener ugc nofollow" target="_blank">Service Control Manager (SCM) API</a> functions. Specifically, <code class="de nv nw nx ny b">advapi32!ServiceCreate</code> is used to register the service with the <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/modules/kull_m_service.c#L154" rel="noopener ugc nofollow" target="_blank">following attributes</a>:</p><figure class="pf pg ph pi pj pk"><div class="pm ga m fr"><div class="pn po m"><div src="https://medium.com/media/f2098d47b03743c7369054fc2a772c11" allowfullscreen="" frameborder="0" height="0" width="0" title="Mimidrv Service Creation" class="fw o gz ed bi" scrolling="no" data-original-tag="iframe"><title>Mimidrv Service Creation – Medium</title><base target="_blank"><link rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-8703547f549b05ef.css"><div id="gist100014956" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-mimidrv_svc-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="mimidrv_svc.c content, created by matterpreter on 03:56PM on December 12, 2019.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://medium.com/@matterpreter/mimidrv-in-depth-4d273d19e148" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="mimidrv_svc.c">
        <tbody><tr>
          <td id="file-mimidrv_svc-c-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-mimidrv_svc-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-en">CreateService</span>(</td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-mimidrv_svc-c-LC2" class="blob-code blob-code-inner js-file-line">              <span class="pl-s1">hSC</span>, <span class="pl-c">//Handle to the SCM database provided by OpenSCManager</span></td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-mimidrv_svc-c-LC3" class="blob-code blob-code-inner js-file-line">              <span class="pl-c1">'mimidrv'</span>, <span class="pl-c">//Service name</span></td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-mimidrv_svc-c-LC4" class="blob-code blob-code-inner js-file-line">              <span class="pl-c1">'mimikatz driver (mimidrv)'</span>, <span class="pl-c">//Service display name </span></td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-mimidrv_svc-c-LC5" class="blob-code blob-code-inner js-file-line">              <span class="pl-c1">READ_CONTROL</span> | <span class="pl-c1">WRITE_DAC</span> | <span class="pl-c1">SERVICE_START</span>,  <span class="pl-c">//Desired access</span></td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-mimidrv_svc-c-LC6" class="blob-code blob-code-inner js-file-line">              <span class="pl-c1">SERVICE_KERNEL_DRIVER</span>,  <span class="pl-c">//Kernel driver service type</span></td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-mimidrv_svc-c-LC7" class="blob-code blob-code-inner js-file-line">              <span class="pl-c1">SERVICE_AUTO_START</span>, <span class="pl-c">//Start the service automatically on boot </span></td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L8" class="blob-num js-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-mimidrv_svc-c-LC8" class="blob-code blob-code-inner js-file-line">              <span class="pl-c1">SERVICE_ERROR_NORMAL</span>, <span class="pl-c">//Log driver errors that occur during startup to the event log</span></td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L9" class="blob-num js-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-mimidrv_svc-c-LC9" class="blob-code blob-code-inner js-file-line">              <span class="pl-c1">'C:\\path\\to\\mimidrv.sys'</span>, <span class="pl-c">//Absolute path of the driver on disk  </span></td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L10" class="blob-num js-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-mimidrv_svc-c-LC10" class="blob-code blob-code-inner js-file-line">              <span class="pl-c1">NULL</span>,  <span class="pl-c">//Load order group (unused)</span></td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L11" class="blob-num js-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-mimidrv_svc-c-LC11" class="blob-code blob-code-inner js-file-line">              <span class="pl-c1">NULL</span>,  <span class="pl-c">//Not used because the previous argument is NULL </span></td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L12" class="blob-num js-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-mimidrv_svc-c-LC12" class="blob-code blob-code-inner js-file-line">              <span class="pl-c1">NULL</span>,  <span class="pl-c">//No dependencies for the driver</span></td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L13" class="blob-num js-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-mimidrv_svc-c-LC13" class="blob-code blob-code-inner js-file-line">              <span class="pl-c1">NULL</span>,  <span class="pl-c">//Use NT AUTHORITY\SYSTEM to start the service</span></td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L14" class="blob-num js-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-mimidrv_svc-c-LC14" class="blob-code blob-code-inner js-file-line">              <span class="pl-c1">NULL</span>   <span class="pl-c">//Unused because we are using the SYSTEM account</span></td>
        </tr>
        <tr>
          <td id="file-mimidrv_svc-c-L15" class="blob-num js-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-mimidrv_svc-c-LC15" class="blob-code blob-code-inner js-file-line">);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/matterpreter/78044c7fcf20964839136043f61c8c76/raw/46040e4c1616c2c9f94b53a9bf31aaa70feac9b5/mimidrv_svc.c" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/matterpreter/78044c7fcf20964839136043f61c8c76#file-mimidrv_svc-c" class="Link--inTextBlock">
          mimidrv_svc.c
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></div></div></figure><p id="71be" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">If the service is created successfully, the <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/modules/kull_m_service.c#L103" rel="noopener ugc nofollow" target="_blank">“Everyone” group is granted access to the service</a>, allowing any user on the system to interact with the service. For example, a low-privilege user can stop the service.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd pp"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*OgQs14JOMqwXJ3VNVg1Rig.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*OgQs14JOMqwXJ3VNVg1Rig.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*OgQs14JOMqwXJ3VNVg1Rig.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*OgQs14JOMqwXJ3VNVg1Rig.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*OgQs14JOMqwXJ3VNVg1Rig.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*OgQs14JOMqwXJ3VNVg1Rig.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OgQs14JOMqwXJ3VNVg1Rig.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*OgQs14JOMqwXJ3VNVg1Rig.png 640w, https://miro.medium.com/v2/resize:fit:720/1*OgQs14JOMqwXJ3VNVg1Rig.png 720w, https://miro.medium.com/v2/resize:fit:750/1*OgQs14JOMqwXJ3VNVg1Rig.png 750w, https://miro.medium.com/v2/resize:fit:786/1*OgQs14JOMqwXJ3VNVg1Rig.png 786w, https://miro.medium.com/v2/resize:fit:828/1*OgQs14JOMqwXJ3VNVg1Rig.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*OgQs14JOMqwXJ3VNVg1Rig.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*OgQs14JOMqwXJ3VNVg1Rig.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="330" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*OgQs14JOMqwXJ3VNVg1Rig.png"></picture></div></div></figure><blockquote class="pu pv pw"><p id="de92" class="mw mx px my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph=""><strong class="my hm">Note:</strong> This is one of the reasons that post-op clean up is so important. Don’t forget to remove the driver (<code class="de nv nw nx ny b">!-</code>) when you are done so that you don’t leave it implanted for someone else to use.</p></blockquote><p id="b994" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">If that completes successfully, the service is finally started with <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/modules/kull_m_service.c#L169" rel="noopener ugc nofollow" target="_blank">a call to </a><code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/modules/kull_m_service.c#L169" rel="noopener ugc nofollow" target="_blank">StartService</a></code>.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd py"><picture><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*9TFAU2JQ_38YeyXN 640w, https://miro.medium.com/v2/resize:fit:720/0*9TFAU2JQ_38YeyXN 720w, https://miro.medium.com/v2/resize:fit:750/0*9TFAU2JQ_38YeyXN 750w, https://miro.medium.com/v2/resize:fit:786/0*9TFAU2JQ_38YeyXN 786w, https://miro.medium.com/v2/resize:fit:828/0*9TFAU2JQ_38YeyXN 828w, https://miro.medium.com/v2/resize:fit:1100/0*9TFAU2JQ_38YeyXN 1100w, https://miro.medium.com/v2/resize:fit:1298/0*9TFAU2JQ_38YeyXN 1298w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 649px"><img alt="" class="bi md pl c" width="649" height="254" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:649/0*9TFAU2JQ_38YeyXN"></picture></div></figure><h2 id="16b3" class="nz oa hl bg ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot ou ov ow bl" data-selectable-paragraph="">Post-Load Actions</h2><p id="58c2" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">Once the service starts, it is Mimidrv’s turn to complete its setup. The driver does not do anything atypical during its startup process, but it may seem complicated you haven’t <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/writing-wdm-drivers" rel="noopener ugc nofollow" target="_blank">developed WDM drivers</a> before.</p><p id="e312" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Every driver must have a defined <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/wdf/driverentry-for-kmdf-drivers" rel="noopener ugc nofollow" target="_blank">DriverEntry</a></code> function that is called as soon as the driver is loaded and is used to set up the requirements for the driver to run. You can think of this similarly to a <code class="de nv nw nx ny b">main()</code> function in user mode code. In Mimidrv’s <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/fa42ed93aa4d5aa73825295e2ab757ac96005581/mimidrv/mimidrv.c#L22" rel="noopener ugc nofollow" target="_blank">DriverEntry</a></code> function, there are four main things that happen.</p><h3 id="185e" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">1. Create the Device Object</h3><p id="d523" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">Clients do not talk directly to drivers, but rather <a class="ah nu" href="https://googleprojectzero.blogspot.com/2015/10/windows-drivers-are-truely-tricky.html" rel="noopener ugc nofollow" target="_blank">device objects</a>. Kernel mode drivers must create at least 1 device object, however this device object still can’t be accessed directly by user mode code without a symbolic link. We’ll cover the symbolic link a little later, but the creation of the device object must occur first.</p><p id="356f" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">To create the device object, a <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/mimidrv.c#L30" rel="noopener ugc nofollow" target="_blank">call to </a><code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/mimidrv.c#L30" rel="noopener ugc nofollow" target="_blank">nt!IoCreateDevice</a></code> is made with some important details. Most notable of this is the third parameter, <code class="de nv nw nx ny b">DeviceName</code>. This is set in <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/globals.h#L16" rel="noopener ugc nofollow" target="_blank">globals.h</a></code> as “mimidrv”.</p><p id="4943" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">This newly created device object can be seen with <a class="ah nu" href="https://docs.microsoft.com/en-us/sysinternals/downloads/winobj" rel="noopener ugc nofollow" target="_blank">WinObj</a>.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd qo"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*4HMuZKx6Lmya_x0Pous0uQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*4HMuZKx6Lmya_x0Pous0uQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*4HMuZKx6Lmya_x0Pous0uQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*4HMuZKx6Lmya_x0Pous0uQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*4HMuZKx6Lmya_x0Pous0uQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*4HMuZKx6Lmya_x0Pous0uQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4HMuZKx6Lmya_x0Pous0uQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*4HMuZKx6Lmya_x0Pous0uQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*4HMuZKx6Lmya_x0Pous0uQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*4HMuZKx6Lmya_x0Pous0uQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*4HMuZKx6Lmya_x0Pous0uQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*4HMuZKx6Lmya_x0Pous0uQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*4HMuZKx6Lmya_x0Pous0uQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*4HMuZKx6Lmya_x0Pous0uQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="370" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*4HMuZKx6Lmya_x0Pous0uQ.png"></picture></div></div></figure><h3 id="3305" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">2. Set the <em class="qp">DispatchDeviceControl</em> and Unload Functions</h3><p id="3b85" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">If that device object creation succeeds, it defines its <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_dispatch" rel="noopener ugc nofollow" target="_blank">DispatchDeviceControl </a></code><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_dispatch" rel="noopener ugc nofollow" target="_blank">function</a>, registered at the <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/irp-mj-device-control" rel="noopener ugc nofollow" target="_blank">IRP_MJ_DEVICE_CONTRO</a>L</code> index in its <code class="de nv nw nx ny b">MajorFunction</code> dispatch table, as the <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/mimidrv.c#L61" rel="noopener ugc nofollow" target="_blank">MimiDispatchDeviceControl</a></code> function. What this means is that any time it receives a <code class="de nv nw nx ny b">IRP_MJ_DEVICE_CONTROL</code> request, such as from <code class="de nv nw nx ny b">kernel32!DeviceIoControl</code>, Mimidrv will call its internal <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/mimidrv.c#L61" rel="noopener ugc nofollow" target="_blank">MimiDispatchDeviceControl</a></code> function which will process the request. We will cover how this works in the “<em class="px">User Mode Interaction via MimiDispatchDeviceControl</em>” section.</p><p id="d7ea" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Just as every driver must specify a <code class="de nv nw nx ny b">DriveryEntry</code> function, it must define a corresponding <code class="de nv nw nx ny b">Unload</code> function that is executed when the driver is unloaded. Mimidrv’s <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/mimidrv.c#L16" rel="noopener ugc nofollow" target="_blank">DriverUnload</a></code><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/mimidrv.c#L16" rel="noopener ugc nofollow" target="_blank"> function</a> is about as simple as it gets and its only job is to delete the symbolic link and then device object.</p><h3 id="80a0" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">3. Create the Symbolic Link</h3><p id="9ba9" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">As mentioned earlier, if a driver wants to allow user mode code to interact with it, it must create a symbolic link. This symbolic link will be used by user mode applications, such as through calls to <code class="de nv nw nx ny b">nt!CreateFile</code> and <code class="de nv nw nx ny b">kernel32!DeviceIoControl</code>, in place of a “normal” file to send data to and receive data from the driver.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd qq"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*j3-rmPCm_xSMmCuHIdoXqQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*j3-rmPCm_xSMmCuHIdoXqQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*j3-rmPCm_xSMmCuHIdoXqQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*j3-rmPCm_xSMmCuHIdoXqQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*j3-rmPCm_xSMmCuHIdoXqQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*j3-rmPCm_xSMmCuHIdoXqQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j3-rmPCm_xSMmCuHIdoXqQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*j3-rmPCm_xSMmCuHIdoXqQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*j3-rmPCm_xSMmCuHIdoXqQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*j3-rmPCm_xSMmCuHIdoXqQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*j3-rmPCm_xSMmCuHIdoXqQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*j3-rmPCm_xSMmCuHIdoXqQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*j3-rmPCm_xSMmCuHIdoXqQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*j3-rmPCm_xSMmCuHIdoXqQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="107" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*j3-rmPCm_xSMmCuHIdoXqQ.png"></picture></div></div></figure><p id="37ce" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">To create the symbolic link, Mimidrv makes a call to <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-iocreatesymboliclink" rel="noopener ugc nofollow" target="_blank">nt!IoCreateSymbolicLink</a></code> with the <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/mimidrv.c#L9" rel="noopener ugc nofollow" target="_blank">name of the symbolic link</a> and the device object as arguments. The newly created device object and associated symlink can be seen in WinObj:</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd qr"><picture><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*2l5HBJiXxEiktrte 640w, https://miro.medium.com/v2/resize:fit:720/0*2l5HBJiXxEiktrte 720w, https://miro.medium.com/v2/resize:fit:750/0*2l5HBJiXxEiktrte 750w, https://miro.medium.com/v2/resize:fit:786/0*2l5HBJiXxEiktrte 786w, https://miro.medium.com/v2/resize:fit:828/0*2l5HBJiXxEiktrte 828w, https://miro.medium.com/v2/resize:fit:1100/0*2l5HBJiXxEiktrte 1100w, https://miro.medium.com/v2/resize:fit:1400/0*2l5HBJiXxEiktrte 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="441" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/0*2l5HBJiXxEiktrte"></picture></div></div></figure><h3 id="5bbc" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">4. Initialize Aux_klib</h3><p id="16ff" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">Finally, it initializes the <code class="de nv nw nx ny b">Aux_klib</code> library using <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows/win32/devnotes/auxklibinitialize-func" rel="noopener ugc nofollow" target="_blank">AuxKlibInitialize</a></code>, which must be done before being able to call any function in that library (more on that in the “<em class="px">Modules</em>” section).</p><h2 id="feba" class="nz oa hl bg ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot ou ov ow bl" data-selectable-paragraph="">User Mode Interaction via MimiDispatchDeviceControl</h2><p id="0585" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">After initialization, a driver’s job is simply to handle requests to it. It does this through a partially opaque feature called <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/i-o-request-packets" rel="noopener ugc nofollow" target="_blank">I/O request packets (IRPs)</a>.These IRPs contain I/O Control Codes (IOCTLs) which are mapped to function codes. These typically start at <code class="de nv nw nx ny b">0x8000</code>, but Mimikatz starts at <code class="de nv nw nx ny b">0x000</code>, against <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/defining-i-o-control-codes" rel="noopener ugc nofollow" target="_blank">Microsoft’s recommendation</a>. Mimikatz currently defines 23 IOCTLs in <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/ioctl.h" rel="noopener ugc nofollow" target="_blank">ioctl.h</a></code>. Each one of these IOCTLs is <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/mimidrv.c#L79" rel="noopener ugc nofollow" target="_blank">mapped to a function</a>. When Mimidrv receives one of these 23 defined IOCTLs, it calls the mapped function. This is where the core functionality of Mimidrv lies.</p><h3 id="58ce" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">Sending IRPs</h3><p id="6ee3" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">In order to get the driver to execute one of the functions mapped to the IOCTLs, we have to send an IRP from user mode via the symbolic link created earlier. Mimikatz handles this in the <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimikatz/modules/kuhl_m_kernel.c#L30" rel="noopener ugc nofollow" target="_blank">kuhl_m_kernel_do</a></code> function, which trickles down to a <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/modules/kull_m_kernel.c#L48" rel="noopener ugc nofollow" target="_blank">call to </a><code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/modules/kull_m_kernel.c#L48" rel="noopener ugc nofollow" target="_blank">nt!CreateFile</a></code> to get a handle on the device object and <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/modules/kull_m_kernel.c#L21" rel="noopener ugc nofollow" target="_blank">kernel32!DeviceIoControl</a></code><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/modules/kull_m_kernel.c#L21" rel="noopener ugc nofollow" target="_blank"> to sent the IRP</a>. This hits the <code class="de nv nw nx ny b">IRP_MJ_DEVICE_CONTROL</code> major function, which was defined as <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/mimidrv.c#L61" rel="noopener ugc nofollow" target="_blank">MimiDispatchDeviceControl</a></code>, and walks down the list of internally defined functions by their IOCTL codes. When a command is entered with the prefix “<code class="de nv nw nx ny b">!</code>”, it checks the <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimikatz/modules/kuhl_m_kernel.c#L8" rel="noopener ugc nofollow" target="_blank">KUHL_K_C</a></code><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimikatz/modules/kuhl_m_kernel.c#L8" rel="noopener ugc nofollow" target="_blank"> structure, </a><code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimikatz/modules/kuhl_m_kernel.c#L8" rel="noopener ugc nofollow" target="_blank">kuhl_k_c_kernel</a></code>, to get the IOCTL associated with the command. The structure is defined as:</p><figure class="pf pg ph pi pj pk"><div class="pm ga m fr"><div class="pn po m"><div src="https://medium.com/media/fffdb3f048044bd980ae9da29261ffb5" allowfullscreen="" frameborder="0" height="0" width="0" title="Mimikatz KUHL_K_C Structure" class="fw o gz ed bi" scrolling="no" data-original-tag="iframe"><title>Mimikatz KUHL_K_C Structure – Medium</title><base target="_blank"><link rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-8703547f549b05ef.css"><div id="gist99900339" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-kuhl_k_c-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="kuhl_k_c.c content, created by matterpreter on 03:48PM on December 06, 2019.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://medium.com/@matterpreter/mimidrv-in-depth-4d273d19e148" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="kuhl_k_c.c">
        <tbody><tr>
          <td id="file-kuhl_k_c-c-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-kuhl_k_c-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> <span class="pl-smi">_KUHL_K_C</span> {</td>
        </tr>
        <tr>
          <td id="file-kuhl_k_c-c-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-kuhl_k_c-c-LC2" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">const</span> <span class="pl-smi">PKUHL_M_C_FUNC</span> <span class="pl-c1">pCommand</span>;</td>
        </tr>
        <tr>
          <td id="file-kuhl_k_c-c-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-kuhl_k_c-c-LC3" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">const</span> <span class="pl-smi">DWORD</span> <span class="pl-c1">ioctlCode</span>;</td>
        </tr>
        <tr>
          <td id="file-kuhl_k_c-c-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-kuhl_k_c-c-LC4" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">const</span> <span class="pl-smi">wchar_t</span> <span class="pl-c1">*</span> <span class="pl-c1">command</span>;</td>
        </tr>
        <tr>
          <td id="file-kuhl_k_c-c-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-kuhl_k_c-c-LC5" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">const</span> <span class="pl-smi">wchar_t</span> <span class="pl-c1">*</span> <span class="pl-c1">description</span>;</td>
        </tr>
        <tr>
          <td id="file-kuhl_k_c-c-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-kuhl_k_c-c-LC6" class="blob-code blob-code-inner js-file-line">} <span class="pl-smi">KUHL_K_C</span>, <span class="pl-c1">*</span><span class="pl-smi">PKUHL_K_C</span>;</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/matterpreter/3a2b92b5fedc4d4df75566fc3489caf9/raw/425ffa3c7eac8f92244bfcfaa075f0755c201567/kuhl_k_c.c" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/matterpreter/3a2b92b5fedc4d4df75566fc3489caf9#file-kuhl_k_c-c" class="Link--inTextBlock">
          kuhl_k_c.c
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></div></div></figure><p id="da88" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">In the struct, 19 commands are defined as:</p><figure class="pf pg ph pi pj pk"><div class="pm ga m fr"><div class="pn po m"><div src="https://medium.com/media/d0b89d5799b623012136ee133cf45207" allowfullscreen="" frameborder="0" height="0" width="0" title="Mimidrv User Functions" class="fw o gz ed bi" scrolling="no" data-original-tag="iframe"><title>Mimidrv User Functions – Medium</title><base target="_blank"><link rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-8703547f549b05ef.css"><div id="gist99900276" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-mimidrvfunctions-csv" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-csv  " style="overflow: auto" tabindex="0" role="region" aria-label="MimidrvFunctions.csv content, created by matterpreter on 03:45PM on December 06, 2019.">

        <div class="blob-interaction-bar">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-search">
    <path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7Z"></path>
</svg>
  <input type="text" name="filter" class="form-control js-csv-filter-field blob-filter" autocapitalize="off" placeholder="Search this file…" aria-label="Search this file…">
</div>

  <div class="markdown-body js-check-hidden-unicode" data-line-alert="before" data-hpc="">
    
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://medium.com/@matterpreter/mimidrv-in-depth-4d273d19e148" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

    <table class="js-csv-data csv-data js-file-line-container">
      <thead>
        <tr id="file-mimidrvfunctions-csv-LC1" class="js-file-line">
          <td id="file-mimidrvfunctions-csv-L1" class="blob-num js-line-number" data-line-number="1"></td>
            <th>Function</th>
            <th>IOCTL</th>
            <th>Command</th>
            <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr id="file-mimidrvfunctions-csv-LC2" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L2" class="blob-num js-line-number" data-line-number="2"></td>
              <td>kuhl_m_kernel_add_mimidrv</td>
              <td>N/A</td>
              <td>+</td>
              <td>Install and/or start mimikatz driver (mimidrv)</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC3" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L3" class="blob-num js-line-number" data-line-number="3"></td>
              <td>kuhl_m_kernel_remove_mimidrv</td>
              <td>N/A</td>
              <td>-</td>
              <td>Remove mimikatz driver (mimidrv)</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC4" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L4" class="blob-num js-line-number" data-line-number="4"></td>
              <td>N/A</td>
              <td>IOCTL_MIMIDRV_PING</td>
              <td>ping</td>
              <td>Ping the driver</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC5" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L5" class="blob-num js-line-number" data-line-number="5"></td>
              <td>N/A</td>
              <td>IOCTL_MIMIDRV_BSOD</td>
              <td>bsod</td>
              <td>BSOD !</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC6" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L6" class="blob-num js-line-number" data-line-number="6"></td>
              <td>N/A</td>
              <td>IOCTL_MIMIDRV_PROCESS_LIST</td>
              <td>process</td>
              <td>List process</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC7" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L7" class="blob-num js-line-number" data-line-number="7"></td>
              <td>kuhl_m_kernel_processProtect</td>
              <td>N/A</td>
              <td>processProtect</td>
              <td>Protect process</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC8" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L8" class="blob-num js-line-number" data-line-number="8"></td>
              <td>kuhl_m_kernel_processToken</td>
              <td>N/A</td>
              <td>processToken</td>
              <td>Duplicate process token</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC9" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L9" class="blob-num js-line-number" data-line-number="9"></td>
              <td>kuhl_m_kernel_processPrivilege</td>
              <td>N/A</td>
              <td>processPrivilege</td>
              <td>Set all privilege on process</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC10" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L10" class="blob-num js-line-number" data-line-number="10"></td>
              <td>N/A</td>
              <td>IOCTL_MIMIDRV_MODULE_LIST</td>
              <td>modules</td>
              <td>List modules</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC11" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L11" class="blob-num js-line-number" data-line-number="11"></td>
              <td>N/A</td>
              <td>IOCTL_MIMIDRV_SSDT_LIST</td>
              <td>ssdt</td>
              <td>List SSDT</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC12" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L12" class="blob-num js-line-number" data-line-number="12"></td>
              <td>N/A</td>
              <td>IOCTL_MIMIDRV_NOTIFY_PROCESS_LIST</td>
              <td>notifProcess</td>
              <td>List process notify callbacks</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC13" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L13" class="blob-num js-line-number" data-line-number="13"></td>
              <td>N/A</td>
              <td>IOCTL_MIMIDRV_NOTIFY_THREAD_LIST</td>
              <td>notifThread</td>
              <td>List thread notify callbacks</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC14" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L14" class="blob-num js-line-number" data-line-number="14"></td>
              <td>N/A</td>
              <td>IOCTL_MIMIDRV_NOTIFY_IMAGE_LIST</td>
              <td>notifImage</td>
              <td>List image notify callbacks</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC15" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L15" class="blob-num js-line-number" data-line-number="15"></td>
              <td>N/A</td>
              <td>IOCTL_MIMIDRV_NOTIFY_REG_LIST</td>
              <td>notifReg</td>
              <td>List registry notify callbacks</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC16" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L16" class="blob-num js-line-number" data-line-number="16"></td>
              <td>N/A</td>
              <td>IOCTL_MIMIDRV_NOTIFY_OBJECT_LIST</td>
              <td>notifObject</td>
              <td>List object notify callbacks</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC17" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L17" class="blob-num js-line-number" data-line-number="17"></td>
              <td>N/A</td>
              <td>IOCTL_MIMIDRV_FILTER_LIST</td>
              <td>filters</td>
              <td>List FS filters</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC18" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L18" class="blob-num js-line-number" data-line-number="18"></td>
              <td>N/A</td>
              <td>IOCTL_MIMIDRV_MINIFILTER_LIST</td>
              <td>minifilters</td>
              <td>List minifilters</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC19" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L19" class="blob-num js-line-number" data-line-number="19"></td>
              <td>kuhl_m_kernel_sysenv_set</td>
              <td>N/A</td>
              <td>sysenvset</td>
              <td>System Environment Variable Set</td>
          </tr>
          <tr id="file-mimidrvfunctions-csv-LC20" class="js-file-line">
            <td id="file-mimidrvfunctions-csv-L20" class="blob-num js-line-number" data-line-number="20"></td>
              <td>kuhl_m_kernel_sysenv_del</td>
              <td>N/A</td>
              <td>sysenvde</td>
              <td>System Environment Variable Delete</td>
          </tr>
      </tbody>
    </table>
  </div>

    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/matterpreter/010d22a978217d7ecc53ae9b876477fd/raw/2da7a2e693d4a8502dd79efea0dfb0b84fdbb060/MimidrvFunctions.csv" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/matterpreter/010d22a978217d7ecc53ae9b876477fd#file-mimidrvfunctions-csv" class="Link--inTextBlock">
          MimidrvFunctions.csv
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></div></div></figure><p id="f2ec" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Despite there being 23 IOCTLs, there are only 19 commands available via Mimikatz. This is because 4 of the functions related to interacting with virtual memory are not mapped to commands. The IOCTLs and associated functions are:</p><ul class=""><li id="8186" class="mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt qs qt qu bl" data-selectable-paragraph=""><code class="de nv nw nx ny b">IOCTL_MIMIDRV_VM_READ</code>→<code class="de nv nw nx ny b">kkll_m_memory_vm_read</code></li><li id="6b6a" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph=""><code class="de nv nw nx ny b">IOCTL_MIMIDRV_VM_WRITE</code>→<code class="de nv nw nx ny b">kkll_m_memory_vm_write</code></li><li id="4fe7" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph=""><code class="de nv nw nx ny b">IOCTL_MIMIDRV_VM_ALLOC</code>→<code class="de nv nw nx ny b">kkll_m_memory_vm_alloc</code></li><li id="6cf4" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph=""><code class="de nv nw nx ny b">IOCTL_MIMIDRV_VM_FREE</code>→<code class="de nv nw nx ny b">kkll_m_memory_vm_free</code></li></ul></div></div></div><div class="ac ci ra rb rc rd" role="separator"><span class="re by bn rf rg rh"></span><span class="re by bn rf rg rh"></span><span class="re by bn rf rg"></span></div><div class="he hf hg hh hi"><div class="ac ci"><div class="cp bi gq gr gs gt"><h2 id="7ec7" class="nz oa hl bg ob oc ri oe of og rj oi oj ok rk om on oo rl oq or os rm ou ov ow bl" data-selectable-paragraph="">Driver Function Internals</h2><p id="eb73" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The commands can be broken down into 7 groups— General, Process, Notify, Modules, Filters, Memory, and SSDT. These are, for the most part (minus the General functions), logically organized in the Mimidrv source code with file name format <code class="de nv nw nx ny b">kkll_m_&lt;group&gt;.c</code>.</p><h2 id="38d6" class="nz oa hl bg ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot ou ov ow bl" data-selectable-paragraph="">General</h2><h3 id="9343" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!ping</h3><p id="d4e9" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The <code class="de nv nw nx ny b">ping</code> command can be used to test the ability to write data to and receive data from Mimidrv. This is done through Benjamin’s <code class="de nv nw nx ny b">kprintf</code> function, which is really just a <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/68ac65b426d1b9e1354dd0365676b1ead15022de/mimidrv/globals.h#L18" rel="noopener ugc nofollow" target="_blank">simplified call to </a><code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/68ac65b426d1b9e1354dd0365676b1ead15022de/mimidrv/globals.h#L18" rel="noopener ugc nofollow" target="_blank">nt!RtlStringCbPrintfExW</a></code> which allows the use of the <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/68ac65b426d1b9e1354dd0365676b1ead15022de/mimidrv/globals.h#L24" rel="noopener ugc nofollow" target="_blank">KIWI_BUFFER</a></code> structure to keep the code tidy.</p><h3 id="4673" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!bsod</h3><p id="22c2" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">As alluded to by the name, this functionality bluescreens the box. This is done via a call to <code class="de nv nw nx ny b">KeBugCheck</code> with a <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/bug-check-0xdeaddead--manually-initiated-crash1" rel="noopener ugc nofollow" target="_blank">bugcheck code</a> of <code class="de nv nw nx ny b">MANUALLY_INITIATED_CRASH</code>, which will be shown on the bluescreen under the “stop code”.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd rn"><picture><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*IxaRPEICeft5RP4z 640w, https://miro.medium.com/v2/resize:fit:720/0*IxaRPEICeft5RP4z 720w, https://miro.medium.com/v2/resize:fit:750/0*IxaRPEICeft5RP4z 750w, https://miro.medium.com/v2/resize:fit:786/0*IxaRPEICeft5RP4z 786w, https://miro.medium.com/v2/resize:fit:828/0*IxaRPEICeft5RP4z 828w, https://miro.medium.com/v2/resize:fit:1100/0*IxaRPEICeft5RP4z 1100w, https://miro.medium.com/v2/resize:fit:1400/0*IxaRPEICeft5RP4z 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="401" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/0*IxaRPEICeft5RP4z"></picture></div></div></figure><h3 id="708f" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!sysenvset &amp; !sysenvdel</h3><p id="5fdb" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The <code class="de nv nw nx ny b">!sysenvset</code> command sets a system environment variable, but not in the traditional sense (e.g. modifying <code class="de nv nw nx ny b">%PATH%</code>). Instead, on systems configured with Secure Boot, it modifies a <a class="ah nu" href="http://www.alex-ionescu.com/?p=97" rel="noopener ugc nofollow" target="_blank">variable in the UEFI firmware store</a>, specifically <code class="de nv nw nx ny b">Kernel_Lsa_Ppl_Config</code>, which is associated with the <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection" rel="noopener ugc nofollow" target="_blank">RunAsPPL</a></code> value in the registry. The GUID that it writes this value to, <code class="de nv nw nx ny b">77fa9abd-0359–4d32-bd60–28f4e78f784b</code>, is the Protected Store which Windows can use to store values that it wants to protect from user and admin modification. This effectively overrides the registry, so even if you were to modify the <code class="de nv nw nx ny b">RunAsPPL</code> key and reboot, LSASS would still be protected.</p><p id="cfee" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">The <code class="de nv nw nx ny b">!sysenvdel</code> does the opposite and removes this environment variable. The <code class="de nv nw nx ny b">RunAsPPL</code> registry key could then be deleted, the system rebooted, and then we could get a handle on LSASS.</p></div></div></div><div class="ac ci ra rb rc rd" role="separator"><span class="re by bn rf rg rh"></span><span class="re by bn rf rg rh"></span><span class="re by bn rf rg"></span></div><div class="he hf hg hh hi"><div class="ac ci"><div class="cp bi gq gr gs gt"><h2 id="20e0" class="nz oa hl bg ob oc ri oe of og rj oi oj ok rk om on oo rl oq or os rm ou ov ow bl" data-selectable-paragraph="">Process</h2><p id="f13f" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The first group of modules we’ll really dig into is the Process group, which allows for interaction and modification of user mode processes. Because we will be working with processes in this section, it is important to understand what they look like from the kernel’s perspective. Processes in the kernel center around the <code class="de nv nw nx ny b">EPROCESS</code> structure, an opaque structure that serves as the object for a process. Inside of the structure are all of the attributes of a process that we are familiar with, such as the process ID, token information, and process environment block (PEB).</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd ro"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*MjxbQP8e31aNysb1Fnk1vg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*MjxbQP8e31aNysb1Fnk1vg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*MjxbQP8e31aNysb1Fnk1vg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*MjxbQP8e31aNysb1Fnk1vg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*MjxbQP8e31aNysb1Fnk1vg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*MjxbQP8e31aNysb1Fnk1vg.png 1100w, https://miro.medium.com/v2/resize:fit:726/format:webp/1*MjxbQP8e31aNysb1Fnk1vg.png 726w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 363px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*MjxbQP8e31aNysb1Fnk1vg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*MjxbQP8e31aNysb1Fnk1vg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*MjxbQP8e31aNysb1Fnk1vg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*MjxbQP8e31aNysb1Fnk1vg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*MjxbQP8e31aNysb1Fnk1vg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*MjxbQP8e31aNysb1Fnk1vg.png 1100w, https://miro.medium.com/v2/resize:fit:726/1*MjxbQP8e31aNysb1Fnk1vg.png 726w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 363px"><img alt="" class="bi md pl c" width="363" height="167" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:363/1*MjxbQP8e31aNysb1Fnk1vg.png"></picture></div></figure><p id="8e2e" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph=""><code class="de nv nw nx ny b">EPROCESS</code> structures in the kernel are connected through a circular doubly-linked list. The list head is stored in the kernel variable <code class="de nv nw nx ny b">PsActiveProcessHead</code> and is used as the “beginning” of the list. Each <code class="de nv nw nx ny b">EPROCESS</code> structure contains a member, <code class="de nv nw nx ny b">ActiveProcessLinks</code>, of the type <code class="de nv nw nx ny b">LIST_ENTRY</code>. The <code class="de nv nw nx ny b">LIST_ENTRY</code> structure has 2 components — a forward link (<code class="de nv nw nx ny b">Flink</code>) and a backward link (<code class="de nv nw nx ny b">Blink</code>). The <code class="de nv nw nx ny b">Flink</code> points to the <code class="de nv nw nx ny b">Flink</code> of the next <code class="de nv nw nx ny b">EPROCESS</code> structure in the list. The <code class="de nv nw nx ny b">Blink</code> points to the <code class="de nv nw nx ny b">Flink</code> of the previous <code class="de nv nw nx ny b">EPROCESS</code> structure in the list. The <code class="de nv nw nx ny b">Flink</code> of the last structure in the list points to the <code class="de nv nw nx ny b">Flink</code> of <code class="de nv nw nx ny b">PsActiveProcessHead</code>. This creates a loop of <code class="de nv nw nx ny b">EPROCESS</code> structures and is represented in this simplified graphic.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd rp"><picture><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*FKQsDx7iyDo06nme 640w, https://miro.medium.com/v2/resize:fit:720/0*FKQsDx7iyDo06nme 720w, https://miro.medium.com/v2/resize:fit:750/0*FKQsDx7iyDo06nme 750w, https://miro.medium.com/v2/resize:fit:786/0*FKQsDx7iyDo06nme 786w, https://miro.medium.com/v2/resize:fit:828/0*FKQsDx7iyDo06nme 828w, https://miro.medium.com/v2/resize:fit:1100/0*FKQsDx7iyDo06nme 1100w, https://miro.medium.com/v2/resize:fit:1400/0*FKQsDx7iyDo06nme 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="264" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/0*FKQsDx7iyDo06nme"></picture></div></div></figure><h3 id="ad73" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!process</h3><p id="e88d" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The first module gives us a list of processes running on the system, along with some additional information about them. This works by walking the linked list described earlier using 2 Windows version-specific offsets — <code class="de nv nw nx ny b">EprocessNext</code> and <code class="de nv nw nx ny b">EprocessFlags2</code>. <code class="de nv nw nx ny b">EprocessNext</code> is the offset in the current <code class="de nv nw nx ny b">EPROCESS</code> structure containing the address of the <code class="de nv nw nx ny b">ActiveProcessLinks</code> member, where the <code class="de nv nw nx ny b">Flink</code> to the next process can be read (e.g. <code class="de nv nw nx ny b">0x02f0</code> in Windows 10 1903). <code class="de nv nw nx ny b">EProcessFlags2</code> is a second set of <code class="de nv nw nx ny b">ULONG</code> bitfields introduced in Windows Vista, hence why this is only shown when running on systems <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_process.c#L73" rel="noopener ugc nofollow" target="_blank">Vista and above</a>, used to give use some more detail. Specifically:</p><ul class=""><li id="c5f3" class="mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt qs qt qu bl" data-selectable-paragraph=""><code class="de nv nw nx ny b">PrimaryTokenFrozen</code> — Uses a ternary to return “F-Tok” if the primary token is frozen and nothing if it isn’t. If <code class="de nv nw nx ny b">PrimaryTokenFrozen</code> is not set, we can <a class="ah nu" href="https://www.exploit-db.com/exploits/42556" rel="noopener ugc nofollow" target="_blank">swap in our token</a> such as in the case of suspended processes. In a vast majority of cases, you will find that the primary token is frozen.</li><li id="c5e3" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph=""><code class="de nv nw nx ny b">SignatureProtect</code> — This is actually 2 values - <code class="de nv nw nx ny b"><a class="ah nu" href="http://www.alex-ionescu.com/?p=146" rel="noopener ugc nofollow" target="_blank">SignatureLevel</a></code><a class="ah nu" href="http://www.alex-ionescu.com/?p=146" rel="noopener ugc nofollow" target="_blank"> and </a><code class="de nv nw nx ny b"><a class="ah nu" href="http://www.alex-ionescu.com/?p=146" rel="noopener ugc nofollow" target="_blank">SectionSignatureLevel</a></code>. <code class="de nv nw nx ny b">SignatureLevel</code> defines the signature requirements of the primary module. <code class="de nv nw nx ny b">SectionSignatureLevel</code> defines the minimum signature level requirements of a DLL to be loaded into the process.</li><li id="dc42" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph=""><code class="de nv nw nx ny b">Protection</code> — These 3 values, <code class="de nv nw nx ny b">Type</code>, <code class="de nv nw nx ny b">Audit</code>, and <code class="de nv nw nx ny b">Signer</code>, are members of the <code class="de nv nw nx ny b">PS_PROTECTION</code> structure which represent the process’ protection status. Most important of these is <code class="de nv nw nx ny b">Type</code>, which maps to the following statuses, which you may recognize as PP/PPL:</li></ul><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd rq"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*EtK6NBn1YhPvcsRAArtu9w.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*EtK6NBn1YhPvcsRAArtu9w.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*EtK6NBn1YhPvcsRAArtu9w.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*EtK6NBn1YhPvcsRAArtu9w.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*EtK6NBn1YhPvcsRAArtu9w.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*EtK6NBn1YhPvcsRAArtu9w.png 1100w, https://miro.medium.com/v2/resize:fit:612/format:webp/1*EtK6NBn1YhPvcsRAArtu9w.png 612w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 306px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*EtK6NBn1YhPvcsRAArtu9w.png 640w, https://miro.medium.com/v2/resize:fit:720/1*EtK6NBn1YhPvcsRAArtu9w.png 720w, https://miro.medium.com/v2/resize:fit:750/1*EtK6NBn1YhPvcsRAArtu9w.png 750w, https://miro.medium.com/v2/resize:fit:786/1*EtK6NBn1YhPvcsRAArtu9w.png 786w, https://miro.medium.com/v2/resize:fit:828/1*EtK6NBn1YhPvcsRAArtu9w.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*EtK6NBn1YhPvcsRAArtu9w.png 1100w, https://miro.medium.com/v2/resize:fit:612/1*EtK6NBn1YhPvcsRAArtu9w.png 612w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 306px"><img alt="" class="bi md pl c" width="306" height="89" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:306/1*EtK6NBn1YhPvcsRAArtu9w.png"></picture></div></figure><h3 id="606f" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!processProtect</h3><p id="f6ce" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The <code class="de nv nw nx ny b">!processProtect</code> function is one of, if not the most, used functionalities supplied by Mimidrv. Its objective is to add or remove <a class="ah nu" href="http://www.alex-ionescu.com/?p=97" rel="noopener ugc nofollow" target="_blank">process protection</a> from a process, most commonly LSASS. The way it goes about modifying the protection status is relatively simple:</p><ol class=""><li id="c72f" class="mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt rr qt qu bl" data-selectable-paragraph="">Use <code class="de nv nw nx ny b">nt!PsLookupProcessByProcessId</code> to get a handle on a process’ <code class="de nv nw nx ny b">EPROCESS</code> structure by its PID.</li><li id="5bcf" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt rr qt qu bl" data-selectable-paragraph="">Go to the <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/68ac65b426d1b9e1354dd0365676b1ead15022de/mimidrv/kkll_m_process.c#L8" rel="noopener ugc nofollow" target="_blank">version-specific offset</a> of <code class="de nv nw nx ny b">SignatureProtect</code> in the <code class="de nv nw nx ny b">EPROCESS</code> structure.</li><li id="4949" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt rr qt qu bl" data-selectable-paragraph="">Patches 5 values — <code class="de nv nw nx ny b">SignatureLevel</code>, <code class="de nv nw nx ny b">SectionSignatureLevel</code>, <code class="de nv nw nx ny b">Type</code>, <code class="de nv nw nx ny b">Audit</code>, and <code class="de nv nw nx ny b">Signer</code> (the last 3 being members of the <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/ioctl.h#L38" rel="noopener ugc nofollow" target="_blank">PS_PROTECTION</a></code><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/ioctl.h#L38" rel="noopener ugc nofollow" target="_blank"> struct</a>) — depending on whether or not it is protecting or unprotecting the process.</li><li id="afd0" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt rr qt qu bl" data-selectable-paragraph="">If protecting, the values will be <code class="de nv nw nx ny b">0x3f, 0x3f, 2, 0, 6</code>, representing a protected signer of <code class="de nv nw nx ny b">WinTcb</code> and protection level of <code class="de nv nw nx ny b">Max</code>.</li><li id="d60c" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt rr qt qu bl" data-selectable-paragraph="">If unprotecting, the values will be <code class="de nv nw nx ny b">0, 0, 0, 0, 0</code>, representing an unprotected process.</li><li id="7af6" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt rr qt qu bl" data-selectable-paragraph="">Finally, dereference the <code class="de nv nw nx ny b">EPROCESS</code> object.</li></ol><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd rs"><picture><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*hvmZgwD1ZOrapzqN 640w, https://miro.medium.com/v2/resize:fit:720/0*hvmZgwD1ZOrapzqN 720w, https://miro.medium.com/v2/resize:fit:750/0*hvmZgwD1ZOrapzqN 750w, https://miro.medium.com/v2/resize:fit:786/0*hvmZgwD1ZOrapzqN 786w, https://miro.medium.com/v2/resize:fit:828/0*hvmZgwD1ZOrapzqN 828w, https://miro.medium.com/v2/resize:fit:1100/0*hvmZgwD1ZOrapzqN 1100w, https://miro.medium.com/v2/resize:fit:1400/0*hvmZgwD1ZOrapzqN 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="338" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/0*hvmZgwD1ZOrapzqN"></picture></div></div></figure><p id="fb5b" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">This module is particularly relevant for us as attackers because most obviously we can remove protection from LSASS in order to extract credentials, but more interestingly we can protect an arbitrary process and use that to get a handle on another protected process. For example, we use <code class="de nv nw nx ny b">!processProtect</code> to protect our running <code class="de nv nw nx ny b">mimikatz.exe</code> and then run some command to extract credentials from LSASS and it should work despite LSASS being protected. An example of this use case is shown below.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd rt"><picture><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*wSlq8y6sOC7WYZav 640w, https://miro.medium.com/v2/resize:fit:720/0*wSlq8y6sOC7WYZav 720w, https://miro.medium.com/v2/resize:fit:750/0*wSlq8y6sOC7WYZav 750w, https://miro.medium.com/v2/resize:fit:786/0*wSlq8y6sOC7WYZav 786w, https://miro.medium.com/v2/resize:fit:828/0*wSlq8y6sOC7WYZav 828w, https://miro.medium.com/v2/resize:fit:1100/0*wSlq8y6sOC7WYZav 1100w, https://miro.medium.com/v2/resize:fit:1400/0*wSlq8y6sOC7WYZav 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="402" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/0*wSlq8y6sOC7WYZav"></picture></div></div></figure><h3 id="7853" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!processToken</h3><p id="2c0f" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">Continuing with another operationally-relevant function is <code class="de nv nw nx ny b">!processToken</code> which can be used to duplicate a process token and pass it to an attacker-specified process. This is most commonly used during <a class="ah nu" href="https://attack.mitre.org/techniques/T1207/" rel="noopener ugc nofollow" target="_blank">DCShadow attacks</a> and is similar to <code class="de nv nw nx ny b">token::elevate</code>, but modifies the process token instead of the thread token.</p><p id="2e6c" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">With no arguments passed, this function will grant all <code class="de nv nw nx ny b">cmd.exe</code>, <code class="de nv nw nx ny b">powershell.exe</code>, and <code class="de nv nw nx ny b">mimikatz.exe</code> processes a <code class="de nv nw nx ny b">NT AUTHORITY\SYSTEM</code> token. Alternatively, it takes “to” and “from” parameters which can be used to define the process you wish to copy the token from and process you want to copy it to.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd ru"><picture><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*hlut77KbWQN4Y1fR 640w, https://miro.medium.com/v2/resize:fit:720/0*hlut77KbWQN4Y1fR 720w, https://miro.medium.com/v2/resize:fit:750/0*hlut77KbWQN4Y1fR 750w, https://miro.medium.com/v2/resize:fit:786/0*hlut77KbWQN4Y1fR 786w, https://miro.medium.com/v2/resize:fit:828/0*hlut77KbWQN4Y1fR 828w, https://miro.medium.com/v2/resize:fit:1100/0*hlut77KbWQN4Y1fR 1100w, https://miro.medium.com/v2/resize:fit:664/0*hlut77KbWQN4Y1fR 664w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 332px"><img alt="" class="bi md pl c" width="332" height="81" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:332/0*hlut77KbWQN4Y1fR"></picture></div></figure><p id="53e7" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">To duplicate the token, Mimikatz first sets the “to” and “from” PIDs to the user-supplied values, or “0” if not set, and then places them in a <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/ioctl.h#L55" rel="noopener ugc nofollow" target="_blank">MIMIDRV_PROCESS_TOKEN_FROM_TO</a></code> struct, which sent to Mimidrv via <code class="de nv nw nx ny b">IOCTL_MIMIDRV_PROCESS_TOKEN</code>.</p><p id="fe0a" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Once Mimidrv receives the PIDs specified by the user, it gets handles on the “to” and “from” processes using <code class="de nv nw nx ny b">nt!PsLookupProcessByProcessId</code>. If it was able to get a handle on those processes, it uses <code class="de nv nw nx ny b">nt!ObOpenObjectByPointer</code> to get a kernel handle (<code class="de nv nw nx ny b">OBJ_KERNEL_HANDLE</code>) on the “from” process. This is required by the following call to <code class="de nv nw nx ny b">nt!ZwOpenProcessTokenEx</code>, which will return a handle on the “from” process’ token.</p><p id="5f96" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">At this point, the logic forks somewhat. In the first case where the user has supplied their own “to” process, Mimidrv calls <code class="de nv nw nx ny b">kkll_m_process_token_toProcess</code>. This function first uses <code class="de nv nw nx ny b">nt!ObOpenObjectByPointer</code> to get a kernel handle on the “to” process. Then it calls <code class="de nv nw nx ny b">ZwDuplicateToken</code> to get the token from the “from” process and stash it in an <a class="ah nu" href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented+Functions%2FNT+Objects%2FProcess%2FPROCESS_ACCESS_TOKEN.html" rel="noopener ugc nofollow" target="_blank">undocumented </a><code class="de nv nw nx ny b"><a class="ah nu" href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented+Functions%2FNT+Objects%2FProcess%2FPROCESS_ACCESS_TOKEN.html" rel="noopener ugc nofollow" target="_blank">PROCESS_ACCESS_TOKEN</a></code><a class="ah nu" href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented+Functions%2FNT+Objects%2FProcess%2FPROCESS_ACCESS_TOKEN.html" rel="noopener ugc nofollow" target="_blank"> struct</a> as the <code class="de nv nw nx ny b">Token</code> attribute. If the system is running Windows Vista or above, it sets <code class="de nv nw nx ny b">PrimaryTokenFrozen</code> (described in the <code class="de nv nw nx ny b">!process</code> section) and then calls the <a class="ah nu" href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented+Functions%2FNT+Objects%2FProcess%2FNtSetInformationProcess.html" rel="noopener ugc nofollow" target="_blank">undocumented </a><code class="de nv nw nx ny b"><a class="ah nu" href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented+Functions%2FNT+Objects%2FProcess%2FNtSetInformationProcess.html" rel="noopener ugc nofollow" target="_blank">nt!ZwSetInformationProcess</a></code><a class="ah nu" href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented+Functions%2FNT+Objects%2FProcess%2FNtSetInformationProcess.html" rel="noopener ugc nofollow" target="_blank"> function</a> to do the actual work of giving the duplicated token to the “to” process. Once that completes, it cleans up by closing the handles to the “to” process and <code class="de nv nw nx ny b">PROCESS_ACCESS_TOKEN</code> struct.</p><p id="d318" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">In the event that no “to” process was specified, Mimidrv leverages the <code class="de nv nw nx ny b">kkll_m_process_enum</code> function used in <code class="de nv nw nx ny b">!process</code> to walk the list of processes on the system. Instead of using the <code class="de nv nw nx ny b">kkll_m_process_list_callback</code> callback, it uses <code class="de nv nw nx ny b">kkll_m_process_systoken_callback</code>, which uses <code class="de nv nw nx ny b">ntdll!RtlCompareMemory</code> to check if the ImageFileName matches “mimikatz.exe”, “cmd.exe”, or “powershell.exe”. If it does, it passes a handle to that process to <code class="de nv nw nx ny b">kkll_m_process_token_toProcess</code> and the functionality described in the paragraph before this is used to grant a duplicated token to that process, and then it continues walking the linked list looking for other matches.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd rv"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*4wMfz46sU0_6I4vu_9vxwA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*4wMfz46sU0_6I4vu_9vxwA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*4wMfz46sU0_6I4vu_9vxwA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*4wMfz46sU0_6I4vu_9vxwA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*4wMfz46sU0_6I4vu_9vxwA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*4wMfz46sU0_6I4vu_9vxwA.png 1100w, https://miro.medium.com/v2/resize:fit:806/format:webp/1*4wMfz46sU0_6I4vu_9vxwA.png 806w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 403px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*4wMfz46sU0_6I4vu_9vxwA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*4wMfz46sU0_6I4vu_9vxwA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*4wMfz46sU0_6I4vu_9vxwA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*4wMfz46sU0_6I4vu_9vxwA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*4wMfz46sU0_6I4vu_9vxwA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*4wMfz46sU0_6I4vu_9vxwA.png 1100w, https://miro.medium.com/v2/resize:fit:806/1*4wMfz46sU0_6I4vu_9vxwA.png 806w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 403px"><img alt="" class="bi md pl c" width="403" height="213" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:403/1*4wMfz46sU0_6I4vu_9vxwA.png"></picture></div></figure><h3 id="8161" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!processPrivilege</h3><p id="0144" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">This is a relatively simple function that grants all privileges (e.g. <code class="de nv nw nx ny b">SeDebugPrivilege</code>, <code class="de nv nw nx ny b">SeLoadDriverPrivilege</code>), but includes some interesting code that highlights the power of operating in ring 0. Before we jump into exactly how Mimidrv modifies the target process token, it is important to understand what a token looks like in the kernel.</p><p id="beb7" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">As discussed earlier, the <code class="de nv nw nx ny b">EPROCESS</code> structure contains attributes of a process, including the token (offset <code class="de nv nw nx ny b">0x360</code> in Windows 10 1903). You may notice that the token of the type <code class="de nv nw nx ny b"><a class="ah nu" href="https://www.codemachine.com/article_exfastref_pointers.html" rel="noopener ugc nofollow" target="_blank">EX_FAST_REF</a></code> rather than <code class="de nv nw nx ny b">TOKEN</code>.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd rw"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*N7x-DahK958UwDbQ6bRhaA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*N7x-DahK958UwDbQ6bRhaA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*N7x-DahK958UwDbQ6bRhaA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*N7x-DahK958UwDbQ6bRhaA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*N7x-DahK958UwDbQ6bRhaA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*N7x-DahK958UwDbQ6bRhaA.png 1100w, https://miro.medium.com/v2/resize:fit:674/format:webp/1*N7x-DahK958UwDbQ6bRhaA.png 674w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 337px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*N7x-DahK958UwDbQ6bRhaA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*N7x-DahK958UwDbQ6bRhaA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*N7x-DahK958UwDbQ6bRhaA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*N7x-DahK958UwDbQ6bRhaA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*N7x-DahK958UwDbQ6bRhaA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*N7x-DahK958UwDbQ6bRhaA.png 1100w, https://miro.medium.com/v2/resize:fit:674/1*N7x-DahK958UwDbQ6bRhaA.png 674w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 337px"><img alt="" class="bi md pl c" width="337" height="49" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:337/1*N7x-DahK958UwDbQ6bRhaA.png"></picture></div></figure><p id="2d25" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">This is some internal Windows weirdness, but these pointers are built around that fact that that kernel structures are aligned on a 16-byte boundary on x64 systems. Due to this alignment, spare bits in the pointer are available to be used for reference counting. Where this becomes relevant for us is that the last 1 byte of the pointer will be the reference to our object — in this case a pointer to the <code class="de nv nw nx ny b">TOKEN</code> structure.</p><p id="d179" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">To demonstrate this practically, let’s hunt down the token of the System process in WinDbg. First, we get the address of the <code class="de nv nw nx ny b">EPROCESS</code> structure for the process.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd rx"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*C4XoX8jy3qFNXvqHnvAoOQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*C4XoX8jy3qFNXvqHnvAoOQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*C4XoX8jy3qFNXvqHnvAoOQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*C4XoX8jy3qFNXvqHnvAoOQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*C4XoX8jy3qFNXvqHnvAoOQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*C4XoX8jy3qFNXvqHnvAoOQ.png 1100w, https://miro.medium.com/v2/resize:fit:1102/format:webp/1*C4XoX8jy3qFNXvqHnvAoOQ.png 1102w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 551px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*C4XoX8jy3qFNXvqHnvAoOQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*C4XoX8jy3qFNXvqHnvAoOQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*C4XoX8jy3qFNXvqHnvAoOQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*C4XoX8jy3qFNXvqHnvAoOQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*C4XoX8jy3qFNXvqHnvAoOQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*C4XoX8jy3qFNXvqHnvAoOQ.png 1100w, https://miro.medium.com/v2/resize:fit:1102/1*C4XoX8jy3qFNXvqHnvAoOQ.png 1102w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 551px"><img alt="" class="bi md pl c" width="551" height="69" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:551/1*C4XoX8jy3qFNXvqHnvAoOQ.png"></picture></div></figure><p id="189d" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Because we know that the token <code class="de nv nw nx ny b">EX_FAST_REF</code> will be at offset <code class="de nv nw nx ny b">0x360</code>, we can use WinDbg’s calculator to do some quick math and give us the memory address at the result of the equation.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd ry"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*pxl18_W3Otk2m1QlY1lZCA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*pxl18_W3Otk2m1QlY1lZCA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*pxl18_W3Otk2m1QlY1lZCA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*pxl18_W3Otk2m1QlY1lZCA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*pxl18_W3Otk2m1QlY1lZCA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*pxl18_W3Otk2m1QlY1lZCA.png 1100w, https://miro.medium.com/v2/resize:fit:580/format:webp/1*pxl18_W3Otk2m1QlY1lZCA.png 580w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 290px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*pxl18_W3Otk2m1QlY1lZCA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*pxl18_W3Otk2m1QlY1lZCA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*pxl18_W3Otk2m1QlY1lZCA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*pxl18_W3Otk2m1QlY1lZCA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*pxl18_W3Otk2m1QlY1lZCA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*pxl18_W3Otk2m1QlY1lZCA.png 1100w, https://miro.medium.com/v2/resize:fit:580/1*pxl18_W3Otk2m1QlY1lZCA.png 580w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 290px"><img alt="" class="bi md pl c" width="290" height="35" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:290/1*pxl18_W3Otk2m1QlY1lZCA.png"></picture></div></figure><p id="f833" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Now that we have the address of the <code class="de nv nw nx ny b">EX_FAST_REF</code>, we can change the last byte to <code class="de nv nw nx ny b">0</code> to get the address of our <code class="de nv nw nx ny b">TOKEN</code> structure, which we’ll examine with the <code class="de nv nw nx ny b">!token</code> extension.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd rz"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*jaYdVKUMpz8kyXkfM3cuYQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*jaYdVKUMpz8kyXkfM3cuYQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*jaYdVKUMpz8kyXkfM3cuYQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*jaYdVKUMpz8kyXkfM3cuYQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*jaYdVKUMpz8kyXkfM3cuYQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*jaYdVKUMpz8kyXkfM3cuYQ.png 1100w, https://miro.medium.com/v2/resize:fit:1232/format:webp/1*jaYdVKUMpz8kyXkfM3cuYQ.png 1232w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 616px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*jaYdVKUMpz8kyXkfM3cuYQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*jaYdVKUMpz8kyXkfM3cuYQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*jaYdVKUMpz8kyXkfM3cuYQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*jaYdVKUMpz8kyXkfM3cuYQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*jaYdVKUMpz8kyXkfM3cuYQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*jaYdVKUMpz8kyXkfM3cuYQ.png 1100w, https://miro.medium.com/v2/resize:fit:1232/1*jaYdVKUMpz8kyXkfM3cuYQ.png 1232w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 616px"><img alt="" class="bi md pl c" width="616" height="542" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:616/1*jaYdVKUMpz8kyXkfM3cuYQ.png"></picture></div></figure><p id="56f7" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">So now that we can identify the <code class="de nv nw nx ny b">TOKEN</code> structure, we can examine some of its attributes.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd sa"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*2Qh9E82BNo9fz9sivriwnQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*2Qh9E82BNo9fz9sivriwnQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*2Qh9E82BNo9fz9sivriwnQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*2Qh9E82BNo9fz9sivriwnQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*2Qh9E82BNo9fz9sivriwnQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*2Qh9E82BNo9fz9sivriwnQ.png 1100w, https://miro.medium.com/v2/resize:fit:788/format:webp/1*2Qh9E82BNo9fz9sivriwnQ.png 788w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 394px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*2Qh9E82BNo9fz9sivriwnQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*2Qh9E82BNo9fz9sivriwnQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*2Qh9E82BNo9fz9sivriwnQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*2Qh9E82BNo9fz9sivriwnQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*2Qh9E82BNo9fz9sivriwnQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*2Qh9E82BNo9fz9sivriwnQ.png 1100w, https://miro.medium.com/v2/resize:fit:788/1*2Qh9E82BNo9fz9sivriwnQ.png 788w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 394px"><img alt="" class="bi md pl c" width="394" height="150" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:394/1*2Qh9E82BNo9fz9sivriwnQ.png"></picture></div></figure><p id="1ea4" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Most relevant to <code class="de nv nw nx ny b">!processPrivileges</code> is the <code class="de nv nw nx ny b">Privileges</code> attribute (offset <code class="de nv nw nx ny b">0x40</code> on Vista and above). This attribute is of the type <code class="de nv nw nx ny b">SEP_TOKEN_PRIVILEGES</code> which contains 3 attributes — <code class="de nv nw nx ny b">Present</code>, <code class="de nv nw nx ny b">Enabled</code>, and <code class="de nv nw nx ny b">EnabledByDefault</code>. These are bitmasks representing the token permissions we are used to seeing (<code class="de nv nw nx ny b">SeDebugPrivilege</code>, <code class="de nv nw nx ny b">SeLoadDriverPrivilege</code>, etc.).</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd sb"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*Q-c1a3Hh60y7DSp1PFAwew.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*Q-c1a3Hh60y7DSp1PFAwew.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*Q-c1a3Hh60y7DSp1PFAwew.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*Q-c1a3Hh60y7DSp1PFAwew.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*Q-c1a3Hh60y7DSp1PFAwew.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Q-c1a3Hh60y7DSp1PFAwew.png 1100w, https://miro.medium.com/v2/resize:fit:620/format:webp/1*Q-c1a3Hh60y7DSp1PFAwew.png 620w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 310px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*Q-c1a3Hh60y7DSp1PFAwew.png 640w, https://miro.medium.com/v2/resize:fit:720/1*Q-c1a3Hh60y7DSp1PFAwew.png 720w, https://miro.medium.com/v2/resize:fit:750/1*Q-c1a3Hh60y7DSp1PFAwew.png 750w, https://miro.medium.com/v2/resize:fit:786/1*Q-c1a3Hh60y7DSp1PFAwew.png 786w, https://miro.medium.com/v2/resize:fit:828/1*Q-c1a3Hh60y7DSp1PFAwew.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*Q-c1a3Hh60y7DSp1PFAwew.png 1100w, https://miro.medium.com/v2/resize:fit:620/1*Q-c1a3Hh60y7DSp1PFAwew.png 620w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 310px"><img alt="" class="bi md pl c" width="310" height="68" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:310/1*Q-c1a3Hh60y7DSp1PFAwew.png"></picture></div></figure><p id="77e6" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">If we examine the <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/68ac65b426d1b9e1354dd0365676b1ead15022de/mimidrv/kkll_m_process.c#L237" rel="noopener ugc nofollow" target="_blank">function called by Mimidrv</a> when we issue the <code class="de nv nw nx ny b">!processPrivileges</code> command, we can see that these bitmasks are being overwritten to enable all privileges on the primary token of the target process. Here’s what the result looks like in the GUI.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd sc"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*HEYD8Mv1CjLOldzrsz2N1w.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*HEYD8Mv1CjLOldzrsz2N1w.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*HEYD8Mv1CjLOldzrsz2N1w.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*HEYD8Mv1CjLOldzrsz2N1w.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*HEYD8Mv1CjLOldzrsz2N1w.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*HEYD8Mv1CjLOldzrsz2N1w.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HEYD8Mv1CjLOldzrsz2N1w.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*HEYD8Mv1CjLOldzrsz2N1w.png 640w, https://miro.medium.com/v2/resize:fit:720/1*HEYD8Mv1CjLOldzrsz2N1w.png 720w, https://miro.medium.com/v2/resize:fit:750/1*HEYD8Mv1CjLOldzrsz2N1w.png 750w, https://miro.medium.com/v2/resize:fit:786/1*HEYD8Mv1CjLOldzrsz2N1w.png 786w, https://miro.medium.com/v2/resize:fit:828/1*HEYD8Mv1CjLOldzrsz2N1w.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*HEYD8Mv1CjLOldzrsz2N1w.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*HEYD8Mv1CjLOldzrsz2N1w.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="165" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*HEYD8Mv1CjLOldzrsz2N1w.png"></picture></div></div></figure><p id="e56a" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">And here it is in the debugger while inspecting the memory at the <code class="de nv nw nx ny b">Privileges</code> offset.</p></div></div><div class="pk"><div class="ac ci"><div class="ly sd lz se ma sf cm sg cn sh cp bi"><figure class="pf pg ph pi pj pk sj sk paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd si"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*RB9hMkZAvyZBo_lXNl0ymg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*RB9hMkZAvyZBo_lXNl0ymg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*RB9hMkZAvyZBo_lXNl0ymg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*RB9hMkZAvyZBo_lXNl0ymg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*RB9hMkZAvyZBo_lXNl0ymg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*RB9hMkZAvyZBo_lXNl0ymg.png 1100w, https://miro.medium.com/v2/resize:fit:2000/format:webp/1*RB9hMkZAvyZBo_lXNl0ymg.png 2000w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 1000px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*RB9hMkZAvyZBo_lXNl0ymg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*RB9hMkZAvyZBo_lXNl0ymg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*RB9hMkZAvyZBo_lXNl0ymg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*RB9hMkZAvyZBo_lXNl0ymg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*RB9hMkZAvyZBo_lXNl0ymg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*RB9hMkZAvyZBo_lXNl0ymg.png 1100w, https://miro.medium.com/v2/resize:fit:2000/1*RB9hMkZAvyZBo_lXNl0ymg.png 2000w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 1000px"><img alt="" class="bi md pl c" width="1000" height="114" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:1000/1*RB9hMkZAvyZBo_lXNl0ymg.png"></picture></div></div></figure></div></div></div><div class="ac ci"><div class="cp bi gq gr gs gt"><p id="69a2" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">To sum this module up, <code class="de nv nw nx ny b">!processPrivileges</code> overwrites a specific bitmask in a target process’ <code class="de nv nw nx ny b">TOKEN</code> structure which grants all permissions to the target process.</p></div></div></div><div class="ac ci ra rb rc rd" role="separator"><span class="re by bn rf rg rh"></span><span class="re by bn rf rg rh"></span><span class="re by bn rf rg"></span></div><div class="he hf hg hh hi"><div class="ac ci"><div class="cp bi gq gr gs gt"><h2 id="b69b" class="nz oa hl bg ob oc ri oe of og rj oi oj ok rk om on oo rl oq or os rm ou ov ow bl" data-selectable-paragraph="">Notify</h2><p id="8bdd" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The kernel provides ways for drivers to “subscribe” to specific events that happen on a system by registering callback functions to be executed when the specific event happens. Common examples of this are shutdown handlers, which allow the driver to perform some action when the system is shutting down (often for persistence), and process creation notifications, which let the driver know whenever a new process is started on the system (commonly used by EDRs).</p><p id="918a" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">These modules allow us to find drivers that subscribe to specific event notifications and where their callback function is located. The code Mimidrv uses to do this is a bit hard to read, but the general flow is:</p><ol class=""><li id="c928" class="mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt rr qt qu bl" data-selectable-paragraph=""><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_notify.c#L226" rel="noopener ugc nofollow" target="_blank">Search</a> for a string of bytes, specifically the opcodes directly <strong class="my hm">after</strong> a LEA instruction containing the pointer to a structure in system memory.</li><li id="d75d" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt rr qt qu bl" data-selectable-paragraph="">Work with the <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_notify.h" rel="noopener ugc nofollow" target="_blank">structure</a> (or <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_notify.c#L239" rel="noopener ugc nofollow" target="_blank">pointers to structures</a>) at the address passed in the LEA instruction to find the address of the callback functions.</li><li id="c2cd" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt rr qt qu bl" data-selectable-paragraph=""><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_notify.c#L241" rel="noopener ugc nofollow" target="_blank">Return some details</a> about the function, such as the driver that it belongs to.</li></ol><h3 id="567e" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!notifProcess</h3><p id="6cdd" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">A driver can opt to receive notifications when a process is created or destroyed by using <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreateprocessnotifyroutine" rel="noopener ugc nofollow" target="_blank">nt!PsSetCreateProcessNotifyRoutine</a>(<a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreateprocessnotifyroutineex" rel="noopener ugc nofollow" target="_blank">Ex</a>/<a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreateprocessnotifyroutineex2" rel="noopener ugc nofollow" target="_blank">Ex2</a>)</code> with a callback function specified in the first parameter. When a process is created, a process object for the newly created process is returned along with a <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/ns-ntddk-_ps_create_notify_info" rel="noopener ugc nofollow" target="_blank">PS_CREATE_NOTIFY_INFO</a></code> structure, which contains a ton of relevant information about the newly created process, including its parent process ID and command line arguments. A simple implementation of process notifications can be found <a class="ah nu" href="https://github.com/Madb33/WindowKernelDriver-Study/blob/4e024436e6038cf6cca4944e5686c83274bcb12b/ProcessMonitor/processMonitor.c" rel="noopener ugc nofollow" target="_blank">here</a>.</p><p id="64b3" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">This type of notification has some advantages over <a class="ah nu" href="https://blogs.msdn.microsoft.com/ntdebugging/2009/08/27/part-1-etw-introduction-and-overview/" rel="noopener ugc nofollow" target="_blank">Event Tracing for Windows (ETW)</a>, namely that there is no delay in receiving the creation/termination notifications and because the process object is passed to our driver, we have a way to prevent the process from starting during a pre-operation callback. Seems pretty useful for an EDR product, eh?</p><p id="6982" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">We first begin by searching for the <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_notify.c#L48" rel="noopener ugc nofollow" target="_blank">pattern of bytes</a> (opcodes starting at <code class="de nv nw nx ny b">LEA RCX,[RBX*8]</code> in the screenshot below) between the <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_notify.c#L280" rel="noopener ugc nofollow" target="_blank">addresses</a> of <code class="de nv nw nx ny b">nt!PsSetCreateProcessNotifyRoutine</code> and <code class="de nv nw nx ny b">nt!IoCreateDriver</code> which marks the start of the undocumented <code class="de nv nw nx ny b">nt!PspSetCreateProcessNotifyRoutine</code> array.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd sl"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*CdnRgUYG0ybWY0rHAxa80A.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*CdnRgUYG0ybWY0rHAxa80A.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*CdnRgUYG0ybWY0rHAxa80A.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*CdnRgUYG0ybWY0rHAxa80A.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*CdnRgUYG0ybWY0rHAxa80A.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*CdnRgUYG0ybWY0rHAxa80A.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CdnRgUYG0ybWY0rHAxa80A.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*CdnRgUYG0ybWY0rHAxa80A.png 640w, https://miro.medium.com/v2/resize:fit:720/1*CdnRgUYG0ybWY0rHAxa80A.png 720w, https://miro.medium.com/v2/resize:fit:750/1*CdnRgUYG0ybWY0rHAxa80A.png 750w, https://miro.medium.com/v2/resize:fit:786/1*CdnRgUYG0ybWY0rHAxa80A.png 786w, https://miro.medium.com/v2/resize:fit:828/1*CdnRgUYG0ybWY0rHAxa80A.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*CdnRgUYG0ybWY0rHAxa80A.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*CdnRgUYG0ybWY0rHAxa80A.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="103" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*CdnRgUYG0ybWY0rHAxa80A.png"></picture></div></div></figure><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd sm"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*K3QT4zV6oja-Ew2_QIg7Jw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*K3QT4zV6oja-Ew2_QIg7Jw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*K3QT4zV6oja-Ew2_QIg7Jw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*K3QT4zV6oja-Ew2_QIg7Jw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*K3QT4zV6oja-Ew2_QIg7Jw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*K3QT4zV6oja-Ew2_QIg7Jw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K3QT4zV6oja-Ew2_QIg7Jw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*K3QT4zV6oja-Ew2_QIg7Jw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*K3QT4zV6oja-Ew2_QIg7Jw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*K3QT4zV6oja-Ew2_QIg7Jw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*K3QT4zV6oja-Ew2_QIg7Jw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*K3QT4zV6oja-Ew2_QIg7Jw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*K3QT4zV6oja-Ew2_QIg7Jw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*K3QT4zV6oja-Ew2_QIg7Jw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="57" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*K3QT4zV6oja-Ew2_QIg7Jw.png"></picture></div></div></figure><p id="6d5d" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">At the address of <code class="de nv nw nx ny b">nt!PspSetCreateProcessNotifyRoute</code> is an <a class="ah nu" href="https://www.triplefault.io/2017/09/enumerating-process-thread-and-image.html" rel="noopener ugc nofollow" target="_blank">array of ≤64 pointers</a> to <code class="de nv nw nx ny b">EX_FAST_REF</code> structures.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd sn"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*q4Agk8ONMRSm3CNC7itZDg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*q4Agk8ONMRSm3CNC7itZDg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*q4Agk8ONMRSm3CNC7itZDg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*q4Agk8ONMRSm3CNC7itZDg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*q4Agk8ONMRSm3CNC7itZDg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*q4Agk8ONMRSm3CNC7itZDg.png 1100w, https://miro.medium.com/v2/resize:fit:858/format:webp/1*q4Agk8ONMRSm3CNC7itZDg.png 858w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 429px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*q4Agk8ONMRSm3CNC7itZDg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*q4Agk8ONMRSm3CNC7itZDg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*q4Agk8ONMRSm3CNC7itZDg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*q4Agk8ONMRSm3CNC7itZDg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*q4Agk8ONMRSm3CNC7itZDg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*q4Agk8ONMRSm3CNC7itZDg.png 1100w, https://miro.medium.com/v2/resize:fit:858/1*q4Agk8ONMRSm3CNC7itZDg.png 858w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 429px"><img alt="" class="bi md pl c" width="429" height="148" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:429/1*q4Agk8ONMRSm3CNC7itZDg.png"></picture></div></figure><p id="cbd3" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">When a process is created/terminated, <code class="de nv nw nx ny b">nt!PspCallProcessNotifyRoutines</code> walks through this array and calls all of the callbacks registered by drivers on the system. In this array, we will work with the 3rd item (<code class="de nv nw nx ny b">0xffff9409c37c7e6f</code>). The last 4 bits of these pointer addresses are insignificant, so <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_notify.c#L260" rel="noopener ugc nofollow" target="_blank">they are removed</a> which gives us the address of the <code class="de nv nw nx ny b">EX_CALLBACK_ROUTINE_BLOCK</code>.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd so"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*8Gwb1ndDB6djkvAZ1KHgWA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*8Gwb1ndDB6djkvAZ1KHgWA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*8Gwb1ndDB6djkvAZ1KHgWA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*8Gwb1ndDB6djkvAZ1KHgWA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*8Gwb1ndDB6djkvAZ1KHgWA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*8Gwb1ndDB6djkvAZ1KHgWA.png 1100w, https://miro.medium.com/v2/resize:fit:856/format:webp/1*8Gwb1ndDB6djkvAZ1KHgWA.png 856w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 428px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*8Gwb1ndDB6djkvAZ1KHgWA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*8Gwb1ndDB6djkvAZ1KHgWA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*8Gwb1ndDB6djkvAZ1KHgWA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*8Gwb1ndDB6djkvAZ1KHgWA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*8Gwb1ndDB6djkvAZ1KHgWA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*8Gwb1ndDB6djkvAZ1KHgWA.png 1100w, https://miro.medium.com/v2/resize:fit:856/1*8Gwb1ndDB6djkvAZ1KHgWA.png 856w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 428px"><img alt="" class="bi md pl c" width="428" height="296" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:428/1*8Gwb1ndDB6djkvAZ1KHgWA.png"></picture></div></figure><p id="e025" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">The <code class="de nv nw nx ny b">EX_CALLBACK_ROUTINE_BLOCK</code> structure is undocumented, but thanks to the folks over at ReactOS, we have it <a class="ah nu" href="https://doxygen.reactos.org/de/d22/ndk_2extypes_8h_source.html#l00535" rel="noopener ugc nofollow" target="_blank">defined here</a> as:</p><figure class="pf pg ph pi pj pk"><div class="pm ga m fr"><div class="pn po m"><div src="https://medium.com/media/85c71b50cc062c292bd8afd20528ef85" allowfullscreen="" frameborder="0" height="0" width="0" title="EX_CALLBACK_ROUTINE_BLOCK Definition" class="fw o gz ed bi" scrolling="no" data-original-tag="iframe"><title>EX_CALLBACK_ROUTINE_BLOCK Definition – Medium</title><base target="_blank"><link rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-8703547f549b05ef.css"></div></div></div></figure><p id="9549" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">The first 8 bytes of the structure represent an <code class="de nv nw nx ny b">EX_RUNDOWN_REF</code> structure, so we can jump past them to get the address of the callback function inside of a driver.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd sp"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*fzefgmUyj38wtnJQlhGAcQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*fzefgmUyj38wtnJQlhGAcQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*fzefgmUyj38wtnJQlhGAcQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*fzefgmUyj38wtnJQlhGAcQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*fzefgmUyj38wtnJQlhGAcQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*fzefgmUyj38wtnJQlhGAcQ.png 1100w, https://miro.medium.com/v2/resize:fit:762/format:webp/1*fzefgmUyj38wtnJQlhGAcQ.png 762w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 381px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*fzefgmUyj38wtnJQlhGAcQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*fzefgmUyj38wtnJQlhGAcQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*fzefgmUyj38wtnJQlhGAcQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*fzefgmUyj38wtnJQlhGAcQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*fzefgmUyj38wtnJQlhGAcQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*fzefgmUyj38wtnJQlhGAcQ.png 1100w, https://miro.medium.com/v2/resize:fit:762/1*fzefgmUyj38wtnJQlhGAcQ.png 762w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 381px"><img alt="" class="bi md pl c" width="381" height="32" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:381/1*fzefgmUyj38wtnJQlhGAcQ.png"></picture></div></figure><p id="f266" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">We then take that address and <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_notify.c#L264" rel="noopener ugc nofollow" target="_blank">see which module is loaded at that address</a>.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd sq"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*IDUCK_mnsGVXZUkyJpvXUg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*IDUCK_mnsGVXZUkyJpvXUg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*IDUCK_mnsGVXZUkyJpvXUg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*IDUCK_mnsGVXZUkyJpvXUg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*IDUCK_mnsGVXZUkyJpvXUg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*IDUCK_mnsGVXZUkyJpvXUg.png 1100w, https://miro.medium.com/v2/resize:fit:952/format:webp/1*IDUCK_mnsGVXZUkyJpvXUg.png 952w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 476px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*IDUCK_mnsGVXZUkyJpvXUg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*IDUCK_mnsGVXZUkyJpvXUg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*IDUCK_mnsGVXZUkyJpvXUg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*IDUCK_mnsGVXZUkyJpvXUg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*IDUCK_mnsGVXZUkyJpvXUg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*IDUCK_mnsGVXZUkyJpvXUg.png 1100w, https://miro.medium.com/v2/resize:fit:952/1*IDUCK_mnsGVXZUkyJpvXUg.png 952w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 476px"><img alt="" class="bi md pl c" width="476" height="74" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:476/1*IDUCK_mnsGVXZUkyJpvXUg.png"></picture></div></figure><p id="1104" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">And there we can see that this is the address of the process notification callback for <code class="de nv nw nx ny b">WdFilter.sys</code>, Defender’s driver!</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd sr"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*UrrF6CQuKMKT6kZasKbfXg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*UrrF6CQuKMKT6kZasKbfXg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*UrrF6CQuKMKT6kZasKbfXg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*UrrF6CQuKMKT6kZasKbfXg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*UrrF6CQuKMKT6kZasKbfXg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*UrrF6CQuKMKT6kZasKbfXg.png 1100w, https://miro.medium.com/v2/resize:fit:796/format:webp/1*UrrF6CQuKMKT6kZasKbfXg.png 796w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 398px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*UrrF6CQuKMKT6kZasKbfXg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*UrrF6CQuKMKT6kZasKbfXg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*UrrF6CQuKMKT6kZasKbfXg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*UrrF6CQuKMKT6kZasKbfXg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*UrrF6CQuKMKT6kZasKbfXg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*UrrF6CQuKMKT6kZasKbfXg.png 1100w, https://miro.medium.com/v2/resize:fit:796/1*UrrF6CQuKMKT6kZasKbfXg.png 796w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 398px"><img alt="" class="bi md pl c" width="398" height="182" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:398/1*UrrF6CQuKMKT6kZasKbfXg.png"></picture></div></figure><p id="ef04" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Could we write a <code class="de nv nw nx ny b">RET</code> instruction at this address to neuter this functionality in the driver? 😈</p><h3 id="3c48" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!notifThread</h3><p id="6ba3" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The <code class="de nv nw nx ny b">!notifThread</code> command is nearly identical to the <code class="de nv nw nx ny b">!notifProcess</code> command, but it <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_notify.c#L24" rel="noopener ugc nofollow" target="_blank">searches for the address</a> of <code class="de nv nw nx ny b">nt!PspCreateThreadNotifyRoutine </code>to find the pointers to the thread notification callback functions instead of <code class="de nv nw nx ny b">nt!PspCreateProcessNotifyRoutine</code>.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd ss"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*xXcqY6NDoCx6-16QBoB1Vg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*xXcqY6NDoCx6-16QBoB1Vg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*xXcqY6NDoCx6-16QBoB1Vg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*xXcqY6NDoCx6-16QBoB1Vg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*xXcqY6NDoCx6-16QBoB1Vg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*xXcqY6NDoCx6-16QBoB1Vg.png 1100w, https://miro.medium.com/v2/resize:fit:944/format:webp/1*xXcqY6NDoCx6-16QBoB1Vg.png 944w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 472px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*xXcqY6NDoCx6-16QBoB1Vg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*xXcqY6NDoCx6-16QBoB1Vg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*xXcqY6NDoCx6-16QBoB1Vg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*xXcqY6NDoCx6-16QBoB1Vg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*xXcqY6NDoCx6-16QBoB1Vg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*xXcqY6NDoCx6-16QBoB1Vg.png 1100w, https://miro.medium.com/v2/resize:fit:944/1*xXcqY6NDoCx6-16QBoB1Vg.png 944w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 472px"><img alt="" class="bi md pl c" width="472" height="248" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:472/1*xXcqY6NDoCx6-16QBoB1Vg.png"></picture></div></div></figure><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd st"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*6UfLkSOjjERGKQdSRLitRA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*6UfLkSOjjERGKQdSRLitRA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*6UfLkSOjjERGKQdSRLitRA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*6UfLkSOjjERGKQdSRLitRA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*6UfLkSOjjERGKQdSRLitRA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*6UfLkSOjjERGKQdSRLitRA.png 1100w, https://miro.medium.com/v2/resize:fit:774/format:webp/1*6UfLkSOjjERGKQdSRLitRA.png 774w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 387px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*6UfLkSOjjERGKQdSRLitRA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*6UfLkSOjjERGKQdSRLitRA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*6UfLkSOjjERGKQdSRLitRA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*6UfLkSOjjERGKQdSRLitRA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*6UfLkSOjjERGKQdSRLitRA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*6UfLkSOjjERGKQdSRLitRA.png 1100w, https://miro.medium.com/v2/resize:fit:774/1*6UfLkSOjjERGKQdSRLitRA.png 774w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 387px"><img alt="" class="bi md pl c" width="387" height="74" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:387/1*6UfLkSOjjERGKQdSRLitRA.png"></picture></div></figure><h3 id="10f7" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!notifImage</h3><p id="4724" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">These notifications allow a driver to receive and event whenever an image (e.g. driver, DLL, EXE) is <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nc-ntddk-pload_image_notify_routine" rel="noopener ugc nofollow" target="_blank">mapped into memory</a>. Just as in the function above, <code class="de nv nw nx ny b">!notifImage</code> simply changes the array it is searching for to <code class="de nv nw nx ny b">nt!PspLoadImageNotifyRoutine</code> in order to locate the pointers to image load notification callback routines.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd su"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*wPJq0kMh9tRqhqJYBB30Jw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*wPJq0kMh9tRqhqJYBB30Jw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*wPJq0kMh9tRqhqJYBB30Jw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*wPJq0kMh9tRqhqJYBB30Jw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*wPJq0kMh9tRqhqJYBB30Jw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*wPJq0kMh9tRqhqJYBB30Jw.png 1100w, https://miro.medium.com/v2/resize:fit:1096/format:webp/1*wPJq0kMh9tRqhqJYBB30Jw.png 1096w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 548px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*wPJq0kMh9tRqhqJYBB30Jw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*wPJq0kMh9tRqhqJYBB30Jw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*wPJq0kMh9tRqhqJYBB30Jw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*wPJq0kMh9tRqhqJYBB30Jw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*wPJq0kMh9tRqhqJYBB30Jw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*wPJq0kMh9tRqhqJYBB30Jw.png 1100w, https://miro.medium.com/v2/resize:fit:1096/1*wPJq0kMh9tRqhqJYBB30Jw.png 1096w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 548px"><img alt="" class="bi md pl c" width="548" height="290" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:548/1*wPJq0kMh9tRqhqJYBB30Jw.png"></picture></div></figure><p id="a0b3" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">From there it follows the exact same process of bitshifting to get the address of the callback function.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd sv"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*e1rKTK53sD3-D74xWfdVqQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*e1rKTK53sD3-D74xWfdVqQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*e1rKTK53sD3-D74xWfdVqQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*e1rKTK53sD3-D74xWfdVqQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*e1rKTK53sD3-D74xWfdVqQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*e1rKTK53sD3-D74xWfdVqQ.png 1100w, https://miro.medium.com/v2/resize:fit:778/format:webp/1*e1rKTK53sD3-D74xWfdVqQ.png 778w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 389px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*e1rKTK53sD3-D74xWfdVqQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*e1rKTK53sD3-D74xWfdVqQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*e1rKTK53sD3-D74xWfdVqQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*e1rKTK53sD3-D74xWfdVqQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*e1rKTK53sD3-D74xWfdVqQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*e1rKTK53sD3-D74xWfdVqQ.png 1100w, https://miro.medium.com/v2/resize:fit:778/1*e1rKTK53sD3-D74xWfdVqQ.png 778w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 389px"><img alt="" class="bi md pl c" width="389" height="59" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:389/1*e1rKTK53sD3-D74xWfdVqQ.png"></picture></div></figure><h3 id="42e1" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!notifReg</h3><p id="6700" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">A driver can register pre- and post-operation callbacks for registry events, such as when a key is read, created, or modified, using <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmregistercallback" rel="noopener ugc nofollow" target="_blank">nt!CmRegisterCallback</a>(<a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmregistercallbackex" rel="noopener ugc nofollow" target="_blank">Ex</a>)</code>. While this functionality isn’t as common as the types we discussed previously, it gives developers a way to prevent the modification of protected registry keys.</p><div class="xd xe xf xg ac r cv"><div class="xh xi xj xk xl m fm"><h2 class="xm b xn xo xp xq xr">Get Matt Hand’s stories in&nbsp;your&nbsp;inbox</h2></div><div class="cs m fm"><p class="bg b bh ab eb">Join Medium for free to get updates from&nbsp;this&nbsp;writer.</p></div><div class="xv vd xw xx vc xy ac"><span class="bg b bh ab bl"><div class="xz ac cv"><div class="ac xz fj fi bq ya yb de lq yc yd ye yf yg yh yi"><input class="yj al aj an yk yl gd le bm ym bi" placeholder="Enter your email" type="text" value=""></div></div></span><div class="i l vt cb"><div class="xs xt xu"><button class="bg b bh ab yn uj yo yp yq yr ys fc fd yt yu yv fh fi fj fk bn fl fm">Subscribe</button></div></div><div class="bi k j e"><button class="bg b bh ab yn uj yo yp yq yr ys fc fd yt yu yv fh bi fi fj fk bn fl fm">Subscribe</button></div></div><div class="uh m"><div id="g-recaptcha"></div></div></div><p id="5dd4" class="pw-post-body-paragraph mw mx hl my b mz nb nc nd nf ng nh nj nk nl nn no np nr ns xg nt he bl" data-selectable-paragraph="">This module is simpler than the previous 3 in that it really centers around <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_notify.c#L302" rel="noopener ugc nofollow" target="_blank">finding and working with</a> a single undocumented structure. Mimidrv searches for the address to <code class="de nv nw nx ny b"><a class="ah nu" href="https://www.codemachine.com/article_kernelstruct.html" rel="noopener ugc nofollow" target="_blank">nt!CallbackListHead</a></code>, which is a doubly-linked list that contains the pointer to the address of the registry notification callback routine. This structure can be documented as:</p><figure class="pf pg ph pi pj pk"><div class="pm ga m fr"><div class="pn po m"><div src="https://medium.com/media/f47c17bae035327884d1562fbe792f0f" allowfullscreen="" frameborder="0" height="0" width="0" title="Registry callback at CallbackListHead" class="fw o gz ed bi" scrolling="no" data-original-tag="iframe"><title>Registry callback at CallbackListHead – Medium</title><base target="_blank"><link rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-8703547f549b05ef.css"><div id="gist100318275" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-_reg_callback-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="_REG_CALLBACK.c content, created by matterpreter on 01:42PM on December 31, 2019.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://medium.com/@matterpreter/mimidrv-in-depth-4d273d19e148" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="_REG_CALLBACK.c">
        <tbody><tr>
          <td id="file-_reg_callback-c-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-_reg_callback-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> <span class="pl-smi">_CMREG_CALLBACK</span> {</td>
        </tr>
        <tr>
          <td id="file-_reg_callback-c-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-_reg_callback-c-LC2" class="blob-code blob-code-inner js-file-line">    <span class="pl-smi">LIST_ENTRY</span> <span class="pl-c1">List</span>;</td>
        </tr>
        <tr>
          <td id="file-_reg_callback-c-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-_reg_callback-c-LC3" class="blob-code blob-code-inner js-file-line">    <span class="pl-smi">ULONG</span> <span class="pl-c1">Unknown1</span>;</td>
        </tr>
        <tr>
          <td id="file-_reg_callback-c-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-_reg_callback-c-LC4" class="blob-code blob-code-inner js-file-line">    <span class="pl-smi">ULONG</span> <span class="pl-c1">Unknown2</span>;</td>
        </tr>
        <tr>
          <td id="file-_reg_callback-c-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-_reg_callback-c-LC5" class="blob-code blob-code-inner js-file-line">    <span class="pl-smi">LARGE_INTEGER</span> <span class="pl-c1">Cookie</span>;</td>
        </tr>
        <tr>
          <td id="file-_reg_callback-c-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-_reg_callback-c-LC6" class="blob-code blob-code-inner js-file-line">    <span class="pl-smi">PVOID</span> <span class="pl-c1">Unknown3</span>;</td>
        </tr>
        <tr>
          <td id="file-_reg_callback-c-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-_reg_callback-c-LC7" class="blob-code blob-code-inner js-file-line">    <span class="pl-smi">PEX_CALLBACK_FUNCTION</span> <span class="pl-c1">Function</span>;</td>
        </tr>
        <tr>
          <td id="file-_reg_callback-c-L8" class="blob-num js-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-_reg_callback-c-LC8" class="blob-code blob-code-inner js-file-line">} <span class="pl-smi">CMREG_CALLBACK</span>, <span class="pl-c1">*</span><span class="pl-smi">PCMREG_CALLBACK</span>;</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/matterpreter/c2d251f33fccc1d2d4d4cd9db40b6cc0/raw/8939031e28f8bab79b8b2aa3b5b7fbac50c1f1c2/_REG_CALLBACK.c" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/matterpreter/c2d251f33fccc1d2d4d4cd9db40b6cc0#file-_reg_callback-c" class="Link--inTextBlock">
          _REG_CALLBACK.c
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></div></div></figure><p id="550c" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">At the offset <code class="de nv nw nx ny b">0x28</code> in this structure is the address of the registered callback routine.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd sw"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*nqKiij9mukIyL51Ff4HuFQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*nqKiij9mukIyL51Ff4HuFQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*nqKiij9mukIyL51Ff4HuFQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*nqKiij9mukIyL51Ff4HuFQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*nqKiij9mukIyL51Ff4HuFQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*nqKiij9mukIyL51Ff4HuFQ.png 1100w, https://miro.medium.com/v2/resize:fit:942/format:webp/1*nqKiij9mukIyL51Ff4HuFQ.png 942w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 471px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*nqKiij9mukIyL51Ff4HuFQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*nqKiij9mukIyL51Ff4HuFQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*nqKiij9mukIyL51Ff4HuFQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*nqKiij9mukIyL51Ff4HuFQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*nqKiij9mukIyL51Ff4HuFQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*nqKiij9mukIyL51Ff4HuFQ.png 1100w, https://miro.medium.com/v2/resize:fit:942/1*nqKiij9mukIyL51Ff4HuFQ.png 942w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 471px"><img alt="" class="bi md pl c" width="471" height="104" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:471/1*nqKiij9mukIyL51Ff4HuFQ.png"></picture></div></figure><p id="df1a" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Mimidrv simply <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_notify.c#L320" rel="noopener ugc nofollow" target="_blank">iterates through the linked list</a> getting the callback function addresses and passing them to <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_notify.c#L324" rel="noopener ugc nofollow" target="_blank">kkll_m_modules_fromAddr</a></code> to get the offset of the function in its driver.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd sv"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*gXy2Oh8X87wTGz_cFiegqw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*gXy2Oh8X87wTGz_cFiegqw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*gXy2Oh8X87wTGz_cFiegqw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*gXy2Oh8X87wTGz_cFiegqw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*gXy2Oh8X87wTGz_cFiegqw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*gXy2Oh8X87wTGz_cFiegqw.png 1100w, https://miro.medium.com/v2/resize:fit:778/format:webp/1*gXy2Oh8X87wTGz_cFiegqw.png 778w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 389px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*gXy2Oh8X87wTGz_cFiegqw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*gXy2Oh8X87wTGz_cFiegqw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*gXy2Oh8X87wTGz_cFiegqw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*gXy2Oh8X87wTGz_cFiegqw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*gXy2Oh8X87wTGz_cFiegqw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*gXy2Oh8X87wTGz_cFiegqw.png 1100w, https://miro.medium.com/v2/resize:fit:778/1*gXy2Oh8X87wTGz_cFiegqw.png 778w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 389px"><img alt="" class="bi md pl c" width="389" height="45" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:389/1*gXy2Oh8X87wTGz_cFiegqw.png"></picture></div></figure><h3 id="a4c1" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!notifObject</h3><blockquote class="pu pv pw"><p id="8aff" class="mw mx px my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph=""><strong class="my hm">Note: </strong>This command is not working in release 2.2.0 2019122 against Win10 1903 and returns 0x490 (ERROR_NOT_FOUND) when calling <code class="de nv nw nx ny b">kernel32!DeviceIoControl</code>, likely due to not being able to find the address of <code class="de nv nw nx ny b">nt!ObTypeDirectoryObject</code>. I will update this section if it is modified and working again.</p></blockquote><p id="2d37" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Finally, a driver can <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-obregistercallbacks" rel="noopener ugc nofollow" target="_blank">register a callback</a> to receive notifications when there are attempts to open or duplicate handles to processes, threads, or <a class="ah nu" href="https://techcommunity.microsoft.com/t5/Ask-The-Performance-Team/Sessions-Desktops-and-Windows-Stations/ba-p/372473" rel="noopener ugc nofollow" target="_blank">desktops</a>, such as in the event of token stealing. This is useful for many different types of software, and is used by AVG’s driver to <a class="ah nu" href="https://blog.xpnsec.com/anti-debug-openprocess/" rel="noopener ugc nofollow" target="_blank">protect its user mode processes from being debugged</a>.</p><p id="0609" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">These callbacks can be either <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/writing-preoperation-and-postoperation-callback-routines" rel="noopener ugc nofollow" target="_blank">pre-operation or post-operation</a>. Pre-operation callbacks allow the driver to modify the requested handle, such as the requested access, before the operation which returns a handle is complete. A post-operation callback allows the driver to perform some action after the operation has completed.</p><p id="d7a1" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Mimidrv first <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_notify.c#L90" rel="noopener ugc nofollow" target="_blank">searches</a> for the address of <code class="de nv nw nx ny b">nt!ObpTypeDirectoryObject</code>, which holds a pointer to the <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_notify.h#L21" rel="noopener ugc nofollow" target="_blank">OBJECT_DIRECTORY</a></code> structure.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd sx"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*NVzjz54XCKBKs4TtA7jE_A.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*NVzjz54XCKBKs4TtA7jE_A.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*NVzjz54XCKBKs4TtA7jE_A.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*NVzjz54XCKBKs4TtA7jE_A.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*NVzjz54XCKBKs4TtA7jE_A.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NVzjz54XCKBKs4TtA7jE_A.png 1100w, https://miro.medium.com/v2/resize:fit:1212/format:webp/1*NVzjz54XCKBKs4TtA7jE_A.png 1212w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 606px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*NVzjz54XCKBKs4TtA7jE_A.png 640w, https://miro.medium.com/v2/resize:fit:720/1*NVzjz54XCKBKs4TtA7jE_A.png 720w, https://miro.medium.com/v2/resize:fit:750/1*NVzjz54XCKBKs4TtA7jE_A.png 750w, https://miro.medium.com/v2/resize:fit:786/1*NVzjz54XCKBKs4TtA7jE_A.png 786w, https://miro.medium.com/v2/resize:fit:828/1*NVzjz54XCKBKs4TtA7jE_A.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*NVzjz54XCKBKs4TtA7jE_A.png 1100w, https://miro.medium.com/v2/resize:fit:1212/1*NVzjz54XCKBKs4TtA7jE_A.png 1212w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 606px"><img alt="" class="bi md pl c" width="606" height="149" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:606/1*NVzjz54XCKBKs4TtA7jE_A.png"></picture></div></figure><p id="9e41" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">The “HashBuckets” member of this structure is a linked list of <code class="de nv nw nx ny b">OBJECT_DIRECTORY_ENTRY</code> structures, each containing an object value at offset <code class="de nv nw nx ny b">0x8</code>.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd sy"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*N4IpJ75-qsKaba0BdmxESQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*N4IpJ75-qsKaba0BdmxESQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*N4IpJ75-qsKaba0BdmxESQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*N4IpJ75-qsKaba0BdmxESQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*N4IpJ75-qsKaba0BdmxESQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*N4IpJ75-qsKaba0BdmxESQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N4IpJ75-qsKaba0BdmxESQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*N4IpJ75-qsKaba0BdmxESQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*N4IpJ75-qsKaba0BdmxESQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*N4IpJ75-qsKaba0BdmxESQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*N4IpJ75-qsKaba0BdmxESQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*N4IpJ75-qsKaba0BdmxESQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*N4IpJ75-qsKaba0BdmxESQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*N4IpJ75-qsKaba0BdmxESQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="134" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*N4IpJ75-qsKaba0BdmxESQ.png"></picture></div></div></figure><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd sz"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*0-ETqfjp9CH46LGvDT2z1A.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*0-ETqfjp9CH46LGvDT2z1A.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*0-ETqfjp9CH46LGvDT2z1A.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*0-ETqfjp9CH46LGvDT2z1A.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*0-ETqfjp9CH46LGvDT2z1A.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*0-ETqfjp9CH46LGvDT2z1A.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0-ETqfjp9CH46LGvDT2z1A.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*0-ETqfjp9CH46LGvDT2z1A.png 640w, https://miro.medium.com/v2/resize:fit:720/1*0-ETqfjp9CH46LGvDT2z1A.png 720w, https://miro.medium.com/v2/resize:fit:750/1*0-ETqfjp9CH46LGvDT2z1A.png 750w, https://miro.medium.com/v2/resize:fit:786/1*0-ETqfjp9CH46LGvDT2z1A.png 786w, https://miro.medium.com/v2/resize:fit:828/1*0-ETqfjp9CH46LGvDT2z1A.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*0-ETqfjp9CH46LGvDT2z1A.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*0-ETqfjp9CH46LGvDT2z1A.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="59" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*0-ETqfjp9CH46LGvDT2z1A.png"></picture></div></div></figure><p id="fb79" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Each of these Objects are <code class="de nv nw nx ny b">OBJECT_TYPE</code> structures containing details about the specific type of object (processes, tokens, etc.) which are more easily viewed with WinDbg’s <code class="de nv nw nx ny b">!object</code> extension. The Hash number is the index in the HashBucket above.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd ta"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*nrMGslav22vyhsGMhaQYXQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*nrMGslav22vyhsGMhaQYXQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*nrMGslav22vyhsGMhaQYXQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*nrMGslav22vyhsGMhaQYXQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*nrMGslav22vyhsGMhaQYXQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*nrMGslav22vyhsGMhaQYXQ.png 1100w, https://miro.medium.com/v2/resize:fit:1116/format:webp/1*nrMGslav22vyhsGMhaQYXQ.png 1116w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 558px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*nrMGslav22vyhsGMhaQYXQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*nrMGslav22vyhsGMhaQYXQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*nrMGslav22vyhsGMhaQYXQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*nrMGslav22vyhsGMhaQYXQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*nrMGslav22vyhsGMhaQYXQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*nrMGslav22vyhsGMhaQYXQ.png 1100w, https://miro.medium.com/v2/resize:fit:1116/1*nrMGslav22vyhsGMhaQYXQ.png 1116w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 558px"><img alt="" class="bi md pl c" width="558" height="182" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:558/1*nrMGslav22vyhsGMhaQYXQ.png"></picture></div></figure><p id="213f" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Mimidrv then <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/68ac65b426d1b9e1354dd0365676b1ead15022de/mimidrv/kkll_m_notify.c#L382" rel="noopener ugc nofollow" target="_blank">extracts</a> the <code class="de nv nw nx ny b">Name</code> member from the <code class="de nv nw nx ny b">OBJECT_TYPE</code> structure.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd co"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 1100w, https://miro.medium.com/v2/resize:fit:1360/format:webp/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 1360w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 680px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 1100w, https://miro.medium.com/v2/resize:fit:1360/1*Hn0a2xSwk0z4SL_DOxNHIQ.png 1360w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 680px"><img alt="" class="bi md pl c" width="680" height="217" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:680/1*Hn0a2xSwk0z4SL_DOxNHIQ.png"></picture></div></figure><p id="46b6" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">The other member of note is CallbackList, which defines a list of pre- and post-operation callbacks which have been registered by <code class="de nv nw nx ny b"><a class="ah nu" href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff558692(v=vs.85).aspx" rel="noopener ugc nofollow" target="_blank">nt!ObRegisterCallbacks</a></code>. It is a <code class="de nv nw nx ny b">LIST_ENTRY</code> structure that points to the <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_notify.h#L31" rel="noopener ugc nofollow" target="_blank">undocumented </a><code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_notify.h#L31" rel="noopener ugc nofollow" target="_blank">CALLBACK_ENTRY_ITEM</a></code><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_notify.h#L31" rel="noopener ugc nofollow" target="_blank"> structure</a>. Mimidrv iterates through the linked list of <code class="de nv nw nx ny b">CALLBACK_ENTRY_ITEM</code> structures, passing each one to <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/68ac65b426d1b9e1354dd0365676b1ead15022de/mimidrv/kkll_m_notify.c#L404" rel="noopener ugc nofollow" target="_blank">kkll_m_notify_desc_object_callback</a></code> where the pointer from the pre-/post-operation callback is <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/68ac65b426d1b9e1354dd0365676b1ead15022de/mimidrv/kkll_m_notify.c#L410" rel="noopener ugc nofollow" target="_blank">extracted</a> and passed to <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_modules.c#L35" rel="noopener ugc nofollow" target="_blank">kkll_m_modules_fromAddr</a></code> in order to find the offset in the driver that the callback belongs to.</p><p id="62da" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Finally, Mimidrv loops through an array of 8 object methods starting from the <code class="de nv nw nx ny b">OBJECT_TYPE + 0x70</code>. If a pointer is set, Mimidrv passes it to <code class="de nv nw nx ny b">kkll_m_modules_fromAddr</code> to get the address of the object method and returns it to the user. This can be seen in the example below for the Process object type.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd tb"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*U9V_4cx9exuw-Laqj4rahw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*U9V_4cx9exuw-Laqj4rahw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*U9V_4cx9exuw-Laqj4rahw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*U9V_4cx9exuw-Laqj4rahw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*U9V_4cx9exuw-Laqj4rahw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*U9V_4cx9exuw-Laqj4rahw.png 1100w, https://miro.medium.com/v2/resize:fit:892/format:webp/1*U9V_4cx9exuw-Laqj4rahw.png 892w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 446px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*U9V_4cx9exuw-Laqj4rahw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*U9V_4cx9exuw-Laqj4rahw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*U9V_4cx9exuw-Laqj4rahw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*U9V_4cx9exuw-Laqj4rahw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*U9V_4cx9exuw-Laqj4rahw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*U9V_4cx9exuw-Laqj4rahw.png 1100w, https://miro.medium.com/v2/resize:fit:892/1*U9V_4cx9exuw-Laqj4rahw.png 892w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 446px"><img alt="" class="bi md pl c" width="446" height="178" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:446/1*U9V_4cx9exuw-Laqj4rahw.png"></picture></div><figcaption class="tc fm td pc pd te tf bg b bh ab eb" data-selectable-paragraph="">Object Method Pointers for the Process Object Type</figcaption></figure><p id="e8d4" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">While this function is not working on the latest release of Windows 10, the output would be similar to this:</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd tg"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*HHW_vJO4t0MQ6qW4PBT3ow.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*HHW_vJO4t0MQ6qW4PBT3ow.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*HHW_vJO4t0MQ6qW4PBT3ow.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*HHW_vJO4t0MQ6qW4PBT3ow.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*HHW_vJO4t0MQ6qW4PBT3ow.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*HHW_vJO4t0MQ6qW4PBT3ow.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HHW_vJO4t0MQ6qW4PBT3ow.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*HHW_vJO4t0MQ6qW4PBT3ow.png 640w, https://miro.medium.com/v2/resize:fit:720/1*HHW_vJO4t0MQ6qW4PBT3ow.png 720w, https://miro.medium.com/v2/resize:fit:750/1*HHW_vJO4t0MQ6qW4PBT3ow.png 750w, https://miro.medium.com/v2/resize:fit:786/1*HHW_vJO4t0MQ6qW4PBT3ow.png 786w, https://miro.medium.com/v2/resize:fit:828/1*HHW_vJO4t0MQ6qW4PBT3ow.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*HHW_vJO4t0MQ6qW4PBT3ow.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*HHW_vJO4t0MQ6qW4PBT3ow.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="275" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*HHW_vJO4t0MQ6qW4PBT3ow.png"></picture></div></div><figcaption class="tc fm td pc pd te tf bg b bh ab eb" data-selectable-paragraph="">Source: <a class="ah nu" href="https://www.slideshare.net/ASF-WS/asfws-2014-rump-session" rel="noopener ugc nofollow" target="_blank">https://www.slideshare.net/ASF-WS/asfws-2014-rump-session</a></figcaption></figure></div></div></div><div class="ac ci ra rb rc rd" role="separator"><span class="re by bn rf rg rh"></span><span class="re by bn rf rg rh"></span><span class="re by bn rf rg"></span></div><div class="he hf hg hh hi"><div class="ac ci"><div class="cp bi gq gr gs gt"><h2 id="66b8" class="nz oa hl bg ob oc ri oe of og rj oi oj ok rk om on oo rl oq or os rm ou ov ow bl" data-selectable-paragraph="">Modules</h2><p id="263f" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">While this section only contains 1 command, it also contains another core kernel concept — memory pools. Memory pools are kernel objects that allow chunks of memory to be allocated from a designated memory region, either paged or nonpaged. Each of these types has a specific use case.</p><p id="c08c" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">The paged pool is virtual memory that can be paged in/out (i.e. read/written) to the page file on disk, <code class="de nv nw nx ny b">C:\pagefile.sys</code>). This is the recommended pool for drivers to use.</p><p id="a40d" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">The nonpaged pool can’t be paged out and will always live in RAM. This is required in specific situations where page faults can’t be tolerated, such as when processing <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/introduction-to-interrupt-service-routines" rel="noopener ugc nofollow" target="_blank">Interrupt Service Routines (ISRs)</a> and during<a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/introduction-to-dpc-objects" rel="noopener ugc nofollow" target="_blank"> Deferred Procedure Calls (DPCs)</a>.</p><p id="9e97" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Here’s an example of a standard allocation of paged pool memory:</p><figure class="pf pg ph pi pj pk"><div class="pm ga m fr"><div class="pn po m"><div src="https://medium.com/media/60df82bcfaa7d8692bb2736e2918dd1b" allowfullscreen="" frameborder="0" height="0" width="0" title="Example of allocating a freeing memory in the kernel" class="fw o gz ed bi" scrolling="no" data-original-tag="iframe"><title>Example of allocating a freeing memory in the kernel – Medium</title><base target="_blank"><link rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-8703547f549b05ef.css"><div id="gist99979624" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-kernelmemoryalloc-c" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="KernelMemoryAlloc.c content, created by matterpreter on 01:39AM on December 11, 2019.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://medium.com/@matterpreter/mimidrv-in-depth-4d273d19e148" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="KernelMemoryAlloc.c">
        <tbody><tr>
          <td id="file-kernelmemoryalloc-c-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-kernelmemoryalloc-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">#define</span> <span class="pl-c1">POOL_TAG</span> 'TTAM'</td>
        </tr>
        <tr>
          <td id="file-kernelmemoryalloc-c-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-kernelmemoryalloc-c-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-smi">ULONG</span> <span class="pl-s1">size</span> <span class="pl-c1">=</span> <span class="pl-c1">512</span>;</td>
        </tr>
        <tr>
          <td id="file-kernelmemoryalloc-c-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-kernelmemoryalloc-c-LC3" class="blob-code blob-code-inner js-file-line"><span class="pl-smi">VOID</span> <span class="pl-s1">ptr</span><span class="pl-c1">*</span>;</td>
        </tr>
        <tr>
          <td id="file-kernelmemoryalloc-c-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-kernelmemoryalloc-c-LC4" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-kernelmemoryalloc-c-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-kernelmemoryalloc-c-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-s1">ptr</span> <span class="pl-c1">=</span> <span class="pl-en">ExAllocatePoolWithTag</span>(<span class="pl-s1">PagedPool</span>, <span class="pl-s1">size</span>, <span class="pl-c1">POOL_TAG</span>); <span class="pl-c">//Allocate 512 bytes from the paged pool</span></td>
        </tr>
        <tr>
          <td id="file-kernelmemoryalloc-c-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-kernelmemoryalloc-c-LC6" class="blob-code blob-code-inner js-file-line"><span class="pl-en">KdPrint</span>((<span class="pl-s">"Paged memory allocated at %x\n"</span>,(<span class="pl-smi">int</span><span class="pl-c1">*</span>)<span class="pl-s1">s</span>)); <span class="pl-c">//Print the address of the pointer to our allocated memory</span></td>
        </tr>
        <tr>
          <td id="file-kernelmemoryalloc-c-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-kernelmemoryalloc-c-LC7" class="blob-code blob-code-inner js-file-line"><span class="pl-en">ExFreePoolWithTag</span>(<span class="pl-s1">ptr</span>, <span class="pl-c1">POOL_TAG</span>) <span class="pl-c">//Free the memory</span></td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/matterpreter/f5f582d023a501d64624c18621acfd88/raw/25124267c400d85239883e50995b74e9884202c6/KernelMemoryAlloc.c" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/matterpreter/f5f582d023a501d64624c18621acfd88#file-kernelmemoryalloc-c" class="Link--inTextBlock">
          KernelMemoryAlloc.c
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></div></div></figure><p id="1a0e" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">The last item to note is the third and final parameter of <code class="de nv nw nx ny b">nt!ExAllocatePoolWithTag</code>, the pool tag. This is typically a unique 4-byte ASCII value and is used to help track down drivers with memory leaks. In the example above, the memory would be tagged with “MATT” (the tag is little endian). Mimidrv uses the pool tag “kiwi”, which would be shown as “iwik”, as seen in Pavel Yosifovich’s <a class="ah nu" href="https://github.com/zodiacon/AllTools/blob/master/PoolMonXv2.exe" rel="noopener ugc nofollow" target="_blank">PoolMonX</a> below.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd th"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*qQ2H1fHefd9ZjB21S3gqrw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*qQ2H1fHefd9ZjB21S3gqrw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*qQ2H1fHefd9ZjB21S3gqrw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*qQ2H1fHefd9ZjB21S3gqrw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*qQ2H1fHefd9ZjB21S3gqrw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*qQ2H1fHefd9ZjB21S3gqrw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qQ2H1fHefd9ZjB21S3gqrw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*qQ2H1fHefd9ZjB21S3gqrw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*qQ2H1fHefd9ZjB21S3gqrw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*qQ2H1fHefd9ZjB21S3gqrw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*qQ2H1fHefd9ZjB21S3gqrw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*qQ2H1fHefd9ZjB21S3gqrw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*qQ2H1fHefd9ZjB21S3gqrw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*qQ2H1fHefd9ZjB21S3gqrw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="113" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*qQ2H1fHefd9ZjB21S3gqrw.png"></picture></div></div></figure><h3 id="19e6" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!modules</h3><p id="3a88" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The <code class="de nv nw nx ny b">!modules</code> command lists details about drivers loaded on the system. This command primarily centers around the <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/aux_klib/nf-aux_klib-auxklibquerymoduleinformation" rel="noopener ugc nofollow" target="_blank">aux_klib!AuxKlibQueryModuleInformation</a></code> function.</p><p id="87df" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Mimidrv <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_modules.c#L15" rel="noopener ugc nofollow" target="_blank">first</a> uses <code class="de nv nw nx ny b">aux_klib!AuxKlibQueryModuleInformation</code> to get the total amount of memory it will need to allocate in order to hold the <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/aux_klib/ns-aux_klib-_aux_module_extended_info" rel="noopener ugc nofollow" target="_blank">AUX_MODULE_EXTENDED_INFO</a></code><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/aux_klib/ns-aux_klib-_aux_module_extended_info" rel="noopener ugc nofollow" target="_blank"> structs</a> containing the module information. Once it receives that, it will use <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_modules.c#L18" rel="noopener ugc nofollow" target="_blank">nt!ExAllocatePoolWithTag</a></code> to allocate the required amount of memory from the paged pool using its pool tag, “kiwi”.</p><p id="4632" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Some <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_modules.c#L20" rel="noopener ugc nofollow" target="_blank">quick math</a> happens to determine the number of images loaded by dividing the size returned by the first call to <code class="de nv nw nx ny b">aux_klib!AuxKlibQueryModuleInformation</code> by the size of the <code class="de nv nw nx ny b">AUX_MODULE_EXTENDED_INFO</code> struct. A subsequent call to <code class="de nv nw nx ny b">aux_klib!AuxKlibQueryModuleInformation</code> is made to get all of the module information and store it for processing. Mimidrv then <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimidrv/kkll_m_modules.c#L22" rel="noopener ugc nofollow" target="_blank">iterates through this pool</a> of memory using the callback function <code class="de nv nw nx ny b">kkll_m_modules_list_callback</code> to copy the base address, image size, and file name into the output buffer which will be sent back to the user.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd ti"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*m7yil_2ItIBr5e-rvsPuew.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*m7yil_2ItIBr5e-rvsPuew.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*m7yil_2ItIBr5e-rvsPuew.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*m7yil_2ItIBr5e-rvsPuew.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*m7yil_2ItIBr5e-rvsPuew.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*m7yil_2ItIBr5e-rvsPuew.png 1100w, https://miro.medium.com/v2/resize:fit:930/format:webp/1*m7yil_2ItIBr5e-rvsPuew.png 930w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 465px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*m7yil_2ItIBr5e-rvsPuew.png 640w, https://miro.medium.com/v2/resize:fit:720/1*m7yil_2ItIBr5e-rvsPuew.png 720w, https://miro.medium.com/v2/resize:fit:750/1*m7yil_2ItIBr5e-rvsPuew.png 750w, https://miro.medium.com/v2/resize:fit:786/1*m7yil_2ItIBr5e-rvsPuew.png 786w, https://miro.medium.com/v2/resize:fit:828/1*m7yil_2ItIBr5e-rvsPuew.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*m7yil_2ItIBr5e-rvsPuew.png 1100w, https://miro.medium.com/v2/resize:fit:930/1*m7yil_2ItIBr5e-rvsPuew.png 930w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 465px"><img alt="" class="bi md pl c" width="465" height="149" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:465/1*m7yil_2ItIBr5e-rvsPuew.png"></picture></div></figure></div></div></div><div class="ac ci ra rb rc rd" role="separator"><span class="re by bn rf rg rh"></span><span class="re by bn rf rg rh"></span><span class="re by bn rf rg"></span></div><div class="he hf hg hh hi"><div class="ac ci"><div class="cp bi gq gr gs gt"><h2 id="bb06" class="nz oa hl bg ob oc ri oe of og rj oi oj ok rk om on oo rl oq or os rm ou ov ow bl" data-selectable-paragraph="">Filters</h2><p id="87b9" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">While we have primarily been exploring software drivers, there are 2 other types, filters and minifilters, that Mimidrv allows use to interact with.</p><p id="b771" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Filter drivers are considered legacy but are still supported. There are many types of filter drivers, but they all serve to <a class="ah nu" href="https://www-user.tu-chemnitz.de/~heha/oney_wdm/ch09b.htm" rel="noopener ugc nofollow" target="_blank">expand the functionality of devices</a> by filtering IRPs. Different subclasses of filter drivers exist to serve specific jobs, such as file system filter drives and network filter drivers. Example of a file system filter driver would be an antivirus engine, backup agent, or an encryption agent.</p><p id="1d2e" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">The most common filter driver you will see is <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/filter-manager-and-minifilter-driver-architecture" rel="noopener ugc nofollow" target="_blank">FltMgr.sys</a>, which exposes functionality required by filesystem filters so that developers can more easily develop minifilter drivers.</p><p id="f2d2" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Minifilter drivers are Microsoft’s recommendation for filter driver development and include some <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/advantages-of-the-filter-manager-model" rel="noopener ugc nofollow" target="_blank">distinct advantages</a>, including being able to be unloaded without a reboot and reduced code complexity. These types of drivers are more common than legacy filter drivers and can be listed/managed with <code class="de nv nw nx ny b">fltmc.exe</code>.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd tj"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*xxphobOFoIS-kuM6lQyTyg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*xxphobOFoIS-kuM6lQyTyg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*xxphobOFoIS-kuM6lQyTyg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*xxphobOFoIS-kuM6lQyTyg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*xxphobOFoIS-kuM6lQyTyg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*xxphobOFoIS-kuM6lQyTyg.png 1100w, https://miro.medium.com/v2/resize:fit:1080/format:webp/1*xxphobOFoIS-kuM6lQyTyg.png 1080w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 540px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*xxphobOFoIS-kuM6lQyTyg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*xxphobOFoIS-kuM6lQyTyg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*xxphobOFoIS-kuM6lQyTyg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*xxphobOFoIS-kuM6lQyTyg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*xxphobOFoIS-kuM6lQyTyg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*xxphobOFoIS-kuM6lQyTyg.png 1100w, https://miro.medium.com/v2/resize:fit:1080/1*xxphobOFoIS-kuM6lQyTyg.png 1080w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 540px"><img alt="" class="bi md pl c" width="540" height="246" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:540/1*xxphobOFoIS-kuM6lQyTyg.png"></picture></div></figure><p id="9b64" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">The biggest difference between these 2 types in the context of Mimidrv is that minifilter drivers are <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/loading-and-unloading" rel="noopener ugc nofollow" target="_blank">managed</a> via the <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/fltkernel/" rel="noopener ugc nofollow" target="_blank">Filter Manager APIs</a>.</p><h3 id="6dfa" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!filters</h3><p id="7aa9" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The <code class="de nv nw nx ny b">!filters</code> command works almost exactly the same as the <code class="de nv nw nx ny b">!modules</code> command, but instead leverages <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ioenumerateregisteredfilterslist" rel="noopener ugc nofollow" target="_blank">nt!IoEnumerateRegisteredFiltersList</a></code> to get a list of registered filesystem filter drivers on the system, stores them in a <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_driver_object" rel="noopener ugc nofollow" target="_blank">DRIVER_OBJECT</a></code> struct, and prints out the index of the driver as well as the <code class="de nv nw nx ny b">DriverName</code> member.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd tk"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*hEOpeTLVW8Q27UzN7fhICQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*hEOpeTLVW8Q27UzN7fhICQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*hEOpeTLVW8Q27UzN7fhICQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*hEOpeTLVW8Q27UzN7fhICQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*hEOpeTLVW8Q27UzN7fhICQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*hEOpeTLVW8Q27UzN7fhICQ.png 1100w, https://miro.medium.com/v2/resize:fit:382/format:webp/1*hEOpeTLVW8Q27UzN7fhICQ.png 382w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 191px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*hEOpeTLVW8Q27UzN7fhICQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*hEOpeTLVW8Q27UzN7fhICQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*hEOpeTLVW8Q27UzN7fhICQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*hEOpeTLVW8Q27UzN7fhICQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*hEOpeTLVW8Q27UzN7fhICQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*hEOpeTLVW8Q27UzN7fhICQ.png 1100w, https://miro.medium.com/v2/resize:fit:382/1*hEOpeTLVW8Q27UzN7fhICQ.png 382w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 191px"><img alt="" class="bi md pl c" width="191" height="43" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:191/1*hEOpeTLVW8Q27UzN7fhICQ.png"></picture></div></figure><h3 id="fa96" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!minifilters</h3><p id="22e9" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The <code class="de nv nw nx ny b">!minifilters</code> command displays the minifilter drivers registered on the system. This function is a little <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/68ac65b426d1b9e1354dd0365676b1ead15022de/mimidrv/kkll_m_filters.c#L102" rel="noopener ugc nofollow" target="_blank">tough to read</a>, but that’s because the functions Mimidrv needs to call have memory requirements that aren’t known at runtime, so it makes a request solely to get the amount of memory required, allocates that memory, and then makes the real request. To help understand what is going on, it is helpful to break down each step by primary function.</p><ol class=""><li id="b907" class="mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt rr qt qu bl" data-selectable-paragraph=""><strong class="my hm">FltEnumerateFilters</strong> — The first call is to <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/fltkernel/nf-fltkernel-fltenumeratefilters" rel="noopener ugc nofollow" target="_blank">fltmgr!FltEnumerateFilters</a></code>, which enumerates all registered minifilter drivers on the system and return a list of pointers.</li><li id="49e9" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt rr qt qu bl" data-selectable-paragraph=""><strong class="my hm">FltGetFilterInformation</strong> — Next, we iterate over this list of pointers, calling <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows/win32/api/fltuser/nf-fltuser-filtergetinformation" rel="noopener ugc nofollow" target="_blank">fltmgr!FltGetFilterInformation</a></code> to get a <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/fltuserstructures/ns-fltuserstructures-_filter_full_information" rel="noopener ugc nofollow" target="_blank">FILTER_FULL_INFORMATION</a></code> structure back, containing details about each of the minifilters.</li><li id="9bce" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt rr qt qu bl" data-selectable-paragraph=""><strong class="my hm">FltEnumerateInstances</strong> — For each of the minifilters, <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/fltkernel/nf-fltkernel-fltenumerateinstances" rel="noopener ugc nofollow" target="_blank">fltmgr!FltEnumerateInstances</a></code> is used to get a list of instance pointers.</li><li id="3e6b" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt rr qt qu bl" data-selectable-paragraph=""><strong class="my hm">FltGetVolumeFromInstance</strong> — Next, <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/fltkernel/nf-fltkernel-fltgetvolumefrominstance" rel="noopener ugc nofollow" target="_blank">fltmgr!FltGetVolumeFromInstance</a></code> is used to return the volume each minifilter is attached to (e.g. <code class="de nv nw nx ny b">\Device\HarddiskVolume4</code>). Note that minifilters can have multiple instances attached to different volumes.</li><li id="fdec" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt rr qt qu bl" data-selectable-paragraph=""><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/68ac65b426d1b9e1354dd0365676b1ead15022de/mimidrv/kkll_m_filters.c#L150" rel="noopener ugc nofollow" target="_blank"><strong class="my hm">Get details about pre- and post-operation callbacks</strong></a> — We’ll dig into this next.</li><li id="d8ea" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt rr qt qu bl" data-selectable-paragraph=""><strong class="my hm">FltObjectDereference</strong> — When all instances have been iterated through, <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/fltkernel/nf-fltkernel-fltobjectdereference" rel="noopener ugc nofollow" target="_blank">fltmgr!FltObjectDereference</a></code> is used to deference each instance and the list of minifilters.</li></ol><p id="21dc" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">As you can see, Mimidrv makes use of some pretty standard Filter Manager API functions. However, step 5 is a bit odd in that it gets information about the minifilter using hardcoded offsets and makes calls to <code class="de nv nw nx ny b">kkll_m_modules_fromAddr</code> to get offsets without much indiction of what we are looking at. In the output of <code class="de nv nw nx ny b">!minifilters</code>, there are addresses of <code class="de nv nw nx ny b">PreCallback</code> and/or <code class="de nv nw nx ny b">PostCallback</code>, but what are these?</p><p id="4a21" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Minifilter drivers <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/writing-preoperation-and-postoperation-callback-routines" rel="noopener ugc nofollow" target="_blank">may register up to 1 pre-operation callback and up to 1 post-operation callback for each operation that it needs to filter</a>. When the Filter Manager processes an I/O operation, it passes the request down the driver stack starting with the minifilter with the highest altitude that has <a class="ah nu" href="https://www.osr.com/nt-insider/2017-issue2/introduction-standard-isolation-minifilters/" rel="noopener ugc nofollow" target="_blank">registered a pre-operation callback</a>. This is the minifilter’s opportunity to act on the I/O operation before it is passed to the file system for completion. After the I/O operation is complete, the Filter Manager again passes down the driver stack for drivers with registered post-operation callbacks. Within these callbacks, the drivers can interact with the data, such as examining it or modifying it.</p><p id="661c" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">In order to understand what Mimidrv is parsing out, lets dig into an example from the output of <code class="de nv nw nx ny b">!minifilters</code> on my system, specifically for the Named Pipe Service Triggers driver, <code class="de nv nw nx ny b">npsvctrig.sys</code>.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd tl"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*UuzNdVOf8aS4UPP7JUEA_g.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*UuzNdVOf8aS4UPP7JUEA_g.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*UuzNdVOf8aS4UPP7JUEA_g.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*UuzNdVOf8aS4UPP7JUEA_g.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*UuzNdVOf8aS4UPP7JUEA_g.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*UuzNdVOf8aS4UPP7JUEA_g.png 1100w, https://miro.medium.com/v2/resize:fit:1038/format:webp/1*UuzNdVOf8aS4UPP7JUEA_g.png 1038w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 519px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*UuzNdVOf8aS4UPP7JUEA_g.png 640w, https://miro.medium.com/v2/resize:fit:720/1*UuzNdVOf8aS4UPP7JUEA_g.png 720w, https://miro.medium.com/v2/resize:fit:750/1*UuzNdVOf8aS4UPP7JUEA_g.png 750w, https://miro.medium.com/v2/resize:fit:786/1*UuzNdVOf8aS4UPP7JUEA_g.png 786w, https://miro.medium.com/v2/resize:fit:828/1*UuzNdVOf8aS4UPP7JUEA_g.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*UuzNdVOf8aS4UPP7JUEA_g.png 1100w, https://miro.medium.com/v2/resize:fit:1038/1*UuzNdVOf8aS4UPP7JUEA_g.png 1038w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 519px"><img alt="" class="bi md pl c" width="519" height="135" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:519/1*UuzNdVOf8aS4UPP7JUEA_g.png"></picture></div></figure><p id="5c1c" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">We’ll crack open WinDbg and first look for our registered filters.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd tm"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 1100w, https://miro.medium.com/v2/resize:fit:1114/format:webp/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 1114w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 557px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 1100w, https://miro.medium.com/v2/resize:fit:1114/1*xC0Z4LLAYhI0Xnm_vN-rxA.png 1114w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 557px"><img alt="" class="bi md pl c" width="557" height="433" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:557/1*xC0Z4LLAYhI0Xnm_vN-rxA.png"></picture></div></figure><p id="ef09" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Here we can see an instance of <code class="de nv nw nx ny b">npsvctrig</code> at address <code class="de nv nw nx ny b">0xffffc18f97e34cb0</code>. Inspecting the <code class="de nv nw nx ny b">FLT_INSTANCE</code> structure at this address shows the member <code class="de nv nw nx ny b">CallbackNodes</code> at offset <code class="de nv nw nx ny b">0x0a0</code>.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd tn"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*WHpe0CJFx_YSuC859ZrrMw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*WHpe0CJFx_YSuC859ZrrMw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*WHpe0CJFx_YSuC859ZrrMw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*WHpe0CJFx_YSuC859ZrrMw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*WHpe0CJFx_YSuC859ZrrMw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*WHpe0CJFx_YSuC859ZrrMw.png 1100w, https://miro.medium.com/v2/resize:fit:1358/format:webp/1*WHpe0CJFx_YSuC859ZrrMw.png 1358w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 679px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*WHpe0CJFx_YSuC859ZrrMw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*WHpe0CJFx_YSuC859ZrrMw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*WHpe0CJFx_YSuC859ZrrMw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*WHpe0CJFx_YSuC859ZrrMw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*WHpe0CJFx_YSuC859ZrrMw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*WHpe0CJFx_YSuC859ZrrMw.png 1100w, https://miro.medium.com/v2/resize:fit:1358/1*WHpe0CJFx_YSuC859ZrrMw.png 1358w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 679px"><img alt="" class="bi md pl c" width="679" height="247" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:679/1*WHpe0CJFx_YSuC859ZrrMw.png"></picture></div></figure><p id="00db" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">There are 3 <code class="de nv nw nx ny b">CALLBACK_NODE</code> structures (screenshot snipped for viewing).</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd to"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*lj4OajCHsuCYmunR3uteAg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*lj4OajCHsuCYmunR3uteAg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*lj4OajCHsuCYmunR3uteAg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*lj4OajCHsuCYmunR3uteAg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*lj4OajCHsuCYmunR3uteAg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*lj4OajCHsuCYmunR3uteAg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lj4OajCHsuCYmunR3uteAg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*lj4OajCHsuCYmunR3uteAg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*lj4OajCHsuCYmunR3uteAg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*lj4OajCHsuCYmunR3uteAg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*lj4OajCHsuCYmunR3uteAg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*lj4OajCHsuCYmunR3uteAg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*lj4OajCHsuCYmunR3uteAg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*lj4OajCHsuCYmunR3uteAg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="382" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*lj4OajCHsuCYmunR3uteAg.png"></picture></div></div></figure><p id="b79d" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Inspecting the first <code class="de nv nw nx ny b">CALLBACK_NODE</code> structure at <code class="de nv nw nx ny b">0xffffc18f97e34d50</code>, we can see the <code class="de nv nw nx ny b">PostOperation</code> attribute (offset <code class="de nv nw nx ny b">0x20</code>) has an address of <code class="de nv nw nx ny b">0xfffff8047e5f6010</code>, the same that was shown in Mimikatz for “<a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/68ac65b426d1b9e1354dd0365676b1ead15022de/mimidrv/kkll_m_filters.c#L71" rel="noopener ugc nofollow" target="_blank">CLOSE</a>”, which correlates to <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/irp-mj-close" rel="noopener ugc nofollow" target="_blank">IRP_MJ_CLOSE</a></code>. That means that this is a pointer to the post-operation callback’s address!</p></div></div><div class="pk"><div class="ac ci"><div class="ly sd lz se ma sf cm sg cn sh cp bi"><figure class="pf pg ph pi pj pk sj sk paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd tp"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*KWQ7_dILN--7qscETS2CCA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*KWQ7_dILN--7qscETS2CCA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*KWQ7_dILN--7qscETS2CCA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*KWQ7_dILN--7qscETS2CCA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*KWQ7_dILN--7qscETS2CCA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*KWQ7_dILN--7qscETS2CCA.png 1100w, https://miro.medium.com/v2/resize:fit:2000/format:webp/1*KWQ7_dILN--7qscETS2CCA.png 2000w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 1000px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*KWQ7_dILN--7qscETS2CCA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*KWQ7_dILN--7qscETS2CCA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*KWQ7_dILN--7qscETS2CCA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*KWQ7_dILN--7qscETS2CCA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*KWQ7_dILN--7qscETS2CCA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*KWQ7_dILN--7qscETS2CCA.png 1100w, https://miro.medium.com/v2/resize:fit:2000/1*KWQ7_dILN--7qscETS2CCA.png 2000w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 1000px"><img alt="" class="bi md pl c" width="1000" height="114" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:1000/1*KWQ7_dILN--7qscETS2CCA.png"></picture></div></div></figure></div></div></div><div class="ac ci"><div class="cp bi gq gr gs gt"><p id="c3fc" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">But what about the offset inside the driver show in the output? To get this for us, Mimidrv calls <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/68ac65b426d1b9e1354dd0365676b1ead15022de/mimidrv/kkll_m_filters.c#L163" rel="noopener ugc nofollow" target="_blank">kkll_m_modules_fromAddr</a></code>, which in turn calls <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_modules.c#L38" rel="noopener ugc nofollow" target="_blank">kkll_m_modules_enum</a></code>, which we walked through in the “<em class="px">Modules</em>” section, but this time with a callback function of <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_modules.c#L46" rel="noopener ugc nofollow" target="_blank">kkll_m_modules_fromAddr_callback</a></code>. This callback <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_modules.c#L55" rel="noopener ugc nofollow" target="_blank">returns the address of the callback, the filename of the driver excluding the path, and the offset of the address we provided from the image’s base address</a>.</p><p id="1bf8" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">If we take a quick look at the offset <code class="de nv nw nx ny b">0x6010</code> inside of <code class="de nv nw nx ny b">npsvctrig.sys</code>, we can see that it is the start of its <code class="de nv nw nx ny b">NptrigPostCreateCallback</code> function.</p></div></div><div class="pk"><div class="ac ci"><div class="ly sd lz se ma sf cm sg cn sh cp bi"><figure class="pf pg ph pi pj pk sj sk paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd tq"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*qEZj7N8jNjEfiLGRMUS2pg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*qEZj7N8jNjEfiLGRMUS2pg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*qEZj7N8jNjEfiLGRMUS2pg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*qEZj7N8jNjEfiLGRMUS2pg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*qEZj7N8jNjEfiLGRMUS2pg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*qEZj7N8jNjEfiLGRMUS2pg.png 1100w, https://miro.medium.com/v2/resize:fit:2000/format:webp/1*qEZj7N8jNjEfiLGRMUS2pg.png 2000w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 1000px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*qEZj7N8jNjEfiLGRMUS2pg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*qEZj7N8jNjEfiLGRMUS2pg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*qEZj7N8jNjEfiLGRMUS2pg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*qEZj7N8jNjEfiLGRMUS2pg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*qEZj7N8jNjEfiLGRMUS2pg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*qEZj7N8jNjEfiLGRMUS2pg.png 1100w, https://miro.medium.com/v2/resize:fit:2000/1*qEZj7N8jNjEfiLGRMUS2pg.png 2000w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 1000px"><img alt="" class="bi md pl c" width="1000" height="181" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:1000/1*qEZj7N8jNjEfiLGRMUS2pg.png"></picture></div></div></figure></div></div></div></div><div class="ac ci ra rb rc rd" role="separator"><span class="re by bn rf rg rh"></span><span class="re by bn rf rg rh"></span><span class="re by bn rf rg"></span></div><div class="he hf hg hh hi"><div class="ac ci"><div class="cp bi gq gr gs gt"><h2 id="d508" class="nz oa hl bg ob oc ri oe of og rj oi oj ok rk om on oo rl oq or os rm ou ov ow bl" data-selectable-paragraph="">Memory</h2><p id="c71b" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">These functions, while not implemented as commands available to the user, allow interaction with kernel memory and expose some interesting nuances to consider when working with memory in the kernel. These could be called by Mimikatz as they have correlating IOCTLs, so it is worth walking through what they do.</p><h3 id="6b51" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">kkll_m_memory_vm_read</h3><p id="b862" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">If the name didn’t give it away, this function could be used to read memory in the kernel. It is a very simple function but introduces 2 concepts we haven’t explored yet — Memory Descriptor Lists (MDLs) and page locking.</p><p id="dd83" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Virtual memory should be contiguous, but physical memory can be all over the place. <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/using-mdls" rel="noopener ugc nofollow" target="_blank">Windows uses MDLs</a> to describe the physical page layout for a virtual memory buffer which helps in describing and mapping memory properly.</p><p id="add3" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">In some cases we may need to access data quickly and directly and we don’t want the memory manager messing with that data (e.g. paging it to disk). To make sure that this doesn’t happen, we can use <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-mmprobeandlockpages" rel="noopener ugc nofollow" target="_blank">nt!MmProbeAndLockPages</a></code> to lock the physical pages mapped by the virtual pages in memory temporarily so they can’t be paged out. This function requires that an operation be specified when called which describes what will be done. These can be either <code class="de nv nw nx ny b">IoReadAccess</code>, <code class="de nv nw nx ny b">IoWriteAccess</code>, or <code class="de nv nw nx ny b">IoModifyAccess</code>. After the operation completes, <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-mmunlockpages" rel="noopener ugc nofollow" target="_blank">nt!MmUnlockPages</a></code> is used to unlock the pages.</p><p id="25f1" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">The 2 concepts make up most of <code class="de nv nw nx ny b">kkll_m_memory_vm_read</code>. A <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_memory.c#L48" rel="noopener ugc nofollow" target="_blank">MDL is allocated</a> using <code class="de nv nw nx ny b">nt!IoAllocateMdl</code>, <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_memory.c#L52" rel="noopener ugc nofollow" target="_blank">pages are locked</a> with the <code class="de nv nw nx ny b">nt!IoReadAccess</code> specified, <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlcopymemory" rel="noopener ugc nofollow" target="_blank">nt!RtlCopyMemory</a></code> is <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_memory.c#L53" rel="noopener ugc nofollow" target="_blank">used</a> to copy memory from the MDL to the output buffer, and then the pages are unlocked with a <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_memory.c#L55" rel="noopener ugc nofollow" target="_blank">call</a> to <code class="de nv nw nx ny b">nt!MmUnlockPages</code>. This allows us to read arbitrary memory from the kernel.</p><h3 id="86e0" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">kkll_m_memory_vm_write</h3><p id="6a74" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph=""><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_memory.c#L66" rel="noopener ugc nofollow" target="_blank">This function</a> is a mirror image of <code class="de nv nw nx ny b">kkll_m_memory_vm_read</code>, but the <code class="de nv nw nx ny b">Dest</code> and <code class="de nv nw nx ny b">From</code> parameters are switched as we are writing to an address described by the MDL as opposed to reading from it.</p><h3 id="cf21" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">kkll_m_memory_vm_alloc</h3><p id="a2ec" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_memory.c#L88" rel="noopener ugc nofollow" target="_blank">kkll_m_memory_vm_alloc</a></code> function allows for allocation of arbitrarily-sized memory from the non-paged pool by calling <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-exallocatepoolwithtag" rel="noopener ugc nofollow" target="_blank">nt!ExAllocatePoolWithTag</a></code>. and returns a pointer to the address where memory was allocated.</p><p id="8814" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">This could be used in place of some of the direct calls to <code class="de nv nw nx ny b">nt!ExAllocatePoolWithTag</code> in Mimidrv as it implements error checking which could make the code a little more stable and easier to read.</p><h3 id="11a1" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">kkll_m_memory_vm_free</h3><p id="910c" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">As with all other types of memory, non-paged pool memory must be freed. The <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_memory.c#L101" rel="noopener ugc nofollow" target="_blank">kkll_m_memory_vm_free</a></code> function does just that with a call to <code class="de nv nw nx ny b"><a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-exfreepoolwithtag" rel="noopener ugc nofollow" target="_blank">nt!ExFreePoolWithTag</a></code>.</p><p id="97bf" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Like the function above, this could be used in place of direct calls to <code class="de nv nw nx ny b">nt!ExFreePoolWithTag</code>, but isn’t currently being used by Mimidrv.</p></div></div></div><div class="ac ci ra rb rc rd" role="separator"><span class="re by bn rf rg rh"></span><span class="re by bn rf rg rh"></span><span class="re by bn rf rg"></span></div><div class="he hf hg hh hi"><div class="ac ci"><div class="cp bi gq gr gs gt"><h2 id="e36e" class="nz oa hl bg ob oc ri oe of og rj oi oj ok rk om on oo rl oq or os rm ou ov ow bl" data-selectable-paragraph="">SSDT</h2><p id="286d" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">When a user mode application needs to create a file by using <code class="de nv nw nx ny b">kernel32!CreateFile</code>, how is the disk accessed and storage allocated for the user? Accessing system resources is a function of the kernel but these resources are needed by user mode applications, so there needs to be a way to make requests to the kernel. Windows makes use of system calls, or syscalls, to make this possible.</p><p id="0ec6" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Under the hood, here’s a rough view of what <code class="de nv nw nx ny b">kernel32!CreateFile</code> is actually doing:</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd tr"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*OvGXRYroJuXGgtFqNTliRw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*OvGXRYroJuXGgtFqNTliRw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*OvGXRYroJuXGgtFqNTliRw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*OvGXRYroJuXGgtFqNTliRw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*OvGXRYroJuXGgtFqNTliRw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*OvGXRYroJuXGgtFqNTliRw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OvGXRYroJuXGgtFqNTliRw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*OvGXRYroJuXGgtFqNTliRw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*OvGXRYroJuXGgtFqNTliRw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*OvGXRYroJuXGgtFqNTliRw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*OvGXRYroJuXGgtFqNTliRw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*OvGXRYroJuXGgtFqNTliRw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*OvGXRYroJuXGgtFqNTliRw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*OvGXRYroJuXGgtFqNTliRw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="212" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*OvGXRYroJuXGgtFqNTliRw.png"></picture></div></div></figure><p id="825d" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Right at the boundary between user mode and kernel mode, you can see a call to <code class="de nv nw nx ny b">sysenter</code> (this could also be substituted for <code class="de nv nw nx ny b">syscall</code> <a class="ah nu" href="https://reverseengineering.stackexchange.com/a/16511" rel="noopener ugc nofollow" target="_blank">depending on the processor</a>), which is used to transfer from user mode to kernel mode. This instruction takes a number, specifically a system service number, in the EAX register which determines which system call to make. <a class="ah nu" href="https://twitter.com/j00ru" rel="noopener ugc nofollow" target="_blank">@j00ru</a> maintains a list of Windows syscalls and their service numbers on his <a class="ah nu" href="https://j00ru.vexillium.org/syscalls/nt/64/" rel="noopener ugc nofollow" target="_blank">blog</a>.</p><p id="1766" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">In our <code class="de nv nw nx ny b">kernel32!CreateFile</code> example, <code class="de nv nw nx ny b">ntdll!NtCreateFile</code> places <code class="de nv nw nx ny b">0x55</code> into EAX before the <code class="de nv nw nx ny b">SYSCALL</code> instruction.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd ts"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*NwWoh61UbXd8TRSdGhi9_Q.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*NwWoh61UbXd8TRSdGhi9_Q.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*NwWoh61UbXd8TRSdGhi9_Q.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*NwWoh61UbXd8TRSdGhi9_Q.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*NwWoh61UbXd8TRSdGhi9_Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NwWoh61UbXd8TRSdGhi9_Q.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NwWoh61UbXd8TRSdGhi9_Q.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*NwWoh61UbXd8TRSdGhi9_Q.png 640w, https://miro.medium.com/v2/resize:fit:720/1*NwWoh61UbXd8TRSdGhi9_Q.png 720w, https://miro.medium.com/v2/resize:fit:750/1*NwWoh61UbXd8TRSdGhi9_Q.png 750w, https://miro.medium.com/v2/resize:fit:786/1*NwWoh61UbXd8TRSdGhi9_Q.png 786w, https://miro.medium.com/v2/resize:fit:828/1*NwWoh61UbXd8TRSdGhi9_Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*NwWoh61UbXd8TRSdGhi9_Q.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*NwWoh61UbXd8TRSdGhi9_Q.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="191" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*NwWoh61UbXd8TRSdGhi9_Q.png"></picture></div></div></figure><p id="c7c5" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">On the <code class="de nv nw nx ny b">SYSCALL</code>, <code class="de nv nw nx ny b">KiSystemService</code> in ring 0 receives the request and looks up the system service function in the System Service Descriptor Table (SSDT), <code class="de nv nw nx ny b">KeServiceDescriptorTable</code>. The SSDT holds pointers to kernel functions, and in this case we are looking for <code class="de nv nw nx ny b">nt!NtCreateFile</code>.</p><p id="e0a7" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">In the past, rootkits would hook the SSDT and replace the pointer to kernel functions so that when system services were called, a function inside of their rootkit would be executed instead. Thankfully, Kernel Patch Protection (KPP/PatchGuard) protects <a class="ah nu" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/bug-check-0x109---critical-structure-corruption" rel="noopener ugc nofollow" target="_blank">critical kernel structures</a>, such as the SSDT, from modification so this technique does not work on modern x64 systems.</p><h3 id="a95e" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">!ssdt</h3><p id="1c23" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">The <code class="de nv nw nx ny b">!ssdt</code> command locates the <code class="de nv nw nx ny b">KeServiceDescriptorTable</code> in memory by searching for an OS version-specific pattern (<code class="de nv nw nx ny b">0xd3, 0x41, 0x3b, 0x44, 0x3a, 0x10, 0x0f, 0x83</code> in Windows 10 1803+) which marks the pointer to the <code class="de nv nw nx ny b">KeServiceDescriptorTable</code> structure.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd tt"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*84RCGvpb9_hKwA9mk47HzA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*84RCGvpb9_hKwA9mk47HzA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*84RCGvpb9_hKwA9mk47HzA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*84RCGvpb9_hKwA9mk47HzA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*84RCGvpb9_hKwA9mk47HzA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*84RCGvpb9_hKwA9mk47HzA.png 1100w, https://miro.medium.com/v2/resize:fit:1180/format:webp/1*84RCGvpb9_hKwA9mk47HzA.png 1180w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 590px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*84RCGvpb9_hKwA9mk47HzA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*84RCGvpb9_hKwA9mk47HzA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*84RCGvpb9_hKwA9mk47HzA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*84RCGvpb9_hKwA9mk47HzA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*84RCGvpb9_hKwA9mk47HzA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*84RCGvpb9_hKwA9mk47HzA.png 1100w, https://miro.medium.com/v2/resize:fit:1180/1*84RCGvpb9_hKwA9mk47HzA.png 1180w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 590px"><img alt="" class="bi md pl c" width="590" height="292" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:590/1*84RCGvpb9_hKwA9mk47HzA.png"></picture></div></figure><p id="5891" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Inside of the <code class="de nv nw nx ny b">KeServiceDescriptorTable</code> structure is a pointer to another structure, <code class="de nv nw nx ny b">KiServiceTable</code>, which contains an array of 32-bit offsets relative to <code class="de nv nw nx ny b">KiServiceTable</code> itself.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd tu"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*RrTX9lHB5DGQlsO1SsqYAg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*RrTX9lHB5DGQlsO1SsqYAg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*RrTX9lHB5DGQlsO1SsqYAg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*RrTX9lHB5DGQlsO1SsqYAg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*RrTX9lHB5DGQlsO1SsqYAg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*RrTX9lHB5DGQlsO1SsqYAg.png 1100w, https://miro.medium.com/v2/resize:fit:518/format:webp/1*RrTX9lHB5DGQlsO1SsqYAg.png 518w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 259px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*RrTX9lHB5DGQlsO1SsqYAg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*RrTX9lHB5DGQlsO1SsqYAg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*RrTX9lHB5DGQlsO1SsqYAg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*RrTX9lHB5DGQlsO1SsqYAg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*RrTX9lHB5DGQlsO1SsqYAg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*RrTX9lHB5DGQlsO1SsqYAg.png 1100w, https://miro.medium.com/v2/resize:fit:518/1*RrTX9lHB5DGQlsO1SsqYAg.png 518w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 259px"><img alt="" class="bi md pl c" width="259" height="150" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:259/1*RrTX9lHB5DGQlsO1SsqYAg.png"></picture></div></figure><p id="9740" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Because we can’t really work with these offsets in WinDbg as they are left-shifted 4 bits, we can right-shift it by 4 bits and add it to <code class="de nv nw nx ny b">KiServiceTable</code> to get the correct address.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd tv"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*m-i9EEaaMdAoBJu-XRem7Q.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*m-i9EEaaMdAoBJu-XRem7Q.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*m-i9EEaaMdAoBJu-XRem7Q.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*m-i9EEaaMdAoBJu-XRem7Q.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*m-i9EEaaMdAoBJu-XRem7Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*m-i9EEaaMdAoBJu-XRem7Q.png 1100w, https://miro.medium.com/v2/resize:fit:1300/format:webp/1*m-i9EEaaMdAoBJu-XRem7Q.png 1300w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 650px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*m-i9EEaaMdAoBJu-XRem7Q.png 640w, https://miro.medium.com/v2/resize:fit:720/1*m-i9EEaaMdAoBJu-XRem7Q.png 720w, https://miro.medium.com/v2/resize:fit:750/1*m-i9EEaaMdAoBJu-XRem7Q.png 750w, https://miro.medium.com/v2/resize:fit:786/1*m-i9EEaaMdAoBJu-XRem7Q.png 786w, https://miro.medium.com/v2/resize:fit:828/1*m-i9EEaaMdAoBJu-XRem7Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*m-i9EEaaMdAoBJu-XRem7Q.png 1100w, https://miro.medium.com/v2/resize:fit:1300/1*m-i9EEaaMdAoBJu-XRem7Q.png 1300w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 650px"><img alt="" class="bi md pl c" width="650" height="87" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:650/1*m-i9EEaaMdAoBJu-XRem7Q.png"></picture></div></div></figure><p id="9fd6" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">We can also use some of WinDbg’s more <a class="ah nu" href="https://www.contextis.com/en/blog/introduction-debugging-windows-kernel-windbg" rel="noopener ugc nofollow" target="_blank">advanced features to process the offsets</a> and print out the module located at the calculated addresses to get the addresses of all services.</p></div></div><div class="pk"><div class="ac ci"><div class="ly sd lz se ma sf cm sg cn sh cp bi"><figure class="pf pg ph pi pj pk sj sk paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd tw"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*IKpEs8bPRMKKT6w1LtoK4A.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*IKpEs8bPRMKKT6w1LtoK4A.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*IKpEs8bPRMKKT6w1LtoK4A.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*IKpEs8bPRMKKT6w1LtoK4A.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*IKpEs8bPRMKKT6w1LtoK4A.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*IKpEs8bPRMKKT6w1LtoK4A.png 1100w, https://miro.medium.com/v2/resize:fit:2000/format:webp/1*IKpEs8bPRMKKT6w1LtoK4A.png 2000w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 1000px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*IKpEs8bPRMKKT6w1LtoK4A.png 640w, https://miro.medium.com/v2/resize:fit:720/1*IKpEs8bPRMKKT6w1LtoK4A.png 720w, https://miro.medium.com/v2/resize:fit:750/1*IKpEs8bPRMKKT6w1LtoK4A.png 750w, https://miro.medium.com/v2/resize:fit:786/1*IKpEs8bPRMKKT6w1LtoK4A.png 786w, https://miro.medium.com/v2/resize:fit:828/1*IKpEs8bPRMKKT6w1LtoK4A.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*IKpEs8bPRMKKT6w1LtoK4A.png 1100w, https://miro.medium.com/v2/resize:fit:2000/1*IKpEs8bPRMKKT6w1LtoK4A.png 2000w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 1000px"><img alt="" class="bi md pl c" width="1000" height="231" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:1000/1*IKpEs8bPRMKKT6w1LtoK4A.png"></picture></div></div></figure></div></div></div><div class="ac ci"><div class="cp bi gq gr gs gt"><p id="0325" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">This is the <a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/68ac65b426d1b9e1354dd0365676b1ead15022de/mimidrv/kkll_m_ssdt.c#L33" rel="noopener ugc nofollow" target="_blank">exact same thing</a> the Mimidrv is doing after locating <code class="de nv nw nx ny b">KeServiceDescriptorTable</code> in order to locate pointers to services. If first prints out the index (e.g. 85 for <code class="de nv nw nx ny b">NtCreateFile</code> as shown in the earlier WinDbg screenshot) followed by the address. Then <code class="de nv nw nx ny b"><a class="ah nu" href="https://github.com/gentilkiwi/mimikatz/blob/110a831ebe7b529c5dd3010f9e7fced0d3e3a46c/mimidrv/kkll_m_modules.c#L35" rel="noopener ugc nofollow" target="_blank">kkll_m_modules_fromAddr</a></code>, which you’ll remember from earlier sections, is called to get the offset of the service/function inside of <code class="de nv nw nx ny b">ntoskrnl.exe</code>.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd tx"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*ZFvh2tVb3N0LFh1lDDdDEA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*ZFvh2tVb3N0LFh1lDDdDEA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*ZFvh2tVb3N0LFh1lDDdDEA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*ZFvh2tVb3N0LFh1lDDdDEA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*ZFvh2tVb3N0LFh1lDDdDEA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*ZFvh2tVb3N0LFh1lDDdDEA.png 1100w, https://miro.medium.com/v2/resize:fit:844/format:webp/1*ZFvh2tVb3N0LFh1lDDdDEA.png 844w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 422px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*ZFvh2tVb3N0LFh1lDDdDEA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*ZFvh2tVb3N0LFh1lDDdDEA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*ZFvh2tVb3N0LFh1lDDdDEA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*ZFvh2tVb3N0LFh1lDDdDEA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*ZFvh2tVb3N0LFh1lDDdDEA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*ZFvh2tVb3N0LFh1lDDdDEA.png 1100w, https://miro.medium.com/v2/resize:fit:844/1*ZFvh2tVb3N0LFh1lDDdDEA.png 844w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 422px"><img alt="" class="bi md pl c" width="422" height="149" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:422/1*ZFvh2tVb3N0LFh1lDDdDEA.png"></picture></div></figure><p id="2986" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Using the indexes provided by WinDbg, we can see the the address at index 0 points to <code class="de nv nw nx ny b">nt!NtAccessCheck</code>. which resides at offset <code class="de nv nw nx ny b">0x112340</code> in <code class="de nv nw nx ny b">ntoskrnl.exe</code>.</p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div class="pc pd ty"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*JVLGTU5ak6oqM2bs_hdT0A.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*JVLGTU5ak6oqM2bs_hdT0A.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*JVLGTU5ak6oqM2bs_hdT0A.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*JVLGTU5ak6oqM2bs_hdT0A.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*JVLGTU5ak6oqM2bs_hdT0A.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*JVLGTU5ak6oqM2bs_hdT0A.png 1100w, https://miro.medium.com/v2/resize:fit:1370/format:webp/1*JVLGTU5ak6oqM2bs_hdT0A.png 1370w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 685px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*JVLGTU5ak6oqM2bs_hdT0A.png 640w, https://miro.medium.com/v2/resize:fit:720/1*JVLGTU5ak6oqM2bs_hdT0A.png 720w, https://miro.medium.com/v2/resize:fit:750/1*JVLGTU5ak6oqM2bs_hdT0A.png 750w, https://miro.medium.com/v2/resize:fit:786/1*JVLGTU5ak6oqM2bs_hdT0A.png 786w, https://miro.medium.com/v2/resize:fit:828/1*JVLGTU5ak6oqM2bs_hdT0A.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*JVLGTU5ak6oqM2bs_hdT0A.png 1100w, https://miro.medium.com/v2/resize:fit:1370/1*JVLGTU5ak6oqM2bs_hdT0A.png 1370w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 685px"><img alt="" class="bi md pl c" width="685" height="85" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:685/1*JVLGTU5ak6oqM2bs_hdT0A.png"></picture></div></figure><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd tz"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*p703fOfVJA9e7MOJqBMIWg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*p703fOfVJA9e7MOJqBMIWg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*p703fOfVJA9e7MOJqBMIWg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*p703fOfVJA9e7MOJqBMIWg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*p703fOfVJA9e7MOJqBMIWg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*p703fOfVJA9e7MOJqBMIWg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p703fOfVJA9e7MOJqBMIWg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*p703fOfVJA9e7MOJqBMIWg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*p703fOfVJA9e7MOJqBMIWg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*p703fOfVJA9e7MOJqBMIWg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*p703fOfVJA9e7MOJqBMIWg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*p703fOfVJA9e7MOJqBMIWg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*p703fOfVJA9e7MOJqBMIWg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*p703fOfVJA9e7MOJqBMIWg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="49" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*p703fOfVJA9e7MOJqBMIWg.png"></picture></div></div></figure></div></div></div><div class="ac ci ra rb rc rd" role="separator"><span class="re by bn rf rg rh"></span><span class="re by bn rf rg rh"></span><span class="re by bn rf rg"></span></div><div class="he hf hg hh hi"><div class="ac ci"><div class="cp bi gq gr gs gt"><h2 id="a85f" class="nz oa hl bg ob oc ri oe of og rj oi oj ok rk om on oo rl oq or os rm ou ov ow bl" data-selectable-paragraph="">Defending Against Driver-Based Threats</h2><p id="ff8d" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">Now that we’ve covered the inner workings of Mimidrv, how do we prevent the bad guys from getting in implanted on our systems in the first place? Using drivers against Windows 10 systems introduces some unique challenges for us as attackers, the largest of which being that <a class="ah nu" href="https://techcommunity.microsoft.com/t5/windows-hardware-certification/driver-signing-changes-in-windows-10-version-1607/ba-p/364894" rel="noopener ugc nofollow" target="_blank">drivers must be signed</a>.</p><p id="4412" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Mimidrv has many static indicators that are easily modifiable, but require recompilation and re-signing using a new EV certificate. Because of the cost that comes with modifying Mimidrv, a brittle detection is still worth implementing. A few of the default indicators for Mimidrv implantation and organized by source are:</p><h3 id="bd7b" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph=""><strong class="an">Windows Event ID 7045/4697 — Service Creation</strong></h3><ul class=""><li id="d837" class="mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt qs qt qu bl" data-selectable-paragraph=""><strong class="my hm">Service Name:</strong> “mimikatz driver (mimidrv)”</li><li id="ec3c" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph=""><strong class="my hm">Service File Name:</strong> *\mimidrv.sys</li><li id="81f2" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph=""><strong class="my hm">Service Type:</strong> kernel mode driver (0x1)</li><li id="5e78" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph=""><strong class="my hm">Service Start Type:</strong> auto start (2)</li></ul><p id="3b6b" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph=""><strong class="my hm"><em class="px">Note:</em></strong><em class="px"> Event ID 4697 contains information about the account that loaded the driver, which could aide in hunting. </em><a class="ah nu" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-security-system-extension" rel="noopener ugc nofollow" target="_blank"><em class="px">Audit Security System Extension</em></a><em class="px"> must be configured via Group Policy for this event to be generated.</em></p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd ua"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*hp12K-idtn8zuS47Weacpw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*hp12K-idtn8zuS47Weacpw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*hp12K-idtn8zuS47Weacpw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*hp12K-idtn8zuS47Weacpw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*hp12K-idtn8zuS47Weacpw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*hp12K-idtn8zuS47Weacpw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hp12K-idtn8zuS47Weacpw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*hp12K-idtn8zuS47Weacpw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*hp12K-idtn8zuS47Weacpw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*hp12K-idtn8zuS47Weacpw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*hp12K-idtn8zuS47Weacpw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*hp12K-idtn8zuS47Weacpw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*hp12K-idtn8zuS47Weacpw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*hp12K-idtn8zuS47Weacpw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi md pl c" width="700" height="340" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*hp12K-idtn8zuS47Weacpw.png"></picture></div></div></figure><h3 id="e10b" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph=""><strong class="an">Sysmon Event ID 11 — File Creation</strong></h3><ul class=""><li id="1aa7" class="mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt qs qt qu bl" data-selectable-paragraph=""><strong class="my hm">TargetFilename:</strong> *\mimidrv.sys</li></ul><h3 id="e5d4" class="pz oa hl bg ob qa qb ef of qc qd eh oj nh qe qf qg nl qh qi qj np qk ql qm qn bl" data-selectable-paragraph="">Sysmon Event ID 6 — Driver Loaded</h3><ul class=""><li id="403b" class="mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt qs qt qu bl" data-selectable-paragraph=""><strong class="my hm">ImageLoaded:</strong> *\mimidrv.sys</li><li id="3a92" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph=""><strong class="my hm">SignatureStatus:</strong> Expired</li></ul><p id="45bc" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Another more broad approach to this problem is to step back even further and looks at the attributes of unwanted drivers as a whole.</p><p id="bb27" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">Third-party drivers are an inevitability for most organizations, but knowing what the standard is for your fleet and identifying anomalies is a worthwhile exercise. Windows Defender Application Control (WDAC) makes this incredibly simple to audit on Windows 10 systems.</p><p id="eb50" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">My colleague <span class="ud"><span class="bn" aria-describedby="10" aria-labelledby="10" role="tooltip"></span></span></p><div tabindex="-1" class="bf"><a class="ub uc fl" href="https://medium.com/u/e8e64b89121?source=post_page---user_mention--4d273d19e148---------------------------------------" rel="noopener" target="_blank">Matt Graeber</a></div> <a class="ah nu" href="https://posts.specterops.io/threat-detection-using-windows-defender-application-control-device-guard-in-audit-mode-602b48cd1c11" rel="noopener ugc nofollow" target="_blank">wrote an excellent post</a> on deploying a Code Integrity Policy and beginning to audit the loading of any non-Windows, Early Load AntiMalware (ELAM), or Hardware Abstraction Layer (HAL) drivers. After a reboot, the system will begin generating logs with Event ID 3076 for any driver that would have been blocked with the base policy.<p></p><figure class="pf pg ph pi pj pk pc pd paragraph-image"><div role="button" tabindex="0" class="pq pr fr ps bi pt"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="pc pd ue"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*7J7XONLq3GkyfgYTnIdnbQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*7J7XONLq3GkyfgYTnIdnbQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*7J7XONLq3GkyfgYTnIdnbQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*7J7XONLq3GkyfgYTnIdnbQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*7J7XONLq3GkyfgYTnIdnbQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*7J7XONLq3GkyfgYTnIdnbQ.png 1100w, https://miro.medium.com/v2/resize:fit:1202/format:webp/1*7J7XONLq3GkyfgYTnIdnbQ.png 1202w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 601px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*7J7XONLq3GkyfgYTnIdnbQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*7J7XONLq3GkyfgYTnIdnbQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*7J7XONLq3GkyfgYTnIdnbQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*7J7XONLq3GkyfgYTnIdnbQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*7J7XONLq3GkyfgYTnIdnbQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*7J7XONLq3GkyfgYTnIdnbQ.png 1100w, https://miro.medium.com/v2/resize:fit:1202/1*7J7XONLq3GkyfgYTnIdnbQ.png 1202w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 601px"><img alt="" class="bi md pl c" width="601" height="341" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:601/1*7J7XONLq3GkyfgYTnIdnbQ.png"></picture></div></div></figure><p id="0552" class="pw-post-body-paragraph mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt he bl" data-selectable-paragraph="">From here, we can begin to figure out which drivers are needed outside of the base policy, grant exemptions for them, and begin tuning detection logic to allow analysts to triage anomalous driver loads more efficiently.</p><h2 id="5b4c" class="nz oa hl bg ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot ou ov ow bl" data-selectable-paragraph="">Further Reading</h2><p id="9295" class="pw-post-body-paragraph mw mx hl my b mz ox nb nc nd oy nf ng nh oz nj nk nl pa nn no np pb nr ns nt he bl" data-selectable-paragraph="">If you have found this material interesting, here are some resources that cover some of the details that I glossed over in this post:</p><ul class=""><li id="23cc" class="mw mx hl my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt qs qt qu bl" data-selectable-paragraph=""><a class="ah nu" href="https://leanpub.com/windowskernelprogramming" rel="noopener ugc nofollow" target="_blank"><em class="px">Windows Kernel Programming</em></a> by Pavel Yosifovich</li><li id="4295" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph=""><a class="ah nu" href="https://www.microsoftpressstore.com/store/windows-internals-part-1-system-architecture-processes-9780735684188" rel="noopener ugc nofollow" target="_blank"><em class="px">Windows Internals, Part 1</em></a> by Pavel Yosifovich, Mark Russinovich, David Solomon, and Alex Ionescu</li><li id="07ee" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph=""><a class="ah nu" href="https://www.wiley.com/en-us/Practical+Reverse+Engineering%3A+x86%2C+x64%2C+ARM%2C+Windows+Kernel%2C+Reversing+Tools%2C+and+Obfuscation-p-9781118787311" rel="noopener ugc nofollow" target="_blank"><em class="px">Practical Reverse Engineering: x86, x64, ARM, Windows Kernel, Reversing Tools, and Obfuscation, Chapter 3</em></a> by Bruce Dang, Alexandre Gazet, Elias Bachaalany, and Sébastien Josse</li><li id="68e1" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph="">OSR’s <a class="ah nu" href="https://www.osr.com/nt-insider/" rel="noopener ugc nofollow" target="_blank"><em class="px">The NT Insider</em></a> publication and <a class="ah nu" href="https://community.osr.com/" rel="noopener ugc nofollow" target="_blank">community forum</a></li><li id="4992" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph="">Microsoft’s <a class="ah nu" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/tree/a0486ec7b6480aec5233ba59c64c49578e540f52/wdk-ddi-src/content/wdm" rel="noopener ugc nofollow" target="_blank">sample WDM drivers</a></li><li id="20f4" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph="">Broderick Aquilino’s thesis <a class="ah nu" href="https://aaltodoc.aalto.fi/handle/123456789/38990" rel="noopener ugc nofollow" target="_blank"><em class="px">Relevance of Security Features Introduced in Modern Windows OS</em></a></li><li id="ad4e" class="mw mx hl my b mz qv nb nc nd qw nf ng nh qx nj nk nl qy nn no np qz nr ns nt qs qt qu bl" data-selectable-paragraph="">Geoff Chappell’s <a class="ah nu" href="https://www.geoffchappell.com/studies/windows/km/index.htm?tx=146%2C150" rel="noopener ugc nofollow" target="_blank">Windows kernel documentation</a></li></ul></div></div></div></div></section></div></div></article></div><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="uf ug ac jl"><div class="uh ac"><a class="ui ak ao aq" rel="noopener follow" href="https://medium.com/tag/mimikatz?source=post_page-----4d273d19e148---------------------------------------" data-discover="true"><div class="uj fr de uk gv ul um bg b bh ab bl gc">Mimikatz</div></a></div><div class="uh ac"><a class="ui ak ao aq" rel="noopener follow" href="https://medium.com/tag/drivers?source=post_page-----4d273d19e148---------------------------------------" data-discover="true"><div class="uj fr de uk gv ul um bg b bh ab bl gc">Drivers</div></a></div><div class="uh ac"><a class="ui ak ao aq" rel="noopener follow" href="https://medium.com/tag/wdm?source=post_page-----4d273d19e148---------------------------------------" data-discover="true"><div class="uj fr de uk gv ul um bg b bh ab bl gc">Wdm</div></a></div><div class="uh ac"><a class="ui ak ao aq" rel="noopener follow" href="https://medium.com/tag/windows-internals?source=post_page-----4d273d19e148---------------------------------------" data-discover="true"><div class="uj fr de uk gv ul um bg b bh ab bl gc">Windows Internals</div></a></div><div class="uh ac"><a class="ui ak ao aq" rel="noopener follow" href="https://medium.com/tag/kernel?source=post_page-----4d273d19e148---------------------------------------" data-discover="true"><div class="uj fr de uk gv ul um bg b bh ab bl gc">Kernel</div></a></div></div></div></div><div class="m"></div><div class="vb m"><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="ac iv it ir vc vd"><div class="ve vf vg vh vi vj vk vl vm vn ac cw"><div class="i l"><a tabindex="0" rel="noopener follow" href="https://medium.com/@matterpreter?source=post_page---post_author_info--4d273d19e148---------------------------------------" data-discover="true"><div class="m fr"><img alt="Matt Hand" class="m fk by vo vp de" width="48" height="48" loading="lazy" src="https://miro.medium.com/v2/resize:fill:48:48/2*HFgLEKa86-RKIOoc4CfbOA.png"><div class="gj by m vo vp fw o ak vq"></div></div></a></div><div class="k j e"><a tabindex="0" rel="noopener follow" href="https://medium.com/@matterpreter?source=post_page---post_author_info--4d273d19e148---------------------------------------" data-discover="true"><div class="m fr"><img alt="Matt Hand" class="m fk by vr vs de" width="64" height="64" loading="lazy" src="https://miro.medium.com/v2/resize:fill:64:64/2*HFgLEKa86-RKIOoc4CfbOA.png"><div class="gj by m vr vs fw o ak vq"></div></div></a></div><div class="k j e vt cb"><div class="ac"><button class="abq abv aq ac ci r acb kt acc" style="border: 1px solid rgba(8, 8, 8, 0.23);"><span class="bg b bh ab bl bi"><span class="bn abz">Follow</span></span></button></div></div></div><div class="ac cv cd"><div class="vu vv vw se sd m"><a class="ah ai aj al am an ao ap aq ar as at au av ac r" rel="noopener follow" href="https://medium.com/@matterpreter?source=post_page---post_author_info--4d273d19e148---------------------------------------" data-discover="true"><h2 class="pw-author-name bg vy vz wa wb wc wd we nh qf qg nl qi qj np ql qm bl"><span class="he vx">Written by Matt Hand</span></h2><div class="wf ac"><div><div class="ac" aria-describedby="16" aria-labelledby="16" role="tooltip"><div tabindex="-1" class="bf"><div class="ac jj"><div class="ac"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 16 16"><path fill="#437AFF" d="M15.163 8c0 .65-.459 1.144-.863 1.575-.232.244-.471.5-.563.719s-.086.543-.092.875c-.006.606-.018 1.3-.49 1.781-.47.481-1.15.494-1.744.5-.324.006-.655.013-.857.094s-.465.337-.704.575c-.422.412-.906.881-1.542.881-.637 0-1.12-.469-1.543-.881-.239-.238-.49-.482-.704-.575-.214-.094-.532-.088-.857-.094-.593-.006-1.273-.019-1.744-.5s-.484-1.175-.49-1.781c-.006-.332-.012-.669-.092-.875-.08-.207-.33-.475-.563-.719-.404-.431-.863-.925-.863-1.575s.46-1.144.863-1.575c.233-.244.472-.5.563-.719.092-.219.086-.544.092-.875.006-.606.019-1.3.49-1.781s1.15-.494 1.744-.5c.325-.006.655-.012.857-.094.202-.081.465-.337.704-.575C7.188 1.47 7.671 1 8.308 1s1.12.469 1.542.881c.239.238.49.481.704.575s.533.088.857.094c.594.006 1.273.019 1.745.5.47.481.483 1.175.49 1.781.005.331.011.669.091.875s.33.475.563.719c.404.431.863.925.863 1.575"></path><path fill="#fff" d="M7.328 10.5c.195 0 .381.08.519.22.137.141.215.331.216.53 0 .066.026.13.072.177a.24.24 0 0 0 .346 0 .25.25 0 0 0 .071-.177c.001-.199.079-.389.216-.53a.73.73 0 0 1 .519-.22h1.959c.13 0 .254-.053.346-.146a.5.5 0 0 0 .143-.354V6a.5.5 0 0 0-.143-.354.49.49 0 0 0-.346-.146h-1.47c-.324 0-.635.132-.865.366-.23.235-.359.552-.359.884v2.5c0 .066-.025.13-.071.177a.24.24 0 0 1-.346 0 .25.25 0 0 1-.072-.177v-2.5c0-.332-.13-.65-.359-.884A1.21 1.21 0 0 0 6.84 5.5h-1.47a.49.49 0 0 0-.346.146A.5.5 0 0 0 4.88 6v4c0 .133.051.26.143.354a.49.49 0 0 0 .347.146z"></path></svg></div></div></div></div></div></div></a><div class="uh ac ix"><div class="m cb"><span class="pw-follower-count bg b bh ab eb"><a class="ah ai aj fo al am an ao ap aq ar as at jg" rel="noopener follow" href="https://medium.com/@matterpreter/followers?source=post_page---post_author_info--4d273d19e148---------------------------------------" data-discover="true">476 followers</a></span></div><div class="bg b bh ab eb ac wg"><span class="wh m" aria-hidden="true"><span class="bg b bh ab eb">·</span></span><a class="ah ai aj fo al am an ao ap aq ar as at jg" rel="noopener follow" href="https://medium.com/@matterpreter/following?source=post_page---post_author_info--4d273d19e148---------------------------------------" data-discover="true">5 following</a></div></div><div class="wi m"><p class="bg b bh ab bl">Red team guy gone purple @preludeorg 💜 | Author of Evading EDR <a class="ah ai aj fo al am an ao ap aq ar as at nu hf he" href="http://nostarch.com/evading-edr" rel="noopener  ugc nofollow">http://nostarch.com/evading-edr</a> 📖 | Security research &amp; windows internals 🦠</p></div></div></div><div class="i l"><div class="ac"><button class="abq abv aq ac ci r acb kt acc" style="border: 1px solid rgba(8, 8, 8, 0.23);"><span class="bg b bh ab bl bi"><span class="bn abz">Follow</span></span></button></div></div></div></div></div></div><div class="wj m"><div class="wk bi s vb"></div><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="ac r cw"><h2 class="bg vy oc oe of og oi oj ok om on oo oq or os ou ov bl">No responses yet</h2><div class="ac wl"><div><div class="bn" aria-describedby="17" aria-labelledby="17" role="tooltip"><div tabindex="-1" class="bf"><a class="wm wn" href="https://policy.medium.com/medium-rules-30e5502c4eb4?source=post_page---post_responses--4d273d19e148---------------------------------------" rel="noopener follow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" aria-label="Shield with a checkmark" viewBox="0 0 25 25"><path fill-rule="evenodd" d="M11.987 5.036a.754.754 0 0 1 .914-.01c.972.721 1.767 1.218 2.6 1.543.828.322 1.719.485 2.887.505a.755.755 0 0 1 .741.757c-.018 3.623-.43 6.256-1.449 8.21-1.034 1.984-2.662 3.209-4.966 4.083a.75.75 0 0 1-.537-.003c-2.243-.874-3.858-2.095-4.897-4.074-1.024-1.951-1.457-4.583-1.476-8.216a.755.755 0 0 1 .741-.757c1.195-.02 2.1-.182 2.923-.503.827-.322 1.6-.815 2.519-1.535m.468.903c-.897.69-1.717 1.21-2.623 1.564-.898.35-1.856.527-3.026.565.037 3.45.469 5.817 1.36 7.515.884 1.684 2.25 2.762 4.284 3.571 2.092-.81 3.465-1.89 4.344-3.575.886-1.698 1.299-4.065 1.334-7.512-1.149-.039-2.091-.217-2.99-.567-.906-.353-1.745-.873-2.683-1.561m-.009 9.155a2.672 2.672 0 1 0 0-5.344 2.672 2.672 0 0 0 0 5.344m0 1a3.672 3.672 0 1 0 0-7.344 3.672 3.672 0 0 0 0 7.344m-1.813-3.777.525-.526.916.917 1.623-1.625.526.526-2.149 2.152z" clip-rule="evenodd"></path></svg></a></div></div></div></div></div><div class="wo wp wq wr ws m"><div><div class="bg b bh ab bl"><div class="zx"><div class="abf m"><div class="abg ac r"><div class="m fr"><img alt="" class="m fk by bz ca de" width="32" height="32" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fill:32:32/1*dmbNkD5D-u45r44go_cf0g.png"><div class="gj by m bz ca fw o ak vq"></div></div><div class="bo ac cu cv ci"><p class="bg b bh ab eb">Write a response</p></div></div><div class="de bq ac cv zy zz"><div class="ac cv fr"><span data-dd-action-name="Susi presentation tracker respond_sidebar"><a class="ah ai aj fo al am an ao ap aq ar as at au av" rel="noopener follow" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40matterpreter%2Fmimidrv-in-depth-4d273d19e148&amp;source=---post_responses--4d273d19e148---------------------respond_sidebar------------------" data-discover="true"><div class="ya m"><p class="bg b bh ab eb">What are your thoughts?</p></div></a></span><div class="cw aba eb ac abb zb abc"><span class="bg b bh ab eb"><div class="ac"><div><div class="bn" aria-describedby="30" aria-labelledby="30" role="tooltip"><div tabindex="-1" class="bf"><span role="button" aria-label="Bold (⌘B)" class="abh abi abj abk bq lx ci abl abm abn" tabindex="0"><svg width="21" height="21"><path fill-rule="evenodd" d="M10.308 17.993h-5.92l.11-.894.783-.12c.56-.11.79-.224.79-.448V5.37c0-.225-.113-.336-.902-.448H4.5l-.114-.894h6.255c4.02 0 5.58 1.23 5.58 3.13 0 1.896-1.78 3.125-3.79 3.463v.11c2.69.34 4.25 1.56 4.25 3.57 0 2.35-2.01 3.69-6.37 3.69l.02.01h-.02zm-.335-12.96H8.967V10.5h1.23c1.788 0 2.79-1.23 2.79-2.683 0-1.685-1.004-2.803-3.006-2.803v.02zm-.223 6.36h-.783v5.588l1.225.23h.22c1.67 0 3.01-1.004 3.01-2.792 0-2.122-1.566-3.016-3.69-3.016h.018z"></path></svg></span></div></div></div><div><div class="bn" aria-describedby="31" aria-labelledby="31" role="tooltip"><div tabindex="-1" class="bf"><span role="button" aria-label="Italic (⌘I)" class="abh abi abj abk bq lx ci abl abm abn" tabindex="0"><svg width="21" height="21"><path fill-rule="evenodd" d="M9.847 18.04c-.533 0-2.027-.64-1.92-.853l2.027-7.68-.64-.214-1.387 1.494-.427-.427c.534-1.173 1.707-2.667 2.774-2.667.533 0 2.24.534 2.133.854l-2.133 7.786.533.214 1.6-1.067.427.427c-.64 1.066-1.92 2.133-2.987 2.133m2.347-11.733c-.96 0-1.387-.64-1.387-1.387 0-1.067.747-1.92 1.493-1.92.854 0 1.387.64 1.387 1.493-.107 1.067-.747 1.814-1.493 1.814"></path></svg></span></div></div></div></div></span><div class="abd vt ac abb zb abc"><div class="abe"><button class="bg b ec ab bl abo abp abq abr lw ls ys fc fd fe abs abt abu fh fi fj fk bn fl fm" data-testid="CancelResponseButton">Cancel</button></div><button class="bg b ec ab yn abo yo yp yq yr ys fc fd yt yu yv fh fi fj fk bn fl fm" disabled="" data-testid="ResponseRespondButton">Respond</button></div></div></div></div></div></div></div></div></div></div></div></div><div class="wt wu wv ww wx m bx"><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="acd ace dt du dv wi m"><h2 class="bg vy oc oe of og oi oj ok om on oo oq or os ou ov bl">More from Matt Hand</h2></div><div class="acf ac ku jl acg ach aci acj ack acl acm acn aco acp acq acr acs act acu"><div class="acv acw acx sd acy acz ada se adb adc add ade adf adg adh adi adj adk adl adm adn"></div><div class="acv acw acx sd acy acz ada se adb adc add ade adf adg adh adi adj adk adl adm adn"></div><div class="acv acw acx sd acy acz ada se adb adc add ade adf adg adh adi adj adk adl adm adn"></div><div class="acv acw acx sd acy acz ada se adb adc add ade adf adg adh adi adj adk adl adm adn"></div></div><div class="wk bi wy dr ds ahl ahm ahn"></div><div class="ac vd vc ir it iv"><a class="bg b bh ab bl uj abp abq abr lw ls ys fc fd fe abs abt abu fh aho ahp ahq ahr ahs fi fj fk bn fl fm" rel="noopener follow" href="https://medium.com/@matterpreter?source=post_page---author_recirc--4d273d19e148---------------------------------------" data-discover="true"><div class="m fm">See all from Matt Hand</div></a></div></div></div><div class="wk bi wy aht ahu ahv ahw ahx"></div><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="ahy ahz m"><h2 class="bg vy oc oe of og oi oj ok om on oo oq or os ou ov bl">Recommended from Medium</h2><div class="pf pg ph pi pj m"><div class="acf ac ku jl acg ach aci acj ack acl acm acn aco acp acq acr acs act acu"><div class="acv acw acx sd acy acz ada se adb adc add ade adf adg adh adi adj adk adl adm adn"></div><div class="acv acw acx sd acy acz ada se adb adc add ade adf adg adh adi adj adk adl adm adn"></div></div></div><div class="acf ac ku jl acg ach aci acj ack acl acm acn aco acp acq acr acs act acu"><div class="acv acw acx sd acy acz ada se adb adc add ade adf adg adh adi adj adk adl adm adn"></div><div class="acv acw acx sd acy acz ada se adb adc add ade adf adg adh adi adj adk adl adm adn"></div><div class="acv acw acx sd acy acz ada se adb adc add ade adf adg adh adi adj adk adl adm adn"></div><div class="acv acw acx sd acy acz ada se adb adc add ade adf adg adh adi adj adk adl adm adn"></div></div><div class="wk bi wy dr ds ahl ahm ahn"></div><a class="bg b bh ab bl uj abp abq abr lw ls ys fc fd fe abs abt abu fh aho ahp ahq ahr ahs fi fj fk bn fl fm" rel="noopener follow" href="https://medium.com/?source=post_page---read_next_recirc--4d273d19e148---------------------------------------" data-discover="true"><div class="m fm">See more recommendations</div></a></div></div></div><div class="i l k"><div class="wk bi wy wz"></div><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="xa ac ku jl"><div class="xb xc m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://help.medium.com/hc/en-us?source=post_page-----4d273d19e148---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Help</p></a></div><div class="xb xc m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://status.medium.com/?source=post_page-----4d273d19e148---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Status</p></a></div><div class="xb xc m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" rel="noopener follow" href="https://medium.com/about?autoplay=1&amp;source=post_page-----4d273d19e148---------------------------------------" data-discover="true"><p class="bg b ec ab eb">About</p></a></div><div class="xb xc m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" rel="noopener follow" href="https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----4d273d19e148---------------------------------------" data-discover="true"><p class="bg b ec ab eb">Careers</p></a></div><div class="xb xc m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="mailto:pressinquiries@medium.com" rel="noopener follow"><p class="bg b ec ab eb">Press</p></a></div><div class="xb xc m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://blog.medium.com/?source=post_page-----4d273d19e148---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Blog</p></a></div><div class="xb xc m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----4d273d19e148---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Privacy</p></a></div><div class="xb xc m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://policy.medium.com/medium-rules-30e5502c4eb4?source=post_page-----4d273d19e148---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Rules</p></a></div><div class="xb xc m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----4d273d19e148---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Terms</p></a></div><div class="xb m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://speechify.com/medium?source=post_page-----4d273d19e148---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Text to speech</p></a></div></div></div></div></div></div></div></div></div></div></div></div>





































<div height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" data-original-tag="iframe"></div>
<div><div class="grecaptcha-badge" data-style="bottomright" style="width: 256px; height: 60px; display: block; transition: right 0.3s; position: fixed; bottom: 14px; right: -186px; box-shadow: gray 0px 0px 5px; border-radius: 2px; overflow: hidden;"><div class="grecaptcha-logo"><div title="reCAPTCHA" width="256" height="60" role="presentation" name="a-1m6dey8ao7zd" frameborder="0" scrolling="no" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-top-navigation allow-modals allow-popups-to-escape-sandbox allow-storage-access-by-user-activation" src="https://www.google.com/recaptcha/enterprise/anchor?ar=1&amp;k=6Le-uGgpAAAAAPprRaokM8AKthQ9KNGdoxaGUvVp&amp;co=aHR0cHM6Ly9tZWRpdW0uY29tOjQ0Mw..&amp;hl=en&amp;v=vUgXt_KV952_-5BB2jjloYzl&amp;size=invisible&amp;anchor-ms=20000&amp;execute-ms=30000&amp;cb=te3yf7aw06dg" data-original-tag="iframe">

<title>reCAPTCHA</title>

<link rel="stylesheet" type="text/css" href="https://www.gstatic.com/recaptcha/releases/vUgXt_KV952_-5BB2jjloYzl/styles__ltr.css">


<div id="rc-anchor-alert" class="rc-anchor-alert"></div>

<div class="rc-anchor rc-anchor-invisible rc-anchor-light  rc-anchor-invisible-hover"><div id="recaptcha-accessible-status" class="rc-anchor-aria-status" aria-hidden="true">Recaptcha requires verification. </div><div class="rc-anchor-error-msg-container" style="display:none"><span class="rc-anchor-error-msg" aria-hidden="true"></span></div><div class="rc-anchor-normal-footer"><div class="rc-anchor-logo-large" role="presentation"><div class="rc-anchor-logo-img rc-anchor-logo-img-large"></div></div><div class="rc-anchor-pt"><a href="https://www.google.com/intl/en/policies/privacy/" target="_blank">Privacy</a><span aria-hidden="true" role="presentation"> - </span><a href="https://www.google.com/intl/en/policies/terms/" target="_blank">Terms</a></div></div><div class="rc-anchor-invisible-text"><span>protected by <strong>reCAPTCHA</strong></span><div class="rc-anchor-pt"><a href="https://www.google.com/intl/en/policies/privacy/" target="_blank" style="">Privacy</a><span aria-hidden="true" role="presentation"> - </span><a href="https://www.google.com/intl/en/policies/terms/" target="_blank" style="">Terms</a></div></div></div><div style="display: none;" data-original-tag="iframe"></div></div></div><div class="grecaptcha-error"></div><textarea id="g-recaptcha-response-100000" name="g-recaptcha-response" class="g-recaptcha-response" style="width: 250px; height: 40px; border: 1px solid rgb(193, 193, 193); margin: 10px 25px; padding: 0px; resize: none; display: none;"></textarea></div><div style="display: none;" data-original-tag="iframe"></div></div></body></html>