Title:
Understanding Telemetry: Kernel Callbacks

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains Windows kernel callback routines and how EDR/AV drivers use them to collect high-fidelity telemetry on process/thread/image/registry activity.  
- It focuses on object manager (OB) callbacks via `ObRegisterCallbacks`, showing how drivers register pre/post callbacks for process/thread/desktop handle create/duplicate operations.  
- The author walks through relevant kernel data structures (`OB_CALLBACK_REGISTRATION`, `OB_OPERATION_REGISTRATION`) and the internal flow from `OpenProcess`/`NtOpenProcess` to `ObpPreInterceptHandleCreate`/`ObpPostInterceptHandleCreate`.  
- A PoC demonstrates monitoring handle opens and modifying requested access rights (e.g., stripping `PROCESS_ALL_ACCESS` down to limited rights) after SRM checks, highlighting how security products can constrain or observe handle-based attacks.  
- It also covers practical methods to enumerate callbacks on a system using WinObjEx64, TelemetrySourcerer (and its driver-based unregistration approach), and WinDbg scripting to traverse `OBJECT_TYPE.CallbackList`.  
- Useful for red teamers and malware developers learning EDR telemetry sources and potential evasion constraints, and for defenders wanting to understand where handle-operation telemetry originates and how to baseline it.

Technical Focus:
- Windows kernel callback mechanisms (process/thread/image/registry/object callbacks)
- `ObRegisterCallbacks` and OB pre/post operation callbacks for handle create/duplicate
- Windows Object Manager internals (`OBJECT_TYPE`, `CallbackList`, callback list ordering/altitudes)
- Syscall-to-kernel execution path (`NtOpenProcess` → `ObpCreateHandle` → intercept callbacks)
- Callback enumeration and analysis (WinObjEx64, WinDbg JS, symbol resolution)
- Access mask modification/stripping and SRM interaction (`SeAccessCheck`, `SePrivilegeCheck`)

Use Cases:
- Enumerate and attribute EDR/AV kernel callbacks registered on endpoints
- Build detections/telemetry pipelines around process handle opens/duplications (e.g., LSASS targeting)
- Reverse engineer how a specific EDR constrains handle access rights
- Develop kernel-driver PoCs to log or modify handle operations for research
- Validate or test callback-removal tooling (e.g., TelemetrySourcerer) in lab environments

Keywords:
Windows kernel, kernel callbacks, telemetry, EDR, AV driver, ObRegisterCallbacks, OB_CALLBACK_REGISTRATION, OB_OPERATION_REGISTRATION, OBJECT_TYPE, CallbackList, altitude, process handle, thread handle, handle duplication, OpenProcess, NtOpenProcess, ObpCreateHandle, ObpPreInterceptHandleCreate, ObpPostInterceptHandleCreate, SeAccessCheck, SePrivilegeCheck, WinDbg, JavaScript WinDbg scripting, WinObjEx64, TelemetrySourcerer, PsSetCreateProcessNotifyRoutine, PsSetCreateThreadNotifyRoutine, PsSetLoadImageNotifyRoutine, CmRegisterCallbackEx