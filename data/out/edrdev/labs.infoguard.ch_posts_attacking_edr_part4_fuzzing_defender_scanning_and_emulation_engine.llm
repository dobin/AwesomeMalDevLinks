Title:
Attacking EDRs Part 4: Fuzzing Defender's Scanning and Emulation Engine (mpengine.dll)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post documents a vulnerability research workflow for fuzzing Microsoft Defender’s local scanning/emulation engine `mpengine.dll` to find memory-safety bugs.  
- The author focuses on snapshot fuzzing to keep Defender’s real boot/config state (as used by `MsMpEng.exe`) rather than relying solely on older `rsignal`-based harnesses (`RSIG_BOOTENGINE` / `RSIG_SCAN_STREAMBUFFER`).  
- It covers practical hurdles: debugging a PPL-protected process, bypassing/neutralizing `WdFilter.sys` object callbacks, choosing a snapshot point, and virtualizing filesystem APIs inside the fuzzer.  
- Using WTF snapshot fuzzing (plus experiments with kAFL/NYX and Jackalope), the author found multiple distinct crashes (primarily OOB reads and null dereferences), some only reproducible with PageHeap, that can reliably DoS Defender during file scanning.  
- The bugs were assessed as non-exploitable for RCE, but still operationally relevant because they can be used to crash Defender pre-payload (e.g., via downloaded file or SMB drop) and reduce detection.  
- It’s most useful for vulnerability researchers and red teamers interested in AV/EDR attack surface, and for defenders to understand DoS risk and testing methodology; Microsoft reportedly fixed the issues silently after publication.

Technical Focus:
- Snapshot fuzzing on Windows targets (WTF) and harness design
- Microsoft Defender internals: `MsMpEng.exe`, `mpengine.dll`, `rsignal` scan flow
- Debugging Protected Process Light (PPL) and self-protection bypass techniques
- Virtual filesystem/API hooking for emulated execution (NtCreateFile/NtReadFile, etc.)
- Crash triage with PageHeap, WinDBG, symbols, and IDA/ret-sync
- Comparative fuzzing approaches: WTF vs kAFL/NYX (Redqueen/Grimoire) vs Jackalope

Use Cases:
- Build a high-fidelity fuzzing setup for Defender/AV engines without reinitializing per test case
- Reproduce and triage Defender scanning crashes (DoS) using PageHeap and WinDBG
- Develop harnesses for `mpengine.dll` scanning paths (file-based vs stream-based)
- Evaluate EDR/AV resilience against malformed files across many formats (PE, JAR, Mach-O, Office, text)
- Red team tradecraft: pre-position a file that crashes Defender to reduce subsequent detection (DoS-only)

Keywords:
Microsoft Defender, Defender for Endpoint, mpengine.dll, MsMpEng.exe, WdFilter.sys, snapshot fuzzing, WTF fuzzer, kAFL, NYX, Redqueen, Jackalope, PageHeap, WinDBG, PPL, PPLControl, ret-sync, IDA Pro, NtCreateFile, NtReadFile, RSIG_BOOTENGINE, RSIG_SCAN_STREAMBUFFER, rsignal, out-of-bounds read, null dereference, denial of service, VX-Underground, file format parsing, emulation engine