Title:
When the Hunter Becomes the Hunted: Using Custom Callbacks to Disable EDRs

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how Windows EDR/AV products monitor process creation using kernel process-notify callbacks registered via PsSetCreateProcessNotifyRoutine(Ex/Ex2) and stored in the kernel’s PspCreateProcessNotifyRoutine array.  
- It demonstrates a signed kernel driver/rootkit (“prevent.sys”) registering its own process creation callback to selectively block EDR processes from starting, effectively “blinding” the endpoint by preventing key security services (e.g., Microsoft Defender for Endpoint components) from launching.  
- The technique relies on inspecting PS_CREATE_NOTIFY_INFO (image path/command line) inside a PCREATE_PROCESS_NOTIFY_ROUTINE_EX callback and denying creation by setting CreationStatus = STATUS_ACCESS_DENIED.  
- The author uses WinDbg to inspect callback array entries (including address masking/alignment) and shows before/after impact via Process Hacker and lack of MDE alerts.  
- It’s primarily useful for kernel-focused red teamers/malware developers (offense) and for defenders validating assumptions about kernel callback trust and boot-time driver threats.  
- The key takeaway is that kernel callback mechanisms are a high-impact control point: adding or tampering with callbacks can neutralize user-mode EDR components without noisy userland injection.

Technical Focus:
- Windows kernel process creation notify routines (PsSetCreateProcessNotifyRoutineEx / PCREATE_PROCESS_NOTIFY_ROUTINE_EX)
- PspCreateProcessNotifyRoutine / nt!PspCallProcessNotifyRoutines internals and callback enumeration
- PS_CREATE_NOTIFY_INFO inspection (ImageFileName/CommandLine) and process creation denial (CreationStatus)
- Signed kernel driver/rootkit loading at boot and EDR self-protection bypass
- Kernel debugging/reversing with WinDbg; callback pointer masking/alignment (AND with 0xFFFFFFFFFFFFFFF8)

Use Cases:
- Disable or degrade EDR by preventing its agent/services from starting (boot-time persistence scenario)
- Researching kernel callback abuse as an EDR evasion primitive
- Building detections/hardening guidance around unexpected process-notify callbacks and driver load events
- Validating EDR resilience against malicious/signed driver threats in lab environments

Keywords:
Windows kernel, EDR bypass, rootkit, signed driver, PsSetCreateProcessNotifyRoutine, PsSetCreateProcessNotifyRoutineEx, PsSetCreateProcessNotifyRoutineEx2, PCREATE_PROCESS_NOTIFY_ROUTINE_EX, PS_CREATE_NOTIFY_INFO, PspCreateProcessNotifyRoutine, PspCallProcessNotifyRoutines, WdFilter.sys, mssecflt.sys, Microsoft Defender for Endpoint, MsSense.exe, STATUS_ACCESS_DENIED, WinDbg, kernel callbacks, process creation notification, boot-time driver loading