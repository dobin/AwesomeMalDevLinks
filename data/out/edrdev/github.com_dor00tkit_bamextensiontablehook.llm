Title:
BamExtensionTableHook

Type:
GitHub Tool

Short Summary (4–8 sentences max):
This repository provides a proof-of-concept Windows kernel driver that hooks the kernel “Extension Table” callback mechanism used by `bam.sys` (Background Activity Moderator) to receive process create/exit notifications. It addresses a common evasion technique where attackers with kernel read/write zero out entries in `nt!PspCreateProcessNotifyRoutine` to disable standard `PsSetCreateProcessNotifyRoutine(Ex|Ex2)` callbacks used by security products. The PoC locates `nt!PspBamExtensionHost` and overwrites the pointer to `bam!BampCreateProcessCallback`, redirecting execution to a custom callback so process monitoring persists even if the standard notify array is cleared. It highlights that PatchGuard does not appear to monitor this extension-table modification (per the author’s observation), making it a potentially stealthy persistence/visibility mechanism. It’s useful for kernel security researchers, EDR/AV engineers, and red teamers studying callback tampering and alternative kernel notification paths. It also notes a “complete disable” option for attackers: writing `0` to `nt!PspNotifyEnableMask` to disable all process notifications including extension-table ones.

Technical Focus:
- Windows process notify callbacks (`PsSetCreateProcessNotifyRoutine(Ex|Ex2)`, `nt!PspCreateProcessNotifyRoutine`)
- Kernel Extension Table mechanism (`nt!ExRegisterExtension`, extension hosts)
- Hooking `nt!PspBamExtensionHost` / `bam!BampCreateProcessCallback`
- Kernel memory tampering / DKOM-style pointer replacement
- Callback evasion and resilience against callback clearing
- PatchGuard coverage gaps (as observed)

Use Cases:
- Build resilient kernel process-monitoring callbacks that survive standard callback array wiping
- Research/validate attacker techniques for disabling EDR kernel callbacks and corresponding mitigations
- Develop detections for extension-table callback tampering (integrity checks on `PspBamExtensionHost`)
- Red-team simulation of advanced kernel-level telemetry suppression and defender countermeasures

Keywords:
Windows kernel, kernel driver, process notify callback, PsSetCreateProcessNotifyRoutine, PsSetCreateProcessNotifyRoutineEx, PsSetCreateProcessNotifyRoutineEx2, PspCreateProcessNotifyRoutine, PspCallProcessNotifyRoutines, Extension Table, ExRegisterExtension, PspBamExtensionHost, bam.sys, BampCreateProcessCallback, PspNotifyEnableMask, DKOM, kernel R/W primitive, callback tampering, PatchGuard, Windows 11 24H2