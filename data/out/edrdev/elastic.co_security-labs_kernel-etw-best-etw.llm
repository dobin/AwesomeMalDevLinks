Title:
Kernel ETW is the best ETW

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post argues that kernel-level ETW telemetry is more reliable and tamper-resistant than user-mode hooks (e.g., `ntdll` syscall hooks) for security monitoring and audit logging.  
- It explains why “where logging happens” matters (in-process vs service/RPC vs kernel) and highlights that even common Security Log events (e.g., 4688) are not purely kernel-sourced and can be influenced in user-mode components like `lsass.exe`.  
- The article categorizes ETW sources into four families (modern/legacy event providers and modern/legacy trace providers) and shows how to enumerate or recover metadata for each (TDH/registered manifests, WMI/MOF, TraceLogging blobs, WPP/symbol-based metadata).  
- It details a reverse-engineering workflow to map kernel `EtwWrite` callsites back to provider GUIDs and event descriptors by analyzing `EtwRegister`/`EtwWrite` patterns in `ntoskrnl.exe` with decompilers (Ghidra/IDA).  
- It introduces/updates the author’s “API-To-ETW” Ghidra script that de-anonymizes opaque kernel audit events (e.g., `Microsoft-Windows-Kernel-Audit-API-Calls`) by linking event IDs to the underlying kernel APIs (e.g., `NtTerminateProcess`, `PsOpenProcess`).  
- Useful for EDR engineers, defenders, and red teamers assessing telemetry gaps/anti-tamper, and for researchers building higher-fidelity detections from kernel-native audit sources.

Technical Focus:
- Kernel ETW vs user-mode hooking anti-tamper properties
- ETW provider taxonomy: MOF/manifest, WPP, TraceLogging
- Enumerating ETW metadata via TDH, WMI EventTrace classes, manifests/MOF reconstruction
- Reverse engineering `ntoskrnl.exe` ETW instrumentation (`EtwRegister`, `EtwWrite`, `EtwTraceKernelEvent`)
- Mapping ETW events to kernel APIs and syscall-reachable code paths
- Kernel trace flags / `PERFINFO_GROUPMASK` and undocumented enablement nuances

Use Cases:
- Build detections based on kernel-native ETW (process/thread/object/API audit events)
- Validate which Windows events are kernel-sourced vs user-mode mediated (tamper risk analysis)
- De-obfuscate/identify undocumented or opaque ETW events and their triggering conditions
- Improve EDR telemetry design by prioritizing kernel ETW over fragile user-mode hooks
- Research attacker bypass feasibility (what requires kernel privileges to suppress)

Keywords:
ETW, Kernel ETW, Microsoft-Windows-Kernel-Process, Microsoft-Windows-Kernel-Audit-API-Calls, Security-Auditing 4688, LSASS, ntdll hooks, syscall hooking, EtwWrite, EtwRegister, EtwTraceKernelEvent, TDH, WMI EventTrace, MOF, manifest, TraceLogging, WPP, PerfView, EtwExplorer, Ghidra, IDA, KrabsETW, PERFINFO_GROUPMASK, PsOpenProcess, NtTerminateProcess, SeAccessCheck, AutoLogger, Microsoft Defender for Endpoint (MDE)