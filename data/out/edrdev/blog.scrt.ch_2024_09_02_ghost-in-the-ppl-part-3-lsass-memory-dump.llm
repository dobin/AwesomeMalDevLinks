Title:
Ghost in the PPL Part 3: LSASS Memory Dump

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post details a userland exploit chain to obtain an LSASS memory dump even when LSASS runs as a Protected Process Light (PPL).  
- Instead of achieving code execution inside LSASS, the author pivots to triggering a dump via `MiniDumpWriteDump` indirectly by abusing `xolehlp.dll!WriteDumpThread`, which conveniently reads dump settings from the MSDTC registry and calls `MiniDumpWriteDump` with minimal arguments.  
- The chain includes coercing LSASS to load a chosen Microsoft-signed DLL using the WinSock2 Autodial DLL registry mechanism, and triggering the load via SSPI/Schannel revocation checking that causes LSASS to perform HTTP (CRL/OCSP) lookups.  
- It also covers enumerating modules in PPL LSASS without kernel drivers by scanning memory mappings with `NtQueryVirtualMemory`, and dynamically resolving internal function addresses by pattern-matching RIP-relative call/lea sequences around `QueueUserWorkItem`.  
- The final PoC combines these primitives with KeyIso/Ncrypt provider bugs (info leak + UAF) to trigger the dump and detect it via an opportunistic lock on `lsass.exe`.  
- It’s primarily useful for red teamers and exploit developers studying PPL constraints, userland-only LSASS dumping, and creative DLL load coercion, while also informing defenders about unusual registry and SSPI-driven behaviors.

Technical Focus:
- LSASS PPL constraints and userland dumping strategies
- `MiniDumpWriteDump` invocation via `xolehlp.dll!WriteDumpThread`
- WinSock2 Autodial DLL loading (`AutodialDll`) and process coercion
- SSPI/Schannel revocation checking (CRL/OCSP over HTTP) as a trigger
- PPL module enumeration via `NtQueryVirtualMemory` (mapped image filename)
- Runtime address resolution via RIP-relative pattern scanning (x64)

Use Cases:
- Dumping LSASS credentials on systems where LSASS is PPL-protected (research/PoC context)
- Coercing protected processes to load Microsoft-signed DLLs via Autodial registry manipulation
- Building userland-only telemetry/detections for suspicious AutodialDll changes and LSASS network activity
- Enumerating loaded modules in protected processes without a kernel driver
- Developing exploit chains that avoid hard-coded offsets by resolving targets dynamically

Keywords:
LSASS, PPL, Protected Process Light, MiniDumpWriteDump, xolehlp.dll, WriteDumpThread, dbghelp.dll, comsvcs.dll, rundll32, WinSock2, ws2_32.dll, AutodialDll, LoadAutodialHelperDll, SSPI, Schannel, AcquireCredentialsHandle, InitializeSecurityContext, SCH_CRED_REVOCATION_CHECK_CHAIN, CRL, OCSP, HTTP, NtQueryVirtualMemory, MemoryMappedFilenameInformation, QueueUserWorkItem, RIP-relative, pattern scanning, KeyIso, keyiso.dll, ncryptprov.dll, use-after-free, information disclosure, opportunistic lock (oplock)