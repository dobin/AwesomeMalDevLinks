Title:
Hidden Treasure: Intrusion Detection with ETW, Part 2

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how to consume Windows Event Tracing for Windows (ETW) at scale for intrusion detection, focusing on real-time collection rather than offline ETL analysis.  
- It addresses the core problem of ETW’s extremely high event volume and why naïvely forwarding ETW to a SIEM is impractical without aggressive on-host reduction.  
- The author compares common ETW consumer APIs and motivates the creation of **krabsetw**, an open-source library providing high-performance ETW consumption with filtering executed in native code to avoid managed allocation/GC overhead.  
- A concrete example shows monitoring DNS activity via the **Microsoft-Windows-DNS-Client** provider with EventId-based filtering and property extraction (QueryName/QueryResults).  
- It outlines operational strategies—**filtering, aggregation, and on-box alerting**—to reduce centralized processing bottlenecks in large fleets.  
- Useful primarily for Blue Teams/detection engineers and platform security teams building host-based telemetry pipelines; also valuable to red teamers for understanding what ETW can expose (DNS, network, image loads, injection, WMI, PowerShell).

Technical Focus:
- ETW real-time consumption (trace sessions, providers, callbacks)
- High-performance event filtering (native-side filtering, GC avoidance)
- ETW consumer APIs (TDH, TraceEvent, System.Diagnostics.Tracing, krabsetw)
- Telemetry reduction: aggregation and on-host alerting
- Detection mapping to ETW providers (DNS, kernel network, image load, thread, WMI, PowerShell)

Use Cases:
- Build a lightweight endpoint sensor that streams only security-relevant ETW events
- Implement per-process “netflow-like” aggregation from kernel network ETW
- Detect DNS-based C2/beaconing patterns using DNS client ETW events
- Reduce SIEM ingestion costs by filtering/alerting locally before forwarding
- Create forensic timelines for process behavior (DLL loads, injection, WMI persistence, PowerShell activity)

Keywords:
ETW, Event Tracing for Windows, krabsetw, TDH, StartTrace, StopTrace, ETL, xperf, logman, PerfView, Windows Performance Analyzer, Microsoft-Windows-DNS-Client, EventId 3018, EventId 3020, Kernel Network Provider, Kernel Image Load, Kernel Thread Provider, Microsoft-Windows-WMI, Microsoft-Windows-PowerShell, SIEM filtering, telemetry aggregation, on-host alerting