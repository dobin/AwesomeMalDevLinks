Title:
[Research] Walking Through Windows Minifilter Drivers (EN)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This write-up explains how Windows Minifilter drivers work (architecture, callback model, and user-mode communication) and why they are commonly used by AV/EDR/backup products to monitor file I/O.  
- It details the Filter Manager (`fltmgr.sys`) pipeline, altitude-based ordering, and how minifilters intercept IRP/Fast I/O via pre/post-operation callbacks instead of traditional dispatch routines.  
- The post includes a minimal example showing kernel↔user communication using filter communication ports (`FltCreateCommunicationPort`, `FltSendMessage`, `FilterConnectCommunicationPort`, `FilterGetMessage`).  
- It then performs a 1-day analysis of CVE-2024-30085 in the Windows Cloud Files minifilter (`cldflt.sys`), describing a heap-based buffer overflow caused by trusting a user-controlled bitmap size and bypassing validation in a specific parsing path.  
- The exploitation overview shows how to reach the vulnerable post-create path using CfAPI sync-root registration and crafted cloud reparse-point metadata, then leverage WNF/ALPC heap shaping, kernel pointer leaks, and token swapping for LPE.  
- Useful for kernel exploit developers, vulnerability researchers, and defenders wanting to understand minifilter attack surface and common parsing/validation failure modes.

Technical Focus:
- Windows Filter Manager / Minifilter architecture (`fltmgr.sys`, altitude ordering)
- IRP_MJ_* pre/post-operation callbacks and callback registration (`FLT_OPERATION_REGISTRATION`)
- Kernel↔user communication via Filter Communication Ports (FltMgr messaging APIs)
- Cloud Files / CfAPI internals (stub files, `IO_REPARSE_TAG_CLOUD`, sync roots)
- Kernel heap exploitation primitives (paged pool spraying, WNF_STATE_DATA, ALPC objects)
- LPE chain: kernel info leak + arbitrary R/W + EPROCESS token stealing

Use Cases:
- Reverse engineering and auditing Windows minifilter drivers for parsing/validation bugs
- Building file I/O monitoring or policy enforcement prototypes using minifilter callbacks
- Reproducing and understanding CVE-2024-30085 trigger conditions and vulnerable code paths
- Developing kernel heap grooming strategies using WNF/ALPC for exploit research
- Creating detections around suspicious CfAPI sync-root registration and reparse-point abuse

Keywords:
Windows minifilter, fltmgr.sys, cldflt.sys, CVE-2024-30085, Filter Manager, altitude, IRP_MJ_CREATE, PFLT_PRE_OPERATION_CALLBACK, PFLT_POST_OPERATION_CALLBACK, FLT_OPERATION_REGISTRATION, FltRegisterFilter, FltStartFiltering, FltCreateCommunicationPort, FltSendMessage, FilterConnectCommunicationPort, reparse point, IO_REPARSE_TAG_CLOUD, CfRegisterSyncRoot, stub file, heap-based buffer overflow, ExAllocatePoolWithTag, memmove, WNF_STATE_DATA, ALPC, NtAlpcCreateResourceReserve, token stealing, EPROCESS