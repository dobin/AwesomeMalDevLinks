# https://github.com/xuanxuan0/TiEtwAgent

[Skip to content](https://github.com/xuanxuan0/TiEtwAgent#start-of-content)

You signed in with another tab or window. [Reload](https://github.com/xuanxuan0/TiEtwAgent) to refresh your session.You signed out in another tab or window. [Reload](https://github.com/xuanxuan0/TiEtwAgent) to refresh your session.You switched accounts on another tab or window. [Reload](https://github.com/xuanxuan0/TiEtwAgent) to refresh your session.Dismiss alert

{{ message }}

[xuanxuan0](https://github.com/xuanxuan0)/ **[TiEtwAgent](https://github.com/xuanxuan0/TiEtwAgent)** Public

- [Notifications](https://github.com/login?return_to=%2Fxuanxuan0%2FTiEtwAgent) You must be signed in to change notification settings
- [Fork\\
45](https://github.com/login?return_to=%2Fxuanxuan0%2FTiEtwAgent)
- [Star\\
298](https://github.com/login?return_to=%2Fxuanxuan0%2FTiEtwAgent)


PoC memory injection detection agent based on ETW, for offensive and defensive research purposes


[blog.redbluepurple.io/windows-security-research/kernel-tracing-injection-detection](https://blog.redbluepurple.io/windows-security-research/kernel-tracing-injection-detection "https://blog.redbluepurple.io/windows-security-research/kernel-tracing-injection-detection")

[298\\
stars](https://github.com/xuanxuan0/TiEtwAgent/stargazers) [45\\
forks](https://github.com/xuanxuan0/TiEtwAgent/forks) [Branches](https://github.com/xuanxuan0/TiEtwAgent/branches) [Tags](https://github.com/xuanxuan0/TiEtwAgent/tags) [Activity](https://github.com/xuanxuan0/TiEtwAgent/activity)

[Star](https://github.com/login?return_to=%2Fxuanxuan0%2FTiEtwAgent)

[Notifications](https://github.com/login?return_to=%2Fxuanxuan0%2FTiEtwAgent) You must be signed in to change notification settings

# xuanxuan0/TiEtwAgent

master

[**1** Branch](https://github.com/xuanxuan0/TiEtwAgent/branches) [**1** Tag](https://github.com/xuanxuan0/TiEtwAgent/tags)

[Go to Branches page](https://github.com/xuanxuan0/TiEtwAgent/branches)[Go to Tags page](https://github.com/xuanxuan0/TiEtwAgent/tags)

Go to file

Code

Open more actions menu

## Folders and files

| Name | Name | Last commit message | Last commit date |
| --- | --- | --- | --- |
| ## Latest commit<br>![author](https://github.githubassets.com/images/gravatars/gravatar-user-420.png?size=40)<br>Filip Olszak<br>[Merge branch 'master' of](https://github.com/xuanxuan0/TiEtwAgent/commit/c0e8f8a16ac4cdfa058b039c052d170e1d416755) [https://github.com/xinbailu/TiEtwAgent](https://github.com/xinbailu/TiEtwAgent)<br>5 years agoApr 10, 2021<br>[c0e8f8a](https://github.com/xuanxuan0/TiEtwAgent/commit/c0e8f8a16ac4cdfa058b039c052d170e1d416755) · 5 years agoApr 10, 2021<br>## History<br>[27 Commits](https://github.com/xuanxuan0/TiEtwAgent/commits/master/) <br>Open commit details<br>[View commit history for this file.](https://github.com/xuanxuan0/TiEtwAgent/commits/master/) 27 Commits |
| [.github/workflows](https://github.com/xuanxuan0/TiEtwAgent/tree/master/.github/workflows "This path skips through empty directories") | [.github/workflows](https://github.com/xuanxuan0/TiEtwAgent/tree/master/.github/workflows "This path skips through empty directories") | [Create msbuild.yml](https://github.com/xuanxuan0/TiEtwAgent/commit/317feca19e47c82b9c4c6dc4704a0bdff570120b "Create msbuild.yml") | 5 years agoApr 3, 2021 |
| [agent](https://github.com/xuanxuan0/TiEtwAgent/tree/master/agent "agent") | [agent](https://github.com/xuanxuan0/TiEtwAgent/tree/master/agent "agent") | [add default detection message](https://github.com/xuanxuan0/TiEtwAgent/commit/3dcb12817d63fd5a7606eea3950cb016205e7eb2 "add default detection message") | 5 years agoApr 10, 2021 |
| [packages](https://github.com/xuanxuan0/TiEtwAgent/tree/master/packages "packages") | [packages](https://github.com/xuanxuan0/TiEtwAgent/tree/master/packages "packages") | [refactor](https://github.com/xuanxuan0/TiEtwAgent/commit/ec1556cc7969784edc2ebd915d613b331d75f172 "refactor") | 5 years agoApr 10, 2021 |
| [rules @ 3872244](https://github.com/Yara-Rules/rules/tree/3872244500f584491cde7c633f12f1f043a61c13 "rules") | [rules @ 3872244](https://github.com/Yara-Rules/rules/tree/3872244500f584491cde7c633f12f1f043a61c13 "rules") | [Link to yararules](https://github.com/xuanxuan0/TiEtwAgent/commit/02a7d98d9880e128cd30d24f33b877ca0b31e194 "Link to yararules") | 5 years agoApr 3, 2021 |
| [.gitattributes](https://github.com/xuanxuan0/TiEtwAgent/blob/master/.gitattributes ".gitattributes") | [.gitattributes](https://github.com/xuanxuan0/TiEtwAgent/blob/master/.gitattributes ".gitattributes") | [Add .gitignore and .gitattributes.](https://github.com/xuanxuan0/TiEtwAgent/commit/9e05acb178c78911e870036cb480532b85e7b232 "Add .gitignore and .gitattributes.") | 5 years agoApr 3, 2021 |
| [.gitignore](https://github.com/xuanxuan0/TiEtwAgent/blob/master/.gitignore ".gitignore") | [.gitignore](https://github.com/xuanxuan0/TiEtwAgent/blob/master/.gitignore ".gitignore") | [Update .gitignore](https://github.com/xuanxuan0/TiEtwAgent/commit/19e0b8dcf56d2af7fbe52cf64b7fa118f7479b4d "Update .gitignore") | 5 years agoApr 3, 2021 |
| [.gitmodules](https://github.com/xuanxuan0/TiEtwAgent/blob/master/.gitmodules ".gitmodules") | [.gitmodules](https://github.com/xuanxuan0/TiEtwAgent/blob/master/.gitmodules ".gitmodules") | [Link to yararules](https://github.com/xuanxuan0/TiEtwAgent/commit/02a7d98d9880e128cd30d24f33b877ca0b31e194 "Link to yararules") | 5 years agoApr 3, 2021 |
| [README.md](https://github.com/xuanxuan0/TiEtwAgent/blob/master/README.md "README.md") | [README.md](https://github.com/xuanxuan0/TiEtwAgent/blob/master/README.md "README.md") | [Update README.md](https://github.com/xuanxuan0/TiEtwAgent/commit/6c6ab21b4c3ea5da633e02b325b8f585b8ec48e1 "Update README.md") | 5 years agoApr 10, 2021 |
| [ti\_etw\_agent.sln](https://github.com/xuanxuan0/TiEtwAgent/blob/master/ti_etw_agent.sln "ti_etw_agent.sln") | [ti\_etw\_agent.sln](https://github.com/xuanxuan0/TiEtwAgent/blob/master/ti_etw_agent.sln "ti_etw_agent.sln") | [Add project files.](https://github.com/xuanxuan0/TiEtwAgent/commit/8376629cb74f81268618e82f56a5e0dcebb67560 "Add project files.") | 5 years agoApr 3, 2021 |
| View all files |

## Repository files navigation

# TiEtwAgent - ETW-based process injection detection

[Permalink: TiEtwAgent - ETW-based process injection detection](https://github.com/xuanxuan0/TiEtwAgent#tietwagent---etw-based-process-injection-detection)

[![msbuild](https://github.com/xinbailu/TiEtwAgent/actions/workflows/msbuild.yml/badge.svg)](https://github.com/xinbailu/TiEtwAgent/actions/workflows/msbuild.yml/badge.svg)

This project was created to research, build and test different memory injection detection use cases and bypass techniques. The agent utilizes Microsoft-Windows-Threat-Intelligence event tracing provider, as a more modern and stable alternative to Userland-hooking, with the benefit of Kernel-mode visibility.

The project depends on the [microsoft/krabsetw](https://github.com/microsoft/krabsetw) library for ETS setup and consumption.

An accompanying blog post can be found here: [https://blog.redbluepurple.io/windows-security-research/kernel-tracing-injection-detection](https://blog.redbluepurple.io/windows-security-research/kernel-tracing-injection-detection)

[![gif](https://camo.githubusercontent.com/a07b3092797cdef789227b21b9780f8bf7f54c500df6ce46a7189ed267611ffd/68747470733a2f2f692e696d6775722e636f6d2f4d3951586b317a2e676966)](https://camo.githubusercontent.com/a07b3092797cdef789227b21b9780f8bf7f54c500df6ce46a7189ed267611ffd/68747470733a2f2f692e696d6775722e636f6d2f4d3951586b317a2e676966)[![gif](https://camo.githubusercontent.com/a07b3092797cdef789227b21b9780f8bf7f54c500df6ce46a7189ed267611ffd/68747470733a2f2f692e696d6775722e636f6d2f4d3951586b317a2e676966)](https://camo.githubusercontent.com/a07b3092797cdef789227b21b9780f8bf7f54c500df6ce46a7189ed267611ffd/68747470733a2f2f692e696d6775722e636f6d2f4d3951586b317a2e676966)[Open in new window](https://camo.githubusercontent.com/a07b3092797cdef789227b21b9780f8bf7f54c500df6ce46a7189ed267611ffd/68747470733a2f2f692e696d6775722e636f6d2f4d3951586b317a2e676966)

# Adding new detections

[Permalink: Adding new detections](https://github.com/xuanxuan0/TiEtwAgent#adding-new-detections)

Detection functions can be easily added in `DetectionLogic.cpp`, and called from `detect_event(GenericEvent evt)` for any source event type. Support for new event fields can be easily added by appending their name to the map in `GenericEvent` class declaration.

# Setup instructions

[Permalink: Setup instructions](https://github.com/xuanxuan0/TiEtwAgent#setup-instructions)

Assuming you do not have a Microsoft-trusted signing certificate:

- Put your machine in the test signing mode with bcdedit
- Generate a self-signed certificate with ELAM and Code Signing EKU
- Sign TiEtwAgent.exe and your ELAM driver with the certificate
- ./TiEtwAgent install
- net start TiEtwAgent
- Look for logs, by default in C:\\Windows\\Temp\\TiEtwAgent.txt

# TODO

[Permalink: TODO](https://github.com/xuanxuan0/TiEtwAgent#todo)

- [x]  PPL Service, event parsing
- [x]  First detection
- [ ]  Detection lifecycle
- [ ]  Risk based lifecycle

PS. If you do not want to write an ELAM driver, you can get one from [https://github.com/pathtofile/PPLRunner/tree/main/elam\_driver](https://github.com/pathtofile/PPLRunner/tree/main/elam_driver)

Special thanks to [@pathtofile](https://github.com/pathtofile) for the post here: [https://blog.tofile.dev/2020/12/16/elam.html](https://blog.tofile.dev/2020/12/16/elam.html)

## About

PoC memory injection detection agent based on ETW, for offensive and defensive research purposes


[blog.redbluepurple.io/windows-security-research/kernel-tracing-injection-detection](https://blog.redbluepurple.io/windows-security-research/kernel-tracing-injection-detection "https://blog.redbluepurple.io/windows-security-research/kernel-tracing-injection-detection")

### Topics

[security](https://github.com/topics/security "Topic: security") [detection](https://github.com/topics/detection "Topic: detection") [injection](https://github.com/topics/injection "Topic: injection") [memory-scanning](https://github.com/topics/memory-scanning "Topic: memory-scanning") [edr](https://github.com/topics/edr "Topic: edr")

### Resources

[Readme](https://github.com/xuanxuan0/TiEtwAgent#readme-ov-file)

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/xuanxuan0/TiEtwAgent).

[Activity](https://github.com/xuanxuan0/TiEtwAgent/activity)

### Stars

[**298**\\
stars](https://github.com/xuanxuan0/TiEtwAgent/stargazers)

### Watchers

[**8**\\
watching](https://github.com/xuanxuan0/TiEtwAgent/watchers)

### Forks

[**45**\\
forks](https://github.com/xuanxuan0/TiEtwAgent/forks)

[Report repository](https://github.com/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fxuanxuan0%2FTiEtwAgent&report=xuanxuan0+%28user%29)

## [Releases](https://github.com/xuanxuan0/TiEtwAgent/releases)

[1tags](https://github.com/xuanxuan0/TiEtwAgent/tags)

## [Packages\  0](https://github.com/users/xuanxuan0/packages?repo_name=TiEtwAgent)

No packages published

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/xuanxuan0/TiEtwAgent).

## Languages

- [C85.5%](https://github.com/xuanxuan0/TiEtwAgent/search?l=c)
- [C++14.5%](https://github.com/xuanxuan0/TiEtwAgent/search?l=c%2B%2B)

You can’t perform that action at this time.