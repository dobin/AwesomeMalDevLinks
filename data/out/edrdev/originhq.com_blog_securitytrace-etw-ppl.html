# https://www.originhq.com/blog/securitytrace-etw-ppl

<!DOCTYPE html><!--UCl_a0aupBtM8Ugyf9aS0--><html lang="en"><body class="inter_fe8b9d92-module__LINzvG__variable"><div><!--$--><!--/$--></div><div class="relative w-full bg-[#ccc] font-sans min-h-screen text-white"><div class="fixed inset-0 z-[3] w-full h-full mix-blend-difference pointer-events-none" style="background:url(&quot;/bg-1.png&quot;) center center no-repeat;background-size:cover;filter:blur(0px) brightness(0.5) contrast(1.5) grayscale(1)"></div><canvas id="noise-canvas" class="fixed inset-0 z-[1] w-full h-full pointer-events-none mix-blend-difference grayscale" width="1919" height="992"></canvas><div class="fixed top-0 bottom-0 left-0 w-[42px] md:w-[54px] flex flex-col justify-between items-center z-[1] bg-[rgba(190,190,190,0.5)]"></div><div class="fixed top-0 bottom-0 left-0 w-[42px] md:w-[54px] flex flex-col justify-end items-center z-10 py-[20px] px-[10px] md:py-[30px] md:px-[15px]"><a href="https://www.originhq.com/"><svg width="100%" viewBox="0 0 52 224" xmlns="http://www.w3.org/2000/svg" class="fill-[#333] hover:fill-white transition-colors cursor-pointer"><path d="M45.2947 223.464L-2.55369e-07 223.464L-7.65283e-07 211.799L4.2081 211.799L4.2081 218.386L41.0866 218.386L41.0866 211.799L45.2947 211.799L45.2947 223.464ZM42.4006 202.419L40.3764 205.367L2.94744 179.834L4.97159 176.869L42.4006 202.419ZM22.6385 174.685C26.5211 174.685 29.8591 175.395 32.6527 176.816C35.4344 178.236 37.5769 180.183 39.0803 182.657C40.5717 185.119 41.3175 187.919 41.3175 191.056C41.3175 194.204 40.5717 197.016 39.0803 199.49C37.5769 201.952 35.4285 203.893 32.6349 205.313C29.8414 206.734 26.5092 207.444 22.6385 207.444C18.7559 207.444 15.4238 206.734 12.642 205.313C9.84848 203.893 7.70596 201.952 6.21449 199.49C4.71117 197.016 3.95951 194.204 3.95951 191.056C3.95951 187.919 4.71117 185.119 6.21449 182.657C7.70596 180.183 9.84848 178.236 12.642 176.816C15.4238 175.395 18.7559 174.685 22.6385 174.685ZM22.6385 180.118C19.6792 180.118 17.1875 180.597 15.1633 181.556C13.1274 182.503 11.5885 183.805 10.5469 185.463C9.49337 187.108 8.96662 188.972 8.96662 191.056C8.96662 193.151 9.49337 195.021 10.5469 196.666C11.5885 198.312 13.1274 199.614 15.1633 200.573C17.1875 201.52 19.6792 201.993 22.6385 201.993C25.5978 201.993 28.0954 201.52 30.1314 200.573C32.1555 199.614 33.6944 198.312 34.7479 196.666C35.7895 195.021 36.3104 193.151 36.3104 191.056C36.3104 188.972 35.7895 187.108 34.7479 185.463C33.6944 183.805 32.1555 182.503 30.1314 181.556C28.0954 180.597 25.5978 180.118 22.6385 180.118ZM-3.08861e-06 158.647L45.2947 158.647L45.2947 170.313L41.0866 170.313L41.0866 163.725L4.20809 163.725L4.20809 170.313L-2.5787e-06 170.313L-3.08861e-06 158.647ZM22.6385 104.128C26.5211 104.128 29.8591 104.838 32.6527 106.259C35.4344 107.679 37.5769 109.627 39.0803 112.101C40.5717 114.563 41.3175 117.362 41.3175 120.499C41.3175 123.648 40.5717 126.459 39.0803 128.933C37.5769 131.395 35.4285 133.336 32.6349 134.757C29.8414 136.177 26.5092 136.887 22.6385 136.887C18.7559 136.887 15.4238 136.177 12.642 134.757C9.84848 133.336 7.70596 131.395 6.21448 128.933C4.71117 126.459 3.95951 123.648 3.95951 120.499C3.95951 117.362 4.71117 114.563 6.21448 112.101C7.70596 109.627 9.84848 107.679 12.642 106.259C15.4238 104.838 18.7559 104.128 22.6385 104.128ZM22.6385 109.561C19.6792 109.561 17.1875 110.041 15.1633 111C13.1274 111.947 11.5885 113.249 10.5469 114.906C9.49337 116.551 8.96661 118.416 8.96661 120.499C8.96661 122.594 9.49337 124.464 10.5469 126.11C11.5885 127.755 13.1274 129.057 15.1633 130.016C17.1875 130.963 19.6792 131.436 22.6385 131.436C25.5978 131.436 28.0954 130.963 30.1314 130.016C32.1555 129.057 33.6944 127.755 34.7479 126.11C35.7895 124.464 36.3104 122.594 36.3104 120.499C36.3104 118.416 35.7895 116.551 34.7479 114.906C33.6944 113.249 32.1555 111.947 30.1314 111C28.0954 110.041 25.5978 109.561 22.6385 109.561ZM40.8203 97.714L13.5476 97.714L13.5476 92.5826L17.88 92.5826L17.88 92.2985C16.4122 91.8013 15.258 90.9254 14.4176 89.6706C13.5653 88.4041 13.1392 86.9718 13.1392 85.3738C13.1392 85.0423 13.151 84.6517 13.1747 84.2019C13.1984 83.7402 13.228 83.3792 13.2635 83.1188L18.3416 83.1188C18.2824 83.3319 18.2173 83.7107 18.1463 84.2552C18.0634 84.7997 18.022 85.3442 18.022 85.8887C18.022 87.1434 18.2883 88.262 18.821 89.2445C19.3418 90.2152 20.0698 90.9846 21.005 91.5527C21.9283 92.1209 22.9818 92.405 24.1655 92.405L40.8203 92.405L40.8203 97.714ZM40.8203 78.5245L13.5476 78.5245L13.5476 73.2156L40.8203 73.2156L40.8203 78.5245ZM9.33948 75.8434C9.33948 76.7667 9.03172 77.5598 8.41618 78.2227C7.78882 78.8737 7.04308 79.1992 6.17897 79.1992C5.30302 79.1992 4.55728 78.8737 3.94175 78.2227C3.31439 77.5598 3.0007 76.7667 3.0007 75.8434C3.0007 74.9201 3.31439 74.1329 3.94175 73.4819C4.55728 72.819 5.30302 72.4876 6.17897 72.4876C7.04308 72.4876 7.78882 72.819 8.41618 73.4819C9.03172 74.1329 9.33948 74.9201 9.33948 75.8434ZM51.6158 54.6387C51.6158 56.8049 51.3317 58.6692 50.7635 60.2317C50.1953 61.7824 49.4436 63.049 48.5085 64.0314C47.5734 65.0139 46.5495 65.7478 45.4368 66.2331L43.5547 61.6699C44.0755 61.3503 44.6259 60.9242 45.206 60.3915C45.7978 59.847 46.3009 59.1131 46.7152 58.1898C47.1295 57.2547 47.3366 56.0532 47.3366 54.5854C47.3366 52.5731 46.8454 50.91 45.8629 49.5961C44.8923 48.2821 43.3416 47.6252 41.2109 47.6252L35.8487 47.6252L35.8487 47.9625C36.4287 48.2821 37.0739 48.7438 37.7841 49.3475C38.4943 49.9393 39.1098 50.7561 39.6307 51.7978C40.1515 52.8394 40.4119 54.1948 40.4119 55.8638C40.4119 58.0182 39.9088 59.9595 38.9027 61.6877C37.8847 63.4041 36.3873 64.7653 34.4105 65.7715C32.4219 66.7658 29.9775 67.263 27.0774 67.263C24.1773 67.263 21.6915 66.7717 19.62 65.7893C17.5485 64.7949 15.9624 63.4337 14.8615 61.7054C13.7488 59.9772 13.1925 58.0182 13.1925 55.8283C13.1925 54.1356 13.4766 52.7684 14.0447 51.7268C14.6011 50.6851 15.2521 49.8742 15.9979 49.2942C16.7436 48.7024 17.4006 48.2466 17.9687 47.927L17.9687 47.5364L13.5476 47.5364L13.5476 42.334L41.424 42.334C43.7677 42.334 45.6913 42.8785 47.1946 43.9675C48.6979 45.0565 49.8106 46.5303 50.5327 48.3887C51.2547 50.2353 51.6158 52.3186 51.6158 54.6387ZM36.0085 54.6919C36.0085 53.165 35.6534 51.8747 34.9432 50.8212C34.2211 49.7559 33.1913 48.9509 31.8537 48.4064C30.5043 47.8501 28.8885 47.5719 27.0064 47.5719C25.1716 47.5719 23.5559 47.8442 22.1591 48.3887C20.7623 48.9332 19.6733 49.7322 18.892 50.7857C18.099 51.8392 17.7024 53.1413 17.7024 54.6919C17.7024 56.29 18.1167 57.6216 18.9453 58.687C19.7621 59.7523 20.8748 60.5572 22.2834 61.1017C23.692 61.6344 25.2663 61.9008 27.0064 61.9008C28.7938 61.9008 30.3622 61.6285 31.7116 61.084C33.0611 60.5395 34.1146 59.7346 34.8722 58.6692C35.6297 57.592 36.0085 56.2663 36.0085 54.6919ZM40.8203 35.214L13.5476 35.214L13.5476 29.905L40.8203 29.905L40.8203 35.214ZM9.33948 32.5329C9.33948 33.4562 9.03171 34.2492 8.41618 34.9121C7.78882 35.5632 7.04308 35.8887 6.17897 35.8887C5.30302 35.8887 4.55728 35.5632 3.94175 34.9121C3.31438 34.2492 3.0007 33.4562 3.0007 32.5329C3.0007 31.6096 3.31438 30.8224 3.94175 30.1714C4.55728 29.5085 5.30302 29.177 6.17897 29.177C7.04308 29.177 7.78882 29.5085 8.41618 30.1714C9.03171 30.8224 9.33948 31.6096 9.33948 32.5329ZM24.6271 17.4538L40.8203 17.4538L40.8203 22.7628L13.5476 22.7628L13.5476 17.6669L17.9865 17.6669L17.9865 17.3296C16.5424 16.7022 15.3823 15.7197 14.5064 14.3821C13.6304 13.0327 13.1925 11.3341 13.1925 9.28623C13.1925 7.4278 13.5831 5.8002 14.3643 4.40342C15.1337 3.00664 16.2819 1.92354 17.8089 1.15413C19.3359 0.384716 21.2239 8.6091e-06 23.473 8.51079e-06L40.8203 7.75251e-06L40.8203 5.30896L24.1122 5.30896C22.1354 5.30896 20.5907 5.82387 19.478 6.8537C18.3534 7.88353 17.7912 9.29807 17.7912 11.0973C17.7912 12.3284 18.0575 13.4233 18.5902 14.3821C19.1229 15.3291 19.9041 16.0807 20.9339 16.6371C21.9519 17.1816 23.183 17.4538 24.6271 17.4538Z"></path></svg></a></div><div class="relative ml-[42px] md:ml-[54px] min-h-screen flex flex-col"><div class="relative pt-[20px] md:pt-[30px] px-[15px] md:px-[5vw] lg:px-[10vw] flex flex-col"><div class="absolute z-10 top-0 left-0 bottom-0 right-0 bg-[#333] mix-blend-difference"></div><div class="absolute z-10 top-0 left-0 bottom-0 right-0 bg-[#eeeeeecc]"></div><article class="relative z-10 prose prose-invert max-w-[800px]"><div class="relative w-max z-10 text-[12px] leading-[14px] md:text-[14px] md:leading-[18px] lg:text-[16px] lg:leading-[18px] md:uppercase font-[500] md:font-[600] text-[#999] rounded-[16px]">Next Generation <br> Endpoint Security</div><h1 class="mt-[24px] md:mt-[32px] lg:mt-[42px] text-[5vw] leading-[5vw] md:text-[36px] md:leading-[36px] font-black text-[#333] mb-4 uppercase">Check Your Privilege: The Curious Case of ETW's SecurityTrace Flag</h1><div class="text-[#666] mb-8 text-sm uppercase">2026-01-19<!-- --> - <!-- -->Connor McGarr</div><div class="
              bg-[#e3e3e3] py-2 md:py-4 px-2 md:px-4
              block text-[14px] leading-[18px] lg:text-[16px] lg:leading-[22px] font-[400] text-[#333]
              [&amp;_*]:first:mt-0 [&amp;_*]:last:mb-0
              [&amp;_h1]:my-6 [&amp;_h1]:text-[18px] [&amp;_h1]:leading-[24px] [&amp;_h1]:font-[600]
              [&amp;_h2]:my-6 [&amp;_h2]:text-[16px] [&amp;_h2]:leading-[20px] [&amp;_h2]:font-[500]
              [&amp;_p]:my-6 [&amp;_p]:text-[14px] [&amp;_p]:leading-[22px]
              [&amp;_table]:my-6 [&amp;_table]:w-full [&amp;_table]:border-collapse [&amp;_th]:text-left [&amp;_th]:font-[600] [&amp;_th]:text-[14px]
              [&amp;_th]:px-3 [&amp;_th]:py-2 [&amp;_td]:px-3 [&amp;_td]:py-2 [&amp;_th]:border [&amp;_td]:border [&amp;_th]:border-[#ccc] [&amp;_td]:border-[#ccc] [&amp;_td]:text-[14px]
              [&amp;_a]:text-[#000] [&amp;_a]:hover:text-[#666] [&amp;_a]:cursor [&amp;_a]:border-b-1 [&amp;_a]:border-dotted [&amp;_a]:border-[#000] [&amp;_a]:hover:border-[#666]
              [&amp;_li_p]:py-0 [&amp;_li_p]:my-0
              [&amp;_ul]:mx-4 [&amp;_ul]:my-1 [&amp;_ul]:list-disc [&amp;_ul]:text-[14px] [&amp;_ul>li]:py-1 [&amp;_ul>li]:px-2
              [&amp;_ol]:mx-4 [&amp;_ol]:my-1 [&amp;_ol]:list-decimal [&amp;_ol]:text-[14px] [&amp;_ol>li]:py-1 [&amp;_ol>li]:px-2
              [&amp;_blockquote]:my-6 [&amp;_blockquote]:pl-4 [&amp;_blockquote]:border-l-[3px] [&amp;_blockquote]:border-[#999] [&amp;_blockquote]:text-[#555] [&amp;_blockquote]:italic
              [&amp;_pre]:text-[14px] [&amp;_pre]:block [&amp;_pre]:p-[10px] [&amp;_pre]:overflow-auto [&amp;_pre]:rounded
              [&amp;_code]:text-[14px] [&amp;>p>code]:only:block [&amp;>p>code]:only:p-[10px] [&amp;>p>code]:only:bg-[#eeeeee] [&amp;>p>code]:only:overflow-auto
              overflow-hidden
            "><article><h1>Introduction</h1><p>Recently, while investigating new feature development for our <a href="https://www.preludesecurity.com/runtime-memory-protection">Origin (by Prelude) Runtime Memory Protection</a> research preview product, we were forced to dig into the inner-workings of Event Tracing for Windows (ETW). In the course of leveraging our internal ETW tooling, which executes at a signing and protection level of <a href="https://www.alex-ionescu.com/the-evolution-of-protected-processes-pass-the-hash-mitigations-in-windows-8-1/">Antimalware Protected Process Light (PPL)</a>, we noticed that it was possible to issue a "stop trace" code to a target ETW session that had an undocumented "security trace" flag enabled - which will be the topic of this blog post - without (seemingly) the necessary privileges required. This undocumented flag appears to ensure that only processes running at Antimalware-PPL can interact with or modify any ETW trace session with this flag enabled. In practice, it seems most applicable to AutoLogger ETW trace sessions (as we will see later). Yet we were able to stop the trace session with only administrative privileges, without any special signing or elevated protection level. If you're familiar with Windows internals you will know that - even if not <em>officially</em> acknowledged - resources created or managed by a protected process generally should not be modifiable by less-privileged entities, including administrative processes. Given that this flag appears to delegate trace-session management exclusively to Antimalware-PPL processes, our interest was piqued.</p><p>As we set out to determine how any of this was possible in the first place, this led us to identifying both how to configure and manage this undocumented "security trace" ETW flag without needing Antimalware-PPL. However, and much more practical and impactful, <strong>this allowed us to identify a new method to consume events from ETW providers which require Antimalware-PPL, like Microsoft-Windows-Threat-Intelligence, without running as Antimalware-PPL <em>and</em> without relying on a kernel driver - or any of the usual "patch-the-kernel" gymnastics researchers have historically relied on</strong>. Alongside this post, we are also releasing a public proof of concept that encapsulates this research: <a href="https://github.com/preludeorg/ThreatIntelligenceConsumer">ThreatIntelligenceConsumer</a>.</p><h1>ETW Session Management</h1><p>Although the functionality for creating and managing ETW sessions is exposed in user-mode on Windows, the kernel is still responsible for the <em>true</em> management of resources related to trace sessions. One of the primary structures used by the kernel to manage a specific ETW session is through the <code>WMI_LOGGER_CONTEXT</code> structure.</p><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#24292E">lkd</span><span style="color:#D73A49">&gt;</span><span style="color:#24292E"> dt nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_WMI_LOGGER_CONTEXT</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x000</span><span style="color:#6F42C1"> LoggerId</span><span style="color:#24292E">         : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x004</span><span style="color:#6F42C1"> BufferSize</span><span style="color:#24292E">       : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x008</span><span style="color:#6F42C1"> MaximumEventSize</span><span style="color:#24292E"> : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x00c</span><span style="color:#6F42C1"> LoggerMode</span><span style="color:#24292E">       : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x010</span><span style="color:#6F42C1"> AcceptNewEvents</span><span style="color:#24292E">  : Int4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x018</span><span style="color:#6F42C1"> GetCpuClock</span><span style="color:#24292E">      : Uint8B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x020</span><span style="color:#6F42C1"> LoggerThread</span><span style="color:#24292E">     : Ptr64 _ETHREAD</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x028</span><span style="color:#6F42C1"> LoggerStatus</span><span style="color:#24292E">     : Int4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x02c</span><span style="color:#6F42C1"> FailureReason</span><span style="color:#24292E">    : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x030</span><span style="color:#6F42C1"> BufferQueue</span><span style="color:#24292E">      : _ETW_BUFFER_QUEUE</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x040</span><span style="color:#6F42C1"> OverflowQueue</span><span style="color:#24292E">    : _ETW_BUFFER_QUEUE</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x050</span><span style="color:#6F42C1"> GlobalList</span><span style="color:#24292E">       : _LIST_ENTRY</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x060</span><span style="color:#6F42C1"> DebugIdTrackingList</span><span style="color:#24292E"> : _LIST_ENTRY</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x070</span><span style="color:#6F42C1"> DecodeControlList</span><span style="color:#24292E"> : Ptr64 _ETW_DECODE_CONTROL_ENTRY</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x078</span><span style="color:#6F42C1"> DecodeControlCount</span><span style="color:#24292E"> : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x080</span><span style="color:#6F42C1"> BatchedBufferList</span><span style="color:#24292E"> : Ptr64 _WMI_BUFFER_HEADER</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x080</span><span style="color:#6F42C1"> CurrentBuffer</span><span style="color:#24292E">    : _EX_FAST_REF</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x088</span><span style="color:#6F42C1"> LoggerName</span><span style="color:#24292E">       : _UNICODE_STRING</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x098</span><span style="color:#6F42C1"> LogFileName</span><span style="color:#24292E">      : _UNICODE_STRING</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x0a8</span><span style="color:#6F42C1"> LogFilePattern</span><span style="color:#24292E">   : _UNICODE_STRING</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x0b8</span><span style="color:#6F42C1"> NewLogFileName</span><span style="color:#24292E">   : _UNICODE_STRING</span></span>
<span class="line"><span style="color:#D73A49">&lt;---</span><span style="color:#24292E"> Truncated </span><span style="color:#D73A49">---&gt;</span></span></code></pre></div><p>This structure, which is quite large, manages a lot of the data and metadata needed for the session including the name of the logger, the state of ETW buffers being written to, Last Branch Record (LBR) and Intel Processor Trace (IPT) <a href="https://www.originhq.com/Closing%20the%20Execution%20Gap.pdf">ETW enablement status if applicable</a>, flags, and other items of interest. For the purposes of this blog post, we will examine the various flags which are present.</p><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> Flags</span><span style="color:#24292E">            : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> Persistent</span><span style="color:#24292E">       : Pos </span><span style="color:#005CC5">0</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> AutoLogger</span><span style="color:#24292E">       : Pos </span><span style="color:#005CC5">1</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> FsReady</span><span style="color:#24292E">          : Pos </span><span style="color:#005CC5">2</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> RealTime</span><span style="color:#24292E">         : Pos </span><span style="color:#005CC5">3</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> Wow</span><span style="color:#24292E">              : Pos </span><span style="color:#005CC5">4</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> KernelTrace</span><span style="color:#24292E">      : Pos </span><span style="color:#005CC5">5</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> NoMoreEnable</span><span style="color:#24292E">     : Pos </span><span style="color:#005CC5">6</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> StackTracing</span><span style="color:#24292E">     : Pos </span><span style="color:#005CC5">7</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> ErrorLogged</span><span style="color:#24292E">      : Pos </span><span style="color:#005CC5">8</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> RealtimeLoggerContextFreed</span><span style="color:#24292E"> : Pos </span><span style="color:#005CC5">9</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> PebsTracing</span><span style="color:#24292E">      : Pos </span><span style="color:#005CC5">10</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> PmcCounters</span><span style="color:#24292E">      : Pos </span><span style="color:#005CC5">11</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> PageAlignBuffers</span><span style="color:#24292E"> : Pos </span><span style="color:#005CC5">12</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> StackLookasideListAllocated</span><span style="color:#24292E"> : Pos </span><span style="color:#005CC5">13</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> SecurityTrace</span><span style="color:#24292E">    : Pos </span><span style="color:#005CC5">14</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> LastBranchTracing</span><span style="color:#24292E"> : Pos </span><span style="color:#005CC5">15</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> SystemLoggerIndex</span><span style="color:#24292E"> : Pos </span><span style="color:#005CC5">16</span><span style="color:#24292E">, </span><span style="color:#005CC5">8</span><span style="color:#24292E"> Bits</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> StackCaching</span><span style="color:#24292E">     : Pos </span><span style="color:#005CC5">24</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> ProviderTracking</span><span style="color:#24292E"> : Pos </span><span style="color:#005CC5">25</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> ProcessorTrace</span><span style="color:#24292E">   : Pos </span><span style="color:#005CC5">26</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> QpcDeltaTracking</span><span style="color:#24292E"> : Pos </span><span style="color:#005CC5">27</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> MarkerBufferSaved</span><span style="color:#24292E"> : Pos </span><span style="color:#005CC5">28</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> LargeMdlPages</span><span style="color:#24292E">    : Pos </span><span style="color:#005CC5">29</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">+</span><span style="color:#005CC5">0x330</span><span style="color:#6F42C1"> ExcludeKernelStack</span><span style="color:#24292E"> : Pos </span><span style="color:#005CC5">30</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span></code></pre></div><p>Although the mask of flags is technically represented by <code>WMI_LOGGER_CONTEXT.Flags</code>, the symbols contain a convenient breakdown of the various values which are available. As we can see, <code>SecurityTrace</code> is a flag which is present and will be the subject of this blog post. By itself, however, this flag does not indicate what it is used for, other than the fact that it denotes the trace is somehow related to security.</p><p>To get a sense as to what this flag may be used for, we first enumerated all of the trace sessions which contained this flag. Note that the list of active loggers cannot exceed 0x50 (80), as this currently is the maximum number of supported loggers on a system. WinDbg, which we use for our research, is a very powerful <a href="https://blog.trailofbits.com/2023/11/22/etw-internals-for-security-research-and-forensics/">tool</a> for ETW analysis.</p><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#24292E">lkd</span><span style="color:#D73A49">&gt;</span><span style="color:#6F42C1"> dx</span><span style="color:#24292E"> ((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_WMI_LOGGER_CONTEXT</span><span style="color:#D73A49">*</span><span style="color:#24292E">(</span><span style="color:#D73A49">*</span><span style="color:#24292E">)[</span><span style="color:#005CC5">0x50</span><span style="color:#24292E">])(((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_ESERVERSILO_GLOBALS</span><span style="color:#D73A49">*</span><span style="color:#24292E">)</span><span style="color:#D73A49">&amp;</span><span style="color:#24292E">nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">PspHostSiloGlobals)</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">EtwSiloState</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">EtwpLoggerContext))</span><span style="color:#D73A49">-&gt;</span><span style="color:#6F42C1">Where</span><span style="color:#24292E">(</span><span style="color:#E36209">l</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> l </span><span style="color:#D73A49">!=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">).</span><span style="color:#6F42C1">Where</span><span style="color:#24292E">(</span><span style="color:#E36209">l</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> l</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">SecurityTrace </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">).</span><span style="color:#6F42C1">Select</span><span style="color:#24292E">(</span><span style="color:#E36209">i</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> i</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">LoggerName)</span></span>
<span class="line"><span style="color:#24292E">((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_WMI_LOGGER_CONTEXT</span><span style="color:#D73A49">*</span><span style="color:#24292E">(</span><span style="color:#D73A49">*</span><span style="color:#24292E">)[</span><span style="color:#005CC5">0x50</span><span style="color:#24292E">])(((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_ESERVERSILO_GLOBALS</span><span style="color:#D73A49">*</span><span style="color:#24292E">)</span><span style="color:#D73A49">&amp;</span><span style="color:#24292E">nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">PspHostSiloGlobals)</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">EtwSiloState</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">EtwpLoggerContext))</span><span style="color:#D73A49">-&gt;</span><span style="color:#6F42C1">Where</span><span style="color:#24292E">(</span><span style="color:#E36209">l</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> l </span><span style="color:#D73A49">!=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">).</span><span style="color:#6F42C1">Where</span><span style="color:#24292E">(</span><span style="color:#E36209">l</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> l</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">SecurityTrace </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">).</span><span style="color:#6F42C1">Select</span><span style="color:#24292E">(</span><span style="color:#E36209">i</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> i</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">LoggerName)                </span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#005CC5">5</span><span style="color:#24292E">]              : </span><span style="color:#032F62">"DefenderApiLogger"</span><span style="color:#24292E"> [Type: _UNICODE_STRING]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#005CC5">6</span><span style="color:#24292E">]              : </span><span style="color:#032F62">"DefenderAuditLogger"</span><span style="color:#24292E"> [Type: _UNICODE_STRING]</span></span></code></pre></div><p>There are only two trace sessions with this feature enabled - DefenderApiLogger and DefenderAuditLogger. These trace sessions are associated with Microsoft Defender. If one attempts to analyze the relevant binaries, you will not find the creation of these ETW sessions present (via <code>StartTrace</code>). This is because these sessions are registered as <a href="https://learn.microsoft.com/en-us/windows/win32/etw/configuring-and-starting-an-autologger-session">AutoLogger</a> ETW sessions. For the unfamiliar, AutoLogger sessions are used in order for some loggers to consume events fairly early (all things considered) in the boot process and are not created by a particular process, but instead are created by the kernel directly (unlike most "normal" sessions - which are created by a particular process invoking <code>StartTrace</code>). These sessions are configured through the Registry via <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\WMI\Autologger</code>.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace1.png" alt="AutoLogger trace sessions"></p><p>By examining one of the AutoLogger sessions associated with Microsoft Defender we can glean further insight, potentially, into the <code>SecurityTrace</code> feature.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace2.png" alt="DefenderApiLogger AutoLogger trace session"></p><p>The DefenderApiLogger key itself contains AutoLogger-compliant configuration settings (not all of the ETW trace session configuration settings are available to AutoLoggers). As we can see in the above image, there are no configuration options related to "Flags" or any other moniker which would indicate configuration of various features such as <code>SecurityTrace</code>, etc. Moreover, if we put AutoLogger sessions aside and look at the <code>EVENT_TRACE_PROPERTIES</code> structure, which is used by callers of <code>StartTrace</code> to create a new ETW session programmatically, there <em>still</em> are no options to configure an item such as a "security trace" feature or a <code>SecurityTrace</code> flag.</p><p>In the case of DefenderApiLogger, all that is present are a list of AutoLogger-compliant ETW settings, along with a list of GUIDs for the various ETW providers which the DefenderApiLogger trace session wishes to consume from. For example, the Microsoft-Windows-Services ETW provider is represented by the first GUID present in the subkey, <code>0063715B-EEDA-4007-9429-AD526F62696E</code>. Each of these keys contains additional settings, such as the configuration of how a particular provider should emit events or how the logger should consume them - including an additional subkey named "Filters" (if present) which denotes various ETW filters (event ID filtering, etc.).</p><p>Still, however, there is nothing particularly identifiable about any of these configuration settings that would indicate the configuration of <code>SecurityTrace</code>. Given that the <code>WMI_LOGGER_CONTEXT</code> structure is a kernel-only structure, we further sought to understand how the ETW runtime in kernel-mode manages the undocumented <code>SecurityTrace</code> feature.</p><h1>SecurityTrace Logger Flag</h1><p>We've mentioned the <code>SecurityTrace</code> flag - but what does it actually <em>do</em>? One of the clearest ways to answer this is to look where this flag is evaluated (or set). The primary place where <code>SecurityTrace</code> is evaluated is in the Windows kernel, specifically the <code>EtwpQueryTrace</code>. As the name suggests, this function handles queries against a target ETW session. In practice, when you use a built-in tool like <code>logman</code> to retrieve details about an ETW trace session, the request ultimately funnels down to <code>EtwpQueryTrace</code> in order to be serviced.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace3.png" alt="`EtwpQueryTrace`"></p><p>Before talking about how <code>SecurityTrace</code> is evaluated in this function it is worth talking about how queries <em>actually</em> work - as this information will become prevalent in the latter portion of this blog.</p><p>ETW session query functionality resides around the <code>WMI_LOGGER_INFORMATION</code> structure. This undocumented structure is what is actually used by the low-level user-mode caller, <code>NtTraceControl</code> (via <code>ControlTrace</code>) for most ETW operations, such as starting or querying a trace. This structure is what is sent to the kernel - not the higher-level (and documented) <code>EVENT_TRACE_PROPERTIES</code> structure present in the Windows SDK. Although the Windows Research Kernel (WRK) has a definition of this structure, it has seen quite a few updates since the WRK was last updated. Luckily, the structure is present in <code>combase.dll</code> (as an aside, COM is notoiously hard to debug, so Microsoft actually ships private symbols for <code>combase.dll</code>. Given COM intersects with much of the OS, it can be a gold mine for information like this).</p><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#005CC5">0</span><span style="color:#24292E">:</span><span style="color:#005CC5">000</span><span style="color:#D73A49">&gt;</span><span style="color:#24292E"> dt combase</span><span style="color:#D73A49">!</span><span style="color:#24292E">_WMI_LOGGER_INFORMATION</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x000</span><span style="color:#6F42C1"> Wnode</span><span style="color:#24292E">            : _WNODE_HEADER</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x030</span><span style="color:#6F42C1"> BufferSize</span><span style="color:#24292E">       : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x034</span><span style="color:#6F42C1"> MinimumBuffers</span><span style="color:#24292E">   : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x038</span><span style="color:#6F42C1"> MaximumBuffers</span><span style="color:#24292E">   : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x03c</span><span style="color:#6F42C1"> MaximumFileSize</span><span style="color:#24292E">  : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x040</span><span style="color:#6F42C1"> LogFileMode</span><span style="color:#24292E">      : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x044</span><span style="color:#6F42C1"> FlushTimer</span><span style="color:#24292E">       : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x048</span><span style="color:#6F42C1"> EnableFlags</span><span style="color:#24292E">      : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x04c</span><span style="color:#6F42C1"> AgeLimit</span><span style="color:#24292E">         : Int4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x04c</span><span style="color:#6F42C1"> FlushThreshold</span><span style="color:#24292E">   : Int4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x050</span><span style="color:#6F42C1"> Wow</span><span style="color:#24292E">              : Pos </span><span style="color:#005CC5">0</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x050</span><span style="color:#6F42C1"> QpcDeltaTracking</span><span style="color:#24292E"> : Pos </span><span style="color:#005CC5">1</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x050</span><span style="color:#6F42C1"> LargeMdlPages</span><span style="color:#24292E">    : Pos </span><span style="color:#005CC5">2</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x050</span><span style="color:#6F42C1"> ExcludeKernelStack</span><span style="color:#24292E"> : Pos </span><span style="color:#005CC5">3</span><span style="color:#24292E">, </span><span style="color:#005CC5">1</span><span style="color:#24292E"> Bit</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x050</span><span style="color:#6F42C1"> V2Options</span><span style="color:#24292E">        : Uint8B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x058</span><span style="color:#6F42C1"> LogFileHandle</span><span style="color:#24292E">    : Ptr64 Void</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x058</span><span style="color:#6F42C1"> LogFileHandle64</span><span style="color:#24292E">  : Uint8B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x060</span><span style="color:#6F42C1"> NumberOfBuffers</span><span style="color:#24292E">  : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x060</span><span style="color:#6F42C1"> InstanceCount</span><span style="color:#24292E">    : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x064</span><span style="color:#6F42C1"> FreeBuffers</span><span style="color:#24292E">      : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x064</span><span style="color:#6F42C1"> InstanceId</span><span style="color:#24292E">       : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x068</span><span style="color:#6F42C1"> EventsLost</span><span style="color:#24292E">       : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x068</span><span style="color:#6F42C1"> NumberOfProcessors</span><span style="color:#24292E"> : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x06c</span><span style="color:#6F42C1"> BuffersWritten</span><span style="color:#24292E">   : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x070</span><span style="color:#6F42C1"> LogBuffersLost</span><span style="color:#24292E">   : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x070</span><span style="color:#6F42C1"> Flags</span><span style="color:#24292E">            : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x074</span><span style="color:#6F42C1"> RealTimeBuffersLost</span><span style="color:#24292E"> : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x078</span><span style="color:#6F42C1"> LoggerThreadId</span><span style="color:#24292E">   : Ptr64 Void</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x078</span><span style="color:#6F42C1"> LoggerThreadId64</span><span style="color:#24292E"> : Uint8B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x080</span><span style="color:#6F42C1"> LogFileName</span><span style="color:#24292E">      : _UNICODE_STRING</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x080</span><span style="color:#6F42C1"> LogFileName64</span><span style="color:#24292E">    : _STRING64</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x090</span><span style="color:#6F42C1"> LoggerName</span><span style="color:#24292E">       : _UNICODE_STRING</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x090</span><span style="color:#6F42C1"> LoggerName64</span><span style="color:#24292E">     : _STRING64</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x0a0</span><span style="color:#6F42C1"> RealTimeConsumerCount</span><span style="color:#24292E"> : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x0a4</span><span style="color:#6F42C1"> SequenceNumber</span><span style="color:#24292E">   : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x0a8</span><span style="color:#6F42C1"> LoggerExtension</span><span style="color:#24292E">  : Ptr64 Voidf</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x0a8</span><span style="color:#6F42C1"> LoggerExtension64</span><span style="color:#24292E"> : Uint8B</span></span></code></pre></div><p><code>WMI_LOGGER_INFORMATION</code> acts as a <em>translation</em> layer to extract information from, or store information into, the target trace session's <code>WMI_LOGGER_CONTEXT</code> from the original <code>EVENT_TRACE_PROPERTIES</code> structure associated with the target operation (such as <code>StartTrace</code> or <code>ControlTrace</code>).</p><p><code>Sechost.dll</code>, the user-mode component which receives the high-level query request from user-mode, translates the <code>EVENT_TRACE_PROPERTIES</code> structure into the appropriate <code>WMI_LOGGER_INFORMATION</code> structure - which then is sent to kernel-mode and is populated by the target <code>WMI_LOGGER_CONTEXT</code> structure. This is then translated back into the expected <code>EVENT_TRACE_PROPERTIES</code> structure provided by the caller of <a href="https://learn.microsoft.com/en-us/windows/win32/api/evntrace/nf-evntrace-controltracew"><code>ControlTrace</code></a> query operation. This translation is achieved in <code>Sechost.dll</code> via <code>EtwpCopyPropertiesToInfo</code> (<code>EVENT_TRACE_PROPERTIES</code> -&gt; <code>WMI_LOGGER_INFORMATION</code>) and <code>EtwpCopyInfoToProperties</code> (<code>WMI_LOGGER_INFORMATION</code> -&gt; <code>EVENT_TRACE_PROPERTIES</code>).</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace4.png" alt="`EtwpCopyPropertiesToInfo`"></p><p>What does this have to do with an ETW "security trace"? The actual functionality of a query operation, as we saw previously in <code>EtwpQueryTrace</code>, is gated by the presence of the target trace session's <code>WMI_LOGGER_CONTEXT.Flags.SecurityTrace</code> bit. In order for the target session's <code>WMI_LOGGER_INFORMATION</code> structure to be populated from the <code>WMI_LOGGER_CONTEXT</code> structure (in other words, in order for a trace query operation to take place), the caller process (i.e., the process which is performing the query, such as <code>logman.exe</code> or any other caller of <code>ControlTrace</code>) must contain <em>at least</em> Antimalware-PPL signing level/privilege.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace4a.png" alt="`SecurityTrace` check"></p><p>This means it is not even possible to query these ETW sessions from a process which has, for example, <code>SYSTEM</code> privileges.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace5.png" alt="Querying a `SecurityTrace` session fails as `SYSTEM`"></p><p>However, the <code>SecurityTrace</code> feature is more useful than <em>just</em> filtering the ability to query a session from user-mode directly via <code>ControlTrace</code> with the <code>EVENT_TRACE_CONTROL_QUERY</code> control code (although it is one of, if not <em>the</em> fundemental operation it is used for). The <code>SecurityTrace</code> flag is also checked in other security-relevant code paths. <strong>Curiously, however, the check is not present when the "stop ETW trace session" code path (<code>EtwpStopLogger</code> in <code>Sechost.dll</code>, <code>EtwpStopTrace</code> in NT) is exercised</strong>.</p><p>In the kernel, the presence of the <code>SecurityTrace</code> bit is checked in <code>EtwpStopLoggerInstance</code> (which is called by <code>EtwpStopTrace</code>). However, the check is <em>not</em> "security-related" (i.e., validating the calling process is running at Antimalware-PPL) and simply is to, if the target trace session had the Microsoft-Windows-Security-Auditing provider enabled, update global information about this provider - which has special handling in the kernel. This is because, as we will see later, one of the ways in which the <code>SecurityTrace</code> feature can be enabled is to consume from the Microsoft-Windows-Security-Auditing ETW provider in a very specific manner.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace6.png" alt="Microsoft-Windows-Security-Auditing handling"></p><p>Given no explicit Antimalware-PPL check occurs (and that a stop operation also does not result in a query, which would implicitly perform the Antimalware-PPL check) between the issuing of the stop code and the trace session being stopped, if the name of the target session with <code>SecurityTrace</code> enabled is known it is still possible for a process with only administrative privileges (<code>SYSTEM</code> in the case of the Defender session due to additional security descriptors) privileges to stop an ETW trace session with the <code>SecurityTrace</code> flag present (even though querying such a session would require the querying process to possess Antimalware-PPL). Though, as just mentioned, additional measures such as security descriptors can further tighten the permissions needed to perform such an action on a trace session.</p><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#24292E">eventProperties</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">Wnode.Guid </span><span style="color:#D73A49">=</span><span style="color:#24292E"> k_DefenderApiLoggerGuid;</span></span>
<span class="line"><span style="color:#24292E">eventProperties</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">LoggerNameOffset </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> sizeof</span><span style="color:#24292E">(EVENT_TRACE_PROPERTIES);</span></span>
<span class="line"><span style="color:#24292E">    </span></span>
<span class="line"><span style="color:#24292E">error </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> ControlTraceW</span><span style="color:#24292E">(</span><span style="color:#005CC5">0</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">                      L</span><span style="color:#032F62">"DefenderApiLogger"</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">                      eventProperties,</span></span>
<span class="line"><span style="color:#24292E">                      EVENT_TRACE_CONTROL_STOP);</span></span>
<span class="line"><span style="color:#D73A49">if</span><span style="color:#24292E"> (error </span><span style="color:#D73A49">!=</span><span style="color:#24292E"> ERROR_SUCCESS)</span></span>
<span class="line"><span style="color:#24292E">{</span></span>
<span class="line"><span style="color:#D73A49">    goto</span><span style="color:#24292E"> Exit;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">wprintf</span><span style="color:#24292E">(L</span><span style="color:#032F62">"[+] Successfully stopped DefenderApiLogger trace session.</span><span style="color:#005CC5">\n</span><span style="color:#032F62">"</span><span style="color:#24292E">);</span></span></code></pre></div><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace7.png" alt="Stopping a `SecurityTrace` trace session without Antimalware-PPL"></p><p>Lastly, <code>SecurityTrace</code> and Antimalware-PPL checks almost always occur in tandem with the <code>EtwCheckSecurityLoggerAccess</code> kernel function. This is the actual function which performs the check for if the requesting/querying process has the necessary privilege (Antimalware-PPL) the operation. This function <a href="https://jonny-johnson.medium.com/peeling-back-the-mask-how-the-threat-intelligence-provider-is-protected-9968c38c5481">is also responsible</a> for ensuring that only Antimalware-PPL processes can enable Microsoft-Windows-Threat-Intelligence related telemetry on desired processes. Not all Microsoft-Windows-Threat-Intelligence events are generated by "default" even with the appropriate keywords enabled. For example, processes must be <em>opted-in</em> to emitting specific events, such as reading/writing to/from memory. Processes do not emit these events by default.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace8.png" alt="Checking the presence of Antimalware-PPL"></p><p>To summarize: the point, in our view, of the <code>SecurityTrace</code> flag seems to be to prevent non-Antimalware-PPL processes from accessing ETW data specific to sessions (more specifically, as we will see, AutoLogger trace sessions) with this bit set. This brings up the obvious question: how can one enable this feature in the first place? Additionally, could there be any implications for sessions which have the <code>SecurityTrace</code> feature enabled?</p><h1>SecurityTrace - AutoLogger Sessions</h1><p>In our analysis we identified three ways to enable the <code>SecurityTrace</code> feature. The first two methods happen indirectly through the specific configuration of an AutoLogger trace session.</p><p>AutoLogger sessions go through a special code path in the kernel in order to have all of the requested providers enabled (this will be important for later in the blog post). AutoLoggers trace sessions have their target providers enabled via <code>EtwpEnableAutoLoggerProvider</code> (instead of <code>EtwEnableTrace</code> directly). This function begins by extracting all of the provider subkeys in the target AutoLogger Registry key entry, iterating by provider GUID. If any of the target providers are either Microsoft-Windows-Kernel-Audit-Api-Calls or Microsoft-Windows-Threat-Intelligence, the target trace's <code>WMI_LOGGER_CONTEXT</code> structure is updated to contain the <code>SecurityTrace</code> flag.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace9.png" alt="`SecurityTrace` enablement via specific ETW providers"></p><p>The key here to remember is that the sessions are not started in context of any particular process - meaning there is no Antimalware-PPL check to be done at this point because the requesting "process" is the <code>System</code> process - in other words, the kernel itself. Traditionally, an ETW trace session cannot enable Microsoft-Windows-Threat-Intelligence because of the fact that when <code>EnableTraceEx2</code> is called, the caller process has its identity verified - and if it is not an Antimalware-PPL process, an access denied error is propogated back to the caller.</p><p>The difference for AutoLoggers resides in the fact that there is no check to be done on a caller of <code>EnableTraceEx2</code> because provider enablement for AutoLoggers it not tied to a particular process identity, as it does not involve a process calling <code>EnableTraceEx2</code>. The kernel itself is responsible for enabling all of the requested providers (which are listed, as previously shown, in the Registry for each AutoLogger). This is why the presence of the <code>SecurityTrace</code> flag is important, as it's purpose is to protect AutoLogger sessions which have enabled privileged providers, like Microsoft-Windows-Threat-Intelligence, from being consumed by non-Antimalware-PPL processes. Although nothing can be done to check the identity of a process enabling a particular provider for an AutoLogger trace session at the time of enablement (as there is no process context to check), the OS can at least delegate this check to later, when a process attempts to then <em>consume</em> from this session. This is exactly where <code>SecurityTrace</code> comes into play.</p><p>The second way an AutoLogger can enable this capability is by setting an undocumented, but valid, AutoLogger Registry configuration value. The value in this case is <code>EnableSecurityProvider</code>. This is achieved in <code>EtwpStartAutoLogger</code> in the kernel (note that <code>SecTraceUnion</code> is <em>user-defined</em> and is not the name of the union which is actually used in the <code>WMI_LOGGER_INFORMATION</code> structure we have previously mentioned. <code>Flags</code> in this case is a 1-to-1 mapping of <code>Flags</code> in the target session's <code>WMI_LOGGER_CONTEXT</code>, as we will see later).</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace10.png" alt="`SecurityTrace` enablement via `EnableSecurityProvider`"></p><p>As a point of contention, when the <code>EnableSecurityProvider</code> AutoLogger key  is set a few additional implicit actions occur. Any AutoLogger which has this key set will <em>automatically</em> be opted-in to consuming the Microsoft-Windows-Security-Auditing ETW provider and the target logger ID is added to the list of known loggers consuming from this provider, via the <code>ETW_SILODRIVERSTATE</code> structure managed <code>PspHostSiloGlobals</code> in the kernel. This is because the <code>EtwpSecurityProviderGuidEntry</code> is always set to the Microsoft-Windows-Security-Auditing provider in <code>EtwpPreInitializeSiloState</code>.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace11.png" alt="Microsoft-Windows-Security-Auditing configuration"></p><p>Additionally, the first logger ID in the <code>EtwpSecurityLoggers</code> array is hardcoded, in <code>EtwpPreInitializeSiloState</code>, to the logger ID of 3 - which is always reserved for the EventLog-Security trace session. And, as mentioned, any AutoLogger which specifies the <code>EnableSecurityProvider</code> Registry value will be added to this list - as well as have the <code>SecurityTrace</code> bit enabled.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace12.png" alt="EventLog-Security configuration"></p><p>In addition there is a "non-AutoLogger" method to enable the <code>SecurityTrace</code> flag without running at Antimalware-PPL (and also, for that matter, dynamically/programmatically without the help of the AutoLogger Registry keys). Additionally, we will outline how it is possible to also consume from such traces without Antimalware-PPL.</p><h1>WMI_LOGGER_INFORMATION</h1><p>As previously mentioned there is a level of abstraction, in user-mode, between the documented <code>EVENT_TRACE_PROPERTIES</code> structure and the kernel-mode <code>WMI_LOGGER_CONTEXT</code> structure - and that is the <code>WMI_LOGGER_INFORMATION</code> structure. Taking a look at this structure, there is some interesting behavior present. Specifically, <code>Flags</code> and <code>LogBuffersLost</code>:</p><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#005CC5">0</span><span style="color:#24292E">:</span><span style="color:#005CC5">000</span><span style="color:#D73A49">&gt;</span><span style="color:#24292E"> dt combase</span><span style="color:#D73A49">!</span><span style="color:#24292E">_WMI_LOGGER_INFORMATION</span></span>
<span class="line"><span style="color:#D73A49">    &lt;---</span><span style="color:#24292E"> Truncated </span><span style="color:#D73A49">---&gt;</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x070</span><span style="color:#6F42C1"> LogBuffersLost</span><span style="color:#24292E">   : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   +</span><span style="color:#005CC5">0x070</span><span style="color:#6F42C1"> Flags</span><span style="color:#24292E">            : Uint4B</span></span>
<span class="line"><span style="color:#D73A49">   &lt;---</span><span style="color:#24292E"> Truncated </span><span style="color:#D73A49">---&gt;</span></span></code></pre></div><p>As seen above, both of these members are located at the same place in memory (offset 0x70). This infers these two members are actually part of a <em>union</em> (represented by our <code>SecTraceUnion</code> union earlier), and only one of the values can be valid at a time. <code>LogBuffersLost</code>, which is present in the documented <code>EVENT_TRACE_PROPERTIES</code> structure is unioned with another member which is not present in the documented structure: <code>Flags</code>. This <code>Flags</code> member, as we mentioned earlier, is directly imported from the intermediary <code>WMI_LOGGER_INFORMATION</code> structure, provided by user-mode, into the <code>Flags</code> member of the <code>WMI_LOGGER_CONTEXT</code> structure in kernel mode.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace13.png" alt="`WMI_LOGGER_INFORMATION` union"></p><p>In our case, however, because <code>LogBuffersLost</code> is present in the <code>EVENT_TRACE_PROPERTIES</code> structure passed to <code>StartTrace</code>, and because this is unioned with <code>Flags</code>, if <code>LogBuffersLost</code> is set to <code>0x4000</code> in the call to <code>StartTrace</code> (the mask associated with the <code>SecurityTrace</code> bit being set in <code>WMI_LOGGER_CONTEXT.Flags</code>) this value is directly imported into the target <code>WMI_LOGGER_CONTEXT</code> structure! This is because, again, <code>EtwpCopyPropertiesIntoInfo</code> (<code>EVENT_TRACE_PROPERTIES</code> -&gt; <code>WMI_LOGGER_INFORMATION</code>) in <code>Sechost.dll</code> performs a direct copy of the unioned data.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace14.png" alt="`EtwpCopyPropertiesToInfo` updated `WMI_LOGGER_INFORMATION` from `EVENT_TRACE_PROPERTIES`, including `Flags`"></p><p>This allows one programmatically to enable <code>SecurityTrace</code> without running at Antimalware-PPL, or without needing to even use an <code>AutoLogger</code> trace session that enables any providers which do require Antimalware-PPL in order to consume from the trace. Additionally, one must set this flag on the call to <code>StartTrace</code> (it is not possible to call <code>ControlTrace</code> with an updated <code>EVENT_TRACE_PROPERTIES</code> containing a new value for <code>LogBuffersLost</code>. This value is ignored in update scenarios by the kernel via <code>EVENT_TRACE_CONTROL_UPDATE</code>).</p><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#6A737D">// &lt;snip&gt;</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"><span style="color:#24292E">traceProperties</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">LogBuffersLost </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> 0x</span><span style="color:#005CC5">4000</span><span style="color:#24292E">;</span><span style="color:#6A737D">  // Treated as "Flags" if 0x4000 is set in nt!EtwpStartLogger.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E">error </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> StartTraceW</span><span style="color:#24292E">(TraceHandle,</span></span>
<span class="line"><span style="color:#24292E">                    TraceName,</span></span>
<span class="line"><span style="color:#24292E">                    traceProperties);</span></span>
<span class="line"><span style="color:#D73A49">if</span><span style="color:#24292E"> (error </span><span style="color:#D73A49">!=</span><span style="color:#24292E"> ERROR_SUCCESS)</span></span>
<span class="line"><span style="color:#24292E">{</span></span>
<span class="line"><span style="color:#6F42C1">    wprintf</span><span style="color:#24292E">(L</span><span style="color:#032F62">"[-] Error in StartTraceW! (Error: 0x</span><span style="color:#005CC5">%lx</span><span style="color:#032F62">)</span><span style="color:#005CC5">\n</span><span style="color:#032F62">"</span><span style="color:#24292E">, error);</span></span>
<span class="line"><span style="color:#D73A49">    goto</span><span style="color:#24292E"> Exit;</span></span>
<span class="line"><span style="color:#24292E">}</span></span></code></pre></div><p>After the call to <code>StartTrace</code>, with <code>LogBuffersLost</code> set to <code>0x4000</code>, the <code>SecurityTrace</code> bit is set in the target trace's <code>WMI_LOGGER_CONTEXT</code>.</p><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#005CC5">3</span><span style="color:#24292E">: kd</span><span style="color:#D73A49">&gt;</span><span style="color:#6F42C1"> dx</span><span style="color:#24292E"> ((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_WMI_LOGGER_CONTEXT</span><span style="color:#D73A49">*</span><span style="color:#24292E">(</span><span style="color:#D73A49">*</span><span style="color:#24292E">)[</span><span style="color:#005CC5">0x50</span><span style="color:#24292E">])(((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_ESERVERSILO_GLOBALS</span><span style="color:#D73A49">*</span><span style="color:#24292E">)</span><span style="color:#D73A49">&amp;</span><span style="color:#24292E">nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">PspHostSiloGlobals)</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">EtwSiloState</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">EtwpLoggerContext))</span><span style="color:#D73A49">-&gt;</span><span style="color:#6F42C1">Where</span><span style="color:#24292E">(</span><span style="color:#E36209">l</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> l </span><span style="color:#D73A49">!=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">).</span><span style="color:#6F42C1">Where</span><span style="color:#24292E">(</span><span style="color:#E36209">l</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> l</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">SecurityTrace </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">).</span><span style="color:#6F42C1">Select</span><span style="color:#24292E">(</span><span style="color:#E36209">i</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> i</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">LoggerName)</span></span>
<span class="line"><span style="color:#24292E">((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_WMI_LOGGER_CONTEXT</span><span style="color:#D73A49">*</span><span style="color:#24292E">(</span><span style="color:#D73A49">*</span><span style="color:#24292E">)[</span><span style="color:#005CC5">0x50</span><span style="color:#24292E">])(((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_ESERVERSILO_GLOBALS</span><span style="color:#D73A49">*</span><span style="color:#24292E">)</span><span style="color:#D73A49">&amp;</span><span style="color:#24292E">nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">PspHostSiloGlobals)</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">EtwSiloState</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">EtwpLoggerContext))</span><span style="color:#D73A49">-&gt;</span><span style="color:#6F42C1">Where</span><span style="color:#24292E">(</span><span style="color:#E36209">l</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> l </span><span style="color:#D73A49">!=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">).</span><span style="color:#6F42C1">Where</span><span style="color:#24292E">(</span><span style="color:#E36209">l</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> l</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">SecurityTrace </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">).</span><span style="color:#6F42C1">Select</span><span style="color:#24292E">(</span><span style="color:#E36209">i</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> i</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">LoggerName)                </span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#005CC5">5</span><span style="color:#24292E">]              : </span><span style="color:#032F62">"DefenderApiLogger"</span><span style="color:#24292E"> [Type: _UNICODE_STRING]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#005CC5">6</span><span style="color:#24292E">]              : </span><span style="color:#032F62">"DefenderAuditLogger"</span><span style="color:#24292E"> [Type: _UNICODE_STRING]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#005CC5">41</span><span style="color:#24292E">]             : </span><span style="color:#032F62">"MyTrace"</span><span style="color:#24292E"> [Type: _UNICODE_STRING]</span></span></code></pre></div><p>So, as we can see, we <em>can</em> still create a trace which prevents any process without Antimalware-PPL from querying the session! This is especially useful for software which wants to create an ETW session that is protected from being discovered by other processes (as no AutoLogger key is needed to do this).</p><p>The issue though is that, in its current state, this is completely useless because we still run into an issue when it comes time to actually consume ETW events from this trace session. As we have seen thus far - in almost every scenario where <code>SecurityTrace</code> is enabled, the assumption is the target process consuming from the trace will be running at Antimalware-PPL (even though we know it is possible for a process which is <em>not</em> running at Antimalware-PPL to enable this feature).</p><p>In order to consume events (using the documented APIs) we need two calls: <code>OpenTrace</code> and <code>ProcessTrace</code>. <code>OpenTrace</code> and <code>ProcessTrace</code>, for <a href="https://learn.microsoft.com/en-us/windows/win32/etw/consuming-events">real-time</a> ETW consumers, contain a call to the private function <code>EtwpQueryRealTimeTraceProperties</code> in <code>Sechost.dll</code>.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace15.png" alt="`EtwpQueryRealtimeTraceProperties` union"></p><p>This function occurs inline with <code>OpenTrace</code> and <code>ProcessTrace</code>. The fundamental problem here is that calling both of these functions will implicitly call <code>ControlTrace</code> with the <code>EVENT_TRACE_CONTROL_QUERY</code> code - which results in a query operation to the kernel. As already mentioned, given that <code>SecurityTrace</code> must be set at the time of the call to <code>StartTrace</code> and cannot be updated, the <code>SecurityTrace</code> bit will already be set at the time of the call to <code>EtwpQueryRealTimeTraceProperties</code>. Since query operations result in a check of the <code>SecurityTrace</code> bit (and given our process which is making the calls to <code>OpenTrace</code> and <code>ProcessTrace</code> is <em>not</em> running as Antimalware-PPL) the operation will fail with <code>ERROR_ACCESS_DENIED</code>. Going back to what we mentioned earlier, this is why it is not possible to consume events from a trace session that has <code>SecurityTrace</code> enabled without Antimalware-PPL. However, given that this check is occurring in user-mode, there is more than what meets the eye!</p><h1>Consuming from a SecurityTrace Session Without Antimalware-PPL</h1><p>The fundamental reason why consuming fails is due to the query operation. However, given that the check is delegated to user-mode instead of happening <em>inline</em> in the kernel itself as part of a call to <code>NtTraceControl</code> for consuming events, and given that we fully-control the process which is invoking <code>OpenTrace</code> and <code>ProcessTrace</code> - we can bypass this check and consume from any trace session which has <code>SecurityTrace</code> enabled. There are two primary options to choose from:</p><ol><li>Use only native APIs from <code>ntdll.dll</code> (primarily <code>NtTraceControl</code>) to consume from the trace session. Since <code>OpenTrace</code> and <code>ProcessTrace</code> are high-level APIs, directly calling the native APIs will result in a bypassing of the query operation</li><li>Install a hook on <code>EtwpQueryRealTimeTraceProperties</code> (or <code>ControlTrace</code> itself) to detour all query operations to our own variant. This can be achieved using a supported library like <a href="https://github.com/microsoft/Detours">Microsoft Detours</a>, or by installing your own hook.</li></ol><p>Due to time constraints we opted for the latter option, which resulted in using our own simple function hook (not using Detours or any other library). Given we opted for a function hook, we needed to compensate for a few things. The first being returning to the caller of <code>EtwpQueryRealTimeTraceProperties</code> all of the information it expects. This includes:</p><ol><li>The number of processors on the system</li><li>The <code>HistoricalContext</code> (which is referred to as the "trace handle", but really is just the logger ID preserved in the <code>ETW_REALTIME_CONSUMER</code> structure - or additionally the position of the session's <code>WMI_LOGGER_CONTEXT</code> structure in the <code>EtwpLoggerContext</code> array found in <code>PspHostSiloGlobals-&gt;EtwSiloState</code> in the kernel)</li><li>The "final" <code>EVENT_TRACE_PROPERTIES</code> to return to the caller (which needs to be 0x1078 bytes in size)</li><li>An <code>ERROR_SUCCESS</code> (<code>0</code>) return code</li></ol><p>However, this is if we choose to install a hook on <code>EtwpQueryRealTimeTraceProperties</code>. Given that this is a <em>private</em> function - as indicated by the <code>Etwp</code> prefix - this function is not exported and it will be a more involved process in order to keep a working POC portable/updated. A more portable method for a POC would be to install a hook on <code>ControlTrace</code> for only query operations. <code>ControlTrace</code> is exported and its address can always be known. Because of this all that is required is returning both a a "success" error code and the output tracing properties. Note that the call to <code>TraceQueryInformation</code>, which is one of the ways the number of processors is retrieved, does not result in an <em>actual</em> call to <code>EtwpQueryTrace</code> in the kernel.</p><p>Going back to <code>EtwpQueryRealTimeTraceProperties</code>, the query operation is presumably an artifact of getting a "known good copy" of the target trace properties from the kernel - and additionally so that a check of the <code>SecurityTrace</code> bit can occur. Trial-and-error revealed that simply just providing the <code>EVENT_TRACE_PROPERTIES</code> returned from the original call to <code>StartTrace</code> was sufficient and the queried properties are not necessary. So, for our purposes, all that is needed is to detour calls to <code>ControlTrace</code> for query operations to our own hook and then return to the caller the tracing properties we already have populated from the call to <code>StartTrace</code>! The <code>ControlTrace</code> hook simply identifies if the target operation is a query and, if it is, returns the target trace properties to <code>EtwpQueryRealTimeTraceProperties</code> (which then fills out the <code>HistoricalContext</code> and number of processors as a result of natural execution).</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace16.png" alt="`ControlTrace` hook"></p><p>The above code simply returns the necessary information the caller of <code>EtwpQueryRealTimeTraceProperties</code> needs without the actual query operation (which would fail, as mentioned, due to the consuming process not running at Antimalware-PPL). By simply inserting this thunk we can now successfully consume ETW events from a trace session which has the <code>SecurityTrace</code> bit set without Antimalware-PPL! We can also use this exact same method to consume protected ETW providers, like Microsoft-Windows-Threat-Intelligence, without Antimalware-PPL!</p><h1>Consuming From Microsoft-Windows-Threat-Intelligence Without Antimalware-PPL</h1><p>As mentioned earlier, the whole point of the <code>SecurityTrace</code> bit is to protect ETW trace sessions that wish to consume from privileged ETW providers, like Microsoft-Windows-Threat-Intelligence - specifically in AutoLogger scenarios. The reason for this is pretty straightforward - the code paths to enable an ETW provider in a target trace session, in the kernel, differ based on if the trace session is an AutoLogger session or not. If the trace session is not an AutoLogger trace session it is impossible to consume from the Microsoft-Windows-Threat-Intelligence provider without being an Antimalware-PPL. This is due to a check which occurs in <code>EtwpCheckNotificationAccess</code> in kernel-mode (recall when the AutoLogger enablement happens there is no "process context" for which <code>EnableTraceEx2</code> can be invoked, since the kernel is responsible for standing up all AutoLogger sessions).</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace17.png" alt="`EtwpCheckNotificationAccess` check"></p><p>The issue here is that with an AutoLogger ETW trace session the actual check is different. If the Microsoft-Windows-Threat-Intelligence provider is to be consumed by an AutoLogger, only the <code>SecurityTrace</code> flag is checked - there is no call to <code>EtwpCheckNotificationAccess</code>, as there is no process context to validate against. This is because the kernel itself is responsible for instantiating all AutoLogger sessions, not a particular process. We saw this earlier in the blog with how an AutoLogger has the <code>SecurityTrace</code> bit set in the first place. Given this, we can instrument the following:</p><ol><li>Create an entry in the AutoLogger Registry key to consume from Microsoft-Windows-Threat-Intelligence. This will enable Microsoft-Windows-Threat-Intelligence in the trace session. Note that the trace has not yet been consumed by a target process, meaning no Antimalware-PPL check happens because it is not applicable at this state as the kernel is creating all of these sessions - not a particular process</li><li>Patch <code>ControlTrace</code> in user-mode, which allows consumption from a trace that has the <code>SecurityTrace</code> bit set. We just need to provide the target <code>EVENT_TRACE_PROPERTIES</code> structure</li><li>Call <code>OpenTrace</code> and <code>ProcessTrace</code> as normal. This results in everything needed to consume from the session <em>without</em> the query operation we previously showed.</li></ol><p>The only challenge in the above implementation is <code>EVENT_TRACE_PROPERTIES</code>. In our original proof-of-concept, we took solace in the fact that we had a fully-populated <code>EVENT_TRACE_PROPERTIES</code> structure after the original call to <code>StartTrace</code>. Given that we are trying to consume from an already-existing AutoLogger session, we can no longer call <code>StartTrace</code> because the session already exists. This means we need to manually populate our own <code>EVENT_TRACE_PROPERTIES</code> structure to return to the caller of <code>EtwpQueryRealTimeTraceProperties</code> in <code>Sechost.dll</code>. Recall that we cannot directly query for these properties without Antimalware-PPL, since <code>SecurityTrace</code> is set. Trial-and-error revealed that the following fields in the <code>EVENT_TRACE_PROPERTIES</code> structure are needed for the call to succeed (and the entirety of the <code>OpenTrace</code> and <code>ProcessTrace</code> operations in general):</p><ol><li>All relevant <code>WNODE_HEADER</code> fields (<code>Guid</code>, etc.). <em>Especially</em> <code>HistoricalContext</code></li><li><code>BufferSize</code> (a valid value - I have chosen <code>0x40</code>)</li><li><code>LogFileMode</code> (<code>EVENT_TRACE_REAL_TIME_MODE</code>)</li><li><code>FlushTimer</code></li><li><code>MinimumBuffers</code></li><li><code>LoggerNameOffset</code></li></ol><p>All of the aforementioned fields are trivial to fill out (they just need to be reconciled with the target AutoLogger trace session settings in the Registry) except for <code>HistoricalContext</code>. <code>HistoricalContext</code>, however, is deterministic. This because it is simply, as mentioned, the ID of the logger. Given that we are consuming from an AutoLogger trace session, the only "relevant" IDs will be those present in the AutoLogger Registry key at the time an ID is assigned to our trace session. Additionally, the AutoLoggers are enabled in alphabetical order (with a few exceptions that are easily compensated for).</p><p>Through testing, it seems the first logger ID used is always 2 (for the "traditional" kernel logger session), and we also know from earlier that ID 3 is always reserved for the EventLog-Security trace - meaning the first possible ID is 4. Compensating for all of this, one can easily infer what the projected <code>HistoricalContext</code> will be for the target session by brute-forcing all values from 4 - 80 (the maximum ID) with a query operation. AutoLoggers will always reserve the "lower" IDs (starting at 4, 5, 6, etc.) and, thus, iterating over values 4 - 80 until a query to a value that returns <code>ERROR_ACCESS_DENIED</code> is found is a good indicator that the target trace session is likely a <code>SecurityTrace</code> target (although this is not <em>always</em> the case as there can be other reasons why a query can fail that is not related to <code>SecurityTrace</code>). What we are releasing is a POC and, thus, other implementations to reconcile the trace ID are left as an exercise to the reader, as the trace IDs themselves are simply just numeric values and AutoLoggers themselves are enabled in alphabetical order. In the POC we have released, we simply create a trace session name which starts with 0. This all but guarantees, for POC purposes, that this session will be the first ID (4) in the registered trace session, since it will come first alphabetically in most cases.</p><p>Finally, with the relevant checks passed, it is then possible to consume from the Microsoft-Windows-Threat-Intelligence ETW provider without Antimalware-PPL or any sort of kernel-mode memory patching or driver loading.</p><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#D73A49">void</span></span>
<span class="line"><span style="color:#6F42C1">HandleThreatIntelligenceCallback</span><span style="color:#24292E"> (</span></span>
<span class="line"><span style="color:#24292E">    _In_ PEVENT_RECORD EventRecord</span></span>
<span class="line"><span style="color:#24292E">    )</span></span>
<span class="line"><span style="color:#24292E">{</span></span>
<span class="line"><span style="color:#6F42C1">    wprintf</span><span style="color:#24292E">(L</span><span style="color:#032F62">"[+] [HandleThreatIntelligenceCallback] Hello from the Threat-Intelligence ETW callback!</span><span style="color:#005CC5">\n</span><span style="color:#032F62">"</span><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    //</span></span>
<span class="line"><span style="color:#6A737D">    // Print the GUID</span></span>
<span class="line"><span style="color:#6A737D">    //</span></span>
<span class="line"><span style="color:#6F42C1">    wprintf</span><span style="color:#24292E">(L</span><span style="color:#032F62">"  [*] GUID = {</span><span style="color:#005CC5">%08lX</span><span style="color:#032F62">-</span><span style="color:#005CC5">%04hX</span><span style="color:#032F62">-</span><span style="color:#005CC5">%04hX</span><span style="color:#032F62">-</span><span style="color:#005CC5">%02hhX%02hhX</span><span style="color:#032F62">-</span><span style="color:#005CC5">%02hhX%02hhX%02hhX%02hhX%02hhX%02hhX</span><span style="color:#032F62">}</span><span style="color:#005CC5">\n</span><span style="color:#032F62">"</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">            EventRecord-&gt;EventHeader.ProviderId.Data1,</span></span>
<span class="line"><span style="color:#24292E">            EventRecord-&gt;EventHeader.ProviderId.Data2,</span></span>
<span class="line"><span style="color:#24292E">            EventRecord-&gt;EventHeader.ProviderId.Data3,</span></span>
<span class="line"><span style="color:#24292E">            EventRecord-&gt;EventHeader.ProviderId.Data4[</span><span style="color:#005CC5">0</span><span style="color:#24292E">],</span></span>
<span class="line"><span style="color:#24292E">            EventRecord-&gt;EventHeader.ProviderId.Data4[</span><span style="color:#005CC5">1</span><span style="color:#24292E">],</span></span>
<span class="line"><span style="color:#24292E">            EventRecord-&gt;EventHeader.ProviderId.Data4[</span><span style="color:#005CC5">2</span><span style="color:#24292E">],</span></span>
<span class="line"><span style="color:#24292E">            EventRecord-&gt;EventHeader.ProviderId.Data4[</span><span style="color:#005CC5">3</span><span style="color:#24292E">],</span></span>
<span class="line"><span style="color:#24292E">            EventRecord-&gt;EventHeader.ProviderId.Data4[</span><span style="color:#005CC5">4</span><span style="color:#24292E">],</span></span>
<span class="line"><span style="color:#24292E">            EventRecord-&gt;EventHeader.ProviderId.Data4[</span><span style="color:#005CC5">5</span><span style="color:#24292E">],</span></span>
<span class="line"><span style="color:#24292E">            EventRecord-&gt;EventHeader.ProviderId.Data4[</span><span style="color:#005CC5">6</span><span style="color:#24292E">],</span></span>
<span class="line"><span style="color:#24292E">            EventRecord-&gt;EventHeader.ProviderId.Data4[</span><span style="color:#005CC5">7</span><span style="color:#24292E">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">    return</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">}</span></span></code></pre></div><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace18.png" alt="Microsoft-Windows-Threat-Intelligence being consumed from"></p><p>We can see the GUID here is that of the Microsoft-Windows-Threat-Intelligence GUID (<code>F4E1897C-BB5D-5668-F1D8-040F4D8DD344</code>). Additionally, if we enumerate the list of consumers attached to this trace session (via the linked-list in <code>WMI_LOGGER_CONTEXT</code>) for a list of <code>ETW_REALTIME_CONSUMER</code> structures - we can see the only process which is consuming from this trace session, which has enabled the Microsoft-Windows-Threat-Intelligence provider, does not have Antimalware-PPL, and is our proof-of-concept process!</p><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#005CC5">3</span><span style="color:#24292E">: kd</span><span style="color:#D73A49">&gt;</span><span style="color:#6F42C1"> dx</span><span style="color:#24292E"> ((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_WMI_LOGGER_CONTEXT</span><span style="color:#D73A49">*</span><span style="color:#24292E">(</span><span style="color:#D73A49">*</span><span style="color:#24292E">)[</span><span style="color:#005CC5">0x50</span><span style="color:#24292E">])(((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_ESERVERSILO_GLOBALS</span><span style="color:#D73A49">*</span><span style="color:#24292E">)</span><span style="color:#D73A49">&amp;</span><span style="color:#24292E">nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">PspHostSiloGlobals)</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">EtwSiloState</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">EtwpLoggerContext))</span><span style="color:#D73A49">-&gt;</span><span style="color:#6F42C1">Where</span><span style="color:#24292E">(</span><span style="color:#E36209">l</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> l </span><span style="color:#D73A49">!=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">).</span><span style="color:#6F42C1">Where</span><span style="color:#24292E">(</span><span style="color:#E36209">l</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> l</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">SecurityTrace </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">).</span><span style="color:#6F42C1">Select</span><span style="color:#24292E">(</span><span style="color:#E36209">i</span><span style="color:#D73A49"> =&gt;</span><span style="color:#D73A49"> new</span><span style="color:#24292E"> { Name </span><span style="color:#D73A49">=</span><span style="color:#24292E"> i</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">LoggerName, Consumers </span><span style="color:#D73A49">=</span><span style="color:#24292E"> Debugger.Utility.Collections.</span><span style="color:#6F42C1">FromListEntry</span><span style="color:#24292E">(i</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">Consumers, </span><span style="color:#032F62">"nt!_ETW_REALTIME_CONSUMER"</span><span style="color:#24292E">, </span><span style="color:#032F62">"Links"</span><span style="color:#24292E">)})[0n4].Consumers[</span><span style="color:#005CC5">0</span><span style="color:#24292E">]</span></span>
<span class="line"><span style="color:#24292E">((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_WMI_LOGGER_CONTEXT</span><span style="color:#D73A49">*</span><span style="color:#24292E">(</span><span style="color:#D73A49">*</span><span style="color:#24292E">)[</span><span style="color:#005CC5">0x50</span><span style="color:#24292E">])(((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_ESERVERSILO_GLOBALS</span><span style="color:#D73A49">*</span><span style="color:#24292E">)</span><span style="color:#D73A49">&amp;</span><span style="color:#24292E">nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">PspHostSiloGlobals)</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">EtwSiloState</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">EtwpLoggerContext))</span><span style="color:#D73A49">-&gt;</span><span style="color:#6F42C1">Where</span><span style="color:#24292E">(</span><span style="color:#E36209">l</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> l </span><span style="color:#D73A49">!=</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">).</span><span style="color:#6F42C1">Where</span><span style="color:#24292E">(</span><span style="color:#E36209">l</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> l</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">SecurityTrace </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">).</span><span style="color:#6F42C1">Select</span><span style="color:#24292E">(</span><span style="color:#E36209">i</span><span style="color:#D73A49"> =&gt;</span><span style="color:#D73A49"> new</span><span style="color:#24292E"> { Name </span><span style="color:#D73A49">=</span><span style="color:#24292E"> i</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">LoggerName, Consumers </span><span style="color:#D73A49">=</span><span style="color:#24292E"> Debugger.Utility.Collections.</span><span style="color:#6F42C1">FromListEntry</span><span style="color:#24292E">(i</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">Consumers, </span><span style="color:#032F62">"nt!_ETW_REALTIME_CONSUMER"</span><span style="color:#24292E">, </span><span style="color:#032F62">"Links"</span><span style="color:#24292E">)})[0n4].Consumers[</span><span style="color:#005CC5">0</span><span style="color:#24292E">]                 [Type: _ETW_REALTIME_CONSUMER]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x000</span><span style="color:#24292E">] Links            [Type: _LIST_ENTRY]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x010</span><span style="color:#24292E">] </span><span style="color:#6F42C1">ProcessHandle</span><span style="color:#24292E">    : </span><span style="color:#005CC5">0xffffffff800037b0</span><span style="color:#24292E"> [Type: </span><span style="color:#D73A49">void</span><span style="color:#D73A49"> *</span><span style="color:#24292E">]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x018</span><span style="color:#24292E">] </span><span style="color:#6F42C1">ProcessObject</span><span style="color:#24292E">    : </span><span style="color:#005CC5">0xffffa58900524080</span><span style="color:#24292E"> [Type: _EPROCESS </span><span style="color:#D73A49">*</span><span style="color:#24292E">]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x020</span><span style="color:#24292E">] </span><span style="color:#6F42C1">NextNotDelivered</span><span style="color:#24292E"> : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: </span><span style="color:#D73A49">void</span><span style="color:#D73A49"> *</span><span style="color:#24292E">]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x028</span><span style="color:#24292E">] </span><span style="color:#6F42C1">RealtimeConnectContext</span><span style="color:#24292E"> : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: </span><span style="color:#D73A49">void</span><span style="color:#D73A49"> *</span><span style="color:#24292E">]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x030</span><span style="color:#24292E">] </span><span style="color:#6F42C1">DisconnectEvent</span><span style="color:#24292E">  : </span><span style="color:#005CC5">0xffffa5890188e2e0</span><span style="color:#24292E"> [Type: _KEVENT </span><span style="color:#D73A49">*</span><span style="color:#24292E">]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x038</span><span style="color:#24292E">] </span><span style="color:#6F42C1">DataAvailableEvent</span><span style="color:#24292E"> : </span><span style="color:#005CC5">0xffffa5890188e760</span><span style="color:#24292E"> [Type: _KEVENT </span><span style="color:#D73A49">*</span><span style="color:#24292E">]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x040</span><span style="color:#24292E">] </span><span style="color:#6F42C1">UserBufferCount</span><span style="color:#24292E">  : </span><span style="color:#005CC5">0x202d0255450</span><span style="color:#24292E"> : Unable to read memory at Address </span><span style="color:#005CC5">0x202d0255450</span><span style="color:#24292E"> [Type: unsigned long </span><span style="color:#D73A49">*</span><span style="color:#24292E">]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x048</span><span style="color:#24292E">] </span><span style="color:#6F42C1">UserBufferListHead</span><span style="color:#24292E"> : </span><span style="color:#005CC5">0x202d0255448</span><span style="color:#24292E"> [Type: _SINGLE_LIST_ENTRY </span><span style="color:#D73A49">*</span><span style="color:#24292E">]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x050</span><span style="color:#24292E">] </span><span style="color:#6F42C1">BuffersLost</span><span style="color:#24292E">      : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: unsigned long]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x054</span><span style="color:#24292E">] </span><span style="color:#6F42C1">EmptyBuffersCount</span><span style="color:#24292E"> : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: unsigned long]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x058</span><span style="color:#24292E">] </span><span style="color:#6F42C1">LoggerId</span><span style="color:#24292E">         : </span><span style="color:#005CC5">0x4</span><span style="color:#24292E"> [Type: unsigned short]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x05a</span><span style="color:#24292E">] </span><span style="color:#6F42C1">Flags</span><span style="color:#24292E">            : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: unsigned char]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x05a</span><span style="color:#24292E"> ( </span><span style="color:#005CC5">0</span><span style="color:#24292E">: </span><span style="color:#005CC5">0</span><span style="color:#24292E">)] </span><span style="color:#6F42C1">ShutDownRequested</span><span style="color:#24292E"> : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: unsigned char]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x05a</span><span style="color:#24292E"> ( </span><span style="color:#005CC5">1</span><span style="color:#24292E">: </span><span style="color:#005CC5">1</span><span style="color:#24292E">)] </span><span style="color:#6F42C1">NewBuffersLost</span><span style="color:#24292E">   : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: unsigned char]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x05a</span><span style="color:#24292E"> ( </span><span style="color:#005CC5">2</span><span style="color:#24292E">: </span><span style="color:#005CC5">2</span><span style="color:#24292E">)] </span><span style="color:#6F42C1">Disconnected</span><span style="color:#24292E">     : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: unsigned char]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x05a</span><span style="color:#24292E"> ( </span><span style="color:#005CC5">3</span><span style="color:#24292E">: </span><span style="color:#005CC5">3</span><span style="color:#24292E">)] </span><span style="color:#6F42C1">Notified</span><span style="color:#24292E">         : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: unsigned char]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x05a</span><span style="color:#24292E"> ( </span><span style="color:#005CC5">4</span><span style="color:#24292E">: </span><span style="color:#005CC5">4</span><span style="color:#24292E">)] </span><span style="color:#6F42C1">Wow</span><span style="color:#24292E">              : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: unsigned char]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x060</span><span style="color:#24292E">] ReservedBufferSpaceBitMap [Type: _RTL_BITMAP]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x070</span><span style="color:#24292E">] </span><span style="color:#6F42C1">ReservedBufferSpace</span><span style="color:#24292E"> : </span><span style="color:#005CC5">0x202d0360000</span><span style="color:#24292E"> : Unable to read memory at Address </span><span style="color:#005CC5">0x202d0360000</span><span style="color:#24292E"> [Type: unsigned char </span><span style="color:#D73A49">*</span><span style="color:#24292E">]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x078</span><span style="color:#24292E">] </span><span style="color:#6F42C1">ReservedBufferSpaceSize</span><span style="color:#24292E"> : </span><span style="color:#005CC5">0x80000</span><span style="color:#24292E"> [Type: unsigned long]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x07c</span><span style="color:#24292E">] </span><span style="color:#6F42C1">UserPagesAllocated</span><span style="color:#24292E"> : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: unsigned long]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x080</span><span style="color:#24292E">] </span><span style="color:#6F42C1">UserPagesReused</span><span style="color:#24292E">  : </span><span style="color:#005CC5">0x3d</span><span style="color:#24292E"> [Type: unsigned long]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x088</span><span style="color:#24292E">] </span><span style="color:#6F42C1">EventsLostCount</span><span style="color:#24292E">  : </span><span style="color:#005CC5">0x202d0255368</span><span style="color:#24292E"> : Unable to read memory at Address </span><span style="color:#005CC5">0x202d0255368</span><span style="color:#24292E"> [Type: unsigned long </span><span style="color:#D73A49">*</span><span style="color:#24292E">]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x090</span><span style="color:#24292E">] </span><span style="color:#6F42C1">BuffersLostCount</span><span style="color:#24292E"> : </span><span style="color:#005CC5">0x202d025536c</span><span style="color:#24292E"> : Unable to read memory at Address </span><span style="color:#005CC5">0x202d025536c</span><span style="color:#24292E"> [Type: unsigned long </span><span style="color:#D73A49">*</span><span style="color:#24292E">]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x098</span><span style="color:#24292E">] </span><span style="color:#6F42C1">SiloState</span><span style="color:#24292E">        : </span><span style="color:#005CC5">0xffffa588f8631000</span><span style="color:#24292E"> [Type: _ETW_SILODRIVERSTATE </span><span style="color:#D73A49">*</span><span style="color:#24292E">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5">3</span><span style="color:#24292E">: kd</span><span style="color:#D73A49">&gt;</span><span style="color:#6F42C1"> dx</span><span style="color:#24292E"> ((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_EPROCESS</span><span style="color:#D73A49">*</span><span style="color:#24292E">)</span><span style="color:#005CC5">0xffffa58900524080</span><span style="color:#24292E">)</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">Protection</span></span>
<span class="line"><span style="color:#24292E">((nt</span><span style="color:#D73A49">!</span><span style="color:#24292E">_EPROCESS</span><span style="color:#D73A49">*</span><span style="color:#24292E">)</span><span style="color:#005CC5">0xffffa58900524080</span><span style="color:#24292E">)</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">Protection                 [Type: _PS_PROTECTION]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x000</span><span style="color:#24292E">] </span><span style="color:#6F42C1">Level</span><span style="color:#24292E">            : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: unsigned char]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x000</span><span style="color:#24292E"> ( </span><span style="color:#005CC5">2</span><span style="color:#24292E">: </span><span style="color:#005CC5">0</span><span style="color:#24292E">)] </span><span style="color:#6F42C1">Type</span><span style="color:#24292E">             : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: unsigned char]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x000</span><span style="color:#24292E"> ( </span><span style="color:#005CC5">3</span><span style="color:#24292E">: </span><span style="color:#005CC5">3</span><span style="color:#24292E">)] </span><span style="color:#6F42C1">Audit</span><span style="color:#24292E">            : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: unsigned char]</span></span>
<span class="line"><span style="color:#24292E">    [</span><span style="color:#D73A49">+</span><span style="color:#005CC5">0x000</span><span style="color:#24292E"> ( </span><span style="color:#005CC5">7</span><span style="color:#24292E">: </span><span style="color:#005CC5">4</span><span style="color:#24292E">)] </span><span style="color:#6F42C1">Signer</span><span style="color:#24292E">           : </span><span style="color:#005CC5">0x0</span><span style="color:#24292E"> [Type: unsigned char]</span></span></code></pre></div><p>As a point of contention for the reader, it is worth noting that this POC is not capable of enabling sources of telemetry which are disabled by default on processes. For example, one still needs Antimalware-PPL in order to call <code>NtSetInformationProcess</code> to enable <a href="https://jonny-johnson.medium.com/behind-the-mask-unpacking-impersonation-events-fca909e08d00">impersonation events</a> - which have to be explicitly enabled through this privileged system call that this POC is incapable of making. The method outlined here is capable of consuming the following telemetry by default (telemetry that is emitted without a separate privileged system call being made to enable it on a per-process basis):</p><ol><li>Executable memory allocation events (user-mode and kernel-mode callers)</li><li>Executable memory mapping events (user-mode and kernel-mode callers)</li><li>Remote APC events (user-mode)</li><li>Thread context update events (SetThreadContext)</li><li>Kernel-mode device and driver load and unload events</li><li><a href="https://windows-internals.com/an-end-to-kaslr-bypasses/">System call events</a>. At the time this blog post was written, this includes only NtSystemDebugControl and NtQuerySystemInformation system calls</li></ol><p>However, it is also worth pointing out that on the latest Insider Preview version of Windows (Canary channel), there are several processes which have already been opted-in to the "optional" telemetry (including memory protection, process/thread suspension, and other events). This means that using the methodology outlined in this blog post will result in receiving such events "for free". This is a result of Microsoft Defender invoking the functionality, since it is a process running at Antimalware-PPL, for enabling the other "optional" telemetry bits.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace19.png" alt="Defender enabling additional Microsoft-Windows-Threat-Intelligence telemetry"></p><p>A list of all processes which have opted-in to the optional Threat-Intelligence telemetry can be seen below:</p><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#24292E">dx </span><span style="color:#D73A49">-</span><span style="color:#24292E">g @$cursession.Processes.</span><span style="color:#6F42C1">Where</span><span style="color:#24292E">(</span><span style="color:#E36209">p</span><span style="color:#D73A49"> =&gt;</span><span style="color:#24292E"> (p.KernelObject.EnableProcessImpersonationLogging </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 1</span><span style="color:#D73A49"> ||</span><span style="color:#24292E"> p.KernelObject.EnableProcessLocalExecProtectVmLogging </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">) </span><span style="color:#D73A49">||</span><span style="color:#24292E"> p.KernelObject.EnableProcessRemoteExecProtectVmLogging </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 1</span><span style="color:#D73A49"> ||</span><span style="color:#24292E"> p.KernelObject.EnableProcessSuspendResumeLogging </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 1</span><span style="color:#D73A49"> ||</span><span style="color:#24292E"> p.KernelObject.EnableReadVmLogging </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 1</span><span style="color:#D73A49"> ||</span><span style="color:#24292E"> p.KernelObject.EnableThreadSuspendResumeLogging </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 1</span><span style="color:#D73A49"> ||</span><span style="color:#24292E"> p.KernelObject.EnableWriteVmLogging </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> 1</span><span style="color:#24292E">).</span><span style="color:#6F42C1">Select</span><span style="color:#24292E">(</span><span style="color:#E36209">p</span><span style="color:#D73A49"> =&gt;</span><span style="color:#D73A49"> new</span><span style="color:#24292E"> { Name </span><span style="color:#D73A49">=</span><span style="color:#24292E"> p</span><span style="color:#D73A49">-&gt;</span><span style="color:#24292E">Name, EnableProcessImpersonationLogging </span><span style="color:#D73A49">=</span><span style="color:#24292E"> p.KernelObject.EnableProcessImpersonationLogging, EnableProcessLocalExecProtectVmLogging </span><span style="color:#D73A49">=</span><span style="color:#24292E"> p.KernelObject.EnableProcessLocalExecProtectVmLogging, EnableProcessRemoteExecProtectVmLogging </span><span style="color:#D73A49">=</span><span style="color:#24292E"> p.KernelObject.EnableProcessRemoteExecProtectVmLogging, EnableProcessSuspendResumeLogging </span><span style="color:#D73A49">=</span><span style="color:#24292E"> p.KernelObject.EnableProcessSuspendResumeLogging, EnableReadVmLogging  </span><span style="color:#D73A49">=</span><span style="color:#24292E"> p.KernelObject.EnableReadVmLogging, EnableThreadSuspendResumeLogging </span><span style="color:#D73A49">=</span><span style="color:#24292E"> p.KernelObject.EnableThreadSuspendResumeLogging, EnableWriteVmLogging </span><span style="color:#D73A49">=</span><span style="color:#24292E"> p.KernelObject.EnableWriteVmLogging }),d</span></span></code></pre></div><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://www.originhq.com/assets/securitytrace20.png" alt="A list of processes with additional Microsoft-Windows-Threat-Intelligence telemetry enabled"></p><h1>Conclusion</h1><p>We have coordinated with Microsoft the findings in this blog post and MSRC has concluded no vulnerability exists due to the administrative &lt;-&gt; PPL boundary which is not enforceable. The <code>SecurityTrace</code> is a pretty obscure and undocumented flag that we found interesting as a result of research we were conducting within the <a href="https://www.originhq.com/">Origin (By Prelude)</a> company - in order to better protect our customers. This blog post would also be incomplete without any recommendation - which would be to move such a check for <code>SecurityTrace</code> traces to the kernel and not delegate it to user-mode. Thank you for reading and we hope you enjoyed this blog post!</p></article></div></article></div><div class="relative py-[20px] md:py-[30px] px-[15px] md:px-[5vw] lg:px-[10vw] text-white flex flex-col"><div class="absolute z-10 top-0 left-0 bottom-0 right-0 bg-[#333] mix-blend-difference"></div><div class="absolute z-10 top-0 left-0 bottom-0 right-0 bg-[#eeeeeecc]"></div><div class="relative z-10 flex flex-col gap-[30px] md:gap-[40px]"><div class="relative z-10 flex flex-col gap-[10px]"><span class="block text-[12px] leading-[12px] lg:text-[14px] lg:leading-[14px] uppercase font-[400] text-[#666]">Blog</span><div class="relative z-10 flex flex-col md:flex-col gap-[10px] md:gap-[10px]"><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/process-preluding"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Process Preluding: Child Process Injection Before The Story Begins</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">John Uhlmann</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/praxis-announcement"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Introducing Praxis: An Adversarial Framework for Exploring Computer Use Agents on Endpoint</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">David Kaplan</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/semantic-protocol-confusion"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Semantic Protocol Confusion: When My LLM Thinks It's a Web Browser</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">David Kaplan</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/securitytrace-etw-ppl"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Check Your Privilege: The Curious Case of ETW's SecurityTrace Flag</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Connor McGarr</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/cua-kit-attacking-the-intelligent-endpoint"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">cua-kit: Attacking the Intelligent Endpoint</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Matt Hand</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/era-of-semantic-security"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">The Era of Semantic Security: Computer Use Agents and the End of Signatures</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Matt Hand</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/rehabilitating-registry-tradecraft-with-regrestorekey"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Rehabilitating Registry Tradecraft with RegRestoreKey</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Michael Barclay</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/escaping-loader-locks-with-postprocessinitroutine"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Escaping Loader Locks with PostProcessInitRoutine</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">John Uhlmann</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/time-for-the-next-generation-of-endpoint-security"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">It's (Finally) Time For The Next Generation of Endpoint Security</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Spencer Thompson</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/windows-arm64-internals-deconstructing-pointer-authentication"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Windows ARM64 Internals: Deconstructing Pointer Authentication</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Connor McGarr</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/unexpectedly-out-of-context-detecting-a-lockbit-sample"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Unexpectedly Out-Of-Context: Detecting a LockBit Sample</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Michael Barclay</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/introducing-runtime-memory-protection"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Introducing Runtime Memory Protection</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Research Team</span></a></div></div><div class="relative z-10 flex flex-col gap-[10px] max-w-[800px]"><span class="block text-[12px] leading-[12px] lg:text-[14px] lg:leading-[14px] uppercase font-[400] text-[#666]">Team</span><div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-1"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Michael Barclay</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Lewis Zimmerman</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Mitchell Turner</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Tyler Holmwood</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Jeff Hiner</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Matt Hand</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Matthew Palma</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">John Uhlmann</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Connor McGarr</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Isaac Chen</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Rose Singletary</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Robin Williams</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Mahina Kaholokula</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Keith Robertson</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">David Kaplan</span></div><p class="my-4 block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Backed by Sequoia Capital, Brightmind Partners, IA Ventures and others</p><a href="https://www.originhq.com/jobs" class="w-max text-[10px] leading-[10px] md:text-[11px] md:leading-[11px] uppercase font-[500] px-3 py-2 rounded-[20px] cursor-pointer text-[#000] border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]">explore our open job postings.</a></div><div class="relative z-10 flex flex-col gap-[10px] max-w-[800px]"><svg class="w-[60px] md:w-[70px]" viewBox="0 0 224 52" fill="#666" xmlns="http://www.w3.org/2000/svg"><path d="M-1.07586e-05 45.2947V0H11.6655V4.2081H5.07811V41.0866H11.6655V45.2947H-1.07586e-05ZM21.0449 42.4006L18.0975 40.3764L43.6301 2.94744L46.5953 4.97159L21.0449 42.4006ZM48.7793 22.6385C48.7793 26.5211 48.0691 29.8591 46.6486 32.6527C45.2282 35.4344 43.2809 37.5769 40.807 39.0803C38.3449 40.5717 35.5454 41.3175 32.4085 41.3175C29.2599 41.3175 26.4486 40.5717 23.9746 39.0803C21.5125 37.5769 19.5712 35.4285 18.1507 32.6349C16.7303 29.8414 16.0201 26.5092 16.0201 22.6385C16.0201 18.7559 16.7303 15.4238 18.1507 12.642C19.5712 9.84848 21.5125 7.70596 23.9746 6.21449C26.4486 4.71117 29.2599 3.95952 32.4085 3.95952C35.5454 3.95952 38.3449 4.71117 40.807 6.21449C43.2809 7.70596 45.2282 9.84848 46.6486 12.642C48.0691 15.4238 48.7793 18.7559 48.7793 22.6385ZM43.346 22.6385C43.346 19.6792 42.8666 17.1875 41.9078 15.1634C40.9609 13.1274 39.6588 11.5885 38.0016 10.5469C36.3562 9.49337 34.4919 8.96662 32.4085 8.96662C30.3134 8.96662 28.4431 9.49337 26.7978 10.5469C25.1524 11.5885 23.8503 13.1274 22.8915 15.1634C21.9445 17.1875 21.471 19.6792 21.471 22.6385C21.471 25.5978 21.9445 28.0954 22.8915 30.1314C23.8503 32.1555 25.1524 33.6944 26.7978 34.7479C28.4431 35.7895 30.3134 36.3104 32.4085 36.3104C34.4919 36.3104 36.3562 35.7895 38.0016 34.7479C39.6588 33.6944 40.9609 32.1555 41.9078 30.1314C42.8666 28.0954 43.346 25.5978 43.346 22.6385ZM64.8171 0V45.2947H53.1516V41.0866H59.739V4.2081H53.1516V0H64.8171ZM119.336 22.6385C119.336 26.5211 118.626 29.8591 117.205 32.6527C115.785 35.4344 113.838 37.5769 111.364 39.0803C108.902 40.5717 106.102 41.3175 102.965 41.3175C99.8165 41.3175 97.0052 40.5717 94.5312 39.0803C92.0691 37.5769 90.1278 35.4285 88.7074 32.6349C87.2869 29.8414 86.5767 26.5092 86.5767 22.6385C86.5767 18.7559 87.2869 15.4238 88.7074 12.642C90.1278 9.84848 92.0691 7.70596 94.5312 6.21449C97.0052 4.71117 99.8165 3.95952 102.965 3.95952C106.102 3.95952 108.902 4.71117 111.364 6.21449C113.838 7.70596 115.785 9.84848 117.205 12.642C118.626 15.4238 119.336 18.7559 119.336 22.6385ZM113.903 22.6385C113.903 19.6792 113.423 17.1875 112.464 15.1634C111.518 13.1274 110.215 11.5885 108.558 10.5469C106.913 9.49337 105.049 8.96662 102.965 8.96662C100.87 8.96662 98.9998 9.49337 97.3544 10.5469C95.709 11.5885 94.4069 13.1274 93.4481 15.1634C92.5012 17.1875 92.0277 19.6792 92.0277 22.6385C92.0277 25.5978 92.5012 28.0954 93.4481 30.1314C94.4069 32.1555 95.709 33.6944 97.3544 34.7479C98.9998 35.7895 100.87 36.3104 102.965 36.3104C105.049 36.3104 106.913 35.7895 108.558 34.7479C110.215 33.6944 111.518 32.1555 112.464 30.1314C113.423 28.0954 113.903 25.5978 113.903 22.6385ZM125.75 40.8203V13.5476H130.882V17.88H131.166C131.663 16.4122 132.539 15.258 133.793 14.4176C135.06 13.5653 136.492 13.1392 138.09 13.1392C138.422 13.1392 138.812 13.151 139.262 13.1747C139.724 13.1984 140.085 13.228 140.345 13.2635V18.3416C140.132 18.2824 139.753 18.2173 139.209 18.1463C138.664 18.0634 138.12 18.022 137.575 18.022C136.321 18.022 135.202 18.2884 134.22 18.821C133.249 19.3419 132.48 20.0698 131.911 21.005C131.343 21.9283 131.059 22.9818 131.059 24.1655V40.8203H125.75ZM144.94 40.8203V13.5476H150.249V40.8203H144.94ZM147.621 9.33949C146.697 9.33949 145.904 9.03172 145.241 8.41619C144.59 7.78882 144.265 7.04309 144.265 6.17898C144.265 5.30303 144.59 4.55729 145.241 3.94176C145.904 3.31439 146.697 3.00071 147.621 3.00071C148.544 3.00071 149.331 3.31439 149.982 3.94176C150.645 4.55729 150.977 5.30303 150.977 6.17898C150.977 7.04309 150.645 7.78882 149.982 8.41619C149.331 9.03172 148.544 9.33949 147.621 9.33949ZM168.825 51.6158C166.659 51.6158 164.795 51.3317 163.232 50.7635C161.682 50.1953 160.415 49.4437 159.433 48.5085C158.45 47.5734 157.716 46.5495 157.231 45.4368L161.794 43.5547C162.114 44.0755 162.54 44.6259 163.073 45.206C163.617 45.7978 164.351 46.3009 165.274 46.7152C166.209 47.1295 167.411 47.3366 168.879 47.3366C170.891 47.3366 172.554 46.8454 173.868 45.8629C175.182 44.8923 175.839 43.3416 175.839 41.2109V35.8487H175.502C175.182 36.4287 174.72 37.0739 174.117 37.7841C173.525 38.4943 172.708 39.1098 171.666 39.6307C170.625 40.1515 169.269 40.4119 167.6 40.4119C165.446 40.4119 163.505 39.9089 161.776 38.9027C160.06 37.8847 158.699 36.3873 157.693 34.4105C156.698 32.4219 156.201 29.9775 156.201 27.0774C156.201 24.1773 156.692 21.6915 157.675 19.62C158.669 17.5485 160.03 15.9624 161.759 14.8615C163.487 13.7488 165.446 13.1925 167.636 13.1925C169.329 13.1925 170.696 13.4766 171.737 14.0447C172.779 14.6011 173.59 15.2521 174.17 15.9979C174.762 16.7436 175.217 17.4006 175.537 17.9688H175.928V13.5476H181.13V41.424C181.13 43.7678 180.586 45.6913 179.497 47.1946C178.408 48.6979 176.934 49.8106 175.075 50.5327C173.229 51.2547 171.146 51.6158 168.825 51.6158ZM168.772 36.0085C170.299 36.0085 171.589 35.6534 172.643 34.9432C173.708 34.2211 174.513 33.1913 175.058 31.8537C175.614 30.5043 175.892 28.8885 175.892 27.0064C175.892 25.1716 175.62 23.5559 175.075 22.1591C174.531 20.7623 173.732 19.6733 172.678 18.892C171.625 18.099 170.323 17.7024 168.772 17.7024C167.174 17.7024 165.842 18.1167 164.777 18.9453C163.712 19.7621 162.907 20.8748 162.362 22.2834C161.83 23.692 161.563 25.2663 161.563 27.0064C161.563 28.7938 161.836 30.3622 162.38 31.7116C162.925 33.0611 163.73 34.1146 164.795 34.8722C165.872 35.6297 167.198 36.0085 168.772 36.0085ZM188.25 40.8203V13.5476H193.559V40.8203H188.25ZM190.931 9.33949C190.008 9.33949 189.215 9.03172 188.552 8.41619C187.901 7.78882 187.575 7.04309 187.575 6.17898C187.575 5.30303 187.901 4.55729 188.552 3.94176C189.215 3.31439 190.008 3.00071 190.931 3.00071C191.855 3.00071 192.642 3.31439 193.293 3.94176C193.956 4.55729 194.287 5.30303 194.287 6.17898C194.287 7.04309 193.956 7.78882 193.293 8.41619C192.642 9.03172 191.855 9.33949 190.931 9.33949ZM206.01 24.6271V40.8203H200.701V13.5476H205.797V17.9865H206.135C206.762 16.5424 207.744 15.3823 209.082 14.5064C210.431 13.6304 212.13 13.1925 214.178 13.1925C216.036 13.1925 217.664 13.5831 219.061 14.3643C220.457 15.1338 221.541 16.282 222.31 17.8089C223.079 19.3359 223.464 21.224 223.464 23.473V40.8203H218.155V24.1122C218.155 22.1354 217.64 20.5907 216.61 19.478C215.581 18.3535 214.166 17.7912 212.367 17.7912C211.136 17.7912 210.041 18.0575 209.082 18.5902C208.135 19.1229 207.383 19.9041 206.827 20.9339C206.283 21.9519 206.01 23.183 206.01 24.6271Z"></path></svg><div class="flex flex-row items-center gap-[10px]"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">2025 Origin Technology</span><a href="https://www.preludesecurity.com/" target="_blank" class="block text-[10px] leading-[10px] md:text-[11px] md:leading-[11px] uppercase font-[500] text-[#999] bg-[#ccc] py-[5px] px-[10px] rounded-[10px] hover:bg-[#fff] hover:text-[#666]">By Prelude</a></div><a href="mailto:contact@preludesecurity.com" class="text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#666] hover:text-[#000]">contact@preludesecurity.com</a></div></div></div></div></div><!--$--><!--/$--><next-route-announcer style="position: absolute;"><div aria-live="assertive" id="__next-route-announcer__" role="alert" style="position: absolute; border: 0px; height: 1px; margin: -1px; padding: 0px; width: 1px; clip: rect(0px, 0px, 0px, 0px); overflow: hidden; white-space: nowrap; overflow-wrap: normal;"></div></next-route-announcer></body></html>