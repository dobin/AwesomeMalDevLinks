Title:
ETW Threat Intelligence and Hardware Breakpoints

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post analyzes how Windows EDRs use the ETW Threat Intelligence (TI) provider to detect suspicious kernel-observed behaviors, with a focus on hardware breakpoint abuse.  
- It shows that traditional userland methods for setting debug registers (e.g., `SetThreadContext` / `NtSetContextThread` and certain `NtSetInformationThread` classes) trigger ETW TI events such as `nt!EtwTiLogSetContextThread`, which EDRs can alert on.  
- Using WinDbg call stacks and kernel symbols (`EtwTiLog*`), the author maps which kernel paths generate TI telemetry for thread context manipulation.  
- The key technique is using `NtContinue` to apply a crafted `CONTEXT` containing debug registers, setting hardware breakpoints without naturally invoking the ETW TI “SetThreadContext” logging path.  
- A proof-of-concept demonstrates hooking `Sleep` via DR0/DR7 and handling `STATUS_SINGLE_STEP` with a vectored exception handler, enabling “patchless” control-flow manipulation.  
- This is useful for red teams and malware developers exploring stealthy userland hooks and for defenders building detections beyond TI events tied to `SetThreadContext`.

Technical Focus:
- ETW Threat Intelligence provider internals (`EtwTiLog*` kernel routines)
- Hardware breakpoints and x86/x64 debug registers (DR0–DR7)
- Thread context syscalls (`NtSetContextThread`, `NtSetInformationThread`, `NtContinue`)
- Vectored Exception Handling (VEH) / single-step exception flow
- WinDbg kernel debugging and call stack attribution
- Patchless hooking concepts for AMSI/ETW evasion

Use Cases:
- Implementing stealthy userland hooks using hardware breakpoints without memory patching
- Bypassing ETW TI-based detections that key on `SetThreadContext`-style telemetry
- Researching AMSI/ETW bypass primitives via debug-register manipulation
- Building defensive detections for `NtContinue`-based context updates and anomalous single-step behavior
- Reverse engineering which kernel events feed EDR telemetry pipelines

Keywords:
ETW, Threat Intelligence provider, EtwTiLogSetContextThread, PatchGuard, SSDT, hardware breakpoints, debug registers, DR0, DR7, NtSetContextThread, SetThreadContext, NtSetInformationThread, ThreadWow64Context, NtContinue, CONTEXT_DEBUG_REGISTERS, VEH, Vectored Exception Handler, STATUS_SINGLE_STEP, WinDbg, AMSI, AmsiScanBuffer, NtTraceEvent, userland hooking, EDR evasion