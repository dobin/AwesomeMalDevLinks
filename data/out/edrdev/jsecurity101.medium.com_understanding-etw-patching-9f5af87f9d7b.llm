Title:
Understanding ETW Patching

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains “ETW patching” as a subset of generic function patching used to suppress Windows telemetry by altering code paths (e.g., forcing immediate returns) in ETW-related functions.  
- It clarifies prerequisites: to stop a given provider’s events, you must patch code in the same execution context that emits those events (user-mode process vs kernel-mode).  
- The author contrasts patching exported functions via GetProcAddress (e.g., EtwEventWrite, NtTraceEvent) with patching internal, non-exported logging functions by computing addresses from module base + RVA/offset.  
- It highlights limitations and tradeoffs: remote-process patching typically requires WriteProcessMemory and resembles process injection (high detection risk), while kernel provider suppression requires kernel execution (e.g., via drivers).  
- Practical examples show that patching user-mode ETW (e.g., .NET provider) does not prevent kernel ETW providers like Threat-Intelligence from logging actions such as ReadProcessMemory (common in LSASS dumping).  
- For defenders, it notes detection is non-trivial and suggests focusing detections on telemetry sources less susceptible to in-process patching and considering integrity/behavioral approaches to spotting patched code.

Technical Focus:
- ETW architecture (user-mode vs kernel-mode providers)
- In-memory function patching (RET stubs, control-flow disruption)
- API-based patching: GetProcAddress, LoadLibrary, VirtualProtect
- Manual address resolution (module base + RVA/offset) for internal functions
- Remote patching and injection primitives (WriteProcessMemory)
- Threat-Intelligence ETW and kernel logging of ReadProcessMemory/LSASS access

Use Cases:
- Assessing feasibility/impact of ETW suppression in offensive tooling
- Designing detections resilient to user-mode ETW patching
- Investigating why certain telemetry persists despite EtwEventWrite patching
- Mapping code-flow transitions (PowerShell → WMI/COM/RPC) to identify where logging occurs
- Building lab PoCs to validate provider-specific patching assumptions

Keywords:
ETW, Event Tracing for Windows, ETW provider, function patching, EtwEventWrite, NtTraceEvent, GetProcAddress, VirtualProtect, WriteProcessMemory, LoadLibrary, RVA, module base address, wldap32.dll, Microsoft-Windows-LDAP-Client, Threat-Intelligence ETW, ReadProcessMemory, LSASS dumping, kernel-mode telemetry, user-mode telemetry, COM, RPC, WMI