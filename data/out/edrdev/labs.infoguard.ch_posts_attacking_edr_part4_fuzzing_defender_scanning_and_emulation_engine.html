# https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/

<!DOCTYPE html><html class="transition bg-[var(--page-bg)] md:text-[16px] text-[14px] dark swup-enabled" data-astro-cid-sckkx6r4="" data-overlayscrollbars-initialize="" lang="en" style="--bannerOffset: 15vh; --banner-height-home: 65vh; --banner-height: 35vh; --configHue: 235; --page-width: 75rem; --hue: 235; --banner-height-extend: 30000px; --hue-hl: 97;" data-overlayscrollbars="" data-overlayscrollbars-viewport="scrollbarHidden overflowXScroll overflowYHidden"><body class="transition min-h-screen" data-astro-cid-sckkx6r4="" data-overlayscrollbars-initialize="" style="--bannerOffset:15vh;--banner-height-home:65vh;--banner-height:35vh;--configHue:235;--page-width:75rem"><div id="config-carrier" data-hue="235"></div><div class="transition-all duration-700 max-w-[var(--page-width)] md:px-4 mx-auto pointer-events-none px-0 relative z-50" id="top-row"><div class="transition-all pointer-events-auto sticky top-0" id="navbar-wrapper"><div class="onload-animation z-50" id="navbar"><div class="transition absolute -top-8 bg-[var(--card-bg)] h-8 left-0 right-0"></div><div class="flex items-center justify-between !overflow-visible !rounded-t-none card-base h-[4.5rem] max-w-[var(--page-width)] mx-auto pt-4 px-4"><a href="https://labs.infoguard.ch/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-[3.25rem] mb-2"><div class="mr-24 relative"><svg height="50" width="50" class="stroke-[#FFDC00] stroke-[5]" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg" fill="none"><circle cx="25" cy="25" r="22.5"></circle></svg><div class="absolute top-0 left-[60px]"><svg height="13" width="72" class="fill-[#A0A0A0]" viewBox="0 0 85 15" xmlns="http://www.w3.org/2000/svg"><path d="M54.918 3.90489V14.1256H52.3377V12.8975C51.561 13.8612 50.6015 14.331 49.417 14.331C47.1621 14.331 45.7602 12.8114 45.7602 10.3672V3.90489H48.3211V9.69047C48.3211 11.1406 49.0152 11.9382 50.2731 11.9382C51.5311 11.9382 52.3362 11.0621 52.3362 9.65119V3.90489H54.918ZM64.5795 4.92605C65.3157 5.64811 65.6875 6.71459 65.6875 8.09679V14.1271H63.1821V13.1286C62.392 13.9186 61.344 14.3325 60.1311 14.3325C58.3799 14.3325 56.4938 13.3265 56.4938 11.1195V11.0817C56.4938 8.98653 58.0695 7.73576 60.7083 7.73576C61.8013 7.73576 62.5824 7.90796 63.2001 8.09377V8.05902C63.2001 6.4019 61.9557 6.05446 60.9122 6.05446C59.8687 6.05446 59.0261 6.29767 58.158 6.66172L58.0066 6.72517L57.9541 6.56958L57.3573 4.78556L57.3124 4.65263L57.4398 4.59523C58.3829 4.16924 59.4924 3.77347 61.2106 3.77347C62.6859 3.77347 63.8508 4.17226 64.578 4.92605H64.5795ZM63.2376 10.405V9.83548C62.7833 9.66932 62.0757 9.48805 61.1551 9.48805C59.7847 9.48805 58.9976 10.0334 58.9976 10.9866V11.0243C58.9976 11.8431 59.6903 12.3718 60.7638 12.3718C62.1971 12.3718 63.2376 11.544 63.2376 10.405ZM73.7103 3.71757L73.8572 3.72362V6.42909H73.5738C71.5393 6.42909 70.3743 7.80222 70.3743 10.198V14.1271H67.8135V3.90489H70.3743V5.62697C71.082 4.37166 72.1615 3.71455 73.5273 3.71455C73.5888 3.71455 73.6503 3.71455 73.7118 3.71908L73.7103 3.71757ZM85 0.111784V14.1256H82.4392V12.7736C81.5771 13.8204 80.5261 14.331 79.2397 14.331C76.9518 14.331 74.5214 12.4745 74.5214 9.03336V8.99559C74.5214 5.51669 76.8963 3.69794 79.2397 3.69794C80.5231 3.69794 81.5726 4.17982 82.4392 5.16623V0.111784H85ZM82.4767 9.03336V8.99559C82.4767 7.27502 81.3162 5.97742 79.7794 5.97742C78.2426 5.97742 77.1002 7.21913 77.1002 8.99559V9.03336C77.1002 10.7539 78.2516 12.0515 79.7794 12.0515C81.1048 12.0515 82.4767 10.9216 82.4767 9.03336ZM3.21708e-05 0.117806L0 14.1256H2.56081L2.56084 0.117806H3.21708e-05ZM10.2852 3.69794C9.10677 3.69794 8.14721 4.16471 7.36458 5.12092V3.90489H4.80377V14.1256H7.36458V8.37625C7.36458 6.97593 8.1742 6.07108 9.42912 6.07108C10.684 6.07108 11.3812 6.87623 11.3812 8.33848V14.1241H13.942V7.64361C13.942 5.21004 12.5417 3.69643 10.2867 3.69643L10.2852 3.69794ZM32.7373 8.99559V9.03336C32.7373 12.0153 30.3549 14.3491 27.3128 14.3491C24.2707 14.3491 21.9423 12.0304 21.9423 9.06961V9.03185C21.9423 6.03936 24.3172 3.69643 27.3503 3.69643C30.3834 3.69643 32.7388 6.02425 32.7388 8.99408L32.7373 8.99559ZM24.5031 9.03336C24.5031 10.7267 25.7535 12.0515 27.3488 12.0515C28.9441 12.0515 30.1765 10.7977 30.1765 9.07112V9.03336C30.1765 7.30222 28.9456 5.99706 27.3113 5.99706C25.6771 5.99706 24.5016 7.25841 24.5016 8.9971V9.03487L24.5031 9.03336ZM19.5944 0C18.5869 0 17.8252 0.273418 17.269 0.833848C16.7082 1.40032 16.4234 2.25834 16.4234 3.38373V3.96078H15.1744V6.16625H16.4234V14.1256H18.9842V6.16625H21.5555V3.98042H18.9467V3.59068C18.9467 2.67224 19.3125 2.24323 20.0982 2.24323C20.5719 2.24323 20.9498 2.33689 21.3726 2.4804L21.575 2.54686V0.302119L21.4655 0.268886C21.0187 0.135954 20.449 0 19.5959 0H19.5944ZM33.7043 5.88226C34.1211 3.88525 35.9788 2.43055 37.9174 2.43055C39.5456 2.43055 40.4842 2.95472 41.4707 3.80217L41.5877 3.90338L41.6866 3.78404L43.1395 2.0393L43.2369 1.92148L43.12 1.82178C41.6072 0.527198 40.1274 0 38.0118 0C35.526 0 33.0162 1.45319 31.8017 3.54537C32.5994 4.17226 33.2501 4.96835 33.7043 5.88226ZM43.5728 6.47592V12.2207L43.5188 12.2675C42.4153 13.2177 40.5577 14.3507 37.9789 14.3507C36.1722 14.3507 34.5919 13.7948 33.3685 12.7419C33.9037 11.8899 34.2561 10.9125 34.376 9.85512C35.0972 11.1452 36.4121 11.9397 38.0538 11.9397C39.1513 11.9397 40.2368 11.6059 41.0479 11.0213V8.79468H37.7135V6.47743H43.5713L43.5728 6.47592Z"></path></svg> <span class="-mt-1.5 dark:text-white inline-block text-[#575757] text-[1.2rem]">LABS</span></div></div></a><div class="hidden md:flex"><a href="https://labs.infoguard.ch/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-11" aria-label="Home"><div class="flex items-center">Home</div></a><a href="https://labs.infoguard.ch/posts/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-11" aria-label="Posts"><div class="flex items-center">Posts</div></a><a href="https://labs.infoguard.ch/velociraptor/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-11" aria-label="Velociraptor"><div class="flex items-center">Velociraptor</div></a><a href="https://labs.infoguard.ch/advisories/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-11" aria-label="Advisories"><div class="flex items-center">Advisories</div></a><a href="https://labs.infoguard.ch/archive/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-11" aria-label="Archive"><div class="flex items-center">Archive</div></a><a href="https://infoguard.ch/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-11" aria-label="InfoGuard" target="_blank"><div class="flex items-center">InfoGuard <svg height="1em" width="1em" class="transition -translate-y-[1px] dark:text-white/[0.2] ml-1 text-[0.875rem] text-black/[0.2]" data-icon="fa6-solid:arrow-up-right-from-square"><symbol id="ai:fa6-solid:arrow-up-right-from-square" viewBox="0 0 512 512"><path d="M320 0c-17.7 0-32 14.3-32 32s14.3 32 32 32h82.7L201.4 265.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L448 109.3V192c0 17.7 14.3 32 32 32s32-14.3 32-32V32c0-17.7-14.3-32-32-32zM80 32C35.8 32 0 67.8 0 112v320c0 44.2 35.8 80 80 80h320c44.2 0 80-35.8 80-80V320c0-17.7-14.3-32-32-32s-32 14.3-32 32v112c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16h112c17.7 0 32-14.3 32-32s-14.3-32-32-32z" fill="currentColor"></path></symbol><use href="#ai:fa6-solid:arrow-up-right-from-square"></use></svg></div></a></div><div class="flex"><astro-island client="only" component-export="default" component-url="/_astro/Search.DlUmB71x.js" opts="{&quot;name&quot;:&quot;Search&quot;,&quot;value&quot;:&quot;svelte&quot;}" props="{}" renderer-url="/_astro/client.svelte.DYqRqnAG.js" uid="ZEG73h"><div id="search-bar" class="hidden lg:flex transition-all items-center h-11 mr-2 rounded-lg
      bg-black/[0.04] hover:bg-black/[0.06] focus-within:bg-black/[0.06]
      dark:bg-white/5 dark:hover:bg-white/10 dark:focus-within:bg-white/10
"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="absolute text-[1.25rem] pointer-events-none ml-3 transition my-auto text-black/30 dark:text-white/30 iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"></path><!----></svg><!----> <input class="transition-all pl-10 text-sm bg-transparent outline-0
         h-full w-40 active:w-60 focus:w-60 text-black/50 dark:text-white/50 svelte-1gu5h8y" placeholder="Search"></div> <button aria-label="Search Panel" id="search-switch" class="btn-plain scale-animation lg:!hidden rounded-lg w-11 h-11 active:scale-90"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"></path><!----></svg><!----></button> <div id="search-panel" class="float-panel float-panel-closed search-panel absolute md:w-[30rem] top-20 left-4 md:left-[unset] right-4 shadow-2xl rounded-2xl p-2"><div id="search-bar-inside" class="flex relative lg:hidden transition-all items-center h-11 rounded-xl
      bg-black/[0.04] hover:bg-black/[0.06] focus-within:bg-black/[0.06]
      dark:bg-white/5 dark:hover:bg-white/10 dark:focus-within:bg-white/10
  "><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="absolute text-[1.25rem] pointer-events-none ml-3 transition my-auto text-black/30 dark:text-white/30 iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"></path><!----></svg><!----> <input placeholder="Search" class="pl-10 absolute inset-0 text-sm bg-transparent outline-0
               focus:w-60 text-black/50 dark:text-white/50 svelte-1gu5h8y"></div> <!----></div></astro-island><astro-island client="load" component-export="default" component-url="/_astro/LightDarkSwitch.gKnghUdE.js" opts="{&quot;name&quot;:&quot;LightDarkSwitch&quot;,&quot;value&quot;:true}" props="{}" renderer-url="/_astro/client.svelte.DYqRqnAG.js" uid="2ad1lD" await-children=""><div class="relative z-50" role="menu" tabindex="-1"><button aria-label="Light/Dark Mode" role="menuitem" class="relative btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90" id="scheme-switch"><div class="absolute opacity-0"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M11 3V2q0-.425.288-.712T12 1t.713.288T13 2v1q0 .425-.288.713T12 4t-.712-.288T11 3m0 19v-1q0-.425.288-.712T12 20t.713.288T13 21v1q0 .425-.288.713T12 23t-.712-.288T11 22m11-9h-1q-.425 0-.712-.288T20 12t.288-.712T21 11h1q.425 0 .713.288T23 12t-.288.713T22 13M3 13H2q-.425 0-.712-.288T1 12t.288-.712T2 11h1q.425 0 .713.288T4 12t-.288.713T3 13m16.75-7.325l-.35.35q-.275.275-.687.275T18 6q-.275-.275-.288-.687t.263-.713l.375-.375q.275-.3.7-.3t.725.3t.288.725t-.313.725M6.025 19.4l-.375.375q-.275.3-.7.3t-.725-.3t-.288-.725t.313-.725l.35-.35q.275-.275.688-.275T6 18q.275.275.288.688t-.263.712m12.3.35l-.35-.35q-.275-.275-.275-.687T18 18q.275-.275.688-.287t.712.262l.375.375q.3.275.3.7t-.3.725t-.725.288t-.725-.313M4.6 6.025l-.375-.375q-.3-.275-.3-.7t.3-.725t.725-.288t.725.313l.35.35q.275.275.275.688T6 6q-.275.275-.687.288T4.6 6.025M7.75 16.25Q6 14.5 6 12t1.75-4.25T12 6t4.25 1.75T18 12t-1.75 4.25T12 18t-4.25-1.75m7.088-1.412Q16 13.675 16 12t-1.162-2.838T12 8T9.162 9.163T8 12t1.163 2.838T12 16t2.838-1.162M12 12"></path><!----></svg><!----></div> <div class="absolute"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M12 21q-3.775 0-6.387-2.613T3 12q0-3.45 2.25-5.988T11 3.05q.325-.05.575.088t.4.362t.163.525t-.188.575q-.425.65-.638 1.375T11.1 7.5q0 2.25 1.575 3.825T16.5 12.9q.775 0 1.538-.225t1.362-.625q.275-.175.563-.162t.512.137q.25.125.388.375t.087.6q-.35 3.45-2.937 5.725T12 21m0-2q2.2 0 3.95-1.213t2.55-3.162q-.5.125-1 .2t-1 .075q-3.075 0-5.238-2.163T9.1 7.5q0-.5.075-1t.2-1q-1.95.8-3.163 2.55T5 12q0 2.9 2.05 4.95T12 19m-.25-6.75"></path><!----></svg><!----></div> <div class="absolute opacity-0"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17V7Q9.925 7 8.463 8.463T7 12t1.463 3.538T12 17m0 5q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12t-2.325-5.675T12 4T6.325 6.325T4 12t2.325 5.675T12 20m0-8"></path><!----></svg><!----></div></button> <div id="light-dark-panel" class="hidden lg:block absolute transition float-panel-closed top-11 -right-2 pt-5"><div class="card-base float-panel p-2"><button class="flex transition whitespace-nowrap items-center !justify-start w-full btn-plain scale-animation rounded-lg h-9 px-3 font-medium active:scale-95 mb-0.5"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] mr-3 iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M11 3V2q0-.425.288-.712T12 1t.713.288T13 2v1q0 .425-.288.713T12 4t-.712-.288T11 3m0 19v-1q0-.425.288-.712T12 20t.713.288T13 21v1q0 .425-.288.713T12 23t-.712-.288T11 22m11-9h-1q-.425 0-.712-.288T20 12t.288-.712T21 11h1q.425 0 .713.288T23 12t-.288.713T22 13M3 13H2q-.425 0-.712-.288T1 12t.288-.712T2 11h1q.425 0 .713.288T4 12t-.288.713T3 13m16.75-7.325l-.35.35q-.275.275-.687.275T18 6q-.275-.275-.288-.687t.263-.713l.375-.375q.275-.3.7-.3t.725.3t.288.725t-.313.725M6.025 19.4l-.375.375q-.275.3-.7.3t-.725-.3t-.288-.725t.313-.725l.35-.35q.275-.275.688-.275T6 18q.275.275.288.688t-.263.712m12.3.35l-.35-.35q-.275-.275-.275-.687T18 18q.275-.275.688-.287t.712.262l.375.375q.3.275.3.7t-.3.725t-.725.288t-.725-.313M4.6 6.025l-.375-.375q-.3-.275-.3-.7t.3-.725t.725-.288t.725.313l.35.35q.275.275.275.688T6 6q-.275.275-.687.288T4.6 6.025M7.75 16.25Q6 14.5 6 12t1.75-4.25T12 6t4.25 1.75T18 12t-1.75 4.25T12 18t-4.25-1.75m7.088-1.412Q16 13.675 16 12t-1.162-2.838T12 8T9.162 9.163T8 12t1.163 2.838T12 16t2.838-1.162M12 12"></path><!----></svg><!----> Light</button> <button class="flex transition whitespace-nowrap items-center !justify-start w-full btn-plain scale-animation rounded-lg h-9 px-3 font-medium active:scale-95 mb-0.5 current-theme-btn"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] mr-3 iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M12 21q-3.775 0-6.387-2.613T3 12q0-3.45 2.25-5.988T11 3.05q.325-.05.575.088t.4.362t.163.525t-.188.575q-.425.65-.638 1.375T11.1 7.5q0 2.25 1.575 3.825T16.5 12.9q.775 0 1.538-.225t1.362-.625q.275-.175.563-.162t.512.137q.25.125.388.375t.087.6q-.35 3.45-2.937 5.725T12 21m0-2q2.2 0 3.95-1.213t2.55-3.162q-.5.125-1 .2t-1 .075q-3.075 0-5.238-2.163T9.1 7.5q0-.5.075-1t.2-1q-1.95.8-3.163 2.55T5 12q0 2.9 2.05 4.95T12 19m-.25-6.75"></path><!----></svg><!----> Dark</button> <button class="flex transition whitespace-nowrap items-center !justify-start w-full btn-plain scale-animation rounded-lg h-9 px-3 font-medium active:scale-95"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] mr-3 iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17V7Q9.925 7 8.463 8.463T7 12t1.463 3.538T12 17m0 5q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12t-2.325-5.675T12 4T6.325 6.325T4 12t2.325 5.675T12 20m0-8"></path><!----></svg><!----> System</button></div></div></div></astro-island><button class="rounded-lg btn-plain scale-animation h-11 active:scale-90 w-11 md:!hidden" aria-label="Menu" id="nav-menu-switch" name="Nav Menu"><svg height="1em" width="1em" class="text-[1.25rem]" data-icon="material-symbols:menu-rounded"><symbol id="ai:material-symbols:menu-rounded" viewBox="0 0 24 24"><path d="M4 18q-.425 0-.712-.288T3 17t.288-.712T4 16h16q.425 0 .713.288T21 17t-.288.713T20 18zm0-5q-.425 0-.712-.288T3 12t.288-.712T4 11h16q.425 0 .713.288T21 12t-.288.713T20 13zm0-5q-.425 0-.712-.288T3 7t.288-.712T4 6h16q.425 0 .713.288T21 7t-.288.713T20 8z" fill="currentColor"></path></symbol><use href="#ai:material-symbols:menu-rounded"></use></svg></button></div><div class="absolute float-panel-closed fixed float-panel px-2 py-2 right-4 transition-all" id="nav-menu-panel"><a href="https://labs.infoguard.ch/" class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">Home</div><svg height="1em" width="1em" class="transition text-[var(--primary)] text-[1.25rem]" data-icon="material-symbols:chevron-right-rounded"><symbol id="ai:material-symbols:chevron-right-rounded" viewBox="0 0 24 24"><path d="M12.6 12L8.7 8.1q-.275-.275-.275-.7t.275-.7t.7-.275t.7.275l4.6 4.6q.15.15.213.325t.062.375t-.062.375t-.213.325l-4.6 4.6q-.275.275-.7.275t-.7-.275t-.275-.7t.275-.7z" fill="currentColor"></path></symbol><use href="#ai:material-symbols:chevron-right-rounded"></use></svg> </a><a href="https://labs.infoguard.ch/posts/" class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">Posts</div><svg height="1em" width="1em" class="transition text-[var(--primary)] text-[1.25rem]" data-icon="material-symbols:chevron-right-rounded" viewBox="0 0 24 24"><use href="#ai:material-symbols:chevron-right-rounded"></use></svg> </a><a href="https://labs.infoguard.ch/velociraptor/" class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">Velociraptor</div><svg height="1em" width="1em" class="transition text-[var(--primary)] text-[1.25rem]" data-icon="material-symbols:chevron-right-rounded" viewBox="0 0 24 24"><use href="#ai:material-symbols:chevron-right-rounded"></use></svg> </a><a href="https://labs.infoguard.ch/advisories/" class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">Advisories</div><svg height="1em" width="1em" class="transition text-[var(--primary)] text-[1.25rem]" data-icon="material-symbols:chevron-right-rounded" viewBox="0 0 24 24"><use href="#ai:material-symbols:chevron-right-rounded"></use></svg> </a><a href="https://labs.infoguard.ch/archive/" class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">Archive</div><svg height="1em" width="1em" class="transition text-[var(--primary)] text-[1.25rem]" data-icon="material-symbols:chevron-right-rounded" viewBox="0 0 24 24"><use href="#ai:material-symbols:chevron-right-rounded"></use></svg> </a><a href="https://infoguard.ch/" class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2" target="_blank"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">InfoGuard</div><svg height="1em" width="1em" class="transition -translate-x-1 dark:text-white/25 text-[0.75rem] text-black/25" data-icon="fa6-solid:arrow-up-right-from-square" viewBox="0 0 512 512"><use href="#ai:fa6-solid:arrow-up-right-from-square"></use></svg></a></div><astro-island client="only" component-export="default" component-url="/_astro/DisplaySettings.KStfPvg9.js" opts="{&quot;name&quot;:&quot;DisplaySettings&quot;,&quot;value&quot;:&quot;svelte&quot;}" props="{}" renderer-url="/_astro/client.svelte.DYqRqnAG.js" uid="ZjfqNG"><div id="display-setting" class="float-panel float-panel-closed absolute transition-all w-80 right-4 px-4 py-4 svelte-1s19bex"><div class="flex flex-row gap-2 mb-3 items-center justify-between"><div class="flex gap-2 font-bold text-lg text-neutral-900 dark:text-neutral-100 transition relative ml-3
            before:w-1 before:h-4 before:rounded-md before:bg-[var(--primary)]
            before:absolute before:-left-3 before:top-[0.33rem]">Theme Color <button aria-label="Reset to Default" class="btn-regular w-7 h-7 rounded-md active:scale-90 opacity-0 pointer-events-none"><div class="text-[var(--btn-content)]"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[0.875rem] iconify iconify--fa6-solid" width="1em" height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M125.7 160H176c17.7 0 32 14.3 32 32s-14.3 32-32 32H48c-17.7 0-32-14.3-32-32V64c0-17.7 14.3-32 32-32s32 14.3 32 32v51.2l17.6-17.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0z"></path><!----></svg><!----></div></button></div> <div class="flex gap-1"><div id="hueValue" class="transition bg-[var(--btn-regular-bg)] w-10 h-7 rounded-md flex justify-center
            font-bold text-sm items-center text-[var(--btn-content)]">235</div></div></div> <div class="w-full h-6 px-1 bg-[oklch(0.80_0.10_0)] dark:bg-[oklch(0.70_0.10_0)] rounded select-none"><input type="range" min="0" max="360" class="slider svelte-1s19bex" id="colorSlider" step="5" style="width: 100%" aria-label="Theme Color"></div></div></astro-island></div></div></div></div><div class="absolute pointer-events-none w-full z-30" style="top:5.5rem"><div class="mx-auto max-w-[var(--page-width)] relative pointer-events-auto"><div class="transition w-full duration-700 gap-4 grid grid-cols-[17.5rem_auto] grid-rows-[auto_1fr_auto] left-0 lg:grid-rows-[auto] md:px-4 mx-auto px-0 right-0" id="main-grid"><main class="overflow-hidden col-span-2 lg:col-span-1 transition-swup-fade" id="swup-container"><div class="onload-animation" id="content-wrapper"><div class="flex w-full relative mb-4 overflow-hidden rounded-[var(--radius-large)]"><div class="card-base pb-4 md:px-9 pt-6 px-6 relative w-full z-10" id="post-container"><div class="transition flex dark:text-white/30 flex-row gap-5 mb-3 onload-animation text-black/30"><div class="flex items-center"><div class="transition flex items-center justify-center bg-black/5 dark:bg-white/10 dark:text-white/50 h-6 mr-2 rounded-md text-black/50 w-6"><svg height="1em" width="1em" class="text-xl" data-icon="material-symbols:calendar-today-outline-rounded"><symbol id="ai:material-symbols:calendar-today-outline-rounded" viewBox="0 0 24 24"><path d="M5 22q-.825 0-1.412-.587T3 20V6q0-.825.588-1.412T5 4h1V3q0-.425.288-.712T7 2t.713.288T8 3v1h8V3q0-.425.288-.712T17 2t.713.288T18 3v1h1q.825 0 1.413.588T21 6v14q0 .825-.587 1.413T19 22zm0-2h14V10H5zM5 8h14V6H5zm0 0V6z" fill="currentColor"></path></symbol><use href="#ai:material-symbols:calendar-today-outline-rounded"></use></svg></div><div class="text-sm">2025-05-23</div></div><div class="flex items-center flex-row"><div class="transition flex items-center justify-center bg-black/5 dark:bg-white/10 dark:text-white/50 h-6 mr-2 rounded-md text-black/50 w-6"><svg height="1em" width="1em" data-icon="material-symbols:notes-rounded"><symbol id="ai:material-symbols:notes-rounded" viewBox="0 0 24 24"><path d="M4 18q-.425 0-.712-.288T3 17t.288-.712T4 16h10q.425 0 .713.288T15 17t-.288.713T14 18zm0-5q-.425 0-.712-.288T3 12t.288-.712T4 11h16q.425 0 .713.288T21 12t-.288.713T20 13zm0-5q-.425 0-.712-.288T3 7t.288-.712T4 6h16q.425 0 .713.288T21 7t-.288.713T20 8z" fill="currentColor"></path></symbol><use href="#ai:material-symbols:notes-rounded"></use></svg></div><div class="text-sm">3901 words</div></div><div class="flex items-center flex-row"><div class="transition flex items-center justify-center bg-black/5 dark:bg-white/10 dark:text-white/50 h-6 mr-2 rounded-md text-black/50 w-6"><svg height="1em" width="1em" data-icon="material-symbols:schedule-outline-rounded"><symbol id="ai:material-symbols:schedule-outline-rounded" viewBox="0 0 24 24"><path d="M13 11.6V8q0-.425-.288-.712T12 7t-.712.288T11 8v3.975q0 .2.075.388t.225.337l3.3 3.3q.275.275.7.275T16 16t.275-.7t-.275-.7zM12 22q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q3.325 0 5.663-2.337T20 12t-2.337-5.663T12 4T6.337 6.338T4 12t2.338 5.663T12 20" fill="currentColor"></path></symbol><use href="#ai:material-symbols:schedule-outline-rounded"></use></svg></div><div class="text-sm">20 minutes</div></div></div><div class="onload-animation relative"><div class="transition font-bold before:absolute before:bg-[var(--primary)] before:rounded-md before:h-5 before:left-[-1.125rem] before:top-[0.75rem] block dark:text-white/90 mb-3 md:before:w-1 md:text-[2.25rem]/[2.75rem] text-3xl text-black/90 w-full" data-pagefind-body="" data-pagefind-meta="title" data-pagefind-weight="10">Attacking EDRs Part 4: Fuzzing Defender's Scanning and Emulation Engine (mpengine.dll)</div></div><div class="onload-animation"><div class="flex items-center dark:text-neutral-400 flex-wrap gap-4 gap-x-4 gap-y-2 mb-5 text-neutral-500"><div class="flex items-center"><div class="meta-icon"><svg height="1em" width="1em" class="text-xl" data-icon="material-symbols:person-outline"><symbol id="ai:material-symbols:person-outline" viewBox="0 0 24 24"><path d="M12 12q-1.65 0-2.825-1.175T8 8t1.175-2.825T12 4t2.825 1.175T16 8t-1.175 2.825T12 12m-8 8v-2.8q0-.85.438-1.562T5.6 14.55q1.55-.775 3.15-1.162T12 13t3.25.388t3.15 1.162q.725.375 1.163 1.088T20 17.2V20zm2-2h12v-.8q0-.275-.137-.5t-.363-.35q-1.35-.675-2.725-1.012T12 15t-2.775.338T6.5 16.35q-.225.125-.363.35T6 17.2zm6-8q.825 0 1.413-.587T14 8t-.587-1.412T12 6t-1.412.588T10 8t.588 1.413T12 10m0 8" fill="currentColor"></path></symbol><use href="#ai:material-symbols:person-outline"></use></svg></div><a href="https://twitter.com/p0w1_" class="transition flex items-center font-medium whitespace-nowrap dark:hover:text-[var(--primary)] gap-1 hover:text-[var(--primary)] link-lg text-50 text-sm" aria-label="X profile of Manuel Feifel" target="_blank" rel="noopener noreferrer"><span>Manuel Feifel </span><svg height="1em" width="1em" class="text-lg" data-icon="fa6-brands:x-twitter"><symbol id="ai:fa6-brands:x-twitter" viewBox="0 0 512 512"><path d="M389.2 48h70.6L305.6 224.2L487 464H345L233.7 318.6L106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z" fill="currentColor"></path></symbol><use href="#ai:fa6-brands:x-twitter"></use></svg></a></div><div class="flex items-center"><div class="meta-icon"><svg height="1em" width="1em" class="text-xl" data-icon="material-symbols:book-2-outline-rounded"><symbol id="ai:material-symbols:book-2-outline-rounded" viewBox="0 0 24 24"><path d="M6 15.325q.35-.175.725-.25T7.5 15H8V4h-.5q-.625 0-1.062.438T6 5.5zM10 15h8V4h-8zm-4 .325V4zM7.5 22q-1.45 0-2.475-1.025T4 18.5v-13q0-1.45 1.025-2.475T7.5 2H18q.825 0 1.413.587T20 4v12.525q0 .2-.162.363t-.588.362q-.35.175-.55.5t-.2.75t.2.763t.55.487t.55.413t.2.562v.25q0 .425-.288.725T19 22zm0-2h9.325q-.15-.35-.237-.712T16.5 18.5q0-.4.075-.775t.25-.725H7.5q-.65 0-1.075.438T6 18.5q0 .65.425 1.075T7.5 20" fill="currentColor"></path></symbol><use href="#ai:material-symbols:book-2-outline-rounded"></use></svg></div><div class="flex items-center flex-row flex-nowrap"><a href="https://labs.infoguard.ch/archive/category/Vulnerability%20Research/" class="transition text-sm text-50 dark:hover:text-[var(--primary)] font-medium hover:text-[var(--primary)] link-lg whitespace-nowrap" aria-label="View all posts in the Vulnerability Research category">Vulnerability Research</a></div></div><div class="flex items-center"><div class="meta-icon"><svg height="1em" width="1em" class="text-xl" data-icon="material-symbols:tag-rounded"><symbol id="ai:material-symbols:tag-rounded" viewBox="0 0 24 24"><path d="m9 16l-.825 3.275q-.075.325-.325.525t-.6.2q-.475 0-.775-.375T6.3 18.8L7 16H4.275q-.5 0-.8-.387T3.3 14.75q.075-.35.35-.55t.625-.2H7.5l1-4H5.775q-.5 0-.8-.387T4.8 8.75q.075-.35.35-.55t.625-.2H9l.825-3.275Q9.9 4.4 10.15 4.2t.6-.2q.475 0 .775.375t.175.825L11 8h4l.825-3.275q.075-.325.325-.525t.6-.2q.475 0 .775.375t.175.825L17 8h2.725q.5 0 .8.387t.175.863q-.075.35-.35.55t-.625.2H16.5l-1 4h2.725q.5 0 .8.388t.175.862q-.075.35-.35.55t-.625.2H15l-.825 3.275q-.075.325-.325.525t-.6.2q-.475 0-.775-.375T12.3 18.8L13 16zm.5-2h4l1-4h-4z" fill="currentColor"></path></symbol><use href="#ai:material-symbols:tag-rounded"></use></svg></div><div class="flex items-center flex-row flex-nowrap"><div class="hidden mx-1.5 text-[var(--meta-divider)] text-sm">/</div><a href="https://labs.infoguard.ch/archive/tag/VulnResearch/" class="transition text-sm text-50 dark:hover:text-[var(--primary)] font-medium hover:text-[var(--primary)] link-lg whitespace-nowrap" aria-label="View all posts with the VulnResearch tag">VulnResearch</a><div class="mx-1.5 text-[var(--meta-divider)] text-sm">/</div><a href="https://labs.infoguard.ch/archive/tag/EDR/" class="transition text-sm text-50 dark:hover:text-[var(--primary)] font-medium hover:text-[var(--primary)] link-lg whitespace-nowrap" aria-label="View all posts with the EDR tag">EDR</a></div></div></div></div><img alt="Attacking EDRs Part 4: Fuzzing Defender's Scanning and Emulation Engine (mpengine.dll)" decoding="async" height="417" loading="lazy" src="https://labs.infoguard.ch/_astro/defender_crash.iGitdS1V_ZOXYbg.webp" width="923" class="onload-animation banner-container mb-8 rounded-xl" id="post-cover"><div class="onload-animation mb-6 !max-w-none custom-md dark:prose-invert markdown-content prose prose-base" data-pagefind-body=""><p>This blog post is part of a series analyzing the attack surface for Endpoint Detection and Response (EDR) solutions by <a href="https://x.com/p0w1_">p0w1_</a>. Parts 1-3 are linked, with concluding notes for that initial sub-series in Part 3.</p><ul><li><a href="https://labs.infoguard.ch/posts/edr_part1_intro_-_security_analysis_of_edr_drivers/">Part 1</a> gives an overview of the attack surface of EDR software and describes the process for analysing drivers from the perspective of a low-privileged user.</li><li><a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/">Part 2</a> describes the results of the EDR driver security analysis. A minor authentication issue in the Windows driver of the Cortex XDR agent was identified (CVE-2024-5905). Additionally a PPL-”bypass” as well as a detection bypass by early startup. Furthermore, snapshot fuzzing was applied to a Mini-Filter Communication Port of the Sophos Intercept X Windows Mini-Filter driver.</li><li><a href="https://labs.infoguard.ch/posts/edr_part3_one_bug_to_stop_them_all/">Part 3</a> describes a DoS vulnerability affecting most Windows EDR agents. This vulnerability allows a low-privileged user to crash/stop the agent permanently by exploiting an issue in how the agent handles preexisting objects in the Object Manager’s namespace. Only some vendors assigned a CVE (CVE-2023-3280, CVE-2024-5909, CVE-2024-20671).</li><li><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine">Part 4</a> (<strong>this post</strong>) describes the fuzzing process of Microsoft Defender’s scanning and emulation engine <code>mpengine.dll</code>. Multiple out-of-bounds read and null dereference bugs were identified by using Snapshot Fuzzing with WTF and kAFL/NYX. These bugs can be used to crash the main Defender process as soon as the file is scanned. None of the bugs appear to be exploitable for code execution.</li></ul><section><h1 id="1-introduction">1. Introduction<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#1-introduction" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h1><p>Microsoft Defender (and Defender for Endpoint) is a very interesting target for attackers. It’s installed by default, runs as SYSTEM, has 1-click remote attack surface and has a vast codebase that parses and unpacks numerous file formats, making it prone to memory corruption vulnerabilities. Despite this, it does not receive much attention from public vulnerability researchers.</p><p>Tavis Ormandy from Google Project Zero was one of the first to look into it and find an exploitable vulnerability <a href="https://project-zero.issues.chromium.org/issues/42450309">CVE-2017-8558</a>. He created a DLL loader on Linux to fuzz it called <a href="https://github.com/taviso/loadlibrary">loadlibrary</a> because at that time, no suitable Windows fuzzer for this target was available. Another RCE is <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34522">CVE-2021-34522</a>. Afterwards, relatively little research or vulnerabilities were published, which motivated me to explore this target.</p></section><section><h1 id="2-summary">2. Summary<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#2-summary" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h1><p>Microsoft Defender and Defender for Endpoint include a local analysis engine <code>mpengine.dll</code>, to identify potentially malicious files. This engine performs static checks and uses emulation environments for different file types. This target was fuzzed on Windows mainly using the snapshot fuzzer <a href="https://github.com/0vercl0k/wtf">WTF</a>. Additionally, <a href="https://github.com/IntelLabs/kAFL">kAFL/NYX</a> and <a href="https://github.com/googleprojectzero/Jackalope">Jackalope</a> were tested. WTF found nine different bugs (OOB-reads and null dereferences), some of which can be used to crash Defender(<code>MsMpEng.exe</code>) under normal conditions. Some bugs only lead to a crash with PageHeap enabled. However, after my analysis, none of the bugs appear to be exploitable for code execution. Therefore, these bugs can primarily be used to kill Defender, allowing subsequent malicious actions without detection or prevention. For example, a malicious file could be delivered alongside an initial access payload to kill Defender before the payload executes. Alternatively, it could be used in an internal network to disable Defender by uploading the file to a target host or share before dumping credentials.</p><p>Microsoft officially doesn’t care about these vulnerabilities and responds with the famous:</p><blockquote><p>After careful investigation, this case has been assessed as moderate severity and does not meet MSRC’s bar for immediate servicing.</p></blockquote><p>Despite this, they have probably quietly fixed at least one reported bug within a few weeks.</p><p><strong>Update:</strong> Shortly after this post was published, all bugs were fixed silently.</p></section><section><h1 id="3-how-to-fuzz-mpenginedll">3. How to fuzz <code>mpengine.dll</code>?<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#3-how-to-fuzz-mpenginedll" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h1><p>In 2017, Google Project Zero fuzzed it on Linux by creating a <a href="https://github.com/taviso/loadlibrary">DLL loader</a> and writing this <a href="https://github.com/taviso/loadlibrary/blob/master/mpclient.c">harness</a>. The original harness does no longer work on newer mpengine versions but this could be fixed by some changes. In 2022, <a href="https://medium.com/s2wblog/fuzzing-the-shield-cve-2022-24548-96f568980c0">S2W</a> ported the harness to a newer mpengine version (though not publicly released) and fuzzed it using Jackalope.</p><p>Both approaches manually booted mpengine using <code>RSIG_BOOTENGINE</code> and then initiated a scan by <code>RSIG_SCAN_STREAMBUFFER</code>:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="cpp" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span style="color:#e1e4e8">BootParams.ClientVersion </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> BOOTENGINE_PARAMS_VERSION;</span></span>
<span class="line"><span style="color:#e1e4e8">BootParams.Attributes    </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> BOOT_ATTR_NORMAL;</span></span>
<span class="line"><span style="color:#e1e4e8">BootParams.SignatureLocation </span><span style="color:#f97583">=</span><span style="color:#9ecbff"> L"engine"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">BootParams.ProductName </span><span style="color:#f97583">=</span><span style="color:#9ecbff"> L"Legitimate Antivirus"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">EngineConfig.QuarantineLocation </span><span style="color:#f97583">=</span><span style="color:#9ecbff"> L"quarantine"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">EngineConfig.Inclusions </span><span style="color:#f97583">=</span><span style="color:#9ecbff"> L"*.*"</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">EngineConfig.EngineFlags </span><span style="color:#f97583">=</span><span style="color:#79b8ff"> 1</span><span style="color:#f97583"> &lt;&lt;</span><span style="color:#79b8ff"> 1</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">BootParams.EngineInfo </span><span style="color:#f97583">=</span><span style="color:#f97583"> &amp;</span><span style="color:#e1e4e8">EngineInfo;</span></span>
<span class="line"><span style="color:#e1e4e8">BootParams.EngineConfig </span><span style="color:#f97583">=</span><span style="color:#f97583"> &amp;</span><span style="color:#e1e4e8">EngineConfig;</span></span>
<span class="line"><span style="color:#e1e4e8">KernelHandle </span><span style="color:#f97583">=</span><span style="color:#79b8ff"> NULL</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#b392f0">__rsignal</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8">KernelHandle, RSIG_BOOTENGINE, </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8">BootParams, sizeof BootParams) </span><span style="color:#f97583">!=</span><span style="color:#79b8ff"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">[...]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">ScanParams.Descriptor        = &amp;ScanDescriptor;</span></span>
<span class="line"><span style="color:#e1e4e8">ScanParams.ScanReply         </span><span style="color:#f97583">=</span><span style="color:#f97583"> &amp;</span><span style="color:#e1e4e8">ScanReply;</span></span>
<span class="line"><span style="color:#e1e4e8">ScanReply.EngineScanCallback </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> EngineScanCallback;</span></span>
<span class="line"><span style="color:#e1e4e8">ScanReply.field_C            </span><span style="color:#f97583">=</span><span style="color:#f97583"> 0x</span><span style="color:#79b8ff">7fffffff</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">ScanDescriptor.Read          </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> ReadStream;</span><span style="color:#6a737d">  //The fuzzing payload is read by this function</span></span>
<span class="line"><span style="color:#e1e4e8">ScanDescriptor.GetSize       </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> GetStreamSize;</span></span>
<span class="line"><span style="color:#e1e4e8">ScanDescriptor.GetName       </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> GetStreamName;</span></span>
<span class="line"><span style="color:#b392f0">__rsignal</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8">KernelHandle, RSIG_SCAN_STREAMBUFFER, </span><span style="color:#f97583">&amp;</span><span style="color:#e1e4e8">ScanParams, sizeof ScanParams)</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p>The question for me was: does this actually scan the content in the exact same way as when a file or stream is scanned under normal operating conditions? Perhaps there are other configurations, or it scans files differently than streams?</p><p>While browsing <code>mpengine.dll</code> in IDA, I noticed many configuration options that could influence fuzzing results if they differed from a real environment: <img alt="" decoding="async" height="368" loading="lazy" src="https://labs.infoguard.ch/_astro/mpengine_queryconfig.BF6E4thy_1oRguY.webp" width="992"></p><p>Therefore, I decided to use a different approach by using snapshot fuzzing with WTF. This way, mpengine.dll is already booted and configured identically to a real environment. Additionally, a file-based scan can be used instead of a stream when taking a snapshot after initiating a file scan. An overview of the steps to use WTF are already described in <a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#3-sophos-intercept-x">Part 2, Section 3</a></p><p>A manual file scan for Defender can be triggered using <code>MpCmdRun.exe</code>. However, this does not trigger the scan in the same process but instead sends a RPC request and then uses the exported function <code>rsignal</code> to initiate the scan within <code>mpengine.dll</code> loaded by <code>MsMpEng.exe</code>.</p><p>The next step is to debug Defender in order to understand where the scans occur.</p><section><h2 id="31-debugging-defender">3.1 Debugging Defender<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#31-debugging-defender" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h2><p>The target process that needs to be debugged is <code>MsMpEng.exe</code>. However, AVs/EDRs have self-protection features to prevent debugging or code injection.</p><p>There are two main options to debug it:</p><section><h4 id="1-use-a-user-mode-debugger-and-bypass-restrictions">1.) Use a user mode debugger and bypass restrictions<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#1-use-a-user-mode-debugger-and-bypass-restrictions" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h4><p>Use <a href="https://github.com/itm4n/PPLcontrol">PPLControl</a> to elevate the debugging process to PPL-WinSystem. Afterwards, this process can access other PPL processes, such as Defender’s. <img alt="" decoding="async" height="58" loading="lazy" src="https://labs.infoguard.ch/_astro/pplcontrol.CyZoH_eL_11nYQr.webp" width="1027"> <img alt="" decoding="async" height="552" loading="lazy" src="https://labs.infoguard.ch/_astro/pplcontrol2.DrflNsCV_a6A1O.webp" width="597"></p><p>However, kernel callbacks still prevent access to <code>MsMpEng.exe</code>. These can be removed by overwriting a central callback function in the Defender kernel driver <code>WdFilter.sys</code> using WinDBG as a kernel debugger:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>0: kd&gt; a WdFilter!MpObPreOperationCallback</span></span>
<span class="line"><span>fffff807`1e5cd100 xor eax,eax</span></span>
<span class="line"><span>fffff807`1e5cd102 ret</span></span>
<span class="line"><span>fffff807`1e5cd103 </span></span>
<span class="line"><span>0: kd&gt; u WdFilter!MpObPreOperationCallback</span></span>
<span class="line"><span>WdFilter!MpObPreOperationCallback:</span></span>
<span class="line"><span>fffff807`1e5cd100 31c0            xor     eax,eax</span></span>
<span class="line"><span>fffff807`1e5cd102 c3              ret</span></span>
<span class="line"><span>fffff807`1e5cd103 284883          sub     byte ptr [rax-7Dh],cl</span></span>
<span class="line"><span>fffff807`1e5cd106 7a08            jp      WdFilter!MpObPreOperationCallback+0x10 (fffff807`1e5cd110)</span></span>
<span class="line"><span>fffff807`1e5cd108 00742e48        add     byte ptr [rsi+rbp+48h],dh</span></span>
<span class="line"><span>fffff807`1e5cd10c 8b05de33feff    mov     eax,dword ptr [WdFilter!ExDesktopObjectType (fffff807`1e5b04f0)]</span></span>
<span class="line"><span>fffff807`1e5cd112 488b4a10        mov     rcx,qword ptr [rdx+10h]</span></span>
<span class="line"><span>fffff807`1e5cd116 483b08          cmp     rcx,qword ptr [rax]</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p>Afterwards, a debugger can be attached regularly: <img alt="" decoding="async" height="357" loading="lazy" src="https://labs.infoguard.ch/_astro/windbg_msmpeng.exe.C8vgeGQa_2uhzdy.webp" width="1022"></p></section><section><h4 id="2-use-windbg-as-a-kernel-debugger-and-follow-the-msmpengexe-process">2.) Use WinDBG as a kernel debugger and follow the MsMpEng.exe process.<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#2-use-windbg-as-a-kernel-debugger-and-follow-the-msmpengexe-process" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h4><p>After attaching WinDBG (e.g., with <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection-automatically">KDNET</a>), set the debugger’s context to the target process:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>kd&gt; !process 0 0 MsMpEng.exe</span></span>
<span class="line"><span>PROCESS ffffb385a10d0080</span></span>
<span class="line"><span>    SessionId: 0  Cid: 0df8    Peb: 22c10a0000  ParentCid: 0288</span></span>
<span class="line"><span>    DirBase: 1a431e000  ObjectTable: ffffe08888ed27c0  HandleCount: 452.</span></span>
<span class="line"><span>    Image: MsMpEng.exe</span></span>
<span class="line"><span></span></span>
<span class="line"><span>kd&gt; .process /i /p ffffb385a10d0080</span></span>
<span class="line"><span>You need to continue execution (press 'g' &lt;enter&gt;) for the context</span></span>
<span class="line"><span>to be switched. When the debugger breaks in again, you will be in</span></span>
<span class="line"><span>the new process context.</span></span>
<span class="line"><span>kd&gt; g</span></span>
<span class="line"><span>Break instruction exception - code 80000003 (first chance)</span></span>
<span class="line"><span>nt!DbgBreakPointWithStatus:</span></span>
<span class="line"><span>fffff805`829fedc0 cc              int     3</span></span>
<span class="line"><span>kd&gt; .reload /user</span></span>
<span class="line"><span>Loading User Symbols</span></span>
<span class="line"><span>.....................................................</span></span>
<span class="line"><span>kd&gt; lmu</span></span>
<span class="line"><span>start             end                 module name</span></span>
<span class="line"><span>00007ff7`15a50000 00007ff7`15a6f000   MsMpEng    (deferred)             </span></span>
<span class="line"><span>00007ffe`52430000 00007ffe`5247d000   wscapi     (deferred)             </span></span>
<span class="line"><span>00007ffe`59090000 00007ffe`5a29f000   mpengine   (deferred)   </span></span>
<span class="line"><span></span></span>
<span class="line"><span>kd&gt; bp /p ffffb385a10d0080 mpengine!UfsScannerWrapper::ScanFile</span></span>
<span class="line"><span>kd&gt; g</span></span>
<span class="line"><span>Breakpoint 1 hit</span></span>
<span class="line"><span>mpengine!UfsScannerWrapper::ScanFile:</span></span>
<span class="line"><span>0033:00007ffe`5926fba0 48895c2408      mov     qword ptr [rsp+8],rbx         </span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p>Now, you can use <a href="https://github.com/bootleg/ret-sync">ret-sync</a> to synchronize the debugger’s position with a static analysis tool like IDA Pro. This allows stepping through decompiled code, which is very helpful: <img alt="" decoding="async" height="607" loading="lazy" src="https://labs.infoguard.ch/_astro/windbg_retsync.KzYTzMEb_Z2n9T2R.webp" width="1576"></p></section></section></section><section><h1 id="4-fuzzing">4. Fuzzing<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#4-fuzzing" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h1><section><h2 id="41-wtf-snapshot-position">4.1 WTF Snapshot Position<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#41-wtf-snapshot-position" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h2><p>The next step is to take a snapshot at a good position that primarily executes the interesting target code. Fortunately, public debug symbols for <code>Mpengine.dll</code> are typically released some days or weeks after a new version. However, this DLL is almost 20MB and it’s not easy to navigate. Therefore, I used ProcMon from Sysinternals to identify the code location where the target file is read. <img alt="" decoding="async" height="611" loading="lazy" src="https://labs.infoguard.ch/_astro/procmon.BH3jkcyn_Z1M5GxH.webp" width="1182"></p><p>The best position would be after the file content is loaded into memory and passed as an argument to a scan function, like so:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>res = readFile(path);</span></span>
<span class="line"><span>scanFile(res.content, res.size);  //Take snapshot on this line</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p>However, the actual code is not that straightforward. I decided to take the snapshot before the file is read and then inject the fuzzing payloads in a virtual implementation of <code>ReadFile</code> in WTF. The initial problem was, that the code called functions which accessed hardware such as the file system. This is not available in WTF as it only emulates memory and CPU. WTF already implements some virtual file system functions in <a href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fshooks.cc">fshooks.cc</a>, but additional ones needed to be added. At the end the snapshot was taken within <code>mpengine!SysIo::OpenFile</code> after a call to <code>FilterOplock::AcquireOplock</code> because this function was not implemented virtually.</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>__int64 __fastcall SysIo::OpenFile(</span></span>
<span class="line"><span>        SysIo *this,</span></span>
<span class="line"><span>        wchar_t *file_path,</span></span>
<span class="line"><span>        unsigned int a3,</span></span>
<span class="line"><span>        unsigned int access_flags,</span></span>
<span class="line"><span>        unsigned int share_mode,</span></span>
<span class="line"><span>        struct IFile **a6,</span></span>
<span class="line"><span>        struct IFile *a7)</span></span>
<span class="line"><span>[...]</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p><img alt="" decoding="async" height="435" loading="lazy" src="https://labs.infoguard.ch/_astro/snapshot_position_ida.8TFqpP6E_1LDWf5.webp" width="1060"></p><p class="figcaption">Snapshot position at mpengine+0x15469A (within SysIo::OpenFile)</p><p></p></section><section><h2 id="42-wtf-harness">4.2 WTF Harness<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#42-wtf-harness" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h2><p>Writing a harness for WTF (see <a href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_dummy.cc">dummy-template</a>) differs from typical fuzzers like AFL++, WinAFL, Jackalope, or LibFuzzer. Usually, the harness needs to set up the target and call the target function. For WTF, it typically only needs to inject the fuzzing payload and size at the correct memory location. In this case, however, the fuzzing payload needs to be provided to the <code>ReadFile</code> function.</p><p>The following code shows the cropped code:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="cpp" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span style="color:#f97583">bool</span><span style="color:#b392f0"> InsertTestcase</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">const</span><span style="color:#f97583"> uint8_t</span><span style="color:#f97583"> *</span><span style="color:#ffab70">Buffer</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">const</span><span style="color:#f97583"> size_t</span><span style="color:#ffab70"> BufferSize</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">  [...]</span></span>
<span class="line"><span style="color:#e1e4e8">  std::u16string GuestFile = uR"(\??\</span><span style="color:#b392f0">C</span><span style="color:#e1e4e8">:\</span><span style="color:#b392f0">Users</span><span style="color:#e1e4e8">\</span><span style="color:#b392f0">User</span><span style="color:#e1e4e8">\</span><span style="color:#b392f0">Downloads</span><span style="color:#e1e4e8">\</span><span style="color:#b392f0">test</span><span style="color:#e1e4e8">-</span><span style="color:#b392f0">files</span><span style="color:#e1e4e8">\</span><span style="color:#b392f0">aspack_Hash</span><span style="color:#e1e4e8">.</span><span style="color:#ffab70">exe</span><span style="color:#e1e4e8">)";</span></span>
<span class="line"><span style="color:#e1e4e8"></span></span>
<span class="line"><span style="color:#e1e4e8">  g_FsHandleTable.</span><span style="color:#b392f0">MapExistingGuestFile</span><span style="color:#e1e4e8">(GuestFile.</span><span style="color:#b392f0">c_str</span><span style="color:#e1e4e8">(), Buffer, BufferSize);</span></span>
<span class="line"><span style="color:#6a737d">  //g_FsHandleTable.AddHandle(HANDLE(0x97c), GuestFileFile); //Alternatively, if the file is already opened, it can be mapped to a handle.</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p>The debug print statements of the hooked file functions confirm that the file is opened and read correctly:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXScroll overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>PS &gt; .\wtf.exe run --name defender_file --input .\test --state .\state2_MpEngine1.1.2310_PHenabled_locked\ </span></span>
<span class="line"><span>Setting @fptw to 0xff'ff.</span></span>
<span class="line"><span>Initializing the debugger instance.. (this takes a bit of time)</span></span>
<span class="line"><span>Setting debug register status to zero.</span></span>
<span class="line"><span>Setting debug register status to zero.</span></span>
<span class="line"><span>DEBUG: 0</span></span>
<span class="line"><span>Could not set a breakpoint at hal!HalpPerfInterrupt.</span></span>
<span class="line"><span>Failed to set breakpoint on HalpPerfInterrupt, but ignoring..</span></span>
<span class="line"><span>Running .\test</span></span>
<span class="line"><span>fs: Mapping already existing guest file \??\C:\Users\User\Downloads\test-files\aspack_Hash.exe with filestream(16483)</span></span>
<span class="line"><span>fs: ntdll!NtCreateFile(FileHandle=0x9f0c8fc848, DesiredAccess=0x120089, ObjectAttributes=0x9f0c8fc880 (\??\C:\Users\User\Downloads\test-files\aspack_Hash.exe), IoStatusBlock=0x9f0c8fc870, AllocationSize=0x0, FileAttributes=0x0, ShareAccess=0x7 (FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE), CreateDisposition=0x1 (FILE_OPEN), CreateOptions=0x160 (FILE_NON_DIRECTORY_FILE | FILE_SYNCHRONOUS_IO_NONALERT | FILE_COMPLETE_IF_OPLOCKED), EaBuffer=0x0, EaLength=0x0)</span></span>
<span class="line"><span>fs: IsBlacklisted: false</span></span>
<span class="line"><span>fs: Exists: true</span></span>
<span class="line"><span>fs: Opening 0x7ffffffe for \??\C:\Users\User\Downloads\test-files\aspack_Hash.exe</span></span>
<span class="line"><span>fs: ntdll!NtQueryVolumeInformationFile(FileHandle=0x7ffffffe, IoStatusBlock=0x9f0c8fc9b0, FsInformation=0x9f0c8fc9e0, Length=0x8, FsInformationClass=0x4)</span></span>
<span class="line"><span>fs: ntdll!NtQueryInformationFile(FileHandle=0x7ffffffe, IoStatusBlock=0x9f0c8fc980, FileInformation=0x9f0c8fc990, Length=0x28, FileInformationClass=0x4)</span></span>
<span class="line"><span>fs: ntdll!NtQueryInformationFile(FileHandle=0x7ffffffe, IoStatusBlock=0x9f0c8fca20, FileInformation=0x9f0c8fca30, Length=0x18, FileInformationClass=0x5)</span></span>
<span class="line"><span>fs: ntdll!NtSetInformationFile(FileHandle=0x7ffffffe, IoStatusBlock=0x9f0c8fc848, FileInformation=0x9f0c8fc840, Length=0x8, FileInformationClass=0xe)</span></span>
<span class="line"><span>fs: nt!NtReadFile(FileHandle=0x7ffffffe, Event=0x0, ApcRoutine=0x0, ApcContext=0x0, IoStatusBlock=0x9f0c8fc870, Buffer=0x231017abfe0, Length=0x1000, ByteOffset=0x0, Key=0x0)</span></span>
<span class="line"><span>fs: ntdll!NtSetInformationFile(FileHandle=0x7ffffffe, IoStatusBlock=0x9f0c8fc838, FileInformation=0x9f0c8fc830, Length=0x8, FileInformationClass=0xe)</span></span>
<span class="line"><span>fs: nt!NtReadFile(FileHandle=0x7ffffffe, Event=0x0, ApcRoutine=0x0, ApcContext=0x0, IoStatusBlock=0x9f0c8fc860, Buffer=0x231017aefe0, Length=0x2000, ByteOffset=0x0, Key=0x0)</span></span>
<span class="line"><span>fs: ntdll!NtSetInformationFile(FileHandle=0x7ffffffe, IoStatusBlock=0x9f0c8f9de8, FileInformation=0x9f0c8f9de0, Length=0x8, FileInformationClass=0xe)</span></span>
<span class="line"><span>fs: nt!NtReadFile(FileHandle=0x7ffffffe, Event=0x0, ApcRoutine=0x0, ApcContext=0x0, IoStatusBlock=0x9f0c8f9e10, Buffer=0x231017acfe0, Length=0x4000, ByteOffset=0x0, Key=0x0)</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-visible os-scrollbar-cornerless" style="--os-viewport-percent: 0.5192; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p>In order to debug the fuzzing process, it is useful to set breakpoints in interesting functions to see if they are called:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="cpp" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span style="color:#f97583">bool</span><span style="color:#b392f0"> Init</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">const</span><span style="color:#79b8ff"> Options_t</span><span style="color:#f97583"> &amp;</span><span style="color:#ffab70">Opts</span><span style="color:#e1e4e8">, </span><span style="color:#f97583">const</span><span style="color:#79b8ff"> CpuState_t</span><span style="color:#f97583"> &amp;</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#f97583">  if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">g_Backend-&gt;</span><span style="color:#b392f0">SetBreakpoint</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"mpengine!UfsScannerWrapper::ScanFile"</span><span style="color:#e1e4e8">, [](</span><span style="color:#79b8ff">Backend_t</span><span style="color:#f97583"> *</span><span style="color:#ffab70">Backend</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#b392f0">        DebugPrint</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Called ScanFile()</span><span style="color:#79b8ff">\n</span><span style="color:#9ecbff">"</span><span style="color:#e1e4e8">);          </span></span>
<span class="line"><span style="color:#e1e4e8">      })) {</span></span>
<span class="line"><span style="color:#b392f0">    DebugPrint</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Failed to SetBreakpoint mpengine!UfsScannerWrapper::ScanFile</span><span style="color:#79b8ff">\n</span><span style="color:#9ecbff">"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">    return</span><span style="color:#79b8ff"> false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p>Additionally, the coverage output can be loaded in <a href="https://github.com/gaasedelen/lighthouse">Lighthouse</a> or <a href="https://github.com/gaasedelen/tenet">tenet-traces</a> can be created.</p><p>During tests with a small corpus, too many context switches (changes to the CR3 register) occurred. These negatively impact performance in snapshot fuzzers. Most could be resolved by skipping certain functions. For example, <code>mpengine!IsTrustedFile</code> attempted to load certificate files from disk to verify trust. Such functions can be skipped:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="cpp" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">g_Backend-&gt;</span><span style="color:#b392f0">SetBreakpoint</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"mpengine!IsTrustedFile"</span><span style="color:#e1e4e8">, [](</span><span style="color:#79b8ff">Backend_t</span><span style="color:#f97583"> *</span><span style="color:#ffab70">Backend</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#b392f0">        DebugPrint</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"mpengine!IsTrustedFile Hook SKIP 0x0"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">        Backend-&gt;</span><span style="color:#b392f0">SimulateReturnFromFunction</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">      })) {</span></span>
<span class="line"><span style="color:#b392f0">    DebugPrint</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"Failed to SetBreakpoint IsTrustedFile"</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">    return</span><span style="color:#79b8ff"> false</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p>The fuzzing speed with the BochsCPU backend was impractically slow, but using KVM, I achieved 30-100 exec/s on a modern server CPU depending on the file size and type. The target executes billions of instructions depending on the payload, so really high speeds cannot be expected. Even on a real system, some files can take multiple seconds to scan.</p></section><section><h2 id="43-initial-corpus">4.3 Initial Corpus<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#43-initial-corpus" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h2><p>A large and diverse corpus is essential for this target, as it parses numerous file types, including packed files that coverage-guided fuzzing alone might not effectively explore without good initial seeds. The files which are interesting for Defender are actual malware. And the perfect place to find a huge amout of malware is <a href="https://vx-underground.org/">VX-Underground</a>.</p><p>Seeding the initial corpus took multiple days, but it resulted in a good coverage increase, with over 10,000 files yielding distinct coverage.</p></section><section><h2 id="44-fuzzing-with-wtf">4.4 Fuzzing with WTF<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#44-fuzzing-with-wtf" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h2><p>Snapshots were taken with and without PageHeap enabled for <code>MsMpEng.exe</code>. As the target is rather slow and memory-heavy, the speed without PageHeap is significantly higher. Therefore, fuzzing was first run without PageHeap to explore coverage and subsequently with PageHeap to catch more bugs.</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>./wtf master --name defender_file --inputs inputs --runs 100000000  --max_len 100000 </span></span>
<span class="line"><span>Iterating through the corpus..</span></span>
<span class="line"><span>Sorting through the 219701 entries..</span></span>
<span class="line"><span>#8151 cov: 56117 (+56117) corp: 1503 (9.9kb) exec/s: 815.0 (23 nodes) lastcov: 0.0s crash: 0 timeout: 0 cr3: 0 uptime: 1.4min</span></span>
<span class="line"><span>#14182 cov: 67734 (+11617) corp: 2430 (31.4kb) exec/s: 709.0 (23 nodes) lastcov: 0.0s crash: 0 timeout: 0 cr3: 28 uptime: 1.6min</span></span>
<span class="line"><span>#19470 cov: 72835 (+5101) corp: 3103 (58.8kb) exec/s: 649.0 (23 nodes) lastcov: 0.0s crash: 0 timeout: 0 cr3: 47 uptime: 1.7min</span></span>
<span class="line"><span>#23475 cov: 79492 (+6657) corp: 3540 (85.0kb) exec/s: 586.0 (23 nodes) lastcov: 0.0s crash: 0 timeout: 0 cr3: 49 uptime: 1.9min</span></span>
<span class="line"><span>#25946 cov: 81771 (+2279) corp: 3774 (102.4kb) exec/s: 518.0 (23 nodes) lastcov: 0.0s crash: 0 timeout: 0 cr3: 56 uptime: 2.0min</span></span>
<span class="line"><span>#29398 cov: 85851 (+4080) corp: 4156 (136.9kb) exec/s: 489.0 (23 nodes) lastcov: 0.0s crash: 8 timeout: 0 cr3: 63 uptime: 2.2min</span></span>
<span class="line"><span>#33006 cov: 88877 (+3026) corp: 4487 (173.8kb) exec/s: 471.0 (23 nodes) lastcov: 0.0s crash: 9 timeout: 0 cr3: 66 uptime: 2.4min</span></span>
<span class="line"><span>#35472 cov: 92594 (+3717) corp: 4784 (213.7kb) exec/s: 443.0 (23 nodes) lastcov: 0.0s crash: 10 timeout: 0 cr3: 70 uptime: 2.5min</span></span>
<span class="line"><span>#37112 cov: 94070 (+1476) corp: 4950 (239.0kb) exec/s: 412.0 (23 nodes) lastcov: 0.0s crash: 10 timeout: 0 cr3: 71 uptime: 2.7min</span></span>
<span class="line"><span>#38765 cov: 94880 (+810) corp: 5103 (264.7kb) exec/s: 387.0 (23 nodes) lastcov: 0.0s crash: 10 timeout: 0 cr3: 71 uptime: 2.9min</span></span>
<span class="line"><span>#39673 cov: 95412 (+532) corp: 5186 (279.8kb) exec/s: 360.0 (23 nodes) lastcov: 0.0s crash: 10 timeout: 0 cr3: 71 uptime: 3.0min</span></span>
<span class="line"><span>#41523 cov: 96330 (+918) corp: 5304 (302.9kb) exec/s: 346.0 (23 nodes) lastcov: 0.0s crash: 10 timeout: 0 cr3: 78 uptime: 3.2min</span></span>
<span class="line"><span>#43117 cov: 97747 (+1417) corp: 5439 (331.6kb) exec/s: 331.0 (23 nodes) lastcov: 0.0s crash: 10 timeout: 0 cr3: 93 uptime: 3.4min</span></span>
<span class="line"><span>#45219 cov: 99233 (+1486) corp: 5572 (363.2kb) exec/s: 322.0 (23 nodes) lastcov: 0.0s crash: 10 timeout: 0 cr3: 94 uptime: 3.5min</span></span>
<span class="line"><span>#47520 cov: 100210 (+977) corp: 5736 (404.8kb) exec/s: 316.0 (23 nodes) lastcov: 0.0s crash: 10 timeout: 0 cr3: 94 uptime: 3.7min</span></span>
<span class="line"><span>#49300 cov: 101207 (+997) corp: 5890 (447.6kb) exec/s: 308.0 (23 nodes) lastcov: 0.0s crash: 10 timeout: 0 cr3: 95 uptime: 3.9min</span></span>
<span class="line"><span>#50935 cov: 102396 (+1189) corp: 6079 (502.5kb) exec/s: 299.0 (23 nodes) lastcov: 0.0s crash: 10 timeout: 0 cr3: 98 uptime: 4.0min</span></span>
<span class="line"><span>#51692 cov: 103436 (+1040) corp: 6155 (525.7kb) exec/s: 287.0 (23 nodes) lastcov: 0.0s crash: 10 timeout: 0 cr3: 99 uptime: 4.2min</span></span>
<span class="line"><span>#51910 cov: 103602 (+166) corp: 6167 (529.3kb) exec/s: 273.0 (23 nodes) lastcov: 0.0s crash: 10 timeout: 0 cr3: 99 uptime: 4.4min</span></span>
<span class="line"><span>#52149 cov: 103634 (+32) corp: 6178 (532.7kb) exec/s: 260.0 (23 nodes) lastcov: 0.0s crash: 10 timeout: 0 cr3: 100 uptime: 4.6min</span></span>
<span class="line"><span></span></span>
<span class="line"><span>./wtf fuzz --name defender_file  --state state2_MpEngine1.1.2310_PHenabled_locked --backend kvm</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p>This is a fuzzing run of the already processed seeds from VX-Underground. The speed drops as the input file size increases, consequently making scanning take longer.</p><p>The maximum coverage of <code>mpengine.dll</code> I achieved before the fuzzer stopped at the end of the function <code>mpengine!UfsScanFileCmd::Execute</code> was around <code>154,000</code> basic blocks.</p><p>The fuzzing results and analysis of the crashes are described in <a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#5-Results">Section 5. Results</a>.</p></section><section><h2 id="45-fuzzing-with-kaflnyx">4.5 Fuzzing with kAFL/NYX<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#45-fuzzing-with-kaflnyx" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h2><p>Since WTF, by default, includes relatively simple mutation strategies, I decided to use kAFL, which incorporates more advanced techniques like <a href="https://www.ndss-symposium.org/ndss-paper/redqueen-fuzzing-with-input-to-state-correspondence/">Redqueen</a>. This can help fuzz through complex <code>cmp</code> instructions that are unlikely to be passed accidentally. I hoped this would yield more coverage.</p><section><h3 id="harness">Harness<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#harness" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h3><p>As a harness I adapted <a href="https://github.com/taviso/loadlibrary/blob/master/mpclient.c">mpclient.c from loadlibrary</a>. Initially, I wanted to trigger a normal scan on the running system and then set hooks at the snapshotting position. However, there was no documentation on how to fuzz it by injecting and then triggering the kAFL interaction by using hooks. Recently, a new way of using NYX called <a href="https://github.com/neodyme-labs/hyperhook">Hyperhook</a> is available. Using Hyperhook, a classic harness to initialize and call the target code is not necessary, and Defender could potentially be fuzzed in its original environment more easily.</p><p>The code of the harness based on <code>mpclient.c</code> is on Github: <a href="https://github.com/ig-labs/Defender-mpengine-Fuzzing/blob/main/mpclient_defender_harness_kafl.c">mpclient_defender_harness_kafl.c</a></p><p>A version to test the harness without hypercalls is also available: <a href="https://github.com/ig-labs/Defender-mpengine-Fuzzing/blob/main/mpclient_defender_harness_withoutHypercalls.c">mpclient_defender_harness_withoutHypercalls.c</a></p><p>Initially, I used kAFL on a Hetzner server with an <code>Intel Xeon Gold 5412U</code> CPU, but this led to frequent <code>libxdc_decode</code> errors: <img alt="" decoding="async" height="500" loading="lazy" src="https://labs.infoguard.ch/_astro/kafl_decodeerror.CiMNFkwS_Z1S0KDX.webp" width="805"></p><p>These errors did not occur in a previous setup on an older laptop. As the kAFL maintainers had not encountered these errors on other targets, I tested different CPUs on AWS bare-metal systems. Intel Xeon CPUs from the 3rd generation and newer seem to cause these errors. On Intel Xeon 1st and 2nd generation CPUs, the problem did not manifest.</p><p>Another problem is a memory consumption issue described in this <a href="https://github.com/IntelLabs/kAFL/issues/271">GitHub Issue</a>. The QEMU instances consume progressively more memory and eventually die. Reducing the number of running instances (to provide more memory per core) and periodically restarting the fuzzing process (e.g., after several days) helped mitigate this.</p><p><img alt="" decoding="async" height="722" loading="lazy" src="https://labs.infoguard.ch/_astro/kafl_gui.RQKssl7W_2lDL0N.webp" width="975"></p><p>I used kAFL with Redqueen and Grimoire enabled and ran it for a month. It found some new coverage, but very little overall, and no new crashes. This was surprising, as I had expected better results from these advanced mutation techniques.</p></section></section><section><h2 id="46-fuzzing-with-jackalope">4.6 Fuzzing with Jackalope<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#46-fuzzing-with-jackalope" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h2><p>As I already had a harness to trigger a scan using <code>RSIG_SCAN_STREAMBUFFER</code> from the kAFL harness, I wanted to test Jackalope as I hadn’t used it before. However, Jackalope proved less suitable for this target because the initialization (loading <code>mpengine.dll</code>) is time-consuming, taking about 10 seconds per launch.</p><p>The code of the harness based on mpclient.c is on Github: <a href="https://github.com/ig-labs/Defender-mpengine-Fuzzing/blob/main/jackalope_defender_harness_stream.c">jackalope_defender_harness_stream.c</a></p><p>Initially, the initialization happened for every single run because Jackalope restarts on new coverage even if you use persistent fuzzing. Therefore, <code>-clean_target_on_coverage 0</code> is necessary.</p><p>However, the target still needed to reload frequently due to timeouts with some inputs. If the timeout was set low, the target reloaded frequently. If set high, it spent too much time on slow inputs. Additionally, many crashing files were already in the seeds, causing further reloads. Ultimately, it was too slow, making a snapshot fuzzer the better choice for mpengine.</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="powershell" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXScroll overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span style="color:#e1e4e8">PS C:\fuzzing\Jackalope\build\Release</span><span style="color:#f97583">&gt;</span><span style="color:#e1e4e8"> .\</span><span style="color:#79b8ff">fuzzer.exe</span><span style="color:#f97583"> -</span><span style="color:#e1e4e8">crash_retry </span><span style="color:#79b8ff">0</span><span style="color:#f97583"> -</span><span style="color:#e1e4e8">generate_unwind </span><span style="color:#f97583">-</span><span style="color:#e1e4e8">coverage_retry </span><span style="color:#79b8ff">0</span><span style="color:#f97583"> -</span><span style="color:#e1e4e8">clean_target_on_coverage </span><span style="color:#79b8ff">0</span><span style="color:#f97583"> -in</span><span style="color:#e1e4e8"> seeds </span><span style="color:#f97583">-</span><span style="color:#e1e4e8">out out </span><span style="color:#f97583">-</span><span style="color:#e1e4e8">t1 </span><span style="color:#79b8ff">100000</span><span style="color:#f97583"> -</span><span style="color:#e1e4e8">t </span><span style="color:#79b8ff">10000</span><span style="color:#f97583"> -</span><span style="color:#e1e4e8">delivery shmem </span><span style="color:#f97583">-</span><span style="color:#e1e4e8">instrument_module mpengine.dll </span><span style="color:#f97583">-</span><span style="color:#e1e4e8">target_module </span><span style="color:#79b8ff">jackalope_defender_harness_stream.exe</span><span style="color:#f97583"> -</span><span style="color:#e1e4e8">target_method scanFile </span><span style="color:#f97583">-</span><span style="color:#e1e4e8">nargs </span><span style="color:#79b8ff">0</span><span style="color:#f97583"> -</span><span style="color:#e1e4e8">iterations </span><span style="color:#79b8ff">1000</span><span style="color:#f97583"> -</span><span style="color:#e1e4e8">persist </span><span style="color:#f97583">-</span><span style="color:#e1e4e8">loop </span><span style="color:#f97583">-</span><span style="color:#e1e4e8">nthreads </span><span style="color:#79b8ff">1</span><span style="color:#f97583"> --</span><span style="color:#79b8ff"> jackalope_defender_harness_stream.exe</span><span style="color:#9ecbff"> "@@"</span></span>
<span class="line"><span style="color:#e1e4e8">Fuzzer version </span><span style="color:#79b8ff">1.00</span></span>
<span class="line"><span style="color:#79b8ff">156019</span><span style="color:#e1e4e8"> input files read</span></span>
<span class="line"><span style="color:#e1e4e8">Running input sample seeds\000132616d55e4bd0866cb5ed828dc88</span></span>
<span class="line"><span style="color:#e1e4e8">setup shared mem shm_fuzz_31364_1</span></span>
<span class="line"><span style="color:#e1e4e8">[</span><span style="color:#f97583">+</span><span style="color:#e1e4e8">] Starting..</span><span style="color:#f97583">.</span><span style="color:#79b8ff"> jackalope_defender_harness_stream.exe</span></span>
<span class="line"><span style="color:#e1e4e8">[</span><span style="color:#f97583">+++++++</span><span style="color:#e1e4e8">] NEW START</span><span style="color:#f97583">!</span></span>
<span class="line"><span style="color:#e1e4e8">laoded dll</span></span>
<span class="line"><span style="color:#e1e4e8">got rsignal addr 5fc0e2e0</span></span>
<span class="line"><span style="color:#e1e4e8">size BootParams: 1b8</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">Total execs: </span><span style="color:#79b8ff">1</span></span>
<span class="line"><span style="color:#e1e4e8">Unique samples: </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> discarded)</span></span>
<span class="line"><span style="color:#e1e4e8">Crashes: </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> unique)</span></span>
<span class="line"><span style="color:#e1e4e8">Hangs: </span><span style="color:#79b8ff">0</span></span>
<span class="line"><span style="color:#e1e4e8">Offsets: </span><span style="color:#79b8ff">0</span></span>
<span class="line"><span style="color:#e1e4e8">Execs</span><span style="color:#f97583">/</span><span style="color:#e1e4e8">s: </span><span style="color:#79b8ff">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e1e4e8">Total execs: </span><span style="color:#79b8ff">1</span></span>
<span class="line"><span style="color:#e1e4e8">Unique samples: </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> discarded)</span></span>
<span class="line"><span style="color:#e1e4e8">Crashes: </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> (</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8"> unique)</span></span>
<span class="line"><span style="color:#e1e4e8">Hangs: </span><span style="color:#79b8ff">0</span></span>
<span class="line"><span style="color:#e1e4e8">Offsets: </span><span style="color:#79b8ff">0</span></span>
<span class="line"><span style="color:#e1e4e8">Execs</span><span style="color:#f97583">/</span><span style="color:#e1e4e8">s: </span><span style="color:#79b8ff">0</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-visible os-scrollbar-cornerless" style="--os-viewport-percent: 0.6224; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div></section></section><section><h1 id="5-results">5. Results<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#5-results" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h1><p>The fuzzing was performed on an older version of mpengine.dll (<code>1.1.23100.2009</code>) as I had started reversing it some time ago and continued fuzzing later. However, most crashes could be reproduced on the new version <code>1.1.25040.1</code> from April 2025. Crash1 was likely fixed as Crash1 and Crash2 were reported to MSRC but both “did not meet MSRC’s bar for immediate servicing”. Crash5 and Crash6 no longer trigger a crash in the latest version; I did not verify if the underlying issue was fixed or if other code changes merely altered the path.</p><p>To reproduce these crashes, enable full PageHeap for <code>MsMpEng.exe</code>. This can be done by booting Windows in Safe Mode, making the change, and then restarting. Otherwise, access is blocked. The files are available <a href="https://github.com/ig-labs/defender-mpengine-fuzzing/tree/main/crashes">here</a>.</p><p>Here is a list of the identified bugs (note: <code>mpengine.dll</code> base address was <code>0x7ffcdbab0000</code>):</p><section><h3 id="crash1-exception_access_violation_read-0x7ffcdc670b03">crash1-EXCEPTION_ACCESS_VIOLATION_READ-0x7ffcdc670b03<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#crash1-exception_access_violation_read-0x7ffcdc670b03" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h3><p>Crashes without PageHeap in most attempts. It was likely fixed in an unknown version after being reported to MSRC. This is the only bug which triggerd in a real environment but not with the harness using <code>RSIG_SCAN_STREAMBUFFER</code>.</p><p>File type: <code>Java archive data (JAR)</code></p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>mpengine!strncmp+0x13</span></span>
<span class="line"><span>mpengine!RpfAPI_strncmp+0xa3</span></span>
<span class="line"><span>mpengine!netvm_method_call+0x1b2</span></span>
<span class="line"><span>mpengine!netvm_emulate+0x758</span></span>
<span class="line"><span>mpengine!netvm_parse_routine+0x37e</span></span>
<span class="line"><span>mpengine!netvm_method_call+0x9b</span></span>
<span class="line"><span>mpengine!netvm_emulate+0x758</span></span>
<span class="line"><span>mpengine!netvm_parse_routine+0x37e</span></span>
<span class="line"><span>mpengine!netvm_loadmodule2+0x3ad</span></span>
<span class="line"><span>mpengine!rpf_pInvoke+0x235</span></span>
<span class="line"><span>mpengine!scan_rpf+0x6c</span></span>
<span class="line"><span>mpengine!kcrce_scanfilelast+0x42</span></span>
<span class="line"><span>mpengine!UfsScannerWrapper::ScanFile+0x9f</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p><img alt="" decoding="async" height="333" loading="lazy" src="https://labs.infoguard.ch/_astro/crash1_windbg.DgnVxX1n_2llswU.webp" width="1706"></p></section><section><h3 id="crash2-exception_access_violation_read-0x7ffcdbba5fdf">crash2-EXCEPTION_ACCESS_VIOLATION_READ-0x7ffcdbba5fdf<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#crash2-exception_access_violation_read-0x7ffcdbba5fdf" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h3><p>Null Pointer Dereference. Reliably crashes Defender.</p><p>File type: <code>unknown</code></p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>mpengine!FilteredTrie&lt;unsigned long,FilteredTrieSerializer&lt;unsigned long&gt;,1&gt;::match+0x603</span></span>
<span class="line"><span>mpengine!hstr_internal_search_worker+0x108</span></span>
<span class="line"><span>mpengine!hstr_internal_search+0x7e</span></span>
<span class="line"><span>mpengine!DmgScanner::Scan+0x682</span></span>
<span class="line"><span>mpengine!dmg_scanfile+0x63</span></span>
<span class="line"><span>mpengine!UfsScannerWrapper::ScanFile+0x9f</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p><img alt="" decoding="async" height="136" loading="lazy" src="https://labs.infoguard.ch/_astro/crash2_windbg.DiGuj8Tt_G7T8u.webp" width="795"></p></section><section><h3 id="crash3-exception_access_violation_read-0x7ffcdc0a4acb">crash3-EXCEPTION_ACCESS_VIOLATION_READ-0x7ffcdc0a4acb<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#crash3-exception_access_violation_read-0x7ffcdc0a4acb" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h3><p>OOB Read of 4 bytes (reserved but unallocated memory). Only crashes with PageHeap.</p><p>File type: <code>PE32 executable (GUI) Intel 80386, for MS Windows, 3 sections</code></p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>mpengine!memcpy_repmovs+0xb 05f4acb</span></span>
<span class="line"><span>mpengine!CachedFile::InternalWrite+0x376  002f6266</span></span>
<span class="line"><span>mpengine!CachedFile::Write+0x3c 002f5edc</span></span>
<span class="line"><span>mpengine!vfo_write+0x92 00163822</span></span>
<span class="line"><span>mpengine!RpfAPI_vfo_write+0x5a  08b2c1a</span></span>
<span class="line"><span>mpengine!netvm_method_call+0x1b2  08b5ad6</span></span>
<span class="line"><span>mpengine!netvm_emulate+0x758  0010d468</span></span>
<span class="line"><span>mpengine!netvm_parse_routine+0x37e</span></span>
<span class="line"><span>mpengine!netvm_method_call+0x9b</span></span>
<span class="line"><span>mpengine!netvm_emulate+0x758</span></span>
<span class="line"><span>mpengine!netvm_parse_routine+0x37e</span></span>
<span class="line"><span>mpengine!netvm_loadmodule2+0x3ad</span></span>
<span class="line"><span>mpengine!rpf_pInvoke+0x235</span></span>
<span class="line"><span>mpengine!rpf_pInvoke_PE+0x5d</span></span>
<span class="line"><span>mpengine!pefile_call_breakpoint_handlers+0x93</span></span>
<span class="line"><span>mpengine!kvscanpage4sig+0x150</span></span>
<span class="line"><span>mpengine!scan_PE_context::jmp_scan+0xfc</span></span>
<span class="line"><span>mpengine!BasicBlocksInfo::scan_BB+0x71</span></span>
<span class="line"><span>mpengine!DTscan_worker&lt;0&gt;+0x22f</span></span>
<span class="line"><span>mpengine!DTscan+0x117</span></span>
<span class="line"><span>mpengine!scan_pe_dtscan_slice+0x9c</span></span>
<span class="line"><span>mpengine!scan_pe_dtscan+0xff</span></span>
<span class="line"><span>mpengine!scan_pe_redtscan+0x167</span></span>
<span class="line"><span>mpengine!pefile_scan_mp+0x2105</span></span>
<span class="line"><span>mpengine!UfsScannerWrapper::ScanFile+0x52</span></span>
<span class="line"><span></span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p><img alt="" decoding="async" height="386" loading="lazy" src="https://labs.infoguard.ch/_astro/crash3_windbg.Cnab7Pn-_E79v3.webp" width="1657"></p></section><section><h3 id="crash4-exception_access_violation_read-0x7ffcdbb6e1e7">crash4-EXCEPTION_ACCESS_VIOLATION_READ-0x7ffcdbb6e1e7<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#crash4-exception_access_violation_read-0x7ffcdbb6e1e7" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h3><p>OOB Read on finding executable in a virtual file system. Only crashes with PageHeap.</p><p>File type: <code>JavaScript?</code></p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>mpengine!MpSuppFindExecutable+0x5f</span></span>
<span class="line"><span>mpengine!MpSuppCreate+0x26f</span></span>
<span class="line"><span>mpengine!PreCreateProcess+0x9b</span></span>
<span class="line"><span>mpengine!pe_create_process+0x117</span></span>
<span class="line"><span>mpengine!KERNEL32_DLL_WinExec+0xf3</span></span>
<span class="line"><span>mpengine!__call_api_by_crc+0x1c4</span></span>
<span class="line"><span>mpengine!x32_parseint+0x71</span></span>
<span class="line"><span>mpengine!BasicBlocksInfo::safe_execute+0x53</span></span>
<span class="line"><span>mpengine!IL_2_exe&lt;0&gt;+0x8a3</span></span>
<span class="line"><span>mpengine!DTscan_worker&lt;0&gt;+0xcfb</span></span>
<span class="line"><span>mpengine!DTscan+0x117</span></span>
<span class="line"><span>mpengine!scan_pe_dtscan_slice+0x9c</span></span>
<span class="line"><span>mpengine!scan_pe_dtscan+0xff</span></span>
<span class="line"><span>mpengine!pefile_scan_mp+0x2105</span></span>
<span class="line"><span>mpengine!UfsScannerWrapper::ScanFile+0x52</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p><img alt="" decoding="async" height="203" loading="lazy" src="https://labs.infoguard.ch/_astro/crash4_windbg.n48387rX_ZzRU5.webp" width="1370"></p><p><img alt="" decoding="async" height="237" loading="lazy" src="https://labs.infoguard.ch/_astro/crash4_ida.DJSsiAZ7_11aJ0G.webp" width="1146"></p></section><section><h3 id="crash5-exception_access_violation_read-0x7ffcdc3d3b22">crash5-EXCEPTION_ACCESS_VIOLATION_READ-0x7ffcdc3d3b22<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#crash5-exception_access_violation_read-0x7ffcdc3d3b22" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h3><p>Interestingly, Defender scans and emulates Mach-O files on Windows. This OOB read initially seemed promising, as a size variable could potentially be influenced if the memory layout is controllable. However, it could not be turned into an OOB write. Only crashes with PageHeap.</p><p>File type: <code>Mach-O 64-bit x86_64 dynamically linked shared library, flags:&lt;NOUNDEFS|DYLDLINK|TWOLEVEL&gt;</code></p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>mpengine!macho_lua_api_GetSegment+0x102</span></span>
<span class="line"><span>mpengine!luaD_precall+0x205</span></span>
<span class="line"><span>mpengine!luaV_execute+0x407</span></span>
<span class="line"><span>mpengine!luaD_call+0x35</span></span>
<span class="line"><span>mpengine!luaD_rawrunprotected+0x5b</span></span>
<span class="line"><span>mpengine!ExecuteLuaScript+0x20e</span></span>
<span class="line"><span>mpengine!ValidateSignatureWithPcodeWorker2+0x1d9</span></span>
<span class="line"><span>mpengine!ValidateSignatureWithPcode+0x23</span></span>
<span class="line"><span>mpengine!CHSTRMatchHelper::ProcMatchLevel+0xab</span></span>
<span class="line"><span>mpengine!hstr_internal_report_match_worker+0x2c5</span></span>
<span class="line"><span>mpengine!hstr_internal_report_match+0x44</span></span>
<span class="line"><span>mpengine!MachoParser::Scan+0x1e63</span></span>
<span class="line"><span>mpengine!macho_scanfile+0x71</span></span>
<span class="line"><span>mpengine!UfsScannerWrapper::ScanFile+0x9f</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p><img alt="" decoding="async" height="378" loading="lazy" src="https://labs.infoguard.ch/_astro/crash5_windbg.CNb_dbK4_Ze0f3B.webp" width="1466"> <img alt="" decoding="async" height="496" loading="lazy" src="https://labs.infoguard.ch/_astro/crash5_ida.Cg5oqiyZ_1QAN8k.webp" width="1515"></p></section><section><h3 id="crash6-exception_access_violation_read-0x7ffcf36b3c29">crash6-EXCEPTION_ACCESS_VIOLATION_READ-0x7ffcf36b3c29<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#crash6-exception_access_violation_read-0x7ffcf36b3c29" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h3><p>OOB read in an encrypted Office document. This specific file only crashes with PageHeap but it can be adapted to crash without PageHeap.</p><p>File type: <code>Composite Document File V2 Document</code></p><p>This crashes because of a wrong <code>saltSize</code> value:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>00000b20  44 61 74 61 20 73 61 6c  74 53 69 7a 65 3d 22 31  |Data saltSize="1|</span></span>
<span class="line"><span>00000ba0  68 6d 3d 22 53 48 41 32  35 36 22 20 73 61 6c 74  |hm="SHA256" salt|</span></span>
<span class="line"><span>00000d40  30 22 20 73 61 6c 74 53  69 7a 65 3d 22 31 37 22  |0" saltSize="17"|</span></span>
<span class="line"><span>00000dc0  3d 22 53 48 41 35 31 32  22 20 73 61 6c 74 56 61  |="SHA512" saltVa|</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>ntdll!memcpy+0x29</span></span>
<span class="line"><span>bcryptPrimitives+0x5ad7</span></span>
<span class="line"><span>bcryptPrimitives+0x3f85</span></span>
<span class="line"><span>bcrypt!BCryptHashData+0x77</span></span>
<span class="line"><span>rsaenh!CPHashData+0xbb</span></span>
<span class="line"><span>CRYPTSP!CryptHashData+0x94</span></span>
<span class="line"><span>mpengine!OfficeEcma376AgileDecryptor::HashHelper+0x71</span></span>
<span class="line"><span>mpengine!OfficeEcma376AgileDecryptor::CheckPassword+0x20b</span></span>
<span class="line"><span>mpengine!DecryptWithPassword+0x26</span></span>
<span class="line"><span>mpengine!DecryptWorker+0x48</span></span>
<span class="line"><span>mpengine!TryDecryptDocument+0x1ab</span></span>
<span class="line"><span>mpengine!RME::Scan+0x137</span></span>
<span class="line"><span>mpengine!macro_scan+0x8c</span></span>
<span class="line"><span>mpengine!UfsScannerWrapper::ScanFile+0x9f</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p><img alt="" decoding="async" height="322" loading="lazy" src="https://labs.infoguard.ch/_astro/crash6_windbg.BX8V5Anm_ZcCewU.webp" width="1385"></p></section><section><h3 id="crash8-exception_access_violation_read-0x7ffcdc0a517f">crash8-EXCEPTION_ACCESS_VIOLATION_READ-0x7ffcdc0a517f<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#crash8-exception_access_violation_read-0x7ffcdc0a517f" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h3><p>An OOB read while searching for a character in a string. Only crashes with PageHeap.</p><p>File type: <code>Unicode text, UTF-16, little-endian text</code>. This is a very small file:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>00000000  ff fe 23 00 53 00 74 00  72 00 65 00 61 00 6d 00  |..#.S.t.r.e.a.m.|</span></span>
<span class="line"><span>00000010  20 00 43 00 6f 00 6e 00  74 00 61 00 69 00 6e 00  | .C.o.n.t.a.i.n.|</span></span>
<span class="line"><span>00000020  65 00 72 00 20 00 46 00  69 00 6c 00 65 00 0a 00  |e.r. .F.i.l.e...|</span></span>
<span class="line"><span>00000030  74 00 61 00 69 00 6e 00  65 00 72 00 20 00 46 00  |t.a.i.n.e.r. .F.|</span></span>
<span class="line"><span>00000040  69 00 6c 00 00 6e 00 74  00 61 00 69 00 6e 00 65  |i.l..n.t.a.i.n.e|</span></span>
<span class="line"><span>00000050  00 72 00 20 00 46 00 69  00 6c 00 65 00 0a 75 72  |.r. .F.i.l.e..ur|</span></span>
<span class="line"><span>00000060  6f 3d 2e 63 6d                                    |o=.cm|</span></span>
<span class="line"><span>00000065</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>mpengine!wcschr+0x27</span></span>
<span class="line"><span>mpengine!nUFSP_replayablecontainer::FindNext+0xe0</span></span>
<span class="line"><span>mpengine!UfsFindData::FindFirstUsingPlugin+0xe4</span></span>
<span class="line"><span>mpengine!UfsFindData::FindFirst+0xd0</span></span>
<span class="line"><span>mpengine!UfsClientRequest::FindNextInNode+0x270</span></span>
<span class="line"><span>mpengine!UfsNodeFinder::FindFirst+0xd3</span></span>
<span class="line"><span>mpengine!UfsClientRequest::AnalyzeNode+0x8e</span></span>
<span class="line"><span>mpengine!UfsClientRequest::AnalyzeLeaf+0x18c</span></span>
<span class="line"><span>mpengine!UfsClientRequest::AnalyzePath+0x24f</span></span>
<span class="line"><span>mpengine!UfsCmdBase::ExecuteCmd&lt;&lt;lambda_63254cfa82a2be95f0c1106eef9d5b22&gt; &gt;+0x11c</span></span>
<span class="line"><span>mpengine!UfsScanFileCmd::Execute+0x50</span></span>
<span class="line"><span>mpengine!ksignal+0x5f1</span></span>
<span class="line"><span>mpengine!EngineProcessFile+0x219</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p><img alt="" decoding="async" height="386" loading="lazy" src="https://labs.infoguard.ch/_astro/crash8_windbg.D_obHFYl_Z11JXAo.webp" width="1660"></p></section><section><h2 id="51-example-pocs">5.1 Example POCs<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#51-example-pocs" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h2><p>Crash Defender by clicking a link that triggers a “PDF” download. This could be used in combination with an initial access payload: <img alt="" decoding="async" height="1052" loading="lazy" src="https://labs.infoguard.ch/_astro/crash2_web_link.CSfog9Dm_1jJ0DT.webp" width="1708"></p><p>Crash Defender by uploading a file via SMB before dumping credentials: <img alt="" decoding="async" height="1190" loading="lazy" src="https://labs.infoguard.ch/_astro/Defender_crash2_samdump1.BC5A9hPV_Za4zQ1.webp" width="3090"></p></section></section><section><h1 id="6-conclusion">6. Conclusion<a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#6-conclusion" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h1><p>The initial assumption that <code>mpengine.dll</code> is an interesting fuzzing target proved correct. Nine memory-related bugs were identified that led to a denial of service. While this specific research did not uncover RCEs, the methodology could have potentially revealed exploitable bugs. Nevertheless, attackers can leverage such denial-of-service vulnerabilities to crash Defender before executing subsequent malicious actions (see <a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#51-example-pocs">5.1 Example POCs</a>).</p><p>Depending on the specific scenario, some of the identified crashes have a CVSS v4.0 score of approximately 6.8/10 (e.g., <code>CVSS:4.0/AV:L/AC:L/AT:N/PR:N/UI:P/VC:N/VI:N/VA:H/SC:N/SI:N/SA:N</code> for a downloaded file). However, for some mail clients, Defender can also be configured to scan files automatically which would lead to a remote attack without user interaction.</p><p>Given that these vulnerabilities can be easily exploited to repeatedly crash Defender’s main process, we believe these issues warrant addressing by Microsoft. During our tests, no corresponding alerts were observed in the security dashboard following these crashes or subsequent malicious actions.</p></section></div><div class="transition onload-animation bg-[var(--license-block-bg)] license-container mb-6 overflow-hidden px-6 py-5 relative rounded-xl"><div class="transition font-bold dark:text-white/75 text-black/75">Attacking EDRs Part 4: Fuzzing Defender's Scanning and Emulation Engine (mpengine.dll)</div><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/" class="text-[var(--primary)] link">https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/</a><div class="flex gap-6 mt-2"><div><div class="transition text-sm dark:text-white/30 text-black/30">Author</div><div class="transition dark:text-white/75 text-black/75 whitespace-nowrap">Manuel Feifel</div></div><div><div class="transition text-sm dark:text-white/30 text-black/30">Published at</div><div class="transition dark:text-white/75 text-black/75 whitespace-nowrap">2025-05-23</div></div><div><div class="transition text-sm dark:text-white/30 text-black/30">License</div><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="text-[var(--primary)] link whitespace-nowrap" target="_blank">CC BY-NC-SA 4.0</a></div></div><svg height="1em" width="0.97em" class="transition absolute -translate-y-1/2 dark:text-white/5 pointer-events-none right-6 text-[15rem] text-black/5 top-1/2" data-icon="fa6-brands:creative-commons"><symbol id="ai:fa6-brands:creative-commons" viewBox="0 0 496 512"><path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86m143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86M247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248m.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82" fill="currentColor"></path></symbol><use href="#ai:fa6-brands:creative-commons"></use></svg></div></div></div><div class="flex w-full flex-col gap-4 mb-4 justify-between md:flex-row overflow-hidden"><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#" class="overflow-hidden w-full active:scale-95 font-bold pointer-events-none"></a> <a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#" class="overflow-hidden w-full active:scale-95 font-bold pointer-events-none"></a></div></div></main></div><div class="hidden lg:block back-to-top-wrapper" data-astro-cid-eymb5ayk=""><div class="transition flex items-center rounded-2xl back-to-top-btn hide overflow-hidden" id="back-to-top-btn" data-astro-cid-eymb5ayk=""><button class="btn-card h-[3.75rem] w-[3.75rem]" aria-label="Back to Top" data-astro-cid-eymb5ayk=""><svg height="1em" width="1em" class="mx-auto" data-icon="material-symbols:keyboard-arrow-up-rounded" data-astro-cid-eymb5ayk="true"><symbol id="ai:material-symbols:keyboard-arrow-up-rounded" viewBox="0 0 24 24"><path d="m12 10.8l-3.9 3.9q-.275.275-.7.275t-.7-.275t-.275-.7t.275-.7l4.6-4.6q.3-.3.7-.3t.7.3l4.6 4.6q.275.275.275.7t-.275.7t-.7.275t-.7-.275z" fill="currentColor"></path></symbol><use href="#ai:material-symbols:keyboard-arrow-up-rounded"></use></svg></button></div></div></div></div><div class="absolute hidden 2xl:block w-full z-0"><div class="mx-auto max-w-[var(--page-width)] relative"><div class="transition flex items-center -right-[var(--toc-width)] absolute hidden lg:block top-0 w-[var(--toc-width)]" id="toc-wrapper"><div class="h-[calc(100vh_-_20rem)] fixed hide-scrollbar overflow-x-hidden overflow-y-scroll top-14 w-[var(--toc-width)]" id="toc-inner-wrapper"><div class="transition-swup-fade h-full w-full" id="toc"><div class="h-8 w-full"></div><table-of-contents class="group"><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#1-introduction" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 bg-[var(--toc-badge-bg)] text-[var(--btn-content)]">1</div><div class="transition text-sm text-50">1. Introduction</div></a><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#2-summary" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 bg-[var(--toc-badge-bg)] text-[var(--btn-content)]">2</div><div class="transition text-sm text-50">2. Summary</div></a><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#3-how-to-fuzz-mpenginedll" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 bg-[var(--toc-badge-bg)] text-[var(--btn-content)]">3</div><div class="transition text-sm text-50">3. How to fuzz mpengine.dll?</div></a><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#31-debugging-defender" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 ml-4"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">3.1 Debugging Defender</div></a><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#4-fuzzing" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 bg-[var(--toc-badge-bg)] text-[var(--btn-content)]">4</div><div class="transition text-sm text-50">4. Fuzzing</div></a><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#41-wtf-snapshot-position" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 ml-4"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">4.1 WTF Snapshot Position</div></a><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#42-wtf-harness" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 ml-4"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">4.2 WTF Harness</div></a><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#43-initial-corpus" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 ml-4"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">4.3 Initial Corpus</div></a><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#44-fuzzing-with-wtf" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 ml-4"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">4.4 Fuzzing with WTF</div></a><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#45-fuzzing-with-kaflnyx" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 ml-4"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">4.5 Fuzzing with kAFL/NYX</div></a><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#46-fuzzing-with-jackalope" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 ml-4"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">4.6 Fuzzing with Jackalope</div></a><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#5-results" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 bg-[var(--toc-badge-bg)] text-[var(--btn-content)]">5</div><div class="transition text-sm text-50">5. Results</div></a><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#51-example-pocs" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 ml-4"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">5.1 Example POCs</div></a><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine/#6-conclusion" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 bg-[var(--toc-badge-bg)] text-[var(--btn-content)]">6</div><div class="transition text-sm text-50">6. Conclusion</div></a><div class="absolute left-0 right-0 -z-10 bg-[var(--toc-btn-hover)] border-2 border-[var(--toc-btn-hover)] border-dashed group-hover:bg-transparent group-hover:border-[var(--toc-btn-active)] rounded-xl transition-all" id="active-indicator"></div></table-of-contents><div class="h-8 w-full"></div></div></div></div><!-- #toc needs to exist for Swup to work normally --></div></div><div class="hidden h-[300vh]" id="page-height-extend" style="--bannerOffset:15vh;--banner-height-home:65vh;--banner-height:35vh;--configHue:235;--page-width:75rem" data-astro-cid-sckkx6r4=""></div><!-- Cloudflare Pages Analytics --><!-- Cloudflare Pages Analytics --><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-auto py-1 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-visible os-scrollbar-cornerless" style="--os-viewport-percent: 0.6198; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-auto py-1 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></body></html>