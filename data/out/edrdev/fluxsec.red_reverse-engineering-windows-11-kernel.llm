Title:
Reverse engineering undocumented Windows Kernel features to work with the EDR

Type:
Blog Post

Short Summary (4–8 sentences max):
This post reverse engineers Windows 11 24H2 kernel internals to understand why an ETW Threat Intelligence (ETW:TI) consumer wasn’t receiving the expected “remote process memory write” signal. It traces the user-mode `WriteProcessMemory` path into `NtWriteVirtualMemory` and the undocumented `MiReadWriteVirtualMemory`, identifying the gating logic that decides whether `EtwTiLogReadWriteVm` is called. The author finds the key dependency is `PsIsProcessLoggingEnabled`, which checks per-process EPROCESS flags (`EnableReadVmLogging` / `EnableWriteVmLogging`) at a specific offset before emitting ETW:TI telemetry. They validate this via kernel debugging (breakpoints, register/structure inspection) and then enable the required flags using `ZwSetInformationProcess` with `PROCESS_READWRITEVM_LOGGING_INFORMATION` (ProcessInformationClass 87). The result is reliable generation of the ETW:TI `WRITEVM_REMOTE` event, with code referenced in the Sanctum project. Useful for red teamers and security researchers building telemetry-aware tooling, and for defenders wanting to understand when/why ETW:TI signals may be absent.

Technical Focus:
- ETW Threat Intelligence provider (ETW:TI) and kernel telemetry gating
- Reverse engineering `ntoskrnl.exe` (Windows 11 24H2) with disassemblers
- Undocumented kernel routines (`MiReadWriteVirtualMemory`, `EtwTiLogReadWriteVm`)
- EPROCESS/KPROCESS/KTHREAD/KPCR structure navigation via GS segment
- Kernel debugging with WinDbg (breakpoints, bitfield inspection)
- Enabling process logging via `ZwSetInformationProcess` / `PROCESS_INFORMATION_CLASS`

Use Cases:
- Diagnose missing ETW:TI remote memory write events in custom sensors/consumers
- Build red-team tooling that anticipates/controls kernel telemetry generation
- Validate EDR detections tied to `WriteProcessMemory`/remote VM operations
- Research undocumented Windows kernel behavior changes across versions
- Develop defensive detections that account for per-process logging flags

Keywords:
Windows 11 24H2, ntoskrnl.exe, reverse engineering, Binary Ninja, WinDbg, ETW, ETW Threat Intelligence, ETW:TI, NtWriteVirtualMemory, WriteProcessMemory, MiReadWriteVirtualMemory, PsIsProcessLoggingEnabled, EtwTiLogReadWriteVm, EPROCESS, KPROCESS, KTHREAD, KPCR, GS segment, ZwSetInformationProcess, NtSetInformationProcess, PROCESS_READWRITEVM_LOGGING_INFORMATION, ProcessInformationClass 87, PreviousMode, kernel debugging, Sanctum, remote process memory write, WRITEVM_REMOTE, ObReferenceObjectByHandleWithTag