# https://github.com/pathtofile/SealighterTI

[Skip to content](https://github.com/pathtofile/SealighterTI#start-of-content)

You signed in with another tab or window. [Reload](https://github.com/pathtofile/SealighterTI) to refresh your session.You signed out in another tab or window. [Reload](https://github.com/pathtofile/SealighterTI) to refresh your session.You switched accounts on another tab or window. [Reload](https://github.com/pathtofile/SealighterTI) to refresh your session.Dismiss alert

{{ message }}

[pathtofile](https://github.com/pathtofile)/ **[SealighterTI](https://github.com/pathtofile/SealighterTI)** Public

- [Notifications](https://github.com/login?return_to=%2Fpathtofile%2FSealighterTI) You must be signed in to change notification settings
- [Fork\\
32](https://github.com/login?return_to=%2Fpathtofile%2FSealighterTI)
- [Star\\
197](https://github.com/login?return_to=%2Fpathtofile%2FSealighterTI)


Combining Sealighter with unpatched exploits to run the Threat-Intelligence ETW Provider


[197\\
stars](https://github.com/pathtofile/SealighterTI/stargazers) [32\\
forks](https://github.com/pathtofile/SealighterTI/forks) [Branches](https://github.com/pathtofile/SealighterTI/branches) [Tags](https://github.com/pathtofile/SealighterTI/tags) [Activity](https://github.com/pathtofile/SealighterTI/activity)

[Star](https://github.com/login?return_to=%2Fpathtofile%2FSealighterTI)

[Notifications](https://github.com/login?return_to=%2Fpathtofile%2FSealighterTI) You must be signed in to change notification settings

# pathtofile/SealighterTI

master

[**1** Branch](https://github.com/pathtofile/SealighterTI/branches) [**4** Tags](https://github.com/pathtofile/SealighterTI/tags)

[Go to Branches page](https://github.com/pathtofile/SealighterTI/branches)[Go to Tags page](https://github.com/pathtofile/SealighterTI/tags)

Go to file

Code

Open more actions menu

## Folders and files

| Name | Name | Last commit message | Last commit date |
| --- | --- | --- | --- |
| ## Latest commit<br>[![pathtofile](https://avatars.githubusercontent.com/u/47049312?v=4&size=40)](https://github.com/pathtofile)[pathtofile](https://github.com/pathtofile/SealighterTI/commits?author=pathtofile)<br>[Update README.md](https://github.com/pathtofile/SealighterTI/commit/5851de2ee800073819d8b08ab4bb428f7feca580)<br>4 years agoDec 6, 2022<br>[5851de2](https://github.com/pathtofile/SealighterTI/commit/5851de2ee800073819d8b08ab4bb428f7feca580) · 4 years agoDec 6, 2022<br>## History<br>[36 Commits](https://github.com/pathtofile/SealighterTI/commits/master/) <br>Open commit details<br>[View commit history for this file.](https://github.com/pathtofile/SealighterTI/commits/master/) 36 Commits |
| [.github/workflows](https://github.com/pathtofile/SealighterTI/tree/master/.github/workflows "This path skips through empty directories") | [.github/workflows](https://github.com/pathtofile/SealighterTI/tree/master/.github/workflows "This path skips through empty directories") | [updated CI runner](https://github.com/pathtofile/SealighterTI/commit/c4bccceb16a2864741e95d3c9269ea13eff43cdb "updated CI runner") | 4 years agoAug 23, 2022 |
| [Detours @ fe7216c](https://github.com/microsoft/Detours/tree/fe7216c037c898b1f65330eda85e6146b6e3cb85 "Detours") | [Detours @ fe7216c](https://github.com/microsoft/Detours/tree/fe7216c037c898b1f65330eda85e6146b6e3cb85 "Detours") | [added submodules](https://github.com/pathtofile/SealighterTI/commit/e4d286ebe1becce277ddb851b9b911844c3167ac "added submodules") | 5 years agoMay 11, 2021 |
| [PPLdump](https://github.com/pathtofile/SealighterTI/tree/master/PPLdump "PPLdump") | [PPLdump](https://github.com/pathtofile/SealighterTI/tree/master/PPLdump "PPLdump") | [fixed debug resourse](https://github.com/pathtofile/SealighterTI/commit/bfa5ca94b9557683befe16ea0d0640781f430b18 "fixed debug resourse") | 5 years agoMay 11, 2021 |
| [PPLdumpDll](https://github.com/pathtofile/SealighterTI/tree/master/PPLdumpDll "PPLdumpDll") | [PPLdumpDll](https://github.com/pathtofile/SealighterTI/tree/master/PPLdumpDll "PPLdumpDll") | [enable Threat-Intelligence event stack traces](https://github.com/pathtofile/SealighterTI/commit/e5f80748d6f68ffe202086a1ed9e4bbe39e38b93 "enable Threat-Intelligence event stack traces") | 4 years agoFeb 22, 2022 |
| [Sealighter @ b28aa11](https://github.com/pathtofile/Sealighter/tree/b28aa11f93e740f5842de38c5980488f28ab94a3 "Sealighter") | [Sealighter @ b28aa11](https://github.com/pathtofile/Sealighter/tree/b28aa11f93e740f5842de38c5980488f28ab94a3 "Sealighter") | [updated Sealighter dependecy](https://github.com/pathtofile/SealighterTI/commit/c4f6fa585a9a9dc6d4891996ce1349ab5df6a429 "updated Sealighter dependecy") | 4 years agoMar 17, 2022 |
| [.gitattributes](https://github.com/pathtofile/SealighterTI/blob/master/.gitattributes ".gitattributes") | [.gitattributes](https://github.com/pathtofile/SealighterTI/blob/master/.gitattributes ".gitattributes") | [Add .gitignore and .gitattributes.](https://github.com/pathtofile/SealighterTI/commit/744c00b3f161bcf2169c04df2231d67980797830 "Add .gitignore and .gitattributes.") | 5 years agoApr 7, 2021 |
| [.gitignore](https://github.com/pathtofile/SealighterTI/blob/master/.gitignore ".gitignore") | [.gitignore](https://github.com/pathtofile/SealighterTI/blob/master/.gitignore ".gitignore") | [working](https://github.com/pathtofile/SealighterTI/commit/cacedb9994be5f24a359ccdff1a7208d31f59a8f "working") | 5 years agoMay 11, 2021 |
| [.gitmodules](https://github.com/pathtofile/SealighterTI/blob/master/.gitmodules ".gitmodules") | [.gitmodules](https://github.com/pathtofile/SealighterTI/blob/master/.gitmodules ".gitmodules") | [added submodules](https://github.com/pathtofile/SealighterTI/commit/e4d286ebe1becce277ddb851b9b911844c3167ac "added submodules") | 5 years agoMay 11, 2021 |
| [README.md](https://github.com/pathtofile/SealighterTI/blob/master/README.md "README.md") | [README.md](https://github.com/pathtofile/SealighterTI/blob/master/README.md "README.md") | [Update README.md](https://github.com/pathtofile/SealighterTI/commit/5851de2ee800073819d8b08ab4bb428f7feca580 "Update README.md") | 4 years agoDec 6, 2022 |
| [README\_PPLDUMP.md](https://github.com/pathtofile/SealighterTI/blob/master/README_PPLDUMP.md "README_PPLDUMP.md") | [README\_PPLDUMP.md](https://github.com/pathtofile/SealighterTI/blob/master/README_PPLDUMP.md "README_PPLDUMP.md") | [working](https://github.com/pathtofile/SealighterTI/commit/cacedb9994be5f24a359ccdff1a7208d31f59a8f "working") | 5 years agoMay 11, 2021 |
| [SealighterTI.sln](https://github.com/pathtofile/SealighterTI/blob/master/SealighterTI.sln "SealighterTI.sln") | [SealighterTI.sln](https://github.com/pathtofile/SealighterTI/blob/master/SealighterTI.sln "SealighterTI.sln") | [fixed debug resourse](https://github.com/pathtofile/SealighterTI/commit/bfa5ca94b9557683befe16ea0d0640781f430b18 "fixed debug resourse") | 5 years agoMay 11, 2021 |
| [SealighterTI\_EventLog.png](https://github.com/pathtofile/SealighterTI/blob/master/SealighterTI_EventLog.png "SealighterTI_EventLog.png") | [SealighterTI\_EventLog.png](https://github.com/pathtofile/SealighterTI/blob/master/SealighterTI_EventLog.png "SealighterTI_EventLog.png") | [readme](https://github.com/pathtofile/SealighterTI/commit/c6b4903ff0dafde6d0b84db2c32c89b86bcd833d "readme") | 5 years agoMay 12, 2021 |
| [SealighterTI\_Running.png](https://github.com/pathtofile/SealighterTI/blob/master/SealighterTI_Running.png "SealighterTI_Running.png") | [SealighterTI\_Running.png](https://github.com/pathtofile/SealighterTI/blob/master/SealighterTI_Running.png "SealighterTI_Running.png") | [readme](https://github.com/pathtofile/SealighterTI/commit/c6b4903ff0dafde6d0b84db2c32c89b86bcd833d "readme") | 5 years agoMay 12, 2021 |
| [demo.gif](https://github.com/pathtofile/SealighterTI/blob/master/demo.gif "demo.gif") | [demo.gif](https://github.com/pathtofile/SealighterTI/blob/master/demo.gif "demo.gif") | [Update demo](https://github.com/pathtofile/SealighterTI/commit/9f24123398ee9bc64efaa8bfaf7db063639aebbc "Update demo") | 5 years agoApr 7, 2021 |
| [sealighter\_provider.man](https://github.com/pathtofile/SealighterTI/blob/master/sealighter_provider.man "sealighter_provider.man") | [sealighter\_provider.man](https://github.com/pathtofile/SealighterTI/blob/master/sealighter_provider.man "sealighter_provider.man") | [working](https://github.com/pathtofile/SealighterTI/commit/cacedb9994be5f24a359ccdff1a7208d31f59a8f "working") | 5 years agoMay 11, 2021 |
| View all files |

## Repository files navigation

# Sealighter-TI

[Permalink: Sealighter-TI](https://github.com/pathtofile/SealighterTI#sealighter-ti)

Combining Sealighter with unpatched exploits and [PPLDump](https://github.com/itm4n/PPLdump) to run the `Microsoft-Windows-Threat-Intelligence` ETW Provider without a signed driver.

# **NOTE**

[Permalink: NOTE](https://github.com/pathtofile/SealighterTI#note)

The PPLDump exploit is patched on Windows 10 v21H2 Build 19044.1826 and upwards.
You can know more about it [here](https://github.com/itm4n/PPLdump/issues/12) and [here](https://itm4n.github.io/the-end-of-ppldump/).

For a similar solution, see [my blog on using Vulnerable Drivers](https://blog.tofile.dev/2022/11/30/kdu_sealighter.html) for the same purpose.

# Overview

[Permalink: Overview](https://github.com/pathtofile/SealighterTI#overview)

## The Problem - PPL and Anti-Malware

[Permalink: The Problem - PPL and Anti-Malware](https://github.com/pathtofile/SealighterTI#the-problem---ppl-and-anti-malware)

The `Microsoft-Windows-Threat-Intelligence` ETW Provider is an excellent tool to [detect process injection](https://blog.redbluepurple.io/windows-security-research/kernel-tracing-injection-detection), and other type of attacks. Unlike usermode hooking or in-process ETW Providers, avoiding or tampering with the `Threat-Intelligence` is very difficult.

However, to subscribe to this Provider requires a process with very special privileges, marked as [Protected Process Light (PPL)](https://www.alex-ionescu.com/?p=97) 'Anti-Malware' or higher. To legitimately run a program at this level you must submit a driver to Microsoft to be co-signed by them, something not everyone has the inclination or reputation to do.

I originally created a research project named [PPLRunner](https://github.com/pathtofile/PPLRunner) that would allow you create PPL process in a test environment, however it requires Windows to be put into a debug or 'test signing' mode. This could in theory also have the effect of altering the behaviour of the malware or program you are attempting to analyse, which may behave differently if it believes it is not on a 'real' machine.

## The Solution - Exploit to success

[Permalink: The Solution - Exploit to success](https://github.com/pathtofile/SealighterTI#the-solution---exploit-to-success)

Back in 2018 [Alex Ionescu](https://twitter.com/aionescu) and [James Forshaw](https://twitter.com/tiraniddo) presented a [series of talks](http://publications.alex-ionescu.com/Recon/Recon%202018%20-%20Unknown%20Known%20DLLs%20and%20other%20code%20integrity%20trust%20violations.pdf), as well as some [blogs](https://googleprojectzero.blogspot.com/2018/08/windows-exploitation-tricks-exploiting.html), covering many ways you could trick Windows into illegitimately running arbitrary code at the PPL level. A number of these techniques remain unpatched to this day.

In 2021 [Clément Labro](https://twitter.com/itm4n) created the project [PPLDump](https://github.com/itm4n/PPLdump), which uses one of the unpatched techniques Alex and James covered, to trick a PPL-elevated `services.exe` into loading an arbitrary DLL.

## The Glue - SealighterTI

[Permalink: The Glue - SealighterTI](https://github.com/pathtofile/SealighterTI#the-glue---sealighterti)

PPLDump uses its elevated access to dump the memory of `lsass.exe`. I've taken Clément's awesome code, and instead combined it with my ETW Logging tool [Sealighter](https://github.com/pathtofile/Sealighter), to enable you to get events from the `Microsoft-Windows-Threat-Intelligence` logging to the Windows Event Log. This is possible from a 'production' machine, without the need for a signed driver or to put the machine into 'test signing' mode.

# To Build

[Permalink: To Build](https://github.com/pathtofile/SealighterTI#to-build)

To use pre-built binaries, download the `SealighterTI.exe` and `sealigher_provider.man` from [The Releases Page](https://github.com/pathtofile/SealighterTI/releases).

To build manually, first check out the source code (make sure to use `--recursive`):

```
git clone --recursive https://github.com/pathtofile/SealighterTI.git
```

Then build `SealighterTI.sln`

**In most circumstances, only the 'Release' Build will actually inject successfully, so build and use that for 99% of cases**

# To Run

[Permalink: To Run](https://github.com/pathtofile/SealighterTI#to-run)

First, move the `SealighterTI.exe` binary to somewhere accessible by all users, e.g. `C:\Program Files`.
Then open up the `sealigher_provider.man` in a text editor, and replace all uses of `!!SEALIGHTER_LOCATION!!` with the full path to the `SealighterTI.exe` binary. Then from an elevated command prompt run:

```
wevtutil im path/to/sealigher_provider.man
```

Then just run `SealighterTI.exe`. For the first run, I recommend running with the debug flag:

```
SealighterTI.exe -d
```

For the first run I also recommend having a copy of [Sysinternal's DBGView](https://docs.microsoft.com/en-us/sysinternals/downloads/debugview) open with the "Capture Global Win32" option set, so you can see the debug logs from the DLL/PPL Process as well. If run correctly It should look like this:
[![Pic of Code Running](https://github.com/pathtofile/SealighterTI/raw/master/SealighterTI_Running.png)](https://github.com/pathtofile/SealighterTI/blob/master/SealighterTI_Running.png)

Once it gets to "press ctrl+c to stop" Open Event Viewer, and you should see events under 'Application and Service Logs/Sealighter/Operational':
[![Pic of Event Log](https://github.com/pathtofile/SealighterTI/raw/master/SealighterTI_EventLog.png)](https://github.com/pathtofile/SealighterTI/blob/master/SealighterTI_EventLog.png)

To stop the trace, press 'ctrl+c' in the `SealighterTI.exe` window.

# Technical Details

[Permalink: Technical Details](https://github.com/pathtofile/SealighterTI#technical-details)

See [this blog](https://blog.tofile.dev/) for the technical details about how everything works.

# The code has lots of 'PPLDump' files and functions?

[Permalink: The code has lots of 'PPLDump' files and functions?](https://github.com/pathtofile/SealighterTI#the-code-has-lots-of-ppldump-files-and-functions)

Yep, I chose to fork PPLDump and alter only the parts I needed to in order to get the ETW Trace working. This is both to ensure people know the exploit parts of the code are courtesy of Clément Labro, but also to make it easy if PPLDump gets updated with any bug fixes I may want to also pull into Sealighter-TI.

# Compatibility

[Permalink: Compatibility](https://github.com/pathtofile/SealighterTI#compatibility)

This has only been tested on Windows 10 x64.

# Acknowledgements

[Permalink: Acknowledgements](https://github.com/pathtofile/SealighterTI#acknowledgements)

All of the work to run arbitrary code as PPL is the work of [Clément Labro](https://twitter.com/itm4n) and their [PPLDump](https://github.com/itm4n/PPLdump) project. I simply worked on glueing the ETW Logging to the end of it.

The Research from [Alex Ionescu](https://twitter.com/aionescu) and [James Forshaw](https://twitter.com/tiraniddo) is instrumental in making this project possible.

[Filip Olszak](https://twitter.com/_lpvoid) has written a [great blog](https://blog.redbluepurple.io/windows-security-research/kernel-tracing-injection-detection) about the usefulness of the `Threat-Intelligence` ETW Provider.

# Further Reading/Links

[Permalink: Further Reading/Links](https://github.com/pathtofile/SealighterTI#further-readinglinks)

- [http://publications.alex-ionescu.com/Recon/Recon%202018%20-%20Unknown%20Known%20DLLs%20and%20other%20code%20integrity%20trust%20violations.pdf](http://publications.alex-ionescu.com/Recon/Recon%202018%20-%20Unknown%20Known%20DLLs%20and%20other%20code%20integrity%20trust%20violations.pdf)
- [https://blog.scrt.ch/2021/04/22/bypassing-lsa-protection-in-userland/](https://blog.scrt.ch/2021/04/22/bypassing-lsa-protection-in-userland/)
- [https://googleprojectzero.blogspot.com/2018/08/windows-exploitation-tricks-exploiting.html](https://googleprojectzero.blogspot.com/2018/08/windows-exploitation-tricks-exploiting.html)
- [https://www.alex-ionescu.com/?p=97](https://www.alex-ionescu.com/?p=97)
- [https://blog.redbluepurple.io/windows-security-research/kernel-tracing-injection-detection](https://blog.redbluepurple.io/windows-security-research/kernel-tracing-injection-detection)
- [https://github.com/itm4n/PPLdump](https://github.com/itm4n/PPLdump)
- [https://github.com/pathtofile/PPLRunner](https://github.com/pathtofile/PPLRunner)
- [https://github.com/pathtofile/Sealighter](https://github.com/pathtofile/Sealighter)

## About

Combining Sealighter with unpatched exploits to run the Threat-Intelligence ETW Provider


### Resources

[Readme](https://github.com/pathtofile/SealighterTI#readme-ov-file)

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/pathtofile/SealighterTI).

[Activity](https://github.com/pathtofile/SealighterTI/activity)

### Stars

[**197**\\
stars](https://github.com/pathtofile/SealighterTI/stargazers)

### Watchers

[**6**\\
watching](https://github.com/pathtofile/SealighterTI/watchers)

### Forks

[**32**\\
forks](https://github.com/pathtofile/SealighterTI/forks)

[Report repository](https://github.com/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fpathtofile%2FSealighterTI&report=pathtofile+%28user%29)

## [Releases\  4](https://github.com/pathtofile/SealighterTI/releases)

[Release v1.2\\
Latest\\
\\
on Mar 17, 2022Mar 17, 2022](https://github.com/pathtofile/SealighterTI/releases/tag/v1.2)

[\+ 3 releases](https://github.com/pathtofile/SealighterTI/releases)

## [Packages\  0](https://github.com/users/pathtofile/packages?repo_name=SealighterTI)

No packages published

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/pathtofile/SealighterTI).

## [Contributors\  3](https://github.com/pathtofile/SealighterTI/graphs/contributors)

- [![@pathtofile](https://avatars.githubusercontent.com/u/47049312?s=64&v=4)](https://github.com/pathtofile)[**pathtofile** pat\_h/to/file](https://github.com/pathtofile)
- [![@GetRektBoy724](https://avatars.githubusercontent.com/u/41237415?s=64&v=4)](https://github.com/GetRektBoy724)[**GetRektBoy724** Hannn](https://github.com/GetRektBoy724)
- [![@jdu2600](https://avatars.githubusercontent.com/u/53329154?s=64&v=4)](https://github.com/jdu2600)[**jdu2600** John U](https://github.com/jdu2600)

## Languages

- [C71.6%](https://github.com/pathtofile/SealighterTI/search?l=c)
- [C++26.6%](https://github.com/pathtofile/SealighterTI/search?l=c%2B%2B)
- [Roff1.7%](https://github.com/pathtofile/SealighterTI/search?l=roff)
- [Batchfile0.1%](https://github.com/pathtofile/SealighterTI/search?l=batchfile)

You can’t perform that action at this time.