Title:
Sensecon 23: from Windows drivers to an almost fully working EDR

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post walks through building a “dummy EDR” to demystify how modern Windows EDRs are architected and what kernel/user-mode components they rely on.  
- It contrasts legacy AV kernel hooking (e.g., SSDT patching) with modern constraints introduced by PatchGuard (KPP), motivating the use of supported kernel callback mechanisms.  
- The author implements a KMDF-style kernel driver that registers process-creation callbacks (PsSetCreateProcessNotifyRoutineEx) and demonstrates allowing/denying process creation via `PS_CREATE_NOTIFY_INFO->CreationStatus`.  
- It then adds a user-mode “agent” architecture: a static analyzer that checks Authenticode signature status, suspicious imports (OpenProcess/VirtualAllocEx/WriteProcessMemory/CreateRemoteThread), and strings like `SeDebugPrivilege`, plus a remote injector that DLL-injects into new processes.  
- The injected DLL uses MinHook to hook `ntdll!NtAllocateVirtualMemory` and kills the process when RWX (`PAGE_EXECUTE_READWRITE`) memory is requested, catching common shellcode injection patterns.  
- Useful for red teamers and security researchers to understand EDR telemetry points and bypass surfaces (e.g., callback arrays), and for defenders to understand common implementation tradeoffs and detection logic placement.

Technical Focus:
- Windows kernel drivers (KMDF basics, DriverEntry/IoCreateDevice/IoCreateSymbolicLink)
- PatchGuard (KPP) and why SSDT/kernel patching is constrained
- Kernel notify routines/callbacks (PsSetCreateProcessNotifyRoutineEx, callback arrays like PspCreateProcessNotifyRoutine)
- User-mode EDR agents and IPC (named pipes)
- DLL injection via CreateRemoteThread + LoadLibrary
- User-mode API hooking of NTDLL with MinHook (NtAllocateVirtualMemory)

Use Cases:
- Build a lab-grade EDR prototype to understand real EDR component orchestration
- Study kernel callback telemetry and how process creation can be blocked at creation time
- Prototype detections for remote thread injection and RWX allocation behaviors
- Develop red-team bypass ideas by targeting callback registration/visibility and user-mode hooks
- Teach Windows internals: syscalls, NTDLL role, and kernel/user boundary monitoring

Keywords:
Windows kernel driver, KMDF, PatchGuard, KPP, SSDT, system calls, NTDLL, PsSetCreateProcessNotifyRoutineEx, PS_CREATE_NOTIFY_INFO, PspCreateProcessNotifyRoutine, ObRegisterCallbacks, CmRegisterCallbacks, named pipes, Authenticode, WinVerifyTrust, IAT parsing, CreateRemoteThread, VirtualAllocEx, WriteProcessMemory, MinHook, NtAllocateVirtualMemory, DLL injection, RWX memory, PAGE_EXECUTE_READWRITE, shellcode injection, SeDebugPrivilege, WinDbg, DbgView