Title:
Spoofing Call Stacks To Confuse EDRs

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post demonstrates a proof-of-concept technique to spoof user-mode call stacks so that kernel callbacks (e.g., ObRegisterCallbacks) or telemetry sources like Sysmon/ETW record a benign-looking stack for suspicious actions such as opening a handle to LSASS.  
- It explains why call stacks are valuable EDR context (e.g., detecting unbacked/injected memory in stack traces) and how defenders use stack walking to separate true positives from false positives.  
- The author reverse engineers Sysmon’s stack collection (via RtlWalkFrameChain) and details x64 stack unwinding mechanics using .pdata unwind metadata and UNWIND_CODE parsing.  
- The PoC builds a “sacrificial” suspended thread whose CONTEXT/stack is crafted in reverse to match a target call trace, then executes NtOpenProcess with arguments set per the x64 calling convention.  
- After the syscall returns into a fake stack and faults, a vectored exception handler redirects execution to exit cleanly, yielding telemetry that appears to originate from legitimate modules (RPC/WMI/svchost patterns).  
- Useful for red teams and malware developers exploring EDR evasion, and for blue teams to understand limitations of stack-trace-based detections and how they can be manipulated.

Technical Focus:
- Windows kernel callback telemetry (ObRegisterCallbacks, PsSetCreate*NotifyRoutine*)
- Sysmon Event ID 10 call trace collection and RtlWalkFrameChain
- x64 stack unwinding via .pdata / UNWIND_CODE parsing (RtlVirtualUnwind)
- Thread CONTEXT manipulation (Rip/Rsp, register arguments) and suspended thread setup
- Vectored Exception Handling (VEH) for control-flow recovery
- Call stack spoofing to mask unbacked/injected code origins

Use Cases:
- Evade stack-trace-based detections for LSASS handle access / credential dumping prep
- Make injected/reflective DLL activity appear to originate from legitimate Windows modules
- Generate “benign” call traces for suspicious syscalls (e.g., NtOpenProcess) in telemetry
- Research and test EDR/Sysmon/ETW reliance on stack traces and potential hardening ideas
- Build adversary emulation scenarios around call-stack manipulation

Keywords:
call stack spoofing, EDR evasion, Sysmon Event ID 10, CallTrace, LSASS, NtOpenProcess, OpenProcess, ObRegisterCallbacks, PsSetCreateProcessNotifyRoutineEx, RtlWalkFrameChain, RtlVirtualUnwind, x64 unwind codes, .pdata, CONTEXT, suspended thread, RIP/RSP, x64 calling convention, VEH, ETW stack tracing, reflective DLL injection