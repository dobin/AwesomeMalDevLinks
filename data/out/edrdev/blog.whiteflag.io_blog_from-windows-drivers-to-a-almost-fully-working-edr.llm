Title:
From Windows Drivers to a (Almost) Fully Working EDR (MyDumbEDR)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post walks through building a simplified Windows EDR by starting from a KMDF kernel driver and progressively adding monitoring and prevention features.  
- It explains why legacy AV/EDR techniques like SSDT hooking were used, how PatchGuard (KPP) broke kernel patching approaches, and why modern products rely on supported kernel callback mechanisms.  
- The author implements process-creation monitoring and blocking using `PsSetCreateProcessNotifyRoutineEx`, then shows how callback arrays (e.g., `PspCreateProcessNotifyRoutine`) are structured and why they’re attractive EDR-blinding targets.  
- The “EDR” is split into a kernel driver plus two user-mode agents communicating via named pipes: a static analyzer (signature/IAT/string checks) and an injector that loads a DLL into new processes.  
- The injected DLL uses MinHook to hook `ntdll!NtAllocateVirtualMemory` and kills processes attempting RWX allocations, demonstrating a basic behavioral detection for remote shellcode injection.  
- Useful for red teamers and defenders who want a concrete mental model of EDR architecture (kernel telemetry + user-mode logic + user-mode API hooking) and common weak points.

Technical Focus:
- Windows kernel drivers (KMDF), DriverEntry/IoCreateDevice/IoCreateSymbolicLink
- PatchGuard (KPP) and the shift from SSDT hooking to supported callbacks
- Kernel notify routines: `PsSetCreateProcessNotifyRoutine(Ex)`, callback arrays (`Psp*`)
- User-mode agent orchestration via Named Pipes (IPC)
- DLL injection via `CreateRemoteThread` + `LoadLibraryA`
- User-mode API hooking of NTDLL with MinHook (hooking `NtAllocateVirtualMemory`)

Use Cases:
- Build a lab-grade EDR prototype to understand real EDR component orchestration
- Develop and test process-creation telemetry and prevention logic in kernel callbacks
- Experiment with user-mode hooking strategies and their limitations/detections
- Red-team research into EDR blinding opportunities (callback list manipulation) and bypass ideas
- Blue-team education on where telemetry is collected and where attackers can interfere

Keywords:
Windows kernel driver, KMDF, WDK, DriverEntry, PatchGuard, KPP, SSDT hooking, system calls, NTDLL, PsSetCreateProcessNotifyRoutineEx, PspCreateProcessNotifyRoutine, kernel callbacks, EPROCESS, PPS_CREATE_NOTIFY_INFO, CreationStatus, named pipe, IPC, static analysis, IAT parsing, WinVerifyTrust, DLL injection, CreateRemoteThread, LoadLibraryA, MinHook, NtAllocateVirtualMemory, RWX memory, PAGE_EXECUTE_READWRITE, shellcode injection, VirtualAllocEx, WriteProcessMemory, OpenProcess, SeDebugPrivilege, EDR bypass, CheekyBlinder