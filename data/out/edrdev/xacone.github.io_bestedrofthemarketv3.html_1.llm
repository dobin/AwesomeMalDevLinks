Title:
BestEdrOfTheMarket V3 — Kernel-mode EDR driver using callbacks, VAD analysis, and Alternative System Call Handlers

Type:
Blog Post (with linked GitHub Tool)

Short Summary (4–8 sentences max):
- This write-up presents BEOTM V3, a redesign of the “BestEdrOfTheMarket” project that moves detection from user mode to a Windows kernel driver to leverage stronger kernel telemetry and avoid user-mode hook limitations.  
- The driver is designed to be largely autonomous, using kernel notification callbacks plus an undocumented Alternative System Call Handler mechanism to observe and analyze process/thread/syscall activity without relying on ETW-TI consumers.  
- It implements detections for process tampering/hollowing by correlating PEB/LDR module data with the process VAD tree, and monitors in-memory image loads to send file paths to a user-mode client for YARA scanning.  
- For syscall monitoring, it registers a handler in `PsAltSystemCallHandlers[1]`, inspects `_KTRAP_FRAME` to extract syscall IDs/arguments, and captures buffers from sensitive syscalls (e.g., `NtWriteVirtualMemory`, `NtProtectVirtualMemory`, `NtWriteFile`) for YARA-based content detection.  
- Additional logic includes thread injection heuristics (stack/VAD checks), direct-syscall suspicion checks (RIP not in ntdll region), LSASS handle-open prevention via `ObRegisterCallbacks`, and an experimental CET shadow-stack integrity check.  
- It’s useful for defenders building kernel telemetry/detections, and for red teamers researching what modern kernel-resident detections can see and how common TTPs (hollowing, injection, dumping) are surfaced.

Technical Focus:
- Windows kernel driver telemetry via notification callbacks (Ps/Cm/Ob)
- VAD tree traversal (`_RTL_AVL_TREE`, `_MMVAD`) and LDR/PEB integrity correlation
- Alternative System Call Handlers (`PsAltSystemCallHandlers`, `PsRegisterAltSystemCallHandler`) and `_KTRAP_FRAME` argument extraction
- Buffer capture from sensitive syscalls for user-mode YARA scanning via IOCTL/queues
- Injection and direct-syscall detection heuristics (RIP/VAD/ntdll checks)
- CET shadow stack (IA32_PL3_SSP) comparison for stack tampering detection (experimental)

Use Cases:
- Build/extend kernel-mode detections for process hollowing, ghosting, herpaderping, and image tampering
- Detect/triage code injection by monitoring thread creation + syscall parameter buffers
- Block or alert on LSASS dumping attempts by filtering handle creation rights
- Research/validate detection coverage against C2 artifacts (e.g., Sliver, Metasploit) and common loaders
- Study undocumented kernel mechanisms (Alt syscall dispatch, VAD internals) for defensive engineering

Keywords:
Windows kernel driver, EDR, PsSetCreateProcessNotifyRoutineEx, PsSetCreateThreadNotifyRoutine, PsSetLoadImageNotifyRoutine, CmRegisterCallbackEx, ObRegisterCallbacks, VAD tree, _MMVAD, _RTL_AVL_TREE, PEB, LDR, process hollowing, T1055.012, PsAltSystemCallHandlers, PsRegisterAltSystemCallHandler, PsAltSystemCallDispatch, _KTRAP_FRAME, NtWriteVirtualMemory, NtProtectVirtualMemory, NtWriteFile, direct syscalls, LSASS, PROCESS_VM_READ, YARA, IOCTL, CET, shadow stack, IA32_PL3_SSP