# https://blog.palantir.com/tampering-with-windows-event-tracing-background-offense-and-defense-4be7ac62ac63

<!DOCTYPE html><html lang="en" data-rh="lang" dir="ltr"><body><div id="root"><div class="a b c"><a href="https://blog.palantir.com/sitemap/sitemap.xml" class="d">Sitemap</a><div class="e f g h i j k l"></div><div></div><div class="m c"><div class="m n o p c" style="transform: translateY(0px);"><div class="q r s t u v w x y j e z ab"><a class="eb ai ec bg am b ao ap aq ar as at au av t v x j e r ed ab" href="https://play.google.com/store/apps/details?id=com.medium.reader&amp;referrer=utm_source%3DmobileNavBar&amp;source=post_page---top_nav_layout_nav-----------------------------------------" rel="noopener follow">Open in app<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="none" viewBox="0 0 10 10" class="ea"><path fill="currentColor" d="M.985 8.485a.375.375 0 1 0 .53.53zM8.75 1.25h.375A.375.375 0 0 0 8.75.875zM8.375 6.5a.375.375 0 1 0 .75 0zM3.5.875a.375.375 0 1 0 0 .75zm-1.985 8.14 7.5-7.5-.53-.53-7.5 7.5zm6.86-7.765V6.5h.75V1.25zM3.5 1.625h5.25v-.75H3.5z"></path></svg></a><div class="ac r"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><button class="bg b ee ef ep eg eh eq ei ej er es el et eu eo ev ew ex ey ez fa fb fc fd fe ff fg fh fi fj fk bn fl fm" data-testid="headerSignUpButton">Sign up</button></span></p><div class="fn m"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerSignInButton" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Fblog.palantir.com%2Ftampering-with-windows-event-tracing-background-offense-and-defense-4be7ac62ac63&amp;source=post_page---top_nav_layout_nav-----------------------global_nav------------------" rel="noopener follow">Sign in</a></span></p></div></div></div><div class="q r s ac ae af"><div class="ac r ag"><a class="ah ai aj ak al am an ao ap aq ar as at au av ac" aria-label="Homepage" data-testid="headerMediumLogo" href="https://medium.com/?source=post_page---top_nav_layout_nav-----------------------------------------" rel="noopener follow"><svg xmlns="http://www.w3.org/2000/svg" width="719" height="160" fill="none" aria-labelledby="wordmark-medium-desc" viewBox="0 0 719 160" class="aw ax ay"><desc id="wordmark-medium-desc">Medium Logo</desc><path fill="#242424" d="m174.104 9.734.215-.047V8.02H130.39L89.6 103.89 48.81 8.021H1.472v1.666l.212.047c8.018 1.81 12.09 4.509 12.09 14.242V137.93c0 9.734-4.087 12.433-12.106 14.243l-.212.047v1.671h32.118v-1.665l-.213-.048c-8.018-1.809-12.089-4.509-12.089-14.242V30.586l52.399 123.305h2.972l53.925-126.743V140.75c-.687 7.688-4.721 10.062-11.982 11.701l-.215.05v1.652h55.948v-1.652l-.215-.05c-7.269-1.639-11.4-4.013-12.087-11.701l-.037-116.774h.037c0-9.733 4.071-12.432 12.087-14.242m25.555 75.488c.915-20.474 8.268-35.252 20.606-35.507 3.806.063 6.998 1.312 9.479 3.714 5.272 5.118 7.751 15.812 7.368 31.793zm-.553 5.77h65.573v-.275c-.186-15.656-4.721-27.834-13.466-36.196-7.559-7.227-18.751-11.203-30.507-11.203h-.263c-6.101 0-13.584 1.48-18.909 4.16-6.061 2.807-11.407 7.003-15.855 12.511-7.161 8.874-11.499 20.866-12.554 34.343q-.05.606-.092 1.212a50 50 0 0 0-.065 1.151 85.807 85.807 0 0 0-.094 5.689c.71 30.524 17.198 54.917 46.483 54.917 25.705 0 40.675-18.791 44.407-44.013l-1.886-.664c-6.557 13.556-18.334 21.771-31.738 20.769-18.297-1.369-32.314-19.922-31.042-42.395m139.722 41.359c-2.151 5.101-6.639 7.908-12.653 7.908s-11.513-4.129-15.418-11.63c-4.197-8.053-6.405-19.436-6.405-32.92 0-28.067 8.729-46.22 22.24-46.22 5.657 0 10.111 2.807 12.236 7.704zm43.499 20.008c-8.019-1.897-12.089-4.722-12.089-14.951V1.309l-48.716 14.353v1.757l.299-.024c6.72-.543 11.278.386 13.925 2.83 2.072 1.915 3.082 4.853 3.082 8.987v18.66c-4.803-3.067-10.516-4.56-17.448-4.56-14.059 0-26.909 5.92-36.176 16.672-9.66 11.205-14.767 26.518-14.767 44.278-.003 31.72 15.612 53.039 38.851 53.039 13.595 0 24.533-7.449 29.54-20.013v16.865h43.711v-1.746zM424.1 19.819c0-9.904-7.468-17.374-17.375-17.374-9.859 0-17.573 7.632-17.573 17.374s7.721 17.374 17.573 17.374c9.907 0 17.375-7.47 17.375-17.374m11.499 132.546c-8.019-1.897-12.089-4.722-12.089-14.951h-.035V43.635l-43.714 12.551v1.705l.263.024c9.458.842 12.047 4.1 12.047 15.152v81.086h43.751v-1.746zm112.013 0c-8.018-1.897-12.089-4.722-12.089-14.951V43.635l-41.621 12.137v1.71l.246.026c7.733.813 9.967 4.257 9.967 15.36v59.279c-2.578 5.102-7.415 8.131-13.274 8.336-9.503 0-14.736-6.419-14.736-18.073V43.638l-43.714 12.55v1.703l.262.024c9.459.84 12.05 4.097 12.05 15.152v50.17a56.3 56.3 0 0 0 .91 10.444l.787 3.423c3.701 13.262 13.398 20.197 28.59 20.197 12.868 0 24.147-7.966 29.115-20.43v17.311h43.714v-1.747zm169.818 1.788v-1.749l-.213-.05c-8.7-2.006-12.089-5.789-12.089-13.49v-63.79c0-19.89-11.171-31.761-29.883-31.761-13.64 0-25.141 7.882-29.569 20.16-3.517-13.01-13.639-20.16-28.606-20.16-13.146 0-23.449 6.938-27.869 18.657V43.643L545.487 55.68v1.715l.263.024c9.345.829 12.047 4.181 12.047 14.95v81.784h40.787v-1.746l-.215-.053c-6.941-1.631-9.181-4.606-9.181-12.239V66.998c1.836-4.289 5.537-9.37 12.853-9.37 9.086 0 13.692 6.296 13.692 18.697v77.828h40.797v-1.746l-.215-.053c-6.94-1.631-9.18-4.606-9.18-12.239V75.066a42 42 0 0 0-.578-7.26c1.947-4.661 5.86-10.177 13.475-10.177 9.214 0 13.691 6.114 13.691 18.696v77.828z"></path></svg></a><div class="az i"><div class="ac ak ba bb bc r bd be"><div class="bn" aria-describedby="searchResults" aria-labelledby="searchResults" aria-haspopup="listbox" role="listbox"></div><div class="bo bp ac"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg></div><input role="combobox" aria-controls="searchResults" aria-expanded="false" aria-label="search" data-testid="headerSearchInput" tabindex="0" class="ak bf bg bh ab bi bj bk bl bm" placeholder="Search" value=""></div></div></div><div class="i l x fp fq"><span data-dd-action-name="Susi presentation tracker new_post_topnav"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerWriteButton" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2Fnew-story&amp;source=---top_nav_layout_nav-----------------------new_post_topnav------------------" rel="noopener follow"><div class="bg b bh ab eb fr fs ac r ft fu fv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M14 4a.5.5 0 0 0 0-1zm7 6a.5.5 0 0 0-1 0zm-7-7H4v1h10zM3 4v16h1V4zm1 17h16v-1H4zm17-1V10h-1v10zm-1 1a1 1 0 0 0 1-1h-1zM3 20a1 1 0 0 0 1 1v-1zM4 3a1 1 0 0 0-1 1h1z"></path><path stroke="currentColor" d="m17.5 4.5-8.458 8.458a.25.25 0 0 0-.06.098l-.824 2.47a.25.25 0 0 0 .316.316l2.47-.823a.25.25 0 0 0 .098-.06L19.5 6.5m-2-2 2.323-2.323a.25.25 0 0 1 .354 0l1.646 1.646a.25.25 0 0 1 0 .354L19.5 6.5m-2-2 2 2"></path></svg>Write</div></a></span></div><div class="l k j e"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerSearchButton" href="https://medium.com/search?source=post_page---top_nav_layout_nav-----------------------------------------" rel="noopener follow"><div class="bg b bh ab eb fr fs ac r ft fu fv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Search</span></div></a></div><div class="ge i l k"><div class="ac r"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><button class="bg b ee ef ep eg eh eq ei ej er es el et eu eo ev ew ex ey ez fa fb fc fd fe ff fg fh fi fj fk bn fl fm" data-testid="headerSignUpButton">Sign up</button></span></p><div class="fn m"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerSignInButton" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Fblog.palantir.com%2Ftampering-with-windows-event-tracing-background-offense-and-defense-4be7ac62ac63&amp;source=post_page---top_nav_layout_nav-----------------------global_nav------------------" rel="noopener follow">Sign in</a></span></p></div></div></div><div class="m"><div><div class="bn" role="tooltip" aria-describedby="1" aria-labelledby="1"><div tabindex="-1" class="bf"><button class="ak gf ao ac r aq fr gg gh gi" aria-label="user options menu" data-testid="headerUserIcon"><div class="m fr"><img alt="" class="m fk by bz ca de" src="https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png" width="32" height="32" loading="lazy" role="presentation"><div class="gj by m bz ca fw o ak gk"></div></div></button></div></div></div></div></div></div><div class="ac"><div class="cb i l k j cc" style="width:0px"></div><div class="cd bi ce cf cg ch" style="width:calc(100% - 0px)"><div class="m"><div><div class="gn bi m"><div class="go bi bk"></div><div class="ac ci"><div class="cj ck cl cm cn gp cp bi"><div class="af ac r"><div class="gq gr gs gt gu m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://blog.palantir.com/?source=post_page---publication_nav-3c87dc14372f-4be7ac62ac63---------------------------------------" rel="noopener follow"><h2 class="bg gv gw ef gx gy eh gz ha hb hc hd he hf hg hh hi bl"><div class="gl ga gm gc">Palantir Blog</div></h2></a></div><div class="t v k j e"><span class="hj hk" aria-hidden="true"><span class="bg b hl hm bl">·</span></span><p class="bg b hl hm bl"><button class="ah ai aj fo al am an ao ap aq ar as at pq">Follow publication</button></p></div></div></div></div></div></div><div data-focus-guard="true" tabindex="-1" style="width: 1px; height: 0px; padding: 0px; overflow: hidden; position: fixed; top: 1px; left: 1px;"></div><div data-focus-lock-disabled="disabled"><div class="vi" role="dialog" aria-modal="true" tabindex="-1"><div class="yf yg bi ed yh yi yj aq hs hn yk" aria-hidden="true" role="presentation"></div><div class="yl yh ym yn yo yf ed fk yp yq yr nd ys yt yu yv yw yx yy yz za zb ac cv zc" aria-hidden="true"><div class="zd io"></div></div></div></div><div data-focus-guard="true" tabindex="-1" style="width: 1px; height: 0px; padding: 0px; overflow: hidden; position: fixed; top: 1px; left: 1px;"></div><div class="hn fw ho hp o hq hr nd ze"><div class="ac ci"><div class="cj ck cl cm cn gp cp bi"><div class="hu m"><div class="zf"><div class="ac cu cv"><a href="https://blog.palantir.com/?source=post_page---post_publication_sidebar-3c87dc14372f-4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="fr"><img alt="Palantir Blog" class="de hv m hx hw" src="https://miro.medium.com/v2/resize:fill:76:76/1*PbgkHC0TD-x4rvptc-w3jg.png" width="38" height="38" loading="lazy"><div class="hv m hw hx fw o gj hy"></div></div></a><div class="hz m"></div><p class="bg b bh ab eb"><span class="ia">Palantir Blog</span></p><div class="hz m"></div><p class="bg b bh ab bl"><button class="ah ai aj fo al am an ao ap aq ar as at pq">Follow publication</button></p></div></div></div></div></div></div><div class="ib ic id ie if m"><div class="ac ci"><div class="cp bi ig ih ii ij"></div></div><article><div class="m"><div class="m"><span class="m"></span><section><div><div class="fw ip zg ir is hn"></div><div class="ia it iu iv iw"><div class="ac ci"><div class="cp bi ig ih ii ij"><div><h1 id="6a1f" class="pw-post-title ix iy iz bg ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bl" data-testid="storyTitle" data-selectable-paragraph="">Tampering with Windows Event Tracing: Background, Offense, and Defense</h1><div><div class="speechify-ignore ac cw"><div class="speechify-ignore bi m"><div class="ac ka kb kc kd ke kf kg kh ki kj kk"><div class="ac r kk"><div class="ac kl"><div><div class="bn" role="tooltip" aria-describedby="2" aria-labelledby="2"><div tabindex="-1" class="bf"><a href="https://palantir.medium.com/?source=post_page---byline--4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="m km kn by ko kp"><div class="m fr"><img alt="Palantir" class="m fk by bz ca de" src="https://miro.medium.com/v2/resize:fill:64:64/1*yFp1VmXHPcrYrYrDNlD_7A.png" width="32" height="32" loading="lazy" data-testid="authorPhoto"><div class="kq by m bz ca fw o kr gk"></div></div></div></a></div></div></div></div><span class="bg b bh ab bl"><div class="ks ac r"><div class="ac r kt"><div class="ac r"><div><div class="bn" role="tooltip" aria-describedby="3" aria-labelledby="3"><div tabindex="-1" class="bf"><span class="bg b bh ab bl"><a class="ah ai aj fo al am an ao ap aq ar as at ku" data-testid="authorName" href="https://palantir.medium.com/?source=post_page---byline--4be7ac62ac63---------------------------------------" rel="noopener follow">Palantir</a></span></div></div></div></div><div class="kv bn"></div><button class="xh yb aq ac ci r zy zz aba" style="border: 1px solid rgba(24, 24, 24, 0.663);"><span class="bg b bh ab bl bi"><span class="bn ye">Follow</span></span></button></div></div></span></div><div class="ac r kw"><span class="bg b bh ab eb"><div class="ac ag"><span data-testid="storyReadTime">13 min read</span><div class="kx ky m" aria-hidden="true"><span class="m" aria-hidden="true"><span class="bg b bh ab eb">·</span></span></div><span data-testid="storyPublishDate">Dec 24, 2018</span></div></span></div></div><div class="ac cw kz la lb lc ld le lf lg lh li lj lk ll lm ln lo"><div class="i l x fp fq r"><div class="me m"><div class="ac r mf mg"><div class="pw-multi-vote-icon fr mh mi mj mk"><span data-dd-action-name="Susi presentation tracker clap_footer"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerClapButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fpalantir%2F4be7ac62ac63&amp;operation=register&amp;redirect=https%3A%2F%2Fblog.palantir.com%2Ftampering-with-windows-event-tracing-background-offense-and-defense-4be7ac62ac63&amp;user=Palantir&amp;userId=1529195d9f13&amp;source=---header_actions--4be7ac62ac63---------------------clap_footer------------------" rel="noopener follow"><div><div class="bn" role="tooltip" aria-describedby="4" aria-labelledby="4"><div tabindex="-1" class="bf"><div class="ml aq mm mn mo mp ao mq mr ms mk" role="presentation"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></div></div></div></a></span></div><div class="pw-multi-vote-count m mt mu mv mw mx my mz"><div><div class="bn" aria-describedby="71" aria-labelledby="71" role="tooltip"><div tabindex="-1" class="bf"><p class="bg b ec ab eb"><button class="ah ai aj fo al am an ao ap aq ar as at au av abb ni">214<span class="m i h g vn vo"></span></button></p></div></div></div></div></div></div><div><div class="bn" role="tooltip" aria-describedby="5" aria-labelledby="5"><div tabindex="-1" class="bf"><button class="aq ml nd ne ac r fs nf ng" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="nc"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"></path></svg><p class="bg b ec ab eb"><span class="pw-responses-count nb nc">1</span></p></button></div></div></div></div><div class="ac r lp lq lr ls lt lu lv lw lx ly lz ma mb mc md"><div class="nh l k j e"></div><div class="i l"><div><div class="bn" role="tooltip" aria-describedby="6" aria-labelledby="6"><div tabindex="-1" class="bf"><span data-dd-action-name="Susi presentation tracker bookmark_footer"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerBookmarkButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F4be7ac62ac63&amp;operation=register&amp;redirect=https%3A%2F%2Fblog.palantir.com%2Ftampering-with-windows-event-tracing-background-offense-and-defense-4be7ac62ac63&amp;source=---header_actions--4be7ac62ac63---------------------bookmark_footer------------------" rel="noopener follow"><span class=""><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25" class="eb ni" aria-label="Add to list bookmark button"><path fill="currentColor" d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .805.396L12.5 17l5.695 4.396A.5.5 0 0 0 19 21v-8.5a.5.5 0 0 0-1 0v7.485l-5.195-4.012a.5.5 0 0 0-.61 0L7 19.985z"></path></svg></span></a></span></div></div></div></div><div class="fk nj cu"><div class="m ag"><div class="ac ci"><div class="nk nl nm nn no gl cp bi"><div class="ac"><span data-dd-action-name="Susi presentation tracker post_audio_button"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2Fplans%3Fdimension%3Dpost_audio_button%26postId%3D4be7ac62ac63&amp;operation=register&amp;redirect=https%3A%2F%2Fblog.palantir.com%2Ftampering-with-windows-event-tracing-background-offense-and-defense-4be7ac62ac63&amp;source=---header_actions--4be7ac62ac63---------------------post_audio_button------------------" rel="noopener follow"><div><div class="bn" aria-describedby="21" aria-labelledby="21" role="tooltip"><div tabindex="-1" class="bf"><button aria-label="Listen" data-testid="audioPlayButton" class="ah fs aj fo al am an np ap aq ar fe nq nr ng ns nt nu nv nw t nx ny nz oa ob oc od v oe of og"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"></path></svg><div class="k j e"><p class="bg b bh ab eb">Listen</p></div></button></div></div></div></a></span></div></div></div></div></div><div class="bn" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bn" role="tooltip" aria-describedby="8" aria-labelledby="8"><div tabindex="-1" class="bf"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="ah fs aj fo al am an np ap aq ar fe nq nr ng ns nt nu nv nw t nx ny nz oa ob oc od v oe of og"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"></path></svg><div class="k j e"><p class="bg b bh ab eb">Share</p></div></button></div></div></div></div></div></div></div></div></div></div><figure class="ok ol om on oo op oh oi paragraph-image"><div role="button" tabindex="0" class="oq or fr os bi ot"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="oh oi oj"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*SMDAeNCTr6vY7N8oTjneiA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*SMDAeNCTr6vY7N8oTjneiA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*SMDAeNCTr6vY7N8oTjneiA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*SMDAeNCTr6vY7N8oTjneiA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*SMDAeNCTr6vY7N8oTjneiA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*SMDAeNCTr6vY7N8oTjneiA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SMDAeNCTr6vY7N8oTjneiA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*SMDAeNCTr6vY7N8oTjneiA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*SMDAeNCTr6vY7N8oTjneiA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*SMDAeNCTr6vY7N8oTjneiA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*SMDAeNCTr6vY7N8oTjneiA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*SMDAeNCTr6vY7N8oTjneiA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*SMDAeNCTr6vY7N8oTjneiA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*SMDAeNCTr6vY7N8oTjneiA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi gl ou c" width="700" height="598" loading="eager" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*SMDAeNCTr6vY7N8oTjneiA.png"></picture></div></div></figure><p id="3467" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph=""><a class="ah pq" href="https://blogs.msdn.microsoft.com/ntdebugging/2009/08/27/part-1-etw-introduction-and-overview/" rel="noopener ugc nofollow" target="_blank">Event Tracing for Windows</a> (ETW) is the mechanism Windows uses to trace and log system events. Attackers often clear event logs to cover their tracks. Though the act of clearing an event log itself generates an event, attackers who know ETW well may take advantage of tampering opportunities to cease the flow of logging temporarily or even permanently, without generating any event log entries in the process.</p><p id="900b" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">The Windows event log is the data source for many of the Palantir Critical Incident Response Team’s <a class="ah pq" href="https://medium.com/palantir/alerting-and-detection-strategy-framework-52dc33722df2" rel="noopener">Alerting and Detection Strategies</a>, so familiarity with event log tampering tradecraft is foundational to our success. We continually evaluate our assumptions regarding the integrity of our event data sources, document our blind spots, and adjust our implementation. The goal of this blog post is to share our knowledge with the community by covering ETW background and basics, stealthy event log tampering techniques, and detection strategies.</p><h2 id="4f16" class="pr ps iz bg pt pu pv pw gx px py pz gz qa qb qc qd qe qf qg qh qi qj qk ql qm bl" data-selectable-paragraph="">Introduction to ETW and event logging</h2><p id="76a0" class="pw-post-body-paragraph ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp ia bl" data-selectable-paragraph="">The <a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/etw/about-event-tracing" rel="noopener ugc nofollow" target="_blank">ETW architecture</a> differentiates between event <em class="qs">providers</em>, event <em class="qs">consumers</em>, and event <em class="qs">tracing sessions</em>. Tracing sessions are responsible for collecting events from providers and for relaying them to log files and consumers. Sessions are created and configured by <em class="qs">controllers</em> like the built-in <code class="de qt qu qv qw b">logman.exe</code> command line utility. Here are some useful commands for exploring existing trace sessions and their respective ETW providers; note that these must usually be executed from an elevated context.</p><h3 id="b1a4" class="qx ps iz bg pt gw qy ef gx gy qz eh gz ha ra hb hc hd rb he hf hg rc hh hi rd bl" data-selectable-paragraph="">List all running trace sessions</h3><pre class="re rf rg rh ri rj qw rk rl ak rm bl"><span id="919b" class="qx ps iz qw b hl rn ro m rp rq" data-selectable-paragraph="">&gt; <!-- -->logman query -ets</span><span id="88f3" class="qx ps iz qw b hl rr ro m rp rq" data-selectable-paragraph="">Data Collector Set                Type    Status<br>-------------------------------------------------<br>Circular Kernel Context Logger    Trace   Running<br>AppModel                          Trace   Running<br>ScreenOnPowerStudyTraceSession    Trace   Running<br>DiagLog                           Trace   Running<br>EventLog-Application              Trace   Running<br>EventLog-System                   Trace   Running<br>LwtNetLog                         Trace   Running<br>NtfsLog                           Trace   Running<br>TileStore                         Trace   Running<br>UBPM                              Trace   Running<br>WdiContextLog                     Trace   Running<br>WiFiSession                       Trace   Running<br>UserNotPresentTraceSession        Trace   Running<br>Diagtrack-Listener                Trace   Running<br>MSDTC_TRACE_SESSION               Trace   Running<br>WindowsUpdate_trace_log           Trace   Running</span></pre><h3 id="647f" class="qx ps iz bg pt gw qy ef gx gy qz eh gz ha ra hb hc hd rb he hf hg rc hh hi rd bl" data-selectable-paragraph="">List all providers that a trace session is subscribed to</h3><pre class="re rf rg rh ri rj qw rk rl ak rm bl"><span id="09a8" class="qx ps iz qw b hl rn ro m rp rq" data-selectable-paragraph="">&gt; <!-- -->logman query "EventLog-Application" -ets</span><span id="f182" class="qx ps iz qw b hl rr ro m rp rq" data-selectable-paragraph="">Name:                 EventLog-Application<br>Status:               Running<br>Root Path:            %systemdrive%\PerfLogs\Admin<br>Segment:              Off<br>Schedules:            On<br>Segment Max Size:     100 MB<br> <br>Name:                 EventLog-Application\EventLog-Application<br>Type:                 Trace<br>Append:               Off<br>Circular:             Off<br>Overwrite:            Off<br>Buffer Size:          64<br>Buffers Lost:         0<br>Buffers Written:      242<br>Buffer Flush Timer:   1<br>Clock Type:           System<br>File Mode:            Real-time<br> <br>Provider:<br>Name:                 Microsoft-Windows-SenseIR<br>Provider Guid:        {B6D775EF-1436-4FE6-BAD3-9E436319E218}<br>Level:                255<br>KeywordsAll:          0x0<br>KeywordsAny:          0x8000000000000000 (Microsoft-Windows-SenseIR/Operational)<br>Properties:           65<br>Filter Type:          0<br> <br>Provider:<br>Name:                 Microsoft-Windows-WDAG-Service<br>Provider Guid:        {728B02D9-BF21-49F6-BE3F-91BC06F7467E}<br>Level:                255<br>KeywordsAll:          0x0<br>KeywordsAny:          0x8000000000000000<br>Properties:           65<br>Filter Type:          0<br> <br>...<br> <br>Provider:<br>Name:                 Microsoft-Windows-PowerShell<br>Provider Guid:        {A0C1853B-5C40-4B15-8766-3CF1C58F985A}<br>Level:                255<br>KeywordsAll:          0x0<br>KeywordsAny:          0x9000000000000000 (Microsoft-Windows-PowerShell/Operational,Microsoft-Windows-PowerShell/Admin)<br>Properties:           65<br>Filter Type:          0</span></pre><p id="0b63" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">This command details the configuration of the trace session itself, followed by the configuration of each provider that the session is subscribed to, including the following parameters:</p><ul class=""><li id="9846" class="ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp rs rt ru bl" data-selectable-paragraph=""><strong class="ox ja">Name</strong>: The name of the provider. A provider only has a name if it has a <a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/etw/writing-manifest-based-events" rel="noopener ugc nofollow" target="_blank">registered manifest</a>, but it always has a unique GUID.</li><li id="8dfd" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph=""><strong class="ox ja">Provider GUID</strong>: The unique GUID for the provider. The GUID and/or name of a provider is useful when performing research or operations on a specific provider.</li><li id="3034" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph=""><strong class="ox ja">Level</strong>: The logging level specified. Standard logging levels are: 0 — Log Always; 1 — Critical; 2 — Error; 3 — Warning; 4 — Informational; 5 — Verbose. Custom logging levels can also be defined, but levels 6–15 are reserved. More than one logging level can be captured by ORing respective levels; supplying 255 (0xFF) is the standard method of capturing all supported logging levels.</li><li id="cb70" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph=""><strong class="ox ja">KeywordsAll</strong>: Keywords are used to filter specific categories of events. While logging level is used to filter by event verbosity/importance, keywords allow filtering by event category. A keyword corresponds to a specific bit value. <em class="qs">All</em> indicates that, for a given keyword matched by <code class="de qt qu qv qw b">KeywordsAny</code>, further filtering should be performed based on the specific bitmask in <code class="de qt qu qv qw b">KeywordsAll</code>. This field is often set to zero. More information on <em class="qs">All</em> vs. <em class="qs">Any</em> can be found <a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/wes/defining-keywords-used-to-classify-types-of-events" rel="noopener ugc nofollow" target="_blank">here</a>.</li><li id="264d" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph=""><strong class="ox ja">KeywordsAny</strong>: Enables filtering based on any combination of the keywords specified. This can be thought of as a logical OR where KeywordsAll is a subsequent application of a logical AND. The low 6 bytes refer to keywords specific to the provider. The high two bytes are reserved and defined in <code class="de qt qu qv qw b">WinMeta.xml</code> in the Windows SDK. For example, in event log-related trace sessions, you will see the high byte (specifically, the high nibble) set to a specific value. This corresponds to one or more event channels where the following channels are defined:</li></ul><pre class="re rf rg rh ri rj qw rk rl ak rm bl"><span id="3e70" class="qx ps iz qw b hl rn ro m rp rq" data-selectable-paragraph="">0x01 - Admin channel<br>0x02 - Debug channel<br>0x04 - Analytic channel<br>0x08 - Operational channel</span></pre><ul class=""><li id="0c78" class="ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp rs rt ru bl" data-selectable-paragraph=""><strong class="ox ja">Properties</strong>: This refers to optional ETW properties that can be specified when writing the event. The following values are currently supported (more information <a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/ETW/enable-trace-parameters" rel="noopener ugc nofollow" target="_blank">here</a>):</li></ul><pre class="re rf rg rh ri rj qw rk rl ak rm bl"><span id="f8f4" class="qx ps iz qw b hl rn ro m rp rq" data-selectable-paragraph="">0x001 - EVENT_ENABLE_PROPERTY_SID<br>0x002 - EVENT_ENABLE_PROPERTY_TS_ID<br>0x004 - EVENT_ENABLE_PROPERTY_STACK_TRACE<br>0x008 - EVENT_ENABLE_PROPERTY_PSM_KEY<br>0x010 - EVENT_ENABLE_PROPERTY_IGNORE_KEYWORD_0<br>0x020 - EVENT_ENABLE_PROPERTY_PROVIDER_GROUP<br>0x040 - EVENT_ENABLE_PROPERTY_ENABLE_KEYWORD_0<br>0x080 - EVENT_ENABLE_PROPERTY_PROCESS_START_KEY<br>0x100 - EVENT_ENABLE_PROPERTY_EVENT_KEY<br>0x200 - EVENT_ENABLE_PROPERTY_EXCLUDE_INPRIVATE</span></pre><p id="85ea" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">From a detection perspective, EVENT_ENABLE_PROPERTY_SID, EVENT_ENABLE_PROPERTY_TS_ID, EVENT_ENABLE_PROPERTY_PROCESS_START_KEY are valuable fields to collect. For example, EVENT_ENABLE_PROPERTY_PROCESS_START_KEY generates a value that uniquely identifies a process. Note that Process IDs are not unique identifiers for a process instance.</p><ul class=""><li id="998c" class="ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp rs rt ru bl" data-selectable-paragraph=""><strong class="ox ja">Filter Type</strong>: Providers can optionally choose to implement additional filtering; supported filters are <a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/wes/defining-filters" rel="noopener ugc nofollow" target="_blank">defined in the provider manifest</a>. In practice, none of the built-in providers implement filters as confirmed by running <a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/api/tdh/nf-tdh-tdhenumerateproviderfilters" rel="noopener ugc nofollow" target="_blank">TdhEnumerateProviderFilters</a> over all registered providers. There are some predefined filter types defined in <code class="de qt qu qv qw b">eventprov.h</code> (in the Windows SDK):</li></ul><pre class="re rf rg rh ri rj qw rk rl ak rm bl"><span id="3f11" class="qx ps iz qw b hl rn ro m rp rq" data-selectable-paragraph="">0x00000000 - EVENT_FILTER_TYPE_NONE<br>0x80000000 - EVENT_FILTER_TYPE_SCHEMATIZED<br>0x80000001 - EVENT_FILTER_TYPE_SYSTEM_FLAGS<br>0x80000002 - EVENT_FILTER_TYPE_TRACEHANDLE<br>0x80000004 - EVENT_FILTER_TYPE_PID<br>0x80000008 - EVENT_FILTER_TYPE_EXECUTABLE_NAME<br>0x80000010 - EVENT_FILTER_TYPE_PACKAGE_ID<br>0x80000020 - EVENT_FILTER_TYPE_PACKAGE_APP_ID<br>0x80000100 - EVENT_FILTER_TYPE_PAYLOAD<br>0x80000200 - EVENT_FILTER_TYPE_EVENT_ID<br>0x80000400 - EVENT_FILTER_TYPE_EVENT_NAME<br>0x80001000 - EVENT_FILTER_TYPE_STACKWALK<br>0x80002000 - EVENT_FILTER_TYPE_STACKWALK_NAME<br>0x80004000 - EVENT_FILTER_TYPE_STACKWALK_LEVEL_KW</span></pre><h3 id="2627" class="qx ps iz bg pt gw qy ef gx gy qz eh gz ha ra hb hc hd rb he hf hg rc hh hi rd bl" data-selectable-paragraph="">Enumerating all registered ETW providers</h3><p id="5702" class="pw-post-body-paragraph ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp ia bl" data-selectable-paragraph="">The <code class="de qt qu qv qw b">logman query providers </code>command lists all registered ETW providers, supplying their name and GUID. An ETW provider is registered if it has a binary manifest stored in the<br> <code class="de qt qu qv qw b">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WINEVT\Publishers\{PROVIDER_GUID}</code> registry key. For example, the <code class="de qt qu qv qw b">Microsoft-Windows-PowerShell</code> provider has the following registry values:</p><figure class="re rf rg rh ri op oh oi paragraph-image"><div class="oh oi sa"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*x34GfTbt6kR-GkP7KAX-Nw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*x34GfTbt6kR-GkP7KAX-Nw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*x34GfTbt6kR-GkP7KAX-Nw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*x34GfTbt6kR-GkP7KAX-Nw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*x34GfTbt6kR-GkP7KAX-Nw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*x34GfTbt6kR-GkP7KAX-Nw.png 1100w, https://miro.medium.com/v2/resize:fit:1248/format:webp/1*x34GfTbt6kR-GkP7KAX-Nw.png 1248w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 624px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*x34GfTbt6kR-GkP7KAX-Nw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*x34GfTbt6kR-GkP7KAX-Nw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*x34GfTbt6kR-GkP7KAX-Nw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*x34GfTbt6kR-GkP7KAX-Nw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*x34GfTbt6kR-GkP7KAX-Nw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*x34GfTbt6kR-GkP7KAX-Nw.png 1100w, https://miro.medium.com/v2/resize:fit:1248/1*x34GfTbt6kR-GkP7KAX-Nw.png 1248w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 624px"><img alt="" class="bi gl ou c" width="624" height="115" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:624/1*x34GfTbt6kR-GkP7KAX-Nw.png"></picture></div></figure><p id="43b0" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">ETW and the event log know how to properly parse and display event information to a user based on binary-serialized information in the <code class="de qt qu qv qw b">WEVT_TEMPLATE</code> resource present in the binaries listed in the <code class="de qt qu qv qw b">ResourceFileName</code> registry value. This resource is a binary representation of an <a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/wes/writing-an-instrumentation-manifest" rel="noopener ugc nofollow" target="_blank">instrumentation manifest</a> (i.e., the schema for an ETW provider). The binary structure of <code class="de qt qu qv qw b">WEVT_TEMPLATE</code> is <a class="ah pq" href="https://github.com/libyal/libexe/blob/master/documentation/Executable%20(EXE)%20file%20format.asciidoc" rel="noopener ugc nofollow" target="_blank">under-documented</a>, but there are at least two tools available to assist in parsing and recovering event schema, <a class="ah pq" href="https://github.com/lallousx86/WEPExplorer" rel="noopener ugc nofollow" target="_blank">WEPExplorer</a> and <a class="ah pq" href="https://github.com/Microsoft/perfview" rel="noopener ugc nofollow" target="_blank">Perfview.</a></p><h3 id="45b4" class="qx ps iz bg pt gw qy ef gx gy qz eh gz ha ra hb hc hd rb he hf hg rc hh hi rd bl" data-selectable-paragraph="">Viewing an individual provider</h3><p id="be16" class="pw-post-body-paragraph ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp ia bl" data-selectable-paragraph="">The <code class="de qt qu qv qw b">logman</code> tool prints basic information about a provider. For example:</p><figure class="re rf rg rh ri op"><div class="sb ga m fr"><div class="sc sd m"></div></div></figure><p id="f3d4" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">The listings shows supported keywords and logging values, as well as all processes that are registered to emit events via this provider. This output is useful for understanding how existing trace sessions filter on providers. It is also useful for initial discovery of potentially interesting information that could be gathered from via an ETW trace.</p><p id="87c7" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">Notably, the PowerShell provider appears to support logging to the event log based on the existence of the reserved keywords in the high nibble of the defined keywords. Not all ETW providers are designed to be ingested into the event log; rather, many ETW providers are intended to be used solely for low-level tracing, debugging, and more recently-developed security telemetry purposes. For example, Windows Defender Advanced Threat Protection relies heavily upon ETW as a supplemental detection data source.</p><h3 id="8699" class="qx ps iz bg pt gw qy ef gx gy qz eh gz ha ra hb hc hd rb he hf hg rc hh hi rd bl" data-selectable-paragraph="">Viewing all providers that a specific process is sending events to</h3><p id="985f" class="pw-post-body-paragraph ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp ia bl" data-selectable-paragraph="">Another method for discovering potentially interesting providers is to view all providers to which events are written from a specific process. For example, the following listing shows all providers relevant to <code class="de qt qu qv qw b">MsMpEng.exe</code> (the Windows Defender service, running as pid 5244 in this example):</p><figure class="re rf rg rh ri op"><div class="sb ga m fr"><div class="sc sd m"></div></div></figure><p id="5e54" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">Entries listed with GUID are providers lacking a manifest. They will typically be related to <a class="ah pq" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/wpp-software-tracing" rel="noopener ugc nofollow" target="_blank">WPP</a> or <a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/tracelogging/trace-logging-portal" rel="noopener ugc nofollow" target="_blank">TraceLogging</a>, both of which are beyond the scope of this blog post. It is possible to retrieve provider names and event metadata for these providers types. For example, here are some of the resolved provider names from the unnamed providers above:</p><ul class=""><li id="1574" class="ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp rs rt ru bl" data-selectable-paragraph="">05F95EFE-7F75–49C7-A994–60A55CC09571<br>Microsoft.Windows.Kernel.KernelBase</li><li id="a9a9" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">072665FB-8953–5A85–931D-D06AEAB3D109<br>Microsoft.Windows.ProcessLifetimeManage</li><li id="4bfe" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">7AF898D7–7E0E-518D-5F96-B1E79239484C<br>Microsoft.Windows.Defender</li></ul><h2 id="9421" class="pr ps iz bg pt pu pv pw gx px py pz gz qa qb qc qd qe qf qg qh qi qj qk ql qm bl" data-selectable-paragraph="">Event provider internals</h2><p id="15ae" class="pw-post-body-paragraph ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp ia bl" data-selectable-paragraph="">Looking at ETW-replated code snippets in built-in Windows binaries can help you understand how ETW events are constructed and how they surface in event logs. Below, we highlight two code samples, <code class="de qt qu qv qw b">System.Management.Automation.dll</code> (the core PowerShell assembly) and <code class="de qt qu qv qw b">amsi.dll</code>.</p><h3 id="8a0d" class="qx ps iz bg pt gw qy ef gx gy qz eh gz ha ra hb hc hd rb he hf hg rc hh hi rd bl" data-selectable-paragraph="">System.Management.Automation.dll event tracing</h3><p id="43af" class="pw-post-body-paragraph ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp ia bl" data-selectable-paragraph="">One of the great security features of PowerShell version 5 is <a class="ah pq" href="https://blogs.msdn.microsoft.com/powershell/2015/06/09/powershell-the-blue-team/" rel="noopener ugc nofollow" target="_blank">scriptblock autologging</a>; when enabled, script content is automatically logged to the Microsoft-Windows-PowerShell/Operational event log with event ID 4104 (warning level) if the scriptblock contains any <a class="ah pq" href="https://github.com/PowerShell/PowerShell/blob/79f21b41de0de9b2f68a19ba1fdef0b98f3fb1cb/src/System.Management.Automation/engine/runtime/CompiledScriptBlock.cs#L1546-L1829" rel="noopener ugc nofollow" target="_blank">suspicious terms</a>. The following C# <a class="ah pq" href="https://github.com/PowerShell/PowerShell/blob/c1e171622acb2917914fbc3fde69322b07863b3b/src/System.Management.Automation/engine/runtime/CompiledScriptBlock.cs#L1440-L1444" rel="noopener ugc nofollow" target="_blank">code</a> is executed to generate the event log:</p><figure class="re rf rg rh ri op"><div class="sb ga m fr"><div class="sc sd m"></div></div><figcaption class="se fm sf oh oi sg sh bg b bh ab eb">From <a class="ah pq" href="https://github.com/PowerShell/PowerShell/blob/c1e171622acb2917914fbc3fde69322b07863b3b/src/System.Management.Automation/engine/runtime/CompiledScriptBlock.cs#L1440-L1444" rel="noopener ugc nofollow" target="_blank">PowerShell</a></figcaption></figure><p id="d19e" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">The <code class="de qt qu qv qw b">LogOperationalWarning</code> method is implemented as follows:</p><figure class="re rf rg rh ri op"><div class="sb ga m fr"><div class="sc sd m"></div></div><figcaption class="se fm sf oh oi sg sh bg b bh ab eb">From <a class="ah pq" href="https://github.com/PowerShell/PowerShell/blob/5d03e1653a7d518715fa3f00587cad6b5c78cc89/src/System.Management.Automation/utils/tracing/PSEtwLog.cs#L155-L158" rel="noopener ugc nofollow" target="_blank">PowerShell</a></figcaption></figure><p id="1df1" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">The <code class="de qt qu qv qw b">WriteEvent</code> method is implemented as follows:</p><figure class="re rf rg rh ri op"><div class="sb ga m fr"><div class="sc sd m"></div></div><figcaption class="se fm sf oh oi sg sh bg b bh ab eb">From <a class="ah pq" href="https://github.com/PowerShell/PowerShell/blob/5d03e1653a7d518715fa3f00587cad6b5c78cc89/src/System.Management.Automation/utils/tracing/PSEtwLogProvider.cs#L269-L287" rel="noopener ugc nofollow" target="_blank">PowerShell</a></figcaption></figure><p id="a536" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">Finally, the event information is marshaled and <a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/api/evntprov/nf-evntprov-eventwritetransfer" rel="noopener ugc nofollow" target="_blank">EventWriteTransfer</a> is called, supplying the Microsoft-Windows-PowerShell provider with event data.</p><div class="si gn sj sk ac r cv"><div class="sl sm sn so sp m fm"><h2 class="sq b sr ss st su sv">Get <!-- -->Palantir<!-- -->’s stories in&nbsp;your&nbsp;inbox</h2></div><div class="cs m fm"><p class="bg b bh ab eb">Join Medium for free to get updates from&nbsp;this&nbsp;writer.</p></div><div class="sz ta tb tc td te ac"><span class="bg b bh ab bl"><div class="tf ac cv"><div class="ac tf fj fi bq tg th de nd ti tj tk tl tm tn to"><input class="tp al aj an tq tr gd mp bm ts bi" placeholder="Enter your email" type="text" value=""></div></div></span><div class="i l tt cb"><div class="sw sx sy"><button class="bg b bh ab tu tv tw tx ty tz ua fc fd ub uc ud fh fi fj fk bn fl fm">Subscribe</button></div></div><div class="bi k j e"><button class="bg b bh ab tu tv tw tx ty tz ua fc fd ub uc ud fh bi fi fj fk bn fl fm">Subscribe</button></div></div><div class="ue m"><div id="g-recaptcha"></div></div></div><p id="849e" class="pw-post-body-paragraph ov ow iz ox b oy pa pb pc pe pf ha ph pi hd pk pl hg pn po sk pp ia bl" data-selectable-paragraph="">The relevant data supplied to <code class="de qt qu qv qw b">EventWriteTransfer</code> is as follows:</p><ul class=""><li id="f372" class="ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp rs rt ru bl" data-selectable-paragraph="">Microsoft-Windows-PowerShell provider GUID: <code class="de qt qu qv qw b">{A0C1853B-5C40-4b15-8766-3CF1C58F985A}</code></li><li id="6feb" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">Event ID: <code class="de qt qu qv qw b">PSEventId.ScriptBlock_Compile_Detail - 4104</code></li><li id="2516" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">Channel value: <code class="de qt qu qv qw b">PSChannel.Operational - 16<br></code>Again, the usage of a channel value indicates that the provider is intended to be used with the event log. The operational channel definition for the PowerShell ETW manifest can be seen <a class="ah pq" href="https://github.com/PowerShell/PowerShell-Native/blob/master/src/PowerShell.Core.Instrumentation/PowerShell.Core.Instrumentation.man#L2194-L2202" rel="noopener ugc nofollow" target="_blank">here</a>. When an explicit channel value is not supplied, <a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/wes/message-compiler--mc-exe-" rel="noopener ugc nofollow" target="_blank">Message Compiler</a> (<code class="de qt qu qv qw b">mc.exe</code>) will assign a default value starting at 16. Since the operational channel was defined first, it was assigned 16.</li><li id="3667" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">Opcode value: <code class="de qt qu qv qw b">PSOpcode.Create - 15</code></li><li id="ccf0" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">Logging level: <code class="de qt qu qv qw b">PSLevel.Warning - 3</code></li><li id="2ff7" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">Task value: <code class="de qt qu qv qw b">PSTask.CommandStart - 102</code></li><li id="b21f" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">Keyword value: <code class="de qt qu qv qw b">PSKeyword.UseAlwaysAnalytic - 0x4000000000000000<br></code>This value is later translated to 0 as seen in the code block above. Normally, this event would not be logged but because the Application event log trace session specifies the <code class="de qt qu qv qw b">EVENT_ENABLE_PROPERTY_ENABLE_KEYWORD_0 Enable</code> flag for all of its providers which will log the event despite a keyword value not being specified.</li><li id="f7e7" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">Event data: the scriptblock contents and event fields</li></ul><p id="af08" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">Upon receiving the event from the PowerShell ETW provider, the event log service parses the binary <code class="de qt qu qv qw b">WEVT_TEMPLATE</code> schema (<a class="ah pq" href="https://github.com/PowerShell/PowerShell-Native/blob/master/src/PowerShell.Core.Instrumentation/PowerShell.Core.Instrumentation.man" rel="noopener ugc nofollow" target="_blank">original XML schema</a>) and presents human-readable, parsed event properties/fields:</p><figure class="re rf rg rh ri op oh oi paragraph-image"><div class="oh oi uf"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*ORet99fS6ZXb925L0b8BVQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*ORet99fS6ZXb925L0b8BVQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*ORet99fS6ZXb925L0b8BVQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*ORet99fS6ZXb925L0b8BVQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*ORet99fS6ZXb925L0b8BVQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*ORet99fS6ZXb925L0b8BVQ.png 1100w, https://miro.medium.com/v2/resize:fit:1164/format:webp/1*ORet99fS6ZXb925L0b8BVQ.png 1164w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 582px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*ORet99fS6ZXb925L0b8BVQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*ORet99fS6ZXb925L0b8BVQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*ORet99fS6ZXb925L0b8BVQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*ORet99fS6ZXb925L0b8BVQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*ORet99fS6ZXb925L0b8BVQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*ORet99fS6ZXb925L0b8BVQ.png 1100w, https://miro.medium.com/v2/resize:fit:1164/1*ORet99fS6ZXb925L0b8BVQ.png 1164w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 582px"><img alt="" class="bi gl ou c" width="582" height="264" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:582/1*ORet99fS6ZXb925L0b8BVQ.png"></picture></div></figure><h3 id="6875" class="qx ps iz bg pt gw qy ef gx gy qz eh gz ha ra hb hc hd rb he hf hg rc hh hi rd bl" data-selectable-paragraph="">amsi.dll event tracing</h3><p id="65ca" class="pw-post-body-paragraph ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp ia bl" data-selectable-paragraph="">You may have observed that Windows 10 has an AMSI/Operational event log that is typically empty. To understand why events are not logged to this event log, you would first have to inspect how data is fed to the AMSI ETW provider (<code class="de qt qu qv qw b">Microsoft-Antimalware-Scan-Interface - {2A576B87-09A7-520E-C21A-4942F0271D67}</code>) and then observe how the Application event log trace session (<code class="de qt qu qv qw b">EventLog-Application</code>) subscribes to the AMSI ETW provider. Let’s start by looking at the provider registration in the Application event log. The following PowerShell cmdlet will supply us with this information:</p><pre class="re rf rg rh ri rj qw rk rl ak rm bl"><span id="b42d" class="qx ps iz qw b hl rn ro m rp rq" data-selectable-paragraph="">&gt; <!-- -->Get-EtwTraceProvider -SessionName EventLog-Application -Guid '{2A576B87-09A7-520E-C21A-4942F0271D67}'</span><span id="b2e1" class="qx ps iz qw b hl rr ro m rp rq" data-selectable-paragraph="">SessionName     : EventLog-Application<br>Guid            : {2A576B87-09A7-520E-C21A-4942F0271D67}<br>Level           : 255<br>MatchAnyKeyword : 0x8000000000000000<br>MatchAllKeyword : 0x0<br>EnableProperty  : {EVENT_ENABLE_PROPERTY_ENABLE_KEYWORD_0, EVENT_ENABLE_PROPERTY_SID}</span></pre><p id="4c5c" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">The following properties should be noted:</p><ul class=""><li id="669b" class="ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp rs rt ru bl" data-selectable-paragraph="">Operational channel events (as indicated by <code class="de qt qu qv qw b">0x8000000000000000</code> in the MatchAnyKeyword value) are captured.</li><li id="0c54" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">All logging levels are captured.</li><li id="5b7a" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">Events should be captured even if an event keyword value is zero as indicated by the <code class="de qt qu qv qw b">EVENT_ENABLE_PROPERTY_ENABLE_KEYWORD_0</code> flag.</li></ul><p id="3407" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">This information on its own does not explain why AMSI events are not logged, but it supplies needed context upon inspecting how <code class="de qt qu qv qw b">amsi.dll</code> writes events to ETW. By loading <code class="de qt qu qv qw b">amsi.dl</code> into IDA, we can see that there was a single call to the <code class="de qt qu qv qw b">EventWrite</code> function within the internal <code class="de qt qu qv qw b">CAmsiAntimalware::GenerateEtwEvent</code> function:</p><figure class="re rf rg rh ri op oh oi paragraph-image"><div class="oh oi ug"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*YTbNASnN_A5biCyAfqUljQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*YTbNASnN_A5biCyAfqUljQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*YTbNASnN_A5biCyAfqUljQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*YTbNASnN_A5biCyAfqUljQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*YTbNASnN_A5biCyAfqUljQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*YTbNASnN_A5biCyAfqUljQ.png 1100w, https://miro.medium.com/v2/resize:fit:916/format:webp/1*YTbNASnN_A5biCyAfqUljQ.png 916w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 458px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*YTbNASnN_A5biCyAfqUljQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*YTbNASnN_A5biCyAfqUljQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*YTbNASnN_A5biCyAfqUljQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*YTbNASnN_A5biCyAfqUljQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*YTbNASnN_A5biCyAfqUljQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*YTbNASnN_A5biCyAfqUljQ.png 1100w, https://miro.medium.com/v2/resize:fit:916/1*YTbNASnN_A5biCyAfqUljQ.png 916w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 458px"><img alt="" class="bi gl ou c" width="458" height="522" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:458/1*YTbNASnN_A5biCyAfqUljQ.png"></picture></div></figure><p id="b297" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">The relevant portion of the call to <code class="de qt qu qv qw b">EventWrite</code> is the <code class="de qt qu qv qw b">EventDescriptor</code> argument. Upon applying the <code class="de qt qu qv qw b">EVENT_DESCRIPTOR</code> structure type to <code class="de qt qu qv qw b">_AMSI_SCANBUFFER</code>, the following information was interpreted:</p><figure class="re rf rg rh ri op oh oi paragraph-image"><div class="oh oi sa"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*khNJj2-2qqDn9hruBL5bZg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*khNJj2-2qqDn9hruBL5bZg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*khNJj2-2qqDn9hruBL5bZg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*khNJj2-2qqDn9hruBL5bZg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*khNJj2-2qqDn9hruBL5bZg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*khNJj2-2qqDn9hruBL5bZg.png 1100w, https://miro.medium.com/v2/resize:fit:1248/format:webp/1*khNJj2-2qqDn9hruBL5bZg.png 1248w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 624px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*khNJj2-2qqDn9hruBL5bZg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*khNJj2-2qqDn9hruBL5bZg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*khNJj2-2qqDn9hruBL5bZg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*khNJj2-2qqDn9hruBL5bZg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*khNJj2-2qqDn9hruBL5bZg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*khNJj2-2qqDn9hruBL5bZg.png 1100w, https://miro.medium.com/v2/resize:fit:1248/1*khNJj2-2qqDn9hruBL5bZg.png 1248w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 624px"><img alt="" class="bi gl ou c" width="624" height="136" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:624/1*khNJj2-2qqDn9hruBL5bZg.png"></picture></div></figure><p id="9705" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">The <code class="de qt qu qv qw b">EVENT_DESCRIPTOR</code> context gives us the relevant information:</p><ul class=""><li id="09f9" class="ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp rs rt ru bl" data-selectable-paragraph="">Event ID: <code class="de qt qu qv qw b">1101 (0x44D)<br></code>This events details can be extracted from a recovered manifest as seen <a class="ah pq" href="https://gist.github.com/mattifestation/6b3bbbea56cfc01bbfed9f74d94db618#file-microsoft-antimalware-scan-interface-manifest-xml-L12-L25" rel="noopener ugc nofollow" target="_blank">here</a>.</li><li id="4938" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">Channel: <code class="de qt qu qv qw b">16 (0x10)</code> referring to the operational event log channel</li><li id="4725" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">Level: 4 (Informational)</li><li id="90ff" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">Keyword: <code class="de qt qu qv qw b">0x8000000000000001</code> (AMSI/Operational OR Event1). These values are interpreted by running the <code class="de qt qu qv qw b">logman query providers Microsoft-Antimalware-Scan-Interface</code> command.</li></ul><p id="e9c0" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">We now understand that 1101 events not logged to the Application event log because it only considers events where the keyword value matches 0x8000000000000000. In order to fix this issue and get events pumping into the event log, either the Application event log trace session would need to be modified (not recommended and requires SYSTEM privileges) or you could create your own persistent trace session (e.g., an <a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/etw/configuring-and-starting-an-autologger-session" rel="noopener ugc nofollow" target="_blank">autologger</a>) to capture AMSI events in the event log. The following PowerShell script creates such a trace session:</p><pre class="re rf rg rh ri rj qw rk rl ak rm bl"><span id="065a" class="qx ps iz qw b hl rn ro m rp rq" data-selectable-paragraph="">$AutoLoggerGuid = "{$((New-Guid).Guid)}"<br>New-AutologgerConfig -Name MyCustomAutoLogger -Guid $AutoLoggerGuid -Start Enabled<br>Add-EtwTraceProvider -AutologgerName MyCustomAutoLogger -Guid '{2A576B87-09A7-520E-C21A-4942F0271D67}' -Level 0xff -MatchAnyKeyword 0x80000000000001 -Property 0x41</span></pre><p id="49a9" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">After running the above command, reboot, and the AMSI event log will begin to populate.</p><figure class="re rf rg rh ri op oh oi paragraph-image"><div class="oh oi sa"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*zegstKi6t8mJlwFYr6wFlA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*zegstKi6t8mJlwFYr6wFlA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*zegstKi6t8mJlwFYr6wFlA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*zegstKi6t8mJlwFYr6wFlA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*zegstKi6t8mJlwFYr6wFlA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*zegstKi6t8mJlwFYr6wFlA.png 1100w, https://miro.medium.com/v2/resize:fit:1248/format:webp/1*zegstKi6t8mJlwFYr6wFlA.png 1248w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 624px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*zegstKi6t8mJlwFYr6wFlA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*zegstKi6t8mJlwFYr6wFlA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*zegstKi6t8mJlwFYr6wFlA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*zegstKi6t8mJlwFYr6wFlA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*zegstKi6t8mJlwFYr6wFlA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*zegstKi6t8mJlwFYr6wFlA.png 1100w, https://miro.medium.com/v2/resize:fit:1248/1*zegstKi6t8mJlwFYr6wFlA.png 1248w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 624px"><img alt="" class="bi gl ou c" width="624" height="473" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:624/1*zegstKi6t8mJlwFYr6wFlA.png"></picture></div></figure><p id="8515" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">Some additional reverse engineering showed that the <code class="de qt qu qv qw b">scanResult</code> field refers to the <a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/ne-amsi-amsi_result" rel="noopener ugc nofollow" target="_blank">AMSI_RESULT</a> enum where, in this case, 32768 maps to <code class="de qt qu qv qw b">AMSI_RESULT_DETECTED</code>, indicating that the buffer (the Unicode encoded buffer in the content field) was determined to be malicious.</p><p id="3692" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">Without knowledge of ETW internals, a defender would not have been able to determine that additional data sources (the AMSI log in this case) can be fed into the event log. One would have to resort to speculation as to how the AMSI event became to be misconfigured and whether or not the misconfiguration was intentional.</p><h2 id="c59f" class="pr ps iz bg pt pu pv pw gx px py pz gz qa qb qc qd qe qf qg qh qi qj qk ql qm bl" data-selectable-paragraph="">ETW tampering techniques</h2><p id="2b75" class="pw-post-body-paragraph ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp ia bl" data-selectable-paragraph="">If the goal of an attacker is to subvert event logging, ETW provides a stealthy mechanism to affect logging without itself generating an event log trail. Below is a non-exhaustive list of tampering techniques that an attacker can use to cut off the supply of events to a specific event log.</p><p id="1acf" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">Tampering techniques can generally be broken down into two categories:</p><ol class=""><li id="43f9" class="ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp uh rt ru bl" data-selectable-paragraph="">Persistent, requiring reboot — i.e., a reboot must occur before the attack takes effect. Changes can be reverted, but would require another reboot. These attacks involve altering <a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/etw/configuring-and-starting-an-autologger-session" rel="noopener ugc nofollow" target="_blank">autologger</a> settings — persistent ETW trace sessions with settings in the registry. There are more types of persistent attacks than ephemeral attacks, and they are usually more straightforward to detect.</li><li id="5bbd" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp uh rt ru bl" data-selectable-paragraph="">Ephemeral — i.e., where the attack can take place without a reboot.</li></ol><h3 id="e24f" class="qx ps iz bg pt gw qy ef gx gy qz eh gz ha ra hb hc hd rb he hf hg rc hh hi rd bl" data-selectable-paragraph="">Autologger provider removal</h3><p id="ed5c" class="pw-post-body-paragraph ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp ia bl" data-selectable-paragraph=""><strong class="ox ja">Tampering category</strong>: Persistent, requiring reboot<br><strong class="ox ja">Minimum permissions required</strong>: Administrator<br><strong class="ox ja">Detection artifacts</strong>: Registry key deletion: <code class="de qt qu qv qw b">HKLM\SYSTEM\CurrentControlSet\Control\WMI\Autologger\AUTOLOGGER_NAME\{PROVIDER_GUID}</code><br><br><strong class="ox ja">Description</strong>: This technique involves the removal of a provider entry from a configured autologger. Removing a provider registration from an autologger will cause events to cease to flow to the respective trace session.<br> <br><strong class="ox ja">Example</strong>: The following PowerShell code disables Microsoft-Windows-PowerShell event logging:</p><pre class="re rf rg rh ri rj qw rk rl ak rm bl"><span id="d85f" class="qx ps iz qw b hl rn ro m rp rq" data-selectable-paragraph="">Remove-EtwTraceProvider -AutologgerName EventLog-Application -Guid '{A0C1853B-5C40-4B15-8766-3CF1C58F985A}'</span></pre><p id="a4df" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">In the above example, <code class="de qt qu qv qw b">A0C1853B-5C40-4B15-8766-3CF1C58F985A</code> refers to the Microsoft-Windows-PowerShell ETW provider. This command will end up deleting the <code class="de qt qu qv qw b">HKLM\System\CurrentControlSet\Control\WMI\Autologger\EventLog-Application\{a0c1853b-5c40-4b15-8766-3cf1c58f985a}</code> registry key.</p><h3 id="29b9" class="qx ps iz bg pt gw qy ef gx gy qz eh gz ha ra hb hc hd rb he hf hg rc hh hi rd bl" data-selectable-paragraph="">Provider “Enable” property modification</h3><p id="8f0e" class="pw-post-body-paragraph ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp ia bl" data-selectable-paragraph=""><strong class="ox ja">Tampering category</strong>: Persistent, requiring reboot<br><strong class="ox ja">Minimum permissions required</strong>: Administrator<br><strong class="ox ja">Detection artifacts</strong>: Registry value modification: <code class="de qt qu qv qw b">HKLM\SYSTEM\CurrentControlSet\Control\WMI\Autologger\AUTOLOGGER_NAME\{PROVIDER_GUID} - EnableProperty (REG_DWORD)</code><br><br><strong class="ox ja">Description</strong>: This technique involves alerting the <code class="de qt qu qv qw b">Enable</code> keyword of an autologger session. For example, by default, all ETW provider entries in the <code class="de qt qu qv qw b">EventLog-Application</code> autologger session are set to <code class="de qt qu qv qw b">0x41</code> which translates to <code class="de qt qu qv qw b">EVENT_ENABLE_PROPERTY_SID</code> and <code class="de qt qu qv qw b">EVENT_ENABLE_PROPERTY_ENABLE_KEYWORD_0</code>. <code class="de qt qu qv qw b">EVENT_ENABLE_PROPERTY_ENABLE_KEYWORD_0</code> is not documented; it specifies that any events generated for a provider should be logged even if the keyword value is set to 0. An attacker could swap out <code class="de qt qu qv qw b">EVENT_ENABLE_PROPERTY_ENABLE_KEYWORD_0</code> for <code class="de qt qu qv qw b">EVENT_ENABLE_PROPERTY_IGNORE_KEYWORD_0</code>, resulting in a value of <code class="de qt qu qv qw b">0x11</code>, which would result in all events where the keyword is 0 to not be logged. For example, PowerShell eventing supplies a 0 keyword value with its events, resulting in no logging to the PowerShell event log.<br><br><strong class="ox ja">Example</strong>: The following PowerShell code disables Microsoft-Windows-PowerShell event logging:</p><pre class="re rf rg rh ri rj qw rk rl ak rm bl"><span id="f97c" class="qx ps iz qw b hl rn ro m rp rq" data-selectable-paragraph="">Set-EtwTraceProvider -Guid '{A0C1853B-5C40-4B15-8766-3CF1C58F985A}' -AutologgerName 'EventLog-Application' -Property 0x11</span></pre><p id="2d75" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph="">In the above example, <code class="de qt qu qv qw b">A0C1853B-5C40-4B15-8766-3CF1C58F985A</code> refers to the Microsoft-Windows-PowerShell ETW provider. This command will end up setting <code class="de qt qu qv qw b">HKLM\System\CurrentControlSet\Control\WMI\Autologger\EventLog-Application\{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\EnableProperty</code> to <code class="de qt qu qv qw b">0x11</code>. Upon rebooting, events will cease to be reported to the PowerShell event log.<br> <br>An attacker is not constrained to using just the <a class="ah pq" href="https://docs.microsoft.com/en-us/powershell/module/eventtracmancmdlets/set-etwtraceprovider?view=win10-ps" rel="noopener ugc nofollow" target="_blank">Set-EtwTraceProvider</a> cmdlet to carry out this attack. An attacker could just modify the value directly in the registry. <code class="de qt qu qv qw b">Set-EtwTraceProvider</code> offers a convenient autologger configuration abstraction.<br><br><strong class="ox ja">Alternative detection artifacts/ideas</strong>: If possible, it is advisable to monitor for modifications of values within the <code class="de qt qu qv qw b">HKLM\SYSTEM\CurrentControlSet\Control\WMI\Autologger\AUTOLOGGER_NAME\{PROVIDER_GUID}</code> registry key. Note that modifying <code class="de qt qu qv qw b">EnableProperty</code> is just one specific example and that an attacker can alter ETW providers in other ways, too.</p><h3 id="8e57" class="qx ps iz bg pt gw qy ef gx gy qz eh gz ha ra hb hc hd rb he hf hg rc hh hi rd bl" data-selectable-paragraph="">ETW provider removal from a trace session</h3><p id="cc05" class="pw-post-body-paragraph ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp ia bl" data-selectable-paragraph=""><strong class="ox ja">Tampering category</strong>: Ephemeral<br><strong class="ox ja">Minimum permissions required</strong>: SYSTEM<br><strong class="ox ja">Detection artifacts</strong>: Unfortunately, no file, registry, or event log artifacts are associated with this event. While the technique example below indicates that <code class="de qt qu qv qw b">logman.exe</code> was used to perform the attack, an attacker can obfuscate their techniques by using Win32 APIs directly, WMI, DCOM, PowerShell, etc.<br> <br><strong class="ox ja">Description</strong>: This technique involves removing an ETW provider from a trace session, cutting off its ability to supply a targeted event log with events until a reboot occurs, or until the attacker restores the provider. While an attacker must have SYSTEM privileges to perform this attack, it is unlikely that defenders will notice such an attack if they rely on event logs for threat detection.<br> <br><strong class="ox ja">Example</strong>: The following PowerShell code immediately disables Microsoft-Windows-PowerShell event logging until a reboot occurs or the attacker restores the ETW provider:</p><pre class="re rf rg rh ri rj qw rk rl ak rm bl"><span id="e273" class="qx ps iz qw b hl rn ro m rp rq" data-selectable-paragraph="">logman update trace EventLog-Application --p Microsoft-Windows-PowerShell -ets</span></pre><p id="e3c5" class="pw-post-body-paragraph ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp ia bl" data-selectable-paragraph=""><strong class="ox ja">Alternative detection artifacts/ideas</strong>:</p><ul class=""><li id="06e4" class="ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp rs rt ru bl" data-selectable-paragraph="">Event ID 12 within the Microsoft-Windows-Kernel-EventTracing/Analytic log indicates when a trace session is modified, but it doesn’t supply the provider name or GUID that was removed, so it would be difficult to confidently determine whether or not something suspicious occurred using this event.</li><li id="aefa" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph="">There have been several references thus far to the ETW PowerShell cmdlets housed in the <code class="de qt qu qv qw b">EventTracingManagement</code> module, which itself is a CDXML-based module. This means that all the cmdlets in the <code class="de qt qu qv qw b">EventTracingManagement</code> are backed by WMI classes. For example, the <code class="de qt qu qv qw b">Get-EtwTraceProvider</code> cmdlet is backed by the <code class="de qt qu qv qw b">ROOT/Microsoft/Windows/EventTracingManagement:MSFT_EtwTraceProvider</code> class. Considering ETW providers can be represented in the form of WMI class instances, you could craft a permanent WMI event subscription that logs all provider removals from a specific trace session to the event log. <a class="ah pq" href="https://gist.github.com/mattifestation/9f07e4ab0df84cfd176fe40db2d60aa8" rel="noopener ugc nofollow" target="_blank">This code sample</a> creates an <code class="de qt qu qv qw b">NtEventLogEventConsumer</code> instance that logs event ID 8 to the Application event log (source: WSH) any time a provider is removed from the Application event log trace session, <code class="de qt qu qv qw b">EventLog-Application</code>. The logged event looks like the following:</li></ul><figure class="re rf rg rh ri op oh oi paragraph-image"><div class="oh oi ui"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*6fkfDWJ2pSt7lOh1g77gmg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*6fkfDWJ2pSt7lOh1g77gmg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*6fkfDWJ2pSt7lOh1g77gmg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*6fkfDWJ2pSt7lOh1g77gmg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*6fkfDWJ2pSt7lOh1g77gmg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*6fkfDWJ2pSt7lOh1g77gmg.png 1100w, https://miro.medium.com/v2/resize:fit:1068/format:webp/1*6fkfDWJ2pSt7lOh1g77gmg.png 1068w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 534px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*6fkfDWJ2pSt7lOh1g77gmg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*6fkfDWJ2pSt7lOh1g77gmg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*6fkfDWJ2pSt7lOh1g77gmg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*6fkfDWJ2pSt7lOh1g77gmg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*6fkfDWJ2pSt7lOh1g77gmg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*6fkfDWJ2pSt7lOh1g77gmg.png 1100w, https://miro.medium.com/v2/resize:fit:1068/1*6fkfDWJ2pSt7lOh1g77gmg.png 1068w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 534px"><img alt="" class="bi gl ou c" width="534" height="300" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:534/1*6fkfDWJ2pSt7lOh1g77gmg.png"></picture></div></figure><ul class=""><li id="dd41" class="ov ow iz ox b oy oz pa pb pc pd pe pf ha pg ph pi hd pj pk pl hg pm pn po pp rs rt ru bl" data-selectable-paragraph="">The frequency at which providers are removed from Application event logs in large environments is not currently known. As as fallback, it is still advised to log the execution of <code class="de qt qu qv qw b">logman.exe</code>, <code class="de qt qu qv qw b">wpr.exe</code>, and PowerShell in your environment.</li></ul><h2 id="5c57" class="pr ps iz bg pt pu pv pw gx px py pz gz qa qb qc qd qe qf qg qh qi qj qk ql qm bl" data-selectable-paragraph="">Conclusion</h2><p id="f4c1" class="pw-post-body-paragraph ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp ia bl" data-selectable-paragraph="">Identifying blind spots and assumptions in Alerting and Detection Strategies is a crucial step in ensuring the resilience of detections. Since ETW is at the core of the event logging infrastructure, gaining an in-depth understanding of ETW tampering attacks is a valuable way to increase the integrity of security-related data sources.</p><h2 id="0c7b" class="pr ps iz bg pt pu pv pw gx px py pz gz qa qb qc qd qe qf qg qh qi qj qk ql qm bl" data-selectable-paragraph="">Further Reading</h2><ul class=""><li id="858b" class="ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp rs rt ru bl" data-selectable-paragraph=""><a class="ah pq" href="https://blogs.msdn.microsoft.com/dcook/2015/09/30/etw-overview/" rel="noopener ugc nofollow" target="_blank">ETW — Overview</a></li><li id="58fa" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph=""><a class="ah pq" href="https://docs.microsoft.com/en-us/windows-hardware/test/weg/instrumenting-your-code-with-etw" rel="noopener ugc nofollow" target="_blank">Instrumenting Your Code with ETW</a></li><li id="4408" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph=""><a class="ah pq" href="https://www.codeproject.com/Articles/1190759/Event-Tracing-for-Windows-Reducing-Everest-to-Pike" rel="noopener ugc nofollow" target="_blank">Event Tracing for Windows: Reducing Everest to Pike’s Peak</a></li><li id="dfc8" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph=""><a class="ah pq" href="https://blogs.msdn.microsoft.com/seealso/2011/06/08/use-this-not-this-logging-event-tracing/" rel="noopener ugc nofollow" target="_blank">Use this not this: Logging / Event Tracing</a></li><li id="94aa" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph=""><a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/wes/writing-an-instrumentation-manifest" rel="noopener ugc nofollow" target="_blank">Writing an Instrumentation Manifest</a></li><li id="9be1" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph=""><a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/etw/event-tracing-functions" rel="noopener ugc nofollow" target="_blank">Event Tracing Functions</a></li><li id="1294" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph=""><a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/ETW/configuring-and-starting-an-autologger-session" rel="noopener ugc nofollow" target="_blank">Configuring and Starting an AutoLogger Session</a></li><li id="d342" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph=""><a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/etw/event-tracing-portal" rel="noopener ugc nofollow" target="_blank">Event Tracing</a></li><li id="6da2" class="ov ow iz ox b oy rv pa pb pc rw pe pf ha rx ph pi hd ry pk pl hg rz pn po pp rs rt ru bl" data-selectable-paragraph=""><a class="ah pq" href="https://docs.microsoft.com/en-us/windows/desktop/tracelogging/trace-logging-portal" rel="noopener ugc nofollow" target="_blank">TraceLogging</a></li></ul></div></div></div><div class="ac ci uj uk ul um" role="separator"><span class="un by bn go uo up"></span><span class="un by bn go uo up"></span><span class="un by bn go uo"></span></div><div class="ia it iu iv iw"><div class="ac ci"><div class="cp bi ig ih ii ij"><h2 id="19bb" class="pr ps iz bg pt pu uq pw gx px ur pz gz qa us qc qd qe ut qg qh qi uu qk ql qm bl" data-selectable-paragraph="">Authors</h2><p id="c3c9" class="pw-post-body-paragraph ov ow iz ox b oy qn pa pb pc qo pe pf ha qp ph pi hd qq pk pl hg qr pn po pp ia bl" data-selectable-paragraph="">Matt G.</p></div></div></div></div></section></div></div></article></div><div class="ac ci"><div class="cp bi ig ih ii ij"><div class="uv uw ac kw"><div class="ue ac"><a class="ux ak ao aq" href="https://medium.com/tag/palantirtech?source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="tv fr de uy il uz va bg b bh ab bl gc">Palantirtech</div></a></div><div class="ue ac"><a class="ux ak ao aq" href="https://medium.com/tag/infosec?source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="tv fr de uy il uz va bg b bh ab bl gc">Infosec</div></a></div><div class="ue ac"><a class="ux ak ao aq" href="https://medium.com/tag/windows?source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="tv fr de uy il uz va bg b bh ab bl gc">Windows</div></a></div><div class="ue ac"><a class="ux ak ao aq" href="https://medium.com/tag/incident-response?source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="tv fr de uy il uz va bg b bh ab bl gc">Incident Response</div></a></div><div class="ue ac"><a class="ux ak ao aq" href="https://medium.com/tag/cybersecurity?source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="tv fr de uy il uz va bg b bh ab bl gc">Cybersecurity</div></a></div></div></div></div><div class="m"></div><div class="vp m"><div class="ac ci"><div class="cp bi ig ih ii ij"><div class="vq m"><div class="ac kj kh kf td ta"><div class="vr vs vt vu vv vw vx vy vz wa ac cw"><div class="i l"><a href="https://blog.palantir.com/?source=post_page---post_publication_info--4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="fr"><img alt="Palantir Blog" class="de hv m wc wb" src="https://miro.medium.com/v2/resize:fill:96:96/1*PbgkHC0TD-x4rvptc-w3jg.png" width="48" height="48" loading="lazy"><div class="hv m wb wc fw o gj hy"></div></div></a></div><div class="k j e"><a href="https://blog.palantir.com/?source=post_page---post_publication_info--4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="fr"><img alt="Palantir Blog" class="de hv m we wd" src="https://miro.medium.com/v2/resize:fill:128:128/1*PbgkHC0TD-x4rvptc-w3jg.png" width="64" height="64" loading="lazy"><div class="hv m wd we fw o gj hy"></div></div></a></div><div class="k j e tt cb"><div class="ac"><button style="border: 1px solid rgba(34, 34, 34, 0.957);" class="xh yb aq ac ci r yc me yd"><span class="bg b bh ab bl bi"><span class="bn ye">Follow</span></span></button></div></div></div><div class="ac cv cd"><div class="wf wg wh wi wj m"><a class="ah ai aj al am an ao ap aq ar as at au av ac r" href="https://blog.palantir.com/?source=post_page---post_publication_info--4be7ac62ac63---------------------------------------" rel="noopener follow"><h2 class="pw-author-name bg gv wl wm wn wo wp wq ha hb hc hd he hf hg hh hi bl"><span class="ia wk">Published in <!-- -->Palantir Blog</span></h2></a><div class="ue ac kl"><div class="m cb"><span class="pw-follower-count bg b bh ab eb"><a class="ah ai aj fo al am an ao ap aq ar as at ku" rel="noopener follow" href="https://blog.palantir.com/followers?source=post_page---post_publication_info--4be7ac62ac63---------------------------------------" data-discover="true">9.2K followers</a></span></div><div class="bg b bh ab eb ac rp"><span class="hj m" aria-hidden="true"><span class="bg b bh ab eb">·</span></span><a class="ah ai aj fo al am an ao ap aq ar as at ku" rel="noopener follow" href="https://blog.palantir.com/introducing-pfcs-forward-d8755d34c429?source=post_page---post_publication_info--4be7ac62ac63---------------------------------------" data-discover="true">Last published&nbsp;<!-- -->4 days ago</a></div></div><div class="hz m"><p class="bg b bh ab bl"><span class="ia">Palantir Blog</span></p></div></div></div><div class="i l"><div class="ac"><button style="border: 1px solid rgba(34, 34, 34, 0.957);" class="xh yb aq ac ci r yc me yd"><span class="bg b bh ab bl bi"><span class="bn ye">Follow</span></span></button></div></div></div></div><div class="ac kj kh kf td ta"><div class="vr vs vt vu vv vw vx vy vz wa ac cw"><div class="i l"><a tabindex="0" href="https://palantir.medium.com/?source=post_page---post_author_info--4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="m fr"><img alt="Palantir" class="m fk by wb wc de" src="https://miro.medium.com/v2/resize:fill:96:96/1*yFp1VmXHPcrYrYrDNlD_7A.png" width="48" height="48" loading="lazy"><div class="gj by m wb wc fw o ak hy"></div></div></a></div><div class="k j e"><a tabindex="0" href="https://palantir.medium.com/?source=post_page---post_author_info--4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="m fr"><img alt="Palantir" class="m fk by wd we de" src="https://miro.medium.com/v2/resize:fill:128:128/1*yFp1VmXHPcrYrYrDNlD_7A.png" width="64" height="64" loading="lazy"><div class="gj by m wd we fw o ak hy"></div></div></a></div><div class="k j e tt cb"><div class="ac"><button class="xh yb aq ac ci r yc me yd" style="border: 1px solid rgba(24, 24, 24, 0.663);"><span class="bg b bh ab bl bi"><span class="bn ye">Follow</span></span></button></div></div></div><div class="ac cv cd"><div class="wf wg wh wi wj m"><a class="ah ai aj al am an ao ap aq ar as at au av ac r" href="https://palantir.medium.com/?source=post_page---post_author_info--4be7ac62ac63---------------------------------------" rel="noopener follow"><h2 class="pw-author-name bg gv wl wm wn wo wp wq ha hb hc hd he hf hg hh hi bl"><span class="ia wk">Written by <!-- -->Palantir</span></h2></a><div class="ue ac kl"><div class="m cb"><span class="pw-follower-count bg b bh ab eb"><a class="ah ai aj fo al am an ao ap aq ar as at ku" href="https://palantir.medium.com/followers?source=post_page---post_author_info--4be7ac62ac63---------------------------------------" rel="noopener follow">14.9K followers</a></span></div><div class="bg b bh ab eb ac rp"><span class="hj m" aria-hidden="true"><span class="bg b bh ab eb">·</span></span><a class="ah ai aj fo al am an ao ap aq ar as at ku" href="https://medium.com/@palantir/following?source=post_page---post_author_info--4be7ac62ac63---------------------------------------" rel="noopener follow">3 following</a></div></div><div class="hz m"></div></div></div><div class="i l"><div class="ac"><button class="xh yb aq ac ci r yc me yd" style="border: 1px solid rgba(24, 24, 24, 0.663);"><span class="bg b bh ab bl bi"><span class="bn ye">Follow</span></span></button></div></div></div></div></div></div><div class="wr ws wt wu wv m"><div class="ww bi s vp"></div><div class="ac ci"><div class="cp bi ig ih ii ij"><div class="ac r cw"><h2 class="bg gv pu pw gx px pz gz qa qc qd qe qg qh qi qk ql bl">Responses (<!-- -->1<!-- -->)</h2><div class="ac wx"><div><div class="bn" role="tooltip" aria-describedby="14" aria-labelledby="14"><div tabindex="-1" class="bf"><a class="wy wz" href="https://policy.medium.com/medium-rules-30e5502c4eb4?source=post_page---post_responses--4be7ac62ac63---------------------------------------" rel="noopener follow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" aria-label="Shield with a checkmark" viewBox="0 0 25 25"><path fill-rule="evenodd" d="M11.987 5.036a.754.754 0 0 1 .914-.01c.972.721 1.767 1.218 2.6 1.543.828.322 1.719.485 2.887.505a.755.755 0 0 1 .741.757c-.018 3.623-.43 6.256-1.449 8.21-1.034 1.984-2.662 3.209-4.966 4.083a.75.75 0 0 1-.537-.003c-2.243-.874-3.858-2.095-4.897-4.074-1.024-1.951-1.457-4.583-1.476-8.216a.755.755 0 0 1 .741-.757c1.195-.02 2.1-.182 2.923-.503.827-.322 1.6-.815 2.519-1.535m.468.903c-.897.69-1.717 1.21-2.623 1.564-.898.35-1.856.527-3.026.565.037 3.45.469 5.817 1.36 7.515.884 1.684 2.25 2.762 4.284 3.571 2.092-.81 3.465-1.89 4.344-3.575.886-1.698 1.299-4.065 1.334-7.512-1.149-.039-2.091-.217-2.99-.567-.906-.353-1.745-.873-2.683-1.561m-.009 9.155a2.672 2.672 0 1 0 0-5.344 2.672 2.672 0 0 0 0 5.344m0 1a3.672 3.672 0 1 0 0-7.344 3.672 3.672 0 0 0 0 7.344m-1.813-3.777.525-.526.916.917 1.623-1.625.526.526-2.149 2.152z" clip-rule="evenodd"></path></svg></a></div></div></div></div></div><div class="xa gn xb xc xd xe xf m"><div><div class="bg b bh ab bl"><div class="hm"><div class="zo m"><div class="zp ac r"><div class="m fr"><img alt="" class="m fk by bz ca de" width="32" height="32" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fill:32:32/1*dmbNkD5D-u45r44go_cf0g.png"><div class="gj by m bz ca fw o ak hy"></div></div><div class="bo ac cu cv ci"><p class="bg b bh ab eb">Write a response</p></div></div><div class="de bq ac cv zh zi"><div class="ac cv fr"><span data-dd-action-name="Susi presentation tracker respond_sidebar"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fblog.palantir.com%2Ftampering-with-windows-event-tracing-background-offense-and-defense-4be7ac62ac63&amp;source=---post_responses--4be7ac62ac63---------------------respond_sidebar------------------" rel="noopener follow"><div class="tg m"><p class="bg b bh ab eb">What are your thoughts?</p></div></a></span><div class="cw zj eb ac zk hs zl"><span class="bg b bh ab eb"><div class="ac"><div><div class="bn" aria-describedby="29" aria-labelledby="29" role="tooltip"><div tabindex="-1" class="bf"><span role="button" aria-label="Bold (⌘B)" class="zq zr zs zt bq nj ci zu zv zw" tabindex="0"><svg width="21" height="21"><path fill-rule="evenodd" d="M10.308 17.993h-5.92l.11-.894.783-.12c.56-.11.79-.224.79-.448V5.37c0-.225-.113-.336-.902-.448H4.5l-.114-.894h6.255c4.02 0 5.58 1.23 5.58 3.13 0 1.896-1.78 3.125-3.79 3.463v.11c2.69.34 4.25 1.56 4.25 3.57 0 2.35-2.01 3.69-6.37 3.69l.02.01h-.02zm-.335-12.96H8.967V10.5h1.23c1.788 0 2.79-1.23 2.79-2.683 0-1.685-1.004-2.803-3.006-2.803v.02zm-.223 6.36h-.783v5.588l1.225.23h.22c1.67 0 3.01-1.004 3.01-2.792 0-2.122-1.566-3.016-3.69-3.016h.018z"></path></svg></span></div></div></div><div><div class="bn" aria-describedby="30" aria-labelledby="30" role="tooltip"><div tabindex="-1" class="bf"><span role="button" aria-label="Italic (⌘I)" class="zq zr zs zt bq nj ci zu zv zw" tabindex="0"><svg width="21" height="21"><path fill-rule="evenodd" d="M9.847 18.04c-.533 0-2.027-.64-1.92-.853l2.027-7.68-.64-.214-1.387 1.494-.427-.427c.534-1.173 1.707-2.667 2.774-2.667.533 0 2.24.534 2.133.854l-2.133 7.786.533.214 1.6-1.067.427.427c-.64 1.066-1.92 2.133-2.987 2.133m2.347-11.733c-.96 0-1.387-.64-1.387-1.387 0-1.067.747-1.92 1.493-1.92.854 0 1.387.64 1.387 1.493-.107 1.067-.747 1.814-1.493 1.814"></path></svg></span></div></div></div></div></span><div class="zm tt ac zk hs zl"><div class="zn"><button class="bg b ec ab bl zx xg xh xi ni nf ua fc fd fe xj xk xl fh fi fj fk bn fl fm" data-testid="CancelResponseButton">Cancel</button></div><button class="bg b ec ab tu zx tw tx ty tz ua fc fd ub uc ud fh fi fj fk bn fl fm" disabled="" data-testid="ResponseRespondButton">Respond</button></div></div></div></div></div></div></div></div></div><div class="gn m"><div class="bi ed"><div class="abc abd m"><div class="ac cw"><div class="ac r"><div><div class="bn" aria-describedby="80" aria-labelledby="80" role="tooltip"><div tabindex="-1" class="bf"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://medium.com/@hannahsuarez?source=post_page---post_responses--4be7ac62ac63----0-----------------------------------" rel="noopener follow"><div class="m fr"><div class="m fr"><img alt="Hannah Suarez" class="m fk by bz ca de" width="32" height="32" loading="lazy" src="https://miro.medium.com/v2/resize:fill:32:32/1*N1-RG6h6avH7we0TMkDrIQ.jpeg"><div class="gj by m bz ca fw o ak gk"></div></div></div></a></div></div></div><div class="abe m"><div class="ac r"><div><div class="bn" aria-describedby="81" aria-labelledby="81" role="tooltip"><div tabindex="-1" class="bf"><a class="ah ai aj fo al am an ao ap aq ar as at au av ac r abf abg" href="https://medium.com/@hannahsuarez?source=post_page---post_responses--4be7ac62ac63----0-----------------------------------" rel="noopener follow"><div class="ac kl abf"><p class="bg b bh ab ga abh gm abi abj abk abl abm bl">Hannah Suarez</p></div></a></div></div></div></div><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://medium.com/@hannahsuarez/really-great-and-informative-blog-post-of-etw-related-attacks-9297f9cfc7ce?source=post_page---post_responses--4be7ac62ac63----0-----------------------------------" rel="noopener follow"><p class="bg b ec ab eb"><span>Apr 9, 2019</span></p></a></div></div><div class="bn"><button class="ah fs aj fo al am an np ap aq ar fe nq nr ng ns"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"></path></svg></button></div></div><div class="abn m ia"><pre class="rp"><div class="abo m"><div class="bg b bh ab bl"><div class="hm">Really great and informative blog post of ETW related attacks. I guess better analysis post attack is better when you can also forwarding the event trace sessions (though, not written here)?</div></div></div></pre></div><div class="abp ac r mf cw"><div class="ac r ae"><div class="ac r mf mg"><div class="pw-multi-vote-icon fr ahj mi mj mk"><span data-dd-action-name="Susi presentation tracker respond_sidebar"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2F9297f9cfc7ce&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40hannahsuarez%2Freally-great-and-informative-blog-post-of-etw-related-attacks-9297f9cfc7ce&amp;user=Hannah+Suarez&amp;userId=f50a07531859&amp;source=---post_responses--9297f9cfc7ce----0-----------------respond_sidebar------------------" rel="noopener follow"><div class="ml aq mm mn mo mp ao mq mr ms mk" role="presentation"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></a></span></div></div><p class="bg b ec ab bl"><button class="ah ai aj fo al am an ao ap aq ar as at pq">Reply</button></p></div></div></div></div></div></div></div></div><div class="xr xs xt xu xv m bx"><div class="ac ci"><div class="cp bi ig ih ii ij"><div class="abq abr dt du dv hz m"><h2 class="bg gv pu pw gx px pz gz qa qc qd qe qg qh qi qk ql bl">More from Palantir and Palantir Blog</h2></div><div class="abs ac mf kw abt abu abv abw abx aby abz aca acb acc acd ace acf acg ach"><div class="aci acj ack wj acl acm acn wi aco acp acq acr acs act acu acv acw acx acy acz ada"><div class="adb adc add ade adf ed m"><article class="ed" data-testid="post-preview"><div class="ed vf m"><div class="bi ed"><div class="ed m"></div></div></div></article></div></div><div class="aci acj ack wj acl acm acn wi aco acp acq acr acs act acu acv acw acx acy acz ada"><div class="adb adc add ade adf ed m"><article class="ed" data-testid="post-preview"><div class="ed vf m"><div class="bi ed"><div class="ed m"></div></div></div></article></div></div><div class="aci acj ack wj acl acm acn wi aco acp acq acr acs act acu acv acw acx acy acz ada"><div class="adb adc add ade adf ed m"><article class="ed" data-testid="post-preview"><div class="ed vf m"><div class="bi ed"><div class="ed m"></div></div></div></article></div></div><div class="aci acj ack wj acl acm acn wi aco acp acq acr acs act acu acv acw acx acy acz ada"><div class="adb adc add ade adf ed m"><article class="ed" data-testid="post-preview"><div class="ed vf m"><div class="bi ed"><div class="ed m"></div></div></div></article></div></div></div><div class="ww bi xw dr ds agq agr ags"></div><div class="ac ta td kf kh kj"><a class="bg b bh ab bl tv xg xh xi ni nf ua fc fd fe xj xk xl fh xm xn xo xp xq fi fj fk bn fl fm" href="https://palantir.medium.com/?source=post_page---author_recirc--4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="m fm">See all from Palantir</div></a><div class="agt agu agv agw agx agy agz aha ahb mz m"><a class="bg b bh ab bl tv xg xh xi ni nf ua fc fd fe xj xk xl fh xm xn xo xp xq fi fj fk bn fl fm" href="https://blog.palantir.com/?source=post_page---author_recirc--4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="m fm">See all from Palantir Blog</div></a></div></div></div></div><div class="ww bi xw ahc ahd ahe ahf ahg"></div><div class="ac ci"><div class="cp bi ig ih ii ij"><div class="ahh ahi m"><h2 class="bg gv pu pw gx px pz gz qa qc qd qe qg qh qi qk ql bl">Recommended from Medium</h2><div class="re rf rg rh ri m"><div class="abs ac mf kw abt abu abv abw abx aby abz aca acb acc acd ace acf acg ach"><div class="aci acj ack wj acl acm acn wi aco acp acq acr acs act acu acv acw acx acy acz ada"><div class="adb adc add ade adf ed m"><article class="ed" data-testid="post-preview"><div class="ed vf m"><div class="bi ed"><div class="ed m"></div></div></div></article></div></div><div class="aci acj ack wj acl acm acn wi aco acp acq acr acs act acu acv acw acx acy acz ada"><div class="adb adc add ade adf ed m"><article class="ed" data-testid="post-preview"><div class="ed vf m"><div class="bi ed"><div class="ed m"></div></div></div></article></div></div></div></div><div class="abs ac mf kw abt abu abv abw abx aby abz aca acb acc acd ace acf acg ach"><div class="aci acj ack wj acl acm acn wi aco acp acq acr acs act acu acv acw acx acy acz ada"><div class="adb adc add ade adf ed m"><article class="ed" data-testid="post-preview"><div class="ed vf m"><div class="bi ed"><div class="ed m"></div></div></div></article></div></div><div class="aci acj ack wj acl acm acn wi aco acp acq acr acs act acu acv acw acx acy acz ada"><div class="adb adc add ade adf ed m"><article class="ed" data-testid="post-preview"><div class="ed vf m"><div class="bi ed"><div class="ed m"></div></div></div></article></div></div><div class="aci acj ack wj acl acm acn wi aco acp acq acr acs act acu acv acw acx acy acz ada"><div class="adb adc add ade adf ed m"><article class="ed" data-testid="post-preview"><div class="ed vf m"><div class="bi ed"><div class="ed m"></div></div></div></article></div></div><div class="aci acj ack wj acl acm acn wi aco acp acq acr acs act acu acv acw acx acy acz ada"><div class="adb adc add ade adf ed m"><article class="ed" data-testid="post-preview"><div class="ed vf m"><div class="bi ed"><div class="ed m"></div></div></div></article></div></div></div><div class="ww bi xw dr ds agq agr ags"></div><a class="bg b bh ab bl tv xg xh xi ni nf ua fc fd fe xj xk xl fh xm xn xo xp xq fi fj fk bn fl fm" href="https://medium.com/?source=post_page---read_next_recirc--4be7ac62ac63---------------------------------------" rel="noopener follow"><div class="m fm">See more recommendations</div></a></div></div></div><div class="i l k"><div class="ww bi xw xx"></div><div class="ac ci"><div class="cp bi ig ih ii ij"><div class="xy ac mf kw"><div class="xz ya m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://help.medium.com/hc/en-us?source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Help</p></a></div><div class="xz ya m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://status.medium.com/?source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Status</p></a></div><div class="xz ya m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://medium.com/about?autoplay=1&amp;source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">About</p></a></div><div class="xz ya m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Careers</p></a></div><div class="xz ya m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="mailto:pressinquiries@medium.com" rel="noopener follow"><p class="bg b ec ab eb">Press</p></a></div><div class="xz ya m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://blog.medium.com/?source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Blog</p></a></div><div class="xz ya m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Privacy</p></a></div><div class="xz ya m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://policy.medium.com/medium-rules-30e5502c4eb4?source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Rules</p></a></div><div class="xz ya m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Terms</p></a></div><div class="xz m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://speechify.com/medium?source=post_page-----4be7ac62ac63---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Text to speech</p></a></div></div></div></div></div></div></div></div></div></div></div></div>





































<div height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" data-original-tag="iframe"></div>
<div><div class="grecaptcha-badge" data-style="bottomright" style="width: 256px; height: 60px; display: block; transition: right 0.3s; position: fixed; bottom: 14px; right: -186px; box-shadow: gray 0px 0px 5px; border-radius: 2px; overflow: hidden;"><div class="grecaptcha-logo"><div title="reCAPTCHA" width="256" height="60" role="presentation" name="a-6rdia4fzo56h" frameborder="0" scrolling="no" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-top-navigation allow-modals allow-popups-to-escape-sandbox allow-storage-access-by-user-activation" src="https://www.google.com/recaptcha/enterprise/anchor?ar=1&amp;k=6Le-uGgpAAAAAPprRaokM8AKthQ9KNGdoxaGUvVp&amp;co=aHR0cHM6Ly9ibG9nLnBhbGFudGlyLmNvbTo0NDM.&amp;hl=en&amp;v=vUgXt_KV952_-5BB2jjloYzl&amp;size=invisible&amp;anchor-ms=20000&amp;execute-ms=30000&amp;cb=andr678fm42b" data-original-tag="iframe">

<title>reCAPTCHA</title>

<link rel="stylesheet" type="text/css" href="https://www.gstatic.com/recaptcha/releases/vUgXt_KV952_-5BB2jjloYzl/styles__ltr.css">


<div id="rc-anchor-alert" class="rc-anchor-alert"></div>

<div class="rc-anchor rc-anchor-invisible rc-anchor-light  rc-anchor-invisible-hover"><div id="recaptcha-accessible-status" class="rc-anchor-aria-status" aria-hidden="true">Recaptcha requires verification. </div><div class="rc-anchor-error-msg-container" style="display:none"><span class="rc-anchor-error-msg" aria-hidden="true"></span></div><div class="rc-anchor-normal-footer"><div class="rc-anchor-logo-large" role="presentation"><div class="rc-anchor-logo-img rc-anchor-logo-img-large"></div></div><div class="rc-anchor-pt"><a href="https://www.google.com/intl/en/policies/privacy/" target="_blank">Privacy</a><span aria-hidden="true" role="presentation"> - </span><a href="https://www.google.com/intl/en/policies/terms/" target="_blank">Terms</a></div></div><div class="rc-anchor-invisible-text"><span>protected by <strong>reCAPTCHA</strong></span><div class="rc-anchor-pt"><a href="https://www.google.com/intl/en/policies/privacy/" target="_blank" style="">Privacy</a><span aria-hidden="true" role="presentation"> - </span><a href="https://www.google.com/intl/en/policies/terms/" target="_blank" style="">Terms</a></div></div></div><div style="display: none;" data-original-tag="iframe"></div></div></div><div class="grecaptcha-error"></div><textarea id="g-recaptcha-response-100000" name="g-recaptcha-response" class="g-recaptcha-response" style="width: 250px; height: 40px; border: 1px solid rgb(193, 193, 193); margin: 10px 25px; padding: 0px; resize: none; display: none;"></textarea></div><div style="display: none;" data-original-tag="iframe"></div></div></body></html>