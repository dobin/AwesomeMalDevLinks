# https://fluxsec.red/event-tracing-for-windows-threat-intelligence-rust-consumer

<!DOCTYPE html><html lang="en" class="fontawesome-i2svg-active fontawesome-i2svg-complete" dir="ltr" data-cast-api-enabled="true">
<body class="date-20260218 en_US ltr  site-center-aligned site-as-giant-card webkit webkit-537" dir="ltr">
    <div class="container">
        
          
        <main class="main-content">
            <h1>Reading Event Tracing for Windows Threat Intelligence </h1>
            <p class="description">Malware thought it could sneak past your EDR. Spoiler: It didn’t. Here’s how to make it regret its life choices.</p>
            <hr>
            <h2 id="intro">Intro</h2>

<p>Now we can get into some more really cool stuff by utilising the Event Tracing for Windows: Threat Intelligence (ETW:TI) provider. I have actually talked about bypassing
ETW in my blog post <a href="https://fluxsec.red/etw-patching-rust" target="_blank">EDR Evasion ETW patching in Rust</a>.</p>

<p>That post deals with patching out certain telemetry signals from a usermode process, blinding the EDR to those signals. However; as stated there, we cannot patch out the
Threat Intelligence provider as this is emitted from within the kernel itself. To do so, you’d require kernelmode execution and then to patch out those signals so no
ETW signals are emitted.</p>

<p>I’ve made a short proof of concept video you can checkout on my YouTube channel:</p>

<div width="560" height="315" src="https://www.youtube.com/embed/t2qx0xTDnCI?si=WteNqKFmYVcxq_bz" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen="" data-original-tag="iframe"><link rel="stylesheet" href="https://www.youtube.com/s/player/a944b11f/www-player.css" name="www-player" nonce="kWnBxIVM_tDmx35XEuBQUg"><link rel="preload" href="https://www.youtube.com/s/player/a944b11f/player_es6.vflset/en_US/embed.js" name="player/embed" as="script" nonce="kWnBxIVM_tDmx35XEuBQUg"><link rel="preconnect" href="https://i.ytimg.com/"><title>Event Tracing for Windows Threat Intelligence for a Rust EDR - YouTube</title><link rel="canonical" href="https://www.youtube.com/watch?v=t2qx0xTDnCI"><div id="player" style="width: 100%; height: 100%;"><div class="html5-video-player ytp-exp-bottom-control-flexbox ytp-modern-caption ytp-livebadge-color ytp-title-enable-channel-logo ytp-fine-scrubbing-exp ytp-embed ytp-embed-playlist ytp-cards-teaser-dismissible unstarted-mode ytp-hide-controls" tabindex="-1" id="movie_player" data-version="/s/player/a944b11f/player_es6.vflset/en_US/base.js" aria-label="YouTube Video Player"><div class="html5-video-container" data-layer="0"><video tabindex="-1" aria-hidden="true" class="video-stream html5-main-video" webkit-playsinline="" playsinline="" controlslist="nodownload" style="width: 560px; height: 315px; left: 0px; top: -315px;"></video></div><div class="ytp-gradient-top" data-layer="1"></div><div class="ytp-chrome-top ytp-show-cards-title" data-layer="1"><div class="ytp-title-channel"><div class="ytp-title-beacon"></div><a class="ytp-title-channel-logo" target="_blank" role="link" tabindex="0" href="https://www.youtube.com/channel/UCQMxJOLahofVDOQClNRqLJw?embeds_referring_euri=https%3A%2F%2Ffluxsec.red%2F" aria-label="Photo image of FluxSec" style="background-image: url(&quot;https://yt3.ggpht.com/CocLowJPboAjZT705S6NWdNho5IeOmfRZBgpO0Cnda8E-_E1FMvcwSD28hm3qfOykqgE0xSwiQ=s68-c-k-c0x00ffffff-no-rj&quot;);"></a><div class="ytp-title-expanded-overlay" aria-hidden="true"><div class="ytp-title-expanded-heading"><div class="ytp-title-expanded-title"><a target="_blank" tabindex="-1" aria-hidden="true">FluxSec</a></div><div class="ytp-title-expanded-subtitle" aria-hidden="true">418 subscribers</div></div></div></div><div class="ytp-title"><div class="ytp-title-text "><a class="ytp-title-link yt-uix-sessionlink" target="_blank" data-sessionlink="feature=player-title" tabindex="0" href="https://www.youtube.com/watch?v=t2qx0xTDnCI">Event Tracing for Windows Threat Intelligence for a Rust EDR</a><div class="ytp-title-subtext"><a class="ytp-title-channel-name" target="_blank" href="https://www.youtube.com/embed/t2qx0xTDnCI?si=WteNqKFmYVcxq_bz"></a></div></div></div><div class="ytp-shorts-title-channel" style="display: none;"><a class="ytp-shorts-title-channel-logo" target="_blank" aria-label="Photo image of FluxSec" style="background-image: url(&quot;https://yt3.ggpht.com/CocLowJPboAjZT705S6NWdNho5IeOmfRZBgpO0Cnda8E-_E1FMvcwSD28hm3qfOykqgE0xSwiQ=s68-c-k-c0x00ffffff-no-rj&quot;);"></a><div class="ytp-shorts-title-expanded-heading"><div class="ytp-shorts-title-expanded-title"><a target="_blank" tabindex="0">FluxSec</a></div></div></div><div class="ytp-chrome-top-buttons"><button class="ytp-button ytp-search-button ytp-show-search-title" title="" data-tooltip-title="Search" data-tooltip-opaque="true" aria-label="Search" style="display: none;"><div class="ytp-search-icon"><svg height="100%" version="1.1" viewBox="0 0 24 24" width="100%"><path class="ytp-svg-fill" d="M21.24,19.83l-5.64-5.64C16.48,13.02,17,11.57,17,10c0-3.87-3.13-7-7-7s-7,3.13-7,7c0,3.87,3.13,7,7,7 c1.57,0,3.02-0.52,4.19-1.4l5.64,5.64L21.24,19.83z M5,10c0-2.76,2.24-5,5-5s5,2.24,5,5c0,2.76-2.24,5-5,5S5,12.76,5,10z"></path></svg></div><div class="ytp-search-title">Search</div></button><button class="ytp-watch-later-button ytp-button ytp-show-watch-later-title" title="" data-tooltip-opaque="true" data-tooltip-title="Watch later" aria-label="Watch later" style="display: none;"><div class="ytp-watch-later-icon"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-26"></use><path class="ytp-svg-fill" d="M18,8 C12.47,8 8,12.47 8,18 C8,23.52 12.47,28 18,28 C23.52,28 28,23.52 28,18 C28,12.47 23.52,8 18,8 L18,8 Z M16,19.02 L16,12.00 L18,12.00 L18,17.86 L23.10,20.81 L22.10,22.54 L16,19.02 Z" id="ytp-id-26"></path></svg></div><div class="ytp-watch-later-title">Watch later</div></button><button class="ytp-button ytp-share-button ytp-show-share-title ytp-share-button-visible" title="" data-tooltip-title="Share" aria-haspopup="true" aria-owns="ytp-id-25" data-tooltip-opaque="true" aria-label="Share"><div class="ytp-share-icon"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-27"></use><path class="ytp-svg-fill" d="m 20.20,14.19 0,-4.45 7.79,7.79 -7.79,7.79 0,-4.56 C 16.27,20.69 12.10,21.81 9.34,24.76 8.80,25.13 7.60,27.29 8.12,25.65 9.08,21.32 11.80,17.18 15.98,15.38 c 1.33,-0.60 2.76,-0.98 4.21,-1.19 z" id="ytp-id-27"></path></svg></div><div class="ytp-share-title">Share</div></button><button class="ytp-button ytp-copylink-button ytp-show-copylink-title" title="" data-tooltip-opaque="true" data-tooltip-title="Copy link" aria-label="Copy link" style="display: none;"><div class="ytp-copylink-icon"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-28"></use><path class="ytp-svg-fill" d="M21.9,8.3H11.3c-0.9,0-1.7,.8-1.7,1.7v12.3h1.7V10h10.6V8.3z M24.6,11.8h-9.7c-1,0-1.8,.8-1.8,1.8v12.3  c0,1,.8,1.8,1.8,1.8h9.7c1,0,1.8-0.8,1.8-1.8V13.5C26.3,12.6,25.5,11.8,24.6,11.8z M24.6,25.9h-9.7V13.5h9.7V25.9z" id="ytp-id-28"></path></svg></div><div class="ytp-copylink-title" aria-hidden="true">Copy link</div></button><button class="ytp-playlist-menu-button ytp-button" title="" aria-owns="ytp-id-22" aria-haspopup="true" aria-label="Playlist" data-overlay-order="3" style="display: none;"><div class="ytp-playlist-menu-button-icon"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-23"></use><path d="m 22.53,21.42 0,6.85 5.66,-3.42 -5.66,-3.42 0,0 z m -11.33,0 9.06,0 0,2.28 -9.06,0 0,-2.28 0,0 z m 0,-9.14 13.6,0 0,2.28 -13.6,0 0,-2.28 0,0 z m 0,4.57 13.6,0 0,2.28 -13.6,0 0,-2.28 0,0 z" fill="#fff" id="ytp-id-23"></path></svg></div><div class="ytp-playlist-menu-button-title"></div><div class="ytp-playlist-menu-button-text"></div></button><button class="ytp-button ytp-cards-button" aria-label="Show cards" aria-owns="iv-drawer" aria-haspopup="true" data-tooltip-opaque="true" style="display: none;"><span class="ytp-cards-button-icon-default"><div class="ytp-cards-button-icon"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-2"></use><path class="ytp-svg-fill" d="m 17,23 h 2 V 17 H 17 Z M 18,8 C 12.47,8 8,12.47 8,18 8,23.52 12.47,28 18,28 23.52,28 28,23.52 28,18 28,12.47 23.52,8 18,8 Z m 0,18 c -4.41,0 -8,-3.59 -8,-8 0,-4.41 3.59,-8 8,-8 4.41,0 8,3.59 8,8 0,4.41 -3.59,8 -8,8 z M 17,15 h 2 v -2 h -2 z" id="ytp-id-2"></path></svg></div><div class="ytp-cards-button-title">Info</div></span><span class="ytp-cards-button-icon-shopping"><div class="ytp-cards-button-icon"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><path class="ytp-svg-shadow" d="M 27.99,18 A 9.99,9.99 0 1 1 8.00,18 9.99,9.99 0 1 1 27.99,18 z"></path><path class="ytp-svg-fill" d="M 18,8 C 12.47,8 8,12.47 8,18 8,23.52 12.47,28 18,28 23.52,28 28,23.52 28,18 28,12.47 23.52,8 18,8 z m -4.68,4 4.53,0 c .35,0 .70,.14 .93,.37 l 5.84,5.84 c .23,.23 .37,.58 .37,.93 0,.35 -0.13,.67 -0.37,.90 L 20.06,24.62 C 19.82,24.86 19.51,25 19.15,25 c -0.35,0 -0.70,-0.14 -0.93,-0.37 L 12.37,18.78 C 12.13,18.54 12,18.20 12,17.84 L 12,13.31 C 12,12.59 12.59,12 13.31,12 z m .96,1.31 c -0.53,0 -0.96,.42 -0.96,.96 0,.53 .42,.96 .96,.96 .53,0 .96,-0.42 .96,-0.96 0,-0.53 -0.42,-0.96 -0.96,-0.96 z" fill-opacity="1"></path><path class="ytp-svg-shadow-fill" d="M 24.61,18.22 18.76,12.37 C 18.53,12.14 18.20,12 17.85,12 H 13.30 C 12.58,12 12,12.58 12,13.30 V 17.85 c 0,.35 .14,.68 .38,.92 l 5.84,5.85 c .23,.23 .55,.37 .91,.37 .35,0 .68,-0.14 .91,-0.38 L 24.61,20.06 C 24.85,19.83 25,19.50 25,19.15 25,18.79 24.85,18.46 24.61,18.22 z M 14.27,15.25 c -0.53,0 -0.97,-0.43 -0.97,-0.97 0,-0.53 .43,-0.97 .97,-0.97 .53,0 .97,.43 .97,.97 0,.53 -0.43,.97 -0.97,.97 z" fill="#000" fill-opacity="0.15"></path></svg></div><div class="ytp-cards-button-title">Shopping</div></span></button><div class="ytp-cards-teaser" style="display: none;"><div class="ytp-cards-teaser-box"></div><div class="ytp-cards-teaser-text"><button class="ytp-cards-teaser-info-icon" aria-label="Show cards" aria-haspopup="true"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-29"></use><path class="ytp-svg-fill" d="m 17,23 h 2 V 17 H 17 Z M 18,8 C 12.47,8 8,12.47 8,18 8,23.52 12.47,28 18,28 23.52,28 28,23.52 28,18 28,12.47 23.52,8 18,8 Z m 0,18 c -4.41,0 -8,-3.59 -8,-8 0,-4.41 3.59,-8 8,-8 4.41,0 8,3.59 8,8 0,4.41 -3.59,8 -8,8 z M 17,15 h 2 v -2 h -2 z" id="ytp-id-29"></path></svg></button><img class="ytp-cards-teaser-channel-avatar" alt="" aria-hidden="true"><span class="ytp-cards-teaser-label"></span><button class="ytp-cards-teaser-close-button" aria-label="Close"><svg height="100%" viewBox="0 0 24 24" width="100%"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="#fff"></path></svg></button></div></div><button class="ytp-button ytp-overflow-button" title="" data-tooltip-title="More" aria-haspopup="true" aria-owns="ytp-id-30" aria-label="More" style="display: none;"><div class="ytp-overflow-icon"><svg height="100%" viewBox="-5 -5 36 36" width="100%"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" fill="#fff"></path></svg></div></button></div></div><button class="ytp-unmute ytp-popup ytp-button ytp-unmute-animated ytp-unmute-shrink" data-layer="2" style="display: none;"><div class="ytp-unmute-inner"><div class="ytp-unmute-icon"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-1"></use><path class="ytp-svg-fill" d="m 21.48,17.98 c 0,-1.77 -1.02,-3.29 -2.5,-4.03 v 2.21 l 2.45,2.45 c .03,-0.2 .05,-0.41 .05,-0.63 z m 2.5,0 c 0,.94 -0.2,1.82 -0.54,2.64 l 1.51,1.51 c .66,-1.24 1.03,-2.65 1.03,-4.15 0,-4.28 -2.99,-7.86 -7,-8.76 v 2.05 c 2.89,.86 5,3.54 5,6.71 z M 9.25,8.98 l -1.27,1.26 4.72,4.73 H 7.98 v 6 H 11.98 l 5,5 v -6.73 l 4.25,4.25 c -0.67,.52 -1.42,.93 -2.25,1.18 v 2.06 c 1.38,-0.31 2.63,-0.95 3.69,-1.81 l 2.04,2.05 1.27,-1.27 -9,-9 -7.72,-7.72 z m 7.72,.99 -2.09,2.08 2.09,2.09 V 9.98 z" id="ytp-id-1"></path></svg></div><div class="ytp-unmute-text">Tap to unmute</div><div class="ytp-unmute-box"></div></div></button><div class="ytp-player-content ytp-timely-actions-content" data-layer="4" style="display: none;"></div><div class="ytp-cued-thumbnail-overlay" data-layer="4" style=""><div class="ytp-cued-thumbnail-overlay-image" style="background-image: url(&quot;https://i.ytimg.com/vi/t2qx0xTDnCI/sddefault.jpg?sqp=-oaymwEmCIAFEOAD8quKqQMa8AEB-AH-CYAC0AWKAgwIABABGGUgUyhGMA8=&amp;rs=AOn4CLA8jmZcsctt4H3PGB3djxu1rMbOOQ&quot;);"></div><button class="ytp-large-play-button ytp-button ytp-large-play-button-red-bg" aria-label="Play" title="Play"><svg height="100%" version="1.1" viewBox="0 0 68 48" width="100%"><path class="ytp-large-play-button-bg" d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z" fill="#f03"></path><path d="M 45,24 27,14 27,34" fill="#fff"></path></svg></button></div><div class="ytp-spinner" data-layer="4" style="display: none;"><div class="ytp-spinner-container"><div class="ytp-spinner-rotator"><div class="ytp-spinner-left"><div class="ytp-spinner-circle"></div></div><div class="ytp-spinner-right"><div class="ytp-spinner-circle"></div></div></div></div><div class="ytp-spinner-message" style="display: none;">If playback doesn't begin shortly, try restarting your device.</div></div><div class="ytp-paid-content-overlay" aria-live="assertive" aria-atomic="true" data-overlay-order="5" data-layer="4"><div class="ytp-button ytp-paid-content-overlay-text" style="display: none;"></div></div><div class="ytp-storyboard-framepreview" data-layer="4" style="display: none;"><div class="ytp-storyboard-framepreview-timestamp"></div><div class="ytp-storyboard-framepreview-img"></div></div><div data-layer="4" style="display: none;"><div class="ytp-bezel-text-wrapper"><div class="ytp-bezel-text"></div></div><div class="ytp-bezel" role="status"><div class="ytp-bezel-icon"></div></div></div><div class="ytp-doubletap-ui-legacy" data-layer="4" style="display: none;"><div class="ytp-doubletap-fast-forward-ve"></div><div class="ytp-doubletap-rewind-ve"></div><div class="ytp-doubletap-static-circle"><div class="ytp-doubletap-ripple"></div></div><div class="ytp-doubletap-overlay-a11y"></div><div class="ytp-doubletap-seek-info-container"><div class="ytp-doubletap-arrows-container"><span class="ytp-doubletap-base-arrow"></span><span class="ytp-doubletap-base-arrow"></span><span class="ytp-doubletap-base-arrow"></span></div><div class="ytp-doubletap-tooltip"><div class="ytp-seek-icon-text-container"><div class="ytp-seek-icon" style="display: none;"></div><div class="ytp-chapter-seek-text-legacy"></div></div><div class="ytp-doubletap-tooltip-label"></div></div></div></div><div data-layer="4" aria-live="polite" style="display: none;"><div class="ytp-tooltip-text-wrapper"><div class="ytp-tooltip-edu"><svg height="100%" viewBox="0 0 36 36" width="100%"><path d="M14.1 36.75 12 34.65 24 22.65 36 34.65 33.9 36.75 24 26.85ZM14.1 24.1 12 22 24 10 36 22 33.9 24.1 24 14.2Z"></path></svg><span></span></div><div class="ytp-tooltip-image"></div><div class="ytp-tooltip-title"><span></span><div class="ytp-tooltip-keyboard-shortcut"></div></div><div class="ytp-tooltip-bottom-text"><span class="ytp-tooltip-text"></span><div class="ytp-tooltip-keyboard-shortcut"></div></div><div class="ytp-tooltip-progress-bar-pill"><div class="ytp-tooltip-progress-bar-pill-time-stamp"></div><div class="ytp-tooltip-progress-bar-pill-title"></div></div></div><div class="ytp-tooltip-bg"><div class="ytp-tooltip-duration"></div></div></div><div class="ytp-suggested-action" data-overlay-order="7" data-layer="4"><button class="ytp-button ytp-suggested-action-badge ytp-suggested-action-badge-with-controls" style="display: none;"><div class="ytp-suggested-action-badge-icon-container"></div><div class="ytp-suggested-action-badge-expanded-content-container" style="display: none;"><label class="ytp-suggested-action-badge-title"></label></div></button><button class="ytp-suggested-action-badge-dismiss-button-icon ytp-button"></button></div></div><button class="ytp-info-panel-preview" aria-live="assertive" aria-atomic="true" aria-owns="ytp-id-31" aria-haspopup="true" data-tooltip-opaque="true" data-layer="4" style="display: none;"><div class="ytp-info-panel-preview-text"></div><div class="ytp-info-panel-preview-chevron"></div></button><div class="ytp-pause-overlay-container" tabindex="-1" data-layer="4"><div class="ytp-pause-overlay" tabindex="-1" style="display: none;"><button class="ytp-button ytp-collapse" aria-label="Hide more videos"><div class="ytp-collapse-icon"><svg height="100%" viewBox="0 0 16 16" width="100%"><path d="M13 4L12 3 8 7 4 3 3 4 7 8 3 12 4 13 8 9 12 13 13 12 9 8z" fill="#fff"></path></svg></div></button><button class="ytp-button ytp-expand">More videos</button><div class="ytp-more-videos-view ytp-scroll-min ytp-scroll-max" tabindex="-1"><h2 class="ytp-related-title">More videos</h2><div class="ytp-suggestions" style="height: 89px;"><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.05s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.1s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.15s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.2s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.25s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.3s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.35s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.4s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.45s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.5s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.55s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.6s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.65s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.7s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a><a class="ytp-suggestion-link" target="_blank" style="transition-delay: 0.75s; display: none;"><div class="ytp-suggestion-image" style="width: 159.333px; height: 89px;"></div><div class="ytp-suggestion-overlay" style=""><div class="ytp-suggestion-title"></div><div class="ytp-suggestion-author"></div><div class="ytp-suggestion-duration"></div></div></a></div><button class="ytp-button ytp-previous" aria-label="Show previous suggested videos" style="bottom: 60.5px;"><svg height="100%" version="1.1" viewBox="0 0 32 32" width="100%"><path d="M 19.41,20.09 14.83,15.5 19.41,10.91 18,9.5 l -6,6 6,6 z" fill="#fff"></path></svg></button><button class="ytp-button ytp-next" aria-label="Show more suggested videos" style="bottom: 60.5px;"><svg height="100%" version="1.1" viewBox="0 0 32 32" width="100%"><path d="m 12.59,20.34 4.58,-4.59 -4.58,-4.59 1.41,-1.41 6,6 -6,6 z" fill="#fff"></path></svg></button></div></div></div><div class="ytp-muted-autoplay-overlay" data-layer="4" style="display: none;"><div class="ytp-muted-autoplay-bottom-buttons"><button class="ytp-muted-autoplay-equalizer ytp-button" aria-label="Muted Playback Indicator"><div class="ytp-muted-autoplay-equalizer-icon"><svg height="100%" version="1.1" viewBox="-4 -4 24 24" width="100%"><g fill="#fff"><rect class="ytp-equalizer-bar-left" height="9" width="4" x="1" y="7"></rect><rect class="ytp-equalizer-bar-middle" height="14" width="4" x="6" y="2"></rect><rect class="ytp-equalizer-bar-right" height="12" width="4" x="11" y="4"></rect></g></svg></div></button></div></div><div class="ytp-muted-autoplay-endscreen-overlay" data-layer="4" style="display: none;"><div class="ytp-muted-autoplay-end-panel"><button class="ytp-muted-autoplay-end-text ytp-button"></button></div></div><div class="ytp-remote" data-layer="4" style="display: none;"><div class="ytp-remote-display-status"><div class="ytp-remote-display-status-icon"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-34"></use><path d="M7,24 L7,27 L10,27 C10,25.34 8.66,24 7,24 L7,24 Z M7,20 L7,22 C9.76,22 12,24.24 12,27 L14,27 C14,23.13 10.87,20 7,20 L7,20 Z M25,13 L11,13 L11,14.63 C14.96,15.91 18.09,19.04 19.37,23 L25,23 L25,13 L25,13 Z M7,16 L7,18 C11.97,18 16,22.03 16,27 L18,27 C18,20.92 13.07,16 7,16 L7,16 Z M27,9 L9,9 C7.9,9 7,9.9 7,11 L7,14 L9,14 L9,11 L27,11 L27,25 L20,25 L20,27 L27,27 C28.1,27 29,26.1 29,25 L29,11 C29,9.9 28.1,9 27,9 L27,9 Z" fill="#fff" id="ytp-id-34"></path></svg></div><div class="ytp-remote-display-status-text"></div></div></div><div class="ytp-mdx-popup-dialog" role="dialog" data-layer="4" style="display: none;"><div class="ytp-mdx-popup-dialog-inner-content"><div class="ytp-mdx-popup-title">You're signed out</div><div class="ytp-mdx-popup-description">Videos you watch may be added to the TV's watch history and influence TV recommendations. To avoid this, cancel and sign in to YouTube on your computer.</div><div class="ytp-mdx-privacy-popup-buttons"><button class="ytp-button ytp-mdx-privacy-popup-cancel">Cancel</button><button class="ytp-button ytp-mdx-privacy-popup-confirm">Confirm</button></div></div></div><div class="ytp-playlist-menu" role="dialog" id="ytp-id-22" data-layer="5" style="display: none;"><div class="ytp-playlist-menu-header"><div class="ytp-playlist-menu-title"><a class="ytp-playlist-menu-title-name"></a><button class="ytp-playlist-menu-close ytp-button" aria-label="Close"><svg height="100%" viewBox="0 0 24 24" width="100%"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="#fff"></path></svg></button></div><div class="ytp-playlist-menu-subtitle"></div></div><div class="ytp-playlist-menu-items" role="menu"></div></div><div class="ytp-share-panel" id="ytp-id-25" role="dialog" aria-labelledby="ytp-id-24" data-layer="5" style="display: none;"><div class="ytp-share-panel-inner-content"><div class="ytp-share-panel-title" id="ytp-id-24">Share</div><a class="ytp-share-panel-link ytp-no-contextmenu" target="_blank" title="Share link"></a><label class="ytp-share-panel-include-playlist"><input class="ytp-share-panel-include-playlist-checkbox" type="checkbox" checked="true">Include playlist</label><div class="ytp-share-panel-loading-spinner"><div class="ytp-spinner-container"><div class="ytp-spinner-rotator"><div class="ytp-spinner-left"><div class="ytp-spinner-circle"></div></div><div class="ytp-spinner-right"><div class="ytp-spinner-circle"></div></div></div></div></div><div class="ytp-share-panel-service-buttons"></div><div class="ytp-share-panel-error">An error occurred while retrieving sharing information. Please try again later.</div></div><button class="ytp-share-panel-close ytp-button" title="Close"><svg height="100%" viewBox="0 0 24 24" width="100%"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="#fff"></path></svg></button></div><div class="ytp-overflow-panel" id="ytp-id-30" role="dialog" data-layer="5" style="display: none;"><div class="ytp-overflow-panel-content"><div class="ytp-overflow-panel-action-buttons"></div></div><button class="ytp-overflow-panel-close ytp-button" data-tooltip-title="Close" title="" aria-label="Close"><svg height="100%" viewBox="0 0 24 24" width="100%"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="#fff"></path></svg></button></div><div class="ytp-info-panel-detail-skrim" data-layer="5" style="display: none;"><div class="ytp-info-panel-detail" role="dialog" id="ytp-id-31"><div class="ytp-info-panel-detail-header"><div class="ytp-info-panel-detail-title"></div><button class="ytp-info-panel-detail-close ytp-button" aria-label="Close"><svg height="100%" viewBox="0 0 24 24" width="100%"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="#fff"></path></svg></button></div><div class="ytp-info-panel-detail-body"></div><div class="ytp-info-panel-detail-items"></div></div></div><div class="ytp-popup ytp-settings-menu" data-layer="6" id="ytp-id-17" style="display: none;"><div class="ytp-focus-trap-before" tabindex="0"></div><div class="ytp-popup-content"><div class="ytp-panel"><div class="ytp-panel-menu" role="menu"></div></div></div><div class="ytp-focus-trap-after" tabindex="0"></div></div><a class="ytp-impression-link" aria-label="Watch on YouTube" target="_blank" href="https://www.youtube.com/watch?v=t2qx0xTDnCI&amp;embeds_referring_euri=https%3A%2F%2Ffluxsec.red%2F" data-layer="8"><div class="ytp-impression-link-content" aria-hidden="true"><div class="ytp-impression-link-text">Watch on</div><div class="ytp-impression-link-logo"><svg height="100%" version="1.1" viewBox="0 0 110 26" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-33"></use><path class="ytp-svg-fill" d="M 16.68,.99 C 13.55,1.03 7.02,1.16 4.99,1.68 c -1.49,.4 -2.59,1.6 -2.99,3 -0.69,2.7 -0.68,8.31 -0.68,8.31 0,0 -0.01,5.61 .68,8.31 .39,1.5 1.59,2.6 2.99,3 2.69,.7 13.40,.68 13.40,.68 0,0 10.70,.01 13.40,-0.68 1.5,-0.4 2.59,-1.6 2.99,-3 .69,-2.7 .68,-8.31 .68,-8.31 0,0 .11,-5.61 -0.68,-8.31 -0.4,-1.5 -1.59,-2.6 -2.99,-3 C 29.11,.98 18.40,.99 18.40,.99 c 0,0 -0.67,-0.01 -1.71,0 z m 72.21,.90 0,21.28 2.78,0 .31,-1.37 .09,0 c .3,.5 .71,.88 1.21,1.18 .5,.3 1.08,.40 1.68,.40 1.1,0 1.99,-0.49 2.49,-1.59 .5,-1.1 .81,-2.70 .81,-4.90 l 0,-2.40 c 0,-1.6 -0.11,-2.90 -0.31,-3.90 -0.2,-0.89 -0.5,-1.59 -1,-2.09 -0.5,-0.4 -1.10,-0.59 -1.90,-0.59 -0.59,0 -1.18,.19 -1.68,.49 -0.49,.3 -1.01,.80 -1.21,1.40 l 0,-7.90 -3.28,0 z m -49.99,.78 3.90,13.90 .18,6.71 3.31,0 0,-6.71 3.87,-13.90 -3.37,0 -1.40,6.31 c -0.4,1.89 -0.71,3.19 -0.81,3.99 l -0.09,0 c -0.2,-1.1 -0.51,-2.4 -0.81,-3.99 l -1.37,-6.31 -3.40,0 z m 29.59,0 0,2.71 3.40,0 0,17.90 3.28,0 0,-17.90 3.40,0 c 0,0 .00,-2.71 -0.09,-2.71 l -9.99,0 z m -53.49,5.12 8.90,5.18 -8.90,5.09 0,-10.28 z m 89.40,.09 c -1.7,0 -2.89,.59 -3.59,1.59 -0.69,.99 -0.99,2.60 -0.99,4.90 l 0,2.59 c 0,2.2 .30,3.90 .99,4.90 .7,1.1 1.8,1.59 3.5,1.59 1.4,0 2.38,-0.3 3.18,-1 .7,-0.7 1.09,-1.69 1.09,-3.09 l 0,-0.5 -2.90,-0.21 c 0,1 -0.08,1.6 -0.28,2 -0.1,.4 -0.5,.62 -1,.62 -0.3,0 -0.61,-0.11 -0.81,-0.31 -0.2,-0.3 -0.30,-0.59 -0.40,-1.09 -0.1,-0.5 -0.09,-1.21 -0.09,-2.21 l 0,-0.78 5.71,-0.09 0,-2.62 c 0,-1.6 -0.10,-2.78 -0.40,-3.68 -0.2,-0.89 -0.71,-1.59 -1.31,-1.99 -0.7,-0.4 -1.48,-0.59 -2.68,-0.59 z m -50.49,.09 c -1.09,0 -2.01,.18 -2.71,.68 -0.7,.4 -1.2,1.12 -1.49,2.12 -0.3,1 -0.5,2.27 -0.5,3.87 l 0,2.21 c 0,1.5 .10,2.78 .40,3.78 .2,.9 .70,1.62 1.40,2.12 .69,.5 1.71,.68 2.81,.78 1.19,0 2.08,-0.28 2.78,-0.68 .69,-0.4 1.09,-1.09 1.49,-2.09 .39,-1 .49,-2.30 .49,-3.90 l 0,-2.21 c 0,-1.6 -0.2,-2.87 -0.49,-3.87 -0.3,-0.89 -0.8,-1.62 -1.49,-2.12 -0.7,-0.5 -1.58,-0.68 -2.68,-0.68 z m 12.18,.09 0,11.90 c -0.1,.3 -0.29,.48 -0.59,.68 -0.2,.2 -0.51,.31 -0.81,.31 -0.3,0 -0.58,-0.10 -0.68,-0.40 -0.1,-0.3 -0.18,-0.70 -0.18,-1.40 l 0,-10.99 -3.40,0 0,11.21 c 0,1.4 .18,2.39 .68,3.09 .49,.7 1.21,1 2.21,1 1.4,0 2.48,-0.69 3.18,-2.09 l .09,0 .31,1.78 2.59,0 0,-14.99 c 0,0 -3.40,.00 -3.40,-0.09 z m 17.31,0 0,11.90 c -0.1,.3 -0.29,.48 -0.59,.68 -0.2,.2 -0.51,.31 -0.81,.31 -0.3,0 -0.58,-0.10 -0.68,-0.40 -0.1,-0.3 -0.21,-0.70 -0.21,-1.40 l 0,-10.99 -3.40,0 0,11.21 c 0,1.4 .21,2.39 .71,3.09 .5,.7 1.18,1 2.18,1 1.39,0 2.51,-0.69 3.21,-2.09 l .09,0 .28,1.78 2.62,0 0,-14.99 c 0,0 -3.40,.00 -3.40,-0.09 z m 20.90,2.09 c .4,0 .58,.11 .78,.31 .2,.3 .30,.59 .40,1.09 .1,.5 .09,1.21 .09,2.21 l 0,1.09 -2.5,0 0,-1.09 c 0,-1 -0.00,-1.71 .09,-2.21 0,-0.4 .11,-0.8 .31,-1 .2,-0.3 .51,-0.40 .81,-0.40 z m -50.49,.12 c .5,0 .8,.18 1,.68 .19,.5 .28,1.30 .28,2.40 l 0,4.68 c 0,1.1 -0.08,1.90 -0.28,2.40 -0.2,.5 -0.5,.68 -1,.68 -0.5,0 -0.79,-0.18 -0.99,-0.68 -0.2,-0.5 -0.31,-1.30 -0.31,-2.40 l 0,-4.68 c 0,-1.1 .11,-1.90 .31,-2.40 .2,-0.5 .49,-0.68 .99,-0.68 z m 39.68,.09 c .3,0 .61,.10 .81,.40 .2,.3 .27,.67 .37,1.37 .1,.6 .12,1.51 .12,2.71 l .09,1.90 c 0,1.1 .00,1.99 -0.09,2.59 -0.1,.6 -0.19,1.08 -0.49,1.28 -0.2,.3 -0.50,.40 -0.90,.40 -0.3,0 -0.51,-0.08 -0.81,-0.18 -0.2,-0.1 -0.39,-0.29 -0.59,-0.59 l 0,-8.5 c .1,-0.4 .29,-0.7 .59,-1 .3,-0.3 .60,-0.40 .90,-0.40 z" id="ytp-id-33"></path></svg></div></div></a><div class="ytp-gradient-bottom" data-layer="9" style="height: 128px; background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAACACAYAAADK+QP0AAAAOUlEQVR4AeyQMQ4AMAgCqf3/n1vY2jiok4MOFzESEgx3XizKPFCzKWi8gIqIwlj2JrQJn/Ru/V4OAAAA//9BsSAYAAAABklEQVQDAOgTAa0KtfGEAAAAAElFTkSuQmCC&quot;); display: none;"></div><div class="ytp-chrome-bottom" data-layer="9" style="display: none; width: 536px; left: 12px;"><div class="ytp-progress-bar-container"><div class="ytp-heat-map-container"><div class="ytp-heat-map-edu"></div></div><div class="ytp-progress-bar" tabindex="0" role="slider" aria-label="Seek slider" draggable="true" aria-valuemin="0" aria-valuemax="0" aria-valuenow="0" aria-valuetext="0 Minutes 0 Seconds of 0 Minutes 0 Seconds" style="touch-action: none;"><div class="ytp-chapters-container"><div class="ytp-chapter-hover-container" style="width: 536px;"><div class="ytp-progress-bar-padding"></div><div class="ytp-progress-list"><div class="ytp-play-progress ytp-swatch-background-color" style="left: 0px; transform: scaleX(0); background-size: 0px; background-position-x: 0px;"></div><div class="ytp-progress-linear-live-buffer"></div><div class="ytp-load-progress" style="left: 0px; transform: scaleX(0);"></div><div class="ytp-hover-progress"></div><div class="ytp-ad-progress-list"></div></div></div></div><div class="ytp-timed-markers-container"></div><div class="ytp-clip-start-exclude" style="width: 0%;"></div><div class="ytp-clip-end-exclude" style="left: 100%; width: 0%;"></div><div class="ytp-scrubber-container" style="transform: translateX(0px);"><div class="ytp-scrubber-button ytp-swatch-background-color"><div class="ytp-scrubber-pull-indicator"></div><img class="ytp-decorated-scrubber-button"></div></div></div><div class="ytp-fine-scrubbing-container"><div class="ytp-fine-scrubbing-edu"></div><div class="ytp-fine-scrubbing"><div class="ytp-fine-scrubbing-draggable" draggable="true" style="touch-action: none; padding: 0px;"><div class="ytp-fine-scrubbing-thumbnails" tabindex="0" role="slider" type="range" aria-label="Click or scroll the panel for the precise seeking." aria-valuemin="0" aria-valuemax="410" aria-valuenow="0" aria-valuetext="Seek to 0 Minutes 0 Seconds" style="position: relative;"></div></div><div class="ytp-fine-scrubbing-cursor" aria-hidden="true"></div><div class="ytp-fine-scrubbing-seek-time" aria-hidden="true">0:00</div><div class="ytp-fine-scrubbing-play" title="Play from this position" role="button"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-5"></use><path class="ytp-svg-fill" d="M 12,26 18.5,22 18.5,14 12,10 z M 18.5,22 25,18 25,18 18.5,14 z" id="ytp-id-5"></path></svg></div><div class="ytp-fine-scrubbing-dismiss" title="Exit precise seeking" role="button"><svg height="100%" viewBox="0 0 24 24" width="100%"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="#fff"></path></svg></div></div></div><div class="ytp-bound-time-left"></div><div class="ytp-bound-time-right"></div><div class="ytp-clip-start" draggable="true" title="Watch full video" style="touch-action: none; left: 0%;"><svg height="100%" version="1.1" viewBox="0 0 14 14" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-3"></use><path d="M12,14 L9,11 L9,3 L12,0 L5,0 L5,14 L12,14 Z" fill="#eaeaea" id="ytp-id-3"></path></svg></div><div class="ytp-clip-end" draggable="true" title="Watch full video" style="touch-action: none; left: 100%;"><svg height="100%" version="1.1" viewBox="0 0 14 14" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-4"></use><path d="M2,14 L5,11 L5,3 L2,0 L9,0 L9,14 L2,14 L2,14 Z" fill="#eaeaea" id="ytp-id-4"></path></svg></div></div><div class="ytp-chrome-controls"><div class="ytp-left-controls"><a class="ytp-prev-button ytp-button" role="button" tabindex="0" aria-disabled="true" style="display: none;"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-10"></use><path class="ytp-svg-fill" d="m 12,12 h 2 v 12 h -2 z m 3.5,6 8.5,6 V 12 z" id="ytp-id-10"></path></svg></a><button class="ytp-play-button ytp-button" title="" aria-keyshortcuts="k" data-title-no-tooltip="Play" data-tooltip-title="Play (k)" aria-label="Play (k)"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-11"></use><path class="ytp-svg-fill" d="M 12,26 18.5,22 18.5,14 12,10 z M 18.5,22 25,18 25,18 18.5,14 z" id="ytp-id-11"></path></svg></button><a class="ytp-next-button ytp-button ytp-playlist-ui" role="button" tabindex="0" aria-disabled="true" style="display: none;"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-12"></use><path class="ytp-svg-fill" d="M 12,24 20.5,18 12,12 V 24 z M 22,12 v 12 h 2 V 12 h -2 z" id="ytp-id-12"></path></svg></a><span class="ytp-volume-area"><button class="ytp-mute-button ytp-button" aria-keyshortcuts="m" title="" data-tooltip-offset-y="0" data-tooltip-title="Mute (m)" aria-label="Mute (m)" data-title-no-tooltip="Mute"><div class="ytp-volume-icon"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-14"></use><use class="ytp-svg-shadow" xlink:href="#ytp-id-15"></use><defs><clipPath id="ytp-svg-volume-animation-mask"><path d="m 14.35,-0.14 -5.86,5.86 20.73,20.78 5.86,-5.91 z"></path><path d="M 7.07,6.87 -1.11,15.33 19.61,36.11 27.80,27.60 z"></path><path class="ytp-svg-volume-animation-mover" d="M 9.09,5.20 6.47,7.88 26.82,28.77 29.66,25.99 z" transform="translate(0, 0)"></path></clipPath><clipPath id="ytp-svg-volume-animation-slash-mask"><path class="ytp-svg-volume-animation-mover" d="m -11.45,-15.55 -4.44,4.51 20.45,20.94 4.55,-4.66 z" transform="translate(0, 0)"></path></clipPath></defs><path class="ytp-svg-fill ytp-svg-volume-animation-speaker" clip-path="url(#ytp-svg-volume-animation-mask)" d="M8,21 L12,21 L17,26 L17,10 L12,15 L8,15 L8,21 Z M19,14 L19,22 C20.48,21.32 21.5,19.77 21.5,18 C21.5,16.26 20.48,14.74 19,14 ZM19,11.29 C21.89,12.15 24,14.83 24,18 C24,21.17 21.89,23.85 19,24.71 L19,26.77 C23.01,25.86 26,22.28 26,18 C26,13.72 23.01,10.14 19,9.23 L19,11.29 Z" fill="#fff" id="ytp-id-14"></path><path class="ytp-svg-fill ytp-svg-volume-animation-hider" clip-path="url(#ytp-svg-volume-animation-slash-mask)" d="M 9.25,9 7.98,10.27 24.71,27 l 1.27,-1.27 Z" fill="#fff" id="ytp-id-15" style="display: none;"></path></svg></div></button><div class="ytp-volume-panel" title="" data-tooltip-title="Volume" role="slider" aria-valuemin="0" aria-valuemax="100" tabindex="0" aria-valuenow="100" aria-valuetext="100% volume" aria-label="Volume"><div class="ytp-volume-slider" draggable="true" style="touch-action: none;"><div class="ytp-volume-slider-handle" style="left: 40px;"></div></div></div></span><div class="ytp-time-display notranslate"><div class="ytp-time-wrapper"><div class="ytp-time-contents" aria-label="0 Minutes 0 Seconds of 6 Minutes 50 Seconds"><span class="ytp-time-clip-icon" aria-label="Clip"></span><span class="ytp-time-current">0:00</span><span class="ytp-time-separator"> / </span><span class="ytp-time-duration">6:50</span></div></div><span class="ytp-clip-watch-full-video-button-separator">•</span><span class="ytp-clip-watch-full-video-button"></span><button class="ytp-live-badge ytp-button">Live</button></div><div class="ytp-chapter-container" style="display: none;"><button class="ytp-chapter-title ytp-button ytp-chapter-container-disabled" disabled=""><span class="ytp-chapter-title-prefix" aria-hidden="true">•</span><div class="ytp-chapter-title-content" aria-live="polite" title="" data-tooltip-title="View chapter"></div><div class="ytp-chapter-title-chevron"><svg height="100%" viewBox="0 0 24 24" width="100%"><path d="M9.71 18.71l-1.42-1.42 5.3-5.29-5.3-5.29 1.42-1.42 6.7 6.71z" fill="#fff"></path></svg></div></button></div></div><div class="ytp-right-controls"><button class="ytp-subtitles-button ytp-button" aria-keyshortcuts="c" data-priority="5" title="" data-tooltip-title="Subtitles/closed captions unavailable" data-title-no-tooltip="Subtitles/closed captions unavailable" aria-pressed="false" aria-label="Subtitles/closed captions unavailable"><svg class="ytp-subtitles-button-icon" height="100%" version="1.1" viewBox="0 0 36 36" width="100%" fill-opacity="0.3"><use class="ytp-svg-shadow" xlink:href="#ytp-id-16"></use><path d="M11,11 C9.89,11 9,11.9 9,13 L9,23 C9,24.1 9.89,25 11,25 L25,25 C26.1,25 27,24.1 27,23 L27,13 C27,11.9 26.1,11 25,11 L11,11 Z M17,17 L15.5,17 L15.5,16.5 L13.5,16.5 L13.5,19.5 L15.5,19.5 L15.5,19 L17,19 L17,20 C17,20.55 16.55,21 16,21 L13,21 C12.45,21 12,20.55 12,20 L12,16 C12,15.45 12.45,15 13,15 L16,15 C16.55,15 17,15.45 17,16 L17,17 L17,17 Z M24,17 L22.5,17 L22.5,16.5 L20.5,16.5 L20.5,19.5 L22.5,19.5 L22.5,19 L24,19 L24,20 C24,20.55 23.55,21 23,21 L20,21 C19.45,21 19,20.55 19,20 L19,16 C19,15.45 19.45,15 20,15 L23,15 C23.55,15 24,15.45 24,16 L24,17 L24,17 Z" fill="#fff" id="ytp-id-16"></path></svg></button><button class="ytp-button ytp-settings-button" aria-expanded="false" aria-haspopup="true" aria-controls="ytp-id-17" title="" data-tooltip-title="Settings" data-tooltip-target-id="ytp-settings-button" aria-label="Settings"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-18"></use><path d="m 23.94,18.78 c .03,-0.25 .05,-0.51 .05,-0.78 0,-0.27 -0.02,-0.52 -0.05,-0.78 l 1.68,-1.32 c .15,-0.12 .19,-0.33 .09,-0.51 l -1.6,-2.76 c -0.09,-0.17 -0.31,-0.24 -0.48,-0.17 l -1.99,.8 c -0.41,-0.32 -0.86,-0.58 -1.35,-0.78 l -0.30,-2.12 c -0.02,-0.19 -0.19,-0.33 -0.39,-0.33 l -3.2,0 c -0.2,0 -0.36,.14 -0.39,.33 l -0.30,2.12 c -0.48,.2 -0.93,.47 -1.35,.78 l -1.99,-0.8 c -0.18,-0.07 -0.39,0 -0.48,.17 l -1.6,2.76 c -0.10,.17 -0.05,.39 .09,.51 l 1.68,1.32 c -0.03,.25 -0.05,.52 -0.05,.78 0,.26 .02,.52 .05,.78 l -1.68,1.32 c -0.15,.12 -0.19,.33 -0.09,.51 l 1.6,2.76 c .09,.17 .31,.24 .48,.17 l 1.99,-0.8 c .41,.32 .86,.58 1.35,.78 l .30,2.12 c .02,.19 .19,.33 .39,.33 l 3.2,0 c .2,0 .36,-0.14 .39,-0.33 l .30,-2.12 c .48,-0.2 .93,-0.47 1.35,-0.78 l 1.99,.8 c .18,.07 .39,0 .48,-0.17 l 1.6,-2.76 c .09,-0.17 .05,-0.39 -0.09,-0.51 l -1.68,-1.32 0,0 z m -5.94,2.01 c -1.54,0 -2.8,-1.25 -2.8,-2.8 0,-1.54 1.25,-2.8 2.8,-2.8 1.54,0 2.8,1.25 2.8,2.8 0,1.54 -1.25,2.8 -2.8,2.8 l 0,0 z" fill="#fff" id="ytp-id-18"></path></svg></button><a class="ytp-youtube-button ytp-button yt-uix-sessionlink" title="" target="_blank" data-priority="6" data-sessionlink="feature=player-button" href="https://www.youtube.com/watch?v=t2qx0xTDnCI" data-tooltip-title="Watch on YouTube" aria-label="Watch on YouTube"><svg height="100%" version="1.1" viewBox="0 0 67 36" width="100%" aria-hidden="true"><use class="ytp-svg-shadow" xlink:href="#ytp-id-20"></use><path class="ytp-svg-fill" d="M 45.09 10 L 45.09 25.82 L 47.16 25.82 L 47.41 24.76 L 47.47 24.76 C 47.66 25.14 47.94 25.44 48.33 25.66 C 48.72 25.88 49.16 25.99 49.63 25.99 C 50.48 25.99 51.1 25.60 51.5 24.82 C 51.9 24.04 52.09 22.82 52.09 21.16 L 52.09 19.40 C 52.12 18.13 52.05 17.15 51.90 16.44 C 51.75 15.74 51.50 15.23 51.16 14.91 C 50.82 14.59 50.34 14.44 49.75 14.44 C 49.29 14.44 48.87 14.57 48.47 14.83 C 48.27 14.96 48.09 15.11 47.93 15.29 C 47.78 15.46 47.64 15.65 47.53 15.86 L 47.51 15.86 L 47.51 10 L 45.09 10 z M 8.10 10.56 L 10.96 20.86 L 10.96 25.82 L 13.42 25.82 L 13.42 20.86 L 16.32 10.56 L 13.83 10.56 L 12.78 15.25 C 12.49 16.62 12.31 17.59 12.23 18.17 L 12.16 18.17 C 12.04 17.35 11.84 16.38 11.59 15.23 L 10.59 10.56 L 8.10 10.56 z M 30.10 10.56 L 30.10 12.58 L 32.59 12.58 L 32.59 25.82 L 35.06 25.82 L 35.06 12.58 L 37.55 12.58 L 37.55 10.56 L 30.10 10.56 z M 19.21 14.46 C 18.37 14.46 17.69 14.63 17.17 14.96 C 16.65 15.29 16.27 15.82 16.03 16.55 C 15.79 17.28 15.67 18.23 15.67 19.43 L 15.67 21.06 C 15.67 22.24 15.79 23.19 16 23.91 C 16.21 24.62 16.57 25.15 17.07 25.49 C 17.58 25.83 18.27 26 19.15 26 C 20.02 26 20.69 25.83 21.19 25.5 C 21.69 25.17 22.06 24.63 22.28 23.91 C 22.51 23.19 22.63 22.25 22.63 21.06 L 22.63 19.43 C 22.63 18.23 22.50 17.28 22.27 16.56 C 22.04 15.84 21.68 15.31 21.18 14.97 C 20.68 14.63 20.03 14.46 19.21 14.46 z M 56.64 14.47 C 55.39 14.47 54.51 14.84 53.99 15.61 C 53.48 16.38 53.22 17.60 53.22 19.27 L 53.22 21.23 C 53.22 22.85 53.47 24.05 53.97 24.83 C 54.34 25.40 54.92 25.77 55.71 25.91 C 55.97 25.96 56.26 25.99 56.57 25.99 C 57.60 25.99 58.40 25.74 58.96 25.23 C 59.53 24.72 59.81 23.94 59.81 22.91 C 59.81 22.74 59.79 22.61 59.78 22.51 L 57.63 22.39 C 57.62 23.06 57.54 23.54 57.40 23.83 C 57.26 24.12 57.01 24.27 56.63 24.27 C 56.35 24.27 56.13 24.18 56.00 24.02 C 55.87 23.86 55.79 23.61 55.75 23.25 C 55.71 22.89 55.68 22.36 55.68 21.64 L 55.68 21.08 L 59.86 21.08 L 59.86 19.16 C 59.86 17.99 59.77 17.08 59.58 16.41 C 59.39 15.75 59.07 15.25 58.61 14.93 C 58.15 14.62 57.50 14.47 56.64 14.47 z M 23.92 14.67 L 23.92 23.00 C 23.92 24.03 24.11 24.79 24.46 25.27 C 24.82 25.76 25.35 26.00 26.09 26.00 C 27.16 26.00 27.97 25.49 28.5 24.46 L 28.55 24.46 L 28.76 25.82 L 30.73 25.82 L 30.73 14.67 L 28.23 14.67 L 28.23 23.52 C 28.13 23.73 27.97 23.90 27.77 24.03 C 27.57 24.16 27.37 24.24 27.15 24.24 C 26.89 24.24 26.70 24.12 26.59 23.91 C 26.48 23.70 26.43 23.35 26.43 22.85 L 26.43 14.67 L 23.92 14.67 z M 36.80 14.67 L 36.80 23.00 C 36.80 24.03 36.98 24.79 37.33 25.27 C 37.60 25.64 37.97 25.87 38.45 25.96 C 38.61 25.99 38.78 26.00 38.97 26.00 C 40.04 26.00 40.83 25.49 41.36 24.46 L 41.41 24.46 L 41.64 25.82 L 43.59 25.82 L 43.59 14.67 L 41.09 14.67 L 41.09 23.52 C 40.99 23.73 40.85 23.90 40.65 24.03 C 40.45 24.16 40.23 24.24 40.01 24.24 C 39.75 24.24 39.58 24.12 39.47 23.91 C 39.36 23.70 39.31 23.35 39.31 22.85 L 39.31 14.67 L 36.80 14.67 z M 56.61 16.15 C 56.88 16.15 57.08 16.23 57.21 16.38 C 57.33 16.53 57.42 16.79 57.47 17.16 C 57.52 17.53 57.53 18.06 57.53 18.78 L 57.53 19.58 L 55.69 19.58 L 55.69 18.78 C 55.69 18.05 55.71 17.52 55.75 17.16 C 55.79 16.81 55.87 16.55 56.00 16.39 C 56.13 16.23 56.32 16.15 56.61 16.15 z M 19.15 16.19 C 19.50 16.19 19.75 16.38 19.89 16.75 C 20.03 17.12 20.09 17.7 20.09 18.5 L 20.09 21.97 C 20.09 22.79 20.03 23.39 19.89 23.75 C 19.75 24.11 19.51 24.29 19.15 24.30 C 18.80 24.30 18.54 24.11 18.41 23.75 C 18.28 23.39 18.22 22.79 18.22 21.97 L 18.22 18.5 C 18.22 17.7 18.28 17.12 18.42 16.75 C 18.56 16.38 18.81 16.19 19.15 16.19 z M 48.63 16.22 C 48.88 16.22 49.08 16.31 49.22 16.51 C 49.36 16.71 49.45 17.05 49.50 17.52 C 49.55 17.99 49.58 18.68 49.58 19.55 L 49.58 21 L 49.59 21 C 49.59 21.81 49.57 22.45 49.5 22.91 C 49.43 23.37 49.32 23.70 49.16 23.89 C 49.00 24.08 48.78 24.17 48.51 24.17 C 48.30 24.17 48.11 24.12 47.94 24.02 C 47.76 23.92 47.62 23.78 47.51 23.58 L 47.51 17.25 C 47.59 16.95 47.75 16.70 47.96 16.50 C 48.17 16.31 48.39 16.22 48.63 16.22 z " id="ytp-id-20"></path></svg></a><button class="ytp-pip-button ytp-button" title="" data-priority="8" data-tooltip-target-id="ytp-pip-button" data-tooltip-title="Picture-in-picture" data-title-no-tooltip="Picture-in-picture" style="display: none;"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-32"></use><path d="M25,17 L17,17 L17,23 L25,23 L25,17 L25,17 Z M29,25 L29,10.98 C29,9.88 28.1,9 27,9 L9,9 C7.9,9 7,9.88 7,10.98 L7,25 C7,26.1 7.9,27 9,27 L27,27 C28.1,27 29,26.1 29,25 L29,25 Z M27,25.02 L9,25.02 L9,10.97 L27,10.97 L27,25.02 L27,25.02 Z" fill="#fff" id="ytp-id-32"></path></svg></button><button class="ytp-size-button ytp-button" title="" aria-keyshortcuts="t" data-priority="9" style="display: none;"></button><button class="ytp-remote-button ytp-button" title="" data-tooltip-title="Play on TV" aria-haspopup="true" data-priority="10" aria-label="Play on TV" style="display: none;"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><use class="ytp-svg-shadow" xlink:href="#ytp-id-21"></use><path d="M27,9 L9,9 C7.9,9 7,9.9 7,11 L7,14 L9,14 L9,11 L27,11 L27,25 L20,25 L20,27 L27,27 C28.1,27 29,26.1 29,25 L29,11 C29,9.9 28.1,9 27,9 L27,9 Z M7,24 L7,27 L10,27 C10,25.34 8.66,24 7,24 L7,24 Z M7,20 L7,22 C9.76,22 12,24.24 12,27 L14,27 C14,23.13 10.87,20 7,20 L7,20 Z M7,16 L7,18 C11.97,18 16,22.03 16,27 L18,27 C18,20.92 13.07,16 7,16 L7,16 Z" fill="#fff" id="ytp-id-21"></path></svg></button><button class="ytp-fullscreen-button ytp-button" title="" aria-keyshortcuts="f" data-priority="12" data-title-no-tooltip="Full screen" data-tooltip-title="Full screen (f)" aria-label="Full screen (f)"><svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%"><g class="ytp-fullscreen-button-corner-0"><use class="ytp-svg-shadow" xlink:href="#ytp-id-6"></use><path class="ytp-svg-fill" d="m 10,16 2,0 0,-4 4,0 0,-2 L 10,10 l 0,6 0,0 z" id="ytp-id-6"></path></g><g class="ytp-fullscreen-button-corner-1"><use class="ytp-svg-shadow" xlink:href="#ytp-id-7"></use><path class="ytp-svg-fill" d="m 20,10 0,2 4,0 0,4 2,0 L 26,10 l -6,0 0,0 z" id="ytp-id-7"></path></g><g class="ytp-fullscreen-button-corner-2"><use class="ytp-svg-shadow" xlink:href="#ytp-id-8"></use><path class="ytp-svg-fill" d="m 24,24 -4,0 0,2 L 26,26 l 0,-6 -2,0 0,4 0,0 z" id="ytp-id-8"></path></g><g class="ytp-fullscreen-button-corner-3"><use class="ytp-svg-shadow" xlink:href="#ytp-id-9"></use><path class="ytp-svg-fill" d="M 12,20 10,20 10,26 l 6,0 0,-2 -4,0 0,-4 0,0 z" id="ytp-id-9"></path></g></svg></button></div></div></div></div></div>

<p>ETW Threat Intelligence is a goldmine of additional telemetry we cannot get though driver callback routines alone. These include:</p>

<ol>
<li>Allocating memory (either in the local or remote process0)</li>
<li>Changing the protection of memory</li>
<li>Queueing an APC (see my blog post on bypassing EDR via <a href="https://fluxsec.red/apc-queue-injection-rust" target="_blank">Queue User APC</a>, this is something we can detect with Sanctum EDR via ETW:TI)</li>
<li>Suspend / resume process</li>
<li>Suspend / resume thread</li>
<li>And more!</li>
</ol>

<p>These are all super useful sources of information that we can use to combat modern malware in this EDR project!</p>

<p>Pulling all of this together is my <a href="https://fluxsec.red/edr-syscall-hooking" target="_blank">Ghost Hunting</a> technique, which we can use to detect
foul play at malware trying to implement ‘classic’ antivirus and EDR evasion techniques like those I have already blogged about before.</p>

<h2 id="requirements">Requirements</h2>

<p>In order to start receiving ETW:TI signals, we need:</p>

<ol>
<li>A service running as Protected Process Light</li>
<li>An Early Launch Antimalware driver and certificate</li>
<li>A logging mechanism (we will use the Windows Event Log)</li>
</ol>

<p>Points 1 and 2 are covered in my previous blog post, <a href="https://fluxsec.red/creating-a-ppl-protected-process-light-in-rust-windows" target="_blank">Creating a Protected Process Light</a>
and point 3 you can check out my <a href="https://github.com/0xflux/Sanctum/blob/main/sanctum_ppl_runner/src/logging.rs" target="_blank">logging</a> module of the project.</p>

<h2 id="threat-intelligence-basics">Threat Intelligence basics</h2>

<p>With the requirements in place, we are ready to write the ETW:Threat Intelligence consumer!</p>

<p>One thing to note; this will block the main thread in the service - so we will want to run this in its <strong>own OS thread</strong>.</p>

<p>First of all, getting started with this was a little daunting as there is not much information about the Threat Intelligence provider in terms of implementation,
so the first port of call is to run this in powershell, which will give us all the information we could want to know at this stage about ETW:TI.</p>

<pre><code class="language-shell hljs" data-highlighted="yes">wevtutil gp Microsoft-Windows-Threat-Intelligence
</code></pre>

<p>What this gives us, is the <strong>GUID</strong> of the provider which we need to subscribe to it, as well as all the tasks and keywords the provider has to offer.</p>

<p><img class="wide-img" src="https://fluxsec.red/static/images/etw_1.png" alt="Windows Event Tracing for Windows Threat Intelligence"></p>

<p>The opcodes are split into two parts:</p>

<ol>
<li><strong>Tasks:</strong> These are the major component of the provider. These are given an integer identifier.</li>
<li><strong>Keywords:</strong> These are a 64-bit bitmask used to indicate an events membership in a set of categories.</li>
</ol>

<p>I have taken these out and set them as constants in our <strong>tracing.rs</strong> module (<a href="https://github.com/0xflux/Sanctum/blob/main/sanctum_ppl_runner/src/tracing.rs" target="_blank">link</a>)
and they look as follows:</p>

<pre><code class="language-rust hljs" data-highlighted="yes"><span class="hljs-keyword">const</span> KERNEL_THREATINT_TASK_ALLOCVM: <span class="hljs-type">u16</span>                = <span class="hljs-number">1</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_TASK_PROTECTVM: <span class="hljs-type">u16</span>              = <span class="hljs-number">2</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_TASK_MAPVIEW: <span class="hljs-type">u16</span>                = <span class="hljs-number">3</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_TASK_QUEUEUSERAPC: <span class="hljs-type">u16</span>           = <span class="hljs-number">4</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_TASK_SETTHREADCONTEXT: <span class="hljs-type">u16</span>       = <span class="hljs-number">5</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_TASK_READVM: <span class="hljs-type">u16</span>                 = <span class="hljs-number">6</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_TASK_WRITEVM: <span class="hljs-type">u16</span>                = <span class="hljs-number">7</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_TASK_SUSPENDRESUME_THREAD: <span class="hljs-type">u16</span>   = <span class="hljs-number">8</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_TASK_SUSPENDRESUME_PROCESS: <span class="hljs-type">u16</span>  = <span class="hljs-number">9</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_TASK_DRIVER_DEVICE: <span class="hljs-type">u16</span>          = <span class="hljs-number">10</span>;

<span class="hljs-comment">// Keyword masks for ETW:TI </span>
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_ALLOCVM_LOCAL: <span class="hljs-type">u64</span>                           = <span class="hljs-number">0x1</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_ALLOCVM_LOCAL_KERNEL_CALLER: <span class="hljs-type">u64</span>             = <span class="hljs-number">0x2</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_ALLOCVM_REMOTE: <span class="hljs-type">u64</span>                          = <span class="hljs-number">0x4</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_ALLOCVM_REMOTE_KERNEL_CALLER: <span class="hljs-type">u64</span>            = <span class="hljs-number">0x8</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_PROTECTVM_LOCAL: <span class="hljs-type">u64</span>                         = <span class="hljs-number">0x10</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_PROTECTVM_LOCAL_KERNEL_CALLER: <span class="hljs-type">u64</span>           = <span class="hljs-number">0x20</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_PROTECTVM_REMOTE: <span class="hljs-type">u64</span>                        = <span class="hljs-number">0x40</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_PROTECTVM_REMOTE_KERNEL_CALLER: <span class="hljs-type">u64</span>          = <span class="hljs-number">0x80</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_MAPVIEW_LOCAL: <span class="hljs-type">u64</span>                           = <span class="hljs-number">0x100</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_MAPVIEW_LOCAL_KERNEL_CALLER: <span class="hljs-type">u64</span>             = <span class="hljs-number">0x200</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_MAPVIEW_REMOTE: <span class="hljs-type">u64</span>                          = <span class="hljs-number">0x400</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_MAPVIEW_REMOTE_KERNEL_CALLER: <span class="hljs-type">u64</span>            = <span class="hljs-number">0x800</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_QUEUEUSERAPC_REMOTE: <span class="hljs-type">u64</span>                     = <span class="hljs-number">0x1000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_QUEUEUSERAPC_REMOTE_KERNEL_CALLER: <span class="hljs-type">u64</span>       = <span class="hljs-number">0x2000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_SETTHREADCONTEXT_REMOTE: <span class="hljs-type">u64</span>                 = <span class="hljs-number">0x4000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_SETTHREADCONTEXT_REMOTE_KERNEL_CALLER: <span class="hljs-type">u64</span>   = <span class="hljs-number">0x8000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_READVM_LOCAL: <span class="hljs-type">u64</span>                            = <span class="hljs-number">0x10000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_READVM_REMOTE: <span class="hljs-type">u64</span>                           = <span class="hljs-number">0x20000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_WRITEVM_LOCAL: <span class="hljs-type">u64</span>                           = <span class="hljs-number">0x40000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_WRITEVM_REMOTE: <span class="hljs-type">u64</span>                          = <span class="hljs-number">0x80000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_SUSPEND_THREAD: <span class="hljs-type">u64</span>                          = <span class="hljs-number">0x100000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_RESUME_THREAD: <span class="hljs-type">u64</span>                           = <span class="hljs-number">0x200000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_SUSPEND_PROCESS: <span class="hljs-type">u64</span>                         = <span class="hljs-number">0x400000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_RESUME_PROCESS: <span class="hljs-type">u64</span>                          = <span class="hljs-number">0x800000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_FREEZE_PROCESS: <span class="hljs-type">u64</span>                          = <span class="hljs-number">0x1000000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_THAW_PROCESS: <span class="hljs-type">u64</span>                            = <span class="hljs-number">0x2000000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_CONTEXT_PARSE: <span class="hljs-type">u64</span>                           = <span class="hljs-number">0x4000000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_EXECUTION_ADDRESS_VAD_PROBE: <span class="hljs-type">u64</span>             = <span class="hljs-number">0x8000000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_EXECUTION_ADDRESS_MMF_NAME_PROBE: <span class="hljs-type">u64</span>        = <span class="hljs-number">0x10000000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_READWRITEVM_NO_SIGNATURE_RESTRICTION: <span class="hljs-type">u64</span>    = <span class="hljs-number">0x20000000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_DRIVER_EVENTS: <span class="hljs-type">u64</span>                           = <span class="hljs-number">0x40000000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_DEVICE_EVENTS: <span class="hljs-type">u64</span>                           = <span class="hljs-number">0x80000000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_READVM_REMOTE_FILL_VAD: <span class="hljs-type">u64</span>                  = <span class="hljs-number">0x100000000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_WRITEVM_REMOTE_FILL_VAD: <span class="hljs-type">u64</span>                 = <span class="hljs-number">0x200000000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_PROTECTVM_LOCAL_FILL_VAD: <span class="hljs-type">u64</span>                = <span class="hljs-number">0x400000000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_PROTECTVM_LOCAL_KERNEL_CALLER_FILL_VAD: <span class="hljs-type">u64</span>  = <span class="hljs-number">0x800000000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_PROTECTVM_REMOTE_FILL_VAD: <span class="hljs-type">u64</span>               = <span class="hljs-number">0x1000000000</span>;
<span class="hljs-keyword">const</span> KERNEL_THREATINT_KEYWORD_PROTECTVM_REMOTE_KERNEL_CALLER_FILL_VAD: <span class="hljs-type">u64</span> = <span class="hljs-number">0x2000000000</span>;
</code></pre>

<p>As you can see - these are quite self descriptive. Taking an example we will build out here as a POC of this process working,
if our <strong>malware.exe</strong> allocates memory in a remote process, then we would expect to receive information about:</p>

<p><strong>Task:</strong> KERNEL_THREATINT_TASK_ALLOCVM (1) with a bitmask of <strong>KERNEL_THREATINT_KEYWORD_ALLOCVM_REMOTE</strong> (4).</p>

<p>And in fact, this is exactly what we can infer from the signal:</p>

<p><img class="wide-img" src="https://fluxsec.red/static/images/rem_mem_etw.png" alt="Detecting VirtualAllocEx EDR"></p>

<p>We do successfully detect memory being allocated in a remote process, which was done via <code>VirtualAllocEx</code>.</p>

<h2 id="implementation">Implementation</h2>

<p>Okay so, there’s a couple of milestones we need to meet in order to get this working:</p>

<ol>
<li>Initialise a <strong>EVENT_TRACE_PROPERTIES</strong> structure and register the session</li>
<li>Configure the trace session</li>
<li>Deliver tracing events to our callback routine</li>
<li>Process the event in the callback</li>
</ol>

<h3 id="initialisation">Initialisation</h3>

<p>To perform the initialisation, we need to create a <a href="https://learn.microsoft.com/en-us/windows/win32/api/evntrace/ns-evntrace-event_trace_properties" target="_blank">EVENT_TRACE_PROPERTIES</a>
structure, which <strong>importantly</strong> contains space at the end of the struct for the session name.</p>

<p>We heap allocate a buffer which is the size of the struct, plus the length of the session name (multiplied by the size of a wide char so we don’t cut our string in half!)
and set some flags, importantly: <strong>EVENT_TRACE_REAL_TIME_MODE</strong> as we don’t want to trace to a file. We also have to set the total size of the structure and where the offset
is of the session name (remember, our struct is [size of struct + (length of string * 2)]).</p>

<p>Then, we copy the session name into the buffer and we are good to call <a href="https://learn.microsoft.com/en-us/windows/win32/api/evntrace/nf-evntrace-starttracew" target="_blank">StartTraceW</a>. We also
need to pass in a handle of type <a href="https://microsoft.github.io/windows-docs-rs/doc/windows/Win32/System/Diagnostics/Etw/struct.CONTROLTRACE_HANDLE.html" target="_blank">CONTROLTRACE_HANDLE</a>
which is our way of interacting with the session.</p>

<p>This section looks as follows:</p>

<pre><code class="language-rust hljs" data-highlighted="yes"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">handle</span> = CONTROLTRACE_HANDLE::<span class="hljs-title function_ invoke__">default</span>();

<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">wide_name</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u16</span>&gt; = <span class="hljs-string">"SanctumETWThreatIntelligence\0"</span>.<span class="hljs-title function_ invoke__">encode_utf16</span>().<span class="hljs-title function_ invoke__">collect</span>();
<span class="hljs-keyword">let</span> <span class="hljs-variable">session_name</span> = PCWSTR::<span class="hljs-title function_ invoke__">from_raw</span>(wide_name.<span class="hljs-title function_ invoke__">as_ptr</span>());

<span class="hljs-comment">// SAFETY: null pointer for getting the session name length checked above.</span>
<span class="hljs-keyword">let</span> <span class="hljs-variable">total_size</span>: <span class="hljs-type">usize</span> = size_of::&lt;EVENT_TRACE_PROPERTIES&gt;() + (wide_name.<span class="hljs-title function_ invoke__">len</span>() * size_of::&lt;<span class="hljs-type">u16</span>&gt;());

<span class="hljs-comment">// allocate a buffer for the properties plus the session name (len calculated above)</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">buffer</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0u8</span>; total_size];
<span class="hljs-comment">// get a mutable pointer to the start of the buffer, casting as EVENT_TRACE_PROPERTIES</span>
<span class="hljs-keyword">let</span> <span class="hljs-variable">properties</span> = buffer.<span class="hljs-title function_ invoke__">as_mut_ptr</span>() <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> EVENT_TRACE_PROPERTIES;

<span class="hljs-keyword">if</span> properties.<span class="hljs-title function_ invoke__">is_null</span>() {
    <span class="hljs-title function_ invoke__">event_log</span>(<span class="hljs-string">"Buffer was null for EVENT_TRACE_PROPERTIES. Cannot proceed safely."</span>, EVENTLOG_ERROR_TYPE, EventID::GeneralError);
    std::process::<span class="hljs-title function_ invoke__">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-comment">// allocate the correct parameters for the EVENT_TRACE_PROPERTIES in the buffer.</span>
<span class="hljs-comment">// SAFETY: Null pointer checked above.</span>
<span class="hljs-keyword">unsafe</span> {
    (*properties).Wnode.BufferSize = total_size <span class="hljs-keyword">as</span> _;
    (*properties).Wnode.Flags = EVENT_TRACE_REAL_TIME_MODE;
    (*properties).LogFileMode = EVENT_TRACE_REAL_TIME_MODE;
    <span class="hljs-comment">// set logger name offset to the right of the structure</span>
    (*properties).LoggerNameOffset = size_of::&lt;EVENT_TRACE_PROPERTIES&gt;() <span class="hljs-keyword">as</span> _;
}
<span class="hljs-keyword">let</span> <span class="hljs-variable">logger_name_ptr</span> = <span class="hljs-keyword">unsafe</span> {    
    <span class="hljs-comment">// copy the session name into the buffer</span>
    <span class="hljs-keyword">let</span> <span class="hljs-variable">logger_name_ptr</span> = (buffer.<span class="hljs-title function_ invoke__">as_mut_ptr</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> + (*properties).LoggerNameOffset <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>) <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u16</span>;
    <span class="hljs-title function_ invoke__">copy_nonoverlapping</span>(wide_name.<span class="hljs-title function_ invoke__">as_ptr</span>(), logger_name_ptr, wide_name.<span class="hljs-title function_ invoke__">len</span>());

    logger_name_ptr
};
<span class="hljs-keyword">let</span> <span class="hljs-variable">embedded_session_name</span> = PCWSTR::<span class="hljs-title function_ invoke__">from_raw</span>(logger_name_ptr);

<span class="hljs-keyword">let</span> <span class="hljs-variable">status</span> = <span class="hljs-keyword">unsafe</span> { <span class="hljs-title function_ invoke__">StartTraceW</span>(
    &amp;<span class="hljs-keyword">mut</span> handle, 
    embedded_session_name, 
    properties)
};
<span class="hljs-keyword">if</span> status.<span class="hljs-title function_ invoke__">is_err</span>() {
    <span class="hljs-title function_ invoke__">event_log</span>(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Unable to register ETW:TI session. Failed with Win32 error: {:?}"</span>, status), EVENTLOG_ERROR_TYPE, EventID::GeneralError);
    std::process::<span class="hljs-title function_ invoke__">exit</span>(<span class="hljs-number">1</span>);
}
</code></pre>

<h3 id="configuring-the-session">Configuring the session</h3>

<p>Now that we have registered it, we need to call <a href="https://learn.microsoft.com/en-us/windows/win32/api/evntrace/nf-evntrace-enabletraceex2" target="_blank">EnableTraceEx2</a>
which configures how the trace session operates.</p>

<p><strong>Importantly</strong> here we can configure which keywords we want to filter on, we can either apply a bitmask in here or, set all bits to true via <code>u64::MAX</code>
so we receive all events. This would be something to play around with if you want some tuning.</p>

<p>At this point we also need to provide the GUID (which we talked about in an above section), for this we can define a constant:</p>

<pre><code class="language-Rust hljs" data-highlighted="yes"><span class="hljs-keyword">const</span> ETW_TI_GUID: windows::core::GUID = windows::core::GUID::<span class="hljs-title function_ invoke__">from_u128</span>(<span class="hljs-number">0xf4e1897c_bb5d_5668_f1d8_040f4d8dd344</span>);
</code></pre>

<p>And the implementation looks like:</p>

<pre><code class="language-Rust hljs" data-highlighted="yes"><span class="hljs-keyword">let</span> <span class="hljs-variable">status</span> = <span class="hljs-keyword">unsafe</span> { 
    <span class="hljs-title function_ invoke__">EnableTraceEx2</span>(
        handle, 
        &amp;ETW_TI_GUID,
        EVENT_CONTROL_CODE_ENABLE_PROVIDER.<span class="hljs-number">0</span>,
        TRACE_LEVEL_VERBOSE <span class="hljs-keyword">as</span> _,
        <span class="hljs-type">u64</span>::MAX, <span class="hljs-comment">// set all bits in the mask</span>
        <span class="hljs-number">0</span>, 
        <span class="hljs-number">0</span>, 
        <span class="hljs-literal">None</span>,
    )
};
</code></pre>

<h3 id="deliver-events-to-the-callback">Deliver events to the callback</h3>

<p>The mechanism for event tracing is that we have a callback routine (similar to those we used in the driver). In order to do this we first must initialise
an <a href="https://learn.microsoft.com/en-us/windows/win32/api/evntrace/ns-evntrace-event_trace_logfilew" target="_blank">EVENT_TRACE_LOGFILEW</a> configuring a few flags and fields,
but <strong>importantly</strong> we provide a function pointer to the structure which tells the system where our callback routine is.</p>

<p>We then call <a href="https://learn.microsoft.com/en-us/windows/win32/api/evntrace/nf-evntrace-opentracew" target="_blank">OpenTraceW</a> which sets this up.</p>

<p>This as as follows:</p>

<pre><code class="language-Rust hljs" data-highlighted="yes">{
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">log_file</span> = EVENT_TRACE_LOGFILEW::<span class="hljs-title function_ invoke__">default</span>();
    log_file.LoggerName = <span class="hljs-title function_ invoke__">PWSTR</span>(session_name.<span class="hljs-title function_ invoke__">as_mut_ptr</span>());
    log_file.Anonymous1.ProcessTraceMode = PROCESS_TRACE_MODE_REAL_TIME | PROCESS_TRACE_MODE_EVENT_RECORD;
    log_file.Anonymous2.EventRecordCallback = <span class="hljs-title function_ invoke__">Some</span>(trace_callback);

    <span class="hljs-keyword">let</span> <span class="hljs-variable">trace_handle</span> = <span class="hljs-keyword">unsafe</span> { <span class="hljs-title function_ invoke__">OpenTraceW</span>(&amp;<span class="hljs-keyword">mut</span> log_file) };
}


<span class="hljs-comment">/// A callback routine that handles trace events, allowing them to be processed as required</span>
<span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">"system"</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">trace_callback</span>(record: *<span class="hljs-keyword">mut</span> EVENT_RECORD) {
    <span class="hljs-comment">// the callback fn</span>
}
</code></pre>

<p>And then, we run ProcessTrace which is a blocking function (hence having to take this off the main thread) which delivers trace events to the consumer.</p>

<pre><code class="language-Rust hljs" data-highlighted="yes"><span class="hljs-keyword">let</span> <span class="hljs-variable">status</span> = <span class="hljs-keyword">unsafe</span> { <span class="hljs-title function_ invoke__">ProcessTrace</span>(&amp;[trace_handle], <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>) };
</code></pre>

<h3 id="the-callback-routine">The callback routine</h3>

<p>For our callback routine, we have access to a <a href="https://learn.microsoft.com/en-us/windows/win32/api/evntcons/ns-evntcons-event_record" target="_blank">EVENT_RECORD</a> structure which contains
information on the event, such as the Process ID (pid), which task triggered the event, as well as the bitmask.</p>

<p>There is a <strong>UserData</strong> field which Microsoft say:</p>

<div class="info-box">
  <p><svg class="svg-inline--fa fa-circle-info" style="color: #638be3;" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="circle-info" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"></path></svg><!-- <i class="fa-solid fa-circle-info" style="color: #638be3;"></i> Font Awesome fontawesome.com -->
  Event specific data. To parse this data, see Retrieving Event Data Using TDH. If the Flags member of EVENT_HEADER 
  contains EVENT_HEADER_FLAG_STRING_ONLY, the data is a null-terminated Unicode string that you do not need TDH to parse.</p>
</div>

<p>Now; I’m not entirely sure the best way to parse this out and what may even be in there (I may have to attach a debugger or dump some memory to have a look) - but I will
tackle this at a later date. I believe it is likely this will contain some useful information for us, though we may not specifically need it for
<a href="https://fluxsec.red/edr-syscall-hooking" target="_blank">Ghost Hunting</a>.</p>

<p>From my code here, you can tweak it to start playing about with some pattern matching on the task and keyword masks to get whatever notifications you like! I have also written
a small function to get the process image from the PID which allows us to explicitly filter on processes with <strong>malware</strong> and <strong>notepad</strong> in their image which will make
log hunting easier for us, seeing as <strong>malware.exe</strong> is doing bad things to <strong>notepad.exe</strong> :E.</p>

<p>I have found through this, even though the service is running in the context of <strong>SYSTEM</strong> at <strong>Protected Process Light</strong>, we cannot get a handle to <strong>SYSTEM</strong> processes. Which I
guess makes sense, but this is a potential blind spot. The only way I can realistically see process injection into a SYSTEM process working is via DLL Sideloading, but I would like
to hope that processes running at <strong>SYSTEM</strong> will only load signed, trusted libraries?</p>

<p>Anyway, the code:</p>

<pre><code class="language-Rust hljs" data-highlighted="yes"><span class="hljs-comment">/// A callback routine that handles trace events, allowing them to be processed as required</span>
<span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">"system"</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">trace_callback</span>(record: *<span class="hljs-keyword">mut</span> EVENT_RECORD) {
    <span class="hljs-keyword">if</span> record.<span class="hljs-title function_ invoke__">is_null</span>() {
        <span class="hljs-title function_ invoke__">event_log</span>(<span class="hljs-string">"Event was a null pointer in the tracer callback routine."</span>, EVENTLOG_ERROR_TYPE, EventID::GeneralError);
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// SAFETY: Null pointer dereference checked above</span>
    <span class="hljs-keyword">let</span> <span class="hljs-variable">event_header</span> = <span class="hljs-keyword">unsafe</span> {&amp;(*record).EventHeader};
    <span class="hljs-keyword">let</span> <span class="hljs-variable">descriptor_id</span> = event_header.EventDescriptor.Id;
    <span class="hljs-keyword">let</span> <span class="hljs-variable">task</span> = event_header.EventDescriptor.Task;
    <span class="hljs-keyword">let</span> <span class="hljs-variable">keyword</span> = event_header.EventDescriptor.Keyword;
    <span class="hljs-keyword">let</span> <span class="hljs-variable">level</span> = event_header.EventDescriptor.Level;
    <span class="hljs-keyword">let</span> <span class="hljs-variable">pid</span> = event_header.ProcessId;
    
    <span class="hljs-comment">// lookup the process image name</span>
    <span class="hljs-keyword">let</span> <span class="hljs-variable">process_image</span> = {
        <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">get_process_image_from_pid</span>(pid, event_header) {
            <span class="hljs-title function_ invoke__">Ok</span>(s) =&gt; s,
            <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; <span class="hljs-keyword">return</span>,
        }
    };

    <span class="hljs-keyword">if</span> process_image.<span class="hljs-title function_ invoke__">to_ascii_lowercase</span>().<span class="hljs-title function_ invoke__">contains</span>(<span class="hljs-string">"malware"</span>) || process_image.<span class="hljs-title function_ invoke__">to_ascii_lowercase</span>().<span class="hljs-title function_ invoke__">contains</span>(<span class="hljs-string">"notepad"</span>) {

        <span class="hljs-keyword">if</span> keyword &amp; KERNEL_THREATINT_KEYWORD_ALLOCVM_REMOTE == KERNEL_THREATINT_KEYWORD_ALLOCVM_REMOTE {
            <span class="hljs-title function_ invoke__">event_log</span>(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Remote memory allocation caught for pid: {}, image: {}. Data: {:?}"</span>, pid, process_image, event_header.EventDescriptor), EVENTLOG_SUCCESS, EventID::ProcessOfInterestTI);
        }

    }

}

<span class="hljs-comment">/// Get the process image as a string for a given pid</span>
<span class="hljs-comment">/// </span>
<span class="hljs-comment">/// # Errors</span>
<span class="hljs-comment">/// This function will return an error if it cannot get a handle to the pid, or there was a string conversion error from the image buffer.</span>
<span class="hljs-comment">/// This function is unable to get a handle to SYSTEM processes.</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_process_image_from_pid</span>(pid: <span class="hljs-type">u32</span>, event_header: &amp;EVENT_HEADER) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>, ()&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-variable">process_handle</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">unsafe</span> { <span class="hljs-title function_ invoke__">OpenProcess</span>(PROCESS_ALL_ACCESS, <span class="hljs-literal">false</span>, pid) } {
        <span class="hljs-title function_ invoke__">Ok</span>(h) =&gt; h,
        <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; {
            <span class="hljs-title function_ invoke__">event_log</span>(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Failed to open process for pid: {pid} from event information: {:?}. Error: {e}"</span>, event_header.EventDescriptor), EVENTLOG_ERROR_TYPE, EventID::GeneralError);
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(());
        },
    };

    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">process_img_buffer</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u16</span>&gt; = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0u16</span>; MAX_PATH <span class="hljs-keyword">as</span> _];
    <span class="hljs-keyword">let</span> <span class="hljs-variable">len</span> = <span class="hljs-keyword">unsafe</span> { <span class="hljs-title function_ invoke__">GetProcessImageFileNameW</span>(process_handle, process_img_buffer.<span class="hljs-title function_ invoke__">as_mut_slice</span>()) };
    <span class="hljs-keyword">if</span> len == <span class="hljs-number">0</span> {
        <span class="hljs-title function_ invoke__">event_log</span>(&amp;<span class="hljs-built_in">format!</span>(
            <span class="hljs-string">"Failed to get process image for pid: {pid} from event information: {:?}. Win32 Error: {}"</span>, 
                event_header.EventDescriptor, 
                <span class="hljs-keyword">unsafe</span> { <span class="hljs-title function_ invoke__">GetLastError</span>().<span class="hljs-number">0</span>} ), 
            EVENTLOG_ERROR_TYPE,
            EventID::GeneralError
        );
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(());
    }

    <span class="hljs-keyword">let</span> <span class="hljs-variable">process_image</span>: <span class="hljs-type">String</span> = <span class="hljs-keyword">match</span> <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from_utf16</span>(&amp;process_img_buffer) {
        <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-keyword">mut</span> s) =&gt; {
            s.<span class="hljs-title function_ invoke__">truncate</span>(len <span class="hljs-keyword">as</span> _);
            s
        },
        <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; {
            <span class="hljs-title function_ invoke__">event_log</span>(
                &amp;<span class="hljs-built_in">format!</span>(
                <span class="hljs-string">"Failed to convert image name to string for process: {pid} from event information: {:?}. Error: {e}"</span>, 
                    event_header.EventDescriptor
                ),
                EVENTLOG_ERROR_TYPE,
                EventID::GeneralError
            );
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(());
        },
    };

    <span class="hljs-title function_ invoke__">Ok</span>(process_image)
}
</code></pre>

<h2 id="next-steps">Next steps</h2>

<p>If you are following along - I would spend some time just flat out logging as much as you can to the event system (or a file) and making some really
rich prints of what ETW:TI is emitting.</p>

<p>If you havent been following along and want to have a go - I would recommend cloning my whole project at the
<a href="https://github.com/0xflux/Sanctum/tree/e861d80cf00317280d29b1add7b573778daae772" target="_blank">commit e861d80</a>, and getting yourself a self-signed ELAM certificate
<a href="https://fluxsec.red/creating-a-ppl-protected-process-light-in-rust-windows" target="_blank">detailed in this blog post</a> and running it. I don’t think the driver needs to
be running (as I seem to get PPL execution without the driver running) so you don’t have to worry about environment config the driver / Sanctum project needs.
Basically, follow the instructions in my <a href="https://fluxsec.red/creating-a-ppl-protected-process-light-in-rust-windows" target="_blank">blog post</a> and running <strong>sanctum_ppl_runner</strong>
will allow you to run the ETW:TI tracing!</p>

<p>For me, the next steps now are to implement these ETW events with my EDR, and start detecting malware - seeing if I can also find a clever way of tuning any false positives
in a way which can grow at scale.</p>

<p>As a reminder what this looks like in the event viewer when <strong>malware.exe</strong> tries to inject into <strong>notepad.exe</strong> (included in the Sanctum project):</p>

<p><img class="wide-img" src="https://fluxsec.red/static/images/rem_mem_etw.png" alt="Detecting VirtualAllocEx EDR"></p>

<p>Until next time, ciao!</p>


            

        </main>
        
        

    </div>



</body></html>