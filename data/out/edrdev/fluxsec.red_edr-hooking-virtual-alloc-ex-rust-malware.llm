Title:
Hooking VirtualAllocEx for remote process memory allocation monitoring in Rust

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how to hook `VirtualAllocEx`/`ZwAllocateVirtualMemory` to monitor remote process memory allocations, implemented in Rust.  
- It focuses on the practical complications of intercepting a syscall with six parameters under the Windows x64 ABI, where only the first four arguments are passed in registers and the rest must be placed on the stack.  
- The author details “shadow space” requirements (32 bytes) and correct stack layout/alignment when building an inline-assembly syscall stub that forwards arguments and executes `syscall`.  
- It also refactors a function-pointer/stub tracking mechanism to manage multiple hooked syscall pairs (NTDLL target and callback).  
- Useful for red teamers and malware researchers building injection telemetry or custom EDR-like monitoring, and for defenders studying syscall-level instrumentation and evasion tradeoffs.  
- Interesting because it demonstrates low-level ABI-correct syscall forwarding in Rust, a common failure point when implementing hooks beyond 4 arguments.

Technical Focus:
- Windows x64 calling convention (RCX/RDX/R8/R9 + stack args)
- Shadow space and stack layout for syscall stubs
- Hooking `VirtualAllocEx` via `ZwAllocateVirtualMemory` (NTDLL)
- Rust inline assembly (`asm!`) for direct syscalls
- Syscall numbers (SSN) and `r10 <- rcx` syscall convention
- Managing multiple hook targets via stub address tracking (HashMap)

Use Cases:
- Monitor/detect remote process memory allocation as an injection precursor
- Build an EDR-style usermode syscall hook framework in Rust
- Research syscall-hook correctness and bypass/evasion implications
- Instrument `ZwAllocateVirtualMemory` arguments for behavioral analytics

Keywords:
VirtualAllocEx, ZwAllocateVirtualMemory, NTDLL, syscall hooking, Windows x64 ABI, calling convention, shadow space, stack arguments, RCX RDX R8 R9, SSN, r10 rcx, Rust asm!, remote process injection, memory allocation telemetry, usermode hooks, inline patching, HANDLE, EDR instrumentation, Sanctum, Ghost Hunting