Title:
Better know a data source: Antimalware Scan Interface (AMSI)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains Microsoft’s Antimalware Scan Interface (AMSI) as a key telemetry source for detecting in-memory and “fileless” execution across scripting engines and other Windows components.  
- It breaks down how AMSI works (amsi.dll sessions, AmsiScanString/AmsiScanBuffer, provider registration via COM GUIDs in the registry) and what applications emit AMSI scan buffers (PowerShell, VBScript/JScript, Office VBA/XLM macros, WMI, .NET assembly loads, VSS operations, UAC).  
- The authors show how to collect AMSI telemetry via the Microsoft-Antimalware-Scan-Interface ETW provider (event 1101), interpret fields (AppName, Content, ContentName, ScanResult, SHA256 hash), and use a helper parser (Get-AMSIEvent).  
- Practical examples demonstrate how AMSI captures WMI persistence operations and PowerShell reflective-loading behavior, including full script content and even full in-memory .NET PE bytes for assembly loads.  
- It also covers defensive alternatives and complements (PowerShell Operational logs 4104/4103, classic log 800) and discusses preventive controls like AppLocker/WDAC and Defender ASR rules.  
- Most useful for Blue Teams and detection engineers building high-fidelity detections for script/macro tradecraft; also valuable to red teams for understanding what content is exposed to defenders.

Technical Focus:
- AMSI architecture (amsi.dll API, sessions, providers, AMSI_RESULT)
- AMSI provider registration (HKLM\SOFTWARE\Microsoft\AMSI\Providers, COM CLSID/InprocServer32)
- ETW collection and parsing (Microsoft-Antimalware-Scan-Interface, event 1101, logman, ETL)
- Telemetry semantics (AppName mapping, Content vs ContentName, SHA256 hashing, binary buffers)
- Detection opportunities for WMI and PowerShell/.NET reflective loading
- Compensating logs and controls (PowerShell 4104/4103/4103, WDAC/AppLocker, Defender ASR)

Use Cases:
- Build detections for fileless script execution using AMSI buffer content and AppName context
- Triage suspicious WMI activity (event consumer/filter creation) via AMSI “WMI” buffers
- Detect PowerShell reflective loaders by matching suspicious Win32 API strings (VirtualAlloc/CreateThread, etc.)
- Extract and scan in-memory .NET assemblies captured by AMSI (e.g., YARA on PE bytes)
- Validate logging/visibility gaps and augment with PowerShell Operational logs when AMSI isn’t accessible
- Map and test preventive controls (WDAC/AppLocker, ASR rules) against script/macro tradecraft

Keywords:
AMSI, Antimalware Scan Interface, amsi.dll, AmsiInitialize, AmsiOpenSession, AmsiScanBuffer, AmsiScanString, AMSI provider, IAntimalwareProvider, ETW, Microsoft-Antimalware-Scan-Interface, event 1101, logman, Get-WinEvent, PowerShell 4104, PowerShell 4103, WMI fastprox.dll, VBE7.dll, vbscript.dll, jscript.dll, clr.dll, coreclr.dll, reflective loading, VirtualAlloc, CreateThread, WDAC, AppLocker, Defender ASR, T1546.003, T1620