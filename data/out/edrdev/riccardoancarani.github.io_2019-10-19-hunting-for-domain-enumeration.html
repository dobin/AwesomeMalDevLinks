# https://riccardoancarani.github.io/2019-10-19-hunting-for-domain-enumeration/

<!DOCTYPE html><html lang="en"><!-- Beautiful Jekyll | MIT license | Copyright Dean Attali 2016 -->


  <body>

    

  
    


    <!-- TODO this file has become a mess, refactor it -->











<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

      

      <article role="main" class="blog-post">
        <h3 id="intro">Intro</h3>
<p>This is another post to document my journey of learning Threat Hunting. In today’s post we’re going to perform threat hunting activities with the aim of hunting for AD domain enumeration.</p>

<p>We’re going to heavily rely on FireEye’s SilkETW and we’ll search for suspicious LDAP queries generated by our endpoints.</p>

<p><a href="https://github.com/fireeye/SilkETW">SilkETW</a> is a handy wrapper for Event Tracing for Windows (ETW) that will allow us to perform searches and ship to centralised logging platforms like ElasticSearch. ETW is defined by Microsoft as:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Event Tracing for Windows (ETW) is an efficient kernel-level tracing facility that lets you log kernel or application-defined events to a log file. You can consume the events in real time or from a log file and use them to debug an application or to determine where performance issues are occurring in the application.
</code></pre></div></div>
<p>SilkETW provides support for Yara rules, this means that we can define malicious patterns for events. For example, in FireEye’s <a href="https://www.fireeye.com/blog/threat-research/2019/03/silketw-because-free-telemetry-is-free.html">SilkETW: Because Free Telemetry is … Free!</a>, <a href="https://twitter.com/fuzzysec?lang=en">@b33f</a> shows us how to create Yara rules for detecting cobaltstrike’s <code class="language-plaintext highlighter-rouge">execute-assembly</code> in memory. Crazy.</p>

<p>In this example we’re going to use LDAP ETW provider, which will give us events for all the LDAP queries generated by our endpoints. I executed SilkETW with the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SilkETW.exe -t user -pn Microsoft-Windows-LDAP-Client -ot file -p C:\windows\temp\ldap.json -l verbose -y C:\Tools\SilkETW\v8\SilkETW\yara\ -yo All
</code></pre></div></div>

<p>The notable options are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">-pn Microsoft-Windows-LDAP-Client</code>, that defined the LDAP provider for ETW;</li>
  <li><code class="language-plaintext highlighter-rouge">-y C:\Tools\SilkETW\v8\SilkETW\yara\</code>, that specifies the Yara rules to match, more on those later.</li>
</ul>

<p>Back to hunting.</p>

<p>As always, we start with our hypothesis:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Adversaries may search for sensitive groups or users with specific attributes that would allow them to perform further attacks.
</code></pre></div></div>

<p>More specifically, the things that an attacker that already obtained a foothold within our internal network may do the following:</p>

<ul>
  <li>Identify all the members of the <code class="language-plaintext highlighter-rouge">Domain Admins</code> or other sensitive groups;</li>
  <li>Search for all the user with <code class="language-plaintext highlighter-rouge">servicePrincipalName=*</code> for Kerberoasting attacks;</li>
  <li>Search for users with Kerberos preauthentication disabled;</li>
  <li>Search for users with <code class="language-plaintext highlighter-rouge">adminCount=1</code>.</li>
</ul>

<p>In order to identify those behaviours we need to create Yara rules for each one of the aforementioned cases.</p>

<h3 id="privileged-group-enumeration-and-admincount">Privileged Group Enumeration and AdminCount</h3>
<p>Members of the groups defined below are considered to be sensitive. Attackers will often try to enumerate members of those groups in the situational awareness phase.</p>

<p>I also decided to add the adminCount option to the rule, since it’s often used to identify privileged entities. The adminCount attribute is set to every user that was part of the AdminSDHolder sensitive group and it’s a good indicator for attackers to identify privileged users:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rule PrivilegedGroupEnumeration
{
	strings:
		$s1 = "Domain Admins" ascii wide nocase
		$s2 = "Account Operators" ascii wide nocase
		$s3 = "Backup Operators" ascii wide nocase
		$s4 = "DnsAdmin" ascii wide nocase
		$s5 = "Enterprise Admins" ascii wide nocase
		$s6 = "Group Policy Creator Owners" ascii wide nocase
		$s7 = "admincount=1"
	condition:
		any of ($s*)
}
</code></pre></div></div>

<h3 id="spn-scanning">SPN Scanning</h3>

<p>Scanning for all the SPN within a domain can be seen as one of the first reconnaissance actions to see all the available services within a domain, but also default options of tools that perform Kerberoasting will do the same:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rule SPNScanning {
	strings:
		$s1 = /serviceprincipalname=\*/ ascii wide nocase
		$s2 = /serviceprincipalname=\*\/\*/ ascii wide nocase
	condition:
		any of ($s*)
}
</code></pre></div></div>

<h3 id="kerberos-pre-authentication-disabled">Kerberos Pre-authentication Disabled</h3>
<p>Kerberos pre-auth is a UAC option that, if disabled, would allow adversaries to perform ASREP-Roasting attacks. The following Yara rule will identify attempts to enumerate users with Kerberos pre-auth disabled:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rule ASREPRoasting {
	strings:
		$s1 = "(userAccountControl:1.2.840.113556.1.4.803:=4194304)" ascii wide nocase

	condition:
		any of ($s*)
}
</code></pre></div></div>

<h3 id="testing-time">Testing Time</h3>

<p>In order to verify the rules we just created, we need to perform some form of enumeration. In the screenshot below I used PowerView’s cmdlet for detecting users with kerberos pre-auth disabled and also the <code class="language-plaintext highlighter-rouge">setspn.exe</code> utility to find all the SPN within my domain:</p>

<p><img src="https://riccardoancarani.github.io/assets/2019-10-19-hunting-for-domain-enumeration/bd7b34fc7a8f0d4253ac23b36568a8e7.png" alt=""></p>

<p>As it is possible to see, we’re correctly detecting enumeration activities!</p>

<p><img src="https://riccardoancarani.github.io/assets/2019-10-19-hunting-for-domain-enumeration/b7957a1c49c9e242e2d09ce8df231797.png" alt=""></p>

<h3 id="final-thoughts">Final Thoughts</h3>

<ul>
  <li>This approach may cause false positives, in my small lab it works fine but in bigger environments it may not!</li>
  <li>For the moment I’m just outputting to a file, it’s just for testing purposes since my HELK machine takes half of the RAM of my laptop. With SilkETW it’s possible to output to ElasticSearch out-of-the-box.</li>
  <li>A huge thanks to Ruben who developed this amazing tool!</li>
</ul>

      </article>

      
        <div class="blog-tags">
          Tags:
          
          
            <a href="https://riccardoancarani.github.io/tags#threat-hunting">threat-hunting</a>
          
          
        </div>
      

      
        <!-- Check if any share-links are active -->




<section id="social-share-section">
  <span class="sr-only">Share: </span>

  
  <!--- Share on Twitter -->
    <a href="https://twitter.com/intent/tweet?text=Hunting+for+Suspicious+LDAP+Activity+with+SilkETW+and+Yara&amp;url=https%3A%2F%2Friccardoancarani.github.io%2F2019-10-19-hunting-for-domain-enumeration%2F" class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fa fa-fw fa-twitter" aria-hidden="true"></span>
      <span class="sr-only">Twitter</span>
    </a>
  

  
  <!--- Share on Facebook -->
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Friccardoancarani.github.io%2F2019-10-19-hunting-for-domain-enumeration%2F" class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fa fa-fw fa-facebook" aria-hidden="true"></span>
      <span class="sr-only">Facebook</span>
    </a>
  

  
  <!--- Share on LinkedIn -->
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Friccardoancarani.github.io%2F2019-10-19-hunting-for-domain-enumeration%2F" class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fa fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

</section>



      

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="https://riccardoancarani.github.io/2019-10-19-hunting-covenant-msbuild/" data-toggle="tooltip" data-placement="top" title="Hunting for Anomalous Usage of MSBuild and Covenant">← Previous Post</a>
        </li>
        
        
        <li class="next">
          <a href="https://riccardoancarani.github.io/2019-11-08-not-all-paths-are-equal/" data-toggle="tooltip" data-placement="top" title="Not All Paths are Created Equal">Next Post →</a>
        </li>
        
      </ul>

      
        <div class="disqus-comments">
          
        </div>
          
        <div class="staticman-comments">
          

        </div>
        <div class="justcomments-comments">
          
        </div>
      
    </div>
  </div>
</div>


    

  
    


  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      
    
  






  
  

</body></html>