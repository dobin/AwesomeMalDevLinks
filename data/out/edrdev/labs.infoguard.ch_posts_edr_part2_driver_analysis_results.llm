Title:
Attacking EDRs Part 2: Driver Analysis Results

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post reports results from analyzing Windows kernel-driver attack surface in two EDR products (Palo Alto Cortex XDR and Sophos Intercept X) from a low-privileged attacker perspective.  
- For Cortex XDR, the author reverse engineers multiple device interfaces and IOCTL handlers, finding a minor authorization weakness where a low-privileged process can “claim” a PID-based authorization gate early in boot, interfering with certain protected IOCTLs; this was fixed as CVE-2024-5905.  
- The analysis also maps Cortex’s access-control design involving a shared driver (cyvrlpc.sys) that tracks processes in an AVL table via PsSetCreateProcessNotifyRoutineEx and applies checks based on token SID (SYSTEM) and executable path.  
- For Sophos Intercept X, the author targets a MiniFilter FilterConnectionPort MessageCallback with snapshot fuzzing using WTF, describing practical setup (Hyper-V + WinDbg + bdump + Lighthouse + Tenet) and pitfalls that caused false positives (incorrect CR8/IRQL captured during debugger break).  
- Additional bypass ideas are discussed: executing malware before EDR user-mode is fully started, and launching Cortex’s cyserver.exe without PPL by manipulating service startup behavior.  
- Useful for vulnerability researchers, red teamers, and defenders assessing EDR self-protection and kernel interface hardening.

Technical Focus:
- Windows kernel driver IOCTL interface analysis (IRP_MJ_DEVICE_CONTROL)
- EDR self-protection / authorization models (PID gates, token SID + path checks)
- Shared-kernel policy components (cyvrlpc.sys, process tracking via AVL tables)
- MiniFilter communication ports (FilterConnectionPort, MessageCallback)
- Snapshot fuzzing on Windows (WTF, bdump) and coverage/debug workflows (Lighthouse, Tenet, ret-sync)
- Kernel debugging and IRQL/CR8 correctness issues in snapshots

Use Cases:
- Identify and validate low-privilege attack surface in EDR kernel drivers (open ACL device objects, IOCTL reachability)
- Reproduce/understand CVE-2024-5905-style authorization logic flaws in driver dispatch paths
- Build snapshot-fuzzing harnesses for MiniFilter comm ports and triage crashes with Tenet traces
- Assess EDR boot-time gaps (early-start malware) and self-protection assumptions (PPL/service manipulation)
- Improve defensive hardening: stricter device ACLs, robust caller authentication, safer kernel IPC parsing

Keywords:
Palo Alto Cortex XDR, Sophos Intercept X, Windows kernel driver, IOCTL, IRP_MJ_DEVICE_CONTROL, device object ACL, tedrdrv.sys, cyvrmtgn.sys, cyvrlpc.sys, MiniFilter, FilterConnectionPort, MessageCallback, PsSetCreateProcessNotifyRoutineEx, RTL_AVL_TABLE, ALPC, PPL, WinDbg, ret-sync, IDA Pro, Lighthouse, Tenet, snapshot fuzzing, WTF fuzzer, bdump, CR8, IRQL, CVE-2024-5905, early startup bypass, service manipulation, Mimikatz