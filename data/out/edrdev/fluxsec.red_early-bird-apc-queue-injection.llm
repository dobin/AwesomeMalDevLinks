Title:
Detecting Early Bird APC Queue Injection & Enhancing Ghost Hunting

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post outlines a detection strategy for Early Bird APC queue injection and proposes improvements to the author’s “Ghost Hunting” telemetry correlation approach for an EDR.  
- It argues Early Bird is still detectable because an external injector must perform observable actions (e.g., `VirtualAllocEx`, `WriteProcessMemory`, `QueueUserAPC`) even if the target process is created suspended before user-mode hooks/DLL injection.  
- The author proposes moving Ghost Hunting from a user-mode polling/IPC model into a kernel driver via IOCTLs to reduce latency and improve reliability.  
- A key enhancement is attributing suspicious memory/protection changes to the *victim process* while retaining metadata about the responsible processes to handle multi-process malware and track “history” of memory region transitions (RW → R → RX).  
- For Early Bird detection, the strategy combines API/ETW visibility of the injector with validation that `QueueUserAPC` targets injected/user-allocated memory rather than legitimate `.text` sections.  
- It also explores using `PsSetCreateThreadNotifyRoutine` to study thread start addresses and flag threads starting in user-allocated memory as highly irregular when correlated with injection indicators.

Technical Focus:
- Early Bird APC queue injection (suspended process + `QueueUserAPC`)
- Kernel telemetry and callbacks (`PsSetCreateThreadNotifyRoutine`)
- Cross-process injection primitives (`VirtualAllocEx`, `WriteProcessMemory`)
- ETW-based monitoring and event correlation
- Memory region provenance and protection transition tracking (RW/RX history)
- Attribution/correlation for multi-process malware (“Ghost Hunting” improvements)

Use Cases:
- Detecting and triaging Early Bird APC injection attempts in an EDR
- Correlating injector activity to victim process memory modifications over time
- Flagging suspicious APC targets and thread start addresses outside `.text`
- Building kernel-assisted telemetry pipelines (IOCTL-driven vs user-mode polling)
- Hunting for SysWhispers/Hell’s Gate style NTAPI evasion via injector-side visibility

Keywords:
Early Bird, APC injection, QueueUserAPC, VirtualAllocEx, WriteProcessMemory, process injection, suspended process, EDR bypass, ETW, kernel driver, IOCTL, PsSetCreateThreadNotifyRoutine, thread start address, memory protections, RWX, RX transition, .text section, SysWhispers, Hell’s Gate, Heaven’s Gate