# https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/

<!DOCTYPE html><html class="transition bg-[var(--page-bg)] md:text-[16px] text-[14px] dark swup-enabled" data-astro-cid-sckkx6r4="" data-overlayscrollbars-initialize="" lang="en" style="--bannerOffset: 15vh; --banner-height-home: 65vh; --banner-height: 35vh; --configHue: 235; --page-width: 75rem; --hue: 235; --banner-height-extend: 30000px; --hue-hl: 97;" data-overlayscrollbars="" data-overlayscrollbars-viewport="scrollbarHidden overflowXScroll overflowYHidden"><body class="transition min-h-screen" data-astro-cid-sckkx6r4="" data-overlayscrollbars-initialize="" style="--bannerOffset:15vh;--banner-height-home:65vh;--banner-height:35vh;--configHue:235;--page-width:75rem"><div id="config-carrier" data-hue="235"></div><div class="transition-all duration-700 max-w-[var(--page-width)] md:px-4 mx-auto pointer-events-none px-0 relative z-50" id="top-row"><div class="transition-all pointer-events-auto sticky top-0" id="navbar-wrapper"><div class="onload-animation z-50" id="navbar"><div class="transition absolute -top-8 bg-[var(--card-bg)] h-8 left-0 right-0"></div><div class="flex items-center justify-between !overflow-visible !rounded-t-none card-base h-[4.5rem] max-w-[var(--page-width)] mx-auto pt-4 px-4"><a href="https://labs.infoguard.ch/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-[3.25rem] mb-2"><div class="mr-24 relative"><svg height="50" width="50" class="stroke-[#FFDC00] stroke-[5]" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg" fill="none"><circle cx="25" cy="25" r="22.5"></circle></svg><div class="absolute top-0 left-[60px]"><svg height="13" width="72" class="fill-[#A0A0A0]" viewBox="0 0 85 15" xmlns="http://www.w3.org/2000/svg"><path d="M54.918 3.90489V14.1256H52.3377V12.8975C51.561 13.8612 50.6015 14.331 49.417 14.331C47.1621 14.331 45.7602 12.8114 45.7602 10.3672V3.90489H48.3211V9.69047C48.3211 11.1406 49.0152 11.9382 50.2731 11.9382C51.5311 11.9382 52.3362 11.0621 52.3362 9.65119V3.90489H54.918ZM64.5795 4.92605C65.3157 5.64811 65.6875 6.71459 65.6875 8.09679V14.1271H63.1821V13.1286C62.392 13.9186 61.344 14.3325 60.1311 14.3325C58.3799 14.3325 56.4938 13.3265 56.4938 11.1195V11.0817C56.4938 8.98653 58.0695 7.73576 60.7083 7.73576C61.8013 7.73576 62.5824 7.90796 63.2001 8.09377V8.05902C63.2001 6.4019 61.9557 6.05446 60.9122 6.05446C59.8687 6.05446 59.0261 6.29767 58.158 6.66172L58.0066 6.72517L57.9541 6.56958L57.3573 4.78556L57.3124 4.65263L57.4398 4.59523C58.3829 4.16924 59.4924 3.77347 61.2106 3.77347C62.6859 3.77347 63.8508 4.17226 64.578 4.92605H64.5795ZM63.2376 10.405V9.83548C62.7833 9.66932 62.0757 9.48805 61.1551 9.48805C59.7847 9.48805 58.9976 10.0334 58.9976 10.9866V11.0243C58.9976 11.8431 59.6903 12.3718 60.7638 12.3718C62.1971 12.3718 63.2376 11.544 63.2376 10.405ZM73.7103 3.71757L73.8572 3.72362V6.42909H73.5738C71.5393 6.42909 70.3743 7.80222 70.3743 10.198V14.1271H67.8135V3.90489H70.3743V5.62697C71.082 4.37166 72.1615 3.71455 73.5273 3.71455C73.5888 3.71455 73.6503 3.71455 73.7118 3.71908L73.7103 3.71757ZM85 0.111784V14.1256H82.4392V12.7736C81.5771 13.8204 80.5261 14.331 79.2397 14.331C76.9518 14.331 74.5214 12.4745 74.5214 9.03336V8.99559C74.5214 5.51669 76.8963 3.69794 79.2397 3.69794C80.5231 3.69794 81.5726 4.17982 82.4392 5.16623V0.111784H85ZM82.4767 9.03336V8.99559C82.4767 7.27502 81.3162 5.97742 79.7794 5.97742C78.2426 5.97742 77.1002 7.21913 77.1002 8.99559V9.03336C77.1002 10.7539 78.2516 12.0515 79.7794 12.0515C81.1048 12.0515 82.4767 10.9216 82.4767 9.03336ZM3.21708e-05 0.117806L0 14.1256H2.56081L2.56084 0.117806H3.21708e-05ZM10.2852 3.69794C9.10677 3.69794 8.14721 4.16471 7.36458 5.12092V3.90489H4.80377V14.1256H7.36458V8.37625C7.36458 6.97593 8.1742 6.07108 9.42912 6.07108C10.684 6.07108 11.3812 6.87623 11.3812 8.33848V14.1241H13.942V7.64361C13.942 5.21004 12.5417 3.69643 10.2867 3.69643L10.2852 3.69794ZM32.7373 8.99559V9.03336C32.7373 12.0153 30.3549 14.3491 27.3128 14.3491C24.2707 14.3491 21.9423 12.0304 21.9423 9.06961V9.03185C21.9423 6.03936 24.3172 3.69643 27.3503 3.69643C30.3834 3.69643 32.7388 6.02425 32.7388 8.99408L32.7373 8.99559ZM24.5031 9.03336C24.5031 10.7267 25.7535 12.0515 27.3488 12.0515C28.9441 12.0515 30.1765 10.7977 30.1765 9.07112V9.03336C30.1765 7.30222 28.9456 5.99706 27.3113 5.99706C25.6771 5.99706 24.5016 7.25841 24.5016 8.9971V9.03487L24.5031 9.03336ZM19.5944 0C18.5869 0 17.8252 0.273418 17.269 0.833848C16.7082 1.40032 16.4234 2.25834 16.4234 3.38373V3.96078H15.1744V6.16625H16.4234V14.1256H18.9842V6.16625H21.5555V3.98042H18.9467V3.59068C18.9467 2.67224 19.3125 2.24323 20.0982 2.24323C20.5719 2.24323 20.9498 2.33689 21.3726 2.4804L21.575 2.54686V0.302119L21.4655 0.268886C21.0187 0.135954 20.449 0 19.5959 0H19.5944ZM33.7043 5.88226C34.1211 3.88525 35.9788 2.43055 37.9174 2.43055C39.5456 2.43055 40.4842 2.95472 41.4707 3.80217L41.5877 3.90338L41.6866 3.78404L43.1395 2.0393L43.2369 1.92148L43.12 1.82178C41.6072 0.527198 40.1274 0 38.0118 0C35.526 0 33.0162 1.45319 31.8017 3.54537C32.5994 4.17226 33.2501 4.96835 33.7043 5.88226ZM43.5728 6.47592V12.2207L43.5188 12.2675C42.4153 13.2177 40.5577 14.3507 37.9789 14.3507C36.1722 14.3507 34.5919 13.7948 33.3685 12.7419C33.9037 11.8899 34.2561 10.9125 34.376 9.85512C35.0972 11.1452 36.4121 11.9397 38.0538 11.9397C39.1513 11.9397 40.2368 11.6059 41.0479 11.0213V8.79468H37.7135V6.47743H43.5713L43.5728 6.47592Z"></path></svg> <span class="-mt-1.5 dark:text-white inline-block text-[#575757] text-[1.2rem]">LABS</span></div></div></a><div class="hidden md:flex"><a href="https://labs.infoguard.ch/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-11" aria-label="Home"><div class="flex items-center">Home</div></a><a href="https://labs.infoguard.ch/posts/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-11" aria-label="Posts"><div class="flex items-center">Posts</div></a><a href="https://labs.infoguard.ch/velociraptor/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-11" aria-label="Velociraptor"><div class="flex items-center">Velociraptor</div></a><a href="https://labs.infoguard.ch/advisories/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-11" aria-label="Advisories"><div class="flex items-center">Advisories</div></a><a href="https://labs.infoguard.ch/archive/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-11" aria-label="Archive"><div class="flex items-center">Archive</div></a><a href="https://infoguard.ch/" class="rounded-lg font-bold active:scale-95 btn-plain px-5 scale-animation h-11" aria-label="InfoGuard" target="_blank"><div class="flex items-center">InfoGuard <svg height="1em" width="1em" class="transition -translate-y-[1px] dark:text-white/[0.2] ml-1 text-[0.875rem] text-black/[0.2]" data-icon="fa6-solid:arrow-up-right-from-square"><symbol id="ai:fa6-solid:arrow-up-right-from-square" viewBox="0 0 512 512"><path d="M320 0c-17.7 0-32 14.3-32 32s14.3 32 32 32h82.7L201.4 265.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L448 109.3V192c0 17.7 14.3 32 32 32s32-14.3 32-32V32c0-17.7-14.3-32-32-32zM80 32C35.8 32 0 67.8 0 112v320c0 44.2 35.8 80 80 80h320c44.2 0 80-35.8 80-80V320c0-17.7-14.3-32-32-32s-32 14.3-32 32v112c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16h112c17.7 0 32-14.3 32-32s-14.3-32-32-32z" fill="currentColor"></path></symbol><use href="#ai:fa6-solid:arrow-up-right-from-square"></use></svg></div></a></div><div class="flex"><astro-island client="only" component-export="default" component-url="/_astro/Search.DlUmB71x.js" opts="{&quot;name&quot;:&quot;Search&quot;,&quot;value&quot;:&quot;svelte&quot;}" props="{}" renderer-url="/_astro/client.svelte.DYqRqnAG.js" uid="ZEG73h"><div id="search-bar" class="hidden lg:flex transition-all items-center h-11 mr-2 rounded-lg
      bg-black/[0.04] hover:bg-black/[0.06] focus-within:bg-black/[0.06]
      dark:bg-white/5 dark:hover:bg-white/10 dark:focus-within:bg-white/10
"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="absolute text-[1.25rem] pointer-events-none ml-3 transition my-auto text-black/30 dark:text-white/30 iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"></path><!----></svg><!----> <input class="transition-all pl-10 text-sm bg-transparent outline-0
         h-full w-40 active:w-60 focus:w-60 text-black/50 dark:text-white/50 svelte-1gu5h8y" placeholder="Search"></div> <button aria-label="Search Panel" id="search-switch" class="btn-plain scale-animation lg:!hidden rounded-lg w-11 h-11 active:scale-90"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"></path><!----></svg><!----></button> <div id="search-panel" class="float-panel float-panel-closed search-panel absolute md:w-[30rem] top-20 left-4 md:left-[unset] right-4 shadow-2xl rounded-2xl p-2"><div id="search-bar-inside" class="flex relative lg:hidden transition-all items-center h-11 rounded-xl
      bg-black/[0.04] hover:bg-black/[0.06] focus-within:bg-black/[0.06]
      dark:bg-white/5 dark:hover:bg-white/10 dark:focus-within:bg-white/10
  "><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="absolute text-[1.25rem] pointer-events-none ml-3 transition my-auto text-black/30 dark:text-white/30 iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"></path><!----></svg><!----> <input placeholder="Search" class="pl-10 absolute inset-0 text-sm bg-transparent outline-0
               focus:w-60 text-black/50 dark:text-white/50 svelte-1gu5h8y"></div> <!----></div></astro-island><astro-island client="load" component-export="default" component-url="/_astro/LightDarkSwitch.gKnghUdE.js" opts="{&quot;name&quot;:&quot;LightDarkSwitch&quot;,&quot;value&quot;:true}" props="{}" renderer-url="/_astro/client.svelte.DYqRqnAG.js" uid="2ad1lD" await-children=""><div class="relative z-50" role="menu" tabindex="-1"><button aria-label="Light/Dark Mode" role="menuitem" class="relative btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90" id="scheme-switch"><div class="absolute opacity-0"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M11 3V2q0-.425.288-.712T12 1t.713.288T13 2v1q0 .425-.288.713T12 4t-.712-.288T11 3m0 19v-1q0-.425.288-.712T12 20t.713.288T13 21v1q0 .425-.288.713T12 23t-.712-.288T11 22m11-9h-1q-.425 0-.712-.288T20 12t.288-.712T21 11h1q.425 0 .713.288T23 12t-.288.713T22 13M3 13H2q-.425 0-.712-.288T1 12t.288-.712T2 11h1q.425 0 .713.288T4 12t-.288.713T3 13m16.75-7.325l-.35.35q-.275.275-.687.275T18 6q-.275-.275-.288-.687t.263-.713l.375-.375q.275-.3.7-.3t.725.3t.288.725t-.313.725M6.025 19.4l-.375.375q-.275.3-.7.3t-.725-.3t-.288-.725t.313-.725l.35-.35q.275-.275.688-.275T6 18q.275.275.288.688t-.263.712m12.3.35l-.35-.35q-.275-.275-.275-.687T18 18q.275-.275.688-.287t.712.262l.375.375q.3.275.3.7t-.3.725t-.725.288t-.725-.313M4.6 6.025l-.375-.375q-.3-.275-.3-.7t.3-.725t.725-.288t.725.313l.35.35q.275.275.275.688T6 6q-.275.275-.687.288T4.6 6.025M7.75 16.25Q6 14.5 6 12t1.75-4.25T12 6t4.25 1.75T18 12t-1.75 4.25T12 18t-4.25-1.75m7.088-1.412Q16 13.675 16 12t-1.162-2.838T12 8T9.162 9.163T8 12t1.163 2.838T12 16t2.838-1.162M12 12"></path><!----></svg><!----></div> <div class="absolute"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M12 21q-3.775 0-6.387-2.613T3 12q0-3.45 2.25-5.988T11 3.05q.325-.05.575.088t.4.362t.163.525t-.188.575q-.425.65-.638 1.375T11.1 7.5q0 2.25 1.575 3.825T16.5 12.9q.775 0 1.538-.225t1.362-.625q.275-.175.563-.162t.512.137q.25.125.388.375t.087.6q-.35 3.45-2.937 5.725T12 21m0-2q2.2 0 3.95-1.213t2.55-3.162q-.5.125-1 .2t-1 .075q-3.075 0-5.238-2.163T9.1 7.5q0-.5.075-1t.2-1q-1.95.8-3.163 2.55T5 12q0 2.9 2.05 4.95T12 19m-.25-6.75"></path><!----></svg><!----></div> <div class="absolute opacity-0"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17V7Q9.925 7 8.463 8.463T7 12t1.463 3.538T12 17m0 5q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12t-2.325-5.675T12 4T6.325 6.325T4 12t2.325 5.675T12 20m0-8"></path><!----></svg><!----></div></button> <div id="light-dark-panel" class="hidden lg:block absolute transition float-panel-closed top-11 -right-2 pt-5"><div class="card-base float-panel p-2"><button class="flex transition whitespace-nowrap items-center !justify-start w-full btn-plain scale-animation rounded-lg h-9 px-3 font-medium active:scale-95 mb-0.5"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] mr-3 iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M11 3V2q0-.425.288-.712T12 1t.713.288T13 2v1q0 .425-.288.713T12 4t-.712-.288T11 3m0 19v-1q0-.425.288-.712T12 20t.713.288T13 21v1q0 .425-.288.713T12 23t-.712-.288T11 22m11-9h-1q-.425 0-.712-.288T20 12t.288-.712T21 11h1q.425 0 .713.288T23 12t-.288.713T22 13M3 13H2q-.425 0-.712-.288T1 12t.288-.712T2 11h1q.425 0 .713.288T4 12t-.288.713T3 13m16.75-7.325l-.35.35q-.275.275-.687.275T18 6q-.275-.275-.288-.687t.263-.713l.375-.375q.275-.3.7-.3t.725.3t.288.725t-.313.725M6.025 19.4l-.375.375q-.275.3-.7.3t-.725-.3t-.288-.725t.313-.725l.35-.35q.275-.275.688-.275T6 18q.275.275.288.688t-.263.712m12.3.35l-.35-.35q-.275-.275-.275-.687T18 18q.275-.275.688-.287t.712.262l.375.375q.3.275.3.7t-.3.725t-.725.288t-.725-.313M4.6 6.025l-.375-.375q-.3-.275-.3-.7t.3-.725t.725-.288t.725.313l.35.35q.275.275.275.688T6 6q-.275.275-.687.288T4.6 6.025M7.75 16.25Q6 14.5 6 12t1.75-4.25T12 6t4.25 1.75T18 12t-1.75 4.25T12 18t-4.25-1.75m7.088-1.412Q16 13.675 16 12t-1.162-2.838T12 8T9.162 9.163T8 12t1.163 2.838T12 16t2.838-1.162M12 12"></path><!----></svg><!----> Light</button> <button class="flex transition whitespace-nowrap items-center !justify-start w-full btn-plain scale-animation rounded-lg h-9 px-3 font-medium active:scale-95 mb-0.5 current-theme-btn"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] mr-3 iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M12 21q-3.775 0-6.387-2.613T3 12q0-3.45 2.25-5.988T11 3.05q.325-.05.575.088t.4.362t.163.525t-.188.575q-.425.65-.638 1.375T11.1 7.5q0 2.25 1.575 3.825T16.5 12.9q.775 0 1.538-.225t1.362-.625q.275-.175.563-.162t.512.137q.25.125.388.375t.087.6q-.35 3.45-2.937 5.725T12 21m0-2q2.2 0 3.95-1.213t2.55-3.162q-.5.125-1 .2t-1 .075q-3.075 0-5.238-2.163T9.1 7.5q0-.5.075-1t.2-1q-1.95.8-3.163 2.55T5 12q0 2.9 2.05 4.95T12 19m-.25-6.75"></path><!----></svg><!----> Dark</button> <button class="flex transition whitespace-nowrap items-center !justify-start w-full btn-plain scale-animation rounded-lg h-9 px-3 font-medium active:scale-95"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[1.25rem] mr-3 iconify iconify--material-symbols" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17V7Q9.925 7 8.463 8.463T7 12t1.463 3.538T12 17m0 5q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12t-2.325-5.675T12 4T6.325 6.325T4 12t2.325 5.675T12 20m0-8"></path><!----></svg><!----> System</button></div></div></div></astro-island><button class="rounded-lg btn-plain scale-animation h-11 active:scale-90 w-11 md:!hidden" aria-label="Menu" id="nav-menu-switch" name="Nav Menu"><svg height="1em" width="1em" class="text-[1.25rem]" data-icon="material-symbols:menu-rounded"><symbol id="ai:material-symbols:menu-rounded" viewBox="0 0 24 24"><path d="M4 18q-.425 0-.712-.288T3 17t.288-.712T4 16h16q.425 0 .713.288T21 17t-.288.713T20 18zm0-5q-.425 0-.712-.288T3 12t.288-.712T4 11h16q.425 0 .713.288T21 12t-.288.713T20 13zm0-5q-.425 0-.712-.288T3 7t.288-.712T4 6h16q.425 0 .713.288T21 7t-.288.713T20 8z" fill="currentColor"></path></symbol><use href="#ai:material-symbols:menu-rounded"></use></svg></button></div><div class="absolute float-panel-closed fixed float-panel px-2 py-2 right-4 transition-all" id="nav-menu-panel"><a href="https://labs.infoguard.ch/" class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">Home</div><svg height="1em" width="1em" class="transition text-[var(--primary)] text-[1.25rem]" data-icon="material-symbols:chevron-right-rounded"><symbol id="ai:material-symbols:chevron-right-rounded" viewBox="0 0 24 24"><path d="M12.6 12L8.7 8.1q-.275-.275-.275-.7t.275-.7t.7-.275t.7.275l4.6 4.6q.15.15.213.325t.062.375t-.062.375t-.213.325l-4.6 4.6q-.275.275-.7.275t-.7-.275t-.275-.7t.275-.7z" fill="currentColor"></path></symbol><use href="#ai:material-symbols:chevron-right-rounded"></use></svg> </a><a href="https://labs.infoguard.ch/posts/" class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">Posts</div><svg height="1em" width="1em" class="transition text-[var(--primary)] text-[1.25rem]" data-icon="material-symbols:chevron-right-rounded" viewBox="0 0 24 24"><use href="#ai:material-symbols:chevron-right-rounded"></use></svg> </a><a href="https://labs.infoguard.ch/velociraptor/" class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">Velociraptor</div><svg height="1em" width="1em" class="transition text-[var(--primary)] text-[1.25rem]" data-icon="material-symbols:chevron-right-rounded" viewBox="0 0 24 24"><use href="#ai:material-symbols:chevron-right-rounded"></use></svg> </a><a href="https://labs.infoguard.ch/advisories/" class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">Advisories</div><svg height="1em" width="1em" class="transition text-[var(--primary)] text-[1.25rem]" data-icon="material-symbols:chevron-right-rounded" viewBox="0 0 24 24"><use href="#ai:material-symbols:chevron-right-rounded"></use></svg> </a><a href="https://labs.infoguard.ch/archive/" class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">Archive</div><svg height="1em" width="1em" class="transition text-[var(--primary)] text-[1.25rem]" data-icon="material-symbols:chevron-right-rounded" viewBox="0 0 24 24"><use href="#ai:material-symbols:chevron-right-rounded"></use></svg> </a><a href="https://infoguard.ch/" class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2" target="_blank"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">InfoGuard</div><svg height="1em" width="1em" class="transition -translate-x-1 dark:text-white/25 text-[0.75rem] text-black/25" data-icon="fa6-solid:arrow-up-right-from-square" viewBox="0 0 512 512"><use href="#ai:fa6-solid:arrow-up-right-from-square"></use></svg></a></div><astro-island client="only" component-export="default" component-url="/_astro/DisplaySettings.KStfPvg9.js" opts="{&quot;name&quot;:&quot;DisplaySettings&quot;,&quot;value&quot;:&quot;svelte&quot;}" props="{}" renderer-url="/_astro/client.svelte.DYqRqnAG.js" uid="ZjfqNG"><div id="display-setting" class="float-panel float-panel-closed absolute transition-all w-80 right-4 px-4 py-4 svelte-1s19bex"><div class="flex flex-row gap-2 mb-3 items-center justify-between"><div class="flex gap-2 font-bold text-lg text-neutral-900 dark:text-neutral-100 transition relative ml-3
            before:w-1 before:h-4 before:rounded-md before:bg-[var(--primary)]
            before:absolute before:-left-3 before:top-[0.33rem]">Theme Color <button aria-label="Reset to Default" class="btn-regular w-7 h-7 rounded-md active:scale-90 opacity-0 pointer-events-none"><div class="text-[var(--btn-content)]"><!----><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="text-[0.875rem] iconify iconify--fa6-solid" width="1em" height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M125.7 160H176c17.7 0 32 14.3 32 32s-14.3 32-32 32H48c-17.7 0-32-14.3-32-32V64c0-17.7 14.3-32 32-32s32 14.3 32 32v51.2l17.6-17.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0z"></path><!----></svg><!----></div></button></div> <div class="flex gap-1"><div id="hueValue" class="transition bg-[var(--btn-regular-bg)] w-10 h-7 rounded-md flex justify-center
            font-bold text-sm items-center text-[var(--btn-content)]">235</div></div></div> <div class="w-full h-6 px-1 bg-[oklch(0.80_0.10_0)] dark:bg-[oklch(0.70_0.10_0)] rounded select-none"><input type="range" min="0" max="360" class="slider svelte-1s19bex" id="colorSlider" step="5" style="width: 100%" aria-label="Theme Color"></div></div></astro-island></div></div></div></div><div class="absolute pointer-events-none w-full z-30" style="top:5.5rem"><div class="mx-auto max-w-[var(--page-width)] relative pointer-events-auto"><div class="transition left-0 right-0 duration-700 gap-4 grid grid-cols-[17.5rem_auto] grid-rows-[auto_1fr_auto] lg:grid-rows-[auto] md:px-4 mx-auto px-0 w-full" id="main-grid"><main class="overflow-hidden col-span-2 lg:col-span-1 transition-swup-fade" id="swup-container"><div class="onload-animation" id="content-wrapper"><div class="flex w-full relative mb-4 overflow-hidden rounded-[var(--radius-large)]"><div class="card-base pb-4 md:px-9 pt-6 px-6 relative w-full z-10" id="post-container"><div class="transition flex dark:text-white/30 flex-row gap-5 mb-3 onload-animation text-black/30"><div class="flex items-center"><div class="transition flex items-center justify-center bg-black/5 dark:bg-white/10 dark:text-white/50 h-6 mr-2 rounded-md text-black/50 w-6"><svg height="1em" width="1em" class="text-xl" data-icon="material-symbols:calendar-today-outline-rounded"><symbol id="ai:material-symbols:calendar-today-outline-rounded" viewBox="0 0 24 24"><path d="M5 22q-.825 0-1.412-.587T3 20V6q0-.825.588-1.412T5 4h1V3q0-.425.288-.712T7 2t.713.288T8 3v1h8V3q0-.425.288-.712T17 2t.713.288T18 3v1h1q.825 0 1.413.588T21 6v14q0 .825-.587 1.413T19 22zm0-2h14V10H5zM5 8h14V6H5zm0 0V6z" fill="currentColor"></path></symbol><use href="#ai:material-symbols:calendar-today-outline-rounded"></use></svg></div><div class="text-sm">2025-02-17</div></div><div class="flex items-center flex-row"><div class="transition flex items-center justify-center bg-black/5 dark:bg-white/10 dark:text-white/50 h-6 mr-2 rounded-md text-black/50 w-6"><svg height="1em" width="1em" data-icon="material-symbols:notes-rounded"><symbol id="ai:material-symbols:notes-rounded" viewBox="0 0 24 24"><path d="M4 18q-.425 0-.712-.288T3 17t.288-.712T4 16h10q.425 0 .713.288T15 17t-.288.713T14 18zm0-5q-.425 0-.712-.288T3 12t.288-.712T4 11h16q.425 0 .713.288T21 12t-.288.713T20 13zm0-5q-.425 0-.712-.288T3 7t.288-.712T4 6h16q.425 0 .713.288T21 7t-.288.713T20 8z" fill="currentColor"></path></symbol><use href="#ai:material-symbols:notes-rounded"></use></svg></div><div class="text-sm">3599 words</div></div><div class="flex items-center flex-row"><div class="transition flex items-center justify-center bg-black/5 dark:bg-white/10 dark:text-white/50 h-6 mr-2 rounded-md text-black/50 w-6"><svg height="1em" width="1em" data-icon="material-symbols:schedule-outline-rounded"><symbol id="ai:material-symbols:schedule-outline-rounded" viewBox="0 0 24 24"><path d="M13 11.6V8q0-.425-.288-.712T12 7t-.712.288T11 8v3.975q0 .2.075.388t.225.337l3.3 3.3q.275.275.7.275T16 16t.275-.7t-.275-.7zM12 22q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q3.325 0 5.663-2.337T20 12t-2.337-5.663T12 4T6.337 6.338T4 12t2.338 5.663T12 20" fill="currentColor"></path></symbol><use href="#ai:material-symbols:schedule-outline-rounded"></use></svg></div><div class="text-sm">18 minutes</div></div></div><div class="onload-animation relative"><div class="transition font-bold before:absolute before:bg-[var(--primary)] before:rounded-md before:h-5 before:left-[-1.125rem] before:top-[0.75rem] block dark:text-white/90 mb-3 md:before:w-1 md:text-[2.25rem]/[2.75rem] text-3xl text-black/90 w-full" data-pagefind-body="" data-pagefind-meta="title" data-pagefind-weight="10">Attacking EDRs Part 2: Driver Analysis Results</div></div><div class="onload-animation"><div class="flex items-center dark:text-neutral-400 flex-wrap gap-4 gap-x-4 gap-y-2 mb-5 text-neutral-500"><div class="flex items-center"><div class="meta-icon"><svg height="1em" width="1em" class="text-xl" data-icon="material-symbols:person-outline"><symbol id="ai:material-symbols:person-outline" viewBox="0 0 24 24"><path d="M12 12q-1.65 0-2.825-1.175T8 8t1.175-2.825T12 4t2.825 1.175T16 8t-1.175 2.825T12 12m-8 8v-2.8q0-.85.438-1.562T5.6 14.55q1.55-.775 3.15-1.162T12 13t3.25.388t3.15 1.162q.725.375 1.163 1.088T20 17.2V20zm2-2h12v-.8q0-.275-.137-.5t-.363-.35q-1.35-.675-2.725-1.012T12 15t-2.775.338T6.5 16.35q-.225.125-.363.35T6 17.2zm6-8q.825 0 1.413-.587T14 8t-.587-1.412T12 6t-1.412.588T10 8t.588 1.413T12 10m0 8" fill="currentColor"></path></symbol><use href="#ai:material-symbols:person-outline"></use></svg></div><a href="https://twitter.com/p0w1_" class="transition flex items-center font-medium whitespace-nowrap dark:hover:text-[var(--primary)] gap-1 hover:text-[var(--primary)] link-lg text-50 text-sm" aria-label="X profile of Manuel Feifel" target="_blank" rel="noopener noreferrer"><span>Manuel Feifel </span><svg height="1em" width="1em" class="text-lg" data-icon="fa6-brands:x-twitter"><symbol id="ai:fa6-brands:x-twitter" viewBox="0 0 512 512"><path d="M389.2 48h70.6L305.6 224.2L487 464H345L233.7 318.6L106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z" fill="currentColor"></path></symbol><use href="#ai:fa6-brands:x-twitter"></use></svg></a></div><div class="flex items-center"><div class="meta-icon"><svg height="1em" width="1em" class="text-xl" data-icon="material-symbols:book-2-outline-rounded"><symbol id="ai:material-symbols:book-2-outline-rounded" viewBox="0 0 24 24"><path d="M6 15.325q.35-.175.725-.25T7.5 15H8V4h-.5q-.625 0-1.062.438T6 5.5zM10 15h8V4h-8zm-4 .325V4zM7.5 22q-1.45 0-2.475-1.025T4 18.5v-13q0-1.45 1.025-2.475T7.5 2H18q.825 0 1.413.587T20 4v12.525q0 .2-.162.363t-.588.362q-.35.175-.55.5t-.2.75t.2.763t.55.487t.55.413t.2.562v.25q0 .425-.288.725T19 22zm0-2h9.325q-.15-.35-.237-.712T16.5 18.5q0-.4.075-.775t.25-.725H7.5q-.65 0-1.075.438T6 18.5q0 .65.425 1.075T7.5 20" fill="currentColor"></path></symbol><use href="#ai:material-symbols:book-2-outline-rounded"></use></svg></div><div class="flex items-center flex-row flex-nowrap"><a href="https://labs.infoguard.ch/archive/category/Vulnerability%20Research/" class="transition text-sm text-50 dark:hover:text-[var(--primary)] font-medium hover:text-[var(--primary)] link-lg whitespace-nowrap" aria-label="View all posts in the Vulnerability Research category">Vulnerability Research</a></div></div><div class="flex items-center"><div class="meta-icon"><svg height="1em" width="1em" class="text-xl" data-icon="material-symbols:tag-rounded"><symbol id="ai:material-symbols:tag-rounded" viewBox="0 0 24 24"><path d="m9 16l-.825 3.275q-.075.325-.325.525t-.6.2q-.475 0-.775-.375T6.3 18.8L7 16H4.275q-.5 0-.8-.387T3.3 14.75q.075-.35.35-.55t.625-.2H7.5l1-4H5.775q-.5 0-.8-.387T4.8 8.75q.075-.35.35-.55t.625-.2H9l.825-3.275Q9.9 4.4 10.15 4.2t.6-.2q.475 0 .775.375t.175.825L11 8h4l.825-3.275q.075-.325.325-.525t.6-.2q.475 0 .775.375t.175.825L17 8h2.725q.5 0 .8.387t.175.863q-.075.35-.35.55t-.625.2H16.5l-1 4h2.725q.5 0 .8.388t.175.862q-.075.35-.35.55t-.625.2H15l-.825 3.275q-.075.325-.325.525t-.6.2q-.475 0-.775-.375T12.3 18.8L13 16zm.5-2h4l1-4h-4z" fill="currentColor"></path></symbol><use href="#ai:material-symbols:tag-rounded"></use></svg></div><div class="flex items-center flex-row flex-nowrap"><div class="hidden mx-1.5 text-[var(--meta-divider)] text-sm">/</div><a href="https://labs.infoguard.ch/archive/tag/VulnResearch/" class="transition text-sm text-50 dark:hover:text-[var(--primary)] font-medium hover:text-[var(--primary)] link-lg whitespace-nowrap" aria-label="View all posts with the VulnResearch tag">VulnResearch</a><div class="mx-1.5 text-[var(--meta-divider)] text-sm">/</div><a href="https://labs.infoguard.ch/archive/tag/RedTeaming/" class="transition text-sm text-50 dark:hover:text-[var(--primary)] font-medium hover:text-[var(--primary)] link-lg whitespace-nowrap" aria-label="View all posts with the RedTeaming tag">RedTeaming</a><div class="mx-1.5 text-[var(--meta-divider)] text-sm">/</div><a href="https://labs.infoguard.ch/archive/tag/EDR/" class="transition text-sm text-50 dark:hover:text-[var(--primary)] font-medium hover:text-[var(--primary)] link-lg whitespace-nowrap" aria-label="View all posts with the EDR tag">EDR</a><div class="mx-1.5 text-[var(--meta-divider)] text-sm">/</div><a href="https://labs.infoguard.ch/archive/tag/Fuzzing/" class="transition text-sm text-50 dark:hover:text-[var(--primary)] font-medium hover:text-[var(--primary)] link-lg whitespace-nowrap" aria-label="View all posts with the Fuzzing tag">Fuzzing</a></div></div></div></div><img alt="Attacking EDRs Part 2: Driver Analysis Results" decoding="async" height="981" loading="lazy" src="https://labs.infoguard.ch/_astro/sophos_fuzz_lighthouse.x9K0lMzq_UvYWy.webp" width="1460" class="onload-animation banner-container mb-8 rounded-xl" id="post-cover"><div class="onload-animation mb-6 !max-w-none custom-md dark:prose-invert markdown-content prose prose-base" data-pagefind-body=""><p>This blog post is part of a series analyzing attack surface for Endpoint Detection and Response (EDR) solutions. Parts 1-3 are linked, with concluding notes for that initial sub-series in Part 3.</p><ul><li><a href="https://labs.infoguard.ch/posts/edr_part1_intro_-_security_analysis_of_edr_drivers/">Part 1</a> gives an overview of the attack surface of EDR software and describes the process for analysing drivers from the perspective of a low-privileged user.</li><li><a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/">Part 2</a> (<strong>this article</strong>) describes the results of the EDR driver security analysis. A minor authentication issue in the Windows driver of the Cortex XDR agent was identified (CVE-2024-5905). Additionally a PPL-”bypass” as well as a detection bypass by early startup. Furthermore, snapshot fuzzing was applied to a Mini-Filter Communication Port of the Sophos Intercept X Windows Mini-Filter driver.</li><li><a href="https://labs.infoguard.ch/posts/edr_part3_one_bug_to_stop_them_all/">Part 3</a> describes a DoS vulnerability affecting most Windows EDR agents. This vulnerability allows a low-privileged user to crash/stop the agent permanently by exploiting an issue in how the agent handles preexisting objects in the Object Manager’s namespace. Only some vendors assigned a CVE (CVE-2023-3280, CVE-2024-5909, CVE-2024-20671).</li><li><a href="https://labs.infoguard.ch/posts/attacking_edr_part4_fuzzing_defender_scanning_and_emulation_engine">Part 4</a> describes the fuzzing process of Microsoft Defender’s scanning and emulation engine <code>mpengine.dll</code>. Multiple out-of-bounds read and null dereference bugs were identified by using Snapshot Fuzzing with WTF and kAFL/NYX. These bugs can be used to crash the main Defender process as soon as the file is scanned. None of the bugs appear to be exploitable for code execution.</li></ul><section><h1 id="1-introduction--summary">1. Introduction &amp; Summary<a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#1-introduction--summary" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h1><p>Following the process outlined in Part 1, there are two candidates with open ACLs for their driver interfaces:</p><ul><li>PaloAlto Cortex XDR</li><li>Sophos Intercept X</li></ul><p>The objective was to uncover potential privilege escalation or EDR modification vulnerabilities exploitable by low-privileged attackers. This initial approach did not reveal any serious vulnerabilities but did identify some minor issues, including an authorization bypass for specific IOCTLs in Palo Alto Cortex. To aid other researchers, the subsequent sections detail the analysis process for these drivers.</p><p>We used two different approaches to check for potential vulnerabilities:</p><ul><li>Manual analysis for logic bugs was conducted for two IOCTL-Handler in PaloAlto Cortex XDR.</li><li>Snapshot-Fuzzing was applied on the <code>MessageCallback</code> function of a <code>FilterConnectionPort</code> in Sophos Intercept X. This post gives a brief overview, but does not go into detail on how to perform and debug snapshot fuzzing. There will be a post on Snapshot Fuzzing on the InfoGuard Labs Blog in the future.</li></ul></section><section><h1 id="2-palo-alto-cortex-xdr">2. Palo Alto Cortex XDR<a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#2-palo-alto-cortex-xdr" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h1><p>There are three open interfaces with dispatch functions:</p><ul><li>tedrdrv.sys: \\.\PaloEdrControlDevice</li><li>cyvrmtgn.sys: \\.\CyvrMit</li><li>tedrpers-&lt;version&gt;.sys: \\.\PANWEdrPersistentDevice11343</li></ul><msrc><p>Cortex is the result of a merger between Cyvera and Traps. Consequently, naming conventions may begin with either “t” or with “cyvr”. Usually such a historical grown product is more likely to have logical vulnerabilities.</p></msrc><section><h2 id="21-paloedrcontroldevice">2.1 \\.\PaloEdrControlDevice<a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#21-paloedrcontroldevice" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h2><p>The dispatch function handling the Major Function code 0xe (Device IO Control) has ~20 cases (different IOCTLs). This offers a lot of functionality and consequently also attack surface.</p><p><img alt="" decoding="async" height="891" loading="lazy" src="https://labs.infoguard.ch/_astro/driver_dispatch_io_cortex_marked.ByKpWwCh_1AwBgW.webp" width="1098"></p><p class="figcaption">Device IO Control Dispatch Function in Cortex</p><p></p><p>After testing some random IOCTLs from the decompiled code using the tool IOCTLplus, we noticed that most of the IOCTLs respond with “Access Denied”.</p><p><img alt="" decoding="async" height="647" loading="lazy" src="https://labs.infoguard.ch/_astro/IOCTLplus_blocked.Bcow0seh_Z2x1kuP.webp" width="1720"></p><p class="figcaption">IOCTLplus showing Access denied</p><p></p><p>However, some IOCTLs responded differently</p><ul><li><em>0x2260D8</em> returns 3088 bytes of binary data and does not require an input. We started to search for a client which calls this IOCTL because this should help understanding the data. The source code below shows that these are just statistics which can be printed using the CyTool.</li></ul><p><img alt="" decoding="async" height="645" loading="lazy" src="https://labs.infoguard.ch/_astro/IOCTLplus_stat.DZ0UxhtX_Z2rgBJU.webp" width="1708"></p><p class="figcaption">IOCTLplus calling 0x2260D8</p><p></p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>printf_0("%s = %I64d\n", "StatTakeTime", OutBuffer);</span></span>
<span class="line"><span>printf_0("%s = %I64d\n", "TimeIncrement", v8);</span></span>
<span class="line"><span>printf_0("%s = %I64d\n", "PerformanceFrequency.QuadPart", v9);</span></span>
<span class="line"><span>printf_0("%s = %I64d\n", "Providers.File.FsStreamHandleContextCount", v10);</span></span>
<span class="line"><span>printf_0("%s = %I64d\n", "Providers.File.FsStreamContextCount", v11);</span></span>
<span class="line"><span>printf_0("%s = %I64d\n", "Providers.File.FsStreamMaxContextCount", v12);</span></span>
<span class="line"><span>printf_0("%s = %I64d\n", "Providers.File.FileTotalMessagesSent", v13);</span></span>
<span class="line"><span>printf_0("%s = %I64d\n", "Providers.File.FileTotalRemoteFiles", v14);</span></span>
<span class="line"><span>printf_0("%s = %I64d\n", "Providers.File.FileTotalLocalFiles", v15);</span></span>
<span class="line"><span>printf_0("%s = %I64d\n", "Providers.File.FileNumTimesHashedOnClose", v16);</span></span>
<span class="line"><span>printf_0("%s = %I64d\n", "Providers.File.HashStats.NumBytesPurged", v17);</span></span>
<span class="line"><span>printf_0("%s = %I64d\n", "Providers.File.HashStats.NumBytesPurgedNewFile", v18);</span></span>
<span class="line"><span>printf_0("%s = %I64d\n", "Providers.File.HashStats.TotalNumBytesHashed", v19);</span></span>
<span class="line"><span>printf_0("%s = %I64d\n", "Providers.File.HashStats.NumHashOperations", v20);</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p class="figcaption">Usage of returned data by 0x2260D8 from the decompiled code</p><ul><li><em>0x2260D0</em> gives an interesting response (see below). What can be initialized and who can do it?</li></ul><p><img alt="" decoding="async" height="650" loading="lazy" src="https://labs.infoguard.ch/_astro/ioctlplus_setpid.B2mpMsli_ZPTGMh.webp" width="1732"></p><p>To understand how this function is invoked during startup, we set a breakpoint at the loading of <code>tedrdrv.sys</code> and subsequently another breakpoint at the dispatch function’s entry point. This was done to observe which IOCTLs are called by which processes after a Windows restart:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>0: kd&gt; sxe ld tedrdrv.sys</span></span>
<span class="line"><span>0: kd&gt; g</span></span>
<span class="line"><span>nt!DebugService2+0x5:</span></span>
<span class="line"><span>fffff806`16c01015 cc              int     3</span></span>
<span class="line"><span>0: kd&gt; bp tedrdrv+7E70 "k;!irp rdx detail" </span></span>
<span class="line"><span>0: kd&gt; g</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[...]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&gt;[IRP_MJ_DEVICE_CONTROL(e), N/A(0)]</span></span>
<span class="line"><span>            1  0 ffff970f85974e00 ffff970f8c77c380 00000000-00000000    </span></span>
<span class="line"><span>             \FileSystem\tedrdrv</span></span>
<span class="line"><span>                Args: 00000114 00000000 0x2260d0 00000000</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3: kd&gt; !thread @$thread 0x1f;</span></span>
<span class="line"><span>THREAD ffff970f8afd1080  Cid 0f28.11f8  Teb: 0000009c0fa7b000 Win32Thread: ffff970f8c99d720 RUNNING on processor 3</span></span>
<span class="line"><span>IRP List:</span></span>
<span class="line"><span>    ffff970f8a672480: (0006,0118) Flags: 00060070  Mdl: 00000000</span></span>
<span class="line"><span>Not impersonating</span></span>
<span class="line"><span>DeviceMap                 ffffaa08e5036180</span></span>
<span class="line"><span>Owning Process            ffff970f8ab97080       Image:         cyserver.exe</span></span>
<span class="line"><span>Attached Process          N/A            Image:         N/A</span></span>
<span class="line"><span>Wait Start TickCount      1528           Ticks: 0</span></span>
<span class="line"><span>Context Switch Count      1700           IdealProcessor: 0             </span></span>
<span class="line"><span>UserTime                  00:00:03.250</span></span>
<span class="line"><span>KernelTime                00:00:00.265</span></span>
<span class="line"><span>Win32 Start Address cysvc!CySvcCommandLineHandler (0x00007ffb40f556c0)</span></span>
<span class="line"><span>Stack Init ffff9405d02ebc90 Current ffff9405d02eb3f0</span></span>
<span class="line"><span>Base ffff9405d02ec000 Limit ffff9405d02e6000 Call 0000000000000000</span></span>
<span class="line"><span>Priority 9 BasePriority 8 PriorityDecrement 0 IoPriority 2 PagePriority 5</span></span>
<span class="line"><span>Child-SP          RetAddr               Call Site</span></span>
<span class="line"><span>ffff9405`d02eb7f8 fffff802`6042a6b5     tedrdrv+0x7e70</span></span>
<span class="line"><span>ffff9405`d02eb800 fffff802`608164c8     nt!IofCallDriver+0x55</span></span>
<span class="line"><span>ffff9405`d02eb840 fffff802`608162c7     nt!IopSynchronousServiceTail+0x1a8</span></span>
<span class="line"><span>ffff9405`d02eb8e0 fffff802`60815646     nt!IopXxxControlFile+0xc67</span></span>
<span class="line"><span>ffff9405`d02eba20 fffff802`6060aab5     nt!NtDeviceIoControlFile+0x56</span></span>
<span class="line"><span>ffff9405`d02eba90 00007ffb`5232d1a4     nt!KiSystemServiceCopyEnd+0x25 (TrapFrame @ ffff9405`d02ebb00)</span></span>
<span class="line"><span>0000009c`105fc7f8 00007ffb`51d4572b     ntdll!NtDeviceIoControlFile+0x14</span></span>
<span class="line"><span>0000009c`105fc800 00007ffb`52005611     KERNELBASE!DeviceIoControl+0x6b</span></span>
<span class="line"><span>0000009c`105fc870 00007ffb`3fbade9d     KERNEL32!DeviceIoControlImplementation+0x81</span></span>
<span class="line"><span>0000009c`105fc8c0 00007ffb`41e34900     cysvc!CySvcCommandLineHandler+0x10fe3d</span></span>
<span class="line"><span>0000009c`105fc8c8 00000000`00000000     cysvc!CySvcCommandLineHandler+0x23968a0</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p class="figcaption">WinDBG Tracing IOCTLs in tedrdrv.sys</p><p>This revealed that <em>cyserver.exe</em> calls <code>0x2260D0</code> from <em>cysvc.dll</em>, using a buffer length of 0x114.</p><p>We debugged with WinDBG synced to IDA Pro with ret-sync to see what is happening. The IOCTL <code>0x2260D0</code> sets the ProcessID which is shown in the dispatch function above. Afterwards IOCTLs which compare this ProcessID can be called from the same process.</p><p>In the following screenshot, the red box hightlights calls made before Cyserver (the user-mode component from Cortex) was stopped and the green box shows calls afterwards. This shows that the ProcessId was successfully set to the one of IOCTLplus (see code below which checks the ProcessId for the IOCTL <code>0x2260DC</code>).</p><p><img alt="" decoding="async" height="1096" loading="lazy" src="https://labs.infoguard.ch/_astro/ioctlplus_setpid_disabled_marked.BYFBPpt-_uQspe.webp" width="1715"></p><p class="figcaption">Setting the ProcessID used in the dispatch function to the one of IOCTLplus after disabling Cyserver</p><p></p><div class="relative code-block"><pre class="astro-code github-dark" data-language="cpp" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span style="color:#f97583">case</span><span style="color:#f97583"> 0x</span><span style="color:#79b8ff">2260DC</span><span style="color:#f97583">u</span><span style="color:#e1e4e8">:</span></span>
<span class="line"><span style="color:#f97583">       if</span><span style="color:#e1e4e8"> ( (HANDLE)</span><span style="color:#b392f0">IoGetRequestorProcessId</span><span style="color:#e1e4e8">(a2) </span><span style="color:#f97583">!=</span><span style="color:#e1e4e8"> ProcessId )</span></span>
<span class="line"><span style="color:#f97583">         goto</span><span style="color:#e1e4e8"> LABEL_34;</span></span>
<span class="line"><span style="color:#f97583">       if</span><span style="color:#e1e4e8"> ( InputBufferLength </span><span style="color:#f97583">&lt;</span><span style="color:#f97583"> 0x</span><span style="color:#79b8ff">6E</span><span style="color:#e1e4e8"> )</span></span>
<span class="line"><span style="color:#f97583">         goto</span><span style="color:#e1e4e8"> LABEL_99;</span></span>
<span class="line"><span style="color:#e1e4e8">       v6 </span><span style="color:#f97583">=</span><span style="color:#b392f0"> IO_handle_2260DC_sub_122F20</span><span style="color:#e1e4e8">((__int64)IRP_SystemBuffer);</span></span>
<span class="line"><span style="color:#f97583">       goto</span><span style="color:#e1e4e8"> LABEL_171;</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p class="figcaption">tedrdrv.sys IOCTL 0x2260DC</p><p>To confirm this behavior during Windows startup, we compiled a small C++ project that opens the device and invokes this function. This program was initiated as a scheduled task.</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="cpp" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span style="color:#e1e4e8">hDevice </span><span style="color:#f97583">=</span><span style="color:#b392f0"> CreateFile</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">L"</span><span style="color:#79b8ff">\\\\</span><span style="color:#9ecbff">.</span><span style="color:#79b8ff">\\</span><span style="color:#9ecbff">PaloEdrControlDevice"</span><span style="color:#e1e4e8">,</span></span>
<span class="line"><span style="color:#e1e4e8">        GENERIC_READ </span><span style="color:#f97583">|</span><span style="color:#e1e4e8"> GENERIC_WRITE,</span></span>
<span class="line"><span style="color:#e1e4e8">        FILE_SHARE_WRITE,</span></span>
<span class="line"><span style="color:#79b8ff">        NULL</span><span style="color:#e1e4e8">,</span></span>
<span class="line"><span style="color:#e1e4e8">        OPEN_EXISTING,</span></span>
<span class="line"><span style="color:#79b8ff">        0</span><span style="color:#e1e4e8">,</span></span>
<span class="line"><span style="color:#79b8ff">        NULL</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">[...]</span></span>
<span class="line"><span style="color:#e1e4e8">bResult = DeviceIoControl(</span><span style="color:#b392f0">hDevice</span><span style="color:#e1e4e8">,</span></span>
<span class="line"><span style="color:#e1e4e8">        0</span><span style="color:#b392f0">x2260D0</span><span style="color:#e1e4e8">,</span></span>
<span class="line"><span style="color:#b392f0">        buf</span><span style="color:#e1e4e8">, 0</span><span style="color:#b392f0">x114</span><span style="color:#e1e4e8">,</span><span style="color:#6a737d">                       // no input buffer</span></span>
<span class="line"><span style="color:#b392f0">        buf2</span><span style="color:#e1e4e8">, 0</span><span style="color:#b392f0">x114</span><span style="color:#e1e4e8">,</span><span style="color:#6a737d">                      // output buffer</span></span>
<span class="line"><span style="color:#e1e4e8">        &amp;</span><span style="color:#ffab70">junk</span><span style="color:#e1e4e8">,</span><span style="color:#6a737d">                            // # bytes returned</span></span>
<span class="line"><span style="color:#e1e4e8">        (</span><span style="color:#b392f0">LPOVERLAPPED</span><span style="color:#e1e4e8">)NULL);</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p class="figcaption">Code to open the device and call an IOCTL</p><p>This test was successful and the debugger showed that Cyserver itself got Access Denied errors for some IOCTLs because the ProcessId of the program above was initialized and not the one from Cyserver.</p><p>This suggests that a form of authorization bypass was achieved, concurrently blocking some Cortex functionalities. However, the implications remained unclear, as we could not determine if any harmful actions could be executed using the accessible IOCTLs. Furthermore, only specific IOCTLs could be bypassed. Others incorporate additional security checks in a separate driver, <code>cyvrlpc.sys</code>, utilized by multiple drivers. <code>Cyvrlpc.sys</code> exports shared functionalities; for example, <code>cyvrlpc_35</code> (exported ordinal) implements supplementary security checks that cannot be circumvented using the aforementioned method.</p><p>This authorization bypass was reported to PaloAlto on September 12, 2023. A fix was published on June 12, 2024 as <a href="https://security.paloaltonetworks.com/CVE-2024-5905">CVE-2024-5905</a>.</p><p>After plenty of debugging and reverse engineering, we noticed that Cyvrlpc manages an (AVL) table with all processes. It registers the function <code>PsSetCreateProcessNotifyRoutineEx</code> and inserts each process in this table. Each entry has certain flags which indicate the permissions of the process for the drivers. All processes from Cortex itself have a certain bit set which no other process has set. This bit is checked in some cyvrlpc.sys functions. The flags are set in diferent functions and the whole process is rather complex. They are also influenced by another driver cyvrmtgn.sys which has an IOCTL for authentication purposes.</p><p><img alt="" decoding="async" height="65" loading="lazy" src="https://labs.infoguard.ch/_astro/avltable.B21ukSIo_Z13rxNs.webp" width="845"></p><p class="figcaption">The AVL Table struct from IDA</p><p></p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>0: kd&gt;  !rtlavl cyvrlpc+5ECC0</span></span>
<span class="line"><span>NodeCounter - Node             (Parent,Left,Right)</span></span>
<span class="line"><span>   00000000 - ffff970f859cc410</span></span>
<span class="line"><span>(ffff970f859cc4d0,0000000000000000,0000000000000000)</span></span>
<span class="line"><span>   00000001 - ffff970f859cc4d0</span></span>
<span class="line"><span>(ffff970f85c70d50,ffff970f859cc410,ffff970f87cc1010)</span></span>
<span class="line"><span>   00000002 - ffff970f85ae32d0</span></span>
<span class="line"><span>(ffff970f87cc1010,0000000000000000,0000000000000000)</span></span>
<span class="line"><span>   [...]</span></span>
<span class="line"><span></span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p class="figcaption">Part of the AVL Table in WinDBG</p><p>We did not exactly reverse how each flag is set for each process. However, the one bit which is set for cyserver.exe and other Cortex processes is only set if the SID of the token from the calling process is “S-1-5-18” (SYSTEM) and at the same time the file path matches to one from Cortex such as:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>\Device\HarddiskVolume4\Program Files\Palo Alto Networks\Traps\cyserver.exe</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p><img alt="" decoding="async" height="367" loading="lazy" src="https://labs.infoguard.ch/_astro/tedrdrv_sid_compare_marked.Doc9rTP7_Z1pAU6X.webp" width="1140"></p><p class="figcaption">Checking the SID from the calling process in cyvrlpc.sys</p><p></p><p><img alt="" decoding="async" height="245" loading="lazy" src="https://labs.infoguard.ch/_astro/tedrdrv_str_compare1.yD7lfmXx_1ixcLm.webp" width="1007"></p><p class="figcaption">Checking the file path of the calling process</p><p></p><p><img alt="" decoding="async" height="180" loading="lazy" src="https://labs.infoguard.ch/_astro/tedrdrv_str_compare2.geN0gE7b_2b3CgW.webp" width="1130"></p><p class="figcaption">Checking the file path of the calling process</p><p></p><p>At this point we stopped further looking into this and moved on. It would be interesting if the file path checking could be bypassed.</p></section><section><h2 id="22-panwedrpersistentdevice11343">2.2 \\.\PANWEdrPersistentDevice11343<a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#22-panwedrpersistentdevice11343" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h2><p>There is one dispatch function for all Major Function codes. This function is pretty small and does not seem to have any interesting functionality.</p></section><section><h2 id="23-cyvrmit">2.3 \\.\CyvrMit<a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#23-cyvrmit" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h2><p>The dispatch function which handles the Major Function code 0xe (Device IO Control) handles more than 35 different IOCTLs.</p><p><img alt="" decoding="async" height="803" loading="lazy" src="https://labs.infoguard.ch/_astro/cyvr_driver_1_marked.D738nU9k_1tDGYK.webp" width="881"></p><p class="figcaption">Device IO Control Dispatch Function of <code>\\.\CyvrMit</code></p><p></p><p>The green boxes refer to some kind of access control flags which are set in the <code>DISPATCH_CREATE</code> (analogue to <code>IRP_MJ_CREATE</code>) function of this interface. This function is called when a handle to this driver interface is obtained. Additionally, the flags are set by an IOCTL which is used for authentication purposes (CyAuthenticate).</p><p>There is a significant advantage in analyzing this driver interface compared to the one above. The main binary that calls this interface is <em>cyapi.dll</em>, which is used by <em>cyserver.exe</em> among others. The exported function names of cyapi.dll are not stripped and most of them directly call an IOCTL of <code>\\.\CyvrMit</code>.</p><p><img alt="" decoding="async" height="732" loading="lazy" src="https://labs.infoguard.ch/_astro/cyapi_auth.zsADx9gA_24CYQQ.webp" width="922"></p><p class="figcaption">CyAuthenticate function of cyapi.dll</p><p></p><p>This is very helpful, as IOCTLs can be mapped to meaningful names. At the same time, other important arguments such as the input/output buffers and their length can be looked up. The following table shows some mapped functions that look interesting:</p><table><thead><tr><th>IOCTL</th><th>Function Name</th></tr></thead><tbody><tr><td>0x226020</td><td>CyAuthenticate</td></tr><tr><td>0x226000</td><td>CyEnableMitigationFeature</td></tr><tr><td>0x2220E8</td><td>CyStopService</td></tr><tr><td>0x2260C4</td><td>CyQueryServerPassword</td></tr><tr><td>0x2220E4</td><td>CySetServicePpl</td></tr><tr><td>0x222100</td><td>CyCrashService</td></tr><tr><td>0x22603C</td><td>CySnapshotProcesses</td></tr></tbody></table><p>Regarding the access to those IOCTLs, it is similar compared to <code>\\.\PaloEdrControlDevice</code>. Some functions can be called from an arbitrary low privileged user process and some respond with access denied. The authorization model is similar and also relies at least for some part on cyvrlpc.sys. We did not manage to fully understand all aspects of this.</p><p>To observe the sequence of IOCTL calls, we traced all invocations by setting breakpoints at the start and end of the dispatch function. This setup allowed us to log the caller, the input/output buffer lengths, and the contents of these buffers:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>3: kd&gt; bp cyvrmtgn+5920 ".echo ##############NEW; !thread @$thread 1f; r</span></span>
<span class="line"><span>$t1=rdx; r $t1; !irp $t1 detail; .echo In-Buffer:; dps poi($t1+18); db</span></span>
<span class="line"><span>poi($t1+18);g;"</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3: kd&gt; bp cyvrmtgn+5c70 ".echo ##############END; !irp $t1 detail; .echo</span></span>
<span class="line"><span>Out-Buffer:; dps poi($t1+18); db poi($t1+18);g;"</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p class="figcaption">WinDBG command to trace IOCTLs in dispatch function</p><p>The following is an extract of the output which shows a call to 0x226020 (CyAuthenticate) with the input 0x800. Generally, the first call is always to CyAuthenticate with a different input buffer depending on the required access.</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>##############NEW</span></span>
<span class="line"><span>Args: 00000000 00000010 226020 00000000</span></span>
<span class="line"><span>--</span></span>
<span class="line"><span>In-Buffer:</span></span>
<span class="line"><span>ffffb583`d9c37e00  00 00 00 00 00 00 00 00-00 08 00 00 00 00 00 00</span></span>
<span class="line"><span></span></span>
<span class="line"><span>##############END</span></span>
<span class="line"><span>Out-Buffer:</span></span>
<span class="line"><span>ffffb583`d9c37e00  00 00 00 00 00 00 00 00-00 08 00 00 00 00 00 00</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p>The question arises: how does the driver determine which input parameters are accepted for which calling process?</p><p>We started to test this with the cytool which calls some of the IOCTLs for example when stopping the services. However, this requires a password which is set globally for the tenant to perform modifications.</p><blockquote class="admonition bdm-tip"><span class="bdm-title">TIP</span><p>Try the default password ‘Password1’ and you might be lucky</p></blockquote><p><img alt="" decoding="async" height="349" loading="lazy" src="https://labs.infoguard.ch/_astro/cytool_stop.CaHZpYcc_1o4Y23.webp" width="970"></p><p class="figcaption">CyTool</p><p></p><p>Cytool also calls <code>0x226020</code> after entering the password. Now the Input-Buffer looks different:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>Args: 00000000 00000010 0x226020 00000000</span></span>
<span class="line"><span>In-Buffer:</span></span>
<span class="line"><span>ffff970f`8ae4bec0  00000046`7df6fae0</span></span>
<span class="line"><span>ffff970f`8ae4bec8  00007ff6`0001ffff</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3: kd&gt; db 00000046`7df6fae0</span></span>
<span class="line"><span>00000046`7df6fae0  50 00 61 00 73 00 73 00-77 00 6f 00 72 00 64 00</span></span>
<span class="line"><span>P.a.s.s.w.o.r.d.</span></span>
<span class="line"><span>00000046`7df6faf0  31 00 00 00 5c 01 00 00-d8 28 b2 51 5c 01 00 00</span></span>
<span class="line"><span>1...\....(.Q\...</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p>The first 8 bytes are always 0x0 if cyserver calls 0x226020. However, if called by the cytool a pointer to the password is sent. This means that there are two different ways how the authentication is handled.</p><p><img alt="" decoding="async" height="433" loading="lazy" src="https://labs.infoguard.ch/_astro/pw_compare.DSh1O0QV_rtrnT.webp" width="1149"></p><p class="figcaption">This shows the password check inside cyvrmtng.sys</p><p></p><p>We wanted to know how the password hash is obtained against which the supervisor password is compared. Maybe it is retrieved from a place where it could be manipulated. There is also the function <code>CyQueryServerPassword</code> (0x2260C4). We ended up at some ALPC-communication over which the hash was sent. We’ve never touched ALPC before and therefore decided to have a look at it. Is it possible to spoof a communication partner to retrieve secret data or to send fake data? See <a href="https://labs.infoguard.ch/posts/edr_part3_one_bug_to_stop_them_all/">Part 3</a>.</p></section></section><section><h1 id="3-sophos-intercept-x">3. Sophos Intercept X<a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#3-sophos-intercept-x" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h1><p>The analysis described in Part 1 showed that there are multiple open interfaces:</p><ul><li>SophosED.sys<ul><li>Device Driver interfaces<ul><li>\\.\SophosEndpointDefenseScan</li><li>\\.\SophosEndpointDefensePseudoFSScan</li></ul></li><li>FilterConnectionPorts<ul><li><img alt="sophos_flt" decoding="async" height="217" loading="lazy" src="https://labs.infoguard.ch/_astro/sophos_flt.DgTbcI7l_Z1z6YAF.webp" width="590"></li></ul></li></ul></li></ul><p>The device driver interfaces only had very little attack surface which was checked manually. The vast majority of the functionality is implemented in the FilterConnectionPorts.</p><p>For example <code>\SophosEndpointDefenseSyncCommPort</code> has several different functions. However, they are not that easy to test because most of them require several input parameters which need to be filled with valid data. As time was limited we chose to perform snapshot fuzzing against this interface rather than reverse engineering the code handling the I/O. There is a large call graph from these functions which in turn could be interesting to find common memory corruption bugs.</p><p><img alt="" decoding="async" height="398" loading="lazy" src="https://labs.infoguard.ch/_astro/sophos_fuzz_target2.rsL-303A_R9juc.webp" width="2873"></p><p class="figcaption">Xrefs graph from MessageCallback function</p><p></p><p>A tip which helps during the debugging of the main driver (SophosED.sys) is to change the global logging-level with a kernel debugger. The flag can easily be identified in all the debug messages. By default it is set to “2”. If the value is changed to “1” debug messages are printed:</p><p><img alt="" decoding="async" height="215" loading="lazy" src="https://labs.infoguard.ch/_astro/sophos_debug.DpNQnHZF_Z1ocvV6.webp" width="1093"></p><p class="figcaption">Log-Level in SophosED.sys</p><p></p><p><img alt="" decoding="async" height="584" loading="lazy" src="https://labs.infoguard.ch/_astro/sophos_debug2.gcbE8Xei_Z8ncA2.webp" width="928"></p><p class="figcaption">Changing the Log-Level in SophosED.sys with WinDbg</p><p></p><p>The following screenshot shows the MessageCallback function of the FilterConnectionPort <code>SophosEndpointDefenseSyncCommPort</code>:</p><p><img alt="" decoding="async" height="731" loading="lazy" src="https://labs.infoguard.ch/_astro/sophos_fuzz_target1.B1i44XP9_Zfs1rL.webp" width="1545"></p><p class="figcaption">MessageCallback function of \SophosEndpointDefenseSyncCommPort</p><p></p><p>Each of the functions called “subfunc*” again differentiates between multiple cases what results in the Xrefs graph shown above.</p><p>We used WTF as a fuzzer because we’ve already been familiar with this and it fits perfectly to this case. It is pretty fast to set up compared to traditional harnessing or kernel fuzzing.</p><a href="https://github.com/0vercl0k/wtf" class="card-github no-styling" target="_blank" id="GC6dfh6s-card" repo="0vercl0k/wtf"><div class="gc-titlebar"><div class="gc-titlebar-left"><div class="gc-owner"><div class="gc-avatar" id="GC6dfh6s-avatar" style="background-image: url(&quot;https://avatars.githubusercontent.com/u/1476421?v=4&quot;); background-color: transparent;"></div><div class="gc-user">0vercl0k</div></div><div class="gc-divider">/</div><div class="gc-repo">wtf</div></div><div class="github-logo"></div></div><div class="gc-description" id="GC6dfh6s-description">wtf is a distributed, code-coverage guided, customizable, cross-platform snapshot-based fuzzer designed for attacking user and / or kernel-mode targets running on Microsoft Windows and Linux user-mode (experimental!).</div><div class="gc-infobar"><div class="gc-stars" id="GC6dfh6s-stars">1.7K</div><div class="gc-forks" id="GC6dfh6s-forks">146</div><div class="gc-license" id="GC6dfh6s-license">MIT</div><span class="gc-language" id="GC6dfh6s-language">C++</span></div></a><p>The high-level procedure is as following:</p><ol><li>Use a HyperV-VM connected to a WinDbg Kernel-Debugger (Other VMs have problems for this setup)</li><li>Make a breakpoint at the target function where the fuzzing should start (Entry of the function in the screenshots above)</li><li>Dump the VM state (memory &amp; registers) with <a href="https://github.com/yrp604/bdump">bdump</a></li><li>Write a fuzzing harness which replaces the input buffer (a2_InputBuffer) and length (a3_InputBufferLength) of the MessageCallback function in the harness function InsertTestcase() (<a href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_dummy.cc">template</a>). The inserted data must not be larger than the allocated memory of these buffers. Optionally, if the input has a specific format, a custom mutator could be implemented.</li><li>Record valid input buffers from the running EDR with breakpoints in the kernel debugger and save them to a file. These can be used as input corpus (seeds) to start the mutations.</li><li>Run fuzzer</li><li>Check, Debug &amp; Improve Fuzzing<ul><li>Check the coverage with IDA Lighthouse to verify if it is working as expected</li><li>Make debug prints in the fuzzing harness by hooking functions with WTF. For example print function arguments.</li><li>Use Tenet to debug certain executions (e.g. to understand a potential crash) <a href="https://github.com/0vercl0k/wtf?tab=readme-ov-file#generating-tenet-traces">WTF-Tenet</a></li><li>Virtualize function accessing hardware such as file system access</li></ul></li></ol><p>The snapshot was created with and without driver-verifier enabled. The following output shows a short run with a small input-length. In general it works and the coverage increases quite good. Also the speed for one Fuzzing-node (one Laptop-core) of almost 1000 exec/s on bochscpu is rather fast but shows that most executions are short and potentially exit early because of invalid input formats.</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>..\\..\\src\\build\\RelWithDebInfo\\wtf.exe  master --runs 10000000 --name Sophos --max_len 0x30 --target . --inputs seeds</span></span>
<span class="line"><span>Seeded with 15016965039757084568</span></span>
<span class="line"><span>Iterating through the corpus..</span></span>
<span class="line"><span>Sorting through the 8 entries..</span></span>
<span class="line"><span>Running server on tcp://localhost:31337..</span></span>
<span class="line"><span>#0 cov: 0 (+0) corp: 0 (0.0b) exec/s: -nan (1 nodes) lastcov: 3.0s crash: 0 timeout: 0 cr3: 0 uptime: 3.0s</span></span>
<span class="line"><span>Saving output in .\\outputs\\7167f2dd9d964a3529d55617a73cee2a</span></span>
<span class="line"><span>Saving output in .\\outputs\\7a0ca97cddb79ec90ece2337d24edc5d</span></span>
<span class="line"><span>Saving output in .\\outputs\\crash-a271e8d13ac935afad342fa2146ffb70</span></span>
<span class="line"><span>Saving crash in .\\crashes\\crash-0xa-0x1e8ae6ee000-0xf-0x0-0xfffff80726a26cd9-0x0</span></span>
<span class="line"><span>Saving output in .\\outputs\\f93b14ce14eafe14c69eff38e546ae33</span></span>
<span class="line"><span>Saving output in .\\outputs\\crash-c40e54e406c3f2fa11033b815ff06c79</span></span>
<span class="line"><span>Saving crash in .\\crashes\\crash-0xa-0xffffb402d54c4410-0xf-0x1-0xfffff80726624d95-0x0</span></span>
<span class="line"><span>Saving crash in .\\crashes\\crash-0xa-0xffffb402d5be7a10-0xf-0x1-0xfffff80726624d95-0x0</span></span>
<span class="line"><span>[...]</span></span>
<span class="line"><span>#9013 cov: 14138 (+14138) corp: 61 (2.8kb) exec/s: 901.3 (1 nodes) lastcov: 1.0s crash: 641 timeout: 0 cr3: 0 uptime: 13.0s</span></span>
<span class="line"><span>[...]</span></span>
<span class="line"><span>#27735 cov: 15698 (+587) corp: 88 (4.0kb) exec/s: 924.5 (1 nodes) lastcov: 0.0s crash: 1508 timeout: 0 cr3: 0 uptime: 33.0s</span></span>
<span class="line"><span>[...]</span></span>
<span class="line"><span>#80583 cov: 17368 (+109) corp: 124 (5.7kb) exec/s: 1.0k (1 nodes) lastcov: 0.0s crash: 3895 timeout: 0 cr3: 0 uptime: 1.4min</span></span>
<span class="line"><span>[...]</span></span>
<span class="line"><span>#113654 cov: 17709 (+12) corp: 132 (6.1kb) exec/s: 1.0k (1 nodes) lastcov: 7.0s crash: 5284 timeout: 0 cr3: 0 uptime: 1.9min</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p class="figcaption">WTF Master output</p><p>The coverage loaded in IDA with Lighthouse showed that at least all major functions were triggered from the fuzzer. Green means that the path was executed in the fuzzing process: <img alt="" decoding="async" height="981" loading="lazy" src="https://labs.infoguard.ch/_astro/sophos_fuzz_lighthouse.x9K0lMzq_UvYWy.webp" width="1460"></p><p class="figcaption">Fuzzing Coverage loaded in IDA Lighthouse</p><p></p><p><strong>What is going on?</strong></p><p>Crashes in seconds looks too good to be true. The fuzzer catched bugs by setting a breakpoint to <em>nt!KeBugCheckEx</em>:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="cpp" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">g_Backend-&gt;</span><span style="color:#b392f0">SetBreakpoint</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"nt!KeBugCheck2"</span><span style="color:#e1e4e8">, [](</span><span style="color:#79b8ff">Backend_t</span><span style="color:#f97583"> *</span><span style="color:#ffab70">Backend</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#f97583">      const</span><span style="color:#f97583"> uint64_t</span><span style="color:#e1e4e8"> BCode </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Backend-&gt;</span><span style="color:#b392f0">GetArg</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">      const</span><span style="color:#f97583"> uint64_t</span><span style="color:#e1e4e8"> B0 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Backend-&gt;</span><span style="color:#b392f0">GetArg</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">      const</span><span style="color:#f97583"> uint64_t</span><span style="color:#e1e4e8"> B1 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Backend-&gt;</span><span style="color:#b392f0">GetArg</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">2</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">      const</span><span style="color:#f97583"> uint64_t</span><span style="color:#e1e4e8"> B2 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Backend-&gt;</span><span style="color:#b392f0">GetArg</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">3</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">      const</span><span style="color:#f97583"> uint64_t</span><span style="color:#e1e4e8"> B3 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Backend-&gt;</span><span style="color:#b392f0">GetArg</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">4</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">      const</span><span style="color:#f97583"> uint64_t</span><span style="color:#e1e4e8"> B4 </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> Backend-&gt;</span><span style="color:#b392f0">GetArg</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">5</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#f97583">      const</span><span style="color:#b392f0"> std</span><span style="color:#e1e4e8">::string Filename </span><span style="color:#f97583">=</span></span>
<span class="line"><span style="color:#b392f0">          fmt</span><span style="color:#e1e4e8">::</span><span style="color:#b392f0">format</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"crash-{:#x}-{:#x}-{:#x}-{:#x}-{:#x}-{:#x}"</span><span style="color:#e1e4e8">, BCode, B0,</span></span>
<span class="line"><span style="color:#e1e4e8">                      B1, B2, B3, B4);</span></span>
<span class="line"><span style="color:#b392f0">      DebugPrint</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"KeBugCheck2: {}</span><span style="color:#79b8ff">\n\n</span><span style="color:#9ecbff">"</span><span style="color:#e1e4e8">, Filename);</span></span>
<span class="line"><span style="color:#e1e4e8">      Backend-&gt;</span><span style="color:#b392f0">Stop</span><span style="color:#e1e4e8">(</span><span style="color:#79b8ff">Crash_t</span><span style="color:#e1e4e8">(Filename));</span></span>
<span class="line"><span style="color:#e1e4e8">    }))</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p>Some of the bugs were:</p><ul><li>0xc4: “The DRIVER_VERIFIER_DETECTED_VIOLATION bug check has a value of 0x000000C4. This is the general bug check code for fatal errors found by Driver Verifier.”</li><li>0xa: “The IRQL_NOT_LESS_OR_EQUAL bug check has a value of 0x0000000A. This bug check indicates that Microsoft Windows or a kernel-mode driver accessed paged memory at an invalid address while at a raised interrupt request level (IRQL). The cause is typically a bad pointer or a pageability problem.”</li></ul><p>All these bugs could not be reproduced in a live system. Looking at Tenet-Traces showed that some of the crashes happened in a call to <code>ExAllocatePoolWithTag</code> which indicates a false positive and consequently a problem in the virtualized system. Debugging issues like this is an important part when using snapshot fuzzing and additionally without emulated hardware like in WTF (e.g. paged out memory). KAFL in contrast has full hardware access.</p><p>The setup that helped to understand the cause was to compare the code flow of the same input in a live system with a kernel debugger synced to IDA with a Tenet-Trace from the fuzzer.</p><p>With a Tenet-trace loaded in IDA you have similar functions compared to time-travel debugging. You can scroll through the code flow and look at register values and memory content. There are several other helpful functions which are shown on the <a href="https://github.com/gaasedelen/tenet">tenet-repo</a>.</p><p><img alt="" decoding="async" height="1257" loading="lazy" src="https://labs.infoguard.ch/_astro/tenet_sophos.ewKTBo1S_Z2iUdeI.webp" width="1743"></p><p class="figcaption">WTF Tenet-Trace loaded in IDA</p><p></p><p>Additionally, <a href="https://github.com/bootleg/ret-sync">ret-sync</a> can be used to sync WinDBG to IDA what allows to easily compare the snapshot execution to the live system.</p><p>At the end, the problem was related to the IRQL-value stored in the snapshot of bdump (step 3 in the overview):</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span>kd&gt; r cr8</span></span>
<span class="line"><span>cr8=000000000000000f</span></span>
<span class="line"><span>kd&gt; !irql</span></span>
<span class="line"><span>Debugger saved IRQL for processor 0x0 -- 0 (LOW_LEVEL)</span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p class="figcaption">WinDBG in kernel breakpoint before the snapshot was taken</p><p>The CPU register CR8 stores the current IRQL-value. However, if the system is interrupted with WinDBG kernel breakpoint, the CR8 register is changed to <code>0xf</code>. The current IRQL as shown above, however, would be <code>0x0</code>. Therefore, the snapshot stores CR8 value of the interrupted state instead of the actual IRQL-value. After fixing this value in the snapshot, the false positive crashes disappeared.</p><p>The fuzzer was running for some days but did not identify any exploitable bug. The main issue of this fuzzing setup was that some functions expected memory pointers on certain positions in the input data. We did not use any structure aware mutation and consequently most of the input could not be parsed and the function exited early. The is no uniform structure and it would have been too time consuming to reverse it for different functions. Additionally, the data where the memory-pointers point at would have to be filled with mutated data or potentially pointers again. We used breakpoints in the fuzzing harness, to get an idea of memory access:</p><div class="relative code-block"><pre class="astro-code github-dark" data-language="cpp" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-overlayscrollbars="host"><div class="os-size-observer"><div class="os-size-observer-listener"></div></div><div class="" data-overlayscrollbars-viewport="scrollbarHidden overflowXHidden overflowYHidden" tabindex="-1" style="margin-right: 0px; margin-bottom: 0px; margin-left: 0px; top: 0px; right: auto; left: 0px; width: calc(100% + 0px); padding: 0px;"><code><span class="line"><span style="color:#f97583">    if</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">!</span><span style="color:#e1e4e8">g_Backend-&gt;</span><span style="color:#b392f0">SetBreakpoint</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"nt!ProbeForRead"</span><span style="color:#e1e4e8">, [](</span><span style="color:#79b8ff">Backend_t</span><span style="color:#f97583"> *</span><span style="color:#ffab70">Backend</span><span style="color:#e1e4e8">) {              </span></span>
<span class="line"><span style="color:#b392f0">        DebugPrint</span><span style="color:#e1e4e8">(</span><span style="color:#9ecbff">"nt!ProbeForRead at {:x} with length {:x}"</span><span style="color:#e1e4e8">, g_Backend-&gt;</span><span style="color:#b392f0">Rcx</span><span style="color:#e1e4e8">(), g_Backend-&gt;</span><span style="color:#b392f0">Rdx</span><span style="color:#e1e4e8">());  </span></span></code></div><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-dark px-2 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></pre><button class="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out"><div><svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"></path></svg> <svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"></path></svg></div>
      </button></div><p class="figcaption">A breakpoint in WTF to get debug info for memory access during the fuzzing</p><p>We did not follow this further, but it could be potentially automated by catching <code>nt!ProbeForWrite</code> and <code>nt!ProbeForRead</code> in order to provide feedback to the fuzzer that these values should be valid pointers. All in all, improving the fuzzer and the harness would have been too time consuming and a code analysis is potentially more efficient.</p></section><section><h1 id="4-other-vulnerabilities">4. Other Vulnerabilities<a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#4-other-vulnerabilities" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h1><p>During the research, some other vulnerabilities have been identified. The following is a short summary of them:</p><section><h3 id="early-startup-of-malware">Early Startup of Malware<a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#early-startup-of-malware" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h3><p>Malware can be started before the user-mode component of the EDR is fully started. This was tested with Cortex and it was possible to execute Mimikatz with lsadump::sam without being blocked. This was reported in combination with the ALPC vulnerability. The vendor did not respond to this issue. Other EDRs are potentially affected, too.</p></section><section><h3 id="launching-cyserver-paloalto-cortex-without-ppl">Launching CyServer (PaloAlto Cortex) without PPL<a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#launching-cyserver-paloalto-cortex-without-ppl" class="anchor"><span class="anchor-icon" data-pagefind-ignore="true">#</span></a></h3><p>If a new (second) service which launches Cyserver is created, the original service (which has startup dependencies) does no longer start. The new service configuration is not protected by the Cortex drivers and therefore the configuration can be adjusted. If name begins with “cyserver*” it is blocked.</p><p><code>sc create "fake_cyserver" binPath="C:\Program Files\Palo Alto Networks\Traps\cyserver.exe" start=auto</code> <img alt="" decoding="async" height="743" loading="lazy" src="https://labs.infoguard.ch/_astro/vuln_cortex_ppl.D91TMzHf_xi8Xd.webp" width="920"></p><p>Cortex itself thinks that cyserver is stopped because the own service is stopped. However, the EDR still works. The cyserver.exe still has some self-protections in place but the attack surface is a larger compared to a PPL process.</p><p>This bypass was reported to PaloAlto on 12.09.2023. PaloAlto did not provide further information on this. It is unknown if a fix is implemented or planned.</p><p>This post continues with <a href="https://labs.infoguard.ch/posts/edr_part3_one_bug_to_stop_them_all/">Part 3</a> which describes the ALPC DoS vulnerability and some final notes.</p></section></section></div><div class="transition relative rounded-xl bg-[var(--license-block-bg)] license-container mb-6 onload-animation overflow-hidden px-6 py-5"><div class="transition font-bold dark:text-white/75 text-black/75">Attacking EDRs Part 2: Driver Analysis Results</div><a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/" class="text-[var(--primary)] link">https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/</a><div class="flex gap-6 mt-2"><div><div class="transition text-sm dark:text-white/30 text-black/30">Author</div><div class="transition dark:text-white/75 text-black/75 whitespace-nowrap">Manuel Feifel</div></div><div><div class="transition text-sm dark:text-white/30 text-black/30">Published at</div><div class="transition dark:text-white/75 text-black/75 whitespace-nowrap">2025-02-17</div></div><div><div class="transition text-sm dark:text-white/30 text-black/30">License</div><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="text-[var(--primary)] link whitespace-nowrap" target="_blank">CC BY-NC-SA 4.0</a></div></div><svg height="1em" width="0.97em" class="transition absolute -translate-y-1/2 dark:text-white/5 pointer-events-none right-6 text-[15rem] text-black/5 top-1/2" data-icon="fa6-brands:creative-commons"><symbol id="ai:fa6-brands:creative-commons" viewBox="0 0 496 512"><path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86m143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86M247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248m.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82" fill="currentColor"></path></symbol><use href="#ai:fa6-brands:creative-commons"></use></svg></div></div></div><div class="flex w-full flex-col gap-4 mb-4 justify-between md:flex-row overflow-hidden"><a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#" class="overflow-hidden w-full active:scale-95 font-bold pointer-events-none"></a> <a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#" class="overflow-hidden w-full active:scale-95 font-bold pointer-events-none"></a></div></div></main></div><div class="hidden lg:block back-to-top-wrapper" data-astro-cid-eymb5ayk=""><div class="transition flex items-center rounded-2xl back-to-top-btn hide overflow-hidden" id="back-to-top-btn" data-astro-cid-eymb5ayk=""><button class="btn-card h-[3.75rem] w-[3.75rem]" aria-label="Back to Top" data-astro-cid-eymb5ayk=""><svg height="1em" width="1em" class="mx-auto" data-icon="material-symbols:keyboard-arrow-up-rounded" data-astro-cid-eymb5ayk="true"><symbol id="ai:material-symbols:keyboard-arrow-up-rounded" viewBox="0 0 24 24"><path d="m12 10.8l-3.9 3.9q-.275.275-.7.275t-.7-.275t-.275-.7t.275-.7l4.6-4.6q.3-.3.7-.3t.7.3l4.6 4.6q.275.275.275.7t-.275.7t-.7.275t-.7-.275z" fill="currentColor"></path></symbol><use href="#ai:material-symbols:keyboard-arrow-up-rounded"></use></svg></button></div></div></div></div><div class="absolute hidden 2xl:block w-full z-0"><div class="mx-auto max-w-[var(--page-width)] relative"><div class="transition flex items-center -right-[var(--toc-width)] absolute hidden lg:block top-0 w-[var(--toc-width)]" id="toc-wrapper"><div class="h-[calc(100vh_-_20rem)] fixed hide-scrollbar overflow-x-hidden overflow-y-scroll top-14 w-[var(--toc-width)]" id="toc-inner-wrapper"><div class="transition-swup-fade h-full w-full" id="toc"><div class="h-8 w-full"></div><table-of-contents class="group"><a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#1-introduction--summary" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center text-[var(--btn-content)] bg-[var(--toc-badge-bg)] h-5 shrink-0 text-xs w-5">1</div><div class="transition text-sm text-50">1. Introduction &amp; Summary</div></a><a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#2-palo-alto-cortex-xdr" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center text-[var(--btn-content)] bg-[var(--toc-badge-bg)] h-5 shrink-0 text-xs w-5">2</div><div class="transition text-sm text-50">2. Palo Alto Cortex XDR</div></a><a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#21-paloedrcontroldevice" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 ml-4"><div class="transition h-2 bg-[var(--toc-badge-bg)] rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">2.1 \\.\PaloEdrControlDevice</div></a><a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#22-panwedrpersistentdevice11343" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 ml-4"><div class="transition h-2 bg-[var(--toc-badge-bg)] rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">2.2 \\.\PANWEdrPersistentDevice11343</div></a><a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#23-cyvrmit" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center h-5 shrink-0 text-xs w-5 ml-4"><div class="transition h-2 bg-[var(--toc-badge-bg)] rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">2.3 \\.\CyvrMit</div></a><a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#3-sophos-intercept-x" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center text-[var(--btn-content)] bg-[var(--toc-badge-bg)] h-5 shrink-0 text-xs w-5">3</div><div class="transition text-sm text-50">3. Sophos Intercept X</div></a><a href="https://labs.infoguard.ch/posts/edr_part2_driver_analysis_results/#4-other-vulnerabilities" class="transition flex py-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 px-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center text-[var(--btn-content)] bg-[var(--toc-badge-bg)] h-5 shrink-0 text-xs w-5">4</div><div class="transition text-sm text-50">4. Other Vulnerabilities</div></a><div class="absolute left-0 right-0 -z-10 bg-[var(--toc-btn-hover)] border-2 border-[var(--toc-btn-hover)] border-dashed group-hover:bg-transparent group-hover:border-[var(--toc-btn-active)] rounded-xl transition-all" id="active-indicator"></div></table-of-contents><div class="h-8 w-full"></div></div></div></div><!-- #toc needs to exist for Swup to work normally --></div></div><div class="hidden h-[300vh]" id="page-height-extend" style="--bannerOffset:15vh;--banner-height-home:65vh;--banner-height:35vh;--configHue:235;--page-width:75rem" data-astro-cid-sckkx6r4=""></div><!-- Cloudflare Pages Analytics --><!-- Cloudflare Pages Analytics --><div class="os-scrollbar os-scrollbar-horizontal scrollbar-base scrollbar-auto py-1 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-visible os-scrollbar-cornerless" style="--os-viewport-percent: 0.6664; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div><div class="os-scrollbar os-scrollbar-vertical scrollbar-base scrollbar-auto py-1 os-scrollbar-auto-hide os-scrollbar-auto-hide-hidden os-scrollbar-handle-interactive os-scrollbar-cornerless os-scrollbar-unusable" style="--os-viewport-percent: 1; --os-scroll-direction: 0;"><div class="os-scrollbar-track"><div class="os-scrollbar-handle"></div></div></div></body></html>