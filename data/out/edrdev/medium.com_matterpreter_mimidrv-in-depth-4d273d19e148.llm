Title:
Mimidrv In Depth: Exploring Mimikatz’s Kernel Driver

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post reverse-engineers and documents Mimidrv, the signed WDM kernel-mode driver shipped with Mimikatz that exposes ring-0 capabilities to user mode via `!`-prefixed commands.  
- It explains how Mimikatz installs/starts the driver as a kernel-driver service (requires `SeLoadDriverPrivilege`), creates a device object + symbolic link, and communicates through `DeviceIoControl`/IRP `IRP_MJ_DEVICE_CONTROL` with a set of custom IOCTLs.  
- The article breaks down key driver features: process enumeration and EPROCESS walking, toggling process protection (PP/PPL) to protect/unprotect targets like LSASS, token duplication/assignment, and enabling all token privileges by patching kernel token structures.  
- It also covers kernel telemetry-relevant enumeration of notify routines (process/thread/image/registry/object callbacks), loaded modules, filesystem filters/minifilters, and SSDT listing, plus notes on internal mechanisms (pattern scanning, undocumented structures, AuxKlib, pool allocations, MDLs).  
- Defensive guidance is included: hunting for service creation and driver-load artifacts (Event IDs 7045/4697, Sysmon 6/11), and using WDAC/Device Guard audit policies to baseline and detect anomalous driver loads.  
- Useful for red teamers and malware researchers learning kernel tradecraft and for blue teamers building detections around driver-based post-exploitation.

Technical Focus:
- WDM driver initialization (DriverEntry, device objects, symbolic links, dispatch routines)
- IOCTL design and user↔kernel communication via IRPs (`DeviceIoControl`)
- Kernel process/token internals (EPROCESS, EX_FAST_REF, TOKEN, privilege bitmasks)
- Process protection (PP/PPL) manipulation via `PS_PROTECTION`/signature levels
- Enumeration of kernel callbacks (Ps/Cm/Ob notify routines) and minifilter callbacks
- SSDT discovery/listing and kernel structure pattern scanning; MDLs and page locking

Use Cases:
- Load and operate Mimidrv for ring-0 post-exploitation actions from Mimikatz
- Remove/abuse LSASS PPL protections to enable credential access workflows
- Duplicate/assign SYSTEM tokens to target processes (e.g., for DCShadow prep)
- Enumerate EDR/AV kernel callbacks and filter/minifilter attachment points for analysis
- Build detections/hunts for malicious driver installation and suspicious kernel-driver services
- Baseline and enforce driver allowlisting using WDAC audit telemetry

Keywords:
Mimikatz, mimidrv.sys, WDM, Windows kernel driver, ring 0, SeLoadDriverPrivilege, SCM CreateService, IRP_MJ_DEVICE_CONTROL, IOCTL, DeviceIoControl, IoCreateDevice, IoCreateSymbolicLink, EPROCESS, PsActiveProcessHead, PS_PROTECTION, PPL, RunAsPPL, LSASS, token duplication, EX_FAST_REF, ZwSetInformationProcess, PsSetCreateProcessNotifyRoutine, CmRegisterCallback, ObRegisterCallbacks, minifilter, FltMgr, AuxKlibQueryModuleInformation, SSDT, KeServiceDescriptorTable, PatchGuard, WDAC, Sysmon Event ID 6, Event ID 7045, Event ID 4697