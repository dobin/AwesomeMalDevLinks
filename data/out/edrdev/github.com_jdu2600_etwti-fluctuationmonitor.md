# https://github.com/jdu2600/EtwTi-FluctuationMonitor

[Skip to content](https://github.com/jdu2600/EtwTi-FluctuationMonitor#start-of-content)

You signed in with another tab or window. [Reload](https://github.com/jdu2600/EtwTi-FluctuationMonitor) to refresh your session.You signed out in another tab or window. [Reload](https://github.com/jdu2600/EtwTi-FluctuationMonitor) to refresh your session.You switched accounts on another tab or window. [Reload](https://github.com/jdu2600/EtwTi-FluctuationMonitor) to refresh your session.Dismiss alert

{{ message }}

[jdu2600](https://github.com/jdu2600)/ **[EtwTi-FluctuationMonitor](https://github.com/jdu2600/EtwTi-FluctuationMonitor)** Public

- [Notifications](https://github.com/login?return_to=%2Fjdu2600%2FEtwTi-FluctuationMonitor) You must be signed in to change notification settings
- [Fork\\
16](https://github.com/login?return_to=%2Fjdu2600%2FEtwTi-FluctuationMonitor)
- [Star\\
168](https://github.com/login?return_to=%2Fjdu2600%2FEtwTi-FluctuationMonitor)


Uses Threat-Intelligence ETW events to identify shellcode regions being hidden by fluctuating memory protections


[168\\
stars](https://github.com/jdu2600/EtwTi-FluctuationMonitor/stargazers) [16\\
forks](https://github.com/jdu2600/EtwTi-FluctuationMonitor/forks) [Branches](https://github.com/jdu2600/EtwTi-FluctuationMonitor/branches) [Tags](https://github.com/jdu2600/EtwTi-FluctuationMonitor/tags) [Activity](https://github.com/jdu2600/EtwTi-FluctuationMonitor/activity)

[Star](https://github.com/login?return_to=%2Fjdu2600%2FEtwTi-FluctuationMonitor)

[Notifications](https://github.com/login?return_to=%2Fjdu2600%2FEtwTi-FluctuationMonitor) You must be signed in to change notification settings

# jdu2600/EtwTi-FluctuationMonitor

main

[**1** Branch](https://github.com/jdu2600/EtwTi-FluctuationMonitor/branches) [**0** Tags](https://github.com/jdu2600/EtwTi-FluctuationMonitor/tags)

[Go to Branches page](https://github.com/jdu2600/EtwTi-FluctuationMonitor/branches)[Go to Tags page](https://github.com/jdu2600/EtwTi-FluctuationMonitor/tags)

Go to file

Code

Open more actions menu

## Folders and files

| Name | Name | Last commit message | Last commit date |
| --- | --- | --- | --- |
| ## Latest commit<br>![author](https://github.githubassets.com/images/gravatars/gravatar-user-420.png?size=40)<br>John Uhlmann<br>[BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f)<br>3 years agoMay 15, 2023<br>[695a390](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f) · 3 years agoMay 15, 2023<br>## History<br>[2 Commits](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commits/main/) <br>Open commit details<br>[View commit history for this file.](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commits/main/) 2 Commits |
| [driver](https://github.com/jdu2600/EtwTi-FluctuationMonitor/tree/main/driver "driver") | [driver](https://github.com/jdu2600/EtwTi-FluctuationMonitor/tree/main/driver "driver") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| [.gitignore](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/.gitignore ".gitignore") | [.gitignore](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/.gitignore ".gitignore") | [Initial commit](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/c79693231d10dcae22159232ce38a6b261a78bb1 "Initial commit") | 3 years agoMay 14, 2023 |
| [EtwTi-FluctuationMonitor.sln](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/EtwTi-FluctuationMonitor.sln "EtwTi-FluctuationMonitor.sln") | [EtwTi-FluctuationMonitor.sln](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/EtwTi-FluctuationMonitor.sln "EtwTi-FluctuationMonitor.sln") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| [EtwTi-FluctuationMonitor.vcxproj](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/EtwTi-FluctuationMonitor.vcxproj "EtwTi-FluctuationMonitor.vcxproj") | [EtwTi-FluctuationMonitor.vcxproj](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/EtwTi-FluctuationMonitor.vcxproj "EtwTi-FluctuationMonitor.vcxproj") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| [EtwTi-FluctuationMonitor.vcxproj.filters](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/EtwTi-FluctuationMonitor.vcxproj.filters "EtwTi-FluctuationMonitor.vcxproj.filters") | [EtwTi-FluctuationMonitor.vcxproj.filters](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/EtwTi-FluctuationMonitor.vcxproj.filters "EtwTi-FluctuationMonitor.vcxproj.filters") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| [README.md](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/README.md "README.md") | [README.md](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/README.md "README.md") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| [Resource.rc](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/Resource.rc "Resource.rc") | [Resource.rc](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/Resource.rc "Resource.rc") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| [enableppl.cpp](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/enableppl.cpp "enableppl.cpp") | [enableppl.cpp](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/enableppl.cpp "enableppl.cpp") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| [flux.png](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/flux.png "flux.png") | [flux.png](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/flux.png "flux.png") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| [helpers.cpp](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/helpers.cpp "helpers.cpp") | [helpers.cpp](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/helpers.cpp "helpers.cpp") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| [loaddriver.cpp](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/loaddriver.cpp "loaddriver.cpp") | [loaddriver.cpp](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/loaddriver.cpp "loaddriver.cpp") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| [main.cpp](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/main.cpp "main.cpp") | [main.cpp](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/main.cpp "main.cpp") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| [packages.config](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/packages.config "packages.config") | [packages.config](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/packages.config "packages.config") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| [resource.h](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/resource.h "resource.h") | [resource.h](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/resource.h "resource.h") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| [stdafx.h](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/stdafx.h "stdafx.h") | [stdafx.h](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/stdafx.h "stdafx.h") | [BHASIA23](https://github.com/jdu2600/EtwTi-FluctuationMonitor/commit/695a39058ed1b3f35998400d0922920fdb16901f "BHASIA23") | 3 years agoMay 15, 2023 |
| View all files |

## Repository files navigation

[![screenshot](https://github.com/jdu2600/EtwTi-FluctuationMonitor/raw/main/flux.png)](https://github.com/jdu2600/EtwTi-FluctuationMonitor/blob/main/flux.png)

## Detection of hidden shellcode via immutable code page principle violations

[Permalink: Detection of hidden shellcode via immutable code page principle violations](https://github.com/jdu2600/EtwTi-FluctuationMonitor#detection-of-hidden-shellcode-via-immutable-code-page-principle-violations)

It is security best practice that, once a page is marked executable, it should be immutable.

That is, the the memory protection progression for code pages should only be RW to RX.

On Windows, [Kernel Patch Protection](https://en.wikipedia.org/wiki/Kernel_Patch_Protection) (aka PatchGuard) enforces this for the kernel and [Arbitrary Code Guard](https://blogs.windows.com/msedgedev/2017/02/23/mitigating-arbitrary-native-code-execution/) for user-mode images (where compatible and enabled).

There is no equivalent protection for private user-mode executbale code such as JIT.

However, JIT compilers, just like AOT compilers, only compile once.

We can monitor for violations of this principle using [Threat-Intelligence PROTECTVM\_LOCAL](https://github.com/jdu2600/Windows10EtwEvents/blob/master/manifest/Microsoft-Windows-Threat-Intelligence.tsv) ETW events.

Therefore it is interesting whenever executable memory is changed to non-executable and, to be thorough, also when executable memory changes from non-writable to writable.

We could alert immediately on this but, like always, there are some false positives that we need to deal with.
Some JIT engines re-use memory allocations and there is also legimate API hooking to account for.

The key difference between the benign and malicious behaviours is frequency.
To drastically reduces the false positive rate, we only alert if this is done _more than once_.

See [\[Black Hat Asia 2023\] You Can Run, but You Can't Hide - Finding the Footprints of Hidden Shellcode](https://www.blackhat.com/asia-23/briefings/schedule/index.html#you-can-run-but-you-cant-hide---finding-the-footprints-of-hidden-shellcode-31237) for more details.

## About

Uses Threat-Intelligence ETW events to identify shellcode regions being hidden by fluctuating memory protections


### Resources

[Readme](https://github.com/jdu2600/EtwTi-FluctuationMonitor#readme-ov-file)

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/jdu2600/EtwTi-FluctuationMonitor).

[Activity](https://github.com/jdu2600/EtwTi-FluctuationMonitor/activity)

### Stars

[**168**\\
stars](https://github.com/jdu2600/EtwTi-FluctuationMonitor/stargazers)

### Watchers

[**6**\\
watching](https://github.com/jdu2600/EtwTi-FluctuationMonitor/watchers)

### Forks

[**16**\\
forks](https://github.com/jdu2600/EtwTi-FluctuationMonitor/forks)

[Report repository](https://github.com/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fjdu2600%2FEtwTi-FluctuationMonitor&report=jdu2600+%28user%29)

## [Releases](https://github.com/jdu2600/EtwTi-FluctuationMonitor/releases)

No releases published

## [Packages\  0](https://github.com/users/jdu2600/packages?repo_name=EtwTi-FluctuationMonitor)

No packages published

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/jdu2600/EtwTi-FluctuationMonitor).

## Languages

- [C++99.9%](https://github.com/jdu2600/EtwTi-FluctuationMonitor/search?l=c%2B%2B)
- [C0.1%](https://github.com/jdu2600/EtwTi-FluctuationMonitor/search?l=c)

You can’t perform that action at this time.