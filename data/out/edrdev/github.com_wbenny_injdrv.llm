Title:
injdrv — PoC Windows kernel driver for DLL injection via APC

Type:
GitHub Tool

Short Summary (4–8 sentences max):
injdrv is a proof-of-concept Windows kernel-mode driver that injects a DLL into newly created user-mode processes using APC (Asynchronous Procedure Call) delivery during early process initialization. It targets Windows 7–10 across x86/x64/ARM32/ARM64 and includes specific handling for Wow64 processes, including injecting either same-arch DLLs or native (x64) DLLs into Wow64 on x64 systems. The repo documents multiple injection strategies: a classic “thunk” APC that calls `LdrLoadDll`, a “thunkless” technique that leverages `KiUserApcDispatcher`/calling convention quirks to call x64 `LdrLoadDll` directly (mitigating CFG issues), and a Wow64-specific `wow64log.dll` path reparse via a minifilter. It uses `PsSetCreateProcessNotifyRoutineEx` and `PsSetLoadImageNotifyRoutine` to time injection after key loader DLLs are mapped/initialized, and discusses pitfalls like deadlocks around `AddressCreationLock` and forced APC delivery. A demo DLL hooks a few `ntdll` functions (via DetoursNT) and logs events using ETW APIs available in `ntdll` to avoid `advapi32` dependencies. Useful for red teamers, malware researchers, and defenders studying kernel-assisted injection, early-bird injection timing, and Wow64/CFG edge cases.

Technical Focus:
- Kernel-to-user DLL injection via user-mode APCs (`KeInitializeApc`, `KeTestAlertThread`)
- Process/image load callbacks (`PsSetCreateProcessNotifyRoutineEx`, `PsSetLoadImageNotifyRoutine`)
- Early process initialization / loader timing (`ntdll`, Wow64 DLL load order)
- Memory mapping with sections to avoid RWX (`ZwCreateSection`, `ZwMapViewOfSection`, `ZwUnmapViewOfSection`)
- Wow64 injection mechanics (`PsWrapApcWow64Thread`, `KiUserApcDispatcher`, CFG bitmap constraints)
- Minifilter reparse-based redirection (`IRP_MJ_CREATE`, `IoReplaceFileObjectName`, `STATUS_REPARSE`)

Use Cases:
- Implementing/understanding early-bird DLL injection from kernel mode
- Researching Wow64 injection (x86 target) with native x64 payload constraints and CFG interactions
- Building PoCs for EDR telemetry evaluation around APC injection and image-load callbacks
- Studying safe memory permission transitions (section remap) and deadlock avoidance in callbacks
- Demonstrating user-mode API hooking limited to `ntdll`-only dependencies plus ETW tracing

Keywords:
Windows kernel driver, DLL injection, APC, user-mode APC, kernel-mode APC, PsSetLoadImageNotifyRoutine, PsSetCreateProcessNotifyRoutineEx, KeTestAlertThread, KeInitializeApc, LdrLoadDll, ntdll.dll, Wow64, PsWrapApcWow64Thread, KiUserApcDispatcher, Control Flow Guard, CFG bitmap, ZwCreateSection, ZwMapViewOfSection, AddressCreationLock, minifilter, IRP_MJ_CREATE, IoReplaceFileObjectName, STATUS_REPARSE, ETW, Detours, DetoursNT, protected process, PsIsProtectedProcess