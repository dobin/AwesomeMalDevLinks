Title:
Dissecting the Windows Defender Driver – WdFilter (Part 2)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post reverse-engineers key runtime monitoring logic inside Microsoft Defender’s kernel minifilter driver, WdFilter, focusing on image-load and thread-create callbacks and how they report events to MsMpEng.  
- It breaks down `PsSetCreateThreadNotifyRoutine` vs `PsSetCreateThreadNotifyRoutineEx` behavior (creator-thread context vs new-thread context) and shows how WdFilter gates notifications using per-process `ProcessCtx` flags/rules.  
- The author details how WdFilter collects metadata like thread start address (`ZwQueryInformationThread` with `ThreadQuerySetWin32StartAddress`), I/O priority (`FltRetrieveIoPriorityInfo`), and process command line (`ZwQueryInformationProcess` with `ProcessCommandLineInformation`) to detect anomalies such as PEB command-line tampering.  
- For image loads, it explains `PsSetLoadImageNotifyRoutine`, per-stream vs per-process notification rules via minifilter stream contexts, and special handling for `\Windows\System32\Wow64cpu.dll` load tracking.  
- A large portion documents the internal sync/async messaging pipelines to MsMpEng using `FltSendMessage`, including message formats, queueing, worker-thread scheduling, starvation control, and rule-reset behavior based on replies.  
- Useful for Windows kernel/EDR researchers, red teamers developing stealth techniques, and blue teamers building detections around Defender telemetry and callback semantics.

Technical Focus:
- Kernel callbacks: thread creation and image load notify routines (Ps*NotifyRoutine APIs)
- WdFilter internal state tracking (`ProcessCtx`, rules/flags, stream contexts)
- Telemetry construction: thread start address, command line retrieval, I/O priority
- Minifilter user-mode communication (`FltSendMessage`, MicrosoftMalwareProtectionPort)
- Sync vs async notification design (semaphores/events, worker thread, lookaside lists)
- Wow64cpu.dll load tracking and related process flagging

Use Cases:
- Map Defender/WdFilter telemetry sources to likely user-mode detections in MsMpEng
- Identify which behaviors trigger sync vs async notifications (thread injection vs normal thread creation, image mapping)
- Develop or validate command-line tampering detections (PEB vs kernel-retrieved command line)
- Build kernel-level detection engineering around callback context differences (creator vs created thread)
- Reproduce/monitor Defender’s internal event queueing and throttling behavior for research

Keywords:
WdFilter, Windows Defender, MsMpEng, minifilter, FltSendMessage, MicrosoftMalwareProtectionPort, PsSetCreateThreadNotifyRoutine, PsSetCreateThreadNotifyRoutineEx, PsSetLoadImageNotifyRoutine, ZwQueryInformationThread, ThreadQuerySetWin32StartAddress, ZwQueryInformationProcess, ProcessCommandLineInformation, PEB command line tampering, FltRetrieveIoPriorityInfo, IMAGE_INFO_EX, stream context, kernel callbacks, Wow64cpu.dll