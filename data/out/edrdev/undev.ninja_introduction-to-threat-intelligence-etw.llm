Title:
Introduction to Threat Intelligence ETW (Microsoft-Windows-Threat-Intelligence)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post reverse engineers Windows’ “Threat Intelligence” ETW provider used by Defender/EDR to log high-signal process injection and memory-manipulation activity from the kernel.  
- It maps where `EtwThreatIntProvRegHandle` is referenced in `ntoskrnl.exe` and identifies logging entrypoints such as `EtwTiLogReadWriteVm`, `EtwTiLogAllocExecVm`, `EtwTiLogProtectExecVm`, `EtwTiLogQueueUserApc`, and `EtwTiLogSetContextThread`.  
- The author explains how event descriptors/keywords and `EtwEventEnabled` gating determine which operations are actually emitted (notably differences between local vs remote operations and potential SKU differences like Defender ATP).  
- It demonstrates what telemetry is recorded for `NtWriteVirtualMemory` (process/thread IDs, signature/protection levels, base address, bytes copied) and notes that the written buffer contents are not captured.  
- It analyzes how execute-permission transitions (via `MiMakeProtectionMask`) influence logging for `NtAllocateVirtualMemory`/`NtProtectVirtualMemory`, and discusses implications for both detection and evasion.  
- Useful for red teamers and malware researchers building injection tradecraft, and for defenders validating what ETW TI can/can’t see and where false positives may arise (e.g., OS activity, .NET JIT RWX).

Technical Focus:
- ETW internals: providers, GUIDs, REGHANDLEs, event descriptors/keywords, `EtwProviderEnabled`/`EtwEventEnabled`
- Kernel telemetry hooks for memory operations (`MiReadVirtualMemory` → `EtwTiLogReadWriteVm`)
- Injection-related syscalls/APIs: `NtWriteVirtualMemory`, `NtAllocateVirtualMemory`, `NtProtectVirtualMemory`, APC and thread context operations
- Protection/execution detection via `MiMakeProtectionMask` (RW/RX/RWX transitions)
- Event payload structure (`EtwWrite`, `EVENT_DATA_DESCRIPTOR`) and what fields are logged
- Evasion/detection considerations (local vs remote operations, execute-bit heuristics, SKU differences)

Use Cases:
- Validate which injection primitives generate Microsoft-Windows-Threat-Intelligence ETW events
- Build detections around remote memory writes, remote alloc/protect, APC queueing, thread context changes
- Assess bypass strategies that avoid TI ETW emission (e.g., staging RW then later enabling execute)
- Compare telemetry differences between Defender vs Defender ATP/EDR subscriptions
- Triage/forensics: correlate calling/target process metadata, signature levels, and memory operation parameters

Keywords:
ETW, Microsoft-Windows-Threat-Intelligence, EtwThreatIntProviderGuid, EtwThreatIntProvRegHandle, EtwTiLogReadWriteVm, EtwTiLogAllocExecVm, EtwTiLogProtectExecVm, EtwTiLogQueueUserApc, EtwTiLogSetContextThread, EtwWrite, EVENT_DATA_DESCRIPTOR, EtwEventEnabled, MiReadVirtualMemory, MiMakeProtectionMask, NtWriteVirtualMemory, NtAllocateVirtualMemory, NtProtectVirtualMemory, process injection, process hollowing, APC injection, SetThreadContext, RWX, LSASS, Defender ATP