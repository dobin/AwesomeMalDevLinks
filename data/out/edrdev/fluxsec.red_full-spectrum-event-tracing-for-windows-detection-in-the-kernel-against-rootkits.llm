Title:
Full spectrum Event Tracing for Windows detection in the kernel against rootkits

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post analyzes real-world ETW tampering techniques used to blind EDR telemetry, then demonstrates kernel- and user-mode detections implemented in the author’s Sanctum EDR and validated against Remcos RAT and a Lazarus-inspired rootkit (Ferric Fox / FudModule-like).  
- It covers userland ETW bypass via patching `EtwEventWrite` in `ntdll.dll` and discusses why common interception points (e.g., `WriteProcessMemory`, `VirtualProtect`) can be bypassed via direct syscalls or compiler-inlined memory writes.  
- In kernel mode, it reverse engineers Windows 11 ETW internals (provider registration handles, GUID tables, `_ETW_SILODRIVERSTATE`, `_ETW_GUID_ENTRY`, `_ETW_REG_ENTRY`) and shows multiple rootkit approaches to suppress ETW without triggering PatchGuard.  
- The defensive approach is to implement “EDR-owned PatchGuard-like” integrity checks: dynamically resolving unexported kernel symbols, periodically validating critical ETW structures, and responding with telemetry and/or `KeBugCheckEx(CRITICAL_STRUCTURE_CORRUPTION)` when tampering is detected.  
- It also demonstrates blocking persistent ETW disablement via registry modifications by using a kernel registry callback (`CmRegisterCallbackEx`) to deny operations on protected ETW-related keys.  
- Useful for EDR engineers, kernel security researchers, and red teamers interested in ETW evasion and corresponding detection engineering tradeoffs (coverage vs. stability/performance).

Technical Focus:
- ETW usermode patching detection (NTDLL integrity, `EtwEventWrite`)
- Windows kernel ETW internals: provider handles, GUID hash tables, `_ETW_SILODRIVERSTATE`
- DKOM-style ETW suppression and rootkit tampering patterns
- Runtime resolution of unexported kernel symbols under KASLR
- PatchGuard gaps and “self-integrity” monitoring with `KeBugCheckEx`
- Registry-based ETW disablement prevention via `CmRegisterCallbackEx`

Use Cases:
- Build kernel-assisted detections for ETW blinding attempts (user + kernel mode)
- Adversary emulation of ETW suppression techniques (Remcos, Lazarus/FudModule patterns)
- Integrity monitoring of ETW provider registration handles / GUID enablement state
- Hardening EDR telemetry pipelines against ETW tampering and rollback (“patch-then-revert”) tactics
- Blocking ETW autologger/trace configuration tampering via registry filtering

Keywords:
ETW, ETW Threat Intelligence, EtwEventWrite, ntdll.dll, VirtualProtect, direct syscalls, Hell’s Gate, Windows 11 kernel, ntoskrnl, KASLR, PatchGuard, DKOM, rootkit, _ETW_SILODRIVERSTATE, _ETW_GUID_ENTRY, _ETW_REG_ENTRY, EtwpActiveSystemLoggers, KeBugCheckEx, CRITICAL_STRUCTURE_CORRUPTION, CmRegisterCallbackEx, registry filter, Remcos RAT, Lazarus, FudModule