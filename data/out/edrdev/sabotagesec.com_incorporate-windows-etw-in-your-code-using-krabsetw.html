# https://sabotagesec.com/incorporate-windows-etw-in-your-code-using-krabsetw/

<!DOCTYPE html><html lang="en-US">

<body class="post-template-default single single-post postid-1217 single-format-standard wp-embed-responsive">

<a class="skip-link screen-reader-text" href="https://sabotagesec.com/incorporate-windows-etw-in-your-code-using-krabsetw/#wp--skip-link--target">Skip to content</a><div class="wp-site-blocks">


<main class="wp-block-group is-layout-flow wp-block-group-is-layout-flow" id="wp--skip-link--target">
    
    <div class="wp-block-group has-global-padding is-layout-constrained wp-block-group-is-layout-constrained">
        
        <h2 class="wp-block-post-title">Incorporate Windows ETW in your code using Krabsetw</h2>
    </div>
    <div class="entry-content wp-block-post-content has-global-padding is-layout-constrained wp-block-post-content-is-layout-constrained">
<h2 class="\&quot;wp-block-heading\&quot; wp-block-heading">Introduction</h2>



<figure class="wp-block-image \&quot;wp-block-image"><img decoding="async" src="https://sabotagesec.com/wp-content/uploads//2023/03/image-14.png?w=800\%22" alt="\&quot;\&quot;"></figure>



<p class="\&quot;has-medium-font-size\&quot;">In this post we are going to discuss about how we can perform ETW tracing using krabsetw ETW library. We will not be discussing ETW basics here, for that I would recommend readers to check out following posts:</p>



<ul class="wp-block-list">
<li class="\&quot;has-medium-font-size\&quot;"><a href="https://sabotagesec.com/%22https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/etw-event-tracing-for-windows-101/%22">ETW 101</a></li>



<li class="\&quot;has-medium-font-size\&quot;"><a href="https://sabotagesec.com/%22https://nasbench.medium.com/a-primer-on-event-tracing-for-windows-etw-997725c082bf/%22">Primer on ETW</a></li>
</ul>



<h2 class="\&quot;wp-block-heading\&quot; wp-block-heading">using krabsetw library</h2>



<figure class="wp-block-image \&quot;wp-block-image"><img decoding="async" src="https://sabotagesec.com/wp-content/uploads/2023/03/image-13.png?w=250\%22" alt="\&quot;\&quot;"></figure>



<ul class="wp-block-list">
<li class="\&quot;has-medium-font-size\&quot;">Clone the krabsetw <a href="https://sabotagesec.com/%22https://github.com/microsoft/krabsetw/%22">repo </a></li>



<li class="\&quot;has-medium-font-size\&quot;">Go to krabs directory.</li>



<li class="\&quot;has-medium-font-size\&quot;">Inside krabs directory, you will see krabs.hpp and another directory \”krabs\”. Drop these two in your project directory, thats it!</li>
</ul>



<h2 class="\&quot;wp-block-heading\&quot; wp-block-heading">let the fun begins</h2>



<h2 class="\&quot;wp-block-heading\&quot; wp-block-heading"><strong>Trace types</strong></h2>



<p class="\&quot;has-medium-font-size\&quot;">The ETW has mainly two sets of APIs provided to the user for consumption, theses APIs provide kernel and user space event tracing capabilities. Using Krabsetw we can define the type of trace we want to perform on the system. First step is setting the trace type in our code.</p>


<div class="wp-block-syntaxhighlighter-code \&quot;wp-block-syntaxhighlighter-code\&quot;"><pre class="brush: plain; title: ; notranslate" title="">krabs::user_trace Utrace_object; //user space trace
krabs::kernel_trace Ktrace_object; //kernel space trace 
</pre></div>


<p class="\&quot;has-medium-font-size\&quot;">Once the type is defined, we can use the trace object to perform various activities like starting and stopping a trace session.</p>



<p class="\&quot;has-medium-font-size\&quot;">Krabs lets define named and unnamed trace sessions</p>


<div class="wp-block-syntaxhighlighter-code \&quot;wp-block-syntaxhighlighter-code\&quot;"><pre class="brush: plain; title: ; notranslate" title="">krabs::user_trace trace(L\"COOL_ETW_TRACE\"); //named trace
krabs::user_trace trace(); //unnamed trace
</pre></div>


<p class="\&quot;has-medium-font-size\&quot;">Named trace sessions help us to identify the sessions easily by using applications like logman.</p>



<h2 class="\&quot;wp-block-heading\&quot; wp-block-heading"><strong>choosing a provider</strong></h2>



<p class="\&quot;has-medium-font-size\&quot;">ETW provider provides events to an event tracing session. So beforehand we should have an idea of what we are trying to accomplish with ETW, then we can choose a specific provider the does the job for us. If you are totally new to all of this and want to explore more, use <a href="https://sabotagesec.com/%22https://github.com/zodiacon/EtwExplorer/%22">ETWExplorer </a>by Pavel Yosifovich. </p>



<p class="\&quot;has-medium-font-size\&quot;">Suppose if we are interested in monitoring network related activities on the system, we can use one ETW provider called <em>Microsoft-Windows-Kernel-Network</em> to get information on processes that make the network connection along with other useful data like communication addresses and ports etc.</p>



<p class="\&quot;has-medium-font-size\&quot;">Information about a specific ETW provider is stored in an XML file called Manifest files. Reading the manifest file will give us more information regarding the capabilities of a specific ETW provider. Below image show manifest for Microsoft-Windows-Kernel-Network provider. The information in manifest is little overwhelming at first but it is very easy to understand. Only focus on the highlighted elements in the figure.</p>



<figure class="wp-block-image \&quot;wp-block-image"><img decoding="async" src="https://sabotagesec.com/wp-content/uploads/2023/03/image-15.png?w=1013\%22" alt="\&quot;\&quot;"></figure>



<ul class="wp-block-list">
<li class="\&quot;has-medium-font-size\&quot;">GUID is an alternative identifier for a provider. We can use either guid id or name in Krabsetw library.</li>



<li class="\&quot;has-medium-font-size\&quot;">Mask values in &lt;keywords&gt; tag will help us in filtering the events, we will discuss this later in the post.</li>



<li class="\&quot;has-medium-font-size\&quot;">The &lt;event value&gt; in &lt;events&gt; is very important piece of data. We need this to trace a specific event by the provider. Lets say we are interested in monitoring processes that send data out of the system, then we need to use the KERNEL_NETWORK_TASK_TCPIPDatasent event with an event value of 10.</li>
</ul>



<p class="\&quot;has-medium-font-size\&quot;">ETW provider returns some data for each of these events, we can refer to information provided in the &lt;templates&gt; tag in the manifest as shown below.</p>



<figure class="wp-block-image \&quot;wp-block-image"><img decoding="async" src="https://sabotagesec.com/wp-content/uploads/2023/03/image-10.png?w=486\%22" alt="\&quot;\&quot;"></figure>



<p class="\&quot;has-medium-font-size\&quot;">Now we know the name and the type of the data returned by the events in an ETW provider. Lets see how we can use all the above information in Krabsetw code.</p>


<div class="wp-block-syntaxhighlighter-code \&quot;wp-block-syntaxhighlighter-code\&quot;"><pre class="brush: plain; title: ; notranslate" title="">krabs::provider&lt;&gt; network_provider(L\"Microsoft-Windows-Kernel-Network\");
//krabs::provider&lt;&gt; network_provider(krabs::guid(L\"{7dd42a49-5329-4832-8dfd-43d979153a88}\")); using GUID instead of the string
// The mask value in &lt;keywords&gt;, filter KERNEL_NETWORK_KEYWORD_IPV4
network_provider.any(0x10);
</pre></div>


<p class="\&quot;has-medium-font-size\&quot;">Now we have defined a Microsoft-Windows-Kernel-Network (7dd42a49-5329-4832-8dfd-43d979153a88) provider and set the filter to 0x10 which filters   KERNEL_NETWORK_KEYWORD_IPV4 related events. Now we are good to go ahead and work on more event filters and call back function.</p>



<h2 class="\&quot;wp-block-heading\&quot; wp-block-heading"><strong>Event filters &amp; callback</strong></h2>



<p class="\&quot;has-medium-font-size\&quot;">The callback function is what gets called when a specific even occurs in a tracing session. If we are interested in doing some monitoring activities to detect suspicious activities then that logic needs to be defined in the callback function.</p>



<p class="\&quot;has-medium-font-size\&quot;">As covered in the previous section, the &lt;templates&gt; tag in the manifest file has all the information on the data returned by a specific event. Lets say we are interested in KERNEL_NETWORK_TASK_TCPIPDatasent, following image shows the data returned by the event.</p>



<figure class="wp-block-image size-large \&quot;wp-block-image"><img decoding="async" src="https://sabotagesec.com/wp-content/uploads/2023/03/image-11.png?w=382\%22" alt="\&quot;\&quot;"></figure>



<p class="\&quot;has-medium-font-size\&quot;">We need this information to define local variable to hold the data returned by the provider in a trace session. Below code will show how to retrieve this data.</p>


<div class="wp-block-syntaxhighlighter-code \&quot;wp-block-syntaxhighlighter-code\&quot;"><pre class="brush: plain; title: ; notranslate" title="">krabs::schema schema(record, trace_context.schema_locator);
krabs::parser parser(schema);
//retrieving event specific data  
uint32_t pid = parser.parse&lt;uint32_t&gt;(L\"PID\"); 
</pre></div>


<p class="\&quot;has-medium-font-size\&quot;">Always refer to Provider manifest to get more information on data name and types associated with events traced by a specific ETW provider. Now that out of our way, lets look at the callback function.</p>


<div class="wp-block-syntaxhighlighter-code \&quot;wp-block-syntaxhighlighter-code\&quot;"><pre class="brush: plain; title: ; notranslate" title="">auto network_callback = [](const EVENT_RECORD&amp; record, const krabs::trace_context&amp; trace_context) {
        //retrieving event specific data
		krabs::schema schema(record, trace_context.schema_locator);
		krabs::parser parser(schema);
		uint32_t pid = parser.parse&lt;uint32_t&gt;(L\"PID\");
		
		std::cout &lt;&lt; \"\\nProcess ID: \" &lt;&lt; pid;
		
		
		//passing event data to an external function for further checks
		std::thread t(MonitorLogic, pid);
		t.detach();
	};
</pre></div>


<p class="\&quot;has-medium-font-size\&quot;">After collecting the data from the ETW provider, we are passing it to another function MonitorLogic.</p>



<h2 class="\&quot;wp-block-heading\&quot; wp-block-heading"><strong>Finalizing &amp; starting the trace</strong></h2>



<p class="\&quot;has-medium-font-size\&quot;">Before we start our ETW trace session we need to select the event type and do more filtering. As mentioned in the section Choosing a Provider, we need to tell the ETW provider about the events we are interested in, by using the values as highlighted in the image below.</p>



<figure class="wp-block-image \&quot;wp-block-image"><img decoding="async" src="https://sabotagesec.com/wp-content/uploads/2023/03/image-12.png?w=387\%22" alt="\&quot;\&quot;"></figure>



<p class="\&quot;has-medium-font-size\&quot;">We can make use of the event value in the Krabs via predicates as show below. We are creating an event filter object network_filter which is initialized with the event value.</p>


<div class="wp-block-syntaxhighlighter-code \&quot;wp-block-syntaxhighlighter-code\&quot;"><pre class="brush: plain; title: ; notranslate" title="">//KENREL_NETWORK_TASK_TCPIPDatasent
krabs::event_filter network_filter(krabs::predicates::id_is(10));
</pre></div>


<p class="\&quot;has-medium-font-size\&quot;">Now we can add our call back function to filter object as shown below, after integrating the call back we need to use the add_filter() of the provider class.</p>


<div class="wp-block-syntaxhighlighter-code \&quot;wp-block-syntaxhighlighter-code\&quot;"><pre class="brush: plain; title: ; notranslate" title="">network_filter.add_on_event_callback(network_callback);
//integrating the filter with the provider
network_provider.add_filter(network_filter);
</pre></div>


<p class="\&quot;has-medium-font-size\&quot;">Now we are all set to initiate the trace session.</p>


<div class="wp-block-syntaxhighlighter-code \&quot;wp-block-syntaxhighlighter-code\&quot;"><pre class="brush: plain; title: ; notranslate" title="">trace.enable(network_provider);
trace.start();
//use trace.stop() to stop the trace session
</pre></div>


<p class="\&quot;has-medium-font-size\&quot;">Full code (template)</p>


<div class="wp-block-syntaxhighlighter-code \&quot;wp-block-syntaxhighlighter-code\&quot;"><pre class="brush: plain; title: ; notranslate" title="">#ifndef UNICODE
#define UNICODE
#endif
#include&lt;windows.h&gt;
#include \"krabs.hpp\"
krabs::user_trace trace(L\"COOl_ETW_TRACE\");
void MonitorLogic(DWORD pid)
{
  //Your code logic here...
}
void ETWSession()
{
   krabs::provider&lt;&gt; network_provider(L\"Microsoft-Windows-Kernel-Network\");
//krabs::provider&lt;&gt; network_provider(krabs::guid(L\"{7dd42a49-5329-4832-8dfd-43d979153a88}\")); using GUID instead of the string
// The mask value in &lt;keywords&gt;, filter KERNEL_NETWORK_KEYWORD_IPV4
network_provider.any(0x10);
auto network_callback = [](const EVENT_RECORD&amp; record, const krabs::trace_context&amp; trace_context) {
        //retrieving event specific data
		krabs::schema schema(record, trace_context.schema_locator);
		krabs::parser parser(schema);
		uint32_t pid = parser.parse&lt;uint32_t&gt;(L\"PID\");
		
		//std::cout &lt;&lt; \"\\nProcess ID: \" &lt;&lt; pid;
		
		
		//passing event data to an external function for further checks
		std::thread t(MonitorLogic, pid);
		t.detach();
	};
//KERNEL_NETWORK_TASK_TCPIPDatasent event
krabs::event_filter network_filter(krabs::predicates::id_is(10));
//adding the callback
network_filter.add_on_event_callback(network_callback);
//integrating the filter with the provider
network_provider.add_filter(network_filter);
//starting the trace
trace.enable(network_provider);
trace.start();
//use trace.stop() to stop the trace session
}
int main(int argc, char* argv[])
{
    // Trace session needs to be in a separate thread since the tracing is blocking in nature
	std::thread t(ETWInit);
	t.join();
}
</pre></div>


<p class="\&quot;has-medium-font-size\&quot;">Whenever a process on the system sends out data over the network, ETW trace will identify it and gives us data back, in our case it is PID of the process. Later this is being passed over to user defined function MonitorLogic in a separate thread.</p>



<p class="\&quot;has-medium-font-size\&quot;">Read these for more info</p>



<p>https://github.com/microsoft/krabsetw/tree/master/krabs</p>



<p>https://github.com/microsoft/krabsetw/blob/master/docs/KrabsExample.md</p>



<p>https://github.com/microsoft/krabsetw/tree/master/examples/NativeExamples</p>
</div>
    
    <div class="wp-block-group has-global-padding is-layout-constrained wp-block-group-is-layout-constrained">
        <div class="wp-block-template-part">
<div class="wp-block-group is-layout-flow wp-block-group-is-layout-flow">
    
    <div class="wp-block-group is-layout-flex wp-block-group-is-layout-flex">
        <div style="font-size:14px" class="taxonomy-category wp-block-post-terms"><a href="https://sabotagesec.com/category/offensive-coding/" rel="tag">Offensive Coding</a></div>
    </div>
    

    
    <div class="wp-block-group is-nowrap is-layout-flex wp-container-core-group-is-layout-7 wp-block-group-is-layout-flex">
        <div style="font-size:14px;text-transform:lowercase" class="taxonomy-post_tag wp-block-post-terms"><a href="https://sabotagesec.com/tag/c-programming/" rel="tag">c programming</a><span class="wp-block-post-terms__separator">, </span><a href="https://sabotagesec.com/tag/cpp/" rel="tag">Cpp</a><span class="wp-block-post-terms__separator">, </span><a href="https://sabotagesec.com/tag/cyber-security/" rel="tag">cyber security</a><span class="wp-block-post-terms__separator">, </span><a href="https://sabotagesec.com/tag/etw/" rel="tag">ETW</a><span class="wp-block-post-terms__separator">, </span><a href="https://sabotagesec.com/tag/event-tracing-for-windows/" rel="tag">Event Tracing for Windows</a><span class="wp-block-post-terms__separator">, </span><a href="https://sabotagesec.com/tag/windows/" rel="tag">Windows</a></div>
    </div>
    
</div>

</div>
        
        <div style="height:3rem" aria-hidden="true" class="wp-block-spacer"></div>
        
        

<div class="wp-block-comments wp-block-comments-query-loop">





	<div id="respond" class="comment-respond wp-block-post-comments-form">
		<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://sabotagesec.com/incorporate-windows-etw-in-your-code-using-krabsetw/#respond" style="display:none;">Cancel reply</a></small></h3><form action="https://sabotagesec.com/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate=""><p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> <span class="required-field-message">Required fields are marked <span class="required">*</span></span></p><p class="comment-form-comment"><label for="comment">Comment <span class="required">*</span></label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" required=""></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" autocomplete="name" required=""></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" autocomplete="email" required=""></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="url" value="" size="30" maxlength="200" autocomplete="url"></p>
<p class="comment-form-cookies-consent"><input id="wp-comment-cookies-consent" name="wp-comment-cookies-consent" type="checkbox" value="yes"> <label for="wp-comment-cookies-consent">Save my name, email, and website in this browser for the next time I comment.</label></p>
<p class="form-submit wp-block-button"><input name="submit" type="submit" id="submit" class="wp-block-button__link wp-element-button" value="Post Comment"> 

</p></form>	</div><!-- #respond -->
	</div>


    </div>
    
</main>



</div>









</body></html><!-- Page cached by LiteSpeed Cache 7.6.2 on 2026-02-11 07:47:06 -->