Title:
Detecting Manual Syscalls from User Mode

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post proposes a user-mode method to detect “manual/direct syscalls” used to evade userland EDR hooks.  
- It leverages Windows’ internal Nirvana instrumentation engine via the per-process `KPROCESS.InstrumentationCallback`, set from user mode using `NtSetInformationProcess` with `PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION`.  
- The core idea is to inspect the kernel→user transition point: after a syscall, the return-to-user address (captured via `R10` / TEB instrumentation fields) should land in known legitimate callback/stub locations (e.g., `ntdll.dll` / `win32u.dll`), not arbitrary module memory.  
- A PoC instrumentation callback thunk (ASM + C/C++) captures context (`RtlCaptureContext`), avoids recursion via TEB flags, and performs basic bounds checks and optional symbol resolution (`dbghelp!SymFromAddr`) to flag suspicious returns.  
- It discusses limitations and bypasses (e.g., patching an exported `ntdll` syscall stub) and suggests hardening ideas like anti-tamper/hashing of `ntdll` stubs and reverse-disassembly to recover syscall indices.  
- Useful for blue teams/EDR engineers building user-mode telemetry, and for red teams to understand detection surfaces and potential countermeasures.

Technical Focus:
- Nirvana / Process Instrumentation Callback (`KPROCESS.InstrumentationCallback`)
- `NtSetInformationProcess` with undocumented `PROCESSINFOCLASS` (value 40)
- Kernel-to-user callbacks and return address validation (`R10`, trap frame semantics)
- TEB instrumentation fields and recursion/thread-safety handling
- Context capture/restore (`RtlCaptureContext`, `RtlRestoreContext`)
- Symbol-based validation (`dbghelp.dll`, `SymFromAddr`)

Use Cases:
- Detecting direct/manual syscalls in user mode without kernel drivers
- Building EDR/anti-cheat telemetry around syscall return-to-user integrity
- Researching bypasses of userland syscall-hook evasion techniques
- Hardening user-mode monitoring by validating syscall stub provenance

Keywords:
manual syscalls, direct syscalls, user-mode EDR, Nirvana, instrumentation callback, KPROCESS InstrumentationCallback, PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION, NtSetInformationProcess, PROCESSINFOCLASS 40, TEB InstrumentationCallbackPreviousPc, R10 register, ntdll.dll, win32u.dll, KiUserExceptionDispatcher, KiUserApcDispatcher, RtlCaptureContext, RtlRestoreContext, dbghelp SymFromAddr, syscall stub integrity