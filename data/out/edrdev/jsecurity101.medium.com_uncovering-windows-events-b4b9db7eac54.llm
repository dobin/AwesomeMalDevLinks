Title:
Uncovering Windows Events (Threat Intelligence ETW)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post walks through reverse engineering the Windows “Threat-Intelligence” (TI) manifest-based ETW provider to understand what events it emits and where they originate in the kernel.  
- It addresses the gap that many ETW providers are not fully ingested by EDR/telemetry sensors, and shows a repeatable methodology to map provider events to underlying OS mechanisms.  
- The author focuses on TI events related to process memory operations (e.g., WriteProcessMemory) by tracing kernel code paths in `ntoskrnl.exe` from `EtwRegister`/provider GUID registration to `EtwWrite` calls and `EVENT_DESCRIPTOR` IDs.  
- It highlights that consuming TI provider events requires running as a Protected Process Light (PPL), explaining why vendor agents typically run as PPL and why tools exist to access TI telemetry from non-vendor contexts.  
- The analysis ties user-mode APIs to syscalls (`NtWriteVirtualMemory`/`NtReadVirtualMemory`) and the shared kernel routine (`MiReadWriteVirtualMemory`) that triggers TI logging, including how access rights (e.g., `PROCESS_VM_READ`/`PROCESS_VM_WRITE`) select specific event descriptors.  
- Useful for detection engineers and Windows internals researchers, and also for red teamers assessing what low-level telemetry defenders may have for injection/memory-tampering behaviors.

Technical Focus:
- Event Tracing for Windows (ETW) manifest providers and kernel emission
- Threat-Intelligence ETW provider GUID, registration, and enablement checks
- `EtwRegister`, `EtwWrite`, `EtwProviderEnabled` call flow in `ntoskrnl.exe`
- `EVENT_DESCRIPTOR` parsing (EventId, Keywords) and mapping to events
- Virtual memory read/write telemetry: `NtWriteVirtualMemory`/`NtReadVirtualMemory` → `MiReadWriteVirtualMemory`
- Protected Process Light (PPL) requirements for TI provider consumption

Use Cases:
- Map TI ETW event IDs/keywords to specific kernel behaviors for detection content
- Validate whether an EDR is leveraging TI provider coverage for memory operations
- Build or tune ETW consumers to subscribe to specific TI events (by keyword/event ID)
- Research attacker tradecraft visibility for process injection and remote memory writes
- Replicate the methodology to reverse other manifest-based ETW providers

Keywords:
ETW, Threat-Intelligence provider, Microsoft-Windows-Threat-Intelligence, ntoskrnl.exe, kernel telemetry, EtwRegister, EtwWrite, EtwProviderEnabled, EVENT_DESCRIPTOR, EventId, Keyword mask, PPL, Protected Process Light, EPROCESS, IDA Pro, WinDbg, WriteProcessMemory, NtWriteVirtualMemory, NtReadVirtualMemory, MiReadWriteVirtualMemory, PROCESS_VM_WRITE, PROCESS_VM_READ, remote process memory write, telemetry mapping, detection engineering