Title:
Evading Microsoft Defender by Embedding Lua into Rust

Type:
Blog Post

Short Summary (4–8 sentences max):
- The post demonstrates an AV evasion technique where a Windows shellcode loader is written in Lua (LuaJIT) and embedded inside a Rust binary.  
- It compares Defender detection outcomes between a “pure Rust” shellcode loader and a Rust program that executes the loader logic via embedded Lua using the `mlua` crate with `vendored` + `luajit` features.  
- The Lua code uses LuaJIT FFI to call WinAPI functions (VirtualAlloc, VirtualProtect, CreateThread, WaitForSingleObject), decrypts XOR-encrypted Meterpreter shellcode, copies it into allocated memory, flips protections to executable, and runs it in a new thread.  
- The author reports the embedded-Lua variant runs on Windows 11 with Defender real-time protection enabled, while the baseline Rust loader is detected on disk; VirusTotal results show significantly fewer detections for the Lua-embedded approach.  
- Useful for red teamers and offensive tool developers exploring “uncommon language / unusual runtime” tradecraft to reduce static/heuristic detections.  
- Interesting because it highlights how shifting core malicious logic into an embedded scripting runtime (LuaJIT FFI) can materially change Defender’s detection behavior even with a common injection chain.

Technical Focus:
- Rust + embedded LuaJIT via `mlua` (vendored runtime)
- LuaJIT FFI calling Windows APIs
- Shellcode loader chain: VirtualAlloc → memcpy → VirtualProtect → CreateThread
- XOR (rotating key) shellcode encryption/decryption
- Cross-language data passing (Rust bytes → Lua globals / buffers)
- Defender/VirusTotal detection comparison methodology

Use Cases:
- Building loaders where execution logic lives in an embedded scripting runtime
- Rapidly iterating payload logic in Lua while keeping a Rust wrapper/launcher
- Testing how language/runtime choices affect Microsoft Defender static detection
- Creating PoCs for AV evasion research and detection engineering validation

Keywords:
Microsoft Defender, AV evasion, Rust, Lua, LuaJIT, mlua, FFI, WinAPI, VirtualAlloc, VirtualProtect, CreateThread, WaitForSingleObject, shellcode loader, Meterpreter, msfvenom, XOR encryption, rotating key, Windows 11, static detection, VirusTotal