# https://github.com/jdu2600/API-To-ETW

[Skip to content](https://github.com/jdu2600/API-To-ETW#start-of-content)

You signed in with another tab or window. [Reload](https://github.com/jdu2600/API-To-ETW) to refresh your session.You signed out in another tab or window. [Reload](https://github.com/jdu2600/API-To-ETW) to refresh your session.You switched accounts on another tab or window. [Reload](https://github.com/jdu2600/API-To-ETW) to refresh your session.Dismiss alert

{{ message }}

[jdu2600](https://github.com/jdu2600)/ **[API-To-ETW](https://github.com/jdu2600/API-To-ETW)** Public

- [Notifications](https://github.com/login?return_to=%2Fjdu2600%2FAPI-To-ETW) You must be signed in to change notification settings
- [Fork\\
6](https://github.com/login?return_to=%2Fjdu2600%2FAPI-To-ETW)
- [Star\\
27](https://github.com/login?return_to=%2Fjdu2600%2FAPI-To-ETW)


Uses ghidra to find all ETW write metadata for each API in a PE file


[27\\
stars](https://github.com/jdu2600/API-To-ETW/stargazers) [6\\
forks](https://github.com/jdu2600/API-To-ETW/forks) [Branches](https://github.com/jdu2600/API-To-ETW/branches) [Tags](https://github.com/jdu2600/API-To-ETW/tags) [Activity](https://github.com/jdu2600/API-To-ETW/activity)

[Star](https://github.com/login?return_to=%2Fjdu2600%2FAPI-To-ETW)

[Notifications](https://github.com/login?return_to=%2Fjdu2600%2FAPI-To-ETW) You must be signed in to change notification settings

# jdu2600/API-To-ETW

main

[**1** Branch](https://github.com/jdu2600/API-To-ETW/branches) [**0** Tags](https://github.com/jdu2600/API-To-ETW/tags)

[Go to Branches page](https://github.com/jdu2600/API-To-ETW/branches)[Go to Tags page](https://github.com/jdu2600/API-To-ETW/tags)

Go to file

Code

Open more actions menu

## Folders and files

| Name | Name | Last commit message | Last commit date |
| --- | --- | --- | --- |
| ## Latest commit<br>[![jdu2600](https://avatars.githubusercontent.com/u/53329154?v=4&size=40)](https://github.com/jdu2600)[jdu2600](https://github.com/jdu2600/API-To-ETW/commits?author=jdu2600)<br>[Update README.md](https://github.com/jdu2600/API-To-ETW/commit/cdb4d914d2a94c2fc7dae2a11aed090042c24fd6)<br>2 years agoJul 26, 2024<br>[cdb4d91](https://github.com/jdu2600/API-To-ETW/commit/cdb4d914d2a94c2fc7dae2a11aed090042c24fd6)Â Â·Â 2 years agoJul 26, 2024<br>## History<br>[14 Commits](https://github.com/jdu2600/API-To-ETW/commits/main/) <br>Open commit details<br>[View commit history for this file.](https://github.com/jdu2600/API-To-ETW/commits/main/) 14 Commits |
| [DumpEtwWrites.java](https://github.com/jdu2600/API-To-ETW/blob/main/DumpEtwWrites.java "DumpEtwWrites.java") | [DumpEtwWrites.java](https://github.com/jdu2600/API-To-ETW/blob/main/DumpEtwWrites.java "DumpEtwWrites.java") | [make search depth adaptive](https://github.com/jdu2600/API-To-ETW/commit/c93afeea7589297c360c9c2f65e1be346569e0ab "make search depth adaptive") | 2 years agoJul 26, 2024 |
| [Microsoft-Windows-Kernel-Audit-API-Calls.png](https://github.com/jdu2600/API-To-ETW/blob/main/Microsoft-Windows-Kernel-Audit-API-Calls.png "Microsoft-Windows-Kernel-Audit-API-Calls.png") | [Microsoft-Windows-Kernel-Audit-API-Calls.png](https://github.com/jdu2600/API-To-ETW/blob/main/Microsoft-Windows-Kernel-Audit-API-Calls.png "Microsoft-Windows-Kernel-Audit-API-Calls.png") | [v0.1](https://github.com/jdu2600/API-To-ETW/commit/67973bf8fa10ce153ca8c963863883a61a0311ac "v0.1") | 6 years agoJul 26, 2020 |
| [README.md](https://github.com/jdu2600/API-To-ETW/blob/main/README.md "README.md") | [README.md](https://github.com/jdu2600/API-To-ETW/blob/main/README.md "README.md") | [Update README.md](https://github.com/jdu2600/API-To-ETW/commit/cdb4d914d2a94c2fc7dae2a11aed090042c24fd6 "Update README.md") | 2 years agoJul 26, 2024 |
| [etw\_all\_register\_write.h](https://github.com/jdu2600/API-To-ETW/blob/main/etw_all_register_write.h "etw_all_register_write.h") | [etw\_all\_register\_write.h](https://github.com/jdu2600/API-To-ETW/blob/main/etw_all_register_write.h "etw_all_register_write.h") | [added a C header file with all of the ETW function signatures that ghâ€¦](https://github.com/jdu2600/API-To-ETW/commit/943db12ffcfcde269ceb6c33808b624ee6a47640 "added a C header file with all of the ETW function signatures that ghidra needs") | 6 years agoAug 18, 2020 |
| [ignore.txt](https://github.com/jdu2600/API-To-ETW/blob/main/ignore.txt "ignore.txt") | [ignore.txt](https://github.com/jdu2600/API-To-ETW/blob/main/ignore.txt "ignore.txt") | [update ntoskrnl.exe.csv](https://github.com/jdu2600/API-To-ETW/commit/f276acfcda07af4b8644133e61039721e6250386 "update ntoskrnl.exe.csv") | 2 years agoJul 26, 2024 |
| [ntoskrnl.exe.csv](https://github.com/jdu2600/API-To-ETW/blob/main/ntoskrnl.exe.csv "ntoskrnl.exe.csv") | [ntoskrnl.exe.csv](https://github.com/jdu2600/API-To-ETW/blob/main/ntoskrnl.exe.csv "ntoskrnl.exe.csv") | [update ntoskrnl.exe.csv](https://github.com/jdu2600/API-To-ETW/commit/f276acfcda07af4b8644133e61039721e6250386 "update ntoskrnl.exe.csv") | 2 years agoJul 26, 2024 |
| View all files |

## Repository files navigation

# API-To-ETW

[Permalink: API-To-ETW](https://github.com/jdu2600/API-To-ETW#api-to-etw)

[![stability-experimental](https://camo.githubusercontent.com/0daa00e91aa931aeb2d321edc5a2ce6fe8fb4037fc35c084c4a01cde1621ac98/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f73746162696c6974792d6578706572696d656e74616c2d6f72616e67652e737667)](https://github.com/mkenney/software-guides/blob/master/STABILITY-BADGES.md#experimental)

A ghidra script to find all ETW write metadata for each API in a PE file, including any associated public symbols.

See [\[BSides Brisbane\] Kernel ETW is the best ETW](https://github.com/jdu2600/conference_talks/blob/main/2024-07-bsidesbne-KernelETW.pdf) for more details.

## Why?

[Permalink: Why?](https://github.com/jdu2600/API-To-ETW#why)

Many ETW events are extremely useful for cyber security, but are not (well) documented. ðŸ˜ž

For example, the `Kernel-Audit-API-Calls` provider sounds interesting, but all of the events are called `task_nn`.

[![Microsoft-Windows-Kernel-Audit-API-Calls events](https://github.com/jdu2600/API-To-ETW/raw/main/Microsoft-Windows-Kernel-Audit-API-Calls.png)](https://github.com/jdu2600/API-To-ETW/blob/main/Microsoft-Windows-Kernel-Audit-API-Calls.png)

Previously, this was a manual reversing process. Now you can run this Ghidra script on `ntoskrnl.exe` and grep the results. ðŸ˜ƒ

| Function | EVENT\_DESCRIPTOR Symbol | Id | CallPath |
| --- | --- | --- | --- |
| PsSetLoadImageNotifyRoutine | KERNEL\_AUDIT\_API\_PSSETLOADIMAGENOTIFYROUTINE | 1 | PsSetLoadImageNotifyRoutine->PsSetLoadImageNotifyRoutineEx |
| PsSetLoadImageNotifyRoutineEx | KERNEL\_AUDIT\_API\_PSSETLOADIMAGENOTIFYROUTINE | 1 | PsSetLoadImageNotifyRoutineEx |
| NtTerminateProcess | KERNEL\_AUDIT\_API\_TERMINATEPROCESS | 2 | NtTerminateProcess->PspLogAuditTerminateRemoteProcessEvent |
| NtCreateSymbolicLinkObject | KERNEL\_AUDIT\_API\_CREATESYMBOLICLINKOBJECT | 3 | NtCreateSymbolicLinkObjec |
| IoCreateSymbolicLink | KERNEL\_AUDIT\_API\_CREATESYMBOLICLINKOBJECT | 3 | IoCreateSymbolicLink->IoCreateSymbolicLink2->ObCreateSymbolicLink |
| NtSetContextThread | KERNEL\_AUDIT\_API\_SETCONTEXTTHREAD | 4 | NtSetContextThread |
| NtOpenProcess | KERNEL\_AUDIT\_API\_OPENPROCESS | 5 | NtOpenProcess->PsOpenProcess |
| NtAlpcOpenSenderProcess | KERNEL\_AUDIT\_API\_OPENPROCESS | 5 | NtAlpcOpenSenderProcess->PsOpenProcess |
| NtOpenThread | KERNEL\_AUDIT\_API\_OPENTHREAD | 6 | NtOpenThread->PsOpenThread |
| NtAlpcOpenSenderThread | KERNEL\_AUDIT\_API\_OPENTHREAD | 6 | NtAlpcOpenSenderThread->PsOpenThread |
| IoRegisterLastChanceShutdownNotification | KERNEL\_AUDIT\_API\_IOREGISTERLASTCHANCESHUTDOWNNOTIFICATION | 7 | IoRegisterLastChanceShutdownNotification->IopLogAuditIoRegisterNotificationEvent |
| IoRegisterShutdownNotification | KERNEL\_AUDIT\_API\_IOREGISTERSHUTDOWNNOTIFICATION | 8 | IoRegisterShutdownNotification->IopLogAuditIoRegisterNotificationEvent |

There are also trace providers (TraceLogging and WPP) which are not documented by design. This level of debug tracing is intended for the developer only, but might also prove useful for security. For example, the
`Microsoft.Windows.Kernel.SysEnv` TraceLogging provider includes a `SetVariable` event which might be useful.

## Sample Output

[Permalink: Sample Output](https://github.com/jdu2600/API-To-ETW#sample-output)

[syscalls in ntoskrnl.exe](https://github.com/jdu2600/API-To-ETW/blob/main/ntoskrnl.exe.csv)

- A full dump of all kernel ETW events is much, much longer.
- By default I also only emit the shallowest events in the call graph. The deeper ones are usually error handling.

## How good is it?

[Permalink: How good is it?](https://github.com/jdu2600/API-To-ETW#how-good-is-it)

The quality of the output depends on the quality of the decompilation. With the help of public symbols, Ghidra is pretty good out of the box for Windows binaries. But if you're not getting the results you want, some manual reversing might help.

Sometimes you'll encounter a novel design pattern not supported by the script. For example, `lsasrv.dll` stores provider handles in [a generic table using Adelson-Velsky/Landis (AVL) trees](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-rtlinitializegenerictableavl). So, in order to automatically extract the provider guids, the script would need to be updated to understand the GenericTableAvl APIs.

I'm still missing support for some event write edge cases, but I've tried to flag these in the script output.

## How do I use it?

[Permalink: How do I use it?](https://github.com/jdu2600/API-To-ETW#how-do-i-use-it)

1. Import the file to analyse - such as `ntoskrnl.exe`
2. Open the Code Browser - but don't autoanalyze just yet. We want types and symbols available.
3. Add relevant type archives first. I've provided a [minimal ETW header](https://github.com/jdu2600/API-To-ETW/blob/main/etw_all_register_write), but I use [ntddk64.gdt](https://github.com/zimawhit3/Ghidra-Windows-Data-Types/blob/main/ntddk64.gdt) (or [winapi64.gdt](https://github.com/zimawhit3/Ghidra-Windows-Data-Types/blob/main/winapi32.gdt) for usermode binaries).
4. Load the PDB. This will trigger autoanalyze - so go make a â˜•...
5. Add the local path to this repo to Script Manager's dicectories and refresh the list.
6. Run `DumpEtwWrites.java`

## References

[Permalink: References](https://github.com/jdu2600/API-To-ETW#references)

- [https://www.riverloopsecurity.com/blog/2019/05/pcode/](https://www.riverloopsecurity.com/blog/2019/05/pcode/)
- [ghidra\_scripts](https://github.com/NationalSecurityAgency/ghidra/blob/master/Ghidra/Features/Decompiler/ghidra_scripts/)
- [ghidra\_docs](https://ghidra.re/ghidra_docs/api/)

## Inspiration

[Permalink: Inspiration](https://github.com/jdu2600/API-To-ETW#inspiration)

- [https://github.com/hunters-forge/API-To-Event](https://github.com/hunters-forge/API-To-Event)
- [How do I detect technique X in Windows?](https://drive.google.com/file/d/19AhMG0ZCOt0IVsPZgn4JalkdcUOGq4DK/view), DerbyCon 2019
- [https://pathtofile.run/codereview/re/python/2020/01/11/ghidra.html](https://pathtofile.run/codereview/re/python/2020/01/11/ghidra.html)
- [https://blog.tofile.dev/2020/01/11/ghidra.html](https://blog.tofile.dev/2020/01/11/ghidra.html)
- [https://blog.xpnsec.com/analysing-rpc-with-ghidra-neo4j/](https://blog.xpnsec.com/analysing-rpc-with-ghidra-neo4j/)

## Related Work

[Permalink: Related Work](https://github.com/jdu2600/API-To-ETW#related-work)

- [https://github.com/jdu2600/Windows10EtwEvents](https://github.com/jdu2600/Windows10EtwEvents)
- [https://github.com/jsecurity101/TelemetrySource](https://github.com/jsecurity101/TelemetrySource)
- [https://github.com/airbus-cert/etwbreaker](https://github.com/airbus-cert/etwbreaker) \- an IDA plugin

## About

Uses ghidra to find all ETW write metadata for each API in a PE file


### Resources

[Readme](https://github.com/jdu2600/API-To-ETW#readme-ov-file)

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/jdu2600/API-To-ETW).

[Activity](https://github.com/jdu2600/API-To-ETW/activity)

### Stars

[**27**\\
stars](https://github.com/jdu2600/API-To-ETW/stargazers)

### Watchers

[**2**\\
watching](https://github.com/jdu2600/API-To-ETW/watchers)

### Forks

[**6**\\
forks](https://github.com/jdu2600/API-To-ETW/forks)

[Report repository](https://github.com/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fjdu2600%2FAPI-To-ETW&report=jdu2600+%28user%29)

## [Releases](https://github.com/jdu2600/API-To-ETW/releases)

No releases published

## [Packages\  0](https://github.com/users/jdu2600/packages?repo_name=API-To-ETW)

No packages published

## Languages

- [Java92.1%](https://github.com/jdu2600/API-To-ETW/search?l=java)
- [C7.9%](https://github.com/jdu2600/API-To-ETW/search?l=c)

You canâ€™t perform that action at this time.