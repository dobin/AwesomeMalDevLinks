Title:
.NET Hooking – Harmonizing Managed Territory

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how to instrument and modify .NET applications at runtime using the Harmony (Harmony2) managed hooking library.  
- It focuses on in-memory method patching (no on-disk rewriting), which is valuable when analyzing fragile or heavily obfuscated .NET malware where rebuilding assemblies can break behavior.  
- The article walks through core Harmony patch types (Prefix, Postfix, Transpiler, Reverse Patch) with practical examples: modifying arguments, overriding return values, skipping originals, and rewriting IL instructions.  
- It covers bootstrapping/injection approaches (e.g., reflection-based loaders, external injectors) and shows how to unpatch or safely call original methods to avoid recursion/StackOverflow.  
- A practical case study demonstrates bypassing ConfuserEx2 anti-reflection checks by hooking `Assembly.GetCallingAssembly()` to enable dynamic string decryption, resulting in the ConfuserEx2_String_Decryptor tool.  
- It also shows a workflow trick: triggering Harmony hook install/uninstall from within dnSpyEx’s debugging context via Watch Window expression evaluation.  

Technical Focus:
- Harmony2 runtime patching of .NET methods (managed hooking)
- Patch types: Prefix, Postfix, Transpiler (IL rewriting), Reverse Patch, Finalizer
- Reflection-based loading/bootstrapping and method resolution (AccessTools)
- In-memory IL manipulation with `CodeInstruction` / `System.Reflection.Emit`
- Deobfuscation workflow against ConfuserEx2 constants/string protection
- dnSpyEx debugging + runtime hook orchestration

Use Cases:
- Runtime instrumentation/tracing of .NET malware without modifying files on disk
- Bypassing anti-analysis/anti-reflection checks in protected .NET assemblies
- Automated extraction/decryption of obfuscated strings/constants (e.g., ConfuserEx2)
- Rapid behavior modification for reverse engineering (argument/result tampering, logic changes)
- Controlled hook deployment during live debugging sessions (dnSpyEx + Harmony)

Keywords:
.NET, CLR, CIL, IL, MSIL, Harmony, Harmony2, method patching, managed hooking, Prefix patch, Postfix patch, Transpiler, Reverse Patch, Finalizer, reflection, Assembly.LoadFile, Assembly.GetCallingAssembly, Assembly.GetExecutingAssembly, AccessTools, CodeInstruction, System.Reflection.Emit, dnSpyEx, debugging, in-memory patching, ConfuserEx2, obfuscation, string decryption, AsmResolver, deobfuscation, dynamic analysis