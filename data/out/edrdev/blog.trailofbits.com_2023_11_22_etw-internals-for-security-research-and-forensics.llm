Title:
ETW internals for security research and forensics

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post is a deep dive into Event Tracing for Windows (ETW) internals and why ETW is central to modern Windows 10/11 EDR telemetry—and therefore a frequent target for tampering and bypass.  
- It explains ETW’s provider/consumer model and shows why user-mode tooling often can’t fully enumerate which processes consume specific ETW sessions.  
- The author demonstrates kernel-debugger–based enumeration using WinDbg, including scripting (WinDbg JavaScript) to locate ETW consumer handles (`EtwConsumer` → `_ETW_REALTIME_CONSUMER`) and map them back to logger sessions via `LoggerId`.  
- It then pivots to kernel structures (`_ETW_SILODRIVERSTATE`, `EtwpLoggerContext`, `_WMI_LOGGER_CONTEXT`) to enumerate logger sessions, their consumer process lists, and the provider GUIDs enabled for each session via `EtwpGuidHashTable` and `_ETW_GUID_ENTRY.EnableInfo`.  
- The result is a repeatable method to identify active ETW sessions (including security-relevant ones), which processes subscribe to them (e.g., EDR services), and which providers feed them—useful for both forensic visibility and detecting/understanding ETW manipulation.  
- It’s most useful for Windows security researchers, DFIR, and red team/malware researchers doing ETW-focused analysis or anti-detection research.

Technical Focus:
- ETW architecture: providers, consumers, sessions (loggers), GUID manifests
- Kernel ETW data structures: `_ETW_REALTIME_CONSUMER`, `_WMI_LOGGER_CONTEXT`, `_ETW_SILODRIVERSTATE`, `_ETW_GUID_ENTRY`
- WinDbg kernel debugging and JavaScript automation (`.scriptload`, `dx`)
- Handle table scanning and object type identification (`EtwConsumer`)
- Mapping `LoggerId` ↔ session names and enumerating consumer linked lists
- Provider GUID enumeration via hash buckets (`EtwpGuidHashTable`) and enable masks

Use Cases:
- Enumerate which processes (including EDR agents) consume specific ETW sessions on a host
- Map ETW session IDs to human-readable logger names and attributes for triage/forensics
- Identify which provider GUIDs are enabled for a given session and which processes register them
- Detect ETW irregularities (e.g., disabled sessions/providers) that could indicate tampering
- Support offensive recon to understand which ETW providers/sessions are likely to trigger detections

Keywords:
ETW, Event Tracing for Windows, EDR telemetry, Windows 10, Windows 11, WinDbg, WinDbg JavaScript, kernel debugging, _ETW_REALTIME_CONSUMER, EtwConsumer, handle table, LoggerId, _WMI_LOGGER_CONTEXT, _ETW_SILODRIVERSTATE, PspHostSiloGlobals, EtwpLoggerContext, EtwpGuidHashTable, _ETW_GUID_ENTRY, provider GUIDs, Threat Intelligence channel, server silos, EventLog sessions