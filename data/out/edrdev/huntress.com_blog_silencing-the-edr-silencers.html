# https://www.huntress.com/blog/silencing-the-edr-silencers

<!DOCTYPE html><html lang="en"><body class="body"><!--$--><div class=""><div><img data-image-zoomable="false" role="presentation" aria-hidden="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F6a889f843f1c43a695dc53a813b091e2" alt="" class="builder-image banner-ellipse" loading="eager" fetchpriority="high" decoding="async" crossorigin="anonymous"></div><main class="page-wrapper"><div class="builder-component builder-component-65f3299e49a461b4b9c729ba" data-name="page" data-source="Rendered by Builder.io"><div class="builder-content" builder-content-id="65f3299e49a461b4b9c729ba" builder-model="page"><div data-builder-component="page" data-builder-content-id="65f3299e49a461b4b9c729ba"><div class="builder-blocks css-h47494" builder-type="blocks"><div class="builder-block builder-ddebc027a2b547be8bb340dc4719efa5 builder-has-component css-4hp89i" builder-id="builder-ddebc027a2b547be8bb340dc4719efa5"><section class="blog-banner-section"><img src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F9f33356fc04f46a2ac4a68753ba41658" loading="eager" alt="" class="landing-banner-shape-1 blog-listing-landing-banner-shape-1"><div class="w-layout-blockcontainer container-width-1143 w-container"><div class="blog-listing-banner-wrapper"><div class="blog-listing-banner-main-breadcrumb-wrap"><div class="breadcrumb contained"><a class="persistent-link breadcrumb-link level-1" href="https://www.huntress.com/" data-discover="true">Home</a><img src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F779e332a141048329fb98c924119138a" loading="lazy" alt="" class="breadcrumb-icon"><a class="persistent-link breadcrumb-link level-2" href="https://www.huntress.com/blog" data-discover="true">Blog</a><img src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F779e332a141048329fb98c924119138a" loading="lazy" alt="" class="breadcrumb-icon"><div class="breadcrumb-text">Silencing the EDR Silencers</div></div></div><div class="blog-listing-heading-inner"><div class="landing-banner-heading blog-landing-banner-heading"><div class="breadcrumb blog-date-breadcrumb"><div class="published-text">Last Updated:</div><a class="persistent-link breadcrumb-link breadcrumb-link-back" href="https://www.huntress.com/" data-discover="true">November 18, 2024</a></div><h1 class="landing-banner-heading-h1 blog">Silencing the EDR Silencers</h1><div class="attribution-container"><div class="author-container"><div class="author-wrap-text">By: </div><div class="authors-wrapper"><div role="list" class="authors-list "><div role="listitem" class="author-item "><a class="persistent-link author-link w-inline-block" href="https://www.huntress.com/authors/jonathan-johnson" data-discover="true"><img src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Ffd9313cd495648cebe8b5840aa07d062" loading="lazy" width="40" height="40" alt="" class="author-profile" style="width:40px;height:40px"><div class="_authorName_1vybw_1">Jonathan Johnson</div></a></div></div></div></div></div></div></div><div class="blog-listing-inner-image-wrap"><img src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F948a594740d14aeebdbbad48fcac5a15" loading="lazy" alt="" class="blog-listing-banner-image"></div></div></div><div class="social-share-icon-mobile"><img src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Fe499a4a7ecac4052ab9e5c194b638f16" loading="lazy" alt="Share icon"></div></section><section class="blog-detail-content-section"><img src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Fc2118b00ed614bbf83f96f25de0beaf8" loading="eager" alt="Glitch effect" class="landing-banner-shape-8 blog-detail-landing-banner-shape-8"><img src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Fc2118b00ed614bbf83f96f25de0beaf8" loading="lazy" alt="Glitch effect" class="landing-banner-shape-8 blog-detail-landing-banner-glitch-2"><img src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F0658aac7c84b4f7e9a7c7b2a5b519b28" loading="lazy" alt="Glitch effect" class="landing-banner-shape-8 blog-right-glitch"><div class="w-layout-blockcontainer container-width-1143 w-container"><div class="blog-detail-content-wrapper"><div class="blog-main-section"><div class="post-wrapper"><div class="blog-post-summary-main"><article class="blog-post-summary first w-richtext"><p>As many security practitioners know, tampering with Endpoint Detection and Response (EDR) products is a deep desire for threat actors and red teamers alike. I spoke about this briefly at BlackHat this year in my “EDR Blinded, Now What?” Huntress booth talk.</p>
<figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:1167px" data-rt-type="image" data-rt-align="fullwidth" data-rt-max-width="1167px">
    <div><img data-image-zoomable="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Fb8fe7e11696c499bbe999f67799f3261" alt="__wf_reserved_inherit" class="builder-image" loading="lazy" fetchpriority="auto" decoding="async" crossorigin="anonymous" width="auto" height="auto" data-zoomable=""></div>
    <figcaption><em>Speaking at BlackHat. Photo cred to my twin </em><a class="persistent-link" href="https://www.huntress.com/authors/john-hammond" target="_blank" data-discover="true"><em>John Hammond</em></a><em>. </em></figcaption>
</figure>
<p>In one of the slides, I talked about how one of the most common ways to “blind” EDRs is to apply firewall rules against the desired EDR applications. This technique is unique in the way that an attacker doesn’t need to directly access an EDR’s application themselves (open a handle to the process or file). Instead, they alter the application’s ability to communicate outbound to their server, as well as alter the server’s ability to communicate inbound to the application. So, although the EDR can collect telemetry of an action, those actions aren't being sent up for detections or investigations. In this blog, I'll touch on this technique and discuss how products can protect themselves from this attack.&nbsp;</p>
<p><br></p>
<h2>Blocking Mechanisms&nbsp;</h2>
<p>While we discuss the various ways one might block application's network communications, two ways really come to mind that are the most prevalent today:&nbsp;</p>
<ol>
    <li>Creating Windows Defender Firewall with Advanced Security rules</li>
    <li>Creating Windows Filtering Platform (WFP) rules&nbsp;</li>
</ol>
<p>Now, that might sound repetitive because it slightly is. That’s because the built-in Windows Defender Firewall leverages the Windows Filtering Platform to enforce its rules. However, I call it out because, as we’ll see later, we have to adjust the solution because depending on how you interact with each feature, the settings are set in different locations.&nbsp;</p>
<p><strong><em>Note:</em></strong><em> Before we proceed, it’s important to state that we’ll only be looking at default Windows firewall capabilities, not third-party ones. This blog also only focuses on when firewall rules are set via the Windows Firewall or WFP. </em></p>
<h3>Windows FirewallI</h3>
<p>The <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows/security/operating-system-security/network-security/windows-firewall/" target="_blank">Windows Firewall</a> has the ability to create custom rules that either allow or disallow an application to speak out through the network. Both inbound and outbound. There are no restrictions on which processes are targeted by these firewall rules, so as long as an attacker has local administrator rights they can successfully add an EDR agent into the firewall rule and block network connections. Most people have probably seen the following page as it relates to the Windows Firewall:</p>
<figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:809px" data-rt-type="image" data-rt-align="fullwidth" data-rt-max-width="809px">
    <div><img data-image-zoomable="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F410c0153e006427898348809d0b070b9" alt="" class="builder-image" loading="auto" fetchpriority="auto" decoding="async" crossorigin="anonymous" width="auto" height="auto" data-zoomable=""></div>
    <figcaption><em>Figure 1: Windows Defender Firewall with Advanced Security Window</em></figcaption>
</figure>
<p>There is also an easy built-in tool to create firewall rules called <strong><span class="highlight">netsh</span></strong>:</p>
<figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:1334px" data-rt-type="image" data-rt-align="fullwidth" data-rt-max-width="1334px">
    <div><img data-image-zoomable="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Fe70c793136534ebbac7ec8eff925743e" alt="" class="builder-image" loading="auto" fetchpriority="auto" decoding="async" crossorigin="anonymous" width="auto" height="auto" data-zoomable=""></div>
    <figcaption><em>Figure 2: </em><strong><em>netsh advfirewall</em></strong><em> example</em></figcaption>
</figure>
<p>For something more custom, someone could leverage the <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows/win32/api/netfw/nn-netfw-inetfwrule" target="_blank">INetFwRule</a> and <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows/win32/api/netfw/nf-netfw-inetfwrules-add" target="_blank">INetFwRules</a> COM interfaces. Users can implement this themselves quite easily. A well-known tool that does this is <a class="persistent-link" rel="nofollow" href="https://github.com/wavestone-cdt/EDRSandblast/blob/0710fad92dbcdf373ed30c536b99012fcd46dbcc/EDRSandblast/Utils/FirewallOps.cpp#L140" target="_blank">EDRSandblast</a>, which eventually leverages the <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows/win32/api/netfw/nf-netfw-inetfwrules-add" target="_blank">Add</a> method in the <strong><span class="highlight">INetFwRules</span></strong> COM interface to create a new firewall rule against a known EDR binary.</p>
<figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:1600px" data-rt-type="image" data-rt-align="fullwidth" data-rt-max-width="1600px">
    <div><img data-image-zoomable="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F95bbe3615ff7403b909db330a3110122" alt="" class="builder-image" loading="auto" fetchpriority="auto" decoding="async" crossorigin="anonymous" width="auto" height="auto" data-zoomable=""></div>
    <figcaption><em>Figure 3: </em><strong><em>EDRSandblast </em></strong><em>firewall creation example</em></figcaption>
</figure>
<p>Now, it’s good to note that with Windows AV turned on, Defender does block firewall rules being made against <strong><span class="highlight">MsMpEng.exe</span></strong>. However, the key point is that this can be done against any EDR, and if they’re not monitoring, the network communications will be cut off. When these firewall rules are created, they’re actually stored in the registry under:</p>
<p><strong><span class="highlight">HKLM\System\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\FirewallRules\{GUID}</span> </strong></p>
<p><strong><span class="highlight">{GUID}</span> </strong>represents the firewall rule. This is stored as a <strong><span class="highlight">REG_SZ</span> </strong>value where the data holds the information about the rule:</p>
<p><strong><code>v2.32|Action=Block|Active=TRUE|Dir=In|App={application-path}|Name={firewall-rule-name}|Desc={firewall-rule-name}|</code></strong></p>
<p>Let’s touch on the most important bits of this rule:&nbsp;</p>
<ul>
    <li><strong>Action</strong> - the firewall action to take (allow or block)</li>
    <li><strong>Active</strong> - whether or not the firewall rule is currently active or not</li>
    <li><strong>Dir</strong> - direction to permit or deny communication between either In(bound) or Out(bound)</li>
    <li><strong>App</strong> - the application to block or allow</li>
    <li><strong>Name</strong> - firewall rule name</li>
    <li><strong>Desc</strong> (optional) - description of the firewall</li>
</ul>
<p>There are other optional flags that can be put into the string as well. The three biggest tags here are <strong>Action</strong>, <strong>Dir</strong>, and <strong>App</strong>.</p>
<p>So before we move forward into the WFP, let’s remember the registry key <strong><span class="highlight">HKLM\System\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\FirewallRules\{GUID}</span></strong>. This will come in handy later when we discuss solutions.</p>
<h3>Windows Filtering Platform (WFP)</h3>
<p>The Windows Firewall leverages the <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows/win32/fwp/windows-filtering-platform-start-page" target="_blank">Windows Filtering Platform</a> to enforce its rules. Here, we won’t go in-depth about the internals of the WFP simply because we believe that a lot of other great researchers have. In fact, the following are great resources:&nbsp;</p>
<ul>
    <li><a class="persistent-link" rel="nofollow" href="https://googleprojectzero.blogspot.com/2021/08/understanding-network-access-windows-app.html" target="_blank">Understanding Network Access in Windows AppContainers</a> by <a class="persistent-link" rel="nofollow" href="https://x.com/tiraniddo" target="_blank">James Forshaw</a></li>
    <li><a class="persistent-link" rel="nofollow" href="https://zeronetworks.com/blog/wtf-is-going-on-with-wfp" target="_blank">What The Filter (WTF) is Going on With Windows Filtering Platform</a> by <a class="persistent-link" rel="nofollow" href="https://x.com/SagieDulce" target="_blank">Sagie Dulce</a></li>
</ul>
<p>Interacting with the WFP is a lot easier because there are direct APIs that we can take advantage of. A list of WFP APIs can be found <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows/win32/fwp/api-sets" target="_blank">here</a>. For purposes of creating a WFP filter, the desired API is <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows/win32/api/fwpmu/nf-fwpmu-fwpmfilteradd0" target="_blank">FwpmFilterAdd0</a>. Many reading this blog have likely heard of <a class="persistent-link" rel="nofollow" href="https://github.com/netero1010/EDRSilencer" target="_blank">EDRSilencer</a>. This function is leveraged to <a class="persistent-link" rel="nofollow" href="https://github.com/netero1010/EDRSilencer/blob/57f6bb6b24f88f781eda2f3ebad8e781a8a61c0c/EDRSilencer.c#L200C26-L200C40" target="_blank">create a WFP filter</a> for both IPv4 and IPv6 addresses. When these rules are applied, there are two things that have to exist:</p>
<ul>
    <li>A provider - policy provider that is used for the management of the filter</li>
    <li>A filter (inbound and outbound) - rule that if the conditions are met, takes the actions specified&nbsp;</li>
</ul>
<p>There are four types of run-time filters that users can interact with. <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows/win32/fwp/object-management" target="_blank"><strong>Dynamic</strong></a>, <a class="persistent-link" href="https://learn.microsoft.com/en-us/windows/win32/fwp/object-management"><strong>Static</strong></a>, <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows/win32/fwp/object-management" target="_blank"><strong>Persistent</strong></a>, and <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows/win32/fwp/object-management" target="_blank"><strong>Built-in</strong></a>. The most valuable are persistent filters to an attacker, as they live until the filter is removed. When filters are set, they’re stored in the registry just like firewall rules, just in a different location:</p>
<figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:1086px" data-rt-type="image" data-rt-align="fullwidth" data-rt-max-width="1086px">
    <div><img data-image-zoomable="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Ff54db50abcc34a4898d2d7fe19bd61b7" alt="" class="builder-image" loading="auto" fetchpriority="auto" decoding="async" crossorigin="anonymous" width="auto" height="auto" data-zoomable=""></div>
    <figcaption><em>Figure 4: Procmon output of WFP filters and provider being set</em></figcaption>
</figure>
<p>Each provider and filter is stored as a {GUID}value, and the filter data is stored as a byte array (<strong><span class="highlight">REG_BINARY</span></strong>).</p>
<figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:613px" data-rt-type="image" data-rt-align="fullwidth" data-rt-max-width="613px">
    <div><img data-image-zoomable="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Fc2cc7629fb25403f984a32965ab7455a" alt="" class="builder-image" loading="auto" fetchpriority="auto" decoding="async" crossorigin="anonymous" width="auto" height="auto" data-zoomable=""></div>
    <figcaption><em>Figure 5: WFP filter byte array example</em></figcaption>
</figure>
<p>This can make parsing this data a little more difficult than the firewall rules above just because it isn’t just a simple string value. However, an easy way to interact with filters is with the <strong><span class="highlight">Get-FwFilter</span> </strong>PowerShell cmdlet. For example, you can get the information about a filter via the <strong><span class="highlight">Get-FwFilter</span></strong> cmdlet if you have the <strong><span class="highlight">FilterId</span></strong> or <strong><span class="highlight">FilterKey</span></strong>:</p>
<h5><strong>FilterID</strong></h5>

<div class="_loadingGistBlock_vtnkx_1">Loading Gist...</div><h5><strong>FilterKey</strong></h5><div class="_loadingGistBlock_vtnkx_1">Loading Gist...</div>



<p>This is a great option if you’re curious what a specific filter is doing on your machine. Now, let’s see how to stop this from happening against an EDR application!</p>
<p><br></p>
<h2>Solution&nbsp;</h2>
<p>We’ve identified that firewall rules and WFP filters are both eventually set in the registry. This is great for anyone trying to pick up on this activity because there are multiple ways to monitor the registry. We’d like to propose two avenues that a product could take if they want to stop this tampering technique in its tracks: <strong>Prevention</strong> and <strong>Immediate Removal</strong>.</p>
<h3>Prevention</h3>
<p>Products can either prevent it by leveraging a pre-callback routine for <strong><span class="highlight">RegSetValue</span> </strong>(<a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ne-wdm-_reg_notify_class" target="_blank">RegNtPreSetValueKey</a>). If a product has access to the kernel via a driver, then they could leverage <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ne-wdm-_reg_notify_class" target="_blank">RegNtPreSetValueKey</a> to receive notifications when any registry value set operation is performed in the registry. Upon doing so, they could parse out the registry path and the data being set, and if it matched, they could return <strong><span class="highlight">STATUS_ACCESS_DENIED</span></strong> to prevent that key from being set. A successful implementation would look something like the following:&nbsp;</p>
<figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:1600px" data-rt-type="image" data-rt-align="fullwidth" data-rt-max-width="1600px">
    <div><img data-image-zoomable="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Ffde8210438e4416a983870bbe5f775c9" alt="" class="builder-image" loading="auto" fetchpriority="auto" decoding="async" crossorigin="anonymous" width="auto" height="auto" data-zoomable=""></div>
    <figcaption><em>Figure 6: </em><strong><em>EDRSandblast</em></strong><em> failing to create firewall rules</em></figcaption>
</figure>
<p>You can see that the firewall rules aren't successfully created because they're blocked through the registry pre-callback <strong><span class="highlight">RegNtPreSetValueKey</span></strong> notification. This works great from a prevention standpoint, but to be honest, I don’t always think it’s a good idea to parse or process data in the kernel unless it’s really lightweight. And although this works well for the firewall rules, that data is stored as a string value, where the WFP filters are stored as a byte array. Like the firewall rules above, this shouldn’t be processed/parsed in the kernel.</p>
<h3>Immediate Removal</h3>
<p>The methodology of “immediate removal” is similar to the method above, except that you’re technically allowing the undesired action to take place before doing anything about it. This can be done by monitoring for these registry value set operations via a post-callback (<a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ne-wdm-_reg_notify_class" target="_blank">RegNtPostSetValueKey</a>). This callback is notified once the action has already taken place in the registry. Now, someone could still process/parse this data in the kernel and deal with it, but I recommend storing the post-callback data and shipping it down to a user-mode agent so that it can take care of the parsing and processing. Figure 7 shows a very high-level architecture of how this can be done. There are many ways to do this, and this isn’t the only right way, but this is just how I did it when I created the proof-of-concept within <a class="persistent-link" rel="nofollow" href="https://github.com/jsecurity101/JonMon" target="_blank">JonMon</a>.</p>
<figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:1262px" data-rt-type="image" data-rt-align="fullwidth" data-rt-max-width="1262px">
    <div><img data-image-zoomable="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Fa7a7630d666643f5bf3ef1a04fb0da4e" alt="" class="builder-image" loading="auto" fetchpriority="auto" decoding="async" crossorigin="anonymous" width="auto" height="auto" data-zoomable=""></div>
    <figcaption><em>Figure 7: Basic EDR architecture for registry post-callback</em></figcaption>
</figure>
<p>Once the data is successfully shipped down to the user-mode agent and parsed, then the agent can safely get rid of the rules. You can’t just delete the registry keys because the rules/filters aren't immediately reset. Instead, you must remove them in a way so that the filtering engine refreshes after the removal. You could delete the registry key, but then you’d have to reboot the machine. Obviously, this approach isn’t an appropriate option, as products want to do modifications during runtime. There are some effective options to achieve this, however. For firewall rules, I leveraged COM to do this:</p>
<figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:916px" data-rt-type="image" data-rt-align="fullwidth" data-rt-max-width="916px">
    <div><img data-image-zoomable="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F4016c0b306ef4ede9a77156d386cc09b" alt="" class="builder-image" loading="auto" fetchpriority="auto" decoding="async" crossorigin="anonymous" width="auto" height="auto" data-zoomable=""></div>
    <figcaption><em>Figure 8: Code example for </em><strong><em>INetFwRules::Remove</em></strong></figcaption>
</figure>
<p>I validated that the registry value held the undesired firewall policy and used the <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows/win32/api/netfw/nf-netfw-inetfwrules-remove" target="_blank">INetFwRules Remove Method</a> to remove the firewall policy. Figure 9 shows how it looks after implementation:</p>
<figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:1376px" data-rt-type="image" data-rt-align="fullwidth" data-rt-max-width="1376px">
    <div><img data-image-zoomable="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Fe4d4426d34fa4669acbb9036f2457633" alt="" class="builder-image" loading="auto" fetchpriority="auto" decoding="async" crossorigin="anonymous" width="auto" height="auto" data-zoomable=""></div>
    <figcaption><em>Figure 9: Example of malicious firewall rules being removed in real-time</em></figcaption>
</figure>
<p>You can see the rules were successfully created but immediately removed, rendering the tampering technique useless.&nbsp;</p>
<p>For the filters and providers within the WFP, I leveraged the <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows/win32/api/fwpmu/nf-fwpmu-fwpmfilterdeletebyid0" target="_blank">FwpmFilterDeleteById0 </a>function to delete the filter and the <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/windows/win32/api/fwpmu/nf-fwpmu-fwpmproviderdeletebykey0" target="_blank">FwpmProviderDeleteByKey0</a> function to delete the provider.</p>
<figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:877px" data-rt-type="image" data-rt-align="fullwidth" data-rt-max-width="877px">
    <div><img data-image-zoomable="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F0f20a60e8071478d8cf9af63cc1ae908" alt="" class="builder-image" loading="auto" fetchpriority="auto" decoding="async" crossorigin="anonymous" width="auto" height="auto" data-zoomable=""></div>
    <figcaption><em>Figure 10: Code example of removing malicious WFP filters and providers</em></figcaption>
</figure>
<p>After this is implemented, we can see the filters and providers that are created, with EDRSilencer successfully deleted:</p>
<figure class="w-richtext-figure-type-image w-richtext-align-fullwidth" style="max-width:1221px" data-rt-type="image" data-rt-align="fullwidth" data-rt-max-width="1221px">
    <div><img data-image-zoomable="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F79913ee9d78146d0830a7a4abd7fccf5" alt="" class="builder-image" loading="auto" fetchpriority="auto" decoding="async" crossorigin="anonymous" width="auto" height="auto" data-zoomable=""></div>
    <figcaption><em>Figure 11: Example of malicious WFP filters being removed in real-time</em></figcaption>
</figure>
<p>While this method might not be "preventing" the rules from being written, it's just as effective. The product doesn’t need to parse and process this data in the kernel, and the removal is almost immediate. Lastly, you don’t have to use the registry callbacks, as the WFP has the <a class="persistent-link" rel="nofollow" href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-5447" target="_blank">5447</a> security event that states when a new rule is created. Someone could monitor for that and perform the same actions as above to remove that rule.</p>
<p><br></p>
<h2>Conclusion</h2>
<p>Tampering with EDRs is a very hot topic, and I see many people talking about leveraging firewall policies and WFP filters to blind EDRs. It’s clear this is very effective. It’s also unique, as the attacker doesn’t have to interface with the EDR’s processes directly. I’ve yet to see anyone go in-depth on how to stop or mitigate this tamper technique, so I wanted to provide some potential solutions. I hope this helps you understand this tampering technique better and how to mitigate it.</p>
<p><br></p>
<p>Want to dive into even more attacker techniques? <a class="persistent-link" href="https://www.huntress.com/tradecraft-tuesday" target="_blank" data-discover="true"><strong>Join us at Tradecraft Tuesday! </strong>No products, no pitches—just tradecraft.</a></p></article></div></div></div></div></div></section></div><div class="builder-block builder-2b27cff7899944738e3b3d18be93d1f3 builder-has-component css-4hp89i" builder-id="builder-2b27cff7899944738e3b3d18be93d1f3"><section class="related-resources-section blog-related-resources-section"><img src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F97d1ebf9f67945c9af2c6341e585bc21" loading="lazy" alt="Glitch effect" class="related-glitch-top-right"><div class="w-layout-blockcontainer container-1304 w-container"><div class="related-resources-div-block"><h2 class="heading-7">You Might Also Like</h2><p class="paragraph-9"></p></div></div><div class="w-layout-blockcontainer container-1304 w-container"><div><div style="grid-area:span 1 / span 1 / span 1 / span 1"><div role="list" class="related-resources-block-box "><div role="listitem" class="flex-column "><a class="persistent-link br10 blog-listing-box w-inline-block" href="https://www.huntress.com/blog/looking-at-qilin-ransomware-attack" data-discover="true"><div class="related-resources-thumbnail-wrapper"><img loading="lazy" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F642541cb00fe4e90a07832fed51581a9" alt="" class="related-resources-box-image pos-absolute"></div><div class="related-resources-div-wrap related-resources-block-mini height-100"><h4 class="heading-8 blog-heading">Looking Through a Pinhole at a Qilin Ransomware Attack</h4><div class="mt-auto"><button class="_navigationLink_1eyvn_54 _large_1eyvn_119 _pseudo_1eyvn_22" type="button" tabindex="-1" aria-hidden="true"><span class="_linkText_1eyvn_164">Learn More</span><img data-image-zoomable="false" role="presentation" aria-hidden="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F779e332a141048329fb98c924119138a" alt="right arrow" class="builder-image _iconArrowRight_1eyvn_85" loading="lazy" fetchpriority="auto" decoding="async" crossorigin="anonymous"></button></div></div></a></div><div role="listitem" class="flex-column "><a class="persistent-link br10 blog-listing-box w-inline-block" href="https://www.huntress.com/blog/nezha-china-nexus-threat-actor-tool" data-discover="true"><div class="related-resources-thumbnail-wrapper"><img loading="lazy" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F23d4b0b97a6c44119d5cf9c5ff789138" alt="" class="related-resources-box-image pos-absolute"></div><div class="related-resources-div-wrap related-resources-block-mini height-100"><h4 class="heading-8 blog-heading">The Crown Prince, Nezha: A New Tool Favored by China-Nexus Threat Actors</h4><div class="mt-auto"><button class="_navigationLink_1eyvn_54 _large_1eyvn_119 _pseudo_1eyvn_22" type="button" tabindex="-1" aria-hidden="true"><span class="_linkText_1eyvn_164">Learn More</span><img data-image-zoomable="false" role="presentation" aria-hidden="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F779e332a141048329fb98c924119138a" alt="right arrow" class="builder-image _iconArrowRight_1eyvn_85" loading="lazy" fetchpriority="auto" decoding="async" crossorigin="anonymous"></button></div></div></a></div><div role="listitem" class="flex-column "><a class="persistent-link br10 blog-listing-box w-inline-block" href="https://www.huntress.com/blog/gootloader-threat-detection-woff2-obfuscation" data-discover="true"><div class="related-resources-thumbnail-wrapper"><img loading="lazy" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Fc5ca2c6f28994ad1877490baf68255c5" alt="" class="related-resources-box-image pos-absolute"></div><div class="related-resources-div-wrap related-resources-block-mini height-100"><h4 class="heading-8 blog-heading">Gootloader Returns: What Goodies Did They Bring?</h4><div class="mt-auto"><button class="_navigationLink_1eyvn_54 _large_1eyvn_119 _pseudo_1eyvn_22" type="button" tabindex="-1" aria-hidden="true"><span class="_linkText_1eyvn_164">Learn More</span><img data-image-zoomable="false" role="presentation" aria-hidden="true" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F779e332a141048329fb98c924119138a" alt="right arrow" class="builder-image _iconArrowRight_1eyvn_85" loading="lazy" fetchpriority="auto" decoding="async" crossorigin="anonymous"></button></div></div></a></div></div></div></div></div><img src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Fe4c269018ce94700a59e351c5b9edb99" loading="lazy" alt="" class="related-resources-shap-1 desktop blog-related-glitch"><img src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F1aa59311842f4ca6bda70300ff181cf9" loading="lazy" alt="" class="related-resources-shape-7"><img src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2F9ad6bcb77d1842b98142269ef70c4f47" loading="lazy" alt="" class="related-resources-shap-6"></section></div><div class="builder-block builder-0f50d623022042208a513ab79514b79b builder-has-component css-4hp89i" builder-id="builder-0f50d623022042208a513ab79514b79b"><section class="relative overflow-visible w-full"><div style="max-width:1200px;container-type:inline-size" class="content-container"><div class="relative"><div class="blog-signup-cta-section-container"><div class="blog-signup-cta-section-content-container"><h2 class="heading-2">Sign Up for Huntress Updates</h2><div class="richtext large">Get insider access to Huntress tradecraft, killer events, and the freshest blog updates.</div><div class="pt-5 w-full"><div class="w-full "><div id="anchor-blog-signup-form" class="responsive-anchor"></div><div class="_formWrap_1yjj9_25"><div class=""><div class="_form_1yjj9_1 pt-5 pb-0 px-0"><form id="wf-form-Blog-Signup-Form" name="wf-form-Blog-Signup-Form" data-hs-cf-bound="false" data-hubspot-form-id="5198e52f-a296-4d78-935d-fe864d69a67a" class="_formGrid_1yjj9_107"><div class="_formGroup_1yjj9_116 _colspan2_1yjj9_130"><div class="_wrapper_z4sdm_1"><input type="email" class="_input_z4sdm_7 responsive-anchor" placeholder="Work Email*" aria-invalid="false" id="email" autocomplete="email" data-snowplow-fieldname="email" data-ignore-nb="true" name="email" value=""><label class="_label_z4sdm_30">Work Email*</label></div></div><div class="_formGroup_1yjj9_116 _colspan2_1yjj9_130"><div class="_submitButtonRow_1yjj9_172"><div class="turnstile-wrapper w-full max-w-[300px] justify-items-center" style="display:block"><div class="_tempWrapper_1qkft_1 "><div class="_tempMainWrapper_1qkft_20"><div id="content" class="_tempContent_1qkft_40" aria-live="polite" aria-atomic="true" style="display:flex"><div id="success" role="alert" style="display:grid;visibility:visible"></div><div id="branding" class="_tempBranding_1qkft_53"><a class="cf-link" target="_blank" href="https://www.cloudflare.com/products/turnstile/?utm_source=turnstile&amp;utm_campaign=widget" rel="noopener noreferrer"><svg role="img" aria-label="Cloudflare" id="logo" class="_tempLogo_1qkft_37" viewBox="0 0 73 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M61.8848 15.7841L62.0632 15.1578C62.2758 14.4126 62.1967 13.7239 61.8401 13.2178C61.5118 12.7517 60.9649 12.4773 60.3007 12.4453L47.7201 12.2836C47.6811 12.2829 47.6428 12.2728 47.6083 12.2542C47.5738 12.2356 47.5442 12.209 47.5217 12.1766C47.4996 12.1431 47.4856 12.1049 47.4807 12.0649C47.4758 12.025 47.4801 11.9844 47.4933 11.9465C47.5149 11.8839 47.5541 11.8291 47.6061 11.7888C47.658 11.7486 47.7204 11.7247 47.7856 11.72L60.4827 11.5566C61.9889 11.4864 63.6196 10.2462 64.1905 8.73372L64.9146 6.81361C64.9443 6.73242 64.951 6.64444 64.9341 6.55957C64.112 2.80652 60.8115 0 56.8652 0C53.2293 0 50.1421 2.38158 49.0347 5.69186C48.2864 5.12186 47.3535 4.85982 46.4228 4.95823C44.6785 5.13401 43.276 6.55928 43.1034 8.32979C43.059 8.77189 43.0915 9.21845 43.1992 9.64918C40.3497 9.73347 38.0645 12.1027 38.0645 15.0151C38.0649 15.2751 38.0838 15.5347 38.1212 15.7919C38.1294 15.8513 38.1584 15.9057 38.2029 15.9452C38.2474 15.9847 38.3044 16.0067 38.3635 16.0071L61.5894 16.0099C61.5916 16.0101 61.5938 16.0101 61.596 16.0099C61.6616 16.0088 61.7252 15.9862 61.7772 15.9455C61.8293 15.9049 61.867 15.8483 61.8848 15.7841Z" fill="#F6821F"></path><path d="M66.0758 6.95285C65.9592 6.95285 65.843 6.95582 65.7274 6.96177C65.7087 6.96312 65.6904 6.96719 65.6729 6.97385C65.6426 6.98437 65.6152 7.00219 65.5931 7.02579C65.5711 7.04939 65.555 7.07806 65.5462 7.10936L65.0515 8.84333C64.8389 9.58847 64.918 10.2766 65.2749 10.7827C65.6029 11.2494 66.1498 11.5233 66.814 11.5552L69.4959 11.7186C69.5336 11.7199 69.5705 11.73 69.6037 11.7483C69.6369 11.7666 69.6654 11.7925 69.687 11.8239C69.7092 11.8576 69.7234 11.896 69.7283 11.9363C69.7332 11.9765 69.7288 12.0173 69.7153 12.0555C69.6937 12.118 69.6546 12.1727 69.6028 12.2129C69.5509 12.2531 69.4887 12.2771 69.4236 12.2819L66.6371 12.4453C65.1241 12.5161 63.4937 13.7558 62.9233 15.2682L62.722 15.8022C62.7136 15.8245 62.7105 15.8486 62.713 15.8724C62.7155 15.8961 62.7236 15.9189 62.7365 15.9389C62.7495 15.9589 62.7669 15.9755 62.7874 15.9873C62.8079 15.9991 62.8309 16.0058 62.8544 16.0068C62.8569 16.0068 62.8592 16.0068 62.8618 16.0068H72.4502C72.506 16.0073 72.5604 15.9893 72.6051 15.9554C72.6498 15.9216 72.6823 15.8739 72.6977 15.8195C72.8677 15.2043 72.9535 14.5684 72.9529 13.9296C72.9517 10.0767 69.8732 6.95285 66.0758 6.95285Z" fill="#FBAD41"></path><path d="M8.11963 18.8904H9.75541V23.4254H12.6139V24.8798H8.11963V18.8904Z" class="_tempLogoText_1qkft_37"></path><path d="M14.3081 21.9023V21.8853C14.3081 20.1655 15.674 18.7704 17.4952 18.7704C19.3164 18.7704 20.6653 20.1482 20.6653 21.8681V21.8853C20.6653 23.6052 19.2991 24.9994 17.4785 24.9994C15.6578 24.9994 14.3081 23.6222 14.3081 21.9023ZM18.9958 21.9023V21.8853C18.9958 21.0222 18.3806 20.2679 17.4785 20.2679C16.5846 20.2679 15.9858 21.0038 15.9858 21.8681V21.8853C15.9858 22.7484 16.6013 23.5025 17.4952 23.5025C18.3973 23.5025 18.9958 22.7666 18.9958 21.9023Z" class="_tempLogoText_1qkft_37"></path><path d="M22.6674 22.253V18.8901H24.3284V22.2191C24.3284 23.0822 24.7584 23.4939 25.4159 23.4939C26.0733 23.4939 26.5034 23.1003 26.5034 22.2617V18.8901H28.1647V22.2093C28.1647 24.1432 27.0772 24.9899 25.3991 24.9899C23.7211 24.9899 22.6674 24.1268 22.6674 22.2522" class="_tempLogoText_1qkft_37"></path><path d="M30.668 18.8907H32.9445C35.0526 18.8907 36.275 20.1226 36.275 21.8508V21.8684C36.275 23.5963 35.0355 24.88 32.911 24.88H30.668V18.8907ZM32.97 23.4076C33.9483 23.4076 34.597 22.8609 34.597 21.8928V21.8759C34.597 20.9178 33.9483 20.3614 32.97 20.3614H32.3038V23.4082L32.97 23.4076Z" class="_tempLogoText_1qkft_37"></path><path d="M38.6525 18.8904H43.3738V20.3453H40.2883V21.3632H43.079V22.7407H40.2883V24.8798H38.6525V18.8904Z" class="_tempLogoText_1qkft_37"></path><path d="M45.65 18.8904H47.2858V23.4254H50.1443V24.8798H45.65V18.8904Z" class="_tempLogoText_1qkft_37"></path><path d="M54.4187 18.8475H55.9949L58.5079 24.8797H56.7541L56.3238 23.8101H54.047L53.6257 24.8797H51.9058L54.4187 18.8475ZM55.8518 22.5183L55.1941 20.8154L54.5278 22.5183H55.8518Z" class="_tempLogoText_1qkft_37"></path><path d="M60.6149 18.8901H63.4056C64.3083 18.8901 64.9317 19.13 65.328 19.5406C65.6742 19.883 65.8511 20.3462 65.8511 20.9357V20.9526C65.8511 21.8678 65.3691 22.4754 64.6369 22.7919L66.045 24.88H64.1558L62.9671 23.0658H62.2507V24.88H60.6149V18.8901ZM63.3299 21.7654C63.8864 21.7654 64.2071 21.4915 64.2071 21.0551V21.0381C64.2071 20.5674 63.8697 20.328 63.3211 20.328H62.2507V21.7665L63.3299 21.7654Z" class="_tempLogoText_1qkft_37"></path><path d="M68.2112 18.8904H72.9578V20.3024H69.8302V21.209H72.6632V22.5183H69.8302V23.4683H73V24.8798H68.2112V18.8904Z" class="_tempLogoText_1qkft_37"></path><path d="M4.53824 22.6043C4.30918 23.13 3.82723 23.5022 3.18681 23.5022C2.29265 23.5022 1.67746 22.7493 1.67746 21.8851V21.8678C1.67746 21.0047 2.27593 20.2676 3.1698 20.2676C3.84367 20.2676 4.35681 20.6882 4.5734 21.2605H6.29764C6.02151 19.8349 4.78716 18.7707 3.18681 18.7707C1.36533 18.7707 0 20.1666 0 21.8851V21.9021C0 23.6219 1.3486 25 3.1698 25C4.72762 25 5.94525 23.9764 6.26645 22.6046L4.53824 22.6043Z" class="_tempLogoText_1qkft_37"></path></svg></a><div id="terms" class="_tempTerms_1qkft_64"><a id="privacy-link" class="_tempTermsLink_1qkft_73" target="_blank" rel="noopener noreferrer" href="https://www.cloudflare.com/privacypolicy/">Privacy</a><span class="_tempLinkSpacer_1qkft_77"> • </span><a id="terms-link" class="_tempTermsLink_1qkft_73" target="_blank" rel="noopener noreferrer" href="https://www.cloudflare.com/website-terms/">Terms</a></div></div></div></div></div> <div></div></div><button class="_button_1eyvn_1 _solid_1eyvn_27 _large_1eyvn_119 _submitButton_1yjj9_172 " type="submit" aria-label="Submit" id="submitButton"><span class="_buttonText_1eyvn_155"><div class="_buttonText_1eyvn_155">Submit</div></span></button></div></div><div class="_formGroup_1yjj9_116 _colspan2_1yjj9_130"><div class="_privacyPolicy_1yjj9_221">By submitting this form, you accept our<!-- --> <a href="https://www.huntress.com/terms-of-use" target="_blank" class="_noWrap_1yjj9_289">Terms of Service</a> <!-- -->&amp;<!-- --> <a class="persistent-link _noWrap_1yjj9_289" href="https://www.huntress.com/privacy-policy" target="_blank" data-discover="true">Privacy Policy</a></div></div></form></div></div><div class="text-pretty md:text-balance blog-signup-cta-section-subscribe-success-state _successState_1yjj9_236 " tabindex="-1" role="region" aria-label="Schedule a demo success"><div>Thank you! Your submission has been received!</div></div><div class="text-pretty md:text-balance blog-signup-cta-section-error-message-alt _errorMessage_1yjj9_257 " tabindex="-1" role="region" aria-label="Schedule a demo failure"><div>Oops! Something went wrong while submitting the form.</div></div></div></div></div></div><div class="blog-signup-cta-section-image-wrapper"><img data-image-zoomable="false" src="https://cdn.builder.io/api/v1/image/assets%2F3eb6f92aedf74f109c7b4b0897ec39a8%2Fcb5efa5143804ba59d530a903d29fe5f" alt="" class="builder-image blog-signup-cta-section-image" loading="lazy" fetchpriority="auto" decoding="async" crossorigin="anonymous"></div></div></div></div></section></div><img src="https://cdn.builder.io/api/v1/pixel?apiKey=3eb6f92aedf74f109c7b4b0897ec39a8" aria-hidden="true" alt="" role="presentation" width="0" height="0" class="builder-block builder-pixel-hgtp2h14ooc css-17uogdh" builder-id="builder-pixel-hgtp2h14ooc"></div></div></div></div></main><div><!--$--><!--/$--></div></div><!--/$--><!--$--><div id="automation-verification"></div><!--/$--><div id="ab-test-root" class="ab-test-root"></div><!--$--><!--$--><!--/$--><!--/$--></body></html>