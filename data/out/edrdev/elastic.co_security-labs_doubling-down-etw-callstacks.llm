Title:
Doubling Down: Detecting In-Memory Threats with Kernel ETW Call Stacks

Type:
Blog Post

Short Summary (4–8 sentences max):
- This write-up explains how Elastic Security 8.11 expands kernel-level ETW telemetry with call stack context to better detect in-memory threats on Windows.  
- It addresses the fragility of user-mode API hooking (often bypassed via direct syscalls, unhooking, or call stack spoofing) by leaning on Microsoft’s Threat-Intelligence ETW provider for syscall-adjacent visibility.  
- The post details an implementation strategy to manage high-volume API telemetry (event fingerprinting/deduplication and default on-host processing rather than SIEM streaming).  
- It enumerates monitored memory/injection-relevant APIs (e.g., VirtualAlloc/Protect, MapViewOfFile, WriteProcessMemory, QueueUserAPC) and enriches events with behavioral tags like direct_syscall, proxy_call, image_rop, unbacked_rwx, and hollow_image.  
- Several new detection rules are shown, targeting direct/indirect syscalls, module stomping/image hollowing, AMSI/WLDP patching, ETW patching, and remote hooking of NTDLL/KernelBase.  
- It’s most useful for blue teams and detection engineers building resilient Windows in-memory tradecraft detections, and for red teams to understand what kernel call stack-aware EDR logic is keying on.

Technical Focus:
- Kernel ETW (Microsoft-Windows-Threat-Intelligence) telemetry and call stack capture
- In-memory tradecraft detection (allocation/protection changes, mapping, remote memory writes)
- Direct syscalls / indirect syscalls and call stack origin validation (NTDLL/Nt* expectations)
- Call stack anomaly heuristics (synthetic frames, proxy calls, ROP-like frames)
- AMSI/WLDP and ETW patching detection via memory modification telemetry
- Telemetry volume control (deduplication, on-host detection vs SIEM streaming)

Use Cases:
- Detect shellcode allocation/execution patterns via VirtualAlloc/VirtualProtect call stacks
- Identify direct-syscall injection frameworks that bypass user-mode hooks
- Hunt for module stomping / image hollowing from unbacked memory regions
- Alert on AMSI/WLDP bypass attempts through memory permission changes or writes
- Detect ETW tampering (patching Etw*/NtTrace* paths) and remote NTDLL/KernelBase hooking
- Tune endpoint telemetry pipelines to reduce SIEM cost while keeping high-fidelity detections

Keywords:
ETW, Microsoft-Windows-Threat-Intelligence, kernel telemetry, call stacks, Elastic Defend 8.11, VirtualAlloc, VirtualProtect, MapViewOfFile, WriteProcessMemory, QueueUserAPC, SetThreadContext, direct syscall, indirect syscall, NTDLL, NtProtectVirtualMemory, process injection, module stomping, image hollowing, AMSI, WLDP, ETW patching, ROP, unbacked memory, RWX, LSASS