# https://github.com/Xacone/BestEdrOfTheMarket

[Skip to content](https://github.com/Xacone/BestEdrOfTheMarket#start-of-content)

You signed in with another tab or window. [Reload](https://github.com/Xacone/BestEdrOfTheMarket) to refresh your session.You signed out in another tab or window. [Reload](https://github.com/Xacone/BestEdrOfTheMarket) to refresh your session.You switched accounts on another tab or window. [Reload](https://github.com/Xacone/BestEdrOfTheMarket) to refresh your session.Dismiss alert

{{ message }}

[Xacone](https://github.com/Xacone)/ **[BestEdrOfTheMarket](https://github.com/Xacone/BestEdrOfTheMarket)** Public

- [Notifications](https://github.com/login?return_to=%2FXacone%2FBestEdrOfTheMarket) You must be signed in to change notification settings
- [Fork\\
150](https://github.com/login?return_to=%2FXacone%2FBestEdrOfTheMarket)
- [Star\\
1.4k](https://github.com/login?return_to=%2FXacone%2FBestEdrOfTheMarket)


EDR Lab for Experimentation Purposes


[xacone.github.io/BestEdrOfTheMarketV3.html](https://xacone.github.io/BestEdrOfTheMarketV3.html "https://xacone.github.io/BestEdrOfTheMarketV3.html")

### License

[MIT license](https://github.com/Xacone/BestEdrOfTheMarket/blob/main/LICENSE)

[1.4k\\
stars](https://github.com/Xacone/BestEdrOfTheMarket/stargazers) [150\\
forks](https://github.com/Xacone/BestEdrOfTheMarket/forks) [Branches](https://github.com/Xacone/BestEdrOfTheMarket/branches) [Tags](https://github.com/Xacone/BestEdrOfTheMarket/tags) [Activity](https://github.com/Xacone/BestEdrOfTheMarket/activity)

[Star](https://github.com/login?return_to=%2FXacone%2FBestEdrOfTheMarket)

[Notifications](https://github.com/login?return_to=%2FXacone%2FBestEdrOfTheMarket) You must be signed in to change notification settings

# Xacone/BestEdrOfTheMarket

main

[Branches](https://github.com/Xacone/BestEdrOfTheMarket/branches) [Tags](https://github.com/Xacone/BestEdrOfTheMarket/tags)

[Go to Branches page](https://github.com/Xacone/BestEdrOfTheMarket/branches)[Go to Tags page](https://github.com/Xacone/BestEdrOfTheMarket/tags)

Go to file

Code

Open more actions menu

## Folders and files

| Name | Name | Last commit message | Last commit date |
| --- | --- | --- | --- |
| ## Latest commit<br>## History<br>[120 Commits](https://github.com/Xacone/BestEdrOfTheMarket/commits/main/) <br>[View commit history for this file.](https://github.com/Xacone/BestEdrOfTheMarket/commits/main/) 120 Commits |
| [Assets](https://github.com/Xacone/BestEdrOfTheMarket/tree/main/Assets "Assets") | [Assets](https://github.com/Xacone/BestEdrOfTheMarket/tree/main/Assets "Assets") |  |  |
| [BestEdrOfTheMarket](https://github.com/Xacone/BestEdrOfTheMarket/tree/main/BestEdrOfTheMarket "BestEdrOfTheMarket") | [BestEdrOfTheMarket](https://github.com/Xacone/BestEdrOfTheMarket/tree/main/BestEdrOfTheMarket "BestEdrOfTheMarket") |  |  |
| [BestEdrOfTheMarketDriver](https://github.com/Xacone/BestEdrOfTheMarket/tree/main/BestEdrOfTheMarketDriver "BestEdrOfTheMarketDriver") | [BestEdrOfTheMarketDriver](https://github.com/Xacone/BestEdrOfTheMarket/tree/main/BestEdrOfTheMarketDriver "BestEdrOfTheMarketDriver") |  |  |
| [.gitignore](https://github.com/Xacone/BestEdrOfTheMarket/blob/main/.gitignore ".gitignore") | [.gitignore](https://github.com/Xacone/BestEdrOfTheMarket/blob/main/.gitignore ".gitignore") |  |  |
| [BestEdrOfTheMarket.sln](https://github.com/Xacone/BestEdrOfTheMarket/blob/main/BestEdrOfTheMarket.sln "BestEdrOfTheMarket.sln") | [BestEdrOfTheMarket.sln](https://github.com/Xacone/BestEdrOfTheMarket/blob/main/BestEdrOfTheMarket.sln "BestEdrOfTheMarket.sln") |  |  |
| [LICENSE](https://github.com/Xacone/BestEdrOfTheMarket/blob/main/LICENSE "LICENSE") | [LICENSE](https://github.com/Xacone/BestEdrOfTheMarket/blob/main/LICENSE "LICENSE") |  |  |
| [README.md](https://github.com/Xacone/BestEdrOfTheMarket/blob/main/README.md "README.md") | [README.md](https://github.com/Xacone/BestEdrOfTheMarket/blob/main/README.md "README.md") |  |  |
| View all files |

## Repository files navigation

# [Best EDR Of The Market (BEOTM) V3 üê≤üè¥‚Äç‚ò†Ô∏è](https://xacone.github.io/BestEdrOfTheMarketV3.html)

[Permalink:  Best EDR Of The Market (BEOTM) V3 üê≤üè¥‚Äç‚ò†Ô∏è ](https://github.com/Xacone/BestEdrOfTheMarket#-best-edr-of-the-market-beotm-v3-%E2%80%8D%EF%B8%8F-)

[![](https://github.com/Xacone/BestEdrOfTheMarket/raw/main/Assets/beotm_banner.png)](https://github.com/Xacone/BestEdrOfTheMarket/blob/main/Assets/beotm_banner.png)

Best Edr Of The Market is an open-source lab designed to implement and understand, from a low-level perspective, the detection methods used by Endpoints Detection & Response security products and their workarounds. These techniques are mainly based on the exploitation of Windows NT's telemetric capabilities to dynamically analyze process behavior.

**[‚û°Ô∏è‚Äã What's New in the Kernel Version of BestEdrOfTheMarket?](https://xacone.github.io/BestEdrOfTheMarketV3.html)**

## Defensive Capabilities

[Permalink: Defensive Capabilities](https://github.com/Xacone/BestEdrOfTheMarket#defensive-capabilities)

This current version (v3) focuses on some of the interception capabilities offered by the Windows kernel. These include:

- [x] [System Calls Interception via Alternative System Call Handlers](https://xacone.github.io/BestEdrOfTheMarketV3.html#4)

- [x] [Exploitation of the Virtual Address Descriptor (VAD) Tree for Image Integrity Checking](https://xacone.github.io/BestEdrOfTheMarketV3.html#3)

- [x] [Using kernel callbacks to capture events related to thread creation, process creation, image loading into memory, registry operations, and object-related operations.](https://xacone.github.io/BestEdrOfTheMarketV3.html#2)

- [x] [Code injection detection by validating the integrity of thread call stacks.](https://xacone.github.io/BestEdrOfTheMarketV3.html#5)

- [x] [Integration of Yara rules for rapid pattern detection in memory buffers/files](https://xacone.github.io/BestEdrOfTheMarketV3.html#4)

- [x] [Integrity checking of system calls](https://xacone.github.io/BestEdrOfTheMarketV3.html#4)

- [x] [Leverage of the Shadow Stack to Verify Thread Call Stacks Integrity](https://xacone.github.io/BestEdrOfTheMarketV3.html#6)


Thus, this 3rd version makes it possible to detect a bunch of TTPs such as PPID Spoofing ( [T1134.004](https://attack.mitre.org/techniques/T1134/004/)), Credential Dumping ( [T1003.001](https://attack.mitre.org/techniques/T1003/001/)), process Hollowing/Ghosting/Tampering ( [T1055.012](https://attack.mitre.org/techniques/T1055/012/)), memory code injection ( [T1055](https://attack.mitre.org/techniques/T1055/)) methods including APC queuing ( [T1055.004](https://attack.mitre.org/techniques/T1055/004/)) & Thread Hijacking ( [T1055.003](https://attack.mitre.org/techniques/T1055/003/)), Abnormal System Calls ( [T1106](https://attack.mitre.org/techniques/T1106/)), Registry Persistence Operations ( [T1547.001](https://attack.mitre.org/techniques/T1547/001/)) and many more...

## Release Structure

[Permalink: Release Structure](https://github.com/Xacone/BestEdrOfTheMarket#release-structure)

The project incorporates a clone of @Elastic's [protection-artifacts](https://github.com/Xacone/BestEdrOfTheMarket/blob/main) repository for the provision of Yara rules.

```
üìÅ beotmv3
    ‚öôÔ∏è beotm.sys
    üìÑ beotm.exe
    üìÅ protection-artifacts/
        üìÅ rules/
            üìÅ yara/
                üìÑ Windows_Trojan_Metasploit.yar
                üìÑ Windows_Hacktool_Mimikatz.yar
                üìÑ Windows_Hacktool_Rubeus.yar
                üìÑ ...
    üìÑ libcrypto-3-x64.dll
```

## Usage

[Permalink: Usage](https://github.com/Xacone/BestEdrOfTheMarket#usage)

```
beotm.exe <path to driver> <path to Yara rules folder>
```

Example with `protection-artifacts`:

```
.\beotm.exe .\beotm.sys .\protection-artifacts\yara\rules\
```

beotm.exe installs the beotm.sys driver on the system by itself, and asks to be run in administrator mode before starting. Once the driver is installed, it retrieves and compiles the Yara rules supplied in the path specified in its parameters:

[![Yara Rules Compiling](https://github.com/Xacone/BestEdrOfTheMarket/raw/main/Assets/beotm_yara_rules_compiling.png)](https://github.com/Xacone/BestEdrOfTheMarket/blob/main/Assets/beotm_yara_rules_compiling.png)

Once all Yara rules have been compiled, press any key and you'll be redirected to the UI panel:

[![BEOTM Ui](https://github.com/Xacone/BestEdrOfTheMarket/raw/main/Assets/beotm_simple_ui_panel.png)](https://github.com/Xacone/BestEdrOfTheMarket/blob/main/Assets/beotm_simple_ui_panel.png)

When beotm.exe is terminated, the service associated with the driver remains active on the system, so if you run beotm.exe again, there's no need to re-install the driver. The service is called ‚ÄúBeotmDrv‚Äù:

```
C:\Windows\system32>sc.exe query type=driver | findstr /i "beotm"
SERVICE_NAME: BeotmDrv
DISPLAY_NAME: BeotmDrv
```

You can stop the service if you wish, as follows:

```
C:\Windows\system32> sc.exe stop BeotmDrv
```

## Requirements

[Permalink: Requirements](https://github.com/Xacone/BestEdrOfTheMarket#requirements)

You'll need a test environment such as a Windows virtual machine. [The machine must be configured in `TESTSIGNING` mode.](https://learn.microsoft.com/en-us/windows-hardware/drivers/install/the-testsigning-boot-configuration-option#enable-or-disable-use-of-test-signed-code)

I recommend a Windows 10 22H2 VM (this is the version on which BEOTM was tested), but the project should be compatible between Windows 10 20H1 and Windows 10 22H2.

[You can also debug the remote VM kernel if you would like to test your changes.](https://www.apriorit.com/dev-blog/kernel-driver-debugging-with-windbg) A debug message is displayed when BEOTM is launched, informing whether or not the callbacks have been successfully registered:

```
1: kd> g
 ____            _     _____ ____  ____     ___   __   _____ _
| __ )  ___  ___| |_  | ____|  _ \|  _ \   / _ \ / _| |_   _| |__   ___
|  _ \ / _ \/ __| __| |  _| | | | | |_) | | | | | |_    | | | '_ \ / _ \
| |_) |  __/\__ \ |_  | |___| |_| |  _ <  | |_| |  _|   | | | | | |  __/
|____/_\___||___/\__| |_____|____/|_| \_\  \___/|_|     |_| |_| |_|\___|     v3
|  \/  | __ _ _ __| | _____| |_
| |\/| |/ _` | '__| |/ / _ \ __|
| |  | | (_| | |  |   <  __/ |_           Yazidou - github.com/Xacone
|_|  |_|\__,_|_|  |_|\_\___|\__|

[+] Win Kernel Structs offsets initialized
[+] Altsyscall handler registered !
[+] PsSetCreateThreadNotifyRoutine success
[+] PsSetCreateProcessNotifyRoutineEx success
[+] PsSetLoadImageNotifyRoutine success
[+] ObRegisterCallbacks 1 success
[+] CmRegisterCallbackEx success
[+] Driver loaded
```

## Building the Project

[Permalink: Building the Project](https://github.com/Xacone/BestEdrOfTheMarket#building-the-project)

The project was designed in Visual Studio 2022. Make sure you have the WDK upstream and all the prerequisites, such as the x64 spectrum mitigation libraries. [The Windows Hardware documentation details how to proceed.](https://learn.microsoft.com/en-us/windows-hardware/drivers/download-the-wdk)

The project uses C++20.

The project includes as yet unimplemented TCP/IP filtering functionality based on NDIS. If you encounter "Symbol not found"-like errors. Make sure to link the following libraries in _BestEdrOfTheMarketDriver -> Project Properties -> Linker -> Entry -> Additional Dependencies_:

```
$(DDK_LIB_PATH)\fwpkclnt.lib
$(DDK_LIB_PATH)\ndis.lib
$(SDK_LIB_PATH)\uuid.lib
```

On the user side, make sure you install [yara](https://vcpkg.link/ports/yara) with [vcpkg](https://github.com/microsoft/vcpkg):

```
.\vcpkg\vcpkg.exe install yara
```

Here's how to get the vcpkg.exe executable:

```
git clone https://github.com/microsoft/vcpkg
.\vcpkg\bootstrap-vcpkg.bat
```

## Issue Reporting

[Permalink: Issue Reporting](https://github.com/Xacone/BestEdrOfTheMarket#issue-reporting)

Feel free [to open an issue](https://github.com/Xacone/BestEdrOfTheMarket/issues) for any crash/bug/BSOD you encounter or any excessive false positives.

Please provide me with as much information as possible to help me pinpoint the cause of the error. To do this, nothing better than to provide me with the conditions under which the bug was reproduced and, incidentally, the artifact that caused it + the output of `analyze -v` on WinDbg in kernel debugging mode, (if possible).

If it was one of your artifacts that caused the crash/bug/BSOD, it would be cool if I could also have its source code.

## Disclaimer ‚ö†Ô∏è

[Permalink: Disclaimer ‚ö†Ô∏è](https://github.com/Xacone/BestEdrOfTheMarket#disclaimer-%EF%B8%8F)

The scope of this project is purely educational. The driver is to be used in a **controlled testing environment** only.

## About

EDR Lab for Experimentation Purposes


[xacone.github.io/BestEdrOfTheMarketV3.html](https://xacone.github.io/BestEdrOfTheMarketV3.html "https://xacone.github.io/BestEdrOfTheMarketV3.html")

### Topics

[kernel-driver](https://github.com/topics/kernel-driver "Topic: kernel-driver") [edr](https://github.com/topics/edr "Topic: edr") [kernel-development](https://github.com/topics/kernel-development "Topic: kernel-development") [edr-testing](https://github.com/topics/edr-testing "Topic: edr-testing") [defense-evasion](https://github.com/topics/defense-evasion "Topic: defense-evasion") [edr-evasion](https://github.com/topics/edr-evasion "Topic: edr-evasion")

### Resources

[Readme](https://github.com/Xacone/BestEdrOfTheMarket#readme-ov-file)

### License

[MIT license](https://github.com/Xacone/BestEdrOfTheMarket#MIT-1-ov-file)

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/Xacone/BestEdrOfTheMarket).

[Activity](https://github.com/Xacone/BestEdrOfTheMarket/activity)

### Stars

[**1.4k**\\
stars](https://github.com/Xacone/BestEdrOfTheMarket/stargazers)

### Watchers

[**18**\\
watching](https://github.com/Xacone/BestEdrOfTheMarket/watchers)

### Forks

[**150**\\
forks](https://github.com/Xacone/BestEdrOfTheMarket/forks)

[Report repository](https://github.com/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2FXacone%2FBestEdrOfTheMarket&report=Xacone+%28user%29)

## [Releases\  1](https://github.com/Xacone/BestEdrOfTheMarket/releases)

[Best EDR Of The Market V3\\
Latest\\
\\
Apr 14, 2024](https://github.com/Xacone/BestEdrOfTheMarket/releases/tag/v3)

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/Xacone/BestEdrOfTheMarket).

## Languages

- [C++82.3%](https://github.com/Xacone/BestEdrOfTheMarket/search?l=c%2B%2B)
- [C16.4%](https://github.com/Xacone/BestEdrOfTheMarket/search?l=c)
- [Python1.3%](https://github.com/Xacone/BestEdrOfTheMarket/search?l=python)

You can‚Äôt perform that action at this time.