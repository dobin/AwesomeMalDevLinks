# https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm

<!DOCTYPE html><html lang="en-US"><body class="wp-singular post-template-default single single-post postid-5642 single-format-standard wp-custom-logo wp-embed-responsive wp-theme-helpsystems wp-child-theme-cobalt-strike group-blog understrap-has-sidebar"><div id="consent_blackbar" lang="en">
            
            <div id="truste-consent-track" style="position: relative; z-index: 999999; border-top: 1px solid rgb(102, 102, 102);" class="ta-show ta-display-block">  <div id="truste-consent-content" style="overflow: hidden;">    <div id="truste-consent-text" class="truste-messageColumn" data-nosnippet="data-nosnippet">      <span class="hstitle">This website uses cookies. You may change your settings at any time.</span>    </div>    <div id="truste-consent-buttons" class="truste-buttonsColumn" data-nosnippet="data-nosnippet">      <span id="truste-repop-msg" style="padding: 7px 10px; background: #F9EDBE; border:1px solid #F0C36D; margin: 11px 0px 13px;font-size:11; line-height: 16px;color: #AF7501; display:none;"></span>       <button id="truste-consent-button">Accept</button>      <button id="truste-consent-required">Reject All</button>      <button id="truste-show-consent" aria-haspopup="dialog">Manage Cookies</button>    </div>  </div></div></div>
<div style="display:none;" id="teconsent" consent="undefined" aria-label="Open Cookie Preferences Modal" class="truste_caIcon_display" role="complementary"><a role="link" id="icon-id08717233114185574" tabindex="0" lang="en" aria-haspopup="dialog" aria-label="Cookie Preferences, opens a dedicated popup modal window" class="truste_cursor_pointer">Cookie Preferences</a></div>

	
<!-- TrustArc tag end -->
<!-- Google Tag Manager -->

<!-- End Google Tag Manager --><link rel="icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-32x32.png" sizes="32x32">
<link rel="icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-192x192.png" sizes="192x192">
<link rel="apple-touch-icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-180x180.png">

		
		


<!-- Google Tag Manager (noscript) -->

<!-- End Google Tag Manager (noscript) -->
<div class="site" id="page">

	<!-- ******************* The Navbar Area ******************* -->
	<!-- #wrapper-navbar -->

<div class="header-banner"> 
	<div class="jumbotron jumbotron-fluid bg-4 " style="background-image: ">
	<div class="banner-wrapper">
		<div class="container">
			<p class="yoast-breadcrumbs m-0"><span><span><a href="https://www.cobaltstrike.com/">Home</a></span> » <span><a href="https://www.cobaltstrike.com/blog/">Blog</a></span> » <span class="breadcrumb_last" aria-current="page">Introducing the Mutator Kit: Creating Object File Monstrosities with Sleep Mask and LLVM</span></span></p>							<h1>Introducing the Mutator Kit: Creating Object File Monstrosities with Sleep Mask and LLVM</h1>
							</div>
	</div>
	</div>
</div>


<div class="wrapper" id="page-wrapper">

	<div class="container" id="content" tabindex="-1">
		<div class="row">
			<div class="col-lg-8 content-area" id="primary">

				<main class="site-main" id="main">
					<article class="post-5642 post type-post status-publish format-standard hentry cornerstone-development cornerstone-red-team cta_type-blog" id="post-5642">


<div class="entry-content">
		
<p><em>This is a joint blog written by William Burgess (<a href="https://x.com/joehowwolf" target="_blank" rel="noreferrer noopener">@joehowwolf</a>) and Henri Nurmi (<a href="https://twitter.com/HenriNurmi" target="_blank" rel="noreferrer noopener">@HenriNurmi</a>).</em></p>



<p>In our <a href="https://www.cobaltstrike.com/blog/cobalt-strike-and-yara-can-i-have-your-signature" target="_blank" rel="noreferrer noopener">‘Cobalt Strike and YARA: Can I Have Your Signature?’ blog post</a>, we highlighted that the sleep mask is a common target for in-memory YARA signatures. In that post we recommended using the evasive sleep mask option to scramble the sleep mask at run time and break any static signatures. However, this solves the problem at the cost of introducing further forensic artefacts onto a host and increasing our footprint. A much simpler solution is to mutate the sleep mask each time we compile it to make static signatures redundant.</p>



<p>This blog introduces the mutator kit, which uses an LLVM obfuscator to break in-memory YARA scanning of the sleep mask. In the following sections, we will give a quick background to the mutator kit and then show you how to apply it so that a uniquely mutated sleep mask can be applied every time a payload is exported.&nbsp;</p>



<p>The mutator kit is available in the Arsenal Kit now.&nbsp;</p>



<figure class="wp-block-embed is-type-video is-provider-wistia-inc wp-block-embed-wistia-inc"><div class="wp-block-embed__wrapper">
<div title="Demo: Cobalt Strike MutatorKit Video" src="https://fast.wistia.net/embed/iframe/ncw3ov93bg?dnt=1" allow="autoplay; fullscreen" allowtransparency="true" frameborder="0" scrolling="no" class="wistia_embed" name="wistia_embed" msallowfullscreen="" width="640" height="340" data-original-tag="iframe">



<title>Demo: Cobalt Strike MutatorKit</title>
<link rel="alternate" type="application/json+oembed" href="https://fast.wistia.com/oembed.json?url=https%3A%2F%2Ffast.wistia.com%2Fembed%2Fiframe%2Fncw3ov93bg" title="Demo: Cobalt Strike MutatorKit">















<link as="script" crossorigin="anonymous" href="https://fast.wistia.net/assets/external/insideIframe.js" rel="modulepreload">

<div class="wistia_embed wistia_embed_initialized" id="wistia_video"><div id="wistia_chrome_37" class="w-chrome notranslate" tabindex="-1" style="display: inline-block; height: 100%; line-height: normal; margin: 0px; padding: 0px; position: relative; vertical-align: top; width: 100%; outline: none; overflow: hidden; box-sizing: content-box; border-radius: 0px; clip-path: inset(0.5px);"><div id="wistia_grid_72_wrapper" style="display: block;"><div id="wistia_grid_72_above"></div><div id="wistia_grid_72_main"><div id="wistia_grid_72_behind"></div><div id="wistia_grid_72_center"><div class="w-video-wrapper w-css-reset" style="width: 100%; height: 100%; transition: opacity 200ms; opacity: 1;"><video id="wistia_simple_video_147" crossorigin="anonymous" poster="https://fast.wistia.net/assets/images/blank.gif" aria-label="Demo: Cobalt Strike MutatorKit" src="blob:https://fast.wistia.net/bd4d5467-9797-45ce-8d48-49bd6540b3ae" controlslist="nodownload" playsinline="" preload="none" type="video/m3u8" x-webkit-airplay="allow" style="background: transparent; display: block; height: 100%; max-height: none; max-width: none; position: static; visibility: visible; width: 100%; object-fit: contain;"><source type="application/x-mpegURL" src="https://fast.wistia.com/embed/medias/ncw3ov93bg.m3u8"></video></div><div class="w-ui-container" style="height: 100%; left: 0px; position: absolute; top: 0px; width: 100%; transition: opacity 200ms; opacity: 1;"><div id="w-vulcan-v2-71" class="w-vulcan-v2 w-css-reset" style="border-radius: 0px; box-sizing: border-box; cursor: default; direction: ltr; height: 100%; left: 0px; position: absolute; visibility: visible; top: 0px; width: 100%; --wistia-player-icon-color: #ffffff; --wistia-player-color-hover: #001100; --wistia-player-icon-color-hover: #fff;"><div class="w-vulcan--background w-css-reset" style="height: 100%; left: 0px; position: absolute; top: 0px; width: 100%;"><div data-handle="statusBar" class="w-css-reset"></div><div data-handle="backgroundFocus" class="w-css-reset"><button aria-label="Play Video: Demo: Cobalt Strike MutatorKit" tabindex="0" class="w-css-reset w-vulcan-v2-button" style="clip: rect(1px, 1px, 1px, 1px); height: 1px; overflow: hidden; position: absolute; white-space: nowrap; width: 1px; pointer-events: none;"></button></div><div data-handle="thumbnail" class="w-css-reset"><div><div class="w-css-reset" style="filter: blur(5px); height: 100%; left: 0px; position: absolute; top: 0px; width: 100%; display: block;"><img src="https://fast.wistia.net/embed/medias/ncw3ov93bg/swatch" alt="Video Thumbnail" aria-hidden="true" class="w-css-reset" style="background-color: rgb(0, 0, 0); height: 100%; object-fit: contain; position: absolute; width: 100%; top: 0px; left: 0px; clip: auto; display: block; border-radius: 0px;"></div><div class="w-css-reset" style="height: 100%; left: 0px; opacity: 1; position: absolute; top: 0px; width: 100%; display: block; transition: opacity 3s;"><img src="https://embed-ssl.wistia.com/deliveries/0fa094ec15555fe1fcda7ac70f277d84.webp?image_crop_resized=640x340" alt="Video Thumbnail" class="w-css-reset" style="background-color: rgb(0, 0, 0); height: 100%; object-fit: contain; position: absolute; width: 100%; top: 0px; left: 0px; clip: auto; display: block; border-radius: 0px;"></div></div></div></div><div aria-live="polite" aria-atomic="true" class="w-vulcan--aria-live w-css-reset" style="position: absolute; left: -99999em;"></div><div class="w-vulcan-overlays-table w-css-reset" style="display: table; pointer-events: none; position: absolute; width: 100%; height: calc(100% - 34px);"><div class="w-vulcan-overlays--left w-css-reset" style="display: table-cell; height: auto; vertical-align: top; position: relative; width: 0px;"><div class="w-css-reset" style="height: 100%;"></div></div><div class="w-vulcan-overlays--center w-css-reset" style="display: table-cell; height: 100%; vertical-align: top; position: relative; width: 100%;"><div class="w-css-reset" style="height: 100%;"><div data-handle="bigPlayButton" class="w-css-reset" style="pointer-events: auto;"><div class="w-bpb-wrapper w-css-reset w-css-reset-tree" style="border-radius: 0px; display: block; left: calc(50%); margin-left: -62.5px; margin-top: -40px; overflow: hidden; position: absolute; top: calc(50% + 0px);"><button aria-label="Play Video: Demo: Cobalt Strike MutatorKit" tabindex="0" type="button" class="w-big-play-button w-css-reset-button-important w-vulcan-v2-button" style="background-color: transparent; border: 0px; color: rgb(255, 255, 255); cursor: pointer; height: 80px; box-shadow: none; width: 125px;"><div style="background: rgb(0, 106, 86); display: block; left: 0px; height: 80px; mix-blend-mode: darken; position: absolute; top: 0px; width: 125px;"></div><div style="background-color: rgba(0, 106, 86, 0.7); height: 80px; left: 0px; position: absolute; top: 0px; transition: background-color 150ms; width: 125px;"></div><svg x="0px" y="0px" viewBox="0 0 125 80" enable-background="new 0 0 125 80" aria-hidden="true" style="fill: rgb(255, 255, 255); height: 80px; left: 0px; stroke-width: 0px; top: 0px; width: 100%; position: absolute; color: rgb(255, 255, 255);"><path fill-rule="evenodd" clip-rule="evenodd" fill="currentcolor" opacity="1" transform="translate(44, 22)" d="M12.138 2.173C10.812 1.254 9 2.203 9 3.817v28.366c0 1.613 1.812 2.563 3.138 1.644l20.487-14.183a2 2 0 0 0 0-3.288L12.138 2.173Z"></path></svg></button></div></div><div data-handle="clickForSoundButton" class="w-css-reset" style="pointer-events: auto;"><div data-handle="click-for-sound-backdrop" class="w-css-reset w-css-reset-tree" style="display: none; height: 100%; left: 0px; pointer-events: auto; position: absolute; top: 0px; width: 100%;"><button aria-label="Click for sound" class="w-vulcan-v2-button click-for-sound-btn" style="background: rgba(0, 0, 0, 0.8); border: 2px solid transparent; border-radius: 60px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; outline: none; pointer-events: auto; position: absolute; right: 20.5px; top: 20.5px; max-width: 599px;"><div style="display: flex; align-items: center; justify-content: flex-end; white-space: nowrap; overflow: hidden; max-width: 0px; transition: max-width 200ms;"><span style="color: rgb(255, 255, 255); font-family: WistiaPlayerInter, Helvetica, sans-serif; font-size: 18px; font-weight: 500; padding-left: 1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 640px;">Click for sound</span></div><svg viewBox="0 0 237 237" width="52.5" height="52.5"><path fill="#fff" d="M88 107H65v24h24l23 23V84z"></path><g fill="none" stroke="#fff" stroke-linecap="round" stroke-width="10"><path d="M142 86c9 21 9 44 0 65" class="volume__small-wave"></path><path d="M165 74c13 23 13 66 0 89" class="volume__large-wave"></path></g></svg></button></div></div><div data-handle="playPauseNotifier" class="w-css-reset" style="pointer-events: auto;"></div><div data-handle="playPauseLoading" class="w-css-reset" style="pointer-events: auto;"><div class="w-css-reset w-css-reset-tree" style="height: 100%; left: 0px; pointer-events: none; position: absolute; top: 0px; width: 100%;"><button aria-label="Play Video" class="w-vulcan-v2-button" style="background: rgba(0, 0, 0, 0.6); border: 0px; border-radius: 50%; cursor: pointer; display: none; height: 140px; left: 50%; margin: 0px; padding: 0px; pointer-events: auto; position: absolute; opacity: 0; outline: none; top: 50%; transform: translate(-50%, -50%) scale(0.8); transition: opacity 200ms, transform 600ms; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); width: 140px;"><div style="width: 100%; height: 100%; margin-left: 0px;"><svg x="0px" y="0px" viewBox="0 0 40 34" enable-background="new 0 0 40 34" aria-hidden="true" style="fill: none; height: 100%; left: 0px; stroke-width: 0px; top: 0px; width: 100%; color: rgb(255, 255, 255);"><path d="M24.888 16.1913C25.4371 16.5906 25.4371 17.4094 24.888 17.8087L16.5882 23.845C15.9272 24.3257 15 23.8535 15 23.0362V10.9638C15 10.1465 15.9272 9.67433 16.5882 10.155L24.888 16.1913Z" fill="currentcolor"></path></svg></div></button></div></div><div data-handle="annotationOverlay" class="w-css-reset" style="pointer-events: auto;"><div><div style="position: absolute; display: flex; flex-direction: column; pointer-events: none; max-width: 50%; width: 100%; align-items: flex-start;"></div><div style="position: absolute; display: flex; flex-direction: column; pointer-events: none; max-width: 50%; width: 100%; right: 0px; align-items: flex-end;"></div></div></div></div></div><div class="w-vulcan-overlays--right w-css-reset" style="display: table-cell; height: auto; vertical-align: top; position: relative; width: 0px;"><div class="w-css-reset" style="height: 100%;"></div></div></div><div class="w-bottom-bar w-css-reset" style="bottom: 0px; border-radius: 0px; border-collapse: collapse; display: table; height: 34px; pointer-events: none; position: absolute; padding-left: 0px; padding-right: 0px; right: 50%; table-layout: auto; transform: translate(50%); width: calc(100% + 0px); z-index: 1;"><div class="w-bottom-bar-lower w-css-reset" style="position: relative;"><div style="height: 100%; left: 0px; position: absolute; top: 0px; width: 100%;"><div style="background: rgb(0, 106, 86); display: none; height: 100%; mix-blend-mode: darken; left: 0px; opacity: 1; position: absolute; top: 0px; transition: opacity; width: 100%;"></div><div style="background: rgba(0, 106, 86, 0.85); border-radius: 0px; height: 100%; opacity: 1; left: 0px; position: absolute; top: 0px; transition: opacity; width: 100%;"></div></div><div style="display: none;"><div style="background: rgb(0, 106, 86); display: none; height: 100%; mix-blend-mode: darken; left: 0px; opacity: 1; position: absolute; top: 0px; transition: opacity; width: 100%;"></div><div style="background: 100% rgba(0, 106, 86, 0.85); border-radius: 0px; height: 100%; opacity: 1; left: 0px; position: absolute; top: 0px; transition: opacity; width: 100%;"></div></div><div class="w-bottom-bar-left w-css-reset" style="display: table-cell; height: auto; vertical-align: top; position: relative; width: 0px; opacity: 1; transition: opacity;"><div class="w-bottom-bar-left-inner w-css-reset" style="height: 34px; position: relative; pointer-events: auto; white-space: nowrap;"><div data-handle="smallPlayButton" class="w-css-reset" style="display: inline-block; vertical-align: top;"><div class="w-vulcan-button-wrapper w-css-reset" style="display: inline-block; height: 34px; position: relative; vertical-align: top; width: 40px;"><button tabindex="0" class="w-vulcan-v2-button w-css-reset w-css-reset-tree w-css-reset-button-important" aria-label="Play Video" title="Play Video" style="background-color: transparent; border-radius: 0px; box-shadow: none; cursor: pointer; height: 100%; position: relative; transition: background-color 150ms; width: 100%; color: var(--wistia-player-icon-color) !important;"><div data-handle="smallPlayButton_icon_wrapper" class="w-vulcan-icon-wrapper" style="box-sizing: border-box; height: 100%; position: relative; opacity: 1; transform: scale(1.001); transition: transform 200ms;"><div style="width: 100%; height: 100%; margin-left: 1.5px;"><svg x="0px" y="0px" viewBox="0 0 40 34" enable-background="new 0 0 40 34" aria-hidden="true" style="fill: none; height: 100%; left: 0px; stroke-width: 0px; top: 0px; width: 100%; vertical-align: top;"><path d="M24.888 16.1913C25.4371 16.5906 25.4371 17.4094 24.888 17.8087L16.5882 23.845C15.9272 24.3257 15 23.8535 15 23.0362V10.9638C15 10.1465 15.9272 9.67433 16.5882 10.155L24.888 16.1913Z" fill="currentcolor"></path></svg></div></div></button></div></div></div></div><div class="w-bottom-bar-middle w-css-reset" style="display: table-cell; height: auto; vertical-align: top; position: relative; width: 100%; opacity: 1; transition: opacity;"><div class="w-bottom-bar-middle-inner w-css-reset" style="height: 34px; position: relative; pointer-events: auto; white-space: nowrap; opacity: 1; transform: translateY(0px); transition: opacity, transform;"><div data-handle="playbar" class="w-css-reset" style="height: 100%; position: relative;"><div class="w-playbar-wrapper w-css-reset w-css-reset-tree" style="display: flex; height: 100%; width: 100%;"><div class="w-playbar__time" style="box-sizing: content-box; color: rgb(255, 255, 255); font-family: WistiaPlayerInterNumbersSemiBold, Helvetica, sans-serif; font-size: 13px; letter-spacing: 0.5px; line-height: 34px; padding-left: 5px; pointer-events: none; position: relative; text-align: center; width: 28px;">3:24</div><div style="width: 100%; position: relative;"><div aria-label="Playbar" aria-orientation="horizontal" aria-valuemax="204.04" aria-valuemin="0" aria-valuenow="0" aria-valuetext="0 seconds" role="slider" tabindex="0" style="cursor: pointer; flex: 1 1 0%; height: 34px; outline: none; margin-left: 15px; margin-right: 10px; position: relative;"><canvas height="34" width="447" style="height: 34px; left: -15px; position: absolute; top: 0px; width: 447px;"></canvas><div style="border-radius: 50%; height: 11.2px; left: -5.6px; opacity: 0; position: absolute; top: 11.4px; width: 11.2px;"></div></div><div aria-label="Chapter Markers" role="toolbar" style="bottom: 0px; height: 34px; outline: none; padding-left: 15px; padding-right: 10px; pointer-events: none; position: absolute; width: 100%;"><div aria-label="Chapter Markers" aria-orientation="horizontal" role="toolbar" tabindex="0" class="w-playbar__chapter-markers w-css-reset w-css-reset-tree" style="box-shadow: none; height: 100%; left: 0px; pointer-events: none; position: absolute; top: 0px; width: 100%;"><div style="height: 100%; left: 0px; pointer-events: none; position: absolute; margin-left: 15px; margin-right: 10px; top: 0px; width: calc(100% - 25px);"><button aria-label="Install Requirements on Ubuntu 22.04" tabindex="-1" type="button" class="w-chapter-marker w-css-reset-button-important w-vulcan-v2-button" style="color: rgb(255, 255, 255); cursor: pointer; height: 100%; font-size: 11px; left: 6.3713%; line-height: 1em; opacity: 0; pointer-events: auto; position: absolute; text-align: center; top: 0px; transform: translateX(-50%); transition: opacity 170ms, transform 170ms; width: 16px;"><span style="background: rgb(255, 255, 255); border-radius: 50%; display: block; height: 5px; left: 50%; position: absolute; text-indent: -99999em; top: 50%; transform: translate(-50%, -50%); width: 5px;">●</span></button><button aria-label="Load Sleepmask Mutator script into the Script Manager" tabindex="-1" type="button" class="w-chapter-marker w-css-reset-button-important w-vulcan-v2-button" style="color: rgb(255, 255, 255); cursor: pointer; height: 100%; font-size: 11px; left: 18.6238%; line-height: 1em; opacity: 0; pointer-events: auto; position: absolute; text-align: center; top: 0px; transform: translateX(-50%); transition: opacity 170ms, transform 170ms; width: 16px;"><span style="background: rgb(255, 255, 255); border-radius: 50%; display: block; height: 5px; left: 50%; position: absolute; text-indent: -99999em; top: 50%; transform: translate(-50%, -50%); width: 5px;">●</span></button><button aria-label="Export a Beacon Payload" tabindex="-1" type="button" class="w-chapter-marker w-css-reset-button-important w-vulcan-v2-button" style="color: rgb(255, 255, 255); cursor: pointer; height: 100%; font-size: 11px; left: 30.8763%; line-height: 1em; opacity: 0; pointer-events: auto; position: absolute; text-align: center; top: 0px; transform: translateX(-50%); transition: opacity 170ms, transform 170ms; width: 16px;"><span style="background: rgb(255, 255, 255); border-radius: 50%; display: block; height: 5px; left: 50%; position: absolute; text-indent: -99999em; top: 50%; transform: translate(-50%, -50%); width: 5px;">●</span></button><button aria-label="Export a Mutated Beacon Payload" tabindex="-1" type="button" class="w-chapter-marker w-css-reset-button-important w-vulcan-v2-button" style="color: rgb(255, 255, 255); cursor: pointer; height: 100%; font-size: 11px; left: 60.7724%; line-height: 1em; opacity: 0; pointer-events: auto; position: absolute; text-align: center; top: 0px; transform: translateX(-50%); transition: opacity 170ms, transform 170ms; width: 16px;"><span style="background: rgb(255, 255, 255); border-radius: 50%; display: block; height: 5px; left: 50%; position: absolute; text-indent: -99999em; top: 50%; transform: translate(-50%, -50%); width: 5px;">●</span></button></div></div><div class="w-playbar__chapter-titles" style="height: 0px; left: 0px; pointer-events: none; position: absolute; top: 0px; width: 100%;"><div class="w-chapter-title" style="background: rgba(0, 0, 0, 0.55); bottom: 0px; box-sizing: border-box; color: rgb(255, 255, 255); display: none; font-family: WistiaPlayerInter, Helvetica, sans-serif; font-size: 14px; height: 24px; left: 39.5935px; line-height: 24px; padding: 0px 6px; position: absolute; text-align: center; transform: translateX(-50%); white-space: nowrap;">Install Requirements on Ubuntu 22.04</div><div class="w-chapter-title" style="background: rgba(0, 0, 0, 0.55); bottom: 0px; box-sizing: border-box; color: rgb(255, 255, 255); display: none; font-family: WistiaPlayerInter, Helvetica, sans-serif; font-size: 14px; height: 24px; left: 96.504px; line-height: 24px; padding: 0px 6px; position: absolute; text-align: center; transform: translateX(-50%); white-space: nowrap;">Load Sleepmask Mutator script into the Script Manager</div><div class="w-chapter-title" style="background: rgba(0, 0, 0, 0.55); bottom: 0px; box-sizing: border-box; color: rgb(255, 255, 255); display: none; font-family: WistiaPlayerInter, Helvetica, sans-serif; font-size: 14px; height: 24px; left: 153.415px; line-height: 24px; padding: 0px 6px; position: absolute; text-align: center; transform: translateX(-50%); white-space: nowrap;">Export a Beacon Payload</div><div class="w-chapter-title" style="background: rgba(0, 0, 0, 0.55); bottom: 0px; box-sizing: border-box; color: rgb(255, 255, 255); display: none; font-family: WistiaPlayerInter, Helvetica, sans-serif; font-size: 14px; height: 24px; left: 292.276px; line-height: 24px; padding: 0px 6px; position: absolute; text-align: center; transform: translateX(-50%); white-space: nowrap;">Export a Mutated Beacon Payload</div></div></div></div></div></div></div></div><div class="w-bottom-bar-right w-css-reset" style="display: table-cell; height: auto; vertical-align: top; position: relative; width: 0px; opacity: 1; transition: opacity; white-space: nowrap;"><div class="w-bottom-bar-right-inner-anchor w-css-reset" style="height: 34px; position: relative; pointer-events: auto; white-space: nowrap; display: inline-block; right: 0px; top: 0px; vertical-align: top;"><div class="w-bottom-bar-right-inner w-css-reset" style="height: 34px; position: relative; pointer-events: auto; white-space: nowrap; display: inline-block; opacity: 1; right: 0px; top: 0px; transform: translateY(0px); transition: opacity, transform;"><div data-handle="volumeButton" class="w-css-reset" style="display: inline-block; vertical-align: top;"><div class="w-vulcan-button-wrapper w-css-reset" style="display: inline-block; height: 34px; position: relative; vertical-align: top; width: 40px;"><button tabindex="0" aria-pressed="false" class="w-vulcan-v2-button w-css-reset w-css-reset-tree w-css-reset-button-important" aria-label="Mute" title="Mute" style="background-color: transparent; border-radius: 0px; box-shadow: none; cursor: pointer; height: 100%; position: relative; transition: background-color 150ms; width: 100%; color: var(--wistia-player-icon-color) !important;"><div data-handle="volumeButton_icon_wrapper" class="w-vulcan-icon-wrapper" style="box-sizing: border-box; height: 100%; position: relative; opacity: 1; transform: scale(1.001); transition: transform 200ms;"><svg x="0px" y="0px" viewBox="0 0 40 34" enable-background="new 0 0 40 34" aria-hidden="true" style="fill: none; height: 100%; left: 0px; stroke-width: 0px; top: 0px; width: 100%;"><g style="transform: translateX(1.25px); transition: transform 100ms;"><path d="M15.8 13.9995C15.3 14.4995 14.4 14.7995 13.8 14.7995H12.2C11.5 14.7995 11 15.2995 11 15.9995V17.5995C11 18.2995 11.5 18.7995 12.2 18.7995H13.8C14.5 18.7995 15.4 19.1995 15.8 19.5995L18.2 21.3999C18.5296 21.6472 19 21.412 19 20.9999V12.154C19 11.7163 18.4774 11.4899 18.1581 11.7892L15.8 13.9995Z" fill="currentcolor"></path><g stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.5C22 11.5 23.1 14 23.1 16.5C23.1 19 22 21.5 22 21.5" style="opacity: 1; transition: opacity 100ms;"></path><path d="M26 9C26 9 27.7 12.8 27.7 16.5C27.7 20.2 26 24 26 24" style="opacity: 1; transition: opacity 100ms;"></path><g style="opacity: 0; transition: opacity 100ms;"><path d="M22 14L27 19"></path><path d="M27 14L22 19"></path></g></g></g></svg></div></button></div></div><div data-handle="settingsButton" class="w-css-reset" style="display: inline-block; vertical-align: top;"><div class="w-vulcan-button-wrapper w-css-reset" style="display: inline-block; height: 34px; position: relative; vertical-align: top; width: 40px;"><button tabindex="0" aria-expanded="false" class="w-vulcan-v2-button w-css-reset w-css-reset-tree w-css-reset-button-important" aria-label="Show settings menu" title="Show settings menu" style="background-color: transparent; border-radius: 0px; box-shadow: none; cursor: pointer; height: 100%; position: relative; transition: background-color 150ms; width: 100%; color: var(--wistia-player-icon-color) !important;"><div data-handle="settingsButton_icon_wrapper" class="w-vulcan-icon-wrapper" style="box-sizing: border-box; height: 100%; position: relative; opacity: 1; transform: scale(1.001); transition: transform 200ms;"><svg x="0px" y="0px" viewBox="0 0 40 34" enable-background="new 0 0 40 34" aria-hidden="true" style="fill: none; height: 100%; left: 0px; stroke-width: 0px; top: 0px; width: 100%;"><path fill-rule="evenodd" clip-rule="evenodd" d="M26.4 15.4H28.3C28.7 15.4 29 15.7 29 16.1V16.7C29 17.1 28.7 17.4 28.3 17.4H26.4C26 17.4 25.6 17.7 25.5 18.1L25.1 19.2C25 19.5 25 20 25.3 20.3L26.6 21.6C26.9 21.9 26.9 22.3 26.6 22.6L26.2 23C25.9 23.3 25.5 23.3 25.2 23L23.9 21.7C23.6 21.5 23.1 21.4 22.8 21.6L21.7 22.1C21.3 22.2 21 22.6 21 23V24.7C21 25.1 20.7 25.4 20.3 25.4H19.7C19.3 25.4 19 25.1 19 24.7V23C19 22.6 18.7 22.2 18.3 22.1L17.1 21.6C16.8 21.5 16.3 21.5 16 21.8L14.8 23C14.5 23.3 14.1 23.3 13.8 23L13.4 22.6C13.1 22.3 13.1 21.9 13.4 21.6L14.6 20.4C14.8 20.1 14.9 19.6 14.7 19.3L14.2 18.1C14.1 17.7 13.7 17.4 13.3 17.4H11.7C11.3 17.4 11 17.1 11 16.7V16.1C11 15.7 11.3 15.4 11.7 15.4H13.3C13.7 15.4 14.1 15.1 14.2 14.7L14.7 13.5C14.9 13.2 14.9 12.7 14.6 12.4L13.4 11.2C13.1 10.9 13.1 10.5 13.4 10.2L13.8 9.8C14.1 9.5 14.5 9.5 14.8 9.8L16 11C16.3 11.3 16.8 11.4 17.1 11.2L18.3 10.7C18.7 10.6 19 10.2 19 9.8V8.1C19 7.7 19.3 7.4 19.7 7.4H20.3C20.7 7.4 21 7.7 21 8.1V9.8C21 10.2 21.3 10.6 21.7 10.7L22.8 11.2C23.1 11.4 23.6 11.4 23.9 11.1L25.2 9.8C25.5 9.5 25.9 9.5 26.2 9.8L26.6 10.2C26.9 10.5 26.9 10.9 26.6 11.2L25.3 12.5C25 12.8 24.9 13.3 25.1 13.6L25.5 14.7C25.6 15.1 26 15.4 26.4 15.4ZM19.9 20.4C22 20.4 23.8 18.7 23.8 16.5C23.8 14.3 22.1 12.6 19.9 12.6C17.7 12.6 16 14.4 16 16.5C16 18.6 17.7 20.4 19.9 20.4Z" fill="currentcolor"></path></svg></div></button></div></div><div data-handle="chapters" class="w-css-reset" style="display: inline-block; vertical-align: top;"><div class="w-vulcan-button-wrapper w-css-reset" style="display: inline-block; height: 34px; position: relative; vertical-align: top; width: 40px;"><button tabindex="0" aria-expanded="false" class="w-vulcan-v2-button w-css-reset w-css-reset-tree w-css-reset-button-important" aria-label="Open chapters" title="Open chapters" style="background-color: transparent; border-radius: 0px; box-shadow: none; cursor: pointer; height: 100%; position: relative; transition: background-color 150ms; width: 100%; color: var(--wistia-player-icon-color) !important;"><div data-handle="chapters_icon_wrapper" class="w-vulcan-icon-wrapper" style="box-sizing: border-box; height: 100%; position: relative; opacity: 1; transform: scale(1.001); transition: transform 200ms;"><div style="height: 100%;"><svg x="0px" y="0px" viewBox="0 0 40 34" enable-background="new 0 0 40 34" aria-hidden="true" style="fill: rgb(255, 255, 255); height: 100%; left: 0px; stroke-width: 0px; top: 0px; width: 100%;"><circle cx="11.5" cy="11" r="1.5" fill="currentcolor"></circle><circle cx="11.5" cy="17" r="1.5" fill="currentcolor"></circle><circle cx="11.5" cy="23" r="1.5" fill="currentcolor"></circle><g stroke="currentcolor" stroke-width="2" stroke-linecap="round"><path d="M17 11H29"></path><path d="M17 17H29"></path><path d="M17 23H29"></path></g></svg> </div></div></button></div></div></div></div><div class="w-wistia-logo w-css-reset" style="height: 34px; position: relative; pointer-events: auto; white-space: nowrap; display: none; right: 0px; top: 0px;"></div><div class="w-ellipsis w-css-reset" style="height: 34px; position: relative; pointer-events: auto; white-space: nowrap; display: none;"></div></div></div></div><div class="w-foreground w-css-reset" style="height: 100%; left: 0px; pointer-events: none; position: absolute; top: 0px; width: 100%; z-index: 1;"><div data-handle="contextMenu" class="w-css-reset" style="pointer-events: auto;"></div><div data-handle="loadingHourglass" class="w-css-reset" style="pointer-events: auto;"></div><div data-handle="focusOutline" class="w-css-reset" style="pointer-events: auto;"><div class="w-focus-outline" style="box-shadow: rgb(255, 255, 255) 0px 0px 0px 2px inset; border-radius: 0px; display: none; height: 100%; left: 0px; pointer-events: none; position: absolute; right: 0px; width: 100%;"></div></div><div data-handle="modalOverlay" class="w-css-reset" style="pointer-events: auto;"></div></div></div></div></div><div id="wistia_grid_72_front"></div><div id="wistia_grid_72_top_inside"><div id="wistia_grid_72_top"></div></div><div id="wistia_grid_72_bottom_inside"><div id="wistia_grid_72_bottom"></div></div><div id="wistia_grid_72_left_inside"><div id="wistia_grid_72_left"></div></div><div id="wistia_grid_72_right_inside"><div id="wistia_grid_72_right"></div></div></div><div id="wistia_grid_72_below"></div></div></div></div>




</div>
</div><figcaption class="wp-element-caption"><em>This short video provides a high level overview on how to install and use the Cobalt Strike Mutator Kit, which uses an LLVM obfuscator to break in-memory YARA scanning of the sleep mask.</em></figcaption></figure>



<h2 class="wp-block-heading">Mutator Kit</h2>



<p>Typically, given the same source code, compilers will generate the same machine code (I.e. they can be considered, with some caveats, deterministic). As an example, we can build the sleep mask with MinGW and compare the .text sections between different builds. Closer analysis reveals the .text sections are the same:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_614699" class="syntaxhighlighter nogutter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_614699_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_614699" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines no-wrap"><div class="line alt1"><table><tbody><tr><td class="content"><code class="comments">// [1] Build the sleepmask.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">$ ./build.sh 49 WaitForSingleObject </code><code class="keyword bold">true</code> <code class="plain">none /tmp/dist </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">[ ... ] </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">[Sleepmask kit] [*] Compile sleepmask.x64.o </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">[ ... ]</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="comments">// [2] Use objdump to find the text section size.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">$ objdump -h sleepmask.x64.o </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="spaces">&nbsp;</code><code class="plain">sleepmask.x64.o:&nbsp;&nbsp;&nbsp;&nbsp; file format pe-x86-64 </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">Sections:</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">Idx Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VMA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LMA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; File off&nbsp; Algn</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="spaces">&nbsp;&nbsp;</code><code class="plain">0 .text&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00000200&nbsp; 0000000000000000&nbsp; 0000000000000000&nbsp; 00000104&nbsp; 2**4</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="comments">// [3] Extract the .text section.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="comments">// NB skip is the offset('File off') of the .text section </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="comments">// from objdmp and count is the size of the section </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="comments">// e.g. python -c 'print(int("104", 16))' == 260.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">$ dd </code><code class="keyword bold">if</code><code class="plain">=sleepmask.x64.o of=sleepmask1.bin skip=260 count=512 bs=1 </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="comments">// [4] Calculate shasum.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">$ shasum sleepmask1.bin </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">4f7813a6aae018a4cf6a78040d9c20024b5a83da&nbsp; sleepmask1.bin </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="comments">// [5] Repeat the steps again to build another sleep </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="comments">// mask and extract/hash the .text section - the hash is identical!</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">$ shasum sleepmask2.bin </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">4f7813a6aae018a4cf6a78040d9c20024b5a83da&nbsp; sleepmask2.bin </code></td></tr></tbody></table></div></div></div></div>


<p>This is clearly a problem when attempting to hide from YARA signatures which look for specific op code patterns. An example of this can be found in the <a href="https://github.com/elastic/protections-artifacts/blob/main/yara/rules/Windows_Trojan_CobaltStrike.yar#L849" target="_blank" rel="noreferrer noopener">following YARA signature</a>, which looks for the following op code pattern in the default sleep mask (<code>0x4C 0x8B 0x53 0x08</code> etc.):</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_826252" class="syntaxhighlighter nogutter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_826252_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_826252" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">mov r10, [rbx+0x08]&nbsp; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">mov r9d, [r10]&nbsp; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">mov r11d, [r10+0x04]&nbsp; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">lea r10, [r10+0x08]&nbsp; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">test r9d, r9d&nbsp; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">jnz 0x0000000000000007&nbsp; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">test r11d, r11d&nbsp; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">jz 0x0000000000000035&nbsp; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">cmp r9d, r11d&nbsp; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">jnb 0xFFFFFFFFFFFFFFE8&nbsp; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">mov rdi, r9&nbsp; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">mov r8, [rbx]</code></td></tr></tbody></table></div></div></div></div>


<p>As the sleep mask is visible in memory when Beacon is sleeping, this can be a <a href="https://github.com/elastic/protections-artifacts/blob/main/yara/rules/Windows_Trojan_CobaltStrike.yar#L865" target="_blank" rel="noreferrer noopener">trivial detection opportunity</a>, as demonstrated below:</p>



<figure class="wp-block-image aligncenter size-large is-resized"><img fetchpriority="high" decoding="async" width="1024" height="217" src="https://www.cobaltstrike.com/app/uploads/2024/01/defaultsleepmaskyarahit-1024x217.png" alt="" class="wp-image-5655" style="width:1086px;height:auto"><figcaption class="wp-element-caption">Fig 1. The results of scanning Elastic’s Cobalt Strike YARA rules against a process running Beacon with the default sleep mask enabled. The single hit is for the rule <code>Windows_Trojan_CobaltStrike_b54b94ac</code>, which as explained above, looks for code belonging to the default sleep mask.</figcaption></figure>



<p>Ideally, we would like to compile the sleep mask and get a unique build each time, in order to make it impossible to produce high fidelity YARA signatures at scale. A common technique for mutating code is using <a href="https://llvm.org/docs/tutorial/" target="_blank" rel="noreferrer noopener">LLVM</a>, of which there are numerous well documented open-source projects (for example, see <a href="https://0xpat.github.io/Malware_development_part_6/" target="_blank" rel="noreferrer noopener">0xpat’s blog</a>). &nbsp;Typically, these make use of LLVM Intermediate Representation (IR) code to apply a number of transformation passes to produce obfuscated / mutated machine code.&nbsp;<br>&nbsp;<br><a href="https://github.com/Cobalt-Strike/obfuscator-llvm" target="_blank" rel="noreferrer noopener">Our mutator kit</a> adopts a similar approach and contains four obfuscation passes which are based on eShard’s <a href="https://github.com/eshard/obfuscator-llvm" target="_blank" rel="noreferrer noopener">obfuscator-llvm plugin</a>. &nbsp;This in turn is based on mutations introduced in the <a href="https://crypto.junod.info/spro15.pdf" target="_blank" rel="noreferrer noopener">research by Pascal J., et al</a>. &nbsp;These passes include:&nbsp;</p>



<ul class="wp-block-list">
<li><strong>Substitution-</strong> Replace binary operators with functionally equivalent ones&nbsp;</li>



<li><strong>Bogus-</strong> Insert fake control flow blocks&nbsp;</li>



<li><strong>Code</strong> <strong>Flattening-</strong> Aims to break higher level code/control flow structure</li>



<li><strong>Basic-block Splitting-</strong> Aims to break higher level code/control flow structure&nbsp;</li>
</ul>



<p>More information on these can be found in the research paper referenced above. Note that we are not overly concerned with making the sleep mask hard to reverse engineer; we are primarily interested in breaking static signatures. Hence, we will not go into any more detail into creating obfuscation passes for LLVM. However, the mutator kit <code>README.md</code> contains a number of references should you wish to fork <a href="https://github.com/Cobalt-Strike/obfuscator-llvm" target="_blank" rel="noreferrer noopener">our obfuscator-llvm repo</a> and create your own passes.&nbsp;</p>



<h2 class="wp-block-heading">Usage</h2>



<p>We have provided two methods to install the mutator kit: </p>



<ol class="wp-block-list">
<li>Installing the requirements directly (referred to  as ‘native’)</li>



<li>Docker</li>
</ol>



<p>As LLVM plugins require a specific LLVM version and environment, docker makes it easy to handle the required setup and obfuscation plugin compilation. However, if you do not wish to use docker, scripts are provided to bootstrap this process for you (I.e. method 1/native). Additionally, both docker and LLVM can be complicated to use on Windows, so the native method has the advantage of being simple to run on Windows via the Windows Subsystem for Linux (WSL). This blog will assume installation via the native method but see the <code>README.md</code> in the mutator kit repo for more guidance on using the provided docker container.&nbsp;</p>



<p>After installing the requirements, the primary workflow is to load the <code>sleepmask_mutator.cna</code> script into Cobalt Strike. This will automatically apply a mutated sleep mask to your exported Beacon payloads (see the <code>Cobalt Strike Client</code> section below). This script abstracts away the low level details of the mutator kit and makes it very easy to get up and running. However, in order to demonstrate some of the functionality of the mutator kit we will use the command line in this section.<br><br>The mutator kit can be manually invoked from the command line via the <code>mutator.sh</code> script. The script takes the following arguments:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_435639" class="syntaxhighlighter nogutter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_435639_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_435639" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">mutator.sh &lt;target architecture&gt; &lt;clang args&gt;</code></td></tr></tbody></table></div></div></div></div>


<p>To demonstrate the obfuscation passes in action we can take the following simple C program (<code>example.c</code>):</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_311664" class="syntaxhighlighter nogutter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_311664_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_311664" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="content"><code class="keyword bold">void</code> <code class="plain">go() { </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">int</code> <code class="plain">a = 5; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">int</code> <code class="plain">b = a + 6; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">}</code></td></tr></tbody></table></div></div></div></div>


<p>We can compile this with only the substitution pass enabled with the following command:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_424661" class="syntaxhighlighter nogutter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_424661_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_424661" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">$ OBFUSCATIONS=substitution mutator.sh x64 –c example.c -o example.o</code></td></tr></tbody></table></div></div></div></div>


<p>One helpful way of demonstrating the effect of specific obfuscation passes is by generating LLVM IR code and comparing it to the original (unmutated) code. This is demonstrated in the example below:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_139993" class="syntaxhighlighter nogutter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_139993_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_139993" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="content"><code class="comments">// Build example.c with only the substitution pass enabled </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">$ OBFUSCATIONS=substitution mutator.sh x64 -emit-llvm -S example.c -o example_with_substitutions.ll </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="comments">// Compare the original LLVM IR code with the mutated version </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">$ diff --color example.ll example_with_substitutions.ll&nbsp; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">12,13c12,16 </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="comments">// example.ll </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">&lt;&nbsp;&nbsp; %4 = add nsw i32 %3, 6 </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">&lt;&nbsp;&nbsp; store i32 %4, i32* %2, align 4 </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="comments">// example_with_substitutions.ll </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">&gt;&nbsp;&nbsp; %4 = sub i32 %3, 1041996456 </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">&gt;&nbsp;&nbsp; %5 = add i32 %4, 6 </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">&gt;&nbsp;&nbsp; %6 = add i32 %5, 1041996456 </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="content"><code class="plain">&gt;&nbsp;&nbsp; %7 = add nsw i32 %3, 6 </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="content"><code class="plain">&gt;&nbsp;&nbsp; store i32 %6, i32* %2, align 4 </code></td></tr></tbody></table></div></div></div></div>


<p>This trivial example demonstrates the impact of only including the substitution pass on the generated code.&nbsp;<br>&nbsp;<br>More <a href="https://mapping-high-level-constructs-to-llvm-ir.readthedocs.io/en/latest/a-quick-primer/index.html" target="_blank" rel="noreferrer noopener">detailed documentation on LLVM IR</a> is available, but with a basic understanding this can help debug any problems and to sanity check that specific obfuscation passes have been applied correctly. This makes for a quicker feedback loop, rather than opening the generated object file in IDA.</p>



<p>Having demonstrated the basic usage of the mutator kit, we can now apply it to the sleep mask with the following command:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_492331" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_492331_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_492331" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">$ mutator.sh x64 -c -DIMPL_CHKSTK_MS=1 -DMASK_TEXT_SECTION=1 -o sleepmask.x64.o src49/sleepmask.c </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="plain">Obfuscation flattening enabled </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="plain">Obfuscation substitution enabled </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="plain">Obfuscation split-basic-blocks enabled </code></td></tr></tbody></table></div></div></div></div>


<p>Note that the <code>-D*</code> arguments are used to add an implicit <code>#define</code> to the sleep mask which are consistent with the options provided in the <code>build.sh</code> script within the sleep mask kit. For more information on clang command line arguments see the <a href="https://clang.llvm.org/docs/ClangCommandLineReference.html" target="_blank" rel="noreferrer noopener">Clang documentation</a>. Additionally, the <code>–DIMPL_CHKSTK_MS=1</code> flag is needed to avoid any issues when loading the sleep mask into Cobalt Strike.&nbsp;</p>



<p>By default, only three passes are applied (flattening, substitution, and split-basic-blocks) as bogus can increase the code size. However, you can override the default behaviour by passing in the <code>OBFUSCATIONS</code> environment variable (<code>OBFUSCATIONS=flattening,substitution,split-basic-blocks,bogus mutator.sh x64..</code> etc.). See the <code>README.md</code> included in the mutator kit for more guidance.&nbsp;</p>



<p>At this stage, we can compare the default sleep mask to an LLVM mutated sleep mask. The screenshot below shows the call graph for the <em>same</em> function in the default sleep mask (left) and a mutated one (right):&nbsp;</p>



<figure class="wp-block-image aligncenter size-large is-resized"><img decoding="async" width="812" height="1024" src="https://www.cobaltstrike.com/app/uploads/2024/01/functioncallgraphcomparison-812x1024.png" alt="Fig 2. A comparison of the same function for the default sleep mask (left) and a LLVM mutated sleep mask (right). " class="wp-image-5656" style="aspect-ratio:0.7927519818799547;width:560px;height:auto"><figcaption class="wp-element-caption">Fig 2. A comparison of the <em>same</em> function for the default sleep mask (left) and a LLVM mutated sleep mask (right).&nbsp;</figcaption></figure>



<h2 class="wp-block-heading">Cobalt Strike Client</h2>



<p>The example above has demonstrated basic use of the mutator kit and the impact it has on compiled code. However, to make experimenting with the mutator kit and sleep mask as simple as possible we have included a cna script (<code>sleepmask_mutator.cna</code>) which adds a menu item allowing you to configure the mutator kit through the Cobalt Strike client. This option is demonstrated in the screenshot below:</p>



<figure class="wp-block-image aligncenter size-full"><img loading="lazy" decoding="async" width="552" height="470" src="https://www.cobaltstrike.com/app/uploads/2024/01/sleepmask_mutator_ui.png" alt="" class="wp-image-5675"><figcaption class="wp-element-caption">Fig 3. Screenshot showing the use of the <code>sleepmask_mutator.cna</code> script. This allows you to configure the sleep mask and desired obfuscation passes from the Cobalt Strike GUI.&nbsp;</figcaption></figure>



<p>This menu allows you to:&nbsp;</p>



<ul class="wp-block-list">
<li>Select what obfuscation passes to apply&nbsp;</li>



<li>Select whether you want to rebuild the sleep mask for <em>every</em> payload export</li>
</ul>



<p>The script will then automatically apply a mutated sleep mask based on these options to your exported Beacon payloads. Therefore, if desired, it is possible to ensure that every time you export a payload, a different LLVM mutated sleep mask will automatically be applied. The script will also ensure that an error is thrown if any problems are encountered to guarantee a default sleep mask is not accidentally applied (and which could subsequently endanger OPSEC).&nbsp;</p>



<p>The output of the <code>sleepmask_mutator.cna</code> script can be seen in the screenshot of the Script Console below when generating a raw HTTP Beacon DLL:&nbsp;</p>



<figure class="wp-block-image aligncenter size-large is-resized"><img loading="lazy" decoding="async" width="1024" height="409" src="https://www.cobaltstrike.com/app/uploads/2024/01/mutator_plugin_export-1024x409.png" alt="" class="wp-image-5659" style="width:1072px;height:auto"><figcaption class="wp-element-caption">Fig 4: The Script Console showing the <code>sleepmask_mutator.cna</code> script in action. As part of payload generation, a new LLVM mutated sleep mask is built and automatically applied to a raw Beacon DLL.</figcaption></figure>



<p>With our mutated sleep mask, we can re-run the YARA scan against a process hosting beacon and reveal that no hits are found:</p>



<figure class="wp-block-image aligncenter size-large is-resized"><img loading="lazy" decoding="async" width="1024" height="222" src="https://www.cobaltstrike.com/app/uploads/2024/01/yara_after_llvm-1024x222.png" alt="" class="wp-image-5660" style="width:1138px;height:auto"><figcaption class="wp-element-caption">Fig 5:&nbsp; The results of scanning Elastic’s Cobalt Strike YARA rules against a process running Beacon with a LLVM mutated sleep mask. As we have mutated the sleep mask there are now no YARA hits for the sleep mask when Beacon is sleeping.</figcaption></figure>



<p>We can also use the mutator kit to compile other BOFs. You may want to consider doing this for a higher level of OPSEC. As a note, most open source BOFs are intended to be compiled with MinGW. Hence, when compiling BOFs with the mutator kit it is highly likely you will encounter compiler issues which you will need to resolve on your own.</p>



<h2 class="wp-block-heading">Conclusion</h2>



<p>This blog has introduced the mutator kit which is available in the Arsenal Kit now. This kit is designed with the intention of making the creation of high fidelity YARA signatures targeting the sleep mask in-memory impracticable. With this release you can now generate mutated sleep masks on every payload export, which will fundamentally break pre-canned YARA signatures and provide enhanced OPSEC against in-memory signatures.&nbsp;</p>

</div><!-- .entry-content -->

<!-- .entry-footer -->

</article><!-- #post-5642 -->


				</main>
			</div> <!-- #primary -->
			
<div class="col-lg-4 align-self-start resource-sidebar widget-area"><!-- #resource-sidebar -->
        <div class="sidebar-content bg-7 mb-3">
        <div class=" container">
            <div class="row">
                <div class="col-12">
                                    <div class="author-description p-3 row">
                                                <div class="author-image col-5">
                             <img width="231" height="231" src="https://www.cobaltstrike.com/app/uploads/2023/07/William-Burgess.png" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="" decoding="async" loading="lazy">                        </div>
                                                <div class=" col-7 pl-0">
                            <h4 class="author-title text-align-left font-weight-light">
                                <a href="https://www.cobaltstrike.com/profile/william-burgess">William Burgess</a>
                            </h4>
                            <div>Principal Research Lead</div>
                        </div>
                        <div class="col-12 text-center mt-2">
                            <a class=" btn-link view-profile" href="https://www.cobaltstrike.com/profile/william-burgess">View Profile</a>
                        </div>
                    </div>
                                </div>  <!-- #column -->
            </div> <!-- #row -->
        </div> <!-- #container -->
    </div>  <!-- #sidebar-content -->
            <div class="sidebar-content bg-7 mb-3">
        <div class=" container">
            <div class="row">
                <div class="col-12">
                                                                <div class="sidebar-content p-3">
                            <div class="block-title text-uppercase">
                            TOPICS
                            </div>
                            <ul class="list-group list-group-flush pt-2">
                            <li class="list-unstyled"><a href="https://www.cobaltstrike.com/blog?_sft_cornerstone=development" title="Development">Development</a></li><li class="list-unstyled"><a href="https://www.cobaltstrike.com/blog?_sft_cornerstone=red-team" title="Red Team">Red Team</a></li>                            </ul>
                        </div>
                                    </div>  <!-- #column -->
            </div> <!-- #row -->
        </div> <!-- #container -->
    </div>  <!-- #sidebar-content -->
    </div><!-- #resource-sidebar -->
		</div><!-- .row -->
	</div><!-- #container -->
</div><!-- #page-wrapper -->



</div>



<div class="wpc-filters-overlay"></div>









<div height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" data-original-tag="iframe"></div>
<div class="ta-display-none" name="trustarc_notice" id="trustarcNoticeFrame" title="Trustarc Cross-Domain Consent Frame" src="https://consent.trustarc.com/get?name=crossdomain.html&amp;domain=helpsystems.com" data-original-tag="iframe"></div></body></html>