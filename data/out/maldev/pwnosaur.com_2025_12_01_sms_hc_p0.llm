Title:
The hacker is in the details (Segmentation, FS/GS, Flat Memory Model, Heaven’s Gate) — SMS Hacker’s Corner Part 0

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains why x86 segmentation details still matter for exploitation and malware research even under the “flat” memory model.  
- It focuses on the special role of FS/GS segment registers as per-thread anchors (TEB/TLS) and how attackers use them for PEB-walking to resolve module bases/APIs without noisy imports or GetProcAddress usage.  
- It contrasts historical segmentation-based execute/data separation with how the flat model’s overlapping CS/SS ranges enabled classic stack execution (pre-NX), effectively weakening hardware-enforced boundaries.  
- It then covers “Heaven’s Gate” on WoW64: switching code segments via the descriptor L-bit to transition between 32-bit compatibility mode and 64-bit execution.  
- The technique is framed as useful for evading or bypassing user-mode hooks/telemetry that only monitor one bitness, and for confusing debuggers and tooling.  
- Overall, it’s a segmentation-centric view of real-world offensive tradecraft and OS design tradeoffs relevant to Windows internals and EDR bypass research.

Technical Focus:
- FS/GS usage (TEB/TLS) and thread-local addressing
- PEB walk / PEB_LDR_DATA module enumeration for API resolution
- Segment descriptors (TYPE field) and code vs data execution rules
- Flat memory model implications (CS/SS overlap) and pre-NX stack execution
- WoW64 internals and Heaven’s Gate (L-bit, 0x23/0x33 selectors)
- User-mode hooking limitations across 32-bit vs 64-bit transitions

Use Cases:
- Writing position-independent shellcode that resolves APIs via PEB walking
- Malware tradecraft to reduce static imports and avoid GetProcAddress
- Understanding legacy segmentation effects when debugging exploits
- WoW64 “Heaven’s Gate” transitions to bypass/evade user-mode hooks
- Building/assessing EDR detections for cross-bitness syscall/API execution paths

Keywords:
x86 segmentation, FS, GS, TEB, PEB, PEB_LDR_DATA, TLS, ASLR, position-independent code, shellcode, NX-bit, segment descriptor, TYPE field, CS, SS, general protection fault, flat memory model, WoW64, compatibility mode, Heaven’s Gate, NTDLL, user-mode hooks, EDR bypass, 0x23, 0x33, L-bit, IA-32e long mode