Title:
Memory Hiding Technique Series: Gargoyle

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains the “Gargoyle” memory-hiding technique used to evade memory scanners that flag suspicious RWX private (non-file-backed) regions commonly created by reflective loaders and in-memory beacons.  
- It focuses on defeating heuristic detection based on allocation permissions by repeatedly flipping a payload’s pages between executable and non-executable states (e.g., PAGE_EXECUTE_READ during execution, PAGE_READONLY while idle).  
- The core mechanism uses Windows APC delivery via waitable timers to run a callback that changes page protections without crashing the currently executing code.  
- A key implementation detail is abusing SetWaitableTimer’s APC completion routine pointer as a ROP gadget entry, combined with a crafted “stack trampoline” to call VirtualProtectEx and then tail-call back into position-independent shellcode.  
- The article breaks down the required configuration/workspace structures and the x86 assembly control flow that loops: wake → make executable → run payload → revert protections → return to alertable wait.  
- It’s most useful for red teamers and malware developers studying sleep obfuscation / in-memory evasion, and for defenders wanting to understand how permission-flipping can reduce RWX exposure windows.

Technical Focus:
- Windows APCs and alertable waits (WaitForSingleObjectEx, SleepEx)
- Waitable timers and APC completion routines (CreateWaitableTimer, SetWaitableTimer)
- Memory protection flipping (VirtualProtectEx, PAGE_READONLY vs PAGE_EXECUTE_READ)
- ROP gadget abuse and stack pivoting (POP ESP; RET)
- Position-independent code (PIC) shellcode workspace/config design
- Memory scanner heuristics (RWX private “floating code” detection)

Use Cases:
- Implementing sleep/permission obfuscation for in-memory implants to reduce RWX dwell time
- Researching APC-based execution flows and timer-driven staging loops
- Building detections for rapid/periodic VirtualProtect(Ex) transitions around suspicious regions
- Reverse engineering and emulating Gargoyle-style ROP + trampoline control flow in sandboxes
- Training/red team labs demonstrating why RWX-private heuristics can be bypassed

Keywords:
Gargoyle, sleep obfuscation, memory hiding, reflective loading, in-memory beacon, RWX private memory, floating code, APC, Asynchronous Procedure Call, alertable state, CreateWaitableTimer, SetWaitableTimer, WaitForSingleObjectEx, QueueUserAPC, VirtualProtectEx, PAGE_READONLY, PAGE_EXECUTE_READ, ROP gadget, stack pivot, mshtml.dll, x86 shellcode, PIC, Moneta, PE-sieve, module stomping