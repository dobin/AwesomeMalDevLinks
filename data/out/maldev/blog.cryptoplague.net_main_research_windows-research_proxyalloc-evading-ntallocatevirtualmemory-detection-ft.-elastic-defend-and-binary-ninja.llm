Title:
ProxyAlloc: Evading NtAllocateVirtualMemory Detection (Elastic Defend) with Signed DLL Wrappers

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes a userland evasion technique for in-process shellcode execution when EDR (specifically Elastic Defend in aggressive mode) monitors direct `NtAllocateVirtualMemory`/`NtProtectVirtualMemory` usage.  
- The author observes detections triggered by suspicious memory allocation/protection patterns and focuses on the call stack attribution (unsigned module calling into `ntdll`).  
- The core idea (“ProxyAlloc”) is to route allocations through internal wrapper functions inside Microsoft-signed DLLs (e.g., `verifier.dll`) that themselves call `NtAllocateVirtualMemory`, inserting a signed module into the call chain.  
- To find suitable wrappers at scale, the author uses Binary Ninja’s Python API to scan signed `System32` DLLs for imports and call sites where `Protect` and `RegionSize` are controllable (and optionally where RWX and >64KB allocations occur).  
- A PoC shows calling an internal function by module base + offset (with a note that pattern scanning would be more robust than fixed offsets).  
- In testing with a loader and a modified Havoc Demon shellcode workflow, Elastic Defend reportedly produced no alerts, highlighting how call-stack-based heuristics can be bypassed by “proxying” through signed code.

Technical Focus:
- Userland memory allocation for shellcode (`NtAllocateVirtualMemory`, `NtProtectVirtualMemory`, `RtlMoveMemory`)
- Call-stack / module-trust-based EDR heuristics and evasion
- Leveraging Microsoft-signed DLL internal (non-exported) wrapper functions
- Static analysis automation with Binary Ninja HLIL and Python
- Offset-based internal function invocation and robustness considerations (pattern scanning)

Use Cases:
- Bypassing usermode EDR detections tied to direct syscalls/NTAPI allocation patterns
- Building stealthier in-process shellcode loaders for red team tradecraft validation
- Hunting for “proxy” API wrappers inside signed Windows components
- Evaluating and improving defensive detections beyond simple call-stack trust assumptions

Keywords:
Elastic Defend, EDR evasion, NtAllocateVirtualMemory, NtProtectVirtualMemory, ZwAllocateVirtualMemory, VirtualAlloc, verifier.dll, AVrfpNtAllocateVirtualMemory, Microsoft-signed DLL, call stack spoofing, userland hooking, shellcode loader, RWX memory, MEM_COMMIT, MEM_RESERVE, Binary Ninja, HLIL, static analysis automation, Havoc C2, Demon agent