# https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/

<!DOCTYPE html><html lang="en" data-mode="dark"><body><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Advanced Evasion in Rust‑Based ArtifactKit: Techniques, CobaltStrike Integration, and Defensive Analysis</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h1 id="advanced-evasion-in-rustbased-artifactkit-techniques-cobaltstrike-integration-and-defensive-analysis">Advanced Evasion in Rust‑Based ArtifactKit: Techniques, CobaltStrike Integration, and Defensive Analysis</h1><blockquote><p><strong>Authorship &amp; implementation</strong>: This research and the accompanying template were engineered in <strong>Rust</strong> by our team to study how modern, memory‑safe systems languages change the detection surface of artifact loaders. We focus on design patterns, diagrams, and defender‑oriented heuristics—not operational code—to help blue teams anticipate and counter emerging techniques.</p></blockquote><blockquote><p><strong>Ethical scope</strong>: This article is written for blue teams, incident responders, and security researchers. It explains evasion tradecraft at a <strong>conceptual</strong> level to strengthen defenses. All code fragments are <strong>non‑executable pseudocode</strong>; there are no operational instructions or runnable artifacts.</p><p><strong>Source code of the ArtifactKit</strong>: You can find the src code of our project on our GitHub <a href="https://github.com/SilentStrikeLab/Rust-Cobalt-Strike-Artifact-Kit/">Check Here</a>.</p></blockquote><h2 id="abstract"><span class="me-2">Abstract</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#abstract" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We analyze a Rust‑based artifact loader architecture designed to reduce classic detection signals such as import tables, RWX permission flips, and thread‑creation artifacts. The design combines compile‑time API hashing, PEB‑based dynamic resolution, section‑object dual mapping (separate READWRITE and EXECUTE_READ views), and fiber‑based execution. We detail how a CNA/Aggressor script integrates with a Rust template through a strict marker‑and‑container contract, then provide hunting heuristics, ATT&amp;CK mappings, a validation protocol, and measurement guidance for defenders.</p><hr><h2 id="executive-summary"><span class="me-2">Executive Summary</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#executive-summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><strong>Objective</strong>: Minimize static imports, avoid RWX transitions, and replace thread creation with fibers to alter behavioral signatures.</li><li><strong>Techniques</strong>: API hashing + PEB walk; dual‑mapped section execution; fiber trampolines; marker‑based CNA patching with a compact container (header + encrypted blob).</li><li><strong>Defender takeaways</strong>: Hunt for dual mapping of the same section with different protections, fiber API usage in non‑GUI contexts, export enumeration without <code class="language-plaintext highlighter-rouge">LoadLibrary</code>, and short‑key decode loops adjacent to opaque data regions.</li></ul><hr><h2 id="table-of-contents"><span class="me-2">Table of Contents</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#table-of-contents" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ol><li>Architecture Overview</li><li>Container Structure (“Phear”‑style) — Concept</li><li>API Hashing &amp; Dynamic Resolution</li><li>Section Mapping with Dual Views</li><li>Fiber‑Based Execution (Threadless Trampoline)</li><li>CNA / Aggressor Patching Workflow (Marker‑Based Integration)</li><li>Integration Rationale: Why the Contract Works</li><li>Optional: Direct Syscall Dispatch (Overview)</li><li>Detection &amp; Hunting Playbook</li><li>ATT&amp;CK Mapping (High‑Level)</li><li>Threat Model &amp; Scope</li><li>Limitations &amp; Trade‑offs</li><li>Appendices (Glossary, Non‑Executable Snippets)</li></ol><hr><h2 id="1-architecture-overview"><span class="me-2">1) Architecture Overview</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#1-architecture-overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p></p><p><strong>Properties</strong></p><ul><li><strong>No static imports</strong>: APIs are resolved at runtime by iterating loaded modules.</li><li><strong>No RWX flips</strong>: payload is written to RW view and executed from RX view of the same section.</li><li><strong>No fresh thread</strong>: fibers move execution within the current thread.</li></ul><hr><h2 id="2-container-structure-phearstyle--concept"><span class="me-2">2) Container Structure (“Phear”‑style) — Concept</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#2-container-structure-phearstyle--concept" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>A compact container—written by CNA—is embedded into the template at a known marker (e.g., 1024 <code class="language-plaintext highlighter-rouge">A</code> characters). It contains a header and an encrypted payload blob.</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>+-------------------------------+
| header (offset, length, key)  |
+-------------------------------+
| optional bootstrap hints      |
+-------------------------------+
| encrypted payload bytes …     |
+-------------------------------+
</pre></td></tr></tbody></table></code></div></div><p><strong>Key fields</strong></p><ul><li><strong>offset</strong>: Start of the embedded payload blob relative to the template.</li><li><strong>length</strong>: Size for bounds checks and decode.</li><li><strong>key[8]</strong>: Short per‑artifact key used with a rolling XOR.</li><li><strong>hints (optional)</strong>: Fast paths for resolver bootstrap.</li></ul><p><strong>Defensive note</strong>: Hunt for large opaque blobs in <code class="language-plaintext highlighter-rouge">.data</code>/custom sections that undergo decode immediately prior to non‑standard control transfers.</p><hr><h2 id="3-api-hashing--dynamic-resolution"><span class="me-2">3) API Hashing &amp; Dynamic Resolution</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#3-api-hashing--dynamic-resolution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="conceptual-sequence"><span class="me-2">Conceptual sequence</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#conceptual-sequence" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p></p><h3 id="nonexecutable-pseudocode"><span class="me-2">Non‑executable pseudocode</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#nonexecutable-pseudocode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="n">fn</span> <span class="n">hash_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">u32</span><span class="o">:</span>
    <span class="n">h</span> <span class="o">:=</span> <span class="n">SEED</span>
    <span class="k">for</span> <span class="n">b</span> <span class="n">in</span> <span class="n">bytes</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">:</span> <span class="n">h</span> <span class="o">:=</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">FACTOR</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">h</span>

<span class="n">fn</span> <span class="n">resolve_export</span><span class="p">(</span><span class="n">module_base</span><span class="p">,</span> <span class="n">wanted_hash</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ptr</span><span class="o">:</span>
    <span class="n">exp</span> <span class="o">:=</span> <span class="n">parse_export_directory</span><span class="p">(</span><span class="n">module_base</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="n">in</span> <span class="n">exp</span><span class="p">.</span><span class="n">names</span><span class="o">:</span>
        <span class="k">if</span> <span class="n">hash_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">wanted_hash</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">module_base</span> <span class="o">+</span> <span class="n">exp</span><span class="p">.</span><span class="n">rva_for</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">null</span>

<span class="n">fn</span> <span class="n">resolve_api</span><span class="p">(</span><span class="n">wanted_hashes</span><span class="p">[])</span> <span class="o">-&gt;</span> <span class="n">map</span><span class="o">:</span>
    <span class="n">apis</span> <span class="o">:=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">mod</span> <span class="n">in</span> <span class="n">enumerate_loaded_modules</span><span class="p">()</span><span class="o">:</span>
        <span class="k">for</span> <span class="n">h</span> <span class="n">in</span> <span class="n">wanted_hashes</span><span class="o">:</span>
            <span class="k">if</span> <span class="n">apis</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="n">is</span> <span class="n">null</span><span class="o">:</span>
                <span class="n">p</span> <span class="o">:=</span> <span class="n">resolve_export</span><span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span> <span class="n">is</span> <span class="n">forwarded</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">:</span>
                    <span class="p">(</span><span class="n">tmod</span><span class="p">,</span> <span class="n">tname</span><span class="p">)</span> <span class="o">:=</span> <span class="n">parse_forwarder</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">p</span> <span class="o">:=</span> <span class="n">resolve_export</span><span class="p">(</span><span class="n">tmod</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">hash_name</span><span class="p">(</span><span class="n">tname</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">null</span><span class="o">:</span> <span class="n">apis</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">:=</span> <span class="n">p</span>
    <span class="k">return</span> <span class="n">apis</span>
</pre></td></tr></tbody></table></code></div></div><p><strong>Hunting hints</strong></p><ul><li>Export‑name scanning loops originating from non‑<code class="language-plaintext highlighter-rouge">ntdll</code> regions.</li><li>Absence of normal library loads paired with intensive export parsing.</li></ul><hr><h2 id="4-section-mapping-with-dual-views"><span class="me-2">4) Section Mapping with Dual Views</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#4-section-mapping-with-dual-views" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="concept"><span class="me-2">Concept</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#concept" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Create a <strong>section object</strong> and map it <strong>twice</strong>:</p><ul><li><strong>RW view</strong> for copying decoded bytes.</li><li><strong>RX view</strong> for executing the same underlying pages; avoids <code class="language-plaintext highlighter-rouge">VirtualProtect</code>.</li></ul><p></p><h3 id="nonexecutable-pseudocode-1"><span class="me-2">Non‑executable pseudocode</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#nonexecutable-pseudocode-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><pre><code class="language-pseudo">(sec, status) := nt_create_section(size, COMMIT, EXECUTE_READWRITE)
(rw, status) := nt_map_view(sec, current_process, READWRITE)
write_bytes(rw, decrypt(payload))
(rx, status) := nt_map_view(sec, current_process, EXECUTE_READ)
jump_to(rx)
</code></pre><p><strong>Hunting hints</strong></p><ul><li>Two mappings of the <strong>same</strong> section with different protections in rapid succession.</li><li>Execution from RX mapping immediately after block copy into RW mapping.</li><li>RX views whose backing object is not a file on disk.</li></ul><hr><h2 id="5-fiberbased-execution-threadless-trampoline"><span class="me-2">5) Fiber‑Based Execution (Threadless Trampoline)</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#5-fiberbased-execution-threadless-trampoline" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="concept-1"><span class="me-2">Concept</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#concept-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Use <strong>fibers</strong> to move execution within the current OS thread, avoiding <code class="language-plaintext highlighter-rouge">CreateThread/ResumeThread</code> patterns.</p><p></p><h3 id="nonexecutable-pseudocode-2"><span class="me-2">Non‑executable pseudocode</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#nonexecutable-pseudocode-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">main_fiber</span> <span class="o">:=</span> <span class="n">fiber_convert</span><span class="p">(</span><span class="n">current_thread</span><span class="p">)</span>
<span class="n">payload_fiber</span> <span class="o">:=</span> <span class="n">fiber_create</span><span class="p">(</span><span class="n">entry</span><span class="o">=</span><span class="n">rx_entry_point</span><span class="p">)</span>
<span class="n">fiber_switch</span><span class="p">(</span><span class="n">payload_fiber</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div><p><strong>Hunting hints</strong></p><ul><li><code class="language-plaintext highlighter-rouge">ConvertThreadToFiber</code>/<code class="language-plaintext highlighter-rouge">CreateFiber</code>/<code class="language-plaintext highlighter-rouge">SwitchToFiber</code> in non‑GUI processes before non‑returning control flow.</li><li>Lack of thread creation events paired with shellcode‑like behavior.</li></ul><hr><h2 id="6-cna--aggressor-patching-workflow-markerbased-integration"><span class="me-2">6) CNA / Aggressor Patching Workflow (Marker‑Based Integration)</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#6-cna--aggressor-patching-workflow-markerbased-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The CNA script functions as a <strong>structured patcher</strong>. It transforms a static template into a per‑task artifact while preserving strict ABI contracts with the stub.</p><h3 id="highlevel-sequence"><span class="me-2">High‑level sequence</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#highlevel-sequence" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p></p><h3 id="integration-contracts"><span class="me-2">Integration contracts</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#integration-contracts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><strong>Marker protocol</strong>: Template includes long runs of <code class="language-plaintext highlighter-rouge">A</code> (container slot) and optionally <code class="language-plaintext highlighter-rouge">M</code> (spawnto slot). CNA finds and replaces them. Stub reads the same regions at runtime.</li><li><strong>Container layout</strong>: Header (offset, length, key, hints) followed by encrypted payload blob.</li><li><strong>Encoding symmetry</strong>: CNA applies rolling XOR; stub reverses it.</li><li><strong>Size constraints</strong>: CNA enforces upper bounds; stub re‑checks <code class="language-plaintext highlighter-rouge">length</code>.</li></ul><h3 id="nonexecutable-pseudocode-3"><span class="me-2">Non‑executable pseudocode</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#nonexecutable-pseudocode-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="cp"># CNA side
</span><span class="n">key</span> <span class="o">:=</span> <span class="n">random_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="k">if</span> <span class="n">has_marker_M</span><span class="o">:</span> <span class="n">write_xor_spawnto</span><span class="p">(</span><span class="k">template</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="n">a_pos</span> <span class="o">:=</span> <span class="n">find_marker</span><span class="p">(</span><span class="k">template</span><span class="p">,</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
<span class="k">if</span> <span class="n">payload_len</span> <span class="p">&gt;</span> <span class="n">MAX</span><span class="o">:</span> <span class="n">abort</span>
<span class="n">blob</span> <span class="o">:=</span> <span class="n">xor_rolling</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="n">header</span> <span class="o">:=</span> <span class="n">build_header</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="n">a_pos</span><span class="o">+</span><span class="n">HEADER_PAYLOAD_OFFSET</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">payload_len</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">hints</span><span class="o">=</span><span class="n">maybe_hints</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
<span class="n">container</span> <span class="o">:=</span> <span class="n">header</span> <span class="o">||</span> <span class="n">blob</span>
<span class="n">write_at</span><span class="p">(</span><span class="k">template</span><span class="p">,</span> <span class="n">a_pos</span><span class="p">,</span> <span class="n">container</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="cp"># Stub side
</span><span class="n">container</span> <span class="o">:=</span> <span class="n">read_container_from_known_region</span><span class="p">()</span>
<span class="n">require</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">container</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="n">MAX</span><span class="p">)</span>
<span class="n">decoded</span> <span class="o">:=</span> <span class="n">xor_rolling</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">blob</span><span class="p">[</span><span class="mi">0</span><span class="o">:</span><span class="n">container</span><span class="p">.</span><span class="n">length</span><span class="p">],</span> <span class="n">container</span><span class="p">.</span><span class="n">key</span><span class="p">)</span>
<span class="n">resolve_apis</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">hints</span> <span class="n">or</span> <span class="n">fallback</span><span class="p">)</span>
<span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">rw</span><span class="p">)</span> <span class="o">:=</span> <span class="n">create_section_and_map_rw</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
<span class="n">copy</span><span class="p">(</span><span class="n">decoded</span><span class="p">,</span> <span class="n">rw</span><span class="p">)</span>
<span class="n">rx</span> <span class="o">:=</span> <span class="n">map_second_view_exec</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">container</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
<span class="n">fiber_switch_to</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">entry</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div><p><strong>Hunting hints</strong></p><ul><li>Families of near‑identical binaries whose differences are concentrated in a small opaque region (per‑task random keying).</li></ul><hr><h2 id="7-integration-rationale-why-the-contract-works"><span class="me-2">7) Integration Rationale: Why the Contract Works</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#7-integration-rationale-why-the-contract-works" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><strong>Contract A — Markers</strong>: The template ships with literal marker buffers (long runs of <code class="language-plaintext highlighter-rouge">A</code> and <code class="language-plaintext highlighter-rouge">M</code>) at known offsets. CNA replaces them; the stub later reads those regions.</li><li><strong>Contract B — Container ABI</strong>: The header precedes the blob and includes ordered fields (offset, length, key, hints). Both sides agree on byte order and structure size.</li><li><strong>Contract C — Bounds</strong>: A fixed maximum payload capacity is enforced by CNA and re‑checked by the stub to avoid corruption.</li><li><strong>Contract D — Encoding symmetry</strong>: CNA’s rolling XOR is inverted by the stub during parse.</li><li><strong>Contract E — Optional hints</strong>: When present, hints accelerate API resolution; otherwise, the resolver falls back to PEB/EAT parsing.</li></ul><hr><h2 id="8-optional-direct-syscall-dispatch-overview"><span class="me-2">8) Optional: Direct Syscall Dispatch (Overview)</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#8-optional-direct-syscall-dispatch-overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Some variants replace user‑mode APIs with <strong>direct syscalls</strong> to reduce exposure to user‑mode hooks. Defenders can look for:</p><ul><li><code class="language-plaintext highlighter-rouge">syscall</code>/<code class="language-plaintext highlighter-rouge">sysenter</code> originating from regions not backed by <code class="language-plaintext highlighter-rouge">ntdll</code>.</li><li>Return addresses that do not match <code class="language-plaintext highlighter-rouge">ntdll</code> thunks.</li></ul><hr><h2 id="9-detection--hunting-playbook"><span class="me-2">9) Detection &amp; Hunting Playbook</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#9-detection--hunting-playbook" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="memorymapping-signals"><span class="me-2">Memory‑mapping signals</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#memorymapping-signals" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Two mappings of the <strong>same</strong> section object with different protections (READWRITE and EXECUTE_READ) in quick succession.</li><li>Tight write→execute temporal correlation between RW and RX views.</li></ul><h3 id="resolver-signals"><span class="me-2">Resolver signals</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#resolver-signals" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Export directory scans without preceding <code class="language-plaintext highlighter-rouge">LoadLibrary</code> events.</li><li>Forwarder parsing patterns (string parse → second module → re‑scan).</li></ul><h3 id="execution-signals"><span class="me-2">Execution signals</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#execution-signals" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Fiber API usage shortly before a non‑returning control transfer.</li><li>Absence of thread creation in the same time window.</li></ul><h3 id="crosstelemetry-correlation"><span class="me-2">Cross‑telemetry correlation</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#crosstelemetry-correlation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>ETW providers for ImageLoad, Process, Thread, and MapView operations.</li><li>EDR memory telemetry for RX mappings not backed by files.</li><li>YARA across memory for short‑key XOR loops near opaque blobs.</li></ul><hr><h2 id="10-attck-mapping-highlevel"><span class="me-2">10) ATT&amp;CK Mapping (High‑Level)</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#10-attck-mapping-highlevel" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="table-wrapper"><table><thead><tr><th>Technique</th><th>ID</th><th>Notes</th></tr></thead><tbody><tr><td>Signed Binary Proxy Execution (contextual)</td><td>T1218</td><td>If templates mimic system binaries (context‑dependent).</td></tr><tr><td>Process Injection (section mapping flavor)</td><td>T1055</td><td>Dual views (RW/RX) of one section object.</td></tr><tr><td>Thread execution obfuscation (fibers)</td><td>T1055.012</td><td>Execution without creating a new thread.</td></tr><tr><td>Obfuscated/Compressed Files &amp; Info</td><td>T1027</td><td>Short‑key XOR over payload and strings.</td></tr><tr><td>Indirect Command Execution / API</td><td>T1106</td><td>Dynamic resolution via PEB walk and export parsing.</td></tr></tbody></table></div><hr><h2 id="11-threat-model--scope"><span class="me-2">11) Threat Model &amp; Scope</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#11-threat-model--scope" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><strong>Adversary objective</strong>: In‑memory payload execution with reduced traditional indicators.</li><li><strong>Out of scope</strong>: C2, lateral movement, privilege escalation; focus is on loader architecture.</li><li><strong>Assumptions</strong>: Host EDR with user‑mode hooks and kernel telemetry; SOC with SIEM/EDR search; isolated lab environment for validation.</li></ul><hr><h2 id="12-limitations--tradeoffs"><span class="me-2">12) Limitations &amp; Trade‑offs</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#12-limitations--tradeoffs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Dual mapping is observable by kernel‑mode sensors and mature EDRs.</li><li>Fiber API usage in non‑GUI contexts is unusual and can be scored.</li><li>PEB walking and heavy export parsing can be baselined in long‑running processes.</li></ul><hr><h2 id="13-appendices"><span class="me-2">13) Appendices</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#13-appendices" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="131-glossary"><span class="me-2">13.1 Glossary</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#131-glossary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><strong>PEB</strong>: Process Environment Block; OS structure listing loaded modules.</li><li><strong>Forwarded Export</strong>: Export entry that redirects to another module’s export.</li><li><strong>Fiber</strong>: User‑mode cooperative scheduling primitive; runs within an existing thread.</li><li><strong>Section Object</strong>: Kernel object backing memory views mapped into one or more processes.</li><li><strong>Container header</strong>: Structured prefix describing how to parse the embedded blob.</li><li><strong>Dual mapping</strong>: Two memory views of one section with different protections.</li><li><strong>Keying</strong>: Per‑artifact small key used for obfuscation; not cryptographic security.</li></ul><h3 id="132-nonexecutable-snippets-illustrative"><span class="me-2">13.2 Non‑Executable Snippets (Illustrative)</span><a href="https://blog.silentstrike.io/posts/Advanced-Evasion-in-Rust-ArtifactKit/#132-nonexecutable-snippets-illustrative" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="cp"># Rolling XOR
</span><span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span><span class="o">:</span>
    <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="n">XOR</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="n">mod</span> <span class="n">len</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
</pre></td></tr></tbody></table></code></div></div><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="cp"># Marker replacement
</span><span class="n">loc</span> <span class="o">:=</span> <span class="n">find_marker</span><span class="p">(</span><span class="k">template</span><span class="p">,</span> <span class="n">MARKER</span><span class="p">)</span>
<span class="n">artifact</span> <span class="o">:=</span> <span class="n">write_bytes</span><span class="p">(</span><span class="k">template</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">container_bytes</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="cp"># Export scanning
</span><span class="k">for</span> <span class="n">each</span> <span class="n">name</span> <span class="n">in</span> <span class="n">export_table</span><span class="p">.</span><span class="n">names</span><span class="o">:</span>
    <span class="k">if</span> <span class="n">hash</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">target_hash</span><span class="o">:</span> <span class="k">return</span> <span class="n">address</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div><hr></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="https://blog.silentstrike.io/categories/malware-dev/">Malware Dev</a>, <a href="https://blog.silentstrike.io/categories/red-teaming/">Red Teaming</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="https://blog.silentstrike.io/tags/windows-api/" class="post-tag no-text-decoration">Windows API</a> <a href="https://blog.silentstrike.io/tags/edr-evasion/" class="post-tag no-text-decoration">EDR Evasion</a> <a href="https://blog.silentstrike.io/tags/stealth/" class="post-tag no-text-decoration">Stealth</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 "><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Advanced%20Evasion%20in%20Rust%E2%80%91Based%20ArtifactKit:%20Techniques,%20CobaltStrike%20Integration,%20and%20Defensive%20Analysis%20-%20SilentStrike%20Blog&amp;url=https%3A%2F%2Fblog.silentstrike.io%2Fposts%2FAdvanced-Evasion-in-Rust-ArtifactKit%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Twitter" data-bs-original-title="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Advanced%20Evasion%20in%20Rust%E2%80%91Based%20ArtifactKit:%20Techniques,%20CobaltStrike%20Integration,%20and%20Defensive%20Analysis%20-%20SilentStrike%20Blog&amp;u=https%3A%2F%2Fblog.silentstrike.io%2Fposts%2FAdvanced-Evasion-in-Rust-ArtifactKit%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Facebook" data-bs-original-title="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.silentstrike.io%2Fposts%2FAdvanced-Evasion-in-Rust-ArtifactKit%2F&amp;text=Advanced%20Evasion%20in%20Rust%E2%80%91Based%20ArtifactKit:%20Techniques,%20CobaltStrike%20Integration,%20and%20Defensive%20Analysis%20-%20SilentStrike%20Blog" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Telegram" data-bs-original-title="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" data-title-succeed="Link copied successfully!" data-bs-original-title="Copy link"> <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="https://blog.silentstrike.io/tags/edr-evasion/">EDR Evasion</a> <a class="post-tag btn btn-outline-primary" href="https://blog.silentstrike.io/tags/stealth/">Stealth</a> <a class="post-tag btn btn-outline-primary" href="https://blog.silentstrike.io/tags/windows-api/">Windows API</a> <a class="post-tag btn btn-outline-primary" href="https://blog.silentstrike.io/tags/cybersecurity/">Cybersecurity</a> <a class="post-tag btn btn-outline-primary" href="https://blog.silentstrike.io/tags/detection-engineering/">Detection Engineering</a> <a class="post-tag btn btn-outline-primary" href="https://blog.silentstrike.io/tags/kernel-manipulation/">Kernel Manipulation</a> <a class="post-tag btn btn-outline-primary" href="https://blog.silentstrike.io/tags/persistence/">Persistence</a> <a class="post-tag btn btn-outline-primary" href="https://blog.silentstrike.io/tags/red-teaming/">Red Teaming</a> <a class="post-tag btn btn-outline-primary" href="https://blog.silentstrike.io/tags/silentstrike/">SilentStrike</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>
</body></html>