# https://oblivion-malware.xyz/posts/shellcode-part-2-finding-exported-functions/

<!DOCTYPE html><html lang="en"><body><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Shellcode - Pt 2: Finding Exported Function</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h1 id="retrieving-export-function">Retrieving Export Function</h1><p>Here, since we already have the address of the module (DLL) loaded into the process, we need to navigate through its PE structure, passing through the PE headers and reaching the data directory, where we will find the IMAGE EXPORT DIRECTORY. For a better understanding of the PE format, check the link: PE Format - Microsoft Documentation.</p><p>I will demonstrate the structure using PE-Bear after loading the DLL, but in general, the format looks like this:</p><p></p><p>Lets go to the first header called IMAGE DOS HEADER, which has the following structure. From there, we’ll obtain the offset of the next header, known as the File Address of the new exe header, or e_lfanew.</p><p></p><p>This will take us to the IMAGE NT HEADERS where we have its signature PE00 equal to 504500 as I’ll show next.</p><p></p><p>Inside the IMAGE NT HEADERS, we have the IMAGE FILE HEADER and the IMAGE OPTIONAL HEADER. What interests us here is the IMAGE OPTIONAL HEADER, as it contains the data directories where we can find the IMAGE EXPORT DIRECTORY, which is what we are interested in.</p><p></p><p>Now, in the IMAGE OPTIONAL HEADER, we can see that the EXPORT DIRECTORY is the first data directory. We can proceed to this directory and find components important for building our function.</p><p></p><p>Here we can already see the exported functions. To access them, we need three important components:</p><ul><li>AddressOfFunctions: Specifies the address of an array of addresses of the exported functions.</li><li>AddressOfNames: Specifies the address of an array of addresses of the names of the exported functions.</li><li>AddressOfNameOrdinals: Specifies the address of an array of ordinal numbers for the exported functions.</li></ul><p>Ordinals are used to identify the address of the function, not the name.</p><h2 id="steps-for-ldrfuncaddr"><span class="me-2">Steps for LdrFuncAddr</span><a href="https://oblivion-malware.xyz/posts/shellcode-part-2-finding-exported-functions/#steps-for-ldrfuncaddr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Retrieve the address of IMAGE NT HEADERS using e_lfanew, which is the last Offset of IMAGE DOS HEADER.</li><li>Access the IMAGE OPTIONAL HEADER within IMAGE NT HEADERS.</li><li>Navigate to the data directory within IMAGE OPTIONAL HEADER, specifically to the first data directory which is the IMAGE EXPORT DIRECTORY, and retrieve its address.</li><li>Access the components AddressOfNames, AddressOfFunctions, and AddressOfNameOrdinals.</li><li>Perform a loop searching for the input, which is the name of the exported function.</li></ul><h2 id="ldrfuncaddr-in-asm"><span class="me-2">LdrFuncAddr in ASM</span><a href="https://oblivion-malware.xyz/posts/shellcode-part-2-finding-exported-functions/#ldrfuncaddr-in-asm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre>section .text
global LdrFuncAddr

LdrFuncAddr:
    ; Receive parameters:
    ;   [ebp+8] - Module base address
    ;   [ebp+12] - Exported function name

    ; Save used registers
    push ebp
    mov ebp, esp

    ; Input parameters
    mov edi, [ebp+8]  ; Module base address
    mov esi, [ebp+12] ; Exported function name

    ; Get IMAGE DOS HEADER
    mov eax, [edi+0x3C]  ; Offset to e_lfanew
    add eax, edi         ; Address of IMAGE NT HEADERS

    ; Get IMAGE OPTIONAL HEADER
    add eax, 0x18        ; Offset to IMAGE OPTIONAL HEADER
    mov ebx, [eax]       ; Address of IMAGE OPTIONAL HEADER

    ; Get IMAGE EXPORT DIRECTORY
    add ebx, 0x60        ; Offset to export directory
    mov ecx, [ebx+0x1C]  ; Address of export directory
    add ecx, edi         ; Absolute address of export directory

    ; Get necessary components
    mov edx, [ecx+0x18]  ; Address of AddressOfNames
    add edx, edi         ; Absolute address of AddressOfNames
    mov esi, [ecx+0x1C]  ; Address of AddressOfNameOrdinals
    add esi, edi         ; Absolute address of AddressOfNameOrdinals
    mov edi, [ecx+0x20]  ; Address of AddressOfFunctions
    add edi, edi         ; Absolute address of AddressOfFunctions

search_loop:
    ; Get the next name from the name list
    mov eax, [edx]
    add eax, edi         ; Absolute address of function name

    ; Compare the current function name with the provided name
    ; If they match, find the address of the corresponding function
    cmp byte [eax], 0
    je not_found
    mov ecx, esi         ; Address of AddressOfNameOrdinals
    mov eax, [ecx]       ; Address of the function's ordinal
    add eax, edi         ; Absolute address of the function's ordinal
    mov ebx, [edi+eax*4] ; Address of AddressOfFunctions
    add ebx, edi         ; Absolute address of AddressOfFunctions
    mov eax, [ebx+eax*4] ; Address of the exported function
    add eax, edi         ; Absolute address of the exported function
    ret

not_found:
    ; Move to the next name in the list
    add edx, 4
    add esi, 2
    jmp search_loop
</pre></td></tr></tbody></table></code></div></div><h2 id="ldrfuncaddr-in-c"><span class="me-2">LdrFuncAddr in C</span><a href="https://oblivion-malware.xyz/posts/shellcode-part-2-finding-exported-functions/#ldrfuncaddr-in-c" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="n">PVOID</span> <span class="nf">LdrFuncAddr</span><span class="p">(</span> <span class="n">_In_</span> <span class="n">PVOID</span> <span class="n">BaseModule</span><span class="p">,</span> <span class="n">_In_</span> <span class="n">PCHAR</span> <span class="n">FuncName</span><span class="p">){</span>
    
    <span class="n">PIMAGE_NT_HEADERS</span>       <span class="n">pImgNt</span>           <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">PIMAGE_EXPORT_DIRECTORY</span> <span class="n">ExpDir</span>           <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">DWORD</span>                   <span class="n">ExpDirSz</span>         <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">PDWORD</span>                  <span class="n">AddrOfFuncs</span>      <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">PDWORD</span>                  <span class="n">AddrOfNames</span>      <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">PWORD</span>                   <span class="n">AddrOfOrdinals</span>   <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">PVOID</span>                   <span class="n">FuncAddr</span>         <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

    <span class="n">pImgNt</span>           <span class="o">=</span> <span class="n">C_PTR</span><span class="p">(</span> <span class="n">BaseModule</span> <span class="o">+</span> <span class="p">((</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">BaseModule</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>
    <span class="n">ExpDir</span>           <span class="o">=</span> <span class="n">C_PTR</span><span class="p">(</span> <span class="n">BaseModule</span> <span class="o">+</span> <span class="n">pImgNt</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">DataDirectory</span><span class="p">[</span> <span class="n">IMAGE_DIRECTORY_ENTRY_EXPORT</span> <span class="p">].</span><span class="n">VirtualAddress</span> <span class="p">);</span>
    <span class="n">ExpDirSz</span>         <span class="o">=</span> <span class="n">U_PTR</span><span class="p">(</span> <span class="n">BaseModule</span> <span class="o">+</span> <span class="n">pImgNt</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">DataDirectory</span><span class="p">[</span> <span class="n">IMAGE_DIRECTORY_ENTRY_EXPORT</span> <span class="p">].</span><span class="n">Size</span> <span class="p">);</span>

    <span class="n">AddrOfNames</span>      <span class="o">=</span> <span class="n">C_PTR</span><span class="p">(</span> <span class="n">BaseModule</span> <span class="o">+</span> <span class="n">ExpDir</span><span class="o">-&gt;</span><span class="n">AddressOfNames</span> <span class="p">);</span>
    <span class="n">AddrOfFuncs</span>      <span class="o">=</span> <span class="n">C_PTR</span><span class="p">(</span> <span class="n">BaseModule</span> <span class="o">+</span> <span class="n">ExpDir</span><span class="o">-&gt;</span><span class="n">AddressOfFunctions</span> <span class="p">);</span>
    <span class="n">AddrOfOrdinals</span>   <span class="o">=</span> <span class="n">C_PTR</span><span class="p">(</span> <span class="n">BaseModule</span> <span class="o">+</span> <span class="n">ExpDir</span><span class="o">-&gt;</span><span class="n">AddressOfNameOrdinals</span> <span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ExpDir</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">){</span>    
      <span class="k">if</span> <span class="p">(</span> <span class="n">StringCompareA</span><span class="p">(</span> <span class="p">(</span><span class="n">PCHAR</span><span class="p">)</span><span class="n">BaseModule</span> <span class="o">+</span> <span class="n">AddrOfNames</span><span class="p">[</span> <span class="n">i</span> <span class="p">],</span> <span class="n">FuncName</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">C_PTR</span><span class="p">(</span> <span class="n">BaseModule</span> <span class="o">+</span> <span class="n">AddrOfFuncs</span><span class="p">[</span> <span class="n">AddrOfOrdinals</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="p">]</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="https://oblivion-malware.xyz/categories/malware-development/">Malware Development</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 "><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Shellcode%20-%20Pt%202:%20Finding%20Exported%20Function%20-%20Oblivion&amp;url=%2Fposts%2Fshellcode-part-2-finding-exported-functions%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Shellcode%20-%20Pt%202:%20Finding%20Exported%20Function%20-%20Oblivion&amp;u=%2Fposts%2Fshellcode-part-2-finding-exported-functions%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fshellcode-part-2-finding-exported-functions%2F&amp;text=Shellcode%20-%20Pt%202:%20Finding%20Exported%20Function%20-%20Oblivion" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="https://oblivion-malware.xyz/tags/windows/">Windows</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>
</body></html>