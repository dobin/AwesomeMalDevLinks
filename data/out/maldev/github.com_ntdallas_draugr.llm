Title:
Draugr — BOF with Synthetic Stackframe (Call Stack Spoofing for Indirect Syscalls)

Type:
GitHub Tool

Short Summary (4–8 sentences max):
Draugr is a Windows Beacon Object File (BOF) framework that performs indirect syscalls while fabricating a “legitimate-looking” user-mode call stack to evade EDR stack-walking detections. It targets detections that flag sensitive API/syscall usage originating from unbacked/executable memory regions typical of shellcode. The implementation combines return-address spoofing with construction of synthetic frames that mimic a normal thread start chain (e.g., `RtlUserThreadStart` → `BaseThreadInitThunk`) so stack inspection shows plausible return addresses. It dynamically resolves syscall numbers (including hook-resilient neighbor scanning in `ntdll`) and computes accurate stack frame sizes by parsing x64 unwind metadata (`RtlLookupFunctionEntry` / `UNWIND_INFO`). A `jmp [rbx]` gadget in `kernelbase.dll` is used to pivot control to a fixup routine that restores registers/stack and returns cleanly, preserving syscall return values (unlike some threadpool-based evasions). The repo also documents a hard mitigation: Intel CET shadow stacks will break this technique due to return-address mismatches.

Technical Focus:
- Indirect syscalls (Hell’s Gate / Halo’s Gate-style SSN resolution)
- Synthetic call stack / return address spoofing (stack-walking evasion)
- x64 unwind parsing (.pdata, `RUNTIME_FUNCTION`, `UNWIND_INFO`, `UNWIND_CODE`)
- Gadget discovery in PE .text (e.g., `FF 23` = `jmp [rbx]`)
- Assembly stub for stack/register manipulation and fixup trampoline
- CET shadow stack incompatibility / hardware-enforced control-flow integrity

Use Cases:
- EDR evasion research for syscall-based memory operations (e.g., `NtAllocateVirtualMemory`)
- Building stealthier BOFs that need syscall return values without spawning new threads
- Studying stack-walk based detections and how synthetic frames affect telemetry
- Defensive validation: testing CET/shadow-stack protections against stack spoofing

Keywords:
BOF, Beacon Object File, indirect syscall, NtAllocateVirtualMemory, ntdll, kernelbase.dll, kernel32.dll, RtlUserThreadStart, BaseThreadInitThunk, call stack spoofing, return address spoofing, stack walking, UNWIND_INFO, RtlLookupFunctionEntry, .pdata, gadget scanning, jmp [rbx], fixup trampoline, Intel CET, shadow stack, #CP exception