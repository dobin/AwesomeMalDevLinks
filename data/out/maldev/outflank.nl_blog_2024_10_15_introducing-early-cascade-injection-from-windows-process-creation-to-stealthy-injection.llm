Title:
Introducing Early Cascade Injection: From Windows Process Creation to Stealthy Injection

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post introduces “Early Cascade Injection,” a new Windows process injection technique that targets the user-mode process creation path to execute payloads before or around common EDR user-mode instrumentation.  
- It builds on concepts from Early Bird APC injection and Marcus Hutchins’ EDR-Preloading, but avoids cross-process APC queueing (a high-signal behavior for EDRs).  
- The technique hijacks an undocumented `ntdll.dll` Shim Engine callback pointer (`g_pfnSE_DllLoaded`) during suspended process creation, runs a small stub early, then queues an APC onto the same initial thread (intra-process) via `NtQueueApcThread`.  
- The queued APC is reliably executed when `LdrInitializeThunk` later calls `NtTestAlert` to drain the APC queue, enabling the “real” payload to run after key DLLs are loaded (reducing loader-lock constraints).  
- The article provides a detailed timeline/call-graph of `LdrInitializeThunk`, explains loader lock constraints, and analyzes where EDRs commonly hook (`LdrLoadDll`, `LdrpLoadDll`, `NtContinue`) to load their user-mode hooking DLLs.  
- It’s most useful for red teams, implant developers, and security researchers studying process creation internals and user-mode EDR bypass opportunities; defenders can use it to understand new pre-entrypoint injection patterns and telemetry gaps.

Technical Focus:
- Windows process creation internals (`NtCreateUserProcess`, `LdrInitializeThunk`)
- DLL loader behavior (`LdrLoadDll` mapping vs initialization, parallel loader)
- APC mechanics (`NtQueueApcThread`, `NtTestAlert`, `KiUserApcDispatcher`)
- Loader Lock and loader-related critical sections
- Undocumented `ntdll` callback hijacking (`g_pfnSE_DllLoaded`, `.mrdata`, Shim Engine)
- EDR user-mode injection/hooking timing (inline hooks on loader functions)

Use Cases:
- Stealthy pre-entrypoint payload execution without cross-process APC queueing
- Researching/replicating user-mode process creation interception points for implants
- Evaluating EDR coverage around loader callbacks, APC draining, and early loader stages
- Building detections for `.mrdata`/Shim-related pointer tampering and early-thread self-APC patterns
- Training material for Windows loader and EDR user-mode initialization timing

Keywords:
Early Cascade Injection, Early Bird APC, EDR-Preloading, Windows process creation, NtCreateUserProcess, CREATE_SUSPENDED, ntdll.dll, LdrInitializeThunk, LdrLoadDll, LdrpLoadDll, NtTestAlert, NtQueueApcThread, APC queue, KiUserApcDispatcher, Loader Lock, PEB, PEB_LDR_DATA, .mrdata, Shim Engine, g_pfnSE_DllLoaded, g_ShimsEnabled, inline hooking, user-mode EDR hooks, kernel callbacks PspCreateProcessNotifyRoutine