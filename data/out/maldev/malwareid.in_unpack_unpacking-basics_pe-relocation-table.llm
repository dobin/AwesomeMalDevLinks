Title:
PE Relocation Table (Base Relocations) — Unpacking Basics

Type:
Blog Post

Short Summary (4–8 sentences max):
- This write-up explains how the PE base relocation table (.reloc) enables Windows to load an executable at a different ImageBase when the preferred base address is unavailable.  
- It frames relocations as a key concept for malware unpacking and process injection scenarios where a payload is mapped into an arbitrary memory region and must fix up absolute addresses.  
- The post walks through the `IMAGE_BASE_RELOCATION` structure, how relocation blocks/pages and TypeOffset “slots” are laid out, and how to compute the relocation target address from `VirtualAddress + Offset`.  
- It then reverse-engineers Windows loader behavior, pointing to `LdrRelocateImageWithBias()` and `LdrProcessRelocationBlockLongLong()` as the core routines that apply relocations.  
- Architecture-specific handling is covered, including ARM/Thumb relocation processing (relevant to Windows on ARM and x64 emulation) and the generic x86/x64 path.  
- Several relocation types are described with operational details (HIGH, LOW, HIGHLOW, HIGHADJ, DIR64), including how the “delta” between bases is applied.  
- Useful for malware analysts, reverse engineers, and tool authors building PE parsers/unpackers or diagnosing loader/relocation issues.

Technical Focus:
- PE `.reloc` section format and `IMAGE_BASE_RELOCATION` parsing
- ImageBase vs actual load base and relocation “delta” computation
- Windows loader internals: `LdrRelocateImageWithBias`, relocation block processing
- Relocation types: HIGH, LOW, HIGHLOW, HIGHADJ, DIR64
- Cross-architecture relocation handling (x86/x64 vs ARM/Thumb; Windows on ARM)

Use Cases:
- Implementing a PE relocation parser/fixer for custom loaders or unpackers
- Debugging why a manually mapped/injected PE crashes due to missing relocations
- Detecting tampering/packing tricks involving relocation stripping or manipulation
- Building tooling to rewrite/normalize relocations during malware analysis
- Understanding Windows loader behavior for defensive or offensive research

Keywords:
Portable Executable, PE, base relocations, relocation table, .reloc section, IMAGE_BASE_RELOCATION, ImageBase, delta, VirtualAddress, SizeOfBlock, TypeOffset, LdrRelocateImageWithBias, LdrProcessRelocationBlockLongLong, LdrpGenericProcessRelocation, LdrpArmProcessRelocation, LdrpThumbProcessRelocation, IMAGE_REL_BASED_HIGHLOW, IMAGE_REL_BASED_DIR64, Windows loader, manual mapping, process injection, Windows on ARM, WOW64 emulation