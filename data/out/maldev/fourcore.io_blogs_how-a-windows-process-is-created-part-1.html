# https://fourcore.io/blogs/how-a-windows-process-is-created-part-1

<!DOCTYPE html><html lang="en" class="dark" data-theme="light" style="color-scheme: light;"><body class="min-h-screen text-white overflow-x-hidden __className_f367f3" style="background-color: rgb(24, 24, 27); background-image: radial-gradient(at 94% 80%, rgb(0, 0, 0) 0px, transparent 90%), radial-gradient(at 88% 30%, rgb(30, 58, 138) 0px, transparent 37%), radial-gradient(at 30% 98%, rgb(0, 0, 0) 0px, transparent 92%), radial-gradient(at 57% 24%, rgb(0, 0, 0) 0px, transparent 70%), radial-gradient(at 11% 50%, rgb(30, 58, 138) 0px, transparent 34%), radial-gradient(at 46% 83%, rgb(30, 58, 138) 0px, transparent 100%);"><span data-focus-scope-start="true"></span><span data-focus-scope-end="true"></span><div data-overlay-container="true"><div><section class="flex flex-col items-center justify-center gap-4 mx-auto mt-10 md:mt-12"><div class="inline-block max-w-[1440px] w-full text-center justify-center"><div class="max-w-[1240px] mx-auto px-5 md:px-5 lg:px-20 pb-10"><div class=" mx-auto min-h-[300px] flex flex-col items-start justify-center capitalize"><div class="text-hero-footer font-semibold bg-[#119978]  px-[1.4rem] py-[0.5rem] rounded-full mb-4 mx-8">Article</div><h4 class="text-card-footer-muted font-body px-8">Last Updated on <b>Wed July 13, 2022</b></h4><h1 class="text-[2.5rem] text-hero-sub-header text-left px-8 __className_ea7542">Genesis - The Birth of a Windows Process (Part 1)</h1><div class="text-c1 flex items-center mx-8 mt-4 text-[1.1rem] gap-4 mb-4 md:mb-8 font-body"><span tabindex="-1" class="flex relative justify-center items-center box-border overflow-hidden align-middle z-0 outline-none data-[focus-visible=true]:z-10 data-[focus-visible=true]:outline-2 data-[focus-visible=true]:outline-focus data-[focus-visible=true]:outline-offset-2 w-10 h-10 text-tiny bg-default rounded-full text-hero-text"><span aria-label="avatar" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center justify-center text-inherit w-full h-full" role="img"><svg aria-hidden="true" fill="none" height="80%" role="presentation" viewBox="0 0 24 24" width="80%"><path d="M12 2C9.38 2 7.25 4.13 7.25 6.75C7.25 9.32 9.26 11.4 11.88 11.49C11.96 11.48 12.04 11.48 12.1 11.49C12.12 11.49 12.13 11.49 12.15 11.49C12.16 11.49 12.16 11.49 12.17 11.49C14.73 11.4 16.74 9.32 16.75 6.75C16.75 4.13 14.62 2 12 2Z" fill="currentColor"></path><path d="M17.0809 14.1489C14.2909 12.2889 9.74094 12.2889 6.93094 14.1489C5.66094 14.9989 4.96094 16.1489 4.96094 17.3789C4.96094 18.6089 5.66094 19.7489 6.92094 20.5889C8.32094 21.5289 10.1609 21.9989 12.0009 21.9989C13.8409 21.9989 15.6809 21.5289 17.0809 20.5889C18.3409 19.7389 19.0409 18.5989 19.0409 17.3589C19.0309 16.1289 18.3409 14.9889 17.0809 14.1489Z" fill="currentColor"></path></svg></span></span><div class="text-left"><div class="">Written by <b>Hardik Manocha</b></div><div class="">Co-founder @ FourCore</div></div></div></div><div class="text-left w-full markdown_markdownBody__2KovQ " style="max-width: 100%; width: 100%; display: flex; flex-flow: column;"> <figure align="center"><img src="https://fourcore.io/images/headers/genesis1.png" alt="Windows Process Creation Workflow" align="center"><figcaption align="center"></figcaption></figure>
<h2>The Birth of a Process</h2>
<p>This is the first part of a two part series. In this post, I cover how Windows spawns a process, the various APIs and data structures involved and different types of processess available on Windows. In <a href="https://fourcore.io/blogs/how-a-windows-process-is-created-part-2">Part 2</a>, We cover the exact workflow on CreateProcess to launch a process on Windows.</p>
<p>The Windows API provides several functions for creating a process. We will go through some of the important APIs and structures Win32 offers before diving into the process creation procedure.</p>
<ul class="list-disc">
<li><strong>CreateProcess:</strong> attempts to create a process with the same access token as the creating process.</li>
</ul>
<pre><div class="markdown_codeBlock__3ZRUv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy markdown_copyButton__xTMLM"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg><pre style="color: rgb(248, 248, 242); background: rgb(40, 42, 54); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none; padding: 1em; margin: 0.5em 0px; overflow: scroll auto; border-radius: 0.3em; max-height: 600px;"><code class="language-c" style="color: rgb(248, 248, 242); background: none; text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none;"><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">1</span><span>BOOL </span><span class="token" style="color: rgb(241, 250, 140);">CreateProcessA</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">2</span><span>  LPCSTR                lpApplicationName</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">3</span><span>  LPSTR                 lpCommandLine</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">4</span><span>  LPSECURITY\_ATTRIBUTES lpProcessAttributes</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">5</span><span>  LPSECURITY\_ATTRIBUTES lpThreadAttributes</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">6</span><span>  BOOL                  bInheritHandles</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">7</span><span>  DWORD                 dwCreationFlags</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">8</span><span>  LPVOID                lpEnvironment</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">9</span><span>  LPCSTR                lpCurrentDirectory</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">10</span><span>  LPSTARTUPINFOA        lpStartupInfo</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">11</span>  LPPROCESS\_INFORMATION lpProcessInformation
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">12</span><span></span><span class="token" style="color: rgb(248, 248, 242);">)</span><span class="token" style="color: rgb(248, 248, 242);">;</span></code></pre></div></pre>
<ul class="list-disc">
<li><strong>CreateProcessAsUser:</strong> attempts to create a process with the context of the user's access token provided as an argument.<br>
<strong>CreateProcessAsUser</strong> <em>must have the</em> <strong><em>SE_INCREASE_QUOTA_NAME</em></strong> <em>privilege and may require the</em> <strong><em>SE_ASSIGNPRIMARYTOKEN_NAME</em></strong> <em>privilege if the token is not assignable.</em></li>
</ul>
<pre><div class="markdown_codeBlock__3ZRUv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy markdown_copyButton__xTMLM"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg><pre style="color: rgb(248, 248, 242); background: rgb(40, 42, 54); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none; padding: 1em; margin: 0.5em 0px; overflow: scroll auto; border-radius: 0.3em; max-height: 600px;"><code class="language-c" style="color: rgb(248, 248, 242); background: none; text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none;"><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">1</span><span>BOOL </span><span class="token" style="color: rgb(241, 250, 140);">CreateProcessAsUserA</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">2</span><span>  HANDLE                hToken</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">3</span><span>  LPCSTR                lpApplicationName</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">4</span><span>  LPSTR                 lpCommandLine</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">5</span><span>  LPSECURITY\_ATTRIBUTES lpProcessAttributes</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">6</span><span>  LPSECURITY\_ATTRIBUTES lpThreadAttributes</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">7</span><span>  BOOL                  bInheritHandles</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">8</span><span>  DWORD                 dwCreationFlags</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">9</span><span>  LPVOID                lpEnvironment</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">10</span><span>  LPCSTR                lpCurrentDirectory</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">11</span><span>  LPSTARTUPINFOA        lpStartupInfo</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">12</span>  LPPROCESS\_INFORMATION lpProcessInformation
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">13</span><span></span><span class="token" style="color: rgb(248, 248, 242);">)</span><span class="token" style="color: rgb(248, 248, 242);">;</span></code></pre></div></pre>
<ul class="list-disc">
<li><strong>CreateProcessWithTokenW:</strong> attempts to create a new process and its primary thread. The new process runs in the security context of the specified token.<br>
<em>The process that calls</em> <strong><em>CreateProcessWithTokenW</em></strong> <em>must have the</em> <strong><em>SE_IMPERSONATE_NAME</em></strong> <em>privilege.</em></li>
</ul>
<pre><div class="markdown_codeBlock__3ZRUv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy markdown_copyButton__xTMLM"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg><pre style="color: rgb(248, 248, 242); background: rgb(40, 42, 54); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none; padding: 1em; margin: 0.5em 0px; overflow: scroll auto; border-radius: 0.3em; max-height: 600px;"><code class="language-c" style="color: rgb(248, 248, 242); background: none; text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none;"><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">1</span><span>BOOL </span><span class="token" style="color: rgb(241, 250, 140);">CreateProcessWithTokenW</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">2</span><span>  HANDLE                hToken</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">3</span><span>  DWORD                 dwLogonFlags</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">4</span><span>  LPCWSTR               lpApplicationName</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">5</span><span>  LPWSTR                lpCommandLine</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">6</span><span>  DWORD                 dwCreationFlags</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">7</span><span>  LPVOID                lpEnvironment</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">8</span><span>  LPCWSTR               lpCurrentDirectory</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">9</span><span>  LPSTARTUPINFOW        lpStartupInfo</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">10</span>  LPPROCESS\_INFORMATION lpProcessInformation
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">11</span><span></span><span class="token" style="color: rgb(248, 248, 242);">)</span><span class="token" style="color: rgb(248, 248, 242);">;</span></code></pre></div></pre>
<ul class="list-disc">
<li><strong>CreateProcessWithLogonW:</strong> attempts to create a new process and its primary thread and runs the specified executable file/ batch file/ 16-bit COM application in the security context of the specified credentials â€” user, domain, and password.</li>
</ul>
<figure align="center"><img src="https://i.imgur.com/ehUNfDR.jpg" alt="Process Creation Workflow" align="center"><figcaption align="center"><b>Process Creation Workflow</b></figcaption></figure>
<ul class="list-disc">
<li><strong>ShellExecute and ShellExecuteEx:</strong> These functions can accept any file and try to locate the executable to run by looking up the respective file extension in <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">HKEY_CLASS_ROOT\*</code> registry.</li>
</ul>
<blockquote>
<p>All these execution paths lead to <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">CreateProcessInternal</code>, which starts the initial setup for creating a user-mode Windows Process and eventually calls <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">NtCreateUserProcess</code> in <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">ntdll.dll</code> to make the transition to kernel mode and continue the kernel-mode part of the process creation in the function with the same name, part of the executive.</p>
</blockquote>
<h2>CreateProcess* function arguments</h2>
<p>Important arguments to CreateProcess* functions may include the token handle, user credentials, executable path, command-line arguments, handle inheritance BOOL, process creation flags, environment block, working directory, STARTUPINFO structure, and PROCESS_INFORMATION structure.</p>
<h3>Flags affecting process creation:</h3>
<ul class="list-disc">
<li>CREATE_SUSPENDED: spawns the initial thread of the new process in the suspended state/ call to <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">ResumeThread</code> to begin execution.</li>
<li>DEBUG_PROCESS: process declaring itself to be a debugger (yeah! that lucky bastard), creating a new process under its control.</li>
<li>EXTENDED_STARTUPINFO_PRESENT: launch with the extended <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">STARTUPINFOEX</code> structure instead of <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">STARTUPINFO</code>.</li>
</ul>
<p><code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">STARTUPINFO</code> structure provides configuration for process creation. The <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">EX</code> version holds key/value pairs for process and thread attributes filled via <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">UpdateProcThreadAttributes</code>. <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">PROCESS_INFORMATION</code> structure holds the new unique PID, new unique TID, and a handle to the new process and a handle to the new thread.</p>
<h2>Creating Windows modern processes</h2>
<p>Launching a modern windows process requires an additional process attribute with a key named PROC_THREAD_ATTRIBUTE_PACKAGE_FULL_NAME with the value set to the full store app package name. Other methods may include using the COM interface called <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">IApplicationActivationManager</code> that is implemented by a COM class with CLSID named <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">CLSID_ApplicationAcitvationManger</code> using the <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">ActiveApplication</code> method in this interface.</p>
<h3>How about Native, Minimal, or Pico Processes?</h3>
<p>Native Processes cannot be created from Windows Applications, as the <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">CreateProcessInternal</code> will reject images with a native subsystem image type.</p>
<p>However, <strong>Ntdll.dll</strong> provides a simple wrapper around <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">NtCreateUserProcess</code> called <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">RtlCreateUserProcess</code></p>
<pre><div class="markdown_codeBlock__3ZRUv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy markdown_copyButton__xTMLM"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg><pre style="color: rgb(248, 248, 242); background: rgb(40, 42, 54); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none; padding: 1em; margin: 0.5em 0px; overflow: scroll auto; border-radius: 0.3em; max-height: 600px;"><code class="language-c" style="color: rgb(248, 248, 242); background: none; text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none;"><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">1</span><span class="token" style="color: rgb(241, 250, 140);">RtlCreateUserProcess</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">2</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">3</span><span>  IN PUNICODE\_STRING      _ImagePath_</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">4</span><span>  IN ULONG                _ObjectAttributes_</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">5</span><span>  IN OUT PRTL\_USER\_PROCESS\_PARAMETERS _ProcessParameters_</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">6</span><span>  IN PSECURITY\_DESCRIPTOR _ProcessSecurityDescriptor_ OPTIONAL</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">7</span><span>  IN PSECURITY\_DESCRIPTOR _ThreadSecurityDescriptor_ OPTIONAL</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">8</span><span>  IN HANDLE               _ParentProcess_</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">9</span><span>  IN BOOLEAN              _InheritHandles_</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">10</span><span>  IN HANDLE               _DebugPort_ OPTIONAL</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">11</span><span>  IN HANDLE               _ExceptionPort_ OPTIONAL</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">12</span><span>  OUT PRTL\_USER\_PROCESS\_INFORMATION _ProcessInformation_ </span><span class="token" style="color: rgb(248, 248, 242);">)</span><span class="token" style="color: rgb(248, 248, 242);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">13</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(98, 114, 164);">14</span><span>  </span><span class="token" style="color: rgb(98, 114, 164);">// Reference: https://undocumented.ntinternals.net/</span></code></pre></div></pre>
<p>Windows includes a number of Kernel-Mode processes too, such as SYSTEM process, Memory Compression Process, and Pico Processes for WSL(thanks! Microsoft :) ). The creation of such processes is provided by the syscall <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">NtCreateProcessEx</code> with certain capabilities for kernel-mode callers.</p>
<p><code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">PspCreatePicoProcess</code> takes care of both creating the minimal process as well as initializing its Pico provider context. <strong>This function is only available to Pico Providers through special interface.</strong></p>
<h2>Process Internals</h2>
<p>Each Windows process is represented by an executive process (EPROCESS) structure. The threads for that process are represented by the executive thread (ETHREAD) structure.</p>
<p><code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">EPROCEESS</code> and most of its related structs exist in system address space except the Process Environment Block (PEB) which exists in the process (user) address space. (*tries to locate kernel32 base, thanks PEB) For each process, the Windows subsystem process (CSRSS) creates a parallel structure called the <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">CSR_PROCESS</code>. Similarly, the kernel-mode part of the Windows subsystem (<code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">Win32k.sys</code>) maintains a per-process data structure, <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">W32PROCESS</code>, which is created the first time a thread calls a Windows USER or GDI function that is implemented in Kernel Mode. For every non-idle process, every EPROCESS structure is encapsulated as a process object by the executive object manager.</p>
<blockquote>
<p>Hey, if you want to create your own data structures to track information on a per-process basis. It's your choice. <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">PsSetCreateProcessNotifyRoutine(Ex, Ex2)</code> allows this and is documented in the WDK.</p>
</blockquote>
<figure align="center"><img src="https://i.imgur.com/TujmXKy.jpg" alt="EPROCESS Structure (Win 10.17763.1098)" align="center"><figcaption align="center"><b>EPROCESS Structure (Win 10.17763.1098)</b></figcaption></figure>
<p>Use command <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">dt nt!_EPROCESS</code> to see all the fields of <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">EPROCESS</code> using WinDbg.</p>
<p><strong>Process Control Block</strong> (first member) is a structure of type <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">KPROCESS</code>, for the kernel process. Many routines although part of <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">EPROCESS</code> structure, use the <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">KPROCESS</code> instead.</p>
<figure align="center"><img src="https://i.imgur.com/LRJ5QsF.jpg" alt="KPROCESS Structure (Win 10.17763.1098)" align="center"><figcaption align="center"><b>KPROCESS Structure (Win 10.17763.1098)</b></figcaption></figure>
<p>Use command <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">dt nt!_KPROCESS</code> to see all the fields of <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">KPROCESS</code> using WinDbg.</p>
<p><strong>PEB</strong> It contains information needed by the image loader, the heap manager, and other windows components that need to access it from user mode.</p>
<figure align="center"><img src="https://i.imgur.com/U1WOFW9.png" alt="Examining the PEB for explorer.exe" align="center"><figcaption align="center"><b>Examining the PEB for explorer.exe</b></figcaption></figure>
<p><strong>CSR_PROCESS</strong> structure contains information about processes that is specific to the Windows Subsystem (CSRSS).</p>
<p><strong>W32PROCESS</strong> structure contains all the information that the Windows graphics and window management code in the kernel (Win32k) needs to maintain state information about GUI processes.</p>
<h2>Protected Processes</h2>
<p>(yo, don't touch my memory)</p>
<p>Protected processes can be created by any application only if the image file has been digitally signed with a <em>special Windows Media Certificate</em>.</p>
<p>The origins of the Windows Protected Process (PP) model stretch back to <a href="http://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc">Vista</a> where it was introduced to protect DRM processes. The protected process model was heavily restricted, limiting loaded DLLs to a subset of code installed with the operating system. Also for an executable to be considered eligible to be started protected it must be signed with a specific Microsoft certificate that is embedded in the binary. One protection that the kernel enforced is that a non-protected process couldn't open a handle to a protected process with enough rights to inject arbitrary code or read memory.</p>
<blockquote>
<p>*stolen shamelessly from <a href="https://googleprojectzero.blogspot.com/2018/10/injecting-code-into-windows-protected.html">https://googleprojectzero.blogspot.com/2018/10/injecting-code-into-windows-protected.html</a></p>
</blockquote>
<p>Few examples of Protected processes include Audio Device Graph (<code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">Audiodg.exe</code>), Media Foundation Protected Pipeline (<code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">Mfpmp.exe</code>), Windows Error Reporting Client Process (<code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">Werfaultsecure.exe</code>).</p>
<p>The System process is protected too, some key decryption information generated by <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">Ksecdd.sys</code> driver is stored in its user-mode memory. Not to forget that the System process's handle table contains all the kernel handles on the system.</p>
<p>Protected processes have special bits set in their <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">EPROCESS</code> structure that modify the behavior of security-related routines in the process manager to deny certain access rights that would normally be granted to administrators. The only access rights granted for protected processes are:</p>
<ul class="list-disc">
<li><code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">PROCESS_QUERY/SET_LIMITED_INFORMATION</code></li>
<li><code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">PROCESS_TERMINATE</code></li>
<li><code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">PROCESS_SUSPEND_RESUME</code></li>
</ul>
<p>Thus becoming the first step to sandbox a protected process from user-mode access.</p>
<h3>Protected Process Light</h3>
<p>PPL model adds an additional dimension to the quality of being protected: attribute values. The different signers have different trust levels, which in turn results in certain PPLs being more, or less, protected that other PPLs. Normally, the only access masks allowed are <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">PROCESS_QUERY/SET_LIMITED_INFORMATION</code> and <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">PROCESS_SUSPEND_RESUME</code>. <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">PROCESS_TERMINATE</code> is not allowed for certain PPL signers. WinSystem is the highest-priority signer and used for the System process and minimal processes such as the Memory Compression process. For user-mode processes, WinTCB is the highest-priority signed and leverage to protect critical processes.</p>
<p>But what about malicious processes? What prohibits them from claiming it is a protected process and shielding itself from anti-malware applications. Microsoft extended its Code Integrity module to understand two special enhanced key usage OIDs that can be encoded in a digital code signing certificate: <strong>1.3.6.1.4.1.311.10.3.22</strong> and <strong>1.3.6.4.1.311.10.3.20</strong>. Once one of these EKUs is present, hardcoded Signer and Issuer strings in the certificate, combined with additional possible EKUs, are then associated with the various Protected Signer values.</p>
<figure align="center"><img src="https://miro.medium.com/max/1110/1*vpLAkB0XGpvIGrJz8BeUzQ.png" alt="" align="center"></figure>
<h2>Minimal and Pico Processes</h2>
<p>Minimal processes are merely used as a container for multiple purposes, their execution time doesn't pollute arbitrary user-mode processes, they don't end up being owned by any arbitrary application either. Eg. SYSTEM.</p>
<p><strong>The Creation of a Minimal Process</strong></p>
<figure align="center"><img src="https://miro.medium.com/max/1400/1*YDjMfTEkcfmxY63rZdGmMw.jpeg" alt="Minimal Process Creation" align="center"><figcaption align="center"><b>Minimal Process Creation</b></figcaption></figure>
<h3>Pico Processes</h3>
<p>The cooler counterpart of minimal processes: installed through <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">Lxss.sys</code> and <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">LxCore.sys</code> drivers adds an inbox Pico Provider to control most aspects of their execution from an operating system perspective. This allows such a provider to emulate the behavior of a different operating system kernel. (<em>all hail thy <a href="https://fourcore.io/blogs/how-a-windows-process-is-created-part-1">DrawBridge Project</a></em>)</p>
<p>To support the existence of a Pico Process, a provider must be present, which is registered with the <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">PsRegisterPicoProvider</code> API with a specific rule: A pico provider must be loaded before any other third-party drivers are loaded. Also, these core drivers must be signed with a Microsoft Signer Certificate and Windows Component EKU.</p>
<p>When a Pico provider calls the registration API, it receives a set of function pointers, which allows it to create and manage Pico Processes:</p>
<ul class="list-disc">
<li>A function to create a Pico Process and one to create a pico thread.</li>
<li>A function to get the context of a Pico Process, one to set it, and another pair of functions to do the same for Pico threads thus populating the <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">PicoContext</code> field in the <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">ETHREAD</code> or <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">EPROCESS</code>.</li>
<li>A function to get the CPU context structure of a Pico Thread and one to set it. Another function to change the <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">FS</code> and/or <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">GS</code> segments of a Pico Thread.</li>
<li>Other functions to terminate, suspend, resume Pico Processes, and their threads.</li>
</ul>
<figure align="center"><img src="https://miro.medium.com/max/1400/1*3U8pGsA8ZH5o-o1_WYoysg.png" alt="Pico Process | WSL" align="center"><figcaption align="center"><b>Pico Process | WSL</b></figcaption></figure>
<h2>Trustlets (Secure Processes)</h2>
<p>Windows contains new virtualization-based security features such as Device Guard and Credential Guard, runs in new Isolated User Mode Environment, which, while still unprivileged (ring 3), has a virtual trust level of 1 (VTL 1), granting it protection from the regular VTL 0 world in which both the NT kernel (ring 0) and applications (ring 3) live.</p>
<h3>Trustlet Structure</h3>
<p>Trustlets are regular Windows Portable Executables with some IUM-Specific properties.</p>
<ul class="list-disc">
<li>Restricted number of system calls thus limited set of Windows System DLLs.</li>
<li>Can import Isolated User Mode specific system DLL called Iumbase, which provides the Base IUM System API, containing support for mailslots, storage boxes, cryptography, and more. This library ends up calling into <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">Iumdll.dll</code>, which is the <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">VTL 1</code> version of <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">Ntdll.dll</code> and contains secure system calls implemented by the secure kernel, and not passed on to the Normal <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">VTL 0</code> kernel.</li>
<li>Contains a PE section named .tPolicy with an exported global variable named <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">s_IumPolicyMetadata</code>.</li>
<li>They are signed with a certificate that contains the Isolated User Mode EKU.</li>
</ul>
<p>That's it for Part 1. In the next article, we'll go through the steps involved in <code style="overflow-wrap: break-word; line-height: 1.5; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, &quot;SF Mono&quot;, Menlo, Consolas, &quot;Liberation Mono&quot;, monospace; padding: 0.2em 0.4em; margin: 0px; font-size: 85%; border-radius: 6px;">CreateProcess</code>. Read <a href="https://fourcore.io/blogs/how-a-windows-process-is-created-part-2">Part 2</a>.</p>
<h2>References</h2>
<ul class="list-disc">
<li><a href="https://docs.microsoft.com/en-us/">Microsoft Documentation</a></li>
<li><a href="https://docs.microsoft.com/en-us/sysinternals/resources/windows-internals">Windows Internals 7th Edition, Part 1</a></li>
<li><a href="https://undocumented.ntinternals.net/">Undocumented Windows APIs</a></li>
<li><a href="https://fourcore.io/blogs/how-a-windows-process-is-created-part-2">Genesis - The Birth of A Windows process (Part 2)</a></li>
</ul></div></div></div></section><div class="relative lg:pt-24 pt-10 sm:pt-10"><img alt="" loading="lazy" width="1536" height="470" decoding="async" data-nimg="1" class="w-full right-0 inset-0 absolute block object-cover h-full overflow-hidden" src="https://fourcore.io/_next/static/media/footer.c753204c.svg" style="color: transparent;"></div></div></div><next-route-announcer style="position: absolute;"><div aria-live="assertive" id="__next-route-announcer__" role="alert" style="position: absolute; border: 0px; height: 1px; margin: -1px; padding: 0px; width: 1px; clip: rect(0px, 0px, 0px, 0px); overflow: hidden; white-space: nowrap; overflow-wrap: normal;"></div></next-route-announcer><div owner="archetype" title="archetype" style="display: none; visibility: hidden;" data-original-tag="iframe"></div></body></html>