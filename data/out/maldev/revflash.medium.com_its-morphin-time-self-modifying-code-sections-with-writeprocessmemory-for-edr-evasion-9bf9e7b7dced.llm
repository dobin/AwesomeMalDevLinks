Title:
It’s Morphin’ Time: Self-Modifying Code Sections with WriteProcessMemory for EDR Evasion

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explores an EDR-evasion oriented self-injection variant that avoids classic RWX allocation patterns by self-modifying an executable’s existing RX (.text) section at runtime.  
- It builds on the “Process Mockingjay” idea (using trusted DLL RWX sections) but removes the dependency on loading rare RWX-section DLLs by instead writing into code sections using WriteProcessMemory.  
- The author explains how EDRs commonly detect self-injection via userland hooks (IAT/inline hooks) on APIs like VirtualAlloc/VirtualProtect/NtProtectVirtualMemory and via kernel callbacks.  
- A key technique is crafting a custom NtProtectVirtualMemory syscall stub that “returns into” an address inside ntdll to evade userland hook/return-address heuristics, while dynamically resolving syscall numbers across Windows versions by scanning neighboring stubs.  
- The PoC reserves safe overwrite “placeholder” regions in .text (via MASM DB DUP) for both the syscall stub and a larger payload area, then flips permissions, writes position-independent code, and restores RX.  
- Useful for red teamers and malware researchers studying in-memory evasion tradeoffs; it’s interesting because it combines self-modifying code, syscall-stub generation, and hook evasion while acknowledging it doesn’t defeat kernel telemetry.

Technical Focus:
- Self-modifying code in PE .text section (RX → RWX → RX)
- WriteProcessMemory behavior and its internal NtProtectVirtualMemory/NtWriteVirtualMemory usage
- EDR userland hooking (IAT hooking, inline hooks in ntdll)
- Direct/indirect syscall stubs and “jumping into ntdll” return-address evasion
- Dynamic syscall number discovery by scanning adjacent ntdll stubs
- Position-independent payload placement and reserved code caves via MASM

Use Cases:
- Building PoCs to evaluate EDR detection of code-section tampering vs RWX allocations
- Researching alternatives to VirtualAlloc/VirtualProtect-based self-injection chains
- Developing syscall-stub strategies resilient to ntdll inline hooks
- Creating binaries that frustrate static analysis by redirecting call sites to runtime-patched trampolines
- Blue-team validation: writing detections for .text modifications and suspicious WPM-to-code-section patterns

Keywords:
WriteProcessMemory, NtProtectVirtualMemory, NtWriteVirtualMemory, ntdll.dll, inline hooks, IAT hooking, EDR evasion, self-injection, self-modifying code, .text section, RWX, RX, syscall stub, direct syscalls, indirect syscalls, return address heuristic, Process Mockingjay, MASM, position-independent code, kernel callbacks