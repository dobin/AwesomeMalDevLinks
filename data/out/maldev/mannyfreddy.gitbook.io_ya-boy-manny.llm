Title:
Fun with Exception Handlers (VEH abuse primitives vs VEH-hooking EDRs)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains Windows Vectored Exception Handling (VEH/VCH) internals and demonstrates multiple abuse primitives that become possible when an EDR relies on VEH hooks for telemetry/enforcement.  
- It shows how to locate the global VEH handler lists in `ntdll`, parse/modify handler entries, and deal with encoded handler pointers (process cookie + rotate).  
- Core offensive techniques include hijacking an existing VEH by overwriting the encoded handler pointer, manually inserting a new handler entry into the linked list, and executing payloads from exception context while selectively handling exceptions (e.g., `GUARD_PAGE`, `ACCESS_VIOLATION`).  
- It also introduces “ghetto syscalls” using a Vectored Continue Handler (VCH) to rewrite thread `CONTEXT` after an EDR’s VEH returns `EXCEPTION_CONTINUE_EXECUTION`, enabling syscall-style execution flow without typical usermode hooks.  
- A later section combines VEH hijacking with thread-pool style injection ideas (PoolParty-like), including abusing IO completion and worker thread creation by patching a single byte (`HLT`) to force an exception and redirect execution.  
- Useful for red teamers, exploit devs, and malware researchers; also valuable for defenders/EDR engineers as a critique of VEH hooking’s fragility, performance cost, and tamper surface.

Technical Focus:
- Windows VEH/VCH internals (`RtlpCallVectoredHandlers`, handler lists in `ntdll`)
- VEH handler list discovery via pattern scanning and version-specific offsets
- Encoded pointers (`RtlEncodePointer`/cookie/ROL-ROR) and remote encoding
- Exception-context execution and `CONTEXT` manipulation (RIP/RAX/R10/R11)
- VCH-based post-VEH callbacks for syscall-like control flow
- Thread pool / PoolParty-adjacent injection primitives (IO completion, worker threads)

Use Cases:
- Hijack or insert VEH handlers to gain execution in processes with existing VEHs (e.g., browsers, CLR-loaded processes)
- Bypass/abuse EDR telemetry that depends on VEH hooks (guard pages, exception-based monitoring)
- Implement exception-driven syscall dispatch (“vectored syscalls”) or context-rewrite trampolines
- Process injection by redirecting thread-pool worker execution via forced exceptions (e.g., `HLT` patch)
- Detect presence of VEH-hooking EDRs by validating handler list invariants

Keywords:
Windows, Vectored Exception Handling, VEH, VCH, RtlpCallVectoredHandlers, ntdll, RtlAddVectoredExceptionHandler, AddVectoredContinueHandler, EXCEPTION_CONTINUE_EXECUTION, GUARD_PAGE, ACCESS_VIOLATION, CONTEXT, EncodePointer, RtlEncodePointer, process cookie, NtQueryInformationProcess, NtReadVirtualMemory, NtWriteVirtualMemory, NtAllocateVirtualMemory, NtCreateThreadEx, IO completion port, thread pool, PoolParty, worker factory, TppWorkerThread, HLT instruction, EDR hooking, SentinelOne, CrowdStrike