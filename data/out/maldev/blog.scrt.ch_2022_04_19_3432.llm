Title:
Engineering antivirus evasion (Part III) – Evading userland hooks with raw syscalls (avcleaner)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes an additional obfuscation layer aimed at bypassing AV/EDR userland API hooks by rewriting high-level Win32 API calls into direct/“raw” syscalls.  
- It builds on SCRT’s earlier work on removing static artifacts (strings/imports) and introduces a clang-based C/C++ source-to-source obfuscation pass that can refactor calls like `CreateRemoteThread` into `NtCreateThreadEx`/`Zw*` equivalents with different signatures.  
- The technique dynamically retrieves Windows syscall numbers at runtime by parsing `ntdll.dll`’s PE export directory and extracting the syscall ID from the standard `mov eax, imm32; syscall` stub pattern, avoiding hardcoded syscall tables and Windows version checks.  
- The author discusses tradeoffs (e.g., reading `ntdll.dll` from disk, needing headers/typedefs) and notes detection considerations such as RWX allocations and `0F 05` syscall byte patterns.  
- A practical example shows automating obfuscation of the Meterpreter codebase with a multithreaded Python wrapper, cross-compiling, and quickly iterating with Defender static scanning.  
- Useful primarily for red teams/payload developers building custom implants, and for defenders to understand common syscall-based hook bypass patterns and their artifacts.

Technical Focus:
- Userland API hooking evasion via direct syscalls
- Dynamic syscall number resolution from `ntdll.dll`
- PE parsing (Export Directory, RVA-to-file-offset conversion)
- Position-independent code and syscall stub generation
- Clang/libTooling source-to-source obfuscation and API rewriting
- Payload build automation and AV signature testing workflows

Use Cases:
- Automate refactoring of suspicious Win32 APIs to `Nt*`/`Zw*` syscalls to reduce userland-hook visibility
- Generate syscall stubs without maintaining per-Windows-version syscall tables
- Large-scale obfuscation of C/C++ payload codebases (e.g., Meterpreter) with reporting/statistics
- Rapid CI-like loop: obfuscate → compile → scan/test to identify detection regressions
- Defensive research: create detections for `ntdll` export parsing + syscall-stub patterns and RWX allocation behavior

Keywords:
userland hooks, EDR bypass, direct syscalls, Windows syscalls, ntdll.dll, PE export directory, IMAGE_EXPORT_DIRECTORY, ASLR, ZwWriteVirtualMemory, NtCreateThreadEx, CreateRemoteThread, syscall stub, 0F 05, VirtualAlloc, PAGE_EXECUTE_READWRITE, clang, libTooling, source obfuscation, Meterpreter, Metasploit payloads, avcleaner