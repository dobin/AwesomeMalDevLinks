Title:
PhaseDive Sleep Obfuscation (Ekko fork) – Trampoline-based evasion of TickTock detection

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes “PhaseDive,” a proof-of-concept fork of the Ekko sleep obfuscation technique intended to complicate detection by WithSecureLabs’ TickTock.  
- Ekko uses a chain of `CreateTimerQueueTimer` callbacks that invoke `NtContinue` with crafted `CONTEXT` structures to execute a ROP-like sequence (change memory protections, encrypt/decrypt the module, sleep, then restore protections) without directly running the main image code.  
- TickTock detects Ekko by enumerating timer queues, resolving timer callback symbols (notably `NtContinue`), and inspecting referenced `CONTEXT` structures to infer the staged calls (e.g., `VirtualProtect`).  
- PhaseDive reduces this visibility by introducing trampoline/gadget indirection (e.g., setting `CONTEXT.Rip` to a `jmp rax` gadget and placing the real target in `RAX`) to break straightforward symbol resolution.  
- It also replaces direct `NtContinue` timer callbacks with `ntdll` gadgets that `call ZwContinue`, aiming to evade detections that alert on timers pointing to `NtContinue`.  
- Useful for red teamers and malware developers studying sleep masking and for defenders understanding how timer/CONTEXT-based detections can be bypassed.

Technical Focus:
- Ekko-style sleep obfuscation via Timer Queue + `NtContinue`
- `CONTEXT` structure manipulation for indirect function invocation
- Timer callback enumeration and symbol-resolution-based detection (TickTock)
- Trampoline/gadget indirection (`jmp rax`, `call ZwContinue`) to evade detections
- Memory protection flipping and in-memory encryption during sleep masking

Use Cases:
- Implementing or modifying sleep-masking in Windows implants/loaders
- Evaluating robustness of timer/NtContinue-based detection logic
- Developing detection bypass PoCs using ROP-like trampolines
- Blue-team research into alternative heuristics beyond symbol resolution

Keywords:
Ekko, PhaseDive, TickTock, sleep obfuscation, sleep masking, CreateTimerQueueTimer, timer queue, NtContinue, ZwContinue, CONTEXT, ROP, trampoline, gadget, jmp rax, ntdll.dll, VirtualProtect, memory encryption, callback enumeration, symbol resolution, EDR evasion