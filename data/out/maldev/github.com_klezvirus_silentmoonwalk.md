# https://github.com/klezVirus/SilentMoonwalk/

[Skip to content](https://github.com/klezVirus/SilentMoonwalk/#start-of-content)

You signed in with another tab or window. [Reload](https://github.com/klezVirus/SilentMoonwalk/) to refresh your session.You signed out in another tab or window. [Reload](https://github.com/klezVirus/SilentMoonwalk/) to refresh your session.You switched accounts on another tab or window. [Reload](https://github.com/klezVirus/SilentMoonwalk/) to refresh your session.Dismiss alert

{{ message }}

[klezVirus](https://github.com/klezVirus)/ **[SilentMoonwalk](https://github.com/klezVirus/SilentMoonwalk)** Public

- [Notifications](https://github.com/login?return_to=%2FklezVirus%2FSilentMoonwalk) You must be signed in to change notification settings
- [Fork\\
109](https://github.com/login?return_to=%2FklezVirus%2FSilentMoonwalk)
- [Star\\
913](https://github.com/login?return_to=%2FklezVirus%2FSilentMoonwalk)


PoC Implementation of a fully dynamic call stack spoofer


### License

[BSD-3-Clause license](https://github.com/klezVirus/SilentMoonwalk/blob/master/LICENSE)

[913\\
stars](https://github.com/klezVirus/SilentMoonwalk/stargazers) [109\\
forks](https://github.com/klezVirus/SilentMoonwalk/forks) [Branches](https://github.com/klezVirus/SilentMoonwalk/branches) [Tags](https://github.com/klezVirus/SilentMoonwalk/tags) [Activity](https://github.com/klezVirus/SilentMoonwalk/activity)

[Star](https://github.com/login?return_to=%2FklezVirus%2FSilentMoonwalk)

[Notifications](https://github.com/login?return_to=%2FklezVirus%2FSilentMoonwalk) You must be signed in to change notification settings

# klezVirus/SilentMoonwalk

master

[**1** Branch](https://github.com/klezVirus/SilentMoonwalk/branches) [**0** Tags](https://github.com/klezVirus/SilentMoonwalk/tags)

[Go to Branches page](https://github.com/klezVirus/SilentMoonwalk/branches)[Go to Tags page](https://github.com/klezVirus/SilentMoonwalk/tags)

Go to file

Code

Open more actions menu

## Folders and files

| Name | Name | Last commit message | Last commit date |
| --- | --- | --- | --- |
| ## Latest commit<br>[![klezVirus](https://avatars.githubusercontent.com/u/8959898?v=4&size=40)](https://github.com/klezVirus)[klezVirus](https://github.com/klezVirus/SilentMoonwalk/commits?author=klezVirus)<br>[Add Eclipse v0.1](https://github.com/klezVirus/SilentMoonwalk/commit/c9ad49f9d0a0e84c6345a991b82e011b03f6f8a6)<br>2 years agoJul 20, 2024<br>[c9ad49f](https://github.com/klezVirus/SilentMoonwalk/commit/c9ad49f9d0a0e84c6345a991b82e011b03f6f8a6) · 2 years agoJul 20, 2024<br>## History<br>[8 Commits](https://github.com/klezVirus/SilentMoonwalk/commits/master/) <br>Open commit details<br>[View commit history for this file.](https://github.com/klezVirus/SilentMoonwalk/commits/master/) 8 Commits |
| [Eclipse](https://github.com/klezVirus/SilentMoonwalk/tree/master/Eclipse "Eclipse") | [Eclipse](https://github.com/klezVirus/SilentMoonwalk/tree/master/Eclipse "Eclipse") | [Add Eclipse v0.1](https://github.com/klezVirus/SilentMoonwalk/commit/c9ad49f9d0a0e84c6345a991b82e011b03f6f8a6 "Add Eclipse v0.1") | 2 years agoJul 20, 2024 |
| [SilentMoonwalk](https://github.com/klezVirus/SilentMoonwalk/tree/master/SilentMoonwalk "SilentMoonwalk") | [SilentMoonwalk](https://github.com/klezVirus/SilentMoonwalk/tree/master/SilentMoonwalk "SilentMoonwalk") | [Fix typo](https://github.com/klezVirus/SilentMoonwalk/commit/b96278c63130bde739a4f9ac92e849ddaedcf456 "Fix typo") | 4 years agoDec 4, 2022 |
| [UnwindInspector](https://github.com/klezVirus/SilentMoonwalk/tree/master/UnwindInspector "UnwindInspector") | [UnwindInspector](https://github.com/klezVirus/SilentMoonwalk/tree/master/UnwindInspector "UnwindInspector") | [Public Release](https://github.com/klezVirus/SilentMoonwalk/commit/84855f84e18545f341120936624eb061f5c5b6cc "Public Release") | 4 years agoDec 4, 2022 |
| [assets/img](https://github.com/klezVirus/SilentMoonwalk/tree/master/assets/img "This path skips through empty directories") | [assets/img](https://github.com/klezVirus/SilentMoonwalk/tree/master/assets/img "This path skips through empty directories") | [Public Release](https://github.com/klezVirus/SilentMoonwalk/commit/84855f84e18545f341120936624eb061f5c5b6cc "Public Release") | 4 years agoDec 4, 2022 |
| [.gitignore](https://github.com/klezVirus/SilentMoonwalk/blob/master/.gitignore ".gitignore") | [.gitignore](https://github.com/klezVirus/SilentMoonwalk/blob/master/.gitignore ".gitignore") | [Public Release](https://github.com/klezVirus/SilentMoonwalk/commit/84855f84e18545f341120936624eb061f5c5b6cc "Public Release") | 4 years agoDec 4, 2022 |
| [LICENSE](https://github.com/klezVirus/SilentMoonwalk/blob/master/LICENSE "LICENSE") | [LICENSE](https://github.com/klezVirus/SilentMoonwalk/blob/master/LICENSE "LICENSE") | [Fix unicode in author name](https://github.com/klezVirus/SilentMoonwalk/commit/c3981e365fb1edaad474db840edc0b7325bae641 "Fix unicode in author name") | 4 years agoDec 4, 2022 |
| [README.md](https://github.com/klezVirus/SilentMoonwalk/blob/master/README.md "README.md") | [README.md](https://github.com/klezVirus/SilentMoonwalk/blob/master/README.md "README.md") | [Update README.md](https://github.com/klezVirus/SilentMoonwalk/commit/8f68c02203bd3ba86f06fe056ff05f04dcc3da8e "Update README.md") | 4 years agoDec 8, 2022 |
| [SilentMoonwalk.sln](https://github.com/klezVirus/SilentMoonwalk/blob/master/SilentMoonwalk.sln "SilentMoonwalk.sln") | [SilentMoonwalk.sln](https://github.com/klezVirus/SilentMoonwalk/blob/master/SilentMoonwalk.sln "SilentMoonwalk.sln") | [Add Eclipse v0.1](https://github.com/klezVirus/SilentMoonwalk/commit/c9ad49f9d0a0e84c6345a991b82e011b03f6f8a6 "Add Eclipse v0.1") | 2 years agoJul 20, 2024 |
| View all files |

## Repository files navigation

# SilentMoonwalk

[Permalink: SilentMoonwalk](https://github.com/klezVirus/SilentMoonwalk/#silentmoonwalk)

PoC Implementation of a fully dynamic call stack spoofer

## TL;DR

[Permalink: TL;DR](https://github.com/klezVirus/SilentMoonwalk/#tldr)

SilentMoonwalk is a PoC implementation of a fully dynamic call stack spoofer, implementing a technique to remove the original caller from the call stack,
using ROP to desynchronize unwinding from control flow.

## Authors

[Permalink: Authors](https://github.com/klezVirus/SilentMoonwalk/#authors)

This PoC is the result of a joint research done on the topic of stack spoofing. The authors of the research are:

- [KlezVirus](https://twitter.com/KlezVirus)
- [Waldo-IRC](https://twitter.com/waldoirc)
- [Trickster0](https://twitter.com/trickster012)

I want to stress that this work would have been impossible without the work of [Waldo-IRC](https://twitter.com/waldoirc) and [Trickster0](https://twitter.com/trickster012), which both
contributed to the early stages of the PoC, and to the research behind the PoC.

## Overview

[Permalink: Overview](https://github.com/klezVirus/SilentMoonwalk/#overview)

This repository demonstrates a PoC implementation to spoof the call stack when calling arbitrary Windows APIs.

This attempt was inspired by [this Twitter thread](https://twitter.com/_Kudaes_/status/1594753842310434816), and [this Twitter thread](https://twitter.com/namazso/status/1442314742488567808), where sensei [namazso](https://twitter.com/namazso) showed and suggested
to extend the stack unwinding approach with a ROP chain to both desynchronize the unwinding from real control flow and restore
the original stack afterwards.

This PoC attempts to do something similar to the above, and uses a desync stack to completely hide the original
call stack, also removing the EXE image base from it. Upon return, a ROP gadget is invoked to restore the original stack.
In the code, this process is repeated 10 times in a loop, using different frames at each iteration, to prove stability.

### Supported Modes

[Permalink: Supported Modes](https://github.com/klezVirus/SilentMoonwalk/#supported-modes)

The tool currently supports 2 modes, where one is actually a wrong patch to a non-working pop RBP frame identified, which operates by shifting the current
RSP and adding two fake frames to the call stack. As it operates using synthetic frames, I refer to this mode as "SYNTHETIC".

When selecting the frame that unwinds by popping the RBP register from the stack, the tool might select an unsuitable frame, ending up in an abruptly
cut call stack, as observable below.

[![Windows 10 Call Stack - Cut](https://github.com/klezVirus/SilentMoonwalk/raw/master/assets/img/stack_cut.png)](https://github.com/klezVirus/SilentMoonwalk/blob/master/assets/img/stack_cut.png)

### Synthetic Call Stack Mode

[Permalink: Synthetic Call Stack Mode](https://github.com/klezVirus/SilentMoonwalk/#synthetic-call-stack-mode)

A silly solution to the problem would be to create two fake frames and link them back to the cut call stack. This would create a sort of apparently legit call stack,
even without a suitable frame which unwinds calling POP RBP, but:

- You would lose the advantage of the desync technique
- The stack would be still unwindable
- The resulting call stack could seem legit just on the first glance, but it would probably not pass a strict check

The result of the \_synthetic spoof can be observed in the image below:

[![Windows 10 Call Stack - Apparently Legit, non unwoundable - getchar](https://github.com/klezVirus/SilentMoonwalk/raw/master/assets/img/stack_win10_getchar.png)](https://github.com/klezVirus/SilentMoonwalk/blob/master/assets/img/stack_win10_getchar.png)

_Figure 1: Windows 10 - Apparently Legit, non unwoundable call stack whereby the EXE module was completely removed (calling no parameters function getchar)_

_Note: This operation mode is disabled by default. To enable this mode, change the CALLSTACK\_TYPE to 1_

### Desync Stack Mode

[Permalink: Desync Stack Mode](https://github.com/klezVirus/SilentMoonwalk/#desync-stack-mode)

This mode is the right solution to the above problem, whereby the non-suitable frame is simply replaced by another, suitable one.

[![Windows 10 Call Stack - Legit, unwoundable - MessageBoxExA](https://github.com/klezVirus/SilentMoonwalk/raw/master/assets/img/stack_win10_msgbox_ex.png)](https://github.com/klezVirus/SilentMoonwalk/blob/master/assets/img/stack_win10_msgbox_ex.png)

_Figure 2: Windows 10 - Legit, unwoundable call stack whereby the EXE module was completely removed (calling 4 parameters function MessageBoxA)_

## Utility

[Permalink: Utility](https://github.com/klezVirus/SilentMoonwalk/#utility)

In the repository, you can find also a little util to inspect runtime functions, which might be useful to analyse runtime function entries.

```
UnwindInspector.exe -h

 Unwind Inspector v0.100000

 Mandatory args:
   -m <module>: Target DLL
   -f <function>: Target Function
   -a <function-address>: Target Function Address
```

Sample Output:

```
UnwindInspector.exe -m kernelbase -a 0x7FFAAE12182C
[*] Using function address 0x7ffaae12182c

  Runtime Function (0x000000000000182C, 0x00000000000019ED)
  Unwind Info Address: 0x000000000026AA88
    Version: 0
    Ver + Flags: 00000000
    SizeOfProlog: 0x1f
    CountOfCodes: 0xc
    FrameRegister: 0x0
    FrameOffset: 0x0
    UnwindCodes:
    [00h] Frame: 0x741f - 0x04  - UWOP_SAVE_NONVOL     (RDI, 0x001f)
    [01h] Frame: 0x0015 - 0x00  - UWOP_PUSH_NONVOL     (RAX, 0x0015)
    [02h] Frame: 0x641f - 0x04  - UWOP_SAVE_NONVOL     (RSI, 0x001f)
    [03h] Frame: 0x0014 - 0x00  - UWOP_PUSH_NONVOL     (RAX, 0x0014)
    [04h] Frame: 0x341f - 0x04  - UWOP_SAVE_NONVOL     (RBX, 0x001f)
    [05h] Frame: 0x0012 - 0x00  - UWOP_PUSH_NONVOL     (RAX, 0x0012)
    [06h] Frame: 0xb21f - 0x02  - UWOP_ALLOC_SMALL     (R11, 0x001f)
    [07h] Frame: 0xf018 - 0x00  - UWOP_PUSH_NONVOL     (R15, 0x0018)
    [08h] Frame: 0xe016 - 0x00  - UWOP_PUSH_NONVOL     (R14, 0x0016)
    [09h] Frame: 0xd014 - 0x00  - UWOP_PUSH_NONVOL     (R13, 0x0014)
    [0ah] Frame: 0xc012 - 0x00  - UWOP_PUSH_NONVOL     (R12, 0x0012)
    [0bh] Frame: 0x5010 - 0x00  - UWOP_PUSH_NONVOL     (RBP, 0x0010)
```

## Build

[Permalink: Build](https://github.com/klezVirus/SilentMoonwalk/#build)

In order to build the POC and observe a similar behaviour to the one in the picture, ensure to:

- Disable GS (`/GS-`)
- Disable Code Optimisation (`/Od`)
- Disable Whole Program Optimisation (Remove `/GL`)
- Disable size and speed preference (Remove `/Os`, `/Ot`)
- **Enable** intrinsic if not enabled (`/Oi`)

## Previous Work

[Permalink: Previous Work](https://github.com/klezVirus/SilentMoonwalk/#previous-work)

It's worth mentioning previous work done on this topic, which built the foundation of this work.

- [Return Address Spoofing](https://www.unknowncheats.me/forum/anti-cheat-bypass/268039-x64-return-address-spoofing-source-explanation.html): Original technique and idea, by Namaszo. Every other PoC I'm aware of was built on top of that.
- [YouMayPasser](https://github.com/waldo-irc/YouMayPasser): This amazing work by Arash is the first properly done extension of the Return Address Spoofing PoC by Namaszo.
- [VulcanRaven](https://github.com/WithSecureLabs/CallStackSpoofer/): A call stack spoofer that operates the spoofing by synthetically creating a Thread Stack mirroring another real call stack.
- [Unwinder](https://github.com/Kudaes/Unwinder/): A very nice Rust PoC implementation of a call stack spoofer which operates by parsing unwind code information to replace frames in the call stack.

## Credits

[Permalink: Credits](https://github.com/klezVirus/SilentMoonwalk/#credits)

- Huge shoutout to [waldo-irc](https://twitter.com/waldoirc) and [trickster0](https://twitter.com/trickster012), which collaborated with me on this research. I owe everything to them.
- All the credit for the idea behind this goes to [namaszo](https://twitter.com/namazso), which I personally consider a genius. He also cross checked this PoC before release, so huge thanks to him.

## Notes

[Permalink: Notes](https://github.com/klezVirus/SilentMoonwalk/#notes)

- \[SYNTHETIC STACK ONLY\]: For a limitation in the way I'm locating the gadgets, the maximum number of arguments is 8 for now (it is TRIVIAL to modify and add more params, but I couldn't bother).
- \[DSESYNC STACK ONLY\]: For a limitation in how I'm setting up the spoofer, the maximum number of supported arguments is 4 for now.
- Testing on this one was pretty limited. There might be exceptions I'm not aware of at the moment.
- Unwinding involving 128-bit registers was no tested.
- Calling functions that use 128-bit registers is not officially supported.

## About

PoC Implementation of a fully dynamic call stack spoofer


### Topics

[thread-stack](https://github.com/topics/thread-stack "Topic: thread-stack") [av-evasion](https://github.com/topics/av-evasion "Topic: av-evasion") [edr-evasion](https://github.com/topics/edr-evasion "Topic: edr-evasion") [stack-spoofing](https://github.com/topics/stack-spoofing "Topic: stack-spoofing")

### Resources

[Readme](https://github.com/klezVirus/SilentMoonwalk/#readme-ov-file)

### License

[BSD-3-Clause license](https://github.com/klezVirus/SilentMoonwalk/#BSD-3-Clause-1-ov-file)

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/klezVirus/SilentMoonwalk/).

[Activity](https://github.com/klezVirus/SilentMoonwalk/activity)

### Stars

[**913**\\
stars](https://github.com/klezVirus/SilentMoonwalk/stargazers)

### Watchers

[**12**\\
watching](https://github.com/klezVirus/SilentMoonwalk/watchers)

### Forks

[**109**\\
forks](https://github.com/klezVirus/SilentMoonwalk/forks)

[Report repository](https://github.com/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2FklezVirus%2FSilentMoonwalk&report=klezVirus+%28user%29)

## [Releases](https://github.com/klezVirus/SilentMoonwalk/releases)

No releases published

## [Packages\  0](https://github.com/users/klezVirus/packages?repo_name=SilentMoonwalk)

No packages published

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/klezVirus/SilentMoonwalk/).

## Languages

- [C++45.7%](https://github.com/klezVirus/SilentMoonwalk/search?l=c%2B%2B)
- [C43.0%](https://github.com/klezVirus/SilentMoonwalk/search?l=c)
- [Assembly11.3%](https://github.com/klezVirus/SilentMoonwalk/search?l=assembly)

You can’t perform that action at this time.