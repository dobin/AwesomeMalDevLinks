Title:
Evading Microsoft Defender by Embedding Lua into Rust

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post demonstrates an AV evasion technique where a Windows shellcode loader is written in Lua (LuaJIT) and embedded inside a Rust executable.  
- The goal is to compare Defender detection between a “baseline” pure-Rust shellcode loader and a Rust program that executes the loader logic via embedded Lua using the `mlua` crate.  
- It walks through passing an XOR-encrypted Meterpreter payload from Rust into Lua, using LuaJIT FFI to call WinAPI (`VirtualAlloc`, `VirtualProtect`, `CreateThread`, `WaitForSingleObject`) to allocate, decrypt, mark executable, and run shellcode.  
- The author reports the embedded-Lua variant runs on Windows 11 with Defender real-time protection enabled, while the pure Rust version is detected on disk; VirusTotal results show significantly fewer detections for the Lua-embedded approach.  
- Useful for red teamers and offensive tool developers exploring “uncommon language/runtime” tradecraft to reduce static/heuristic detections.  
- Interesting because it highlights how shifting implementation into an embedded scripting runtime (LuaJIT FFI) can materially change AV detection outcomes even with a common injection pattern.

Technical Focus:
- Rust + embedded LuaJIT via `mlua` (vendored, luajit features)
- LuaJIT FFI for direct WinAPI invocation
- Classic shellcode loader chain: VirtualAlloc → decrypt/copy → VirtualProtect → CreateThread
- XOR (rotating key) shellcode encryption/decryption workflow
- Cross-language data passing (Rust globals/tables to Lua)
- Defender/VirusTotal comparative detection testing methodology

Use Cases:
- Building loaders that move suspicious logic into an embedded scripting runtime
- Rapid prototyping of Windows injection logic using LuaJIT FFI instead of native Rust/C
- Testing how language/runtime choices affect Microsoft Defender static/heuristic detections
- Creating “baseline vs modified” payloads to evaluate defensive coverage in a lab

Keywords:
Microsoft Defender, AV evasion, Rust, Lua, LuaJIT, mlua, FFI, WinAPI, VirtualAlloc, VirtualProtect, CreateThread, WaitForSingleObject, shellcode loader, Meterpreter, msfvenom, XOR encryption, rotating key, Windows 11, payload embedding, static detection, VirusTotal