Title:
In-Memory Disassembly for EDR/AV Unhooking

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post analyzes inline user-mode hooking used by Sophos AV (via `hmpalert.dll`) against NTDLL exports and explains why common NTDLL “unhooking” approaches fail.  
- The core issue is a chicken-and-egg problem: many public unhookers rely on `VirtualProtect`/`NtProtectVirtualMemory` to patch hooks, but `NtProtectVirtualMemory` itself is hooked and monitored, enabling the AV to block or detect the unhook attempt.  
- While direct syscalls can bypass NTDLL hooks, the author notes limitations (not all NTDLL exports are pure syscalls) and that syscall stubs can be suspicious.  
- The proposed method uses in-memory disassembly to follow the hook trampoline patterns into the AV module and recover pointers to the original, unhooked code blocks/stubs that still reside in memory.  
- After locating these originals at runtime, the technique rewrites the hooked NTDLL entrypoints to jump to the recovered original code, avoiding direct syscalls and avoiding calling hooked APIs before unhooking.  
- A Rust PoC is referenced that implements this logic (export walking + pattern-based disassembly) to restore unhooked behavior.

Technical Focus:
- User-mode inline hooking patterns (JMP trampolines) in NTDLL
- Hook evasion via in-memory disassembly and trampoline resolution
- PEB-based module discovery and NTDLL export table walking
- Recovering original syscall stubs / original code blocks from AV hook modules
- Unhooking strategy that avoids `NtProtectVirtualMemory` hook dependency
- Rust implementation considerations for runtime memory analysis

Use Cases:
- Building unhooking logic that works against self-protecting AV/EDR user-mode hooks
- Enumerating and identifying hooked NTDLL exports in a live process
- Restoring original execution paths for both syscall and non-syscall NTDLL exports
- Red team tradecraft research on hook engines and trampoline layouts
- Developing PoCs to evaluate EDR resilience to unhooking techniques

Keywords:
EDR hooks, AV hooking, NTDLL, inline hook, trampoline, NtProtectVirtualMemory, VirtualProtect, PEB, export table walking, in-memory disassembly, Sophos, hmpalert.dll, syscall stub, direct syscalls, unhooking, Rust, PssNtCaptureSnapshot, user-mode hooking, anti-tamper, self-protection