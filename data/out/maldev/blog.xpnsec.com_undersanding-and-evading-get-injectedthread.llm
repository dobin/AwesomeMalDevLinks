Title:
Understanding and Evading Get-InjectedThread

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post analyzes how SpecterOps’ PowerShell tool “Get-InjectedThread” detects process injection by enumerating threads and inspecting the memory backing each thread’s start address.  
- The detection logic relies on `NtQueryInformationThread` to obtain a thread entry point and `VirtualQueryEx` to check whether that address resides in `MEM_IMAGE` (module-backed) memory versus dynamically allocated (`MEM_PRIVATE`) memory.  
- The author demonstrates that classic `VirtualAllocEx` → `WriteProcessMemory` → `CreateRemoteThread` shellcode injection is flagged because the thread start address points into non-`MEM_IMAGE` committed memory.  
- Three evasion approaches are shown: DLL injection via `LoadLibraryA`, creating a suspended thread in `MEM_IMAGE` code then redirecting execution with `SetThreadContext`, and starting a thread at a `MEM_IMAGE` “gadget” (e.g., `jmp rcx`) that trampolines into shellcode.  
- It’s useful for red teamers and malware developers to understand limitations of thread-start-address heuristics, and for defenders to anticipate bypasses and improve telemetry/correlation beyond `MEM_IMAGE` checks.

Technical Focus:
- Thread enumeration and start-address inspection (`CreateToolhelp32Snapshot`, `NtQueryInformationThread`)
- Memory region classification via `VirtualQueryEx` (`MEM_IMAGE`, `MEM_COMMIT`, protections)
- Remote thread creation and common injection chains (`VirtualAllocEx`, `WriteProcessMemory`, `CreateRemoteThread`)
- DLL injection using `LoadLibraryA` as a `MEM_IMAGE` entry point
- Thread context manipulation (`GetThreadContext`, `SetThreadContext`, `ResumeThread`)
- Gadget-based trampolining / ROP-like thread start (`jmp rcx` on x64 calling convention)

Use Cases:
- Evaluate whether an environment’s “injected thread” hunting will catch your injection tradecraft
- Implement alternative injection primitives that avoid thread-start-in-private-memory heuristics
- Build improved detections that correlate thread start, context changes, and module/gadget usage
- Create lab PoCs to test EDR/DFIR memory-hunting assumptions around `MEM_IMAGE`

Keywords:
Get-InjectedThread, SpecterOps, process injection, thread start address, NtQueryInformationThread, VirtualQueryEx, MEM_IMAGE, MEM_PRIVATE, MEM_COMMIT, CreateToolhelp32Snapshot, OpenThread, OpenProcess, VirtualAllocEx, WriteProcessMemory, CreateRemoteThread, LoadLibraryA, DLL injection, SetThreadContext, GetThreadContext, RIP, x64 calling convention, RCX, jmp rcx gadget, trampoline, ROP, shellcode execution, Windows internals, memory hunting