Title:
A Beginner’s Guide to EDR Evasion

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how modern EDRs detect malicious activity via user-mode Windows API/NTDLL hooking and how attackers can evade those hooks.  
- It walks through Windows API call flow (WinAPI → NTDLL stubs → syscalls) and how EDRs patch NTDLL functions (e.g., inline JMP trampolines) to observe syscall sequences and arguments.  
- It compares API unhooking approaches (restoring bytes, remapping NTDLL, pulling clean stubs from disk) and highlights the key drawback: unhooking itself often triggers telemetry.  
- The main evasion approach presented is using direct syscalls (via SysWhispers/SysWhispers2-generated ASM/H files) to bypass hooked user-mode APIs entirely.  
- For execution/injection, it argues CreateRemoteThread-style injection is broadly detectable and instead focuses on APC queue injection (NtQueueApcThread/QueueUserAPC), including reliability constraints around “alertable” threads and strategies like APC spraying.  
- It concludes with a high-level build recipe for an EDR-evasive shellcode loader: encrypted payload, in-memory decrypt, direct syscalls, and APC-based execution.  
- Useful primarily for red teamers, pentesters, and malware developers; also valuable to blue teams for understanding common bypass patterns and where to add detections beyond user-mode hooks.

Technical Focus:
- User-mode API/NTDLL inline hooking (trampolines, JMP patching)
- Windows syscall path and NTDLL syscall stubs
- API unhooking strategies and limitations
- Direct syscalls with SysWhispers/SysWhispers2 (version-dependent syscall numbers)
- Process injection tradeoffs (CreateRemoteThread vs APC queue injection)
- Memory permission hygiene (RW → RX, avoiding RWX) and in-memory decryption

Use Cases:
- Building a custom shellcode loader that avoids user-mode EDR hooks
- Replacing common injection primitives with APC queue execution for stealthier tradecraft
- Generating direct-syscall wrappers for sensitive NTDLL routines (allocation, mapping, thread/APC ops)
- Designing defensive detections that don’t rely solely on hooked API telemetry (e.g., handle/thread/memory events)

Keywords:
EDR evasion, API hooking, inline hook, trampoline, NTDLL, syscall, direct system calls, SysWhispers, SysWhispers2, NtCreateThreadEx, NtAllocateVirtualMemory, NtWriteVirtualMemory, NtMapViewOfSection, QueueUserAPC, NtQueueApcThread, APC injection, process injection, Cobalt Strike, Defender ATP, CrowdStrike, Carbon Black, RWX avoidance, memory protection (RW/RX), in-memory decryption, PEB spoofing, PPID spoofing