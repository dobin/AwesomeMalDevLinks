Title:
Adventures in Dynamic Evasion

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explores a capability-driven approach to EDR evasion by first identifying what telemetry an endpoint product can collect (specifically user-mode API hooks) and then tailoring tradecraft accordingly, rather than relying on “what worked last time.”  
- It explains how many EDRs monitor suspicious behavior by injecting a DLL and hooking `ntdll.dll` Native API stubs (e.g., `NtAllocateVirtualMemory`, `NtOpenProcess`) via trampolines.  
- The author shows that hooks are straightforward to detect by validating the expected x64 syscall stub instruction sequence and flagging deviations.  
- To experiment without commercial EDR access, they emulate hooking using Frida, then provide a C# PoC “HookDetector” to programmatically identify hooked functions.  
- For evasion, they demonstrate replacing hooked Win32/API usage with direct syscalls (via C# delegates) and propose “dynamic evasion”: a stager reports hook status to a server that generates/compiles a stage using only unhooked APIs or syscalls for hooked ones.  
- The SHAPESHIFTER prototype implements this staged, per-host adaptive payload generation, and the post closes with defensive notes on alternative detection choke points (kernel telemetry, ETW, network, signatures).

Technical Focus:
- User-mode API hooking of `ntdll.dll` Native APIs (trampolines / inline patches)
- x64 Windows syscall stub patterns and hook detection via byte/instruction inspection
- Direct syscalls from .NET (delegates / dynamic invoke concepts)
- Staged payload architecture with per-host adaptive compilation (`ICodeCompiler`)
- Frida-based function hooking to emulate EDR telemetry collection
- Defensive telemetry gaps: ETW providers, kernel vs user-mode visibility

Use Cases:
- Build payloads that automatically adapt to EDR user-mode hook coverage on a target
- Research/validate which Native APIs are hooked in a given process/environment
- Prototype EDR-like user-mode telemetry collection using Frida for testing
- Reduce reliance on syscall-heavy implementations by only using syscalls when needed
- Inform blue-team threat modeling by enumerating “sensor blind spots” and choke points

Keywords:
EDR evasion, user-mode hooks, ntdll.dll, Native API, NtAllocateVirtualMemory, NtOpenProcess, syscall stub, SYSCALL, trampoline, inline patching, Frida, Detours, MinHook, D/Invoke, SysWhispers, C# delegates, .NET Framework, ICodeCompiler, staged payload, SHAPESHIFTER, ETW, Microsoft-Windows-Threat-Intelligence, AMSI, process injection, CreateRemoteThread