Title:
Evading Elastic EDR’s call stack signatures with call gadgets

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post shows a practical evasion of Elastic EDR detections that rely on kernel/ETW-derived call stack “signatures” to flag sensitive operations originating from unbacked (shellcode) memory.  
- The author targets a specific rule that detects DLL loads (e.g., wininet/winhttp/ws2_32) performed via callback-based API proxying, where the call stack summary matches a known pattern.  
- The technique inserts an additional, benign module frame into the call stack by jumping into a “call gadget” (a `call reg` followed shortly by `ret`) inside a non-flagged DLL, breaking the exact stack signature Elastic matches on.  
- A PoC uses Windows Thread Pool callbacks (`TpAllocWork`/`TpPostWork`) and a custom assembly stub that `jmp`s to the gadget (so the stub doesn’t appear as a caller), then the gadget performs the `call` into `LoadLibraryA`.  
- The post also covers how to hunt suitable gadgets across System32 DLLs with objdump/grep and discusses the operational fragility of gadgets across Windows versions/patches (using Winbindex to source older DLL builds).  
- Useful for red teamers/implant developers researching call stack–based telemetry evasion, and for defenders wanting to understand blind spots and harden stack-signature detections.

Technical Focus:
- EDR detections based on kernel/ETW call stacks and call_stack_summary signatures  
- Unbacked memory (shellcode) and module-load telemetry (e.g., `NtMapViewOfSection`, `LdrLoadDll`)  
- Call stack manipulation via call/jmp semantics and unwind metadata (`.pdata`)  
- Callback-based API proxying using Windows Thread Pool APIs  
- Gadget hunting (`call reg` + nearby `ret`) in signed/benign modules and version stability issues  
- PoC implementation details (COFF/Crystal Palace integration, assembly stubs, stack fixups)

Use Cases:
- Evade specific Elastic rules that key off fixed call stack summaries during DLL loads
- Load network-related DLLs from shellcode without triggering “unbacked memory in stack” signatures
- Research and prototype alternative call stack shaping techniques beyond classic stack spoofing
- Build regression tests for defensive detections against call stack signature breaking
- Develop gadget discovery pipelines across Windows builds to find stable call/ret sequences

Keywords:
Elastic EDR, call stack signatures, ETW, kernel call stacks, call_stack_summary, unbacked memory, shellcode, DLL load, LoadLibraryA, LdrLoadDll, NtMapViewOfSection, Windows Thread Pool, TpAllocWork, TpPostWork, callback abuse, API proxying, call stack spoofing, call gadget, ROP gadget hunting, unwind info, .pdata, wininet.dll, winhttp.dll, ws2_32.dll, Crystal Palace, COFF, Winbindex, dsdmo.dll