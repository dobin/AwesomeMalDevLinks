# https://github.com/patrickt2017/VEHNetLoader

[Skip to content](https://github.com/patrickt2017/VEHNetLoader#start-of-content)

You signed in with another tab or window. [Reload](https://github.com/patrickt2017/VEHNetLoader) to refresh your session.You signed out in another tab or window. [Reload](https://github.com/patrickt2017/VEHNetLoader) to refresh your session.You switched accounts on another tab or window. [Reload](https://github.com/patrickt2017/VEHNetLoader) to refresh your session.Dismiss alert

{{ message }}

[patrickt2017](https://github.com/patrickt2017)/ **[VEHNetLoader](https://github.com/patrickt2017/VEHNetLoader)** Public

- [Notifications](https://github.com/login?return_to=%2Fpatrickt2017%2FVEHNetLoader) You must be signed in to change notification settings
- [Fork\\
5](https://github.com/login?return_to=%2Fpatrickt2017%2FVEHNetLoader)
- [Star\\
50](https://github.com/login?return_to=%2Fpatrickt2017%2FVEHNetLoader)


Another version of .NET loader provides capabilities of bypassing ETW and AMSI, utilizing VEH for syscalls and loading .NET assemblies


[50\\
stars](https://github.com/patrickt2017/VEHNetLoader/stargazers) [5\\
forks](https://github.com/patrickt2017/VEHNetLoader/forks) [Branches](https://github.com/patrickt2017/VEHNetLoader/branches) [Tags](https://github.com/patrickt2017/VEHNetLoader/tags) [Activity](https://github.com/patrickt2017/VEHNetLoader/activity)

[Star](https://github.com/login?return_to=%2Fpatrickt2017%2FVEHNetLoader)

[Notifications](https://github.com/login?return_to=%2Fpatrickt2017%2FVEHNetLoader) You must be signed in to change notification settings

# patrickt2017/VEHNetLoader

main

[**1** Branch](https://github.com/patrickt2017/VEHNetLoader/branches) [**0** Tags](https://github.com/patrickt2017/VEHNetLoader/tags)

[Go to Branches page](https://github.com/patrickt2017/VEHNetLoader/branches)[Go to Tags page](https://github.com/patrickt2017/VEHNetLoader/tags)

Go to file

Code

Open more actions menu

## Folders and files

| Name | Name | Last commit message | Last commit date |
| --- | --- | --- | --- |
| ## Latest commit<br>[![patrickt2017](https://avatars.githubusercontent.com/u/170862747?v=4&size=40)](https://github.com/patrickt2017)[patrickt2017](https://github.com/patrickt2017/VEHNetLoader/commits?author=patrickt2017)<br>[Implement NtQueryVirtualMemory API call](https://github.com/patrickt2017/VEHNetLoader/commit/f6a573ebc67cc34661c624ec63cf63fd19d1cbfe)<br>7 months agoJul 6, 2025<br>[f6a573e](https://github.com/patrickt2017/VEHNetLoader/commit/f6a573ebc67cc34661c624ec63cf63fd19d1cbfe) · 7 months agoJul 6, 2025<br>## History<br>[6 Commits](https://github.com/patrickt2017/VEHNetLoader/commits/main/) <br>Open commit details<br>[View commit history for this file.](https://github.com/patrickt2017/VEHNetLoader/commits/main/) 6 Commits |
| [VEHNetLoader](https://github.com/patrickt2017/VEHNetLoader/tree/main/VEHNetLoader "VEHNetLoader") | [VEHNetLoader](https://github.com/patrickt2017/VEHNetLoader/tree/main/VEHNetLoader "VEHNetLoader") | [Implement NtQueryVirtualMemory API call](https://github.com/patrickt2017/VEHNetLoader/commit/f6a573ebc67cc34661c624ec63cf63fd19d1cbfe "Implement NtQueryVirtualMemory API call") | 7 months agoJul 6, 2025 |
| [images](https://github.com/patrickt2017/VEHNetLoader/tree/main/images "images") | [images](https://github.com/patrickt2017/VEHNetLoader/tree/main/images "images") | [Update README.md](https://github.com/patrickt2017/VEHNetLoader/commit/952f2a8cd84b54547e5a05500ba67cdbcf6b312b "Update README.md") | 8 months agoJun 29, 2025 |
| [.gitattributes](https://github.com/patrickt2017/VEHNetLoader/blob/main/.gitattributes ".gitattributes") | [.gitattributes](https://github.com/patrickt2017/VEHNetLoader/blob/main/.gitattributes ".gitattributes") | [Initial commit](https://github.com/patrickt2017/VEHNetLoader/commit/57026d278d8678561b3295d8a63954aeda15120d "Initial commit") | 8 months agoJun 29, 2025 |
| [.gitignore](https://github.com/patrickt2017/VEHNetLoader/blob/main/.gitignore ".gitignore") | [.gitignore](https://github.com/patrickt2017/VEHNetLoader/blob/main/.gitignore ".gitignore") | [Initial commit](https://github.com/patrickt2017/VEHNetLoader/commit/57026d278d8678561b3295d8a63954aeda15120d "Initial commit") | 8 months agoJun 29, 2025 |
| [README.md](https://github.com/patrickt2017/VEHNetLoader/blob/main/README.md "README.md") | [README.md](https://github.com/patrickt2017/VEHNetLoader/blob/main/README.md "README.md") | [Update README.md](https://github.com/patrickt2017/VEHNetLoader/commit/952f2a8cd84b54547e5a05500ba67cdbcf6b312b "Update README.md") | 8 months agoJun 29, 2025 |
| [VEHNetLoader.sln](https://github.com/patrickt2017/VEHNetLoader/blob/main/VEHNetLoader.sln "VEHNetLoader.sln") | [VEHNetLoader.sln](https://github.com/patrickt2017/VEHNetLoader/blob/main/VEHNetLoader.sln "VEHNetLoader.sln") | [Initial commit](https://github.com/patrickt2017/VEHNetLoader/commit/57026d278d8678561b3295d8a63954aeda15120d "Initial commit") | 8 months agoJun 29, 2025 |
| [rc4\_encrypt.py](https://github.com/patrickt2017/VEHNetLoader/blob/main/rc4_encrypt.py "rc4_encrypt.py") | [rc4\_encrypt.py](https://github.com/patrickt2017/VEHNetLoader/blob/main/rc4_encrypt.py "rc4_encrypt.py") | [Initial commit](https://github.com/patrickt2017/VEHNetLoader/commit/57026d278d8678561b3295d8a63954aeda15120d "Initial commit") | 8 months agoJun 29, 2025 |
| View all files |

## Repository files navigation

# VEHNetLoader

[Permalink: VEHNetLoader](https://github.com/patrickt2017/VEHNetLoader#vehnetloader)

Another version of .NET loader provides capabilities of bypassing ETW and AMSI, utilizing VEH for syscalls and loading .NET assemblies

# Explanation

[Permalink: Explanation](https://github.com/patrickt2017/VEHNetLoader#explanation)

## Vectored Syscalls

[Permalink: Vectored Syscalls](https://github.com/patrickt2017/VEHNetLoader#vectored-syscalls)

Syscalls via Vectored Exception Handling (as known as Vectored Syscalls) run Native APIs in a form of indirect syscalls as shown below. It firstly calls the native API with address of SSN to trigger `ACCESS_VIOLATION` exception. The registered vectored exception handler will form the structure of syscalls. The RIP has stored the SSN, since we pass SSN to the address previously. We could copy RIP to EAX for SSN and set RIP to the address of the stub syscall instruction from a Native API (e.g. `NtDrawText()` in this case).

```
mov r10, rcx
mov eax, [SSN]
syscall
```

It is worth noting that EDR or malware analyst may still detect our abnormal syscalls by inspecting the call stack of the native API, since the caller address (syscall) is in the memory region of `NtDrawText()` instead of that of the original native API.

[![](https://github.com/patrickt2017/VEHNetLoader/raw/main/images/Syscalls_VEH_concept.png)](https://github.com/patrickt2017/VEHNetLoader/blob/main/images/Syscalls_VEH_concept.png)
(Reference: [https://redops.at/en/blog/syscalls-via-vectored-exception-handling](https://redops.at/en/blog/syscalls-via-vectored-exception-handling))

## ETW Patching

[Permalink: ETW Patching](https://github.com/patrickt2017/VEHNetLoader#etw-patching)

ETW providers usually call common WinAPIs such as `EtwEventWrite` and `EtwEventWriteFull` to pass the events to ETW tracing session. At the end, The Native API `NtTraceEvent` is called by these ETW functions. Hence, We could directly apply byte patching to replace its SSN to a dummy value to cause the syscall failure.

[![](https://github.com/patrickt2017/VEHNetLoader/raw/main/images/ETW-Patch.png)](https://github.com/patrickt2017/VEHNetLoader/blob/main/images/ETW-Patch.png)

For ETW CLR providers, please refer to Microsoft's documentation: [https://learn.microsoft.com/en-us/dotnet/framework/performance/clr-etw-providers](https://learn.microsoft.com/en-us/dotnet/framework/performance/clr-etw-providers).

## AMSI Patching

[Permalink: AMSI Patching](https://github.com/patrickt2017/VEHNetLoader#amsi-patching)

Practical Securiy Analytics LLC has discussed Microsoft's new behavior detection signature protecting AMSI API in [https://practicalsecurityanalytics.com/obfuscating-api-patches-to-bypass-new-windows-defender-behavior-signatures/](https://practicalsecurityanalytics.com/obfuscating-api-patches-to-bypass-new-windows-defender-behavior-signatures/).

The new technique is to overwrite the string `AmsiScanBuffer` in `.rdata` section of CLR.dll with dummy values, so that it will trigger an error in `GetProcAddress` function call and CLR.dll cannot resolve the method from amsi.dll.

Moreover, AMSI is responsible to scan any assembly content during reflective assembly loads in CLR environment, hence bypassing AMSI here is critical for us to avoid being detected by AMSI and EDR.

[![](https://github.com/patrickt2017/VEHNetLoader/raw/main/images/AMSI-Patch.png)](https://github.com/patrickt2017/VEHNetLoader/blob/main/images/AMSI-Patch.png)

## RC4 Encryption

[Permalink: RC4 Encryption](https://github.com/patrickt2017/VEHNetLoader#rc4-encryption)

Other encryption algorithms, such as AES or XOR, should also be applicable, since the primary purpose is to protect our payload placed on disk against EDR detection. Without bypassing techniques, the payload could still be possibily detected when decrypted and loaded into memory regions in the current process.

## CLR Hosting

[Permalink: CLR Hosting](https://github.com/patrickt2017/VEHNetLoader#clr-hosting)

The .NET loader references to a few resoruces in the resource and credits section for me to understand and implement CLR hosting to load .NET assemblies and invoke the EntryPoint in the assembly with the user-provided arguments. Throughout reading materials, both `Load_3` and `Invoke_3` API calls require to pass a byte array (`SAFEARRAY`) as an argument.

`Load_3`:

[![](https://github.com/patrickt2017/VEHNetLoader/raw/main/images/CLR-Load_3.png)](https://github.com/patrickt2017/VEHNetLoader/blob/main/images/CLR-Load_3.png)

`Invoke_3`:

[![](https://github.com/patrickt2017/VEHNetLoader/raw/main/images/CLR-Invoke_3.png)](https://github.com/patrickt2017/VEHNetLoader/blob/main/images/CLR-Invoke_3.png)

# Usage

[Permalink: Usage](https://github.com/patrickt2017/VEHNetLoader#usage)

```
.\VEHNetLoader.exe -pe <payload> -key <key> -parm <arguments>
```

An example...

Sophos EDR:
[![](https://github.com/patrickt2017/VEHNetLoader/raw/main/images/Sophos-EDR.png)](https://github.com/patrickt2017/VEHNetLoader/blob/main/images/Sophos-EDR.png)

# Resources and Credits

[Permalink: Resources and Credits](https://github.com/patrickt2017/VEHNetLoader#resources-and-credits)

Special Thanks to the following resources for me to learn a lot of writing .NET loaders and bypassing techniques.

1. Basics of Loading .NET assemblies using C
   - HostingCLR: [https://github.com/etormadiv/HostingCLR](https://github.com/etormadiv/HostingCLR)
   - Being-A-Good-CLR-Host: [https://github.com/passthehashbrowns/Being-A-Good-CLR-Host](https://github.com/passthehashbrowns/Being-A-Good-CLR-Host)
2. Existing .NET Loaders (especially for loading user-controlled arguments into .Net assemblies)
   - BetterNetLoader: [https://github.com/racoten/BetterNetLoader](https://github.com/racoten/BetterNetLoader)
   - PatchedCLRLoader: [https://github.com/alexlee820/PatchedCLRLoader](https://github.com/alexlee820/PatchedCLRLoader)
3. AMSI Bypass to prevent runtime loading .NET modules into Anti-virus - Practical Security Analytics LLC: [https://practicalsecurityanalytics.com/new-amsi-bypss-technique-modifying-clr-dll-in-memory/](https://practicalsecurityanalytics.com/new-amsi-bypss-technique-modifying-clr-dll-in-memory/)
4. ETW Patching - AMSI-ETW-Patch: [https://github.com/Mr-Un1k0d3r/AMSI-ETW-Patch](https://github.com/Mr-Un1k0d3r/AMSI-ETW-Patch)
5. Syscalls via Vectored Exception Hanlding - RedOps: [https://redops.at/en/blog/syscalls-via-vectored-exception-handling](https://redops.at/en/blog/syscalls-via-vectored-exception-handling)

# Disclaimer

[Permalink: Disclaimer](https://github.com/patrickt2017/VEHNetLoader#disclaimer)

This tool is developed for learning purposes only. Do not use this tool for any illegal, unauthorized or malicious activities.

## About

Another version of .NET loader provides capabilities of bypassing ETW and AMSI, utilizing VEH for syscalls and loading .NET assemblies


### Resources

[Readme](https://github.com/patrickt2017/VEHNetLoader#readme-ov-file)

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/patrickt2017/VEHNetLoader).

[Activity](https://github.com/patrickt2017/VEHNetLoader/activity)

### Stars

[**50**\\
stars](https://github.com/patrickt2017/VEHNetLoader/stargazers)

### Watchers

[**2**\\
watching](https://github.com/patrickt2017/VEHNetLoader/watchers)

### Forks

[**5**\\
forks](https://github.com/patrickt2017/VEHNetLoader/forks)

[Report repository](https://github.com/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fpatrickt2017%2FVEHNetLoader&report=patrickt2017+%28user%29)

## [Releases](https://github.com/patrickt2017/VEHNetLoader/releases)

No releases published

## [Packages\  0](https://github.com/users/patrickt2017/packages?repo_name=VEHNetLoader)

No packages published

## Languages

- [C95.3%](https://github.com/patrickt2017/VEHNetLoader/search?l=c)
- [Python4.7%](https://github.com/patrickt2017/VEHNetLoader/search?l=python)

You can’t perform that action at this time.