# https://www.okiok.com/achieving-dll-side-loading-in-the-original-process/

<!DOCTYPE html><html lang="en-US" class="wf-loading wf-montserrat-i1-loading wf-montserrat-i2-loading wf-montserrat-i3-loading wf-montserrat-i4-loading wf-montserrat-i5-loading wf-montserrat-i6-loading wf-montserrat-i7-loading wf-montserrat-i8-loading wf-montserrat-i9-loading wf-montserrat-n1-loading wf-montserrat-n2-loading wf-montserrat-n3-loading wf-montserrat-n4-loading wf-montserrat-n5-loading wf-montserrat-n6-loading wf-montserrat-n7-loading wf-montserrat-n8-loading wf-montserrat-n9-loading Chrome Chrome142 cssanimations csstransitions no-touchevents"><body data-rsssl="1" class="post-template-default single single-post postid-25241 single-format-standard wpb-js-composer js-comp-ver-8.7.2.1 vc_responsive" itemscope="itemscope" itemtype="https://schema.org/WebPage" data-adminbar="">
<div id="top-of-page"></div><div id="mk-boxed-layout"><div id="mk-theme-container" style="position: relative;"><div id="theme-page" class="master-holder blog-post-type-image blog-style-compact clearfix" itemscope="itemscope" itemtype="https://schema.org/Blog"><div class="master-holder-bg-holder"><div id="theme-page-bg" class="master-holder-bg js-el"></div></div><div class="mk-main-wrapper-holder"><div id="mk-page-id-25241" class="theme-page-wrapper mk-main-wrapper mk-grid right-layout false"><div class="theme-content false" itemprop="mainEntityOfPage"><article id="25241" class="mk-blog-single post-25241 post type-post status-publish format-standard hentry category-blog tag-dll tag-implant tag-injection tag-payload tag-red-team tag-red-teaming tag-sideloading" itemscope="itemscope" itemprop="blogPost" itemtype="http://schema.org/BlogPosting"><div class="blog-single-meta"><div class="mk-blog-author" itemtype="http://schema.org/Person" itemprop="author">By <a href="https://www.okiok.com/author/gcaille/" title="Posts by Guillaume Caillé" rel="author">Guillaume Caillé</a></div>
<time class="mk-post-date" datetime="2024-03-19" itemprop="datePublished">
&nbsp;Posted <a href="https://www.okiok.com/2024/03/">March 19, 2024</a>
</time><div class="mk-post-cat">&nbsp;In <a href="https://www.okiok.com/category/blog/" rel="category tag">Blog</a></div><div class="mk-post-meta-structured-data" style="display:none;visibility:hidden;"><span itemprop="headline">Achieving DLL Side-Loading in the Original Process</span><span itemprop="datePublished">2024-03-19</span><span itemprop="dateModified">2024-03-19</span><span itemprop="publisher" itemscope="" itemtype="https://schema.org/Organization"><span itemprop="logo" itemscope="" itemtype="https://schema.org/ImageObject"><span itemprop="url">/wp-content/uploads/2016/09/stick-logo2.png</span></span><span itemprop="name">Okiok</span></span><span itemprop="image" itemscope="" itemtype="https://schema.org/ImageObject"><span itemprop="contentUrl url">/wp-content/uploads/2016/09/stick-logo2.png</span><span itemprop="width">200px</span><span itemprop="height">200px</span></span></div></div><div class="single-social-section">
<a href="https://www.okiok.com/achieving-dll-side-loading-in-the-original-process/#comments" class="blog-modern-comment"><svg class="mk-svg-icon" data-name="mk-moon-bubble-9" data-cacheid="icon-69917ea411095" style=" height:16px; width: 16px; " xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M464 0h-416c-26.4 0-48 21.6-48 48v320c0 26.4 21.6 48 48 48h109.714l82.286 96 82.286-96h141.714c26.4 0 48-21.6 48-48v-320c0-26.4-21.599-48-48-48zm-16 352h-139.149l-68.851 77.658-68.85-77.658h-107.15v-288h384v288z"></path></svg><span> 0</span></a>
<a class="mk-blog-print" href="https://www.okiok.com/achieving-dll-side-loading-in-the-original-process/#" title="Print"><svg class="mk-svg-icon" data-name="mk-moon-print-3" data-cacheid="icon-69917ea4111f8" style=" height:16px; width: 16px; " xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M448 288v128h-384v-128h-64v192h512v-192zm-32-256h-320v352h320v-352zm-64 288h-192v-32h192v32zm0-96h-192v-32h192v32zm0-96h-192v-32h192v32z"></path></svg></a><div class="clearboth"></div></div><div class="clearboth"></div><div class="mk-single-content clearfix" itemprop="mainEntityOfPage"><h3><u>Introduction</u></h3><p>DLL side loading has been used for quite some time now to achieve code execution in a trusted signed process. It has been extensively discussed in other blogs, so I invite you to read them first as I won’t repeat that here. The easy and most popular way to do it is by placing code into DllMain to do remote shellcode injection once the DLL gets loaded into a process.</p><p>Remote injection has been less and less easy to do in the recent time against good EDRs, but it is still doable using recent techniques, for example, how “Pool Party” is doing it at this time.</p><p>Local execution of the shellcode in the original process by jumping to its beginning remains a more stable and OPSEC approach in most scenarios, but it comes with a limitation when doing DLL side-loading, namely the “Loader Lock”. In essence, being inside the loader lock means being significantly restricted as per which functions that can be called in that state.</p><p><img decoding="async" class="size-full wp-image-25242 aligncenter" src="https://www.okiok.com/wp-content/uploads/2024/03/dll_order.png" alt="" width="113" height="279"></p><p style="text-align: center;">Figure 1 source: https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-best-practices</p><p>This is because most C2 shellcodes, like Cobalt Strike’s, will attempt to load other DLLs during initialization, which is not permitted nor recommended inside the loader lock. This will result, most of the time, in a blocked process and no shell.</p><p>So, what are our options? Some people are creating a separate thread and executing from there with success, but it is not a <a href="https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-best-practices#:~:text=You%20should%20never%20perform%20the%20following%20tasks%20from%20within%20DllMain%3A">recommended solution</a> as per Microsoft because, depending on what is done in that thread, it can create a deadlock or a crash. I personally never use DllMain to do side-loading and prefer to reimplement and export the first method that is exported by the legitimate DLL and called by the side-loaded process. This is notably useful in scenarios where you don’t want to have the original program display any visual indicator to the potentially currently logged-in user and where completely hijacking the program functionality is what is desired.</p><p>This blog post will present the methodology I use to find good candidates and how to circumvent problems that might arise when compiling.</p><h3><u>Finding Side-Loadable Candidates</u></h3><p>First, I fire up Process Monitor with the usual parameters to find DLLs which are first searched in the current directory but not found.</p><p><img fetchpriority="high" decoding="async" class="size-full wp-image-25251 aligncenter" src="https://www.okiok.com/wp-content/uploads/2024/03/procmon_filter.png" alt="" width="624" height="240"></p><p>Then, I start executing arbitrary signed binaries on my test system until I see a missing DLL that is attempted to be loaded from the testing folder:</p><p><img decoding="async" class="size-full wp-image-25245 aligncenter" src="https://www.okiok.com/wp-content/uploads/2024/03/procmon.png" alt="" width="1023" height="290"></p><p>&nbsp;</p><p>The ideal candidates are signed binaries that can be launched without requiring dozens of other files in the same folder architecture to make them more portable.</p><p>In this example, I found an HP related binary that seemed to be vulnerable to side-loading when placing a custom VERSION.dll in the same folder. OPSEC wise, however, version.dll is a common target for detections and should be avoided for real life scenarios, if possible.</p><h3><u>Finding Hijackable Exported Functions</u></h3><p>Then, using API Monitor (some people prefer to use Frida here, but in this case, I find it’s easier to just use this tool), it is possible to see what functions are called by the original signed process from the target DLL by filtering on GetProcAddress and LoadLibrary function calls. Here, there were three functions looked up in the target DLL.</p><p><img loading="lazy" decoding="async" class="size-large wp-image-25254 aligncenter" src="https://www.okiok.com/wp-content/uploads/2024/03/sideloading-apimonitor.png" alt="" width="1024" height="358"></p><p>In the use cases I described at the beginning of this post, its ideal to hijack the first function that gets called and jump directly to the shellcode to eliminate the need to reimplement anything from the original DLL.</p><p>In this case, with Microsoft’s documentation for <a href="https://learn.microsoft.com/en-us/windows/win32/api/winver/nf-winver-verqueryvaluew">VerQueryValueW</a>, It is possible to confirm which one is called first: “<em>Retrieves specified version information from the specified version-information resource. To retrieve the appropriate resource, <strong>before you call VerQueryValue, you must first call the </strong></em><a href="https://learn.microsoft.com/en-us/windows/desktop/api/winver/nf-winver-getfileversioninfosizea"><strong><em>GetFileVersionInfoSize</em></strong></a><strong><em> function, and then the </em></strong><a href="https://learn.microsoft.com/en-us/windows/desktop/api/winver/nf-winver-getfileversioninfoa"><strong><em>GetFileVersionInfo</em></strong></a><strong><em> function.</em></strong>” This also matches what can be seen from API Monitor.</p><h3><u>Writing the Payload</u></h3><p>At this point I now know what name I should give my DLL, and which exported function name to use. It is time to write the malicious code and compile it.</p><p>For that, it is only important to mimic the original function signature. In this case, since it comes from a system DLL, the function signature can be found on MSDN.</p><p><img loading="lazy" decoding="async" class="size-full wp-image-25258 aligncenter" src="https://www.okiok.com/wp-content/uploads/2024/03/msdn.png" alt="" width="624" height="157"></p><p>Due to personal preferences, the current example will be using the Nim-Lang equivalent. Here is the final code:</p><p><img loading="lazy" decoding="async" class="size-full wp-image-25261 aligncenter" src="https://www.okiok.com/wp-content/uploads/2024/03/nim-code-final.png" alt="" width="1005" height="439"></p><p>In this version, nothing is being done in DllMain at initialization, but the local injection code would be executed shortly after “GetFileVersionInfoSizeW” is called.</p><p>After compilation, it is a good idea to make sure the DLL correctly exports the desired function:</p><p><img loading="lazy" decoding="async" class="size-full wp-image-25264 aligncenter" src="https://www.okiok.com/wp-content/uploads/2024/03/show_export_filtered.png" alt="" width="616" height="356"></p><h3><u>Tricking the compiler</u></h3><p>Sometimes, and as it is the case in this example, the compiler will prevent compilation since the target function name being exported is already defined in one of its files:</p><p><img loading="lazy" decoding="async" class="size-large wp-image-25267 aligncenter" src="https://www.okiok.com/wp-content/uploads/2024/03/compiler-idiot-filtered.png" alt="" width="1024" height="253"></p><p>The easy way to circumvent this problem is to temporarily comment that function in the compiler’s file and try again. If cross compiling from Linux, the following file needs to be modified: <em>/usr/share/mingw-w64/include/winver.h</em></p><p><img loading="lazy" decoding="async" class="size-full wp-image-25273 aligncenter" src="https://www.okiok.com/wp-content/uploads/2024/03/compiler-tricked-filtered-1.png" alt="" width="624" height="105"></p><p>The resulting files:</p><p><img loading="lazy" decoding="async" class="size-full wp-image-25276 aligncenter" src="https://www.okiok.com/wp-content/uploads/2024/03/compiled_files.png" alt="" width="628" height="60"></p><h3><u>Conclusion</u></h3><p>Using this method, I find it is trivial to successfully implement DLL side-loading in the original process while always avoiding DllMain and its deadlock limitation.</p><p>If you have been struggling with this, or just starting out playing with DLL side-loading, I hope this saves you time. Enjoy your shells!</p><p><img loading="lazy" decoding="async" class="size-large wp-image-25279 aligncenter" src="https://www.okiok.com/wp-content/uploads/2024/03/beacon.png" alt="" width="1024" height="111"></p></div><div class="single-post-tags">
<a href="https://www.okiok.com/tag/dll/" rel="tag">dll</a>, <a href="https://www.okiok.com/tag/implant/" rel="tag">implant</a>, <a href="https://www.okiok.com/tag/injection/" rel="tag">injection</a>, <a href="https://www.okiok.com/tag/payload/" rel="tag">payload</a>, <a href="https://www.okiok.com/tag/red-team/" rel="tag">red team</a>, <a href="https://www.okiok.com/tag/red-teaming/" rel="tag">red teaming</a>, <a href="https://www.okiok.com/tag/sideloading/" rel="tag">sideloading</a></div><div class="mk-post-meta-structured-data" style="display:none;visibility:hidden;"></div><div class="mk-about-author-wrapper"><div class="mk-about-author-meta" itemprop="author" itemscope="itemscope" itemtype="https://schema.org/Person"><div class="avatar-wrapper"><img alt="Guillaume Caillé" src="https://www.okiok.com/wp-content/litespeed/avatar/05c911273f8738d2141d8876ff7ddc4e.jpg?ver=1770953738" class="avatar avatar-65 photo" height="65" width="65" loading="lazy" decoding="async"></div>
<a class="about-author-name" href="https://www.okiok.com/author/gcaille/" itemprop="url"><span itemprop="name">Guillaume Caillé</span></a><div class="about-author-desc"></div><ul class="about-author-social"><li><a class="email-icon" title="Get in touch with me via email" href="mailto:gcaille@okiok.com" target="_blank"><svg class="mk-svg-icon" data-name="mk-moon-envelop" data-cacheid="icon-69917ea412ca4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M480 64h-448c-17.6 0-32 14.4-32 32v320c0 17.6 14.4 32 32 32h448c17.6 0 32-14.4 32-32v-320c0-17.6-14.4-32-32-32zm-32 64v23l-192 113.143-192-113.143v-23h384zm-384 256v-177.286l192 113.143 192-113.143v177.286h-384z"></path></svg></a></li></ul></div><div class="clearboth"></div></div><section id="comments"><div id="respond" class="comment-respond"><h3 id="reply-title" class="comment-reply-title"><div class="respond-heading">Leave a Comment</div> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://www.okiok.com/achieving-dll-side-loading-in-the-original-process/#respond" style="display:none;">Cancel reply</a></small></h3><form action="https://www.okiok.com/wp-comments-post.php" method="post" id="commentform" class="comment-form"><div class="comment-textarea"><textarea placeholder="LEAVE YOUR COMMENT" class="textarea" name="comment" rows="8" id="comment" tabindex="666" required="required"></textarea></div><div class="comment-form-name comment-form-row"><input type="text" name="author" value="" class="text_input" id="author" tabindex="666" placeholder="Name *" required="required" maxlength="245"></div><div class="comment-form-email comment-form-row"><input type="email" name="email" class="text_input" id="email" tabindex="667" placeholder="Email *" value="" required="required" maxlength="100"></div><div class="comment-form-website comment-form-row"><input type="url" name="url" class="text_input" id="url" tabindex="668" placeholder="Website" value="" maxlength="200"></div><div class="comment-form-cookies-consent"><input id="wp-comment-cookies-consent" tabindex="669" name="wp-comment-cookies-consent" type="checkbox" value="yes"><label for="wp-comment-cookies-consent">Save my name, email, and website in this browser for the next time I comment.</label></div><p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="POST COMMENT"> 
</p><div id="altEmail_container" class="altEmail_container"><label for="alt_s">Alternative:</label><input type="text" id="alt_s" name="alt_s"></div><span class="wpa_hidden_field" style="display:none;height:0;width:0;"><label>WPA <input type="text" name="fvurgd4420" value="122909"></label></span></form></div></section></article><div class="clearboth"></div></div><div class="clearboth"></div></div></div></div><section id="mk-footer-unfold-spacer"></section><section id="mk-footer" class="" role="contentinfo" itemscope="itemscope" itemtype="https://schema.org/WPFooter"><div class="footer-wrapper mk-grid"><div class="mk-padding-wrapper"><div class="mk-col-1-3"></div><div class="mk-col-2-3 last"><div class="mk-col-1-4"></div><div class="mk-col-1-4"></div><div class="mk-col-1-4"></div><div class="mk-col-1-4"></div></div><div class="clearboth"></div></div></div><div class="foot-custom"><ul><li><a href="https://www.economie.gouv.qc.ca/accueil/?no_cache=1" target="_blank"><img src="https://www.okiok.com/wp-content/uploads/2016/08/performe_signature_entreprises_renv.png" alt=""></a></li><li><a href="http://www.intertek.com/auditing/iso-9001/" target="_blank"><img src="https://www.okiok.com/wp-content/uploads/2019/03/intertek-iso-9001-2015.png" style="width:75px;" alt=""></a></li><li style="width:85px;"><a href="https://www.aicpa.org/soc4so" target="_blank"><img src="https://www.okiok.com/wp-content/uploads/2025/06/aicpa-soc.png" alt=""></a></li><li><a href="http://www.bureausecuriteprivee.qc.ca/" target="_blank"><img src="https://www.okiok.com/wp-content/uploads/2016/08/bureau-securite-publique.png" alt=""></a></li><li><a href="https://www.okiok.com/feed/rss/" target="_blank"><img src="https://www.okiok.com/wp-content/uploads/2016/08/rss-1.png" alt=""></a></li></ul></div><div id="sub-footer"><div class=" mk-grid">
<span class="mk-footer-copyright">RAC/M, RAC/M Identity, S-Filer, S-Filer Portal, S-Filer Cloud and Okiok MDR are registered trademarks of OKIOK Data ltd.
All other trademarks are the property of their respective owners.
© 2026 OKIOK. </span></div><div class="clearboth"></div></div></section><div class="resize-triggers"><div class="expand-trigger"><div style="width: 1905px; height: 13230px;"></div></div><div class="contract-trigger"></div></div></div></div><div class="bottom-corner-btns js-bottom-corner-btns"><a href="https://www.okiok.com/achieving-dll-side-loading-in-the-original-process/#top-of-page" class="mk-go-top  js-smooth-scroll js-bottom-corner-btn js-bottom-corner-btn--back">
<svg class="mk-svg-icon" data-name="mk-icon-chevron-up" data-cacheid="icon-69917ea41e26d" style=" height:16px; width: 16px; " xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M1683 1331l-166 165q-19 19-45 19t-45-19l-531-531-531 531q-19 19-45 19t-45-19l-166-165q-19-19-19-45.5t19-45.5l742-741q19-19 45-19t45 19l742 741q19 19 19 45.5t-19 45.5z"></path></svg></a></div><div class="mk-fullscreen-search-overlay">
<a href="https://www.okiok.com/achieving-dll-side-loading-in-the-original-process/#" class="mk-fullscreen-close"><svg class="mk-svg-icon" data-name="mk-moon-close-2" data-cacheid="icon-69917ea41e423" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M390.628 345.372l-45.256 45.256-89.372-89.373-89.373 89.372-45.255-45.255 89.373-89.372-89.372-89.373 45.254-45.254 89.373 89.372 89.372-89.373 45.256 45.255-89.373 89.373 89.373 89.372z"></path></svg></a><div class="mk-fullscreen-search-wrapper"><p>Start typing and press Enter to search</p><form method="get" id="mk-fullscreen-searchform" action="https://www.okiok.com/">
<input type="text" value="" name="s" id="mk-fullscreen-search-input">
<i class="fullscreen-search-icon"><svg class="mk-svg-icon" data-name="mk-icon-search" data-cacheid="icon-69917ea41e51b" style=" height:25px; width: 23.214285714286px; " xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1664 1792"><path d="M1152 832q0-185-131.5-316.5t-316.5-131.5-316.5 131.5-131.5 316.5 131.5 316.5 316.5 131.5 316.5-131.5 131.5-316.5zm512 832q0 52-38 90t-90 38q-54 0-90-38l-343-342q-179 124-399 124-143 0-273.5-55.5t-225-150-150-225-55.5-273.5 55.5-273.5 150-225 225-150 273.5-55.5 273.5 55.5 225 150 150 225 55.5 273.5q0 220-124 399l343 343q37 37 37 90z"></path></svg></i></form></div></div> 


<div style="position: absolute; z-index: -10000; top: 0px; left: 0px; right: 0px; height: 19106px;"></div><div style="clear: both;"></div></body></html><!-- Page optimized by LiteSpeed Cache @2026-02-15 03:07:00 --><!-- Page supported by LiteSpeed Cache 7.7 on 2026-02-15 03:07:00 -->