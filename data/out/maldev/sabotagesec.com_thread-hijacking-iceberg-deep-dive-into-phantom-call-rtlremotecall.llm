Title:
Thread Hijacking Iceberg: Deep Dive into Phantom Call & RtlRemoteCall

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post analyzes “Phantom Call,” a thread-hijacking technique that executes chosen APIs/functions inside a remote process by switching a victim thread onto a newly allocated, attacker-crafted stack for stability.  
- It explains why x64 stack alignment (16-byte at call boundaries) is critical, showing how misalignment can crash targets when CRT/SIMD instructions (e.g., MOVDQA in ucrtbase) touch unaligned stack memory.  
- The author demonstrates crafting a valid x64 call frame: using RCX/RDX/R8/R9 for the first four args, placing additional args after the 32-byte shadow space, and ensuring a safe return address.  
- A key trick is using an ntdll infinite-loop gadget (EB FE …) to “stabilize” volatile fastcall registers while preparing the stack/context.  
- The second half reverse-engineers the undocumented ntdll!RtlRemoteCall on x86 and x64, detailing its CFG/argument-count limitations, and how PassContext/AlreadySuspended affect context/argument handling (including non-volatile register usage on x64).  
- It concludes with a “weaponization” pattern: pass a single pointer to a buffer containing restore CONTEXT + function pointer + args, run a small callsite stub, then restore execution via NtContinue.

Technical Focus:
- Windows thread hijacking via GetThreadContext/SetThreadContext (and Nt* equivalents)
- x64 Windows calling convention: shadow space, argument passing, stack alignment
- Remote stack crafting with VirtualAllocEx/WriteProcessMemory
- SIMD alignment faults (MOVDQA vs MOVDQU) and CRT/ucrtbase behavior
- Undocumented ntdll!RtlRemoteCall internals (x86 vs x64), PassContext semantics
- Restoring execution with NtContinue / context restoration

Use Cases:
- Execute Win32/NT APIs in a remote process without creating a new remote thread
- More stable “thread execution redirection” compared to naive RIP-only hijacks
- Build custom in-process call stubs for post-exploitation (function invocation + clean return)
- Research/detection engineering around thread-context tampering and remote stack pivots
- Understanding/abusing RtlRemoteCall constraints (CFG checks, max 4 args) and bypassing via argument-buffer indirection

Keywords:
thread hijacking, Phantom Call, RtlRemoteCall, ntdll.dll, GetThreadContext, SetThreadContext, NtGetContextThread, ZwSetContextThread, NtWriteVirtualMemory, VirtualAllocEx, WriteProcessMemory, x64 calling convention, shadow space, stack pivot, RSP alignment, RCX RDX R8 R9, non-volatile registers, R12 R13 R14 R15, R11, NtContinue, Control Flow Guard, CFG, ucrtbase.dll, MOVDQA, MOVDQU, XMM, SIMD, WOW64_CONTEXT, CONTEXT structure