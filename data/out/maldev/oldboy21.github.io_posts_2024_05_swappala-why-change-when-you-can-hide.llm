Title:
SWAPPALA: Why Change When You Can Hide?

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes SWAPPALA, an in-memory obfuscation technique/tool that hides malicious memory by swapping it with a legitimate “sacrificial” DLL mapping during sleep periods.  
- It targets memory scanners/EDR heuristics that flag suspicious regions (e.g., private RWX, unbacked sections, stomped modules) by restoring a clean, file-backed module view when the implant is idle.  
- The approach uses hardware breakpoints to intercept/alter NT syscalls (e.g., preventing ZwClose from closing section handles and forcing SECTION_ALL_ACCESS on section creation) to retain control over the DLL’s section mapping.  
- It enumerates process handles to locate the sacrificial DLL’s section handle, unmaps the DLL view, and maps a private malicious section at the exact same base address/size, then swaps back and forth.  
- For the “sleep” swap choreography, it adapts Ekko-style timer-queue/NtContinue ROP to call APIs needing >4 arguments by duplicating thread stacks to avoid shared-stack collisions.  
- Useful for red teamers and malware developers researching stealthy in-memory tradecraft and for blue teamers understanding how module-backed “clean” views can be reintroduced to evade snapshot scanners.

Technical Focus:
- Hardware breakpoints (HBP) for user-mode syscall interception and parameter tampering
- Section objects and memory mapping (ZwCreateSection, ZwMapViewOfSection, ZwUnmapViewOfSection)
- Sacrificial DLL mapping / module stomping avoidance via remap-at-same-address
- Handle enumeration and object queries (ZwQueryObject, SYSTEM_HANDLE traversal)
- Ekko-style sleep obfuscation using Timer Queues + NtContinue ROP
- Windows x64 calling convention / stack argument staging for ROP chains

Use Cases:
- Hiding shellcode/implant memory from on-demand memory scanners during sleep
- Swapping suspicious private mappings with legitimate file-backed module views
- Researching evasion of tools like Moneta and PE-sieve that detect unbacked/RWX regions
- Building/experimenting with syscall-level tampering via hardware breakpoints
- Developing advanced sleep/idle obfuscation routines for in-memory payloads

Keywords:
SWAPPALA, in-memory obfuscation, sacrificial DLL, section object, ZwCreateSection, ZwMapViewOfSection, ZwUnmapViewOfSection, ZwClose, ZwQueryObject, ZwQueryVirtualMemory, MemoryMappedFilenameInformation, SECTION_ALL_ACCESS, hardware breakpoints, handle enumeration, Process Hacker, Ekko, NtContinue, TimerQueue, ROP chain, MapViewOfFileEx, RWX memory, EDR evasion, Moneta, PE-sieve, module mapping, Windows internals, x64 calling convention