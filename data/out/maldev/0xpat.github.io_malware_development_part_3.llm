Title:
Malware development part 3 – anti-debugging

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post surveys practical anti-debugging techniques for 64-bit Windows malware and shows C/C++ snippets to detect or hinder interactive analysis.  
- It covers “ask the OS” checks (e.g., `IsDebuggerPresent`, `CheckRemoteDebuggerPresent`, `NtQueryInformationProcess`) and lower-level artifact checks in the PEB/heap (`BeingDebugged`, `NtGlobalFlag`, heap `Flags/ForceFlags`).  
- It demonstrates breakpoint detection via code integrity (INT3 `0xCC` scanning/checksums), hardware breakpoint detection via debug registers (`DR0–DR3`), and a working-set/COW trick using `QueryWorkingSet` to spot modified executable pages.  
- Several exception-based approaches are shown (SEH/VEH, `SetUnhandledExceptionFilter`, `DebugBreak`, `RaiseException`) to infer debugger presence or to destabilize debuggers and complicate control flow.  
- It also discusses “making analysis harder” techniques such as hiding threads from debuggers (`NtSetInformationThread`, `NtCreateThreadEx` hide flag), abusing callback-based APIs for non-linear execution, TLS callbacks for pre-`main` execution, timing checks, and optional user input blocking.  
- Useful for red teamers, malware developers, and reverse engineers/blue team analysts who need to understand common anti-analysis patterns and their limitations (e.g., differing behavior across WinDbg/VS/x64dbg).

Technical Focus:
- Windows anti-debugging via PEB/TEB and process heap artifacts
- `NtQueryInformationProcess` debug classes (DebugPort/ObjectHandle/Flags)
- Breakpoint detection (INT3 integrity checks, debug registers)
- Working set enumeration and copy-on-write/sharecount detection
- SEH/VEH and unhandled exception filter behavior under debuggers
- Thread hiding from debugger (`NtSetInformationThread`, `NtCreateThreadEx` flags), TLS callbacks

Use Cases:
- Add layered debugger detection to malware/implants to gate execution
- Build anti-analysis test cases for EDR/malware lab tooling
- Develop reverse-engineering playbooks for bypassing common anti-debug checks
- Create evasive execution flows using exceptions, callbacks, and TLS initialization
- Detect breakpoint tampering in sensitive code regions at runtime

Keywords:
Windows x64, anti-debugging, IsDebuggerPresent, CheckRemoteDebuggerPresent, PEB, BeingDebugged, NtGlobalFlag, GetProcessHeap, heap flags, NtQueryInformationProcess, ProcessDebugPort, ProcessDebugObjectHandle, ProcessDebugFlags, INT3, 0xCC, hardware breakpoints, DR0 DR1 DR2 DR3, CONTEXT_DEBUG_REGISTERS, QueryWorkingSet, copy-on-write, ShareCount, SEH, VEH, SetUnhandledExceptionFilter, DebugBreak, RaiseException, NtSetInformationThread, ThreadHideFromDebugger, NtCreateThreadEx, TLS callbacks, timing checks, BlockInput