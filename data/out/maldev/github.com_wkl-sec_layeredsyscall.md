# https://github.com/WKL-Sec/LayeredSyscall

[Skip to content](https://github.com/WKL-Sec/LayeredSyscall#start-of-content)

You signed in with another tab or window. [Reload](https://github.com/WKL-Sec/LayeredSyscall) to refresh your session.You signed out in another tab or window. [Reload](https://github.com/WKL-Sec/LayeredSyscall) to refresh your session.You switched accounts on another tab or window. [Reload](https://github.com/WKL-Sec/LayeredSyscall) to refresh your session.Dismiss alert

{{ message }}

[WKL-Sec](https://github.com/WKL-Sec)/ **[LayeredSyscall](https://github.com/WKL-Sec/LayeredSyscall)** Public

- [Notifications](https://github.com/login?return_to=%2FWKL-Sec%2FLayeredSyscall) You must be signed in to change notification settings
- [Fork\\
38](https://github.com/login?return_to=%2FWKL-Sec%2FLayeredSyscall)
- [Star\\
296](https://github.com/login?return_to=%2FWKL-Sec%2FLayeredSyscall)


Generating legitimate call stack frame along with indirect syscalls by abusing Vectored Exception Handling (VEH) to bypass User-Land EDR hooks in Windows.


[whiteknightlabs.com/2024/07/31/layeredsyscall-abusing-veh-to-bypass-edrs/](https://whiteknightlabs.com/2024/07/31/layeredsyscall-abusing-veh-to-bypass-edrs/ "https://whiteknightlabs.com/2024/07/31/layeredsyscall-abusing-veh-to-bypass-edrs/")

[296\\
stars](https://github.com/WKL-Sec/LayeredSyscall/stargazers) [38\\
forks](https://github.com/WKL-Sec/LayeredSyscall/forks) [Branches](https://github.com/WKL-Sec/LayeredSyscall/branches) [Tags](https://github.com/WKL-Sec/LayeredSyscall/tags) [Activity](https://github.com/WKL-Sec/LayeredSyscall/activity)

[Star](https://github.com/login?return_to=%2FWKL-Sec%2FLayeredSyscall)

[Notifications](https://github.com/login?return_to=%2FWKL-Sec%2FLayeredSyscall) You must be signed in to change notification settings

# WKL-Sec/LayeredSyscall

main

[**1** Branch](https://github.com/WKL-Sec/LayeredSyscall/branches) [**0** Tags](https://github.com/WKL-Sec/LayeredSyscall/tags)

[Go to Branches page](https://github.com/WKL-Sec/LayeredSyscall/branches)[Go to Tags page](https://github.com/WKL-Sec/LayeredSyscall/tags)

Go to file

Code

Open more actions menu

## Folders and files

| Name | Name | Last commit message | Last commit date |
| --- | --- | --- | --- |
| ## Latest commit<br>[![WKL-Sec](https://avatars.githubusercontent.com/u/97109724?v=4&size=40)](https://github.com/WKL-Sec)[WKL-Sec](https://github.com/WKL-Sec/LayeredSyscall/commits?author=WKL-Sec)<br>[Added link to blog post](https://github.com/WKL-Sec/LayeredSyscall/commit/19364dd361056432fb63e52679a2c13645a383a9)<br>2 years agoJul 31, 2024<br>[19364dd](https://github.com/WKL-Sec/LayeredSyscall/commit/19364dd361056432fb63e52679a2c13645a383a9) · 2 years agoJul 31, 2024<br>## History<br>[6 Commits](https://github.com/WKL-Sec/LayeredSyscall/commits/main/) <br>Open commit details<br>[View commit history for this file.](https://github.com/WKL-Sec/LayeredSyscall/commits/main/) 6 Commits |
| [FuncWrappers.cpp](https://github.com/WKL-Sec/LayeredSyscall/blob/main/FuncWrappers.cpp "FuncWrappers.cpp") | [FuncWrappers.cpp](https://github.com/WKL-Sec/LayeredSyscall/blob/main/FuncWrappers.cpp "FuncWrappers.cpp") | [Add files via upload](https://github.com/WKL-Sec/LayeredSyscall/commit/6d8f8d00dd01de2fb552b4af1c967f5805447ba9 "Add files via upload") | 2 years agoJul 29, 2024 |
| [FuncWrappers.h](https://github.com/WKL-Sec/LayeredSyscall/blob/main/FuncWrappers.h "FuncWrappers.h") | [FuncWrappers.h](https://github.com/WKL-Sec/LayeredSyscall/blob/main/FuncWrappers.h "FuncWrappers.h") | [Add files via upload](https://github.com/WKL-Sec/LayeredSyscall/commit/6d8f8d00dd01de2fb552b4af1c967f5805447ba9 "Add files via upload") | 2 years agoJul 29, 2024 |
| [HookModule.cpp](https://github.com/WKL-Sec/LayeredSyscall/blob/main/HookModule.cpp "HookModule.cpp") | [HookModule.cpp](https://github.com/WKL-Sec/LayeredSyscall/blob/main/HookModule.cpp "HookModule.cpp") | [Add files via upload](https://github.com/WKL-Sec/LayeredSyscall/commit/6d8f8d00dd01de2fb552b4af1c967f5805447ba9 "Add files via upload") | 2 years agoJul 29, 2024 |
| [HookModule.h](https://github.com/WKL-Sec/LayeredSyscall/blob/main/HookModule.h "HookModule.h") | [HookModule.h](https://github.com/WKL-Sec/LayeredSyscall/blob/main/HookModule.h "HookModule.h") | [Add files via upload](https://github.com/WKL-Sec/LayeredSyscall/commit/6d8f8d00dd01de2fb552b4af1c967f5805447ba9 "Add files via upload") | 2 years agoJul 29, 2024 |
| [README.md](https://github.com/WKL-Sec/LayeredSyscall/blob/main/README.md "README.md") | [README.md](https://github.com/WKL-Sec/LayeredSyscall/blob/main/README.md "README.md") | [Added link to blog post](https://github.com/WKL-Sec/LayeredSyscall/commit/19364dd361056432fb63e52679a2c13645a383a9 "Added link to blog post") | 2 years agoJul 31, 2024 |
| [demo.cpp](https://github.com/WKL-Sec/LayeredSyscall/blob/main/demo.cpp "demo.cpp") | [demo.cpp](https://github.com/WKL-Sec/LayeredSyscall/blob/main/demo.cpp "demo.cpp") | [Add files via upload](https://github.com/WKL-Sec/LayeredSyscall/commit/6d8f8d00dd01de2fb552b4af1c967f5805447ba9 "Add files via upload") | 2 years agoJul 29, 2024 |
| [imports.h](https://github.com/WKL-Sec/LayeredSyscall/blob/main/imports.h "imports.h") | [imports.h](https://github.com/WKL-Sec/LayeredSyscall/blob/main/imports.h "imports.h") | [Add files via upload](https://github.com/WKL-Sec/LayeredSyscall/commit/6d8f8d00dd01de2fb552b4af1c967f5805447ba9 "Add files via upload") | 2 years agoJul 29, 2024 |
| View all files |

## Repository files navigation

# LayeredSyscall

[Permalink: LayeredSyscall](https://github.com/WKL-Sec/LayeredSyscall#layeredsyscall)

Generating legitimate call stack frame along with indirect syscalls by abusing Vectored Exception Handling (VEH) to bypass User-Land EDR hooks in Windows.

Accompanying blog post can be found here: [LayeredSyscall – Abusing VEH to Bypass EDRs](https://whiteknightlabs.com/2024/07/31/layeredsyscall-abusing-veh-to-bypass-edrs/)

## Usage

[Permalink: Usage](https://github.com/WKL-Sec/LayeredSyscall#usage)

Include the files, [FuncWrappers.h](https://github.com/WKL-Sec/LayeredSyscall/blob/main/FuncWrappers.h) and [FuncWrappers.cpp](https://github.com/WKL-Sec/LayeredSyscall/blob/main/FuncWrappers.cpp) within your source code.

Make sure to initialize and destroy the hooks using the calls `IntializeHooks()` and `DestroyHooks()` at the beginning and end of your main code.

To let the tool perform the evasion add the prefix "wrp" to the start of the syscall name to be used. For eg.,

`NtCreateUserProcess() -> wrpNtCreateUserProcess()`

The user is also provided with the functionality with changing what legitimate call stack they want to use in this current version of the tool. All they got to do is to change the Windows API call within the [`demofunction()`](https://github.com/WKL-Sec/LayeredSyscall/blob/1014ff4fddb03b4370c0d113caa6d7915d472ddb/HookModule.cpp#L19) found in `HookModule.cpp`.

```
void demofunction() {
    // You can change this call to any other Windows API call you like
    MessageBox(
        NULL,
        (LPCWSTR)L"Resource not available\nDo you want to try again?",
        (LPCWSTR)L"Account Details",
        MB_ICONWARNING | MB_CANCELTRYCONTINUE | MB_DEFBUTTON2
    );
}
```

Below is a demo code to show how the tool can be used, full code can be found [here](https://github.com/WKL-Sec/LayeredSyscall/blob/main/demo.cpp).

```
int main(int argc, char* argv[]) {

	printf("[*] Program Started\n");
	IntializeHooks();

	WCHAR image_path[] = L"\\??\\C:\\Windows\\System32\\calc.exe";
	UNICODE_STRING NtImagePath;
	RtlInitUnicodeString(&NtImagePath, (PWSTR)L"\\??\\C:\\Windows\\System32\\calc.exe");

	// Create the process parameters
	PRTL_USER_PROCESS_PARAMETERS ProcessParameters = NULL;
	RtlCreateProcessParametersEx(&ProcessParameters, &NtImagePath, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, RTL_USER_PROCESS_PARAMETERS_NORMALIZED);

	// Initialize the PS_CREATE_INFO structure
	PS_CREATE_INFO CreateInfo = { 0 };
	CreateInfo.Size = sizeof(CreateInfo);
	CreateInfo.State = PsCreateInitialState;

	// Initialize the PS_ATTRIBUTE_LIST structure
	PPS_ATTRIBUTE_LIST AttributeList = (PS_ATTRIBUTE_LIST*)RtlAllocateHeap(RtlProcessHeap(), HEAP_ZERO_MEMORY, sizeof(PS_ATTRIBUTE));
	AttributeList->TotalLength = sizeof(PS_ATTRIBUTE_LIST) - sizeof(PS_ATTRIBUTE);
	AttributeList->Attributes[0].Attribute = PS_ATTRIBUTE_IMAGE_NAME;
	AttributeList->Attributes[0].Size = NtImagePath.Length;
	AttributeList->Attributes[0].Value = (ULONG_PTR)NtImagePath.Buffer;

	HANDLE hProcess, hThread = NULL;

	BOOL success = FALSE;
	LPVOID remote_base_addr = NULL;
	CONTEXT thread_context = { 0 };

	// create the target process in a suspended state so we can modify its memory and the context of its main thread
	if (wrpNtCreateUserProcess(&hProcess, &hThread, PROCESS_ALL_ACCESS, THREAD_ALL_ACCESS, NULL, NULL,
		NULL, NULL, ProcessParameters, &CreateInfo, AttributeList))
	{
		printf("CreateProcessA() Failed with error: %d\n", GetLastError());
		return -1;
	}

	DestroyHooks();
	printf("[*] Program Ended\n");
	return 1;
}
```

## Todo

[Permalink: Todo](https://github.com/WKL-Sec/LayeredSyscall#todo)

- [ ]  Provide option for global stack spoofing rather than just per api stack spoofing
- [ ]  Provide option for random legitimate Windows API calls apart from the one already in the tool

## Results

[Permalink: Results](https://github.com/WKL-Sec/LayeredSyscall#results)

### Call stack analysis

[Permalink: Call stack analysis](https://github.com/WKL-Sec/LayeredSyscall#call-stack-analysis)

Performing indirect syscall shows no legitimate call stack
[![image](https://private-user-images.githubusercontent.com/65706066/353229818-c360d8a3-9ab8-4736-bd45-3aa371ad386e.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NzE0MTI3ODgsIm5iZiI6MTc3MTQxMjQ4OCwicGF0aCI6Ii82NTcwNjA2Ni8zNTMyMjk4MTgtYzM2MGQ4YTMtOWFiOC00NzM2LWJkNDUtM2FhMzcxYWQzODZlLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAyMTglMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMjE4VDExMDEyOFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWJjNDczNDMxZWFhZTFmN2Q3OGZmMzhlOTI2YjAwZTM2Nzk3MWE1ZTNkZWQ5MTBkYzJjNjgzMGJjNTE3N2M4ODgmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.OxrMxhLefFng3yqZdY3tERRhArSnocBXQerGOQkCw3g)](https://private-user-images.githubusercontent.com/65706066/353229818-c360d8a3-9ab8-4736-bd45-3aa371ad386e.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NzE0MTI3ODgsIm5iZiI6MTc3MTQxMjQ4OCwicGF0aCI6Ii82NTcwNjA2Ni8zNTMyMjk4MTgtYzM2MGQ4YTMtOWFiOC00NzM2LWJkNDUtM2FhMzcxYWQzODZlLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAyMTglMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMjE4VDExMDEyOFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWJjNDczNDMxZWFhZTFmN2Q3OGZmMzhlOTI2YjAwZTM2Nzk3MWE1ZTNkZWQ5MTBkYzJjNjgzMGJjNTE3N2M4ODgmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.OxrMxhLefFng3yqZdY3tERRhArSnocBXQerGOQkCw3g)

Legitimate call stack after usage of the tool
[![image](https://private-user-images.githubusercontent.com/65706066/353230482-f5d79970-e699-4408-b658-97db512fd90c.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NzE0MTI3ODgsIm5iZiI6MTc3MTQxMjQ4OCwicGF0aCI6Ii82NTcwNjA2Ni8zNTMyMzA0ODItZjVkNzk5NzAtZTY5OS00NDA4LWI2NTgtOTdkYjUxMmZkOTBjLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAyMTglMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMjE4VDExMDEyOFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTU3M2E1ODk1NWJmMWM2OGYyN2NkZWVjN2U4NTkxYTE3NTExYWFhZGM5MTEyOTliZWE2MThlNzRlNDVkN2IxOWEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.5t6UuR9kMs3sWvUyrg6yMs5bSuSZmMeqspAAbn7h_Ls)](https://private-user-images.githubusercontent.com/65706066/353230482-f5d79970-e699-4408-b658-97db512fd90c.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NzE0MTI3ODgsIm5iZiI6MTc3MTQxMjQ4OCwicGF0aCI6Ii82NTcwNjA2Ni8zNTMyMzA0ODItZjVkNzk5NzAtZTY5OS00NDA4LWI2NTgtOTdkYjUxMmZkOTBjLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAyMTglMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMjE4VDExMDEyOFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTU3M2E1ODk1NWJmMWM2OGYyN2NkZWVjN2U4NTkxYTE3NTExYWFhZGM5MTEyOTliZWE2MThlNzRlNDVkN2IxOWEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.5t6UuR9kMs3sWvUyrg6yMs5bSuSZmMeqspAAbn7h_Ls)

## Potential Detections

[Permalink: Potential Detections](https://github.com/WKL-Sec/LayeredSyscall#potential-detections)

As of now, detections against this technique would require one to check for maliciously registered exception handlers within a particular program. Other detections could also include flagging anomalous stack behavior by implementing a heuristic against known call stack produced by Windows APIs.

## About

Generating legitimate call stack frame along with indirect syscalls by abusing Vectored Exception Handling (VEH) to bypass User-Land EDR hooks in Windows.


[whiteknightlabs.com/2024/07/31/layeredsyscall-abusing-veh-to-bypass-edrs/](https://whiteknightlabs.com/2024/07/31/layeredsyscall-abusing-veh-to-bypass-edrs/ "https://whiteknightlabs.com/2024/07/31/layeredsyscall-abusing-veh-to-bypass-edrs/")

### Resources

[Readme](https://github.com/WKL-Sec/LayeredSyscall#readme-ov-file)

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/WKL-Sec/LayeredSyscall).

[Activity](https://github.com/WKL-Sec/LayeredSyscall/activity)

### Stars

[**296**\\
stars](https://github.com/WKL-Sec/LayeredSyscall/stargazers)

### Watchers

[**4**\\
watching](https://github.com/WKL-Sec/LayeredSyscall/watchers)

### Forks

[**38**\\
forks](https://github.com/WKL-Sec/LayeredSyscall/forks)

[Report repository](https://github.com/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2FWKL-Sec%2FLayeredSyscall&report=WKL-Sec+%28user%29)

## [Releases](https://github.com/WKL-Sec/LayeredSyscall/releases)

No releases published

## [Packages\  0](https://github.com/users/WKL-Sec/packages?repo_name=LayeredSyscall)

No packages published

## [Contributors\  2](https://github.com/WKL-Sec/LayeredSyscall/graphs/contributors)

- [![@AmunRha](https://avatars.githubusercontent.com/u/65706066?s=64&v=4)](https://github.com/AmunRha)[**AmunRha** Adhithya Suresh Kumar](https://github.com/AmunRha)
- [![@WKL-Sec](https://avatars.githubusercontent.com/u/97109724?s=64&v=4)](https://github.com/WKL-Sec)[**WKL-Sec** White Knight Labs](https://github.com/WKL-Sec)

## Languages

- [C85.5%](https://github.com/WKL-Sec/LayeredSyscall/search?l=c)
- [C++14.5%](https://github.com/WKL-Sec/LayeredSyscall/search?l=c%2B%2B)

You can’t perform that action at this time.