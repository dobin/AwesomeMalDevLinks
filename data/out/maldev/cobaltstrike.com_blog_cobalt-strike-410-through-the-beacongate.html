# https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate

<!DOCTYPE html><html lang="en-US"><body class="wp-singular post-template-default single single-post postid-6046 single-format-standard wp-custom-logo wp-embed-responsive wp-theme-helpsystems wp-child-theme-cobalt-strike group-blog understrap-has-sidebar"><div id="consent_blackbar" lang="en">
            
            <div id="truste-consent-track" style="position: relative; z-index: 999999; border-top: 1px solid rgb(102, 102, 102);" class="ta-show ta-display-block">  <div id="truste-consent-content" style="overflow: hidden;">    <div id="truste-consent-text" class="truste-messageColumn" data-nosnippet="data-nosnippet">      <span class="hstitle">This website uses cookies. You may change your settings at any time.</span>    </div>    <div id="truste-consent-buttons" class="truste-buttonsColumn" data-nosnippet="data-nosnippet">      <span id="truste-repop-msg" style="padding: 7px 10px; background: #F9EDBE; border:1px solid #F0C36D; margin: 11px 0px 13px;font-size:11; line-height: 16px;color: #AF7501; display:none;"></span>       <button id="truste-consent-button">Accept</button>      <button id="truste-consent-required">Reject All</button>      <button id="truste-show-consent" aria-haspopup="dialog">Manage Cookies</button>    </div>  </div></div></div>
<div style="display:none;" id="teconsent" consent="undefined" aria-label="Open Cookie Preferences Modal" class="truste_caIcon_display" role="complementary"><a role="link" id="icon-id05534428134771233" tabindex="0" lang="en" aria-haspopup="dialog" aria-label="Cookie Preferences, opens a dedicated popup modal window" class="truste_cursor_pointer">Cookie Preferences</a></div>

	
<!-- TrustArc tag end -->
<!-- Google Tag Manager -->

<!-- End Google Tag Manager --><link rel="icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-32x32.png" sizes="32x32">
<link rel="icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-192x192.png" sizes="192x192">
<link rel="apple-touch-icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-180x180.png">

		
		


<!-- Google Tag Manager (noscript) -->

<!-- End Google Tag Manager (noscript) -->
<div class="site" id="page">

	<!-- ******************* The Navbar Area ******************* -->
	<!-- #wrapper-navbar -->

<div class="header-banner"> 
	<div class="jumbotron jumbotron-fluid bg-4 " style="background-image: ">
	<div class="banner-wrapper">
		<div class="container">
			<p class="yoast-breadcrumbs m-0"><span><span><a href="https://www.cobaltstrike.com/">Home</a></span> ¬ª <span><a href="https://www.cobaltstrike.com/blog/">Blog</a></span> ¬ª <span class="breadcrumb_last" aria-current="page">Cobalt Strike 4.10: Through the BeaconGate</span></span></p>							<h1>Cobalt Strike 4.10: Through the BeaconGate</h1>
								<p class="font-italic">Tuesday 16 July, 2024</p>

							</div>
	</div>
	</div>
</div>


<div class="wrapper" id="page-wrapper">

	<div class="container" id="content" tabindex="-1">
		<div class="row">
			<div class="col-lg-8 content-area" id="primary">

				<main class="site-main" id="main">
					<article class="post-6046 post type-post status-publish format-standard has-post-thumbnail hentry product_line-cobalt-strike cornerstone-development cornerstone-releases cta_type-blog" id="post-6046">


<div class="entry-content">
		
<p></p>



<p>Cobalt Strike 4.10 is now available. This release introduces BeaconGate, the Postex Kit, and Sleepmask-VS. In addition, we have overhauled the Sleepmask API, refreshed the Jobs UI, added new BOF APIs, added support for hot swapping C2 hosts, and more. This has been a longer release cycle than in previous releases to allow us to make underlying architectural changes to support our longer-term ambitions.</p>



<p><em><strong>Note:</strong> Cobalt Strike 4.10 introduces breaking changes to the update application. Licensed users will need to <a href="https://download.cobaltstrike.com/download" target="_blank" rel="noreferrer noopener">download version 4.10 from scratch</a>. The existing 4.9 update application cannot be used to upgrade to version 4.10.</em></p>



<h3 class="wp-block-heading">BeaconGate</h3>



<figure class="wp-block-image aligncenter size-full is-resized"><img fetchpriority="high" decoding="async" width="760" height="418" src="https://www.cobaltstrike.com/app/uploads/2024/07/stargate.jpg" alt="" class="wp-image-6047" style="width:669px;height:auto"></figure>



<p>Over the past few years there has been a dramatic increase in detection logic for anomalous API calls. For example, open-source projects such as <a href="https://github.com/jackullrich/syscall-detect" target="_blank" rel="noreferrer noopener">syscall-detect</a>, <a href="https://github.com/waldo-irc/MalMemDetect" target="_blank" rel="noreferrer noopener">MalMemDetect</a>, <a href="https://github.com/thefLink/Hunt-Sleeping-Beacons" target="_blank" rel="noreferrer noopener">Hunt-Sleeping-Beacons</a>, and <a href="https://github.com/hasherezade/pe-sieve/wiki/4.9.-Scan-threads-callstack-(threads)" target="_blank" rel="noreferrer noopener">pe-sieve</a> all demonstrate the value of hunting for suspicious API calls from unbacked memory. Additionally, Elastic has pushed the defensive industry forward with their <a href="https://www.elastic.co/security-labs/doubling-down-etw-callstacks" target="_blank" rel="noreferrer noopener">anomalous call stack detection logic</a> that is a formidable challenge for modern red team operations.</p>



<p>Furthermore, prior to this release, it was difficult for operators to address the challenges outlined above with Cobalt Strike. For example, it was not possible to build on Beacon‚Äôs system call implementation and the only way to obtain granular control over Beacon‚Äôs API calls was via <a href="https://github.com/kyleavery/AceLdr/blob/main/src/ace.c#L120-L141" target="_blank" rel="noreferrer noopener">IAT hooking in a UDRL,</a> which is complex and has a high barrier to entry.</p>



<p>As Cobalt Strike specialises in evasion through flexibility, this was a critical problem to solve and one of our key priorities for this release. Additionally, we wanted to provide a solution that avoided getting bogged down in complex implementation details and made it easy for users to apply custom TTPs to Beacon‚Äôs API calls. Our solution to these problems is BeaconGate.</p>



<p>At a high-level, the Sleepmask is conceptually similar to a <a href="https://en.wikipedia.org/wiki/Remote_procedure_call" target="_blank" rel="noreferrer noopener"><em>Remote Procedure Call</em></a><em> (RPC), </em>albeit within the same process address space. For example, when Beacon sleeps, it will call into the Sleepmask BOF, mask, and sleep. Beacon here acts as the ‚Äòclient‚Äô and the Sleepmask is the ‚Äòserver‚Äô that executes the Sleep call <em>on behalf</em> of Beacon. In Cobalt Strike 4.10, we have taken this idea to its logical conclusion and the Sleepmask now supports the execution of arbitrary functions. Therefore, it is now possible to configure Beacon to forward its Windows API calls to be executed via the Sleepmask (aka BeaconGate).</p>



<p>This offers operators unprecedented control and flexibility;&nbsp; we tell you what Beacon wants to call (and the arguments), and you can do what you want with it. Hence, BeaconGate gives users the ability to implement bleeding edge call stack spoofing TTPs and apply them universally to Beacon‚Äôs WinAPI calls. Additionally, as Beacon is now decoupled from its WinAPI calls, you can also mask Beacon while calling a potentially suspicious API. This is all implemented as a BOF, so you can configure different gates and <em>completely change your TTPs</em> by swapping out different Sleepmask BOFs.</p>



<p>By default, if you enable an API to be proxied via BeaconGate, Beacon will be masked while the API is executed. This means that out of the box,<em> </em>Beacon now has mask-and-call functionality. This is a useful mitigation against AV vendors who may trigger scans based on <a href="https://codemachine.com/articles/kernel_callback_functions.html" target="_blank" rel="noreferrer noopener">Kernel callbacks</a>/<a href="https://github.com/jdu2600/Windows10EtwEvents/blob/main/manifest/Microsoft-Windows-Threat-Intelligence.tsv" target="_blank" rel="noreferrer noopener">ETW TI events.</a></p>



<p>BeaconGate can be configured by setting the new <code>stage.beacon_gate</code> Malleable C2 option, as demonstrated below:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_525341" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_525341_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_525341" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">stage {‚ÄØ </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="plain">‚ÄØ‚ÄØ‚ÄØ beacon_gate {‚ÄØ </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="plain">‚ÄØ‚ÄØ‚ÄØ‚ÄØ‚ÄØ‚ÄØ&nbsp;&nbsp;&nbsp; All;‚ÄØ </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="plain">‚ÄØ‚ÄØ‚ÄØ }‚ÄØ </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="plain">}‚ÄØ </code></td></tr></tbody></table></div></div></div></div>


<p>Valid values for this option are:&nbsp;&nbsp;</p>



<ul class="wp-block-list">
<li><strong>Comms</strong> ‚Äì Currently this is <code>InternetOpenA</code> and <code>InternetConnectA</code> (i.e., HTTP(S) <a href="https://learn.microsoft.com/en-us/windows/win32/wininet/about-wininet" target="_blank" rel="noreferrer noopener">WinInet</a> Beacons only)</li>



<li><strong>Core</strong> ‚Äì This is the Windows API equivalents (i.e., <code>VirtualAlloc</code>) of Beacon‚Äôs existing <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/post-exploitation_system-calls.htm">system call API</a>. See the <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/index.htm#cshid=1007">BeaconGate documentation</a> for the full list of supported functions.</li>



<li><strong>Cleanup</strong> ‚Äì Currently this supports proxying <code>ExitThread</code> via the Sleepmask. If this is enabled, then by default the Sleepmask will scrub/free Beacon from memory before exiting. Additionally, this provides an opportunity for operators to perform custom clean up before Beacon exits.</li>



<li><strong>All</strong> ‚Äì Comms + Core + Cleanup.&nbsp;</li>
</ul>



<p>It is also possible to forward specific functions from the supported set with the following syntax:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_117064" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_117064_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_117064" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">stage {‚ÄØ </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">beacon_gate {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="plain">‚ÄØ‚ÄØ‚ÄØ‚ÄØ‚ÄØ‚ÄØ&nbsp;&nbsp;&nbsp; VirtualAlloc;‚ÄØ </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">VirtualAllocEx; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">InternetConnectA; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}‚ÄØ </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="plain">}‚ÄØ </code></td></tr></tbody></table></div></div></div></div>


<p>As a note, some more intensive Beacon commands such as <code>ps</code> may spike CPU if you have the core set enabled. This is expected behaviour, as <code>ps</code> will call <code>OpenProcess</code>/<code>CloseHandle</code> multiple times while masking. If desired, you can disable BeaconGate at runtime via <code>beacon_gate disable</code> or alternatively disable the masking for specific functions in your own Sleepmask BOF.&nbsp;</p>



<p>It is also important to point out that BeaconGate and Cobalt Strike‚Äôs existing <code>syscall_method</code> option are mutually exclusive; if you enable BeaconGate for an API, it will take precedence over system calls. However, you can enable BeaconGate for a specific API <em>and</em> use Beacon‚Äôs existing system call method for the rest. For example:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_952116" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_952116_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_952116" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">stage {‚ÄØ </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">set syscall_method "Indirect"; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">beacon_gate {‚ÄØ </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="plain">‚ÄØ‚ÄØ‚ÄØ‚ÄØ‚ÄØ&nbsp;&nbsp;&nbsp; VirtualAlloc;‚ÄØ // Only VirtualAlloc is proxied via BeaconGate </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="plain">‚ÄØ‚ÄØ‚ÄØ }‚ÄØ </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="plain">}‚ÄØ</code></td></tr></tbody></table></div></div></div></div>


<h3 class="wp-block-heading">Building On Top Of BeaconGate with Custom Sleepmask BOFs</h3>



<p>In the previous section we covered BeaconGate‚Äôs default behaviour. However, the real power comes from building on top of BeaconGate. The potential here is unlimited; your own gate can implement novel system call techniques, <a href="https://github.com/WithSecureLabs/CallStackSpoofer">spoof the call stack</a>, <a href="https://www.unknowncheats.me/forum/anti-cheat-bypass/268039-x64-return-address-spoofing-source-explanation.html">fake the return address</a>, utilize <a href="https://github.com/klezVirus/SilentMoonwalk" target="_blank" rel="noreferrer noopener">SilentMoonwalk</a>, etc. ‚Äì all while Beacon is masked (if desired).&nbsp;</p>



<p>Beacon provides the higher level WinAPI (i.e., <a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc" target="_blank" rel="noreferrer noopener">VirtualAlloc</a> as opposed to <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntallocatevirtualmemory" target="_blank" rel="noreferrer noopener">NtAllocateVirtualMemory</a>) to provide as much flexibility as possible. Hence, you can implement your own system call/gate for the NT function (e.g. something like <a href="https://github.com/thefLink/RecycledGate" target="_blank" rel="noreferrer noopener">RecycledGate)</a> or <a href="https://github.com/rsmudge/unhook-bof" target="_blank" rel="noreferrer noopener">unhook</a> and call the original WinAPI function with a spoofed call stack etc.&nbsp;<br>&nbsp;<br>To demonstrate the possibilities, below is a quick PoC of BeaconGate implementing return address spoofing (while Beacon is masked) for Beacon‚Äôs <code>InternetOpenA</code> calls:</p>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="456" src="https://www.cobaltstrike.com/app/uploads/2024/07/ret_address_spoofing_beacon_gate-1024x456.png" alt="" class="wp-image-6053"></figure>



<p class="has-small-font-size">Fig 1. A screenshot showing BeaconGate implementing return address spoofing. A breakpoint has been triggered in windbg on <code>WININET!InternetOpenA</code> and the calling thread‚Äôs call stack is displayed (via the <code>knf</code> command). The call stack shows the calling function as <code>WININET!UrlCacheFindFirstEntry</code>, however this has been spoofed; the call is being proxied via the Sleepmask. Furthermore, the PowerShell terminal displays a YARA scan on the debugged process <em>after</em> this breakpoint has been hit. This reveals no hits, as Beacon is masked while the <code>InternetOpenA</code> call is made (prior to 4.10 Beacon would be exposed in memory at this point).</p>



<p>This example demonstrates that it is now possible to evade detection logic for anomalous <code>InternetOpen/ConnectA</code> calls, such as in <a href="https://github.com/waldo-irc/MalMemDetect/blob/main/MalMemDetect/Source.cpp#L167-L188" target="_blank" rel="noreferrer noopener">MalMemDetect</a>. However, the same technique could be applied to <em>all</em> the supported WinAPI functions. Additionally, the supported APIs cover <a href="https://www.elastic.co/security-labs/doubling-down-etw-callstacks" target="_blank" rel="noreferrer noopener">the majority of detection use cases</a> for anomalous call stacks from both ETW TI events and Kernel callbacks (with some exceptions, e.g. <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa" target="_blank" rel="noreferrer noopener">CreateProcess</a>).</p>



<h3 class="wp-block-heading">Sleepmask-VS</h3>



<p>The Sleepmask is an essential part of Cobalt Strike‚Äôs evasion strategy. It started out as a tiny Position Independent Code (PIC) blob that could be stomped into Beacon. However, it has since grown into a fully featured BOF. While this change provided a huge amount of flexibility, its rapid growth has also made the Sleepmask quite complex, which means (in our experience) users often shy away from building on it. &nbsp;</p>



<p>Furthermore, in <a href="https://en.wikipedia.org/wiki/Eating_your_own_dog_food" target="_blank" rel="noreferrer noopener">dogfooding</a> BeaconGate internally, we found it difficult to write custom Sleepmask BOFs with existing tooling. Therefore, one of the aims of this release was to lower the barrier to entry for writing custom Sleepmasks.&nbsp;</p>



<p>As a result, we have updated our public <a href="https://github.com/Cobalt-Strike/bof-vs" target="_blank" rel="noreferrer noopener">BOF-VS template</a> to support Sleepmask and BeaconGate functionality. This means our BOF-VS template is now a one-stop shop for writing all the various BOFs used by Cobalt Strike.&nbsp;&nbsp;</p>



<p>Additionally, to provide a working Sleepmask BOF example we have also published <a href="https://github.com/Cobalt-Strike/sleepmask-vs" target="_blank" rel="noreferrer noopener">Sleepmask-VS</a>. This is a simple Sleepmask example that demonstrates how to use the BOF-VS template to write Sleepmask/BeaconGate BOFs. This repository will grow over time to contain a variety of different examples. In addition, it will be used as the accompanying Sleepmask BOF to the UDRL-VS loaders so that we can provide examples of how to use Cobalt Strike‚Äôs most important evasion tools together.&nbsp;</p>



<p>Sleepmask-VS contains <code>runMockedSleepMask()</code> and <code>runMockedBeaconGate()</code> to make it easy to create custom Sleepmask/BeaconGate BOFs. These two functions are similar to the original <a href="https://github.com/Cobalt-Strike/bof-vs/blob/main/BOF-Template/bof.cpp#L49" target="_blank" rel="noreferrer noopener">BOF-VS <code>runMocked()</code> function,</a> except they create a mock in-memory Beacon as well as some example heap memory. This allows users to step through their Sleepmask in the debugger and see the effects of their masking. These functions also allow users to provide their desired Malleable C2 settings to mimic the behaviour of Beacon‚Äôs default loader.&nbsp;</p>



<p>An example call to <code>runMockedSleepMask</code> can be seen below:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_705503" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_705503_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_705503" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="color1 bold">int</code> <code class="plain">main(</code><code class="color1 bold">int</code> <code class="plain">argc, </code><code class="color1 bold">char</code><code class="plain">* argv[]) { </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">bof::runMockedSleepMask(sleep_mask, </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">{ </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">.allocator = bof::profile::Allocator::VirtualAlloc, </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">.obfuscate = bof::profile::Obfuscate::False, </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">.useRWX = bof::profile::UseRWX::False, </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">.module = </code><code class="string">""</code><code class="plain">, </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}, </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">{ </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">.sleepTimeMs = 5000, </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">.runForever = </code><code class="keyword bold">true</code><code class="plain">, </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">} </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">); </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code> <code class="plain">0;</code></td></tr></tbody></table></div></div></div></div>


<p>Sleepmask-VS also provides an example of how to use the <code>runMockedBeaconGate</code> function. This function replicates Beacon invoking the Sleepmask with a BeaconGate call and also passes in mocked Beacon/heap memory to be masked. This makes it easy for operators to start developing their own custom gates.&nbsp;&nbsp;</p>



<p>For example, the sample code below demonstrates proxying a <code>VirtualAlloc</code> call through BeaconGate:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_794502" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_794502_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_794502" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="comments">// Create a FUNCTION_CALL structure</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="plain">FUNCTION_CALL functionCall = bof::mock::createFunctionCallStructure( </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">VirtualAlloc,&nbsp;&nbsp; </code><code class="comments">// Function Pointer </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">WinApi::VIRTUALALLOC, </code><code class="comments">// Human readable WinApi enum </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">TRUE, </code><code class="comments">// Mask Beacon? </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">4, </code><code class="comments">// Number of Arguments (for VirtualAlloc) </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">GateArg(NULL),&nbsp; </code><code class="comments">// VirtualAlloc Arg1/Rcx </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">GateArg(0x1000), </code><code class="comments">// VirtualAlloc Arg2 /Rdx </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">GateArg(MEM_RESERVE | MEM_COMMIT), </code><code class="comments">// VirtualAlloc Arg3/R8 </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">GateArg(PAGE_EXECUTE_READWRITE) </code><code class="comments">// VirtualAlloc Arg4/R9 </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="plain">); </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content"><code class="comments">// Run BeaconGate </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="plain">bof::runMockedBeaconGate(sleep_mask, &amp;functionCall, </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">{ </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>16</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">.allocator = bof::profile::Allocator::VirtualAlloc, </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>17</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">.obfuscate = bof::profile::Obfuscate::False, </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>18</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">.useRWX = bof::profile::UseRWX::False, </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>19</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">.module = </code><code class="string">""</code><code class="plain">, </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>20</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>21</code></td><td class="content"><code class="plain">); </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>22</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>23</code></td><td class="content"><code class="comments">// Free the memory allocated by BeaconGate </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>24</code></td><td class="content"><code class="plain">VirtualFree((</code><code class="color1 bold">LPVOID</code><code class="plain">)functionCall.retValue, 0, MEM_RELEASE);</code></td></tr></tbody></table></div></div></div></div>


<p>The <code>FUNCTION_CALL</code> structure contains all the information required to execute an ‚Äúatomic‚Äù function call and is what is passed by Beacon to the Sleepmask as part of BeaconGate. The <code>createFunctionCallStructure</code> is a helper function which makes it easy to generate these structures for use in your own code. Lastly, the <code>bof::runMockedBeaconGate</code> function will call the Sleepmask entry point and pass your <code>FUNCTION_CALL</code> for it to be executed by BeaconGate. For more details on the exact API usage and function definitions, see <a href="https://github.com/Cobalt-Strike/sleepmask-vs" target="_blank" rel="noreferrer noopener">Sleepmask-VS</a>.&nbsp;<br>&nbsp;<br>There will be a further deep dive on BeaconGate post-release that will demonstrate how to get started developing your own custom TTPs and demonstrate a few different open-source gates. As a taster, the return address spoofing PoC demonstrated previously was developed using Sleepmask-VS.&nbsp;</p>



<p>Additionally, we also identified that inline assembly was an important capability to port low-level techniques such as <a href="https://github.com/thefLink/RecycledGate/blob/main/src/GateTrampolin.asm#L3-L24" target="_blank" rel="noreferrer noopener">RecycledGate</a> to BeaconGate. Hence, we will also discuss how to do this in the upcoming blog.&nbsp;&nbsp;</p>



<p>It is possible to use <a href="https://linux.die.net/man/1/ld" target="_blank" rel="noreferrer noopener"><code>ld</code></a> with Sleepmask-VS to do this currently via <a href="https://stackoverflow.com/questions/2980102/combine-two-gcc-compiled-o-object-files-into-a-third-o-file" target="_blank" rel="noreferrer noopener">combining two different object files</a> but is not ideal (NB MSVC‚Äôs <code>link.exe</code> does not support this). Hence you will need to compile your assembly stub into a separate object file (i.e. via <a href="https://learn.microsoft.com/en-us/cpp/assembler/masm/masm-for-x64-ml64-exe?view=msvc-170" target="_blank" rel="noreferrer noopener">MASM/ml64.exe</a>) and then manually combine it with the <code>sleepmask.x64.o</code> produced by Sleepmask-VS:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_212444" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_212444_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_212444" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">&gt; ml64.exe /Fo asm_funcs.o /c asm_funcs.asm </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="plain">Microsoft (R) Macro Assembler (x64) Version 11.00.50727.1 </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="plain">Copyright (C) Microsoft Corporation.&nbsp; All rights reserved. </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="plain">Assembling: asm_funcs.asm </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="plain">[ ... ] </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="plain">(In WSL/Linux) </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="plain">&gt; ld --oformat pe-x86-64 -r sleepmask.x64.o asm_funcs.o -o sleepmask.x64.o</code></td></tr></tbody></table></div></div></div></div>


<p>Lastly, to enable operators to get the most out of BeaconGate, we have bumped the max Sleepmask BOF size.</p>



<h3 class="wp-block-heading">Beacon Object File Updates</h3>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="501" height="498" src="https://www.cobaltstrike.com/app/uploads/2024/07/butwait.jpg" alt="" class="wp-image-6059"></figure>



<p>We have also made a number of changes to help users get more out of BOFs in this release.&nbsp;</p>



<p>We have expanded the <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/beacon-object-files_bof-c-api.htm" target="_blank" rel="noreferrer noopener">BOF API</a> to expose Beacon‚Äôs system call functionality to BOFs. The new APIs take the form of <code>Beacon&lt;WinAPI&gt;</code>, i.e. <code>BeaconVirtualAlloc</code>. We added new APIs in order to give operators as much flexibility as possible. Hence, users can ‚Äòopt in‚Äô to using Beacon‚Äôs sys call API if desired, as opposed to transparently linking and not having a choice.&nbsp;</p>



<p>As an example, the code below will route the <code>VirtualAlloc</code> call through Beacon‚Äôs system call code:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_776549" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_776549_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_776549" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="keyword bold">void</code> <code class="plain">go(</code><code class="color1 bold">char</code><code class="plain">* args, </code><code class="color1 bold">int</code> <code class="plain">len) {‚ÄØ </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">PVOID</code> <code class="plain">pMemoryBuffer = NULL;‚ÄØ </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">pMemoryBuffer = BeaconVirtualAlloc(NULL, 8, MEM_COMMIT, PAGE_READWRITE);‚ÄØ </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="plain">}‚ÄØ</code></td></tr></tbody></table></div></div></div></div>


<p>The sys call method used by Beacon will be the option configured via the Malleable C2 <code>syscall_method</code> option or via the runtime <code>syscall-method</code> command.&nbsp;</p>



<p>Furthermore, these new BOF APIs are also supported by BeaconGate. Hence, if you have your own custom gate configured, you can proxy WinAPI calls from a BOF to be executed by your custom gate. This gives operators complete control over Beacon‚Äôs API usage/footprint and reduces BOF code bloat.<br>&nbsp;<br>Further details on the new APIs can be found in the documentation <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/beacon-object-files_bof-c-api.htm" target="_blank" rel="noreferrer noopener">here</a>. Additionally, an example BOF can be found in the <a href="https://github.com/Cobalt-Strike/bof_template" target="_blank" rel="noreferrer noopener">bof_template</a> in the public Cobalt Strike GitHub repository, which demonstrates a trivial example of using the new APIs to allocate and free memory.&nbsp;<br>&nbsp;<br>A new Beacon API, <strong>BeaconGetSyscallInformation</strong>, has also been added, which means you can now implement any syscall resolving technique you want in your loader, <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2-extend_user-defined-rdll.htm" target="_blank" rel="noreferrer noopener">pass the resolved syscall info to Beacon via Beacon User Data(BUD),</a> and then retrieve it from within a BOF. This is intended to reduce the bloat from within BOFs of having to repeatedly calculate syscall info yourself. For more detailed information on the API see the documentation <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/beacon-object-files_bof-c-api.htm" target="_blank" rel="noreferrer noopener">here</a>. &nbsp;<br>&nbsp;<br>As a note, the <code>bud-loader</code> in UDRL-VS demonstrates how to pass resolved syscall info to Beacon via BUD and our public <a href="https://github.com/Cobalt-Strike/bof-vs" target="_blank" rel="noreferrer noopener">BOF-VS template</a> contains a mocked <code>BeaconGateSyscallInformation</code> API, making it easy to integrate into your own BOFs.&nbsp;<br>&nbsp;<br>Lastly, the BOF API limit has been expanded to 128 ( üòâ <a href="https://twitter.com/s4ntiago_p" target="_blank" rel="noreferrer noopener">@s4ntiago_p</a> ).</p>



<h3 class="wp-block-heading">Sleepmask Redux</h3>



<p>From talking to customers, we are aware of confusion around the interoperability between the Sleepmask and UDRLs. The confusion stems from the fact that transformations set in the Malleable C2 profile are not applied to Beacons generated via the <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics_aggressor-scripts/as-resources_hooks.htm#BEACON_RDLL_GENERATE" target="_blank" rel="noreferrer noopener"><code>BEACON_RDLL_GENERATE</code> hook</a>. In contrast, the Sleepmask settings are statically calculated from the Malleable C2 profile and Beacon DLL <em>irrespective of whether you‚Äôre using a UDRL</em>. </p>



<p>For example, <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2-extend_pe-memory-indicators.htm" target="_blank" rel="noreferrer noopener"><code>stage.obfuscate</code></a> can be used to obfuscate parts of the Beacon DLL and it also instructs the default loader not to copy the PE header into memory as part of the reflective loading process. However, this does not apply to Beacons with UDRLs. This is expected behaviour, as it puts the developer in the driving seat (i.e., the UDRL must know how Beacon has been obfuscated in order to reverse it). However, the Sleepmask will use <code>stage.obfuscate</code> to calculate what sections it needs to mask, and hence will assume there is no PE header present. This is an obvious source of issues if a UDRL does not honor the Malleable C2 profile settings.</p>



<p>The introduction of BeaconGate meant we had to make some breaking changes to the Sleepmask API and this also provided us with an opportunity to address this issue. In CS 4.10, we have expanded <a href="https://www.cobaltstrike.com/blog/cobalt-strike-49-take-me-to-your-loader" target="_blank" rel="noreferrer noopener">Beacon User Data</a> to include a new <code>ALLOCATED_MEMORY</code> structure. This structure can be used to pass information to Beacon about (dynamic) memory allocated by the reflective loader. For example, Beacon‚Äôs location in memory and the address of each loaded section. This design means that Beacon can now pass the Sleepmask accurate section information, at run time, which greatly simplifies Sleepmask design. This feature also opens up a lot of possibilities, as any memory allocated by the loader can now be automatically masked by the Sleepmask.&nbsp;&nbsp;</p>



<p>For specific implementation details, the <code>bud-loader</code> and the <code>obfuscation-loader</code> in UDRL-VS contain comprehensive examples to demonstrate how to use <code>ALLOCATED_MEMORY</code> in a UDRL. The design was heavily influenced by Microsoft‚Äôs own <a href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-memory_basic_information" target="_blank" rel="noreferrer noopener">abstractions</a> around Virtual Memory and we are planning to release a deep dive on how to get the most out of this feature in the coming months.&nbsp;</p>



<p><em>It is important to note that configuring the Sleepmask via the <code>ALLOCATED_MEMORY</code> / <code>BEACON_USER_DATA</code> structures is the intended workflow as of the 4.10 release. Beacon will still try to mask based on a best effort basis if you do not pass this information (i.e., statically), but it may not work as expected. However, in future releases we plan to remove backwards compatibility. This means that UDRLs must pass allocated memory to Beacon in order to use the Sleepmask.</em></p>



<h4 class="wp-block-heading">User Defined BOF Memory</h4>



<p>We have also added support to the <code>ALLOCATED_MEMORY</code> structure for passing Beacon user defined memory which can be used for BOF and Sleepmask execution. Therefore, if you want full control over how the memory used for BOFs is allocated, you can employ your own custom allocation technique in a UDRL and pass this information to Beacon. This now enables operators to employ techniques such as module stomping when loading/executing BOFs. The <code>bud-loader</code> in UDRL-VS contains an example of how to pass user defined memory to Beacon for use with <code>inline-execute</code> and the Sleepmask.</p>



<h3 class="wp-block-heading">Postex Kit</h3>



<p>Another new addition in 4.10 is the Postex kit. The Postex kit opens up Beacon‚Äôs job architecture to allow operators to develop their own post-ex DLLs for interoperability with Beacon. Hence, if you need to quickly PoC a custom keylogger/session monitor/TGT monitor etc., you can use the Postex kit to develop a DLL which can plug seamlessly into Beacon‚Äôs existing jobs architecture. Furthermore, DLLs generally are simpler to develop and unit test for complex/long running tasks and suffer from none of the pain points and limitations which can make BOF development difficult.&nbsp;</p>



<p>It is important to highlight that the Postex kit also supports post-ex UDRLs (<a href="https://www.cobaltstrike.com/blog/cobalt-strike-49-take-me-to-your-loader" target="_blank" rel="noreferrer noopener">introduced in 4.9</a>), via the <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics_aggressor-scripts/as-resources_hooks.htm#POSTEX_RDLL_GENERATE" target="_blank" rel="noreferrer noopener"><code>POSTEX_RDLL_GENERATE</code></a> Aggressor hook, and <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2-extend_control-process-injection.htm" target="_blank" rel="noreferrer noopener">Process Injection</a> hooks, via the <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics_aggressor-scripts/as-resources_hooks.htm#PROCESS_INJECT_EXPLICIT" target="_blank" rel="noreferrer noopener"><code>PROCESS_INJECTION_*</code></a> Aggressor hooks. This gives operators full control over the whole post-ex attack chain, in terms of custom capabilities and how they are injected/loaded into memory. The process injection kit is still (in our experience) under utilised and it is worth checking out <a href="https://offensivedefence.co.uk/posts/cs-process-inject-kit/" target="_blank" rel="noreferrer noopener">this blog</a> for more information on how to configure it.&nbsp;<br>&nbsp;<br>The Postex kit itself is primarily intended to serve as a template for development. It is a Visual Studio solution that can be found in the Arsenal kit and makes it easy to develop custom long running post-ex DLLs that return data back to Beacon over a named pipe. It includes a library of functions which provide an abstraction over the job architecture allowing operators to focus purely on developing custom tooling. As a note, the Postex kit has been designed in a way that makes it possible to provide support for alternate methods of communication in future releases (i.e. not just named pipes).&nbsp;<br>&nbsp;<br>To support the Postex kit, a new <code>execute-dll</code> command has been added to the Beacon console. This will take a custom post-ex DLL provided by the operator, prepend a post-ex loader to it, and execute it as a new job. This job can be seen via the normal Cobalt Strike jobs output and killed via the <code>jobkill</code> command.&nbsp;&nbsp;</p>



<p>Additionally, the <code>execute-dll</code> command also supports passing arguments. These are automatically patched into a separate memory allocation and can be accessed from within the post-ex DLL via the <code>postexData-&gt;UserArgumentInfo.Buffer</code> (See the Postex kit example DLL for more information).&nbsp;<br>&nbsp;<br>However, one of the most powerful features of Cobalt Strike is its scripting language, Aggressor Script, which provides a huge amount of flexibility to operators. Hence, we have also added a new Aggressor Script function <code>beacon_execute_postex_job</code>.&nbsp;&nbsp;</p>



<p>This works in a similar way to <code>execute-dll</code> except it supports passing BOF style arguments (i.e. via Aggressor Script‚Äôs <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics_aggressor-scripts/as-resources_functions.htm#bof_pack" target="_blank" rel="noreferrer noopener">bof_pack function</a>) to your custom post-ex DLL. This enables operators to use the familiar Beacon Data Parser and Beacon Data Format <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/beacon-object-files_bof-c-api.htm" target="_blank" rel="noreferrer noopener">APIs</a> from within their post-ex DLLs. A trivial example of <code>beacon_execute_postex_job</code> is shown below:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_628127" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_628127_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_628127" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="variable">$argument_string</code> <code class="plain">= </code><code class="string">"example argument string"</code><code class="plain">; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="variable">$packed_arguments</code> <code class="plain">= bof_pack(</code><code class="variable">$beacon_id</code><code class="plain">, </code><code class="string">"iz"</code><code class="plain">, 4444, </code><code class="variable">$argument_string</code><code class="plain">); </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="comments"># example: run the postex task </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="plain">beacon_execute_postex_job(</code><code class="variable">$beacon_id</code><code class="plain">, </code><code class="variable">$pid</code><code class="plain">, </code><code class="variable">$postex_dll</code><code class="plain">, </code><code class="variable">$packed_arguments</code><code class="plain">, </code><code class="variable">$null</code><code class="plain">);</code></td></tr></tbody></table></div></div></div></div>


<p>From the post-ex DLL, the packed arguments can then be parsed via the standard <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/beacon-object-files_bof-c-api.htm" target="_blank" rel="noreferrer noopener">BeaconDataParse/Extract APIs</a>. As ever with Aggressor Script, there is huge scope for customisation here. For example, if desired, you could also stomp arguments directly into the post-ex DLL and retrieve them yourself.&nbsp;<br>&nbsp;<br>Furthermore, we have also added another Aggressor Function, <code>bjob_send_data</code>. This means that operators can now send <em>arbitrary data to a custom post-ex job via a named pipe</em>. An example demonstrating this can be seen below:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_645459" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_645459_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_645459" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="comments"># String to send to the post-ex dll&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="variable">$pipe_data</code><code class="plain">= </code><code class="string">"example pipe data string"</code><code class="plain">; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="comments"># Send the string to target post-ex job over named pipe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="plain">bjob_send_data(</code><code class="variable">$bid</code><code class="plain">, </code><code class="variable">$jid</code><code class="plain">, </code><code class="variable">$pipe_data</code><code class="plain">);&nbsp;&nbsp;&nbsp; </code></td></tr></tbody></table></div></div></div></div>


<p>This provides a huge amount of flexibility in your tooling. As a quick example, below is a screenshot of a custom <code>inject-assembly</code> PoC that we developed internally to dogfood the Postex kit:</p>



<figure class="wp-block-image aligncenter size-large is-resized"><img loading="lazy" decoding="async" width="1024" height="402" src="https://www.cobaltstrike.com/app/uploads/2024/07/inject-assembly-pipe-wait-example-1024x402.png" alt="" class="wp-image-6061" style="width:1072px;height:auto"></figure>



<p class="has-text-align-center has-small-font-size">Fig 2. A screenshot showing a custom <code>inject-assembly</code> PoC demonstrating use of the Postex kit. This example post-ex DLL waits for arguments to be passed via a named pipe and repeatedly executes the <code>DotNetHelloWorld.exe</code> assembly with the passed arguments.&nbsp;</p>



<p>The <code>inject-assembly</code> command above uses <code>beacon_execute_postex_job</code> under the hood to inject the PoC post-ex DLL into a remote process along with the user provided .NET assembly. The post-ex DLL then sits listening on a named pipe waiting for the user to send some arguments via <code>bjob_send_data</code>. In the example above we‚Äôve run the target assembly twice using a different set of arguments.&nbsp;&nbsp;</p>



<p>The Postex kit also contains an example post-ex DLL (which <em>must be</em> used in conjunction with the <code>postex-example.cna</code>) to get up and running to start developing your own tooling. This example post-ex DLL is primarily intended to demonstrate different aspects of the Postex kit in one place. Additionally, the Postex kit documentation can be found <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/index.htm#cshid=1008">here</a>. As with other new 4.10 features, we plan to release a deep dive on the Postex kit (and the custom inject-assembly DLL demonstrated above) in the upcoming months.&nbsp;</p>



<h3 class="wp-block-heading">Callbacks Update</h3>



<p>Callbacks were introduced in the <a href="https://www.cobaltstrike.com/blog/cobalt-strike-49-take-me-to-your-loader" target="_blank" rel="noreferrer noopener">4.9 release</a> and have been extended in 4.10 to provide a straightforward method for users to interact with the Postex kit.&nbsp;<br>&nbsp;<br>For example, you can also call <code>beacon_execute_postex_job</code> and provide a custom callback function as the last argument, which will be invoked each time the job checks in. The custom callback is passed a new <code>%infomap</code> hash map, which contains various information, such as the status of the job (i.e. has the job just been registered, completed, is it sending output etc.) and its job id. The key point is that the callback has access to the job id (once the job has been registered) which can then be used to send further data via <code>bjob_send_data()</code>.</p>



<p>A quick example of this functionality is shown in the <code>cna</code> script snippet below, which demonstrates sending further data to a custom post-ex DLL via a callback once it has been registered:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_836691" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_836691_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_836691" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">$pipe_data= "example pipe data string"; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="plain"># define custom callback function </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">$callback = lambda({ </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">local('$bid $data $result %info $type'); </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">this('$jid'); </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain"># get all arguments passed to lambda </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">($bid, $result, %info) = @_; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="spaces">&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain"># check the status/type of the job </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">$type = %info["type"]; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content"><code class="spaces">&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain"># if the job is registered, send data via the pipe </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">if ($type eq 'job_registered') { </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>16</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">$jid = %info['jid']; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>17</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>18</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain"># send the pipe data string to the DLL </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>19</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">bjob_send_data($bid, $jid, $pipe_data);&nbsp;&nbsp;&nbsp;&nbsp; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>20</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">} </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>21</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>22</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain"># print output to the console </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>23</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">else if ($type eq 'output') { </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>24</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">bjoblog($1, $jid, "Received output:\n" . $result); </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>25</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}&nbsp; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>26</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>27</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}, $pipe_data=&gt; $pipe_data; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>28</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>29</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain"># run the postex task... </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>30</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">beacon_execute_postex_job($beacon_id, $pid, $postex_dll, $packed_arguments, $callback);</code></td></tr></tbody></table></div></div></div></div>


<h3 class="wp-block-heading">Job Browser and Console</h3>



<p>To enable you to get the most out of the Postex kit we have given Cobalt Strike‚Äôs job UI an update with the introduction of the new job browser and job console. This has also been a common pain point for customers, as prior to 4.10 it was difficult to map job output to a specific job id.&nbsp;</p>



<p>The job browser is a new dialog that enables a user to work with jobs being run by one or more Beacons. It can be opened by selecting one (or multiple) Beacons, right-clicking, and selecting the <code>Jobs</code> option from the popup menu, or by selecting <code>View -&gt; All Jobs</code> from the main menu.&nbsp;&nbsp;</p>



<p>The job browser shows a complete list of every job tasked to the given Beacon(s) and shows various information such as the Job ID (JID), its status (i.e., if it has completed or still running), its description, and start and stop times. An example of the job browser is shown below:</p>



<figure class="wp-block-image aligncenter size-full"><img loading="lazy" decoding="async" width="996" height="319" src="https://www.cobaltstrike.com/app/uploads/2024/07/job_browser.png" alt="" class="wp-image-6065"></figure>



<p class="has-text-align-center has-small-font-size">Fig 3. A screenshot showing the new job browser UI.</p>



<p>The job console is another new dialog that allows a user to work with the output of a specific job. It is invoked by right-clicking a target job in the job browser and selecting <code>open</code> from the popup menu. An example of the job console for a portscan job is shown below:&nbsp;</p>



<figure class="wp-block-image aligncenter size-full"><img loading="lazy" decoding="async" width="996" height="319" src="https://www.cobaltstrike.com/app/uploads/2024/07/job_console-1.png" alt="" class="wp-image-6066"></figure>



<p class="has-text-align-center has-small-font-size">Fig 4. A screenshot showing the new job console UI for a portscan.</p>



<p>It is also possible to hide the output from selected jobs from the Beacon console. The output is then redirected to only appear in the job console window. This improves the user experience for long running post-ex jobs, such as SharpHound, as it means the output is all in one place and allows users to continue to operate in the Beacon console window. Additionally, if you need to revisit the output of a specific job you can now open the job console as opposed to having to trawl up through the Beacon console history.</p>



<h3 class="wp-block-heading">Host Rotation Updates</h3>



<p>Cobalt Strike‚Äôs host rotation was introduced in <a href="https://www.cobaltstrike.com/blog/cobalt-strike-4-3-command-and-control" target="_blank" rel="noreferrer noopener">4.3</a> to provide operators with greater control over how the HTTP/S and DNS Beacons cycle through hosts. While this offered additional flexibility over C2 comms, host rotation suffered from two main problems:&nbsp;&nbsp;</p>



<ul class="wp-block-list">
<li>Unresponsive hosts were included in the rotation strategy regardless of whether they were responsive. Hence, if one out of three hosts were failing, 1/3 check-ins would repeatedly fail.</li>



<li>There was no way to update host information on an active Beacon in order to change or disable failing hosts.</li>
</ul>



<p>In Cobalt Strike 4.10, we have made a number of improvements to host rotation to address these issues:</p>



<ul class="wp-block-list">
<li>Beacon will now automatically disable (‚Äúhold‚Äù) hosts that have failed, resulting in a far more reliable connection.</li>



<li>A new Beacon command, <code>beacon_config</code>, and its corresponding Aggressor Script function, <code>bbeacon_config</code>, have been added to make it possible to query and update the host information for an active Beacon. Hence, it is now possible to hot swap C2 hosts (via adding a new host or updating an existing one).</li>



<li>Operators can enable notifications for failed connections making it much easier to debug host rotation issues.</li>
</ul>



<p>As an example, we can query an active Beacon‚Äôs current host information via the new <code>beacon config host info</code> command, as demonstrated below:</p>



<figure class="wp-block-image aligncenter size-large is-resized"><img loading="lazy" decoding="async" width="1024" height="543" src="https://www.cobaltstrike.com/app/uploads/2024/07/beacon_config_host_info-1024x543.png" alt="" class="wp-image-6069" style="width:840px;height:auto"></figure>



<p class="has-text-align-center has-small-font-size">Fig 5. A screenshot showing the new <code>beacon_config</code> command in action. The output shows that only one host (<code>example.yyy</code>) has currently been configured for RoundRobin host rotation on the active Beacon.</p>



<p>The screenshot below shows a new host (<code>example.zzz</code>) being added at run time:</p>



<figure class="wp-block-image aligncenter size-large"><img loading="lazy" decoding="async" width="1024" height="711" src="https://www.cobaltstrike.com/app/uploads/2024/07/beacon_config_host_add-1024x711.png" alt="" class="wp-image-6070"></figure>



<p class="has-text-align-center has-small-font-size">Fig 6. A screenshot showing hot swappable C2 in action. A new host (<code>example.zzz</code>) has been dynamically added, which will now be used as part of the existing RoundRobin host rotation strategy.&nbsp;</p>



<p>Wireshark shows that Beacon immediately starts using the new host to check-in:</p>



<figure class="wp-block-image aligncenter size-large is-resized"><img loading="lazy" decoding="async" width="1024" height="271" src="https://www.cobaltstrike.com/app/uploads/2024/07/wireshark_beacon_host_add-1024x271.png" alt="" class="wp-image-6071" style="width:950px;height:auto"></figure>



<p class="has-text-align-center has-small-font-size">Fig 7. A TCP Stream in Wireshark demonstrating Beacon using the dynamically added host (<code>example.zzz</code>) to check-in.&nbsp;</p>



<p>As a note, the one restriction for adding hot swappable C2 hosts is that the URI must have previously been <a href="https://github.com/Cobalt-Strike/Malleable-C2-Profiles/blob/master/normal/hostprofile_example.profile#L120" target="_blank" rel="noreferrer noopener">defined in the Malleable C2 profile</a>.&nbsp;</p>



<p>Lastly, some web/proxy servers (when blocking requests) return a 200 (OK) status without any additional data in response to Beacon check-ins. Beacon assumes this is a valid ‚Äúnothing to do‚Äù response and hence will not trigger a failover rotation to the next host. To address this issue, users are now able to customise the format of the ‚Äúnothing to do‚Äù task so Beacon can determine whether a given response is valid. This can be enabled via the new Malleable C2 profile options, <code>data_required</code> and <code>data_required_length</code>.&nbsp;&nbsp;</p>



<p>For more information on all of these host rotation updates, see the documentation <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/listener-infrastructure_beacon-http-https.htm">here</a>.</p>



<h3 class="wp-block-heading"><strong>Java Support Updated To Java 11</strong></h3>



<p>As referenced in the <a href="https://www.cobaltstrike.com/blog/cobalt-strike-49-take-me-to-your-loader" target="_blank" rel="noreferrer noopener">Cobalt Strike 4.9 release blog post</a>, we have changed the minimum supported version of Java from Java 8 to Java 11. If you attempt to run the client using an older version of Java, you will see the following error:</p>



<figure class="wp-block-image aligncenter size-large is-resized"><img loading="lazy" decoding="async" width="1024" height="249" src="https://www.cobaltstrike.com/app/uploads/2024/07/java_version_error-1024x249.png" alt="" class="wp-image-6072" style="width:990px;height:auto"></figure>



<p class="has-text-align-center has-small-font-size">Fig 8. A screenshot displaying the error message presented when the Cobalt Strike 4.10 client is run with an older version of Java.</p>



<p>To avoid any issues, please make sure that the version of Java in your environment is at least Java 11 before downloading and running Cobalt Strike. For more guidance, see the Cobalt Strike <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/install_installing.htm" target="_blank" rel="noreferrer noopener">installation guide</a>.</p>



<h3 class="wp-block-heading">Product Security Updates</h3>



<p>Product security controls have been updated as part of the 4.10 release. In particular, the Linux package now splits the client and server out into separate packages, with each requiring a specific authorization file. This has resulted in a breaking change to the way Cobalt Strike updates, which you may need to account for in any bespoke deployment scripts.&nbsp;</p>



<p>Additionally, Fortra has partnered with Europol, the UK National Crime Agency, and several other private partners to protect the legitimate use of Cobalt Strike. In June, 593 IP addresses were taken down to disable stolen, unauthorized versions of Cobalt Strike. Fortra and law enforcement will continue to monitor and carry out similar actions as needed. You can read more about the action <a href="https://www.cobaltstrike.com/europol-coordinates-global-action-against-criminal-abuse-of-cobalt-strike" target="_blank" rel="noreferrer noopener">here</a>.</p>



<h3 class="wp-block-heading">Additional Updates</h3>



<p>In addition, this release also includes updates to System Calls, External C2, as well as numerous quality-of-life (QoL) changes. These QoL updates include:&nbsp;</p>



<ul class="wp-block-list">
<li>Improvements to tab completion (including support for custom commands, shift + tab functionality, and case insensitivity).</li>



<li>UI Improvements (including better word wrapping for dialogs and a preference to allow users to specify if they want Cobalt Strike opened in a maximized window).</li>



<li>Ability to specify the time zone and timestamp format used for logging (configurable via Teamserver.prop).&nbsp;</li>
</ul>



<p>To see a full list of what‚Äôs new in Cobalt Strike 4.10, please check out the‚ÄØ<a href="https://download.cobaltstrike.com/releasenotes.txt" target="_blank" rel="noreferrer noopener">release notes</a>.&nbsp;&nbsp;</p>



<p><strong><em>Licensed users will need to </em></strong><a href="https://download.cobaltstrike.com/download" target="_blank" rel="noreferrer noopener"><strong><em>download version 4.10 from scratch</em></strong></a><strong><em>. The existing 4.9 update application cannot be used to upgrade to version 4.10.</em></strong>&nbsp;</p>



<p>To purchase Cobalt Strike or learn more, please‚ÄØ<a href="https://www.cobaltstrike.com/quote-request/" target="_blank" rel="noreferrer noopener">contact us</a>.‚ÄØ</p>

</div><!-- .entry-content -->

<!-- .entry-footer -->

</article><!-- #post-6046 -->


				</main>
			</div> <!-- #primary -->
			
<div class="col-lg-4 align-self-start resource-sidebar widget-area"><!-- #resource-sidebar -->
        <div class="sidebar-content bg-7 mb-3">
        <div class=" container">
            <div class="row">
                <div class="col-12">
                                    <div class="author-description p-3 row">
                                                <div class="author-image col-5">
                             <img width="231" height="231" src="https://www.cobaltstrike.com/app/uploads/2023/07/William-Burgess.png" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="" decoding="async" loading="lazy">                        </div>
                                                <div class=" col-7 pl-0">
                            <h4 class="author-title text-align-left font-weight-light">
                                <a href="https://www.cobaltstrike.com/profile/william-burgess">William Burgess</a>
                            </h4>
                            <div>Principal Research Lead</div>
                        </div>
                        <div class="col-12 text-center mt-2">
                            <a class=" btn-link view-profile" href="https://www.cobaltstrike.com/profile/william-burgess">View Profile</a>
                        </div>
                    </div>
                                </div>  <!-- #column -->
            </div> <!-- #row -->
        </div> <!-- #container -->
    </div>  <!-- #sidebar-content -->
            <div class="sidebar-content bg-7 mb-3">
        <div class=" container">
            <div class="row">
                <div class="col-12">
                                            <div class="sidebar-content p-3">
                            <div class="block-title text-uppercase">
                            RELATED PRODUCTS
                            </div>
                            <ul class="list-group list-group-flush pt-2">
                            <li class="list-unstyled"><a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate" title="Cobalt Strike">Cobalt Strike</a></li>                            </ul>
                        </div>
                                                                <div class="sidebar-content p-3">
                            <div class="block-title text-uppercase">
                            TOPICS
                            </div>
                            <ul class="list-group list-group-flush pt-2">
                            <li class="list-unstyled"><a href="https://www.cobaltstrike.com/blog?_sft_cornerstone=development" title="Development">Development</a></li><li class="list-unstyled"><a href="https://www.cobaltstrike.com/blog?_sft_cornerstone=releases" title="Releases">Releases</a></li>                            </ul>
                        </div>
                                    </div>  <!-- #column -->
            </div> <!-- #row -->
        </div> <!-- #container -->
    </div>  <!-- #sidebar-content -->
    </div><!-- #resource-sidebar -->
		</div><!-- .row -->
	</div><!-- #container -->
</div><!-- #page-wrapper -->



</div>



<div class="wpc-filters-overlay"></div>










<div height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" data-original-tag="iframe"></div>
<div class="ta-display-none" name="trustarc_notice" id="trustarcNoticeFrame" title="Trustarc Cross-Domain Consent Frame" src="https://consent.trustarc.com/get?name=crossdomain.html&amp;domain=helpsystems.com" data-original-tag="iframe"></div></body></html>