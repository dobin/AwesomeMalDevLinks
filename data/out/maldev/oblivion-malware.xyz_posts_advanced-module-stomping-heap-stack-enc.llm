Title:
Evading detection in memory – Pt 2: Improving Module Stomping (Advanced Module Stomping) + Sleep Obfuscation with heap/stack encryption

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post details an “advanced module stomping” approach to reduce memory-scanner detections that focus on private RX regions and suspicious call stacks.  
- It improves classic module stomping by backing up the target DLL’s `.text` section into mapped memory, overwriting it with shellcode only during execution, and restoring the original bytes during beacon “sleep” to minimize the observable tampering window.  
- It discusses pitfalls of using `LoadLibraryExA(DONT_RESOLVE_DLL_REFERENCES)` (abnormal `LDR_DATA_TABLE_ENTRY` fields) and shows how to patch PEB/LDR metadata (e.g., `EntryPoint`, flags, `LoadNotificationsSent`) to look more like a normal load.  
- To address detections based on modified shared image pages (`SharedOriginal`/shareable working set), it proposes unloading and reloading a fresh module during sleep, then re-stomping on wake.  
- The sleep obfuscation chain uses ROP-style API invocation (`VirtualProtect`, `WriteProcessMemory`, `WaitForSingleObjectEx`, `LdrUnloadDll`, `LoadLibraryExA`) and adds stack/heap encryption (stack via TEB stack bounds; heap via a custom `RtlCreateHeap` and `HeapWalk`).  
- Useful primarily for red teamers and malware developers building stealthy in-memory implants and evaluating against tools like Moneta, pe-sieve, and Hunt-Sleeping-Beacons.

Technical Focus:
- Module stomping of DLL `.text` sections and mapped-memory backups (CreateFileMapping/MapViewOfFile)
- Sleep obfuscation via ROP chains and API-based memory permission flipping (VirtualProtect/WriteProcessMemory)
- PEB/LDR manipulation (`LDR_DATA_TABLE_ENTRY`) to normalize module-load artifacts
- Handling shared image page indicators (`SharedOriginal`, shareable working set) by unload/reload strategies
- Stack obfuscation using TEB (`NT_TIB.StackBase/StackLimit`)
- Heap obfuscation using custom heaps (`RtlCreateHeap`, `HeapWalk`, PROCESS_HEAP_ENTRY)

Use Cases:
- Stealthier in-process beacon execution with reduced “private RX” and modified-image-page IOCs
- Implementing sleep masking that restores legitimate module bytes during idle periods
- Hardening reflective/implant loaders against memory scanners (Moneta, pe-sieve) and sleep-beacon hunters
- Researching detection opportunities around LDR flags, module load notifications, and shared-page semantics

Keywords:
module stomping, advanced module stomping, sleep obfuscation, sleep masking, mapped memory, CreateFileMappingA, MapViewOfFile, LoadLibraryExA, DONT_RESOLVE_DLL_REFERENCES, VirtualProtect, WriteProcessMemory, LdrUnloadDll, PEB, TEB, LDR_DATA_TABLE_ENTRY, .text section, SharedOriginal, shareable working set, ROP chain, WaitForSingleObjectEx, stack encryption, heap encryption, RtlCreateHeap, HeapWalk, PROCESS_HEAP_ENTRY, Moneta, pe-sieve, Hunt-Sleeping-Beacons