Title:
Experimenting: Bypassing Memory Scanners with Cobalt Strike and Gargoyle

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explores an experimental PoC to evade EDR memory scanners by ensuring a Cobalt Strike Beacon is not continuously resident in executable memory.  
- It adapts the “Gargoyle” technique (timer + APC + ROP stack pivot) to periodically flip memory permissions, execute a staging routine, then revert to non-executable memory while “sleeping.”  
- The PoC (“Metalgear”) stores an encrypted/hidden Beacon blob in non-executable memory, reflectively loads it into a new region, runs it briefly, then finds and tears it down by terminating the Beacon thread and unmapping both the original and reflectively loaded allocations.  
- It relies on assumptions common to scalable memory scanning: interval-based scans and focus on executable/RWX regions and injected-thread artifacts rather than scanning all non-exec pages.  
- The article details PIC shellcode implementation in C (hash-based API resolution) and integration into Gargoyle’s assembly payload while preserving execution context (PUSHAD/POPAD).  
- Useful primarily for red teamers and offensive researchers studying in-memory evasion tradeoffs; it’s interesting because it targets scanner scheduling/coverage limitations rather than only “making artifacts harder to detect.”

Technical Focus:
- Gargoyle memory-scanner evasion (waitable timers, APCs, ROP stack pivot)
- Memory permission manipulation (VirtualProtect/VirtualProtectEx; RWX vs RX/RO)
- Reflective DLL loading and Beacon in-memory artifacts
- PIC shellcode in C with hashed API resolution (PEB/module walking)
- Thread and memory region discovery/teardown (TerminateThread, unmapping)
- EDR detection surface: injected threads, RWX regions, periodic scanning

Use Cases:
- Testing whether an EDR’s memory scanning is interval-based and biased toward executable pages
- Prototyping “beacon-on-a-timer” / intermittent in-memory execution tradecraft
- Researching reflective loader artifacts and how scanners identify injected threads/RWX regions
- Building lab PoCs for memory-permission flipping + ROP/APC execution chains
- Developing defensive detections for timer/APC/VirtualProtect patterns and repeated stage/teardown behavior

Keywords:
Cobalt Strike, Beacon, Gargoyle, EDR evasion, memory scanning, reflective DLL injection, ReflectiveLoader, waitable timer, SetWaitableTimer, APC, WaitForSingleObjectEx, ROP gadget, stack pivot, mshtml.dll, VirtualProtectEx, RWX, injected thread detection, PIC shellcode, PEB walking, API hashing, TerminateThread, unmap memory, VMMap, Process Explorer