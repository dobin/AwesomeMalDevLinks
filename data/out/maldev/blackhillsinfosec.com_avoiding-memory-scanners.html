# https://www.blackhillsinfosec.com/avoiding-memory-scanners/

<!DOCTYPE html><html lang="en-US" data-wp-dark-mode-preset="0" style="--tf_fixed_h: 1468px;">

<body class="wp-singular post-template-default single single-post postid-22875 single-format-standard wp-theme-themify-corporate tribe-js skin-default sidebar-none default_width no-home fixed-header-enabled tb_animation_on sidemenu-active" style="--wpdm-img-opacity: 1; --wpdm-vid-opacity: 1;"><div id="simple-banner" class="simple-banner"><div class="simple-banner-text"><span><a href="https://wildwesthackinfest.com/wild-west-hackin-fest-mile-high-2026/">Join us at Wild West Hackin' Fest @ Mile High in Denver for Training, Community, and Fun!</a></span></div></div>
<svg id="tf_svg" style="display:none"><defs><symbol id="tf-fab-youtube-square" viewBox="0 0 32 32"><path d="M11.69 12.63 17.63 16l-5.94 3.38v-6.75zM28 5v22q0 1.25-.88 2.13T25 30H3q-1.25 0-2.13-.88T0 27V5q0-1.25.88-2.13T3 2h22q1.25 0 2.13.88T28 5zm-2.63 11q0-3.69-.5-5.5-.37-1.63-2-2-.75-.25-2.96-.38T15.8 8H14q-7.13 0-8.88.5-1.62.38-2 2-.25.81-.37 2.19t-.13 2.37V16q0 3.75.5 5.5.38 1.63 2 2 .75.25 2.97.38t4.1.12H14q7.13 0 8.88-.5 1.62-.44 2-2 .25-.75.37-2.12t.13-2.38v-1z"></path></symbol><symbol id="tf-fab-linkedin-square" viewBox="0 0 32 32"><path d="M26 2q.81 0 1.4.6T28 4v24q0 .81-.6 1.4T26 30H2q-.81 0-1.4-.6T0 28V4q0-.81.6-1.4T2 2h24zM8.44 26h.06V12.62H4.31V26h4.13zM6.38 10.81q1 0 1.71-.72t.72-1.68-.72-1.7T6.37 6t-1.68.72-.7 1.69.7 1.68 1.68.72zM24 26v-7.31q0-1.5-.19-2.57t-.69-1.96-1.53-1.38-2.53-.47q-1.44 0-2.47.63t-1.47 1.5h-.06v-1.82h-4V26h4.19v-6.63q0-1.56.5-2.5t1.94-.93q.75 0 1.25.3t.65.95.22 1.09.07 1.22V26H24z"></path></symbol><symbol id="tf-fab-bluesky" viewBox="0 0 576 512"><path d="M123.6 34.5c66.4 50.1 137.9 151.5 164.2 206C314 186 385.5 84.5 452 34.5c48-36.1 125.6-64.1 125.6 24.9c0 17.8-10.1 149.2-16.1 170.5c-20.7 74.2-96.1 93.1-163.1 81.6c117.2 20 147 86.3 82.6 152.6C358.7 590 305.2 432.5 291.5 392.1c-2.5-7.5-3.7-10.9-3.7-7.9c0-3.1-1.2 .4-3.7 7.9C270.4 432.5 216.9 590 94.6 464.1C30.2 397.8 60 331.5 177.2 311.5C110.2 322.9 34.8 304 14.1 229.8C8.1 208.5-2 77.1-2 59.3c0-88.9 77.7-61 125.6-24.9z"></path></symbol><symbol id="tf-fab-discord" viewBox="0 0 32 32"><path d="M18.56 15.19q0 .75-.47 1.28t-1.15.53q-.44 0-.82-.25t-.59-.66-.22-.9q0-.38.13-.69t.34-.56.53-.38.63-.12q.68 0 1.15.5t.47 1.25zm-7.43-1.75q.68 0 1.15.5t.47 1.25-.47 1.28-1.15.53-1.16-.53-.47-1.28.47-1.25 1.15-.5zM28 3.3V32q-3.63-3.2-7.44-6.76l.88 3H3.24q-1.3 0-2.27-.97T0 24.94V3.3Q0 1.94.97.97T3.25 0h21.5q1.31 0 2.28.97T28 3.3zm-4.56 15.13q0-2.25-.57-4.6t-1.18-3.53l-.57-1.18q-.62-.5-1.34-.85t-1.25-.5-.97-.25-.69-.1h-.25l-.18.26q1.18.37 2.18.9t1.38.85l.37.31q-2.75-1.56-6-1.63T8.44 9.25l-.94.5q1.3-1.25 4.19-2.13l-.13-.18q-2.19 0-4.5 1.68-.25.5-.62 1.32T5.4 13.72t-.65 4.72q.12.31.47.69t1.6 1.06 2.8.69q.63-.7 1.07-1.32-.88-.25-1.6-.71T8.12 18l-.25-.31.29.15.28.16.12.06q2.13 1.2 4.72 1.4t5.28-.84q.94-.3 1.81-.93-.8 1.31-2.87 1.93l1.06 1.25q1 0 1.85-.28t1.37-.62.94-.69.53-.6z"></path></symbol><symbol id="tf-fab-x-twitter" viewBox="0 0 512 512"><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"></path></symbol><symbol id="tf-fas-podcast" viewBox="0 0 28 32"><path d="M16.69 30.56Q16.3 32 14 32t-2.69-1.44q-.44-1.56-.87-4.22T10 22.25q0-2.75 4-2.75t4 2.75q0 1.44-.44 4.1t-.87 4.21zM9.8 18.06q.32.32-.06.57-.88.62-1.31 1.56-.25.5-.57.12Q5 17.63 5 13.75q0-3.81 2.72-6.47t6.53-2.53q3.56.13 6.12 2.66T23 13.5q.12 4.05-2.88 6.8-.3.38-.56-.12-.44-.94-1.31-1.56-.38-.25-.06-.57 1.8-1.81 1.8-4.31 0-2.56-1.84-4.34t-4.4-1.66q-2.32.13-3.97 1.78T8 13.5q-.13 2.69 1.81 4.56zM14 0q5.81 0 9.9 4.1T28 14q0 4.13-2.19 7.5t-5.69 5.06q-.18.13-.37 0t-.13-.37q.25-1.69.32-2.94 2.31-1.5 3.69-3.94T25 14q0-1.81-.56-3.47t-1.6-3.03-2.37-2.38-3.03-1.56T14 3Q9.44 3 6.22 6.22T3 13.94q0 2.8 1.31 5.25t3.57 3.93q.18.13.18.32.07 1.18.32 2.75.06.25-.13.37t-.37 0Q4.3 24.87 2.16 21.5T0 14q0-5.81 4.1-9.9T14 0zm0 10q1.69 0 2.84 1.16T18 14t-1.16 2.84T14 18t-2.84-1.16T10 14t1.16-2.84T14 10z"></path></symbol></defs></svg><div id="pagewrap" class="hfeed site">

	<div id="headerwrap">

		
		
		<!-- /#header -->

        
	</div><div class="tf_hidden tf_w" style="height: 0px; contain: strict; content-visibility: hidden;"></div>
	<!-- /#headerwrap -->

	<div id="body" class="tf_clearfix">

		<!-- layout -->
<div id="layout" class="pagewidth tf_clearfix">
            <main id="content" class="tf_clearfix">
	    <article id="post-22875" class="post tf_clearfix post-22875 type-post status-publish format-standard has-post-thumbnail hentry category-red-team category-tool-red-team tag-aceldr tag-cobalt-strike tag-evasion tag-foliage tag-gargoyle tag-malware tag-moneta tag-pe-sieve tag-yara has-post-title has-post-date has-post-category has-post-tag has-post-comment no-post-author ">
	
	
			<div class="post-date-wrap">
			<time datetime="2022-09-22" class="post-date entry-date updated">
				<span class="day">22</span>
				<span class="month">Sep</span>
				<span class="year">2022</span>
			</time>
		</div>
	
	<div class="post-content">

					<p class="post-meta entry-meta">

									
				<span class="post-category"><a href="https://www.blackhillsinfosec.com/category/red-team/" rel="tag" class="term-red-team">Red Team</a>, <a href="https://www.blackhillsinfosec.com/category/red-team/tool-red-team/" rel="tag" class="term-tool-red-team">Red Team Tools</a></span>
									 <span class="post-tag"><a href="https://www.blackhillsinfosec.com/tag/aceldr/" rel="tag">AceLdr</a>, <a href="https://www.blackhillsinfosec.com/tag/cobalt-strike/" rel="tag">cobalt strike</a>, <a href="https://www.blackhillsinfosec.com/tag/evasion/" rel="tag">evasion</a>, <a href="https://www.blackhillsinfosec.com/tag/foliage/" rel="tag">FOLIAGE</a>, <a href="https://www.blackhillsinfosec.com/tag/gargoyle/" rel="tag">gargoyle</a>, <a href="https://www.blackhillsinfosec.com/tag/malware/" rel="tag">Malware</a>, <a href="https://www.blackhillsinfosec.com/tag/moneta/" rel="tag">moneta</a>, <a href="https://www.blackhillsinfosec.com/tag/pe-sieve/" rel="tag">pe-sieve</a>, <a href="https://www.blackhillsinfosec.com/tag/yara/" rel="tag">yara</a></span>				
							</p>
		
		<h1 class="post-title entry-title"><a href="https://www.blackhillsinfosec.com/avoiding-memory-scanners/">Avoiding Memory Scanners</a></h1>
		        <div class="entry-content">

                                        <p><a href="https://twitter.com/kyleavery_" target="_blank" rel="noopener noreferrer">Kyle Avery</a> //</p>



<figure class="wp-block-image aligncenter size-large"><img fetchpriority="high" decoding="async" width="1024" height="576" src="https://www.blackhillsinfosec.com/wp-content/uploads/2022/09/BLOG_chalkboard_00602-1024x576.jpg" alt="" class="wp-image-22876"></figure>



<h2 class="wp-block-heading">Introduction</h2>



<p>This post compliments a <a href="https://forum.defcon.org/node/241824" target="_blank" rel="noopener noreferrer">presentation</a> I gave at DEF CON 30 – “Avoiding Memory Scanners: Customizing Malware to Evade YARA, PE-sieve, and More,” which included the public release of a new tool called <a href="https://github.com/kyleavery/AceLdr" target="_blank" rel="noopener noreferrer">AceLdr</a>. The slides for this presentation are available on the <a href="https://media.defcon.org/DEF%20CON%2030/DEF%20CON%2030%20presentations/Kyle%20Avery%20-%20Avoiding%20Memory%20Scanners%20Customizing%20Malware%20to%20Evade%20YARA%20PE-sieve%20and%20More.pdf" target="_blank" rel="noopener noreferrer">conference website</a>.</p>



<p>As open-source tools and commercial security products improve their ability to scan process memory for malware on Windows, red teams are forced to improve their tradecraft to evade them consistently.</p>



<p>Typically, beaconing C2 implants follow a common paradigm in which the malware executes an instruction and then sleeps for a period. This process presents a set of opportunities for detection and evasion, which this post aims to detail.</p>



<h2 class="wp-block-heading">Memory Scanner Capabilities</h2>



<p>Open-source memory scanners have varying features that can be defined into the following categories.</p>



<h3 class="wp-block-heading">Pattern Matching</h3>



<p>Signature or pattern matching may be the most recognized feature of memory scanners and commercial security products. A prime example of this technique is <a href="https://github.com/VirusTotal/yara" target="_blank" rel="noopener noreferrer">YARA</a>. YARA can perform string and byte pattern matching with conditional logic. For example, consider the following example rule:</p>



<pre class="wp-block-code"><code>rule Example
{
  strings:
    $a = "This program cannot" xor
    $b = { 41 42 ( 43 | 44 ) ?? 46 }

  condition:
    $a or $b
}
</code></pre>



<p>In this rule, the target must contain one of the following to match:</p>



<ul class="wp-block-list">
<li>The string “This program cannot” or any single-byte XOR encrypted variation.</li>



<li>The bytes 41 and 42, either 43 or 44, any single byte, and 46.</li>
</ul>



<p>This simple example should provide a good picture of what is possible with YARA. Anything from simple string or byte patterns to relatively complex combinations of these primitives can be defined.</p>



<p>Since YARA scans all memory allocated by a target process, many projects build off YARA to create more efficient scanners with specific goals. For example, <a href="https://github.com/CCob/BeaconEye" target="_blank" rel="noopener noreferrer">BeaconEye</a> only scans heap memory in search of Cobalt Strike configuration structures which are dynamically allocated at initialization.</p>



<p>Commercial security products like AV and EDR are also known to use YARA. Namely, <a href="https://developer.carbonblack.com/reference/enterprise-response/connectors/cb-yara-connector/" target="_blank" rel="noopener noreferrer">Carbon Black</a> and <a href="https://www.crowdstrike.com/products/threat-intelligence/falcon-x-automated-intelligence/" target="_blank" rel="noopener noreferrer">CrowdStrike</a> explicitly mention using YARA, and other vendors will likely use it.</p>



<p>A quick Google search can find many YARA rules for Cobalt Strike. For example, the following demonstration scans two cmd.exe processes with a set of rules targeting Cobalt Strike: one benign and one injected with an implant.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="800" height="450" src="https://www.blackhillsinfosec.com/wp-content/uploads/2022/09/avoiding_memory_scanners_1.gif" alt="" class="wp-image-22887"><figcaption class="wp-element-caption"><em>Detecting Cobalt Strike with YARA</em></figcaption></figure>



<h3 class="wp-block-heading">Memory Attributes</h3>



<p>Attributes of memory, such as permissions and mapping information, can also be used to identify potentially malicious code. Memory can be readable, writeable, or executable and mapped as image commit or private commit data. Memory is “image commit” if it was created by loading a file from disk such as an EXE or DLL. Memory is “private commit” if the process dynamically allocated it through API calls such as VirtualAlloc.</p>



<p><a href="https://github.com/forrest-orr/moneta" target="_blank" rel="noopener noreferrer">Moneta</a> scans memory pages to look for both executable and private commit memory. All code must be executable, but code on Windows tends to be loaded from disk. Executable private memory occurs legitimately in JIT environments such as the .NET runtime or web browsers. Additionally, Moneta will check the start address of all threads for private commit memory addresses. This check is simple enough to evade, since the start address of a thread is not changed after creation. A new thread with an image commit start address can be created in a suspended state, modified to execute the target shellcode, and resumed.</p>



<p><a href="https://github.com/hasherezade/pe-sieve" target="_blank" rel="noopener noreferrer">PE-sieve</a> will scan executable, non-executable, or inaccessible memory for patterns that typically occur in shellcode, depending on the usage. In addition, PE-sieve will check the return address of all threads for private commit memory addresses.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="800" height="450" src="https://www.blackhillsinfosec.com/wp-content/uploads/2022/09/avoiding_memory_scanners_2.gif" alt="" class="wp-image-22885"><figcaption class="wp-element-caption"><em>Detecting Cobalt Strike with Moneta and PE-sieve</em></figcaption></figure>



<h3 class="wp-block-heading">Stack Tracing</h3>



<p>Finally, more recent memory scanners have introduced tracing of thread call stacks to identify potentially malicious code. Tools like <a href="https://github.com/3lp4tr0n/BeaconHunter" target="_blank" rel="noopener noreferrer">BeaconHunter</a> and <a href="https://github.com/thefLink/Hunt-Sleeping-Beacons" target="_blank" rel="noopener noreferrer">Hunt-Sleeping-Beacons</a> operate on a simple premise: identify any thread with a wait reason of “DelayExecution”. Since Cobalt Strike and many other implants use the Sleep API call, this method can reliably detect malware implants. Unfortunately, there are often many false positives associated with the technique.</p>



<p>Since the initial release of AceLdr, Hunt-Sleeping-Beacons has been updated with a new method to detect FOLIAGE (more on this in the next section). The scanner now looks for threads with a wait reason of “UserRequest”, which also have a return address to KiUserApcDispatcher somewhere on their call stack. This will be covered in further detail below.</p>



<p>An interesting variation of stack tracing can be found in <a href="https://github.com/waldo-irc/MalMemDetect" target="_blank" rel="noopener noreferrer">MalMemDetect</a>. This scanner hooks API calls such as RtlAllocateHeap to check the return address at execution time. When Beacon calls one of these APIs, the return address on the stack will point to the implant shellcode, which resides in private commit memory.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="800" height="450" src="https://www.blackhillsinfosec.com/wp-content/uploads/2022/09/avoiding_memory_scanners_3.gif" alt="" class="wp-image-22886"><figcaption class="wp-element-caption"><em>Detecting Cobalt Strike with MalMemDetect</em></figcaption></figure>



<p>The tools discussed above have capabilities outside this post’s scope. I’d recommend looking through the code of each scanner if you’re interested in learning more.</p>



<h2 class="wp-block-heading">Bypassing Memory Scanners</h2>



<p>Developers can take advantage of their C2 implant’s sleep period to implement protections that obfuscate the malware to reduce the likelihood that a scanner will detect it. The longer an implant’s sleep time, the less likely it will be found by scanners evaded by said protections.</p>



<p>A bypass in the context of this post does not generate false positives. It is not meant to confuse analysts or blend in with existing results. A true bypass results in zero results from a memory scanner before and after an implant is injected.</p>



<h3 class="wp-block-heading">Encrypting Data</h3>



<p>The first technique that comes to mind for encrypting data is often single-byte XOR. Single-byte XOR is conveniently easy to implement, doesn’t require API calls, and runs relatively quickly. Unfortunately, tools like YARA and PE-sieve realized this and found ways to detect this encryption method with ease.</p>



<p>An alternative solution might implement functions that perform multi-byte XOR, AES, or RC4. However, it will become apparent in the following sections that this is not a viable option either. To completely evade scanners like Moneta, which search for any executable private memory, the code used for encrypting data must reside in image commit memory.</p>



<p>You can perform AES encryption using Windows APIs, but it requires a combination of multiple API calls to encrypt and decrypt data. An excellent solution for this problem is hinted at in <a href="https://github.com/gentilkiwi/mimikatz/blob/e10bde5b16b747dc09ca5146f93f2beaf74dd17a/modules/kull_m_crypto_system.h#L97" target="_blank" rel="noopener noreferrer">Mimikatz</a>. The author implements SystemFunction032: a system function that can be resolved from advapi32.dll to perform RC4 encryption and decryption. This API call accepts two arguments that contain the target memory and a key, allowing us to dynamically generate a key and encrypt data without executing code in private commit memory. Technically, SystemFunction032 is for encryption, and SystemFunction033 is for decryption. The RC4 cipher is bidirectional, though, so you can use either API for encryption or decryption.</p>



<h3 class="wp-block-heading">Heap Encryption</h3>



<p>Now that we’ve identified a method of encrypting data, we must decide which data should be encrypted. The beginning of this post referenced BeaconEye, a tool that scans dynamically allocated memory for Cobalt Strike configuration data structures.</p>



<p>Heap encryption is probably best performed in one of two ways:</p>



<ul class="wp-block-list">
<li>Tracking heap entries created by Beacon</li>



<li>Utilizing a secondary heap for Beacon’s allocations</li>
</ul>



<p>The official <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/artifacts-antivirus_sleep-mask-kit.htm" target="_blank" rel="noopener noreferrer">Sleep Mask Kit</a> from Cobalt Strike provides a list of memory addresses for encryption. Their solution is clean, but it requires the use of Sleep Mask Kit, which, as described in the following section, prevents us from bypassing some scanners.</p>



<p>Last year, I released a <a href="https://github.com/kyleavery/TitanLdr/tree/heapencrypt" target="_blank" rel="noopener noreferrer">fork of TitanLdr</a>, which creates a new heap before Beacon is loaded. The GetProcessHeap API is hooked in the implant’s IAT to force it to resolve that heap when resolving the process heap to allocate memory. This allows us to encrypt all entries on the secondary heap, since only the implant should use it. The following demonstration uses this fork to bypass BeaconEye.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="800" height="450" src="https://www.blackhillsinfosec.com/wp-content/uploads/2022/09/avoiding_memory_scanners_4.gif" alt="" class="wp-image-22884"><figcaption class="wp-element-caption"><em>Avoiding BeaconEye</em></figcaption></figure>



<h3 class="wp-block-heading">Obfuscating Executable Code</h3>



<p>Consistently bypassing tools like Moneta and PE-sieve requires a combination of encryption to evade pattern matching and memory permission control to evade attribute scanning.</p>



<h5 class="wp-block-heading">Executable Masking Stub</h5>



<p>An executable stub such as that used in Sleep Mask Kit or <a href="https://github.com/mgeeky/ShellcodeFluctuation" target="_blank" rel="noopener noreferrer">Shellcode Fluctuation</a> can encrypt the implant code at rest and make it non-executable. Both examples require at least one executable region to remain unchanged, though. There will always be at least one point of detection from scanners using the “masking stub” technique, and YARA rules can be created to detect the stub itself.</p>



<h5 class="wp-block-heading">Return Oriented Programming (ROP)</h5>



<p>The <a href="https://github.com/JLospinoso/gargoyle" target="_blank" rel="noopener noreferrer">Gargoyle</a> PoC influenced the creation of the other techniques discussed in this section. The author used asynchronous procedure calls to queue and execute a series of ROP gadgets that run while the initiating code is non-executable.</p>



<p>Gargoyle is only provided for 32-bit Windows, and the PoC only executes a message box. Earlier this year, Waldo-irc released <a href="https://github.com/waldo-irc/YouMayPasser" target="_blank" rel="noopener noreferrer">YouMayPasser</a>: a 64-bit implementation of Gargoyle, ready to use with Cobalt Strike.</p>



<h5 class="wp-block-heading">Redirecting Execution with Contexts</h5>



<p>Gargoyle and YouMayPasser achieve our goal of changing the implant code to non-executable. Still, they suffer the same issues as many ROP exploits: different versions of Windows require modifications to the gadget offsets. There are ways to solve this problem, but they can introduce significant complexity.</p>



<p>Inspired by Gargoyle, Austin Hudson released <a href="https://github.com/SecIdiot/FOLIAGE" target="_blank" rel="noopener noreferrer">FOLIAGE</a>: an alternative to traditional ROP, which uses the NtContinue API call to control execution during sleep. NtContinue is typically used in error handling to restore the execution context of a thread. It accepts a new context as the single argument and modifies the current thread to use this context. A context structure specifies values for CPU registers, including the instruction pointer, so it can redirect execution to a specified address. FOLIAGE queues a series of APCs which execute NtContinue to switch contexts repeatedly. A new context structure is used for each of the following steps in a chain that obfuscates the implant:</p>



<ol class="wp-block-list" type="1">
<li>Waits on a new event to keep the thread from exiting</li>



<li>Changes the implant memory to be non-executable</li>



<li>Instructs the KsecDD driver to encrypt the implant memory</li>



<li>Saves the context of the original thread</li>



<li>Sets the context of the original thread to a fake context (more on this later)</li>



<li>Sleeps for the specified time with NtDelayExecution</li>



<li>Instructs the KsecDD driver to decrypt the implant memory</li>



<li>Restores the original thread context</li>



<li>Changes the implant memory to be executable</li>



<li>Exits the new thread</li>
</ol>



<p>This process can be further examined by reviewing <a href="https://github.com/SecIdiot/FOLIAGE/blob/master/source/sleep.c#L217-L512" target="_blank" rel="noopener noreferrer">lines 217-512 of sleep.c</a> in FOLIAGE.</p>



<p>A couple of months ago, C5pider claimed to have reversed <a href="https://www.mdsec.co.uk/nighthawk/" target="_blank" rel="noopener noreferrer">MDSec NightHawk</a> to create <a href="https://github.com/Cracked5pider/Ekko" target="_blank" rel="noopener noreferrer">Ekko</a>: an alternative to FOLIAGE which uses CreateTimerQueueTimer instead of NtQueueApcThread to queue calls to NtContinue.</p>



<p>The following demonstration uses FOLIAGE to bypass Moneta and PE-sieve.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="800" height="450" src="https://www.blackhillsinfosec.com/wp-content/uploads/2022/09/avoiding_memory_scanners_5.gif" alt="" class="wp-image-22883"><figcaption class="wp-element-caption"><em>Avoiding Moneta and PE-sieve</em></figcaption></figure>



<p>NtContinue is not the only API call that forcefully changes execution with context structures. It conveniently requires only one argument, but there are also viable alternatives.</p>



<h3 class="wp-block-heading">Avoiding Sleep</h3>



<p>Tools like BeaconHunter and Hunt-Sleeping-Beacons alert on threads with a wait reason of “DelayExecution”. This detection can be easily evaded using an alternative method of delaying execution which does not set this wait reason. WaitForSingleObject is an API that fits this requirement and sets a wait reason of “UserRequest”. The following demonstration replaces the Sleep API call with WaitForSingleObject to bypass these tools.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="800" height="450" src="https://www.blackhillsinfosec.com/wp-content/uploads/2022/09/avoiding_memory_scanners_6.gif" alt="" class="wp-image-22882"><figcaption class="wp-element-caption"><em>Avoiding Hunt-Sleeping-Beacons</em></figcaption></figure>



<h3 class="wp-block-heading">Return Address Spoofing</h3>



<p>Spoofing the return address involves modifying the call stack return address, so it does not point to private commit memory. This section can be split into two distinct techniques: at rest, and execution return address spoofing.</p>



<h5 class="wp-block-heading">Spoofing at Rest</h5>



<p>The term “at rest” refers to the implant during sleep. Most of the techniques discussed so far focus on this time as well. Commercial security products do not appear to be scanning the thread call stacks at rest, but open-source scanners such as PE-sieve will check return addresses when scanning.</p>



<p>This detection is partially evaded using a technique such as <a href="https://github.com/mgeeky/ThreadStackSpoofer" target="_blank" rel="noopener noreferrer">ThreadStackSpoofer</a>. This PoC hides the return address by overwriting it with zero, effectively truncating the stack. Then, depending on the state of the stack, this technique may leak arguments onto the stack. These arguments may resemble memory addresses to create an indicator for scanners that inspect return addresses.</p>



<p>A more stable technique is demonstrated in FOLIAGE. The author uses NtSetContextThread to overwrite the original thread’s context with a manufactured context that sets the desired return address. The usage of NtSetContextThread is relatively rare and may be a point of detection. The author had not observed open-source scanners or commercial security products raising alerts on this behavior at the time of release.</p>



<h5 class="wp-block-heading">Spoofing at Execution</h5>



<p>The other time a thread’s call stack may be captured is “at execution”. This is demonstrated most clearly in MalMemDetect, as described above. Our return address must point to image commit memory when we make hooked API calls to evade tools like this.</p>



<p>The <a href="https://www.unknowncheats.me/forum/anti-cheat-bypass/268039-x64-return-address-spoofing-source-explanation.html" target="_blank" rel="noopener noreferrer">x64 Return Address Spoofing</a> PoC accomplishes this nicely. A ROP gadget from a loaded DLL is stored as the return address before the API call is made, which jumps to a stub that restores the context necessary to continue execution.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="800" height="450" src="https://www.blackhillsinfosec.com/wp-content/uploads/2022/09/avoiding_memory_scanners_7.gif" alt="" class="wp-image-22881"><figcaption class="wp-element-caption"><em>Avoiding MalMemDetect</em></figcaption></figure>



<p>Since the release of AceLdr, Hunt-Sleeping-Beacons has been updated to detect FOLIAGE. The scanner will now check all threads with a wait reason of “UserRequest” which also have a return address to KiUserApcDispatcher somewhere on their call stack. This cannot be easily bypassed with the public implementation of FOLIAGE as it requires call stack spoofing of API calls in the sleep chain at execution. Since FOLIAGE is obfuscating the shellcode used for return address spoofing, it cannot be called by the APC thread to spoof return addresses.</p>



<h2 class="wp-block-heading">AceLdr</h2>



<p>As a part of this research, I released an implementation of the previously discussed techniques called <a href="https://github.com/kyleavery/AceLdr">AceLdr</a>. This tool is a user-defined reflective loader (UDRL) for Cobalt Strike with the following features at the time of release:</p>



<ul class="wp-block-list">
<li>Bypasses every referenced scanner</li>



<li>Easy to use – import a single CNA script</li>



<li>Encryption using SystemFunction032</li>



<li>Dynamic memory encryption using a secondary heap</li>



<li>Code obfuscation and encryption using FOLIAGE</li>



<li>Delayed execution using WaitForSingleObject</li>



<li>Return address spoofing at execution for InternetConnectA, NtWaitForSingleObject, and RtlAllocateHeap</li>
</ul>



<p>Black Hills Information Security used this tool for approximately one year before releasing it publicly. Below is a demonstration of AceLdr bypassing several memory scanners.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="800" height="450" src="https://www.blackhillsinfosec.com/wp-content/uploads/2022/09/avoiding_memory_scanners_8.gif" alt="" class="wp-image-22880"><figcaption class="wp-element-caption"><em>Avoiding Memory Scanners with AceLdr</em></figcaption></figure>



<h2 class="wp-block-heading">Closing Thoughts</h2>



<p>While AceLdr is made explicitly for Cobalt Strike, the techniques demonstrated in this post can be easily ported to many other projects. Each method presented here bypasses existing scanners. However, this does not guarantee they will evade future implementations, as we’ve already seen with Hunt-Sleeping-Beacons.</p>



<p>Memory scanners and commercial security products are not the same, but they share many characteristics. For example, evading open-source scanners does not guarantee security product evasion. In addition, security product evasion often does not require a complete memory scanner bypass since system resources and development costs limit vendors.</p>



<h3 class="wp-block-heading">Credits</h3>



<ul class="wp-block-list">
<li><a href="https://github.com/SecIdiot/FOLIAGE" target="_blank" rel="noopener noreferrer">https://github.com/SecIdiot/FOLIAGE</a></li>



<li><a href="https://www.unknowncheats.me/forum/anti-cheat-bypass/268039-x64-return-address-spoofing-source-explanation.html" target="_blank" rel="noopener noreferrer">https://www.unknowncheats.me/forum/anti-cheat-bypass/268039-x64-return-address-spoofing-source-explanation.html</a></li>



<li><a href="https://github.com/waldo-irc/YouMayPasser" target="_blank" rel="noopener noreferrer">https://github.com/waldo-irc/YouMayPasser</a></li>



<li><a href="https://github.com/Cracked5pider/Ekko" target="_blank" rel="noopener noreferrer">https://github.com/Cracked5pider/Ekko</a></li>



<li><a href="https://github.com/waldo-irc/MalMemDetect" target="_blank" rel="noopener noreferrer">https://github.com/waldo-irc/MalMemDetect</a></li>
</ul>



<div style="height:40px" aria-hidden="true" class="wp-block-spacer"></div>



<hr class="wp-block-separator has-text-color has-alpha-channel-opacity has-background is-style-default" style="background-color:#6f7070;color:#6f7070">



<hr class="wp-block-separator has-text-color has-alpha-channel-opacity has-background is-style-default" style="background-color:#2a2a74;color:#2a2a74">



<p class="has-text-align-center">Ready to learn more? </p>



<p class="has-text-align-center">Level up your skills with affordable classes from Antisyphon!</p>



<p class="has-text-align-center has-large-font-size"><strong><a href="https://www.antisyphontraining.com/pay-forward-what-you-can/">Pay-Forward-What-You-Can Training</a></strong></p>



<p class="has-text-align-center">Available live/virtual and on-demand</p>



<figure class="wp-block-image aligncenter size-medium is-resized"><img decoding="async" width="500" height="260" src="https://www.blackhillsinfosec.com/wp-content/uploads/2025/04/Antisyphon-Training-Powered-By-BHIS-blk-500x260.jpeg" alt="" class="wp-image-33317" style="width:200px;height:auto"></figure>



<hr class="wp-block-separator has-text-color has-alpha-channel-opacity has-background is-style-default" style="background-color:#2a2a74;color:#2a2a74">



<hr class="wp-block-separator has-text-color has-alpha-channel-opacity has-background is-style-default" style="background-color:#6f7070;color:#6f7070">

<!--themify_builder_content-->
<div id="themify_builder_content-22875" data-postid="22875" class="themify_builder_content themify_builder_content-22875 themify_builder tf_clear">
    </div>
<!--/themify_builder_content-->
            
        </div><!-- /.entry-content -->
        

	</div>
	<!-- /.post-content -->
	
</article>
<!-- /.post -->

		<div class="post-nav tf_clearfix">
			<span class="prev"><a href="https://www.blackhillsinfosec.com/so-you-want-to-build-a-conference-hardware-badge/" rel="prev"><span class="arrow"></span> So You Want to Build a Conference Hardware Badge!</a></span><span class="next"><a href="https://www.blackhillsinfosec.com/talkin-about-infosec-news-9-22-2022/" rel="next"><span class="arrow"></span> Talkin’ About Infosec News – 9/22/2022</a></span>		</div>
		<!-- /.post-nav -->

	                
                    </main>
	</div>
<!-- /#layout -->

	    </div>
	<!-- /body -->

	<div id="footerwrap">

		<div id="footer-inner">

						
			<!-- /#footer -->
			
		</div>
		<!-- /.footer-inner -->

	</div>
	<!-- /#footerwrap -->

</div>
<!-- /#pagewrap -->

<!-- wp_footer -->

<div class="simple-banner simple-banner-text" style="display:none !important"></div>
<div class="wp-dark-mode-floating-switch wp-dark-mode-ignore wp-dark-mode-animation wp-dark-mode-animation-bounce " style="right: 10px; bottom: 10px;">
	<!-- call to action  -->
	
	<div class="wp-dark-mode-switch wp-dark-mode-ignore " tabindex="0" data-style="1" data-size="1" data-text-light="" data-text-dark="" data-icon-light="" data-icon-dark=""><div class="wp-dark-mode-switch-styled wp-dark-mode-switch-1" style="--wpdm-switch-scale: 1"><div class="_track wp-dark-mode-ignore"><div class="_icon wp-dark-mode-ignore"><svg viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg" class="wp-dark-mode-ignore"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.8956 0.505198C11.2091 0.818744 11.3023 1.29057 11.1316 1.69979C10.4835 3.25296 10.125 4.95832 10.125 6.75018C10.125 13.9989 16.0013 19.8752 23.25 19.8752C25.0419 19.8752 26.7472 19.5167 28.3004 18.8686C28.7096 18.6979 29.1814 18.7911 29.495 19.1046C29.8085 19.4182 29.9017 19.89 29.731 20.2992C27.4235 25.8291 21.9642 29.7189 15.5938 29.7189C7.13689 29.7189 0.28125 22.8633 0.28125 14.4064C0.28125 8.036 4.17113 2.57666 9.70097 0.269199C10.1102 0.098441 10.582 0.191653 10.8956 0.505198Z" fill="currentColor"></path></svg></div><div class="_icon wp-dark-mode-ignore"><svg viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg" class="wp-dark-mode-ignore"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.8956 0.505198C11.2091 0.818744 11.3023 1.29057 11.1316 1.69979C10.4835 3.25296 10.125 4.95832 10.125 6.75018C10.125 13.9989 16.0013 19.8752 23.25 19.8752C25.0419 19.8752 26.7472 19.5167 28.3004 18.8686C28.7096 18.6979 29.1814 18.7911 29.495 19.1046C29.8085 19.4182 29.9017 19.89 29.731 20.2992C27.4235 25.8291 21.9642 29.7189 15.5938 29.7189C7.13689 29.7189 0.28125 22.8633 0.28125 14.4064C0.28125 8.036 4.17113 2.57666 9.70097 0.269199C10.1102 0.098441 10.582 0.191653 10.8956 0.505198Z" fill="currentColor"></path></svg></div></div></div></div></div>		
		            <!--googleoff:all-->
            <!--noindex-->
            <!--noptimize-->
            
            <!--/noptimize-->
            <!--/noindex-->
            <!--googleon:all-->
            



<!-- SCHEMA BEGIN --><!-- /SCHEMA END -->



<div class="body-overlay"></div></body></html>