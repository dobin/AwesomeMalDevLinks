Title:
An Introduction to Bypassing User Mode EDR Hooks

Type:
Blog Post

Short Summary (4–8 sentences max):
This post explains how Windows system calls work (SSDT, SSNs, ntdll syscall stubs) and why modern EDRs commonly hook user-mode ntdll functions instead of kernel structures due to PatchGuard. It breaks down typical inline-hook mechanics (overwriting the first bytes with a JMP into an EDR DLL) and how that enables parameter/return-address inspection. The author then surveys common bypass approaches: unhooking ntdll in-memory using a clean on-disk copy, manually mapping a clean ntdll, and performing direct syscalls by implementing syscall stubs yourself. It highlights the main limitation of direct syscalls: kernel-side telemetry (ETW/callbacks/filter drivers) can inspect call stacks and flag syscalls originating outside ntdll as suspicious. As an improvement, it introduces indirect syscalls—jumping to the existing `syscall` instruction inside ntdll after setting registers—to make the call stack appear ntdll-originated, while noting remaining detection angles (shellcode origin, missing hook frames) and motivating call stack spoofing. Useful for red teamers, malware researchers, and defenders wanting to understand user-mode hook bypass tradeoffs and detection opportunities.

Technical Focus:
- Windows syscall architecture (SSDT, SSN/“syscall numbers”, ntdll stubs)
- User-mode inline hooking of Nt/Zw APIs in ntdll
- Unhooking via restoring original bytes (VirtualProtect + disk comparison)
- Manual DLL mapping to obtain clean syscall stubs
- Direct vs indirect syscalls and call stack-based detection
- Kernel telemetry surfaces: ETW, kernel callbacks, filter drivers

Use Cases:
- Building or analyzing syscall-based EDR-evasion techniques in implants/loaders
- Developing detections for anomalous syscall call stacks (non-ntdll origin)
- Reverse engineering EDR user-mode hooks and understanding their control flow
- Creating lab PoCs to test hook integrity checking and re-hook behavior
- Training material for Windows internals and offensive tradecraft around ntdll

Keywords:
Windows syscalls, ntdll, NtOpenProcess, NtAllocateVirtualMemory, SSDT, SSN, syscall instruction, PatchGuard, user-mode hooking, inline hook, JMP trampoline, EDR DLL injection, VirtualProtect, unhooking, manual mapping, direct syscall, indirect syscall, call stack inspection, ETW, kernel callbacks, filter drivers