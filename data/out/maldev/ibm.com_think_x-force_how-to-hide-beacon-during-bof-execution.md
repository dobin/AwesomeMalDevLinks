# https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution

[Skip to content](https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution#main-content)[IBM logo](https://www.ibm.com/)

Software

Infrastructure

[Consulting](https://www.ibm.com/consulting?lnk=L0G)Support

[Overview](https://www.ibm.com/mysupport/s/?language=en_US&lnk=flathl)[Community](https://community.ibm.com/community/user/community?lnk=flathl)[Developer](https://developer.ibm.com/?lnk=flathl)[Documentation](https://www.ibm.com/docs/en?lnk=flathl)[IBM Cloud platform](https://www.ibm.com/products/cloud/support?lnk=flathl)[Implementation](https://www.ibm.com/products/expertlabs?lnk=flatitem)[Training](https://www.ibm.com/training/?lnk=flathl)[Technology Lifecycle Services](https://www.ibm.com/services/technology-lifecycle-services?lnk=flathl)[Think 2026](https://www.ibm.com/events/think)

[Cart](https://www.ibm.com/store/en/us/checkout)

My IBM
Log in


[Think](https://www.ibm.com/think)

- [Artificial intelligence](https://www.ibm.com/think/artificial-intelligence)
- [Cloud](https://www.ibm.com/think/cloud)
- [Security](https://www.ibm.com/think/security)
- [News](https://www.ibm.com/think/news)
- Videos






  - [Overview](https://www.ibm.com/think/videos)
  - [AI Academy](https://www.ibm.com/think/videos/ai-academy)
  - [Think 2025 on demand](https://www.ibm.com/think/videos/think-keynotes)
  - [Webinars](https://www.ibm.com/think/webinars)

- Reports






  - [Cost of a Data Breach Report 2025](https://www.ibm.com/reports/data-breach)
  - [The 2025 CEO Study](https://www.ibm.com/thought-leadership/institute-business-value/c-suite-study/ceo)
  - [IBM X-Force 2025 Threat Intelligence Index](https://www.ibm.com/thought-leadership/institute-business-value/report/2025-threat-intelligence-index)
  - [Industries in the AI era](https://www.ibm.com/thought-leadership/institute-business-value/report/industries-ai-era)
  - [Orchestrating agentic AI for intelligent business operations](https://www.ibm.com/thought-leadership/institute-business-value/report/agentic-process-automation)
  - [Scaling supply chain resilience: Agentic AI for autonomous operations](https://www.ibm.com/thought-leadership/institute-business-value/report/supply-chain-ai-automation-oracle)
  - [AI in Action report](https://www.ibm.com/think/reports/ai-in-action)
  - [State of Sustainability Readiness Report](https://www.ibm.com/think/reports/sustainability-readiness)
  - [View all IBV reports](https://www.ibm.com/thought-leadership/institute-business-value)

- Podcasts






  - [Overview](https://www.ibm.com/think/podcasts)
  - [AI in Action](https://www.ibm.com/think/podcasts/ai-in-action)
  - [Mixture of Experts](https://www.ibm.com/think/podcasts/mixture-of-experts)
  - [Security Intelligence](https://www.ibm.com/think/podcasts/security-intelligence)
  - [Smart Talks with IBM](https://www.ibm.com/think/podcasts/smart-talks)
  - [Techsplainers](https://www.ibm.com/think/podcasts/techsplainers)
  - [The Coherence Times](https://www.ibm.com/think/podcasts/the-coherence-times)
  - [Transformers Podcast](https://www.ibm.com/think/podcasts/transformers-podcast)

- Events






  - [Think 2026](https://www.ibm.com/events/think)
  - [Think on Tour](https://www.ibm.com/events/think/on-tour)
  - [TechXchange](https://www.ibm.com/events/techxchange)
  - [View all IBM Events](https://www.ibm.com/events)

- More






## Topics



  - [Analytics](https://www.ibm.com/think/analytics)
  - [Asset management](https://www.ibm.com/think/asset-management)
  - [Business automation](https://www.ibm.com/think/business-automation)
  - [Business operations](https://www.ibm.com/think/business-operations)
  - [Compute and servers](https://www.ibm.com/think/compute)
  - [DevOps](https://www.ibm.com/think/devops)
  - [IT automation](https://www.ibm.com/think/it-automation)
  - [IT infrastructure](https://www.ibm.com/think/it-infrastructure)
  - [Middleware](https://www.ibm.com/think/middleware)
  - [Network](https://www.ibm.com/think/network)
  - [Quantum](https://www.ibm.com/think/quantum)
  - [Security](https://www.ibm.com/think/security)
  - [Storage](https://www.ibm.com/think/storage)
  - [Sustainability](https://www.ibm.com/think/sustainability)

## Content types

  - [Explainers](https://www.ibm.com/think/topics)
  - [Insights](https://www.ibm.com/think/insights)
  - [News](https://www.ibm.com/think/news)
  - [Newsletters](https://www.ibm.com/subscribe)
  - [Reference architectures](https://www.ibm.com/think/architectures)
  - [Tutorials](https://www.ibm.com/think/tutorials)

## Industries

  - [Automotive](https://www.ibm.com/think/automotive)
  - [Banking](https://www.ibm.com/think/banking-financial-markets)
  - [Consumer Goods](https://www.ibm.com/think/consumer-goods)
  - [Energy & Utilities](https://www.ibm.com/think/energy)
  - [Government](https://www.ibm.com/think/government)
  - [Healthcare](https://www.ibm.com/think/healthcare)
  - [Manufacturing](https://www.ibm.com/think/manufacturing)
  - [Retail](https://www.ibm.com/think/retail)
  - [Telecommunications](https://www.ibm.com/think/telecommunications)
  - [Travel](https://www.ibm.com/think/travel-transportation)

[View all](https://www.ibm.com/think/search)

Subscribe

[Security](https://www.ibm.com/think/security)

# Your BOFs are gross, put on a mask: how to hide beacon during BOF execution

![Female professional with face mask working at her desk in office](https://assets.ibm.com/is/image/ibm/ec731042-1789-4c5d-9e1b638a42879b94?dpr=on%2C1&wid=320&hei=213)

- [Overview](https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution#Overview)
- [Beacon object file basics](https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution#Beacon+object+file+basics)
- [Finding Beacon’s base address](https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution#Finding+Beacon%E2%80%99s+base+address)
- [Accounting for malleable C2 and UDRLs](https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution#Accounting+for+malleable+C2+and+UDRLs)
- [Masking Beacon](https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution#Masking+Beacon)
- [Demonstration](https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution#Demonstration)
- [Caveats](https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution#Caveats)
- [Integration with existing tooling](https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution#Integration+with+existing+tooling)
- [Detections](https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution#Detections)
- [Conclusion](https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution#Conclusion)

## Author

Joshua Magri

Senior Managing Security Consultant

Adversary Services, IBM X-Force Red

In this post, we’ll review a simple technique that we’ve developed to encrypt Cobalt Strike’s Beacon in memory while executing BOFs to prevent a memory scan from detecting Beacon.

Picture this — you’re on a red team engagement and your phish went through, your initial access payload got past EDR, your beacon is now living in memory and calling back to you. The hard part is over, time to do some post-exploitation. You fire up your trusty BOF toolkit and watch the “last” timer tick up indefinitely.

While an initial beacon can go undetected, performing common post-exploitation activities from a Beacon Object File can trigger a memory scan of your process by [EDR](https://www.ibm.com/think/topics/edr). This can result in an EDR product finding your Beacon sitting in memory and killing the process.

Cobalt Strike (somewhat) recently introduced the Sleep Mask functionality, which serves to hide Beacon in memory while it’s sleeping. This helps prevent detection by threat hunting tools or memory scanners that look for Beacon signatures or suspicious artifacts like unbacked executable memory. As of Cobalt Strike 4.7, Sleep Mask is implemented as a BOF, which provides the operator with much more control over how Sleep Mask works. This demonstrates that it is possible to have Beacon encrypted and sleeping during BOF execution. However, during normal BOF execution, Beacon is sitting in memory. Let’s look at how to change that.

## Beacon object file basics

If you’re unfamiliar with the internals of Beacon Object Files (BOFs), they’re essentially a way to write position independent code where Beacon handles loading and linking any dependencies. This allows operators to quickly develop post-exploitation tooling without the hassle of writing shellcode or reflective DLLs.

When you execute a BOF, it looks something like this:

1. Beacon allocates memory according to your Malleable C2 settings and writes the BOF content
2. The BOF loader handles linking any imported functions and finding the specified entry point of the BOF
3. Execution is passed to the entry point, your BOF content runs, and Beacon resumes executing
4. Allocated BOF memory is cleaned up according to your Malleable C2 settings

This blog is not intended to be a reference on BOFs, so you can find more information about BOFs here:

- [A Developer’s Introduction to Beacon Object Files](https://www.trustedsec.com/blog/a-developers-introduction-to-beacon-object-files), TrustedSec
- [Beacon Object Files](https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/beacon-object-files_main.htm), Cobalt Strike

Industry newsletter

### The latest tech news, backed by expert insights

Stay up to date on the most important—and intriguing—industry trends on AI, automation, data and beyond with the Think Newsletter. See the [IBM Privacy Statement](https://www.ibm.com/privacy).

### Thank you! You are subscribed.

- Account information


Current

We use your email to validate you are who you say you are, to create your IBMid, and to contact you for account related matters.

Business email

Your subscription will be delivered in English. You will find an unsubscribe link in every newsletter. You can manage your subscriptions or unsubscribe [here.](https://www.ibm.com/account/reg/us-en/signup?formid=news-urx-51525) Refer to our [IBM Privacy Statement](https://www.ibm.com/us-en/privacy) for more information.

Subscribe

Your subscription will be delivered in English. You will find an unsubscribe link in every newsletter. You can manage your subscriptions or unsubscribe [here](https://www.ibm.com/account/reg/signup?formid=news-urx-51525). Refer to our [IBM Privacy Statement](https://www.ibm.com/privacy) for more information.

## Finding Beacon’s base address

To mask Beacon in memory, we need to know its base address and its size. There are a few ways we could figure out this information, but the method I found to be most reliable uses a bit of assembly and the VirtualQuery API.

When a BOF is executed, and we call a function from our BOF entry point, our stack frame looks like this at the top:

1. Current function
2. BOF entry point
3. Beacon

Below is a snippet of assembly to go back two stack frames. This will get us from our function to our BOF entry point, to the return address of Beacon. This will give us the address that Beacon will resume executing from after our BOF finishes, which is inside Beacon’s .text section.

![Code snippet of assembly to go back from our function to our BOF entry point to the return address of Beacon](https://assets.ibm.com/is/image/ibm/your-bofs-are-gross-put-on-a-mask-how-to-hide-beacon-during-bof-execution-1:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

Now that we have an address for Beacon’s memory range, we need to find its base address. We can accomplish this with two calls to VirtualQuery. The first one will get us the base address of the region that the previous address is in, and the second will give us the base address and size of the allocation that was made for Beacon. These second two values are what we will need for masking.

## Accounting for malleable C2 and UDRLs

One of Beacon’s greatest features is how it exposes flexibility to operators at many points. There are two main mechanisms for changing how Beacon is loaded into memory: Malleable C2 settings and User Defined Reflective Loaders. Here are some links diving into both:

- [Defining the Cobalt Strike Reflective Loader](https://www.ibm.com/think/x-force/defining-cobalt-strike-reflective-loader), Security Intelligence
- [PE and Memory Indicators](https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2-extend_pe-memory-indicators.htm#_Toc65482854), Cobalt Strike

We need to account for the fact that Beacon might be loaded into memory in different ways that will break our VirtualQuery logic. When you call VirtualQuery on a region of memory, it will return results for all of the following pages in memory that share the same attributes (memory protection and page state). So if Beacon is allocated entirely with RWX permissions then calling VirtualQuery twice works perfectly. But if you properly set the memory protections for each section of Beacon, then calling VirtualQuery on the base address of Beacon will only return the size of the NT Header section, since it will have a different memory protection setting than the .text section.

Thankfully, compensating for this is pretty straightforward. We can query the next region in memory and verify that it is executable and that the return address we got for Beacon earlier falls within that region. If it does, then we’ve found Beacon’s .text section!



Mixture of Experts \| 13 February, episode 94




![What do people really use AI for?](https://cdnsecakmi.kaltura.com/p/1773841/thumbnail/entry_id/1_m4234x30/width/0)

### Decoding AI: Weekly News Roundup

Join our world-class panel of engineers, researchers, product leaders and more as they cut through the AI noise to bring you the latest in AI news and insights.

Watch all episodes of Mixture of Experts

## Masking Beacon

Now that we have the base address and size of Beacon’s .text section, we can change the page protection and then apply our mask.

![Code snippet to call VirtualProtect to change Beacon’s page protection to RW, and then apply a simple XOR mask across our Beacon](https://assets.ibm.com/is/image/ibm/your-bofs-are-gross-put-on-a-mask-how-to-hide-beacon-during-bof-execution-2:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

In the snippet above, we call VirtualProtect to change Beacon’s page protection to RW, and then apply a simple XOR mask across our Beacon. We generate this random mask once in our setup function for simplicity. To unmask Beacon, we just reverse the order of these two operations by applying the XOR again and changing Beacon’s page protection to whatever it was before (RWX or RX).

## Demonstration

For demonstration purposes, we have a BOF that just calls MessageBoxA to block execution and give us an opportunity to scan the memory of our Beacon process with some common memory analysis tools: Moneta, PESieve, and YARA.

### Without Masking

Here is Moneta reporting three unbacked RX regions. This is our Beacon, our Sleep Mask BOF, and the BOF we’re currently executing. This may look different for you depending on your Malleable C2 profile.

![Moneta reporting three unbacked RX regions - our Beacon, our Sleep Mask BOF and the BOF we’re currently executing](https://assets.ibm.com/is/image/ibm/your-bofs-are-gross-put-on-a-mask-how-to-hide-beacon-during-bof-execution-3:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

Here is PE-Sieve with the /shellc and /data three options dumping out a region that we can see is our Beacon.

![PE-Sieve with the /shellc and /data three options dumping out a region that we can see is our Beacon.](https://assets.ibm.com/is/image/ibm/your-bofs-are-gross-put-on-a-mask-how-to-hide-beacon-during-bof-execution-4:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

Here is a YARA detection from [this set of rules](https://github.com/elastic/protections-artifacts/blob/main/yara/rules/Windows_Trojan_CobaltStrike.yar) published by Elastic to detect Cobalt Strike.

![A YARA detection from a set of rules published by Elastic to detect Cobalt Strike.](https://assets.ibm.com/is/image/ibm/your-bofs-are-gross-put-on-a-mask-how-to-hide-beacon-during-bof-execution-5:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

### With Masking

Now we can apply our masking code to hide Beacon in memory and try again. Here is Moneta reporting on our Sleep Mask BOF and our currently executing BOF, but not our Beacon.

![Moneta reporting on our Sleep Mask BOF and our currently executing BOF, but not our Beacon](https://assets.ibm.com/is/image/ibm/your-bofs-are-gross-put-on-a-mask-how-to-hide-beacon-during-bof-execution-6:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

PE-Sieve output with zero detections.

![PE-Sieve output with zero detections.](https://assets.ibm.com/is/image/ibm/your-bofs-are-gross-put-on-a-mask-how-to-hide-beacon-during-bof-execution-7:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

And no detections from YARA.

![And no detections from YARA.](https://www.ibm.com/adobe/dynamicmedia/deliver/dm-aid--6db4de8c-47b7-4555-95a9-ec8f18d5e28c/your-bofs-are-gross-put-on-a-mask-how-to-hide-beacon-during-bof-execution-8.png?preferwebp=true&width=320)

As you can see, this technique does yield results and should help prevent memory scanners from detecting our Beacon via signature-based detections or memory artifacts during BOF execution. The presence of our current BOF and our Sleep Mask BOF are not ideal, as they are unbacked RX region IOCs, but EDR may not alert solely on this if no signatures are identified during the memory scan.

If these unbacked memory regions are a concern, it is relatively simple to identify and mask the Sleep Mask BOF in a similar fashion. As for masking the current BOF, it should be possible to mask with some existing ROP techniques, but it gets very difficult for more complex BOFs.

## Caveats

The most important thing to note with this technique is that you CANNOT call Beacon APIs from your BOF while Beacon is encrypted — this means any of the internal Beacon APIs like BeaconPrintf, BeaconSpawnInject, etc. Since these functions are located in the .text section of Beacon you will be passing execution to non-executable garbage code and your Beacon will die. If you have output that you need to get from your BOF then you can either send it all back after unmasking, or you can toggle the mask before/after every Beacon API call.

## Integration with existing tooling

To allow red teams to simulate more advanced threat actors and allow blue teams to be more familiar with memory scanning evasion techniques, we wanted to implement this technique so that integrating it with your BOF arsenal is as easy as possible. To that end, we’ve published this project as a single C header file that you can include in your existing BOF. You just need to call the GetBeaconBaseAddress function before calling MaskBeacon for the first time, and then you can call the MaskBeacon/UnmaskBeacon functions to toggle the mask. An example BOF entrypoint would look like this.

![An example BOF entrypoint](https://assets.ibm.com/is/image/ibm/your-bofs-are-gross-put-on-a-mask-how-to-hide-beacon-during-bof-execution-9:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

If you want to call Beacon APIs inside of your code, you can just toggle the mask like this.

![Example of how to toggle mask to call Beacon APIs inside of your code](https://assets.ibm.com/is/image/ibm/your-bofs-are-gross-suspicious-code?fmt=png-alpha&dpr=on%2C1&wid=320&hei=66)

Stability is always a concern when operating over a C2 channel, and errors in a BOF are a great way to kill your hard-earned Beacon. We have tried to make this code as reliable and stable as possible, but there is always the chance that something can go wrong. If your BOF relies on any Beacon API calls, you should thoroughly test to ensure that you will not hit any snags during execution as a result of the masking. The same goes for using this code with any complicated loaders — you should ensure that the .text section of Beacon is properly located before executing. Some debugging directives have been included to help with troubleshooting.

## Detections

As with any C2 related subject matter, detection is a chief concern. However, detecting BOF-specific execution is not a particularly useful area to focus on. BOFs are ultimately just position independent code being loaded with a handful of benign API calls. Detection efforts are much better spent on detecting Beacon execution and post-exploitation activity. For a BOF to be useful it must generate some activity on the host or the network, and hunting these behaviors is far more fruitful. Some example BOF activities could include [enumerating the local host or Active Directory](https://github.com/trustedsec/CS-Situational-Awareness-BOF), [credential dumping activities](https://github.com/anthemtotheego/CredBandit), or [injecting into another process](https://github.com/ajpc500/BOFs).

All of that said, this technique does leave the executing BOF and a Sleep Mask BOF in memory as unbacked RX (or RWX) regions. These are generally good indicators of malicious activity for threat hunters and memory scanners alike. However, as mentioned above, there are ways that these artifacts can be hidden by a skilled operator.

Below is a non-comprehensive list of resources that you can use for detecting Cobalt Strike and performing memory analysis.

- [Cobalt Strike YARA rules](https://github.com/elastic/protections-artifacts/blob/main/yara/rules/Windows_Trojan_CobaltStrike.yar), Elastic
- [PE-Sieve](https://github.com/hasherezade/pe-sieve), Hasherezade
- [Moneta](https://github.com/forrest-orr/moneta), Forrest Orr
- [Hunt Sleeping Beacons](https://github.com/thefLink/Hunt-Sleeping-Beacons), @thefLinkk
- [BeaconEye](https://github.com/CCob/BeaconEye), Ceri Coburn
- [Cobalt Strike, A Defender’s Guide](https://thedfirreport.com/2021/08/29/cobalt-strike-a-defenders-guide/), The DFIR Report

## Conclusion

In this post, we’ve shown how we can apply the same principle as Beacon’s Sleep Mask kit to provide some extra OPSEC to Beacon during BOF execution. We believe that this is a relatively simple technique that can provide big returns against products that utilize memory scanning and static signature detection.

You can find the published header file [here](https://github.com/xforcered/bofmask).

Learn about adversary simulation services from IBM X-Force [here](https://www.ibm.com/services/adversary-simulation).

Link copied


[![close icon](https://consent.trustarc.com/get?name=ibm_close_icon.svg)](https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution#)

IBM web domains

ibm.com, ibm.org, ibm-zcouncil.com, insights-on-business.com, jazz.net, mobilebusinessinsights.com, promontory.com, proveit.com, ptech.org, s81c.com, securityintelligence.com, skillsbuild.org, softlayer.com, storagecommunity.org, think-exchange.com, thoughtsoncloud.com, alphaevents.webcasts.com, ibm-cloud.github.io, ibmbigdatahub.com, bluemix.net, mybluemix.net, ibm.net, ibmcloud.com, galasa.dev, blueworkslive.com, swiss-quantum.ch, blueworkslive.com, cloudant.com, ibm.ie, ibm.fr, ibm.com.br, ibm.co, ibm.ca, community.watsonanalytics.com, datapower.com, skills.yourlearning.ibm.com, bluewolf.com, carbondesignsystem.com, openliberty.io

![close icon](https://consent.trustarc.com/get?name=ibm_close_icon.svg)

About cookies on this siteOur websites require some cookies to function properly (required). In addition, other cookies may be used with your consent to analyze site usage, improve the user experience and for advertising.For more information, please review your cookie preferences options. By visiting our website, you agree to our processing of information as described in IBM’s [privacy statement](https://www.ibm.com/privacy). To provide a smooth navigation, your cookie preferences will be shared across the IBM web domains listed [here](https://www.ibm.com/think/x-force/how-to-hide-beacon-during-bof-execution#truste_domain_list).

Accept allMore options

Loading

START


END


START


END