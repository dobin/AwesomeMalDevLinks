Title:
Bypassing EDRs With EDR-Preloading

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes “EDR-Preloading,” a technique to run attacker-controlled code during very early Windows process initialization—before an EDR’s user-mode DLL is injected/initialized—so the EDR module can be prevented from running at all.  
- It focuses on Windows loader internals (LdrInitializeThunk/LdrpInitialize/LdrpInitializeProcess) and the timing window where many EDRs execute their injected DLL via APCs processed at ZwTestAlert.  
- The core idea is to abuse AppVerifier/ShimEngine callback pointers in ntdll (notably AvrfpAPILookupCallbackRoutine) that are writable early and are invoked during LdrGetProcedureAddressForCaller when kernelbase.dll is resolved.  
- A PoC launches a target process suspended, locates the .mrdata callback variables, writes an encoded callback pointer (using the SharedUserData pointer cookie), then resumes to gain execution under loader-lock constraints.  
- From that early foothold it “neutralizes” EDR user-mode components by clobbering suspicious module entrypoints, disabling APC dispatch (KiUserApcDispatcher), and optionally proxying LdrLoadDll to monitor/block loads.  
- Useful for red teamers, implant developers, and defenders validating assumptions about user-mode injection timing and hardening opportunities around early-process instrumentation.

Technical Focus:
- Windows process initialization and loader flow (LdrInitializeThunk, LdrpInitializeProcess, RtlUserThreadStart)
- AppVerifier/ShimEngine ntdll callbacks (AvrfpAPILookupCallbackRoutine, AvrfpAPILookupCallbacksEnabled)
- ntdll .mrdata scanning and early writable globals
- Pointer encoding with SharedUserData!Cookie (system pointer cookie)
- EDR user-mode DLL injection via APCs (ZwTestAlert / NtQueueApcThread) and APC dispatcher manipulation
- Loader-lock constraints and early-stage module tampering (LDR lists, entrypoint clobbering)

Use Cases:
- Pre-entrypoint execution to bypass user-mode EDR hooks without direct/indirect syscalls
- Neutralizing or delaying EDR user-mode DLL initialization in newly spawned processes
- Researching/validating EDR injection timing and early-process attack surface
- Building stealthier early-stage loaders compared to classic Early Bird APC injection
- Defensive testing: creating detections for ntdll callback tampering, .mrdata writes, and APC-dispatcher patching

Keywords:
EDR bypass, EDR preloading, Windows loader, ntdll, LdrInitializeThunk, LdrpInitialize, LdrpInitializeProcess, ZwTestAlert, APC, NtQueueApcThread, KiUserApcDispatcher, AppVerifier, ShimEngine, AvrfpAPILookupCallbackRoutine, LdrGetProcedureAddressForCaller, .mrdata, PEB, LDR module list, SharedUserData Cookie, pointer encoding, WriteProcessMemory, suspended process, loader lock, LdrLoadDll hook