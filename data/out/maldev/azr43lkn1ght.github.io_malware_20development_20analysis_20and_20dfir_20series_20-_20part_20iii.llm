Title:
Malware Development, Analysis and DFIR Series – Part III (Windows Memory Internals & Process Internals)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post is a primer on Windows/x86 memory internals aimed at supporting malware development, malware analysis, and DFIR/memory forensics work.  
- It explains core memory models (physical, flat/linear, segmented) and CPU modes (real mode, protected mode/long mode, and SMM), with emphasis on why segmentation is largely abstracted on x86_64 except for FS/GS usage (e.g., TEB).  
- The article walks through virtual memory concepts and paging, including demand paging, shared memory, and copy-on-write, and why these matter for analysis when data may be resident or swapped.  
- It details address translation mechanics for x86 (PDE/PTE, CR3, 4KB vs 4MB pages, CR4.PSE) and x86_64 (canonical addresses, 4-level paging with PML4/PDPT/PDE/PTE, large pages 2MB/1GB).  
- It then connects memory management to Windows process internals: _EPROCESS, ActiveProcessLinks, PEB, _KPROCESS/PCB, tokens, handle tables, threads, memory layout, page tables, and VADs.  
- Useful for red teamers and malware devs needing reliable mental models for injection/unpacking and for blue team/DFIR analysts doing memory triage, artifact extraction, and process/memory structure interpretation.

Technical Focus:
- x86/x64 memory models and CPU modes (real/protected/long mode, SMM)
- Virtual memory, paging, demand paging, shared memory, copy-on-write
- Address translation via CR3 and paging structures (PDE/PTE, PML4/PDPT)
- Large pages (4MB/2MB/1GB) and control bits (CR4.PSE, PS flag)
- Windows process internals (_EPROCESS, PEB, _KPROCESS, tokens, handles)
- VAD trees and process memory layout for forensics

Use Cases:
- Memory forensics: mapping virtual addresses to physical pages and interpreting swapped-out artifacts
- Malware analysis: understanding unpacked-in-memory code regions and process memory layout
- Rootkit/stealth research: reasoning about process lists (ActiveProcessLinks) and kernel/user structure relationships
- Detection engineering: identifying suspicious VAD protections, injected DLL regions, and anomalous memory mappings
- Debugging/internals work: correlating CR3/DirectoryTableBase with per-process address spaces

Keywords:
Windows internals, virtual memory, paging, segmentation, x86, x86_64, long mode, real mode, protected mode, SMM, MMU, CR3, CR4, PSE, page fault, PDE, PTE, PML4, PDPT, canonical addresses, large pages, 2MB pages, 1GB pages, _EPROCESS, ActiveProcessLinks, PEB, _KPROCESS, DirectoryTableBase, access token, SID, handle table, _FILE_OBJECT, VAD, ASLR, memory forensics, Volatility