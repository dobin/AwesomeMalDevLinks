Title:
Running Arbitrary Programs as AntiMalware Protected Process Light (PPL) via ELAM (PPLRunner) and Consuming Microsoft-Windows-Threat-Intelligence ETW

Type:
Blog Post

Short Summary (4â€“8 sentences max):
- The post documents how to create and run a custom Windows service as an AntiMalware Protected Process Light (PPL) by pairing it with an ELAM driver and appropriate signing requirements (demonstrated in testsigning mode).  
- It explains why AntiMalware PPL exists (harder to tamper with/inspect) and highlights the key benefit for research: only PPL processes receive events from the `Microsoft-Windows-Threat-Intelligence` ETW provider.  
- The author walks through generating a self-signed cert with the Early Launch and Code Signing EKUs, building an ELAM driver containing the `MSElamCertInfoID` resource, and installing the ELAM cert via `InstallElamCertificateInfo`.  
- They then create a protected service (`SERVICE_LAUNCH_PROTECTED_ANTIMALWARE_LIGHT`) and show how it can spawn child processes as PPL using `STARTUPINFOEX` with `PROC_THREAD_ATTRIBUTE_PROTECTION_LEVEL` and `CREATE_PROTECTED_PROCESS`.  
- The techniques are packaged into PPLRunner, which launches an arbitrary signed payload as PPL based on a registry configuration and then exits to allow re-runs.  
- Finally, PPLRunner is used to run Sealighter as PPL to successfully collect and log Threat-Intelligence ETW events (e.g., memory allocation telemetry) into the Windows Event Log.  
- Useful for Windows security researchers, red teamers, and defenders investigating ETW/telemetry, PPL boundaries, and protected service behavior.

Technical Focus:
- Protected Process Light (PPL) / AntiMalware PPL mechanics (EPROCESS protection)
- ELAM driver signing and `MSElamCertInfoID` resource (`MicrosoftElamCertificateInfo`)
- Testsigning mode and certificate EKUs (Early Launch, Code Signing), SHA256 requirements
- Windows Service APIs for protected services (`ChangeServiceConfig2`, `SERVICE_CONFIG_LAUNCH_PROTECTED`)
- Protected process creation (`STARTUPINFOEX`, `PROC_THREAD_ATTRIBUTE_PROTECTION_LEVEL`, `CREATE_PROTECTED_PROCESS`)
- ETW consumption of `Microsoft-Windows-Threat-Intelligence` and event export/logging

Use Cases:
- Run a research tool as AntiMalware PPL to access Threat-Intelligence ETW events
- Validate what operations are blocked/allowed against PPL processes (debugging, termination, inspection)
- Build lab telemetry pipelines by logging TI ETW events to Event Log/JSON for analysis
- Prototype protected service/process behaviors for EDR evaluation or defensive engineering

Keywords:
Protected Process Light, PPL, AntiMalware PPL, ELAM, Early Launch AntiMalware, MSElamCertInfoID, MicrosoftElamCertificateInfo, InstallElamCertificateInfo, testsigning, bcdedit, New-SelfSignedCertificate, EKU, SHA256, signtool, Windows services, ChangeServiceConfig2, SERVICE_LAUNCH_PROTECTED_ANTIMALWARE_LIGHT, STARTUPINFOEX, PROC_THREAD_ATTRIBUTE_PROTECTION_LEVEL, CREATE_PROTECTED_PROCESS, CreateProcess, ETW, Microsoft-Windows-Threat-Intelligence, Sealighter, Windows Event Log, Process Explorer, EPROCESS