Title:
Spoofing Call Stacks To Confuse EDRs

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains and demonstrates a proof-of-concept technique to spoof user-mode call stacks so that EDR/Sysmon/ETW stack-trace telemetry records a benign-looking stack for a suspicious action (e.g., opening a handle to LSASS via NtOpenProcess).  
- It focuses on “active” call stack deception during a specific TTP, rather than only masking sleeping threads (contrasting prior work like ThreadStackSpoofer/Ekko).  
- The author walks through how kernel callbacks (e.g., ObRegisterCallbacks) and tools like Sysmon collect user-mode call traces using RtlWalkFrameChain and x64 unwind metadata (.pdata / UNWIND_CODE).  
- The PoC builds a suspended “sacrificial” thread, crafts its stack layout and CONTEXT (RSP/RIP and argument registers) to match a chosen target call trace, resumes it to execute the syscall, then handles the inevitable unwind/return failure via VEH and exits cleanly.  
- It shows that even code executing from unbacked/injected memory can produce a plausible call trace, undermining detections that rely on “UNKNOWN/unbacked” frames in stack telemetry.  
- Useful for red teams and malware developers evaluating EDR blind spots; also relevant to blue teams for understanding limitations of stack-based detections and how attackers may evade them.

Technical Focus:
- Windows kernel callbacks for security telemetry (ObRegisterCallbacks, PsSetCreate*NotifyRoutine*)
- Sysmon Process Access (Event ID 10) call trace collection and RtlWalkFrameChain
- x64 stack unwinding via .pdata / UNWIND_CODE parsing and RtlVirtualUnwind
- Thread CONTEXT manipulation (RIP/RSP, RCX/RDX/R8/R9 calling convention) and suspended thread setup
- Vectored Exception Handling (VEH) for control-flow recovery after spoofed returns
- Call stack spoofing to hide unbacked/injected code origins

Use Cases:
- Evade stack-trace-based detections for LSASS handle access / credential dumping prep
- Make injected/reflective DLL activity appear to originate from legitimate modules (RPC/WMI/svchost-like stacks)
- Red team research to test EDR reliance on call-trace telemetry and tune tradecraft
- Defensive validation: build detections for stack spoofing artifacts (thread anomalies, inconsistent unwind/return behavior)

Keywords:
call stack spoofing, EDR evasion, Sysmon Event ID 10, CallTrace, ETW stack traces, ObRegisterCallbacks, PsSetCreateProcessNotifyRoutineEx, RtlWalkFrameChain, RtlVirtualUnwind, UNWIND_CODE, .pdata, x64 unwind info, NtOpenProcess, OpenProcess, LSASS, handle access, reflective DLL injection, unbacked memory, CONTEXT, VEH, KiSystemServiceCopyEnd