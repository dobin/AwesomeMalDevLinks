# https://medium.com/@matterpreter/adventures-in-dynamic-evasion-1fe0bac57aa

<!DOCTYPE html><html lang="en" data-rh="lang" dir="ltr"><body><div id="root"><div class="a b c"><a href="https://medium.com/sitemap/sitemap.xml" class="d">Sitemap</a><div class="e f g h i j k l"></div><div></div><div class="m c"><div class="m n o p c" style="transform: translateY(0px);"><div class="q r s t u v w x y j e z ab"><a class="eb ai ec bg am b ao ap aq ar as at au av t v x j e r ed ab" href="https://play.google.com/store/apps/details?id=com.medium.reader&amp;referrer=utm_source%3DmobileNavBar&amp;source=post_page---top_nav_layout_nav-----------------------------------------" rel="noopener follow">Open in app<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="none" viewBox="0 0 10 10" class="ea"><path fill="currentColor" d="M.985 8.485a.375.375 0 1 0 .53.53zM8.75 1.25h.375A.375.375 0 0 0 8.75.875zM8.375 6.5a.375.375 0 1 0 .75 0zM3.5.875a.375.375 0 1 0 0 .75zm-1.985 8.14 7.5-7.5-.53-.53-7.5 7.5zm6.86-7.765V6.5h.75V1.25zM3.5 1.625h5.25v-.75H3.5z"></path></svg></a><div class="ac r"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><button class="bg b ee ef ep eg eh eq ei ej er es el et eu eo ev ew ex ey ez fa fb fc fd fe ff fg fh fi fj fk bn fl fm" data-testid="headerSignUpButton">Sign up</button></span></p><div class="fn m"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerSignInButton" rel="noopener follow" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Fmedium.com%2F%40matterpreter%2Fadventures-in-dynamic-evasion-1fe0bac57aa&amp;source=post_page---top_nav_layout_nav-----------------------global_nav------------------" data-discover="true">Sign in</a></span></p></div></div></div><div class="q r s ac ae af"><div class="ac r ag"><a class="ah ai aj ak al am an ao ap aq ar as at au av ac" aria-label="Homepage" data-testid="headerMediumLogo" rel="noopener follow" href="https://medium.com/?source=post_page---top_nav_layout_nav-----------------------------------------" data-discover="true"><svg xmlns="http://www.w3.org/2000/svg" width="719" height="160" fill="none" aria-labelledby="wordmark-medium-desc" viewBox="0 0 719 160" class="aw ax ay"><desc id="wordmark-medium-desc">Medium Logo</desc><path fill="#242424" d="m174.104 9.734.215-.047V8.02H130.39L89.6 103.89 48.81 8.021H1.472v1.666l.212.047c8.018 1.81 12.09 4.509 12.09 14.242V137.93c0 9.734-4.087 12.433-12.106 14.243l-.212.047v1.671h32.118v-1.665l-.213-.048c-8.018-1.809-12.089-4.509-12.089-14.242V30.586l52.399 123.305h2.972l53.925-126.743V140.75c-.687 7.688-4.721 10.062-11.982 11.701l-.215.05v1.652h55.948v-1.652l-.215-.05c-7.269-1.639-11.4-4.013-12.087-11.701l-.037-116.774h.037c0-9.733 4.071-12.432 12.087-14.242m25.555 75.488c.915-20.474 8.268-35.252 20.606-35.507 3.806.063 6.998 1.312 9.479 3.714 5.272 5.118 7.751 15.812 7.368 31.793zm-.553 5.77h65.573v-.275c-.186-15.656-4.721-27.834-13.466-36.196-7.559-7.227-18.751-11.203-30.507-11.203h-.263c-6.101 0-13.584 1.48-18.909 4.16-6.061 2.807-11.407 7.003-15.855 12.511-7.161 8.874-11.499 20.866-12.554 34.343q-.05.606-.092 1.212a50 50 0 0 0-.065 1.151 85.807 85.807 0 0 0-.094 5.689c.71 30.524 17.198 54.917 46.483 54.917 25.705 0 40.675-18.791 44.407-44.013l-1.886-.664c-6.557 13.556-18.334 21.771-31.738 20.769-18.297-1.369-32.314-19.922-31.042-42.395m139.722 41.359c-2.151 5.101-6.639 7.908-12.653 7.908s-11.513-4.129-15.418-11.63c-4.197-8.053-6.405-19.436-6.405-32.92 0-28.067 8.729-46.22 22.24-46.22 5.657 0 10.111 2.807 12.236 7.704zm43.499 20.008c-8.019-1.897-12.089-4.722-12.089-14.951V1.309l-48.716 14.353v1.757l.299-.024c6.72-.543 11.278.386 13.925 2.83 2.072 1.915 3.082 4.853 3.082 8.987v18.66c-4.803-3.067-10.516-4.56-17.448-4.56-14.059 0-26.909 5.92-36.176 16.672-9.66 11.205-14.767 26.518-14.767 44.278-.003 31.72 15.612 53.039 38.851 53.039 13.595 0 24.533-7.449 29.54-20.013v16.865h43.711v-1.746zM424.1 19.819c0-9.904-7.468-17.374-17.375-17.374-9.859 0-17.573 7.632-17.573 17.374s7.721 17.374 17.573 17.374c9.907 0 17.375-7.47 17.375-17.374m11.499 132.546c-8.019-1.897-12.089-4.722-12.089-14.951h-.035V43.635l-43.714 12.551v1.705l.263.024c9.458.842 12.047 4.1 12.047 15.152v81.086h43.751v-1.746zm112.013 0c-8.018-1.897-12.089-4.722-12.089-14.951V43.635l-41.621 12.137v1.71l.246.026c7.733.813 9.967 4.257 9.967 15.36v59.279c-2.578 5.102-7.415 8.131-13.274 8.336-9.503 0-14.736-6.419-14.736-18.073V43.638l-43.714 12.55v1.703l.262.024c9.459.84 12.05 4.097 12.05 15.152v50.17a56.3 56.3 0 0 0 .91 10.444l.787 3.423c3.701 13.262 13.398 20.197 28.59 20.197 12.868 0 24.147-7.966 29.115-20.43v17.311h43.714v-1.747zm169.818 1.788v-1.749l-.213-.05c-8.7-2.006-12.089-5.789-12.089-13.49v-63.79c0-19.89-11.171-31.761-29.883-31.761-13.64 0-25.141 7.882-29.569 20.16-3.517-13.01-13.639-20.16-28.606-20.16-13.146 0-23.449 6.938-27.869 18.657V43.643L545.487 55.68v1.715l.263.024c9.345.829 12.047 4.181 12.047 14.95v81.784h40.787v-1.746l-.215-.053c-6.941-1.631-9.181-4.606-9.181-12.239V66.998c1.836-4.289 5.537-9.37 12.853-9.37 9.086 0 13.692 6.296 13.692 18.697v77.828h40.797v-1.746l-.215-.053c-6.94-1.631-9.18-4.606-9.18-12.239V75.066a42 42 0 0 0-.578-7.26c1.947-4.661 5.86-10.177 13.475-10.177 9.214 0 13.691 6.114 13.691 18.696v77.828z"></path></svg></a><div class="az i"><div class="ac ak ba bb bc r bd be"><div class="bn" aria-describedby="searchResults" aria-labelledby="searchResults" aria-haspopup="listbox" role="listbox"></div><div class="bo bp ac"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg></div><input role="combobox" aria-controls="searchResults" aria-expanded="false" aria-label="search" data-testid="headerSearchInput" tabindex="0" class="ak bf bg bh ab bi bj bk bl bm" placeholder="Search" value=""></div></div></div><div class="i l x fp fq"><span data-dd-action-name="Susi presentation tracker new_post_topnav"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerWriteButton" rel="noopener follow" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2Fnew-story&amp;source=---top_nav_layout_nav-----------------------new_post_topnav------------------" data-discover="true"><div class="bg b bh ab eb fr fs ac r ft fu fv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M14 4a.5.5 0 0 0 0-1zm7 6a.5.5 0 0 0-1 0zm-7-7H4v1h10zM3 4v16h1V4zm1 17h16v-1H4zm17-1V10h-1v10zm-1 1a1 1 0 0 0 1-1h-1zM3 20a1 1 0 0 0 1 1v-1zM4 3a1 1 0 0 0-1 1h1z"></path><path stroke="currentColor" d="m17.5 4.5-8.458 8.458a.25.25 0 0 0-.06.098l-.824 2.47a.25.25 0 0 0 .316.316l2.47-.823a.25.25 0 0 0 .098-.06L19.5 6.5m-2-2 2.323-2.323a.25.25 0 0 1 .354 0l1.646 1.646a.25.25 0 0 1 0 .354L19.5 6.5m-2-2 2 2"></path></svg>Write</div></a></span></div><div class="l k j e"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerSearchButton" rel="noopener follow" href="https://medium.com/search?source=post_page---top_nav_layout_nav-----------------------------------------" data-discover="true"><div class="bg b bh ab eb fr fs ac r ft fu fv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Search</span></div></a></div><div class="ge i l k"><div class="ac r"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><button class="bg b ee ef ep eg eh eq ei ej er es el et eu eo ev ew ex ey ez fa fb fc fd fe ff fg fh fi fj fk bn fl fm" data-testid="headerSignUpButton">Sign up</button></span></p><div class="fn m"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerSignInButton" rel="noopener follow" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Fmedium.com%2F%40matterpreter%2Fadventures-in-dynamic-evasion-1fe0bac57aa&amp;source=post_page---top_nav_layout_nav-----------------------global_nav------------------" data-discover="true">Sign in</a></span></p></div></div></div><div class="m"><div><div class="bn" role="tooltip" aria-describedby="1" aria-labelledby="1"><div tabindex="-1" class="bf"><button class="ak gf ao ac r aq fr gg gh gi" aria-label="user options menu" data-testid="headerUserIcon"><div class="m fr"><img alt="" class="m fk by bz ca de" width="32" height="32" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fill:32:32/1*dmbNkD5D-u45r44go_cf0g.png"><div class="gj by m bz ca fw o ak gk"></div></div></button></div></div></div></div></div></div><div class="ac"><div class="cb i l k j cc" style="width: 0px;"></div><div class="cd bi ce cf cg ch" style="width: calc(100% + 0px);"><div class="m"><div data-focus-guard="true" tabindex="-1" style="width: 1px; height: 0px; padding: 0px; overflow: hidden; position: fixed; top: 1px; left: 1px;"></div><div data-focus-lock-disabled="disabled"><div class="ss" role="dialog" aria-modal="true" tabindex="-1"><div class="xl xm bi ed xn xo xp aq xq hd xr" aria-hidden="true" role="presentation"></div><div class="xs xn xt xu xv xl ed fk xw xx xy ls xz ya yb yc yd ye yf yg yh yi ac cv yj" aria-hidden="true"><div class="yk gy"></div></div></div></div><div data-focus-guard="true" tabindex="-1" style="width: 1px; height: 0px; padding: 0px; overflow: hidden; position: fixed; top: 1px; left: 1px;"></div><div class="gl gm gn go gp m"><div class="ac ci"><div class="cp bi gq gr gs gt"></div></div><article><div class="m"><div class="m"><span class="m"></span><section><div><div class="fw gz yl hb hc hd"></div><div class="he hf hg hh hi"><div class="ac ci"><div class="cp bi gq gr gs gt"><div><h1 id="66a5" class="pw-post-title hj hk hl bg hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il bl" data-testid="storyTitle" data-selectable-paragraph="">Adventures in Dynamic Evasion</h1><div><div class="speechify-ignore ac cw"><div class="speechify-ignore bi m"><div class="ac im in io ip iq ir is it iu iv iw"><div class="ac r iw"><div class="ac ix"><div><div class="bn" aria-describedby="3" aria-labelledby="3" role="tooltip"><div tabindex="-1" class="bf"><a rel="noopener follow" href="https://medium.com/@matterpreter?source=post_page---byline--1fe0bac57aa---------------------------------------" data-discover="true"><div class="m iy iz by ja jb"><div class="m fr"><img alt="Matt Hand" class="m fk by bz ca de" width="32" height="32" loading="lazy" data-testid="authorPhoto" src="https://miro.medium.com/v2/resize:fill:32:32/2*HFgLEKa86-RKIOoc4CfbOA.png"><div class="jc by m bz ca fw o jd gk"></div></div></div></a></div></div></div></div><span class="bg b bh ab bl"><div class="je ac r"><div class="ac r jf"><div class="ac r"><div><div class="bn" aria-describedby="4" aria-labelledby="4" role="tooltip"><div tabindex="-1" class="bf"><span class="bg b bh ab bl"><a class="ah ai aj fo al am an ao ap aq ar as at jg" data-testid="authorName" rel="noopener follow" href="https://medium.com/@matterpreter?source=post_page---byline--1fe0bac57aa---------------------------------------" data-discover="true">Matt Hand</a></span></div></div></div></div><div class="jh ji m"><div class="ac jj"><div class="ac"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 16 16"><path fill="#437AFF" d="M15.163 8c0 .65-.459 1.144-.863 1.575-.232.244-.471.5-.563.719s-.086.543-.092.875c-.006.606-.018 1.3-.49 1.781-.47.481-1.15.494-1.744.5-.324.006-.655.013-.857.094s-.465.337-.704.575c-.422.412-.906.881-1.542.881-.637 0-1.12-.469-1.543-.881-.239-.238-.49-.482-.704-.575-.214-.094-.532-.088-.857-.094-.593-.006-1.273-.019-1.744-.5s-.484-1.175-.49-1.781c-.006-.332-.012-.669-.092-.875-.08-.207-.33-.475-.563-.719-.404-.431-.863-.925-.863-1.575s.46-1.144.863-1.575c.233-.244.472-.5.563-.719.092-.219.086-.544.092-.875.006-.606.019-1.3.49-1.781s1.15-.494 1.744-.5c.325-.006.655-.012.857-.094.202-.081.465-.337.704-.575C7.188 1.47 7.671 1 8.308 1s1.12.469 1.542.881c.239.238.49.481.704.575s.533.088.857.094c.594.006 1.273.019 1.745.5.47.481.483 1.175.49 1.781.005.331.011.669.091.875s.33.475.563.719c.404.431.863.925.863 1.575"></path><path fill="#fff" d="M7.328 10.5c.195 0 .381.08.519.22.137.141.215.331.216.53 0 .066.026.13.072.177a.24.24 0 0 0 .346 0 .25.25 0 0 0 .071-.177c.001-.199.079-.389.216-.53a.73.73 0 0 1 .519-.22h1.959c.13 0 .254-.053.346-.146a.5.5 0 0 0 .143-.354V6a.5.5 0 0 0-.143-.354.49.49 0 0 0-.346-.146h-1.47c-.324 0-.635.132-.865.366-.23.235-.359.552-.359.884v2.5c0 .066-.025.13-.071.177a.24.24 0 0 1-.346 0 .25.25 0 0 1-.072-.177v-2.5c0-.332-.13-.65-.359-.884A1.21 1.21 0 0 0 6.84 5.5h-1.47a.49.49 0 0 0-.346.146A.5.5 0 0 0 4.88 6v4c0 .133.051.26.143.354a.49.49 0 0 0 .347.146z"></path></svg></div></div></div><div class="jk bn"></div><button class="uz ze aq ac ci r zf zg zh" style="border: 1px solid rgba(8, 8, 8, 0.22);"><span class="bg b bh ab bl bi"><span class="bn zi">Follow</span></span></button></div></div></span></div><div class="ac r jl"><span class="bg b bh ab eb"><div class="ac ag"><span data-testid="storyReadTime">10 min read</span><div class="jm jn m" aria-hidden="true"><span class="m" aria-hidden="true"><span class="bg b bh ab eb">·</span></span></div><span data-testid="storyPublishDate">Dec 7, 2020</span></div></span></div></div><div class="ac cw jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd"><div class="i l x fp fq r"><div class="kt m"><div class="ac r ku kv"><div class="pw-multi-vote-icon fr kw kx ky kz"><span data-dd-action-name="Susi presentation tracker clap_footer"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerClapButton" rel="noopener follow" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2F1fe0bac57aa&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40matterpreter%2Fadventures-in-dynamic-evasion-1fe0bac57aa&amp;user=Matt+Hand&amp;userId=43fe4a5cc44&amp;source=---header_actions--1fe0bac57aa---------------------clap_footer------------------" data-discover="true"><div><div class="bn" aria-describedby="5" aria-labelledby="5" role="tooltip"><div tabindex="-1" class="bf"><div class="la aq lb lc ld le ao lf lg lh kz" role="presentation"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></div></div></div></a></span></div><div class="pw-multi-vote-count m li lj lk ll lm ln lo"><div><div class="bn" aria-describedby="68" aria-labelledby="68" role="tooltip"><div tabindex="-1" class="bf"><p class="bg b ec ab eb"><button class="ah ai aj fo al am an ao ap aq ar as at au av zj lx">199<span class="m i h g sx sy"></span></button></p></div></div></div></div></div></div><div><div class="bn" aria-describedby="6" aria-labelledby="6" role="tooltip"><div tabindex="-1" class="bf"><button class="aq la ls lt ac r fs lu lv" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="lr"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"></path></svg><p class="bg b ec ab eb"><span class="pw-responses-count lq lr">1</span></p></button></div></div></div></div><div class="ac r ke kf kg kh ki kj kk kl km kn ko kp kq kr ks"><div class="lw l k j e"></div><div class="i l"><div><div class="bn" aria-describedby="7" aria-labelledby="7" role="tooltip"><div tabindex="-1" class="bf"><span data-dd-action-name="Susi presentation tracker bookmark_footer"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerBookmarkButton" rel="noopener follow" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F1fe0bac57aa&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40matterpreter%2Fadventures-in-dynamic-evasion-1fe0bac57aa&amp;source=---header_actions--1fe0bac57aa---------------------bookmark_footer------------------" data-discover="true"><span class=""><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25" class="eb lx" aria-label="Add to list bookmark button"><path fill="currentColor" d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .805.396L12.5 17l5.695 4.396A.5.5 0 0 0 19 21v-8.5a.5.5 0 0 0-1 0v7.485l-5.195-4.012a.5.5 0 0 0-.61 0L7 19.985z"></path></svg></span></a></span></div></div></div></div><div class="fk ly cu"><div class="m ag"><div class="ac ci"><div class="lz ma mb mc md me cp bi"><div class="ac"><span data-dd-action-name="Susi presentation tracker post_audio_button"><a class="ah ai aj fo al am an ao ap aq ar as at au av" rel="noopener follow" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2Fplans%3Fdimension%3Dpost_audio_button%26postId%3D1fe0bac57aa&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40matterpreter%2Fadventures-in-dynamic-evasion-1fe0bac57aa&amp;source=---header_actions--1fe0bac57aa---------------------post_audio_button------------------" data-discover="true"><div><div class="bn" aria-describedby="55" aria-labelledby="55" role="tooltip"><div tabindex="-1" class="bf"><button aria-label="Listen" data-testid="audioPlayButton" class="ah fs aj fo al am an mf ap aq ar fe mg mh lv mi mj mk ml mm t mn mo mp mq mr ms mt v mu mv mw"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"></path></svg><div class="k j e"><p class="bg b bh ab eb">Listen</p></div></button></div></div></div></a></span></div></div></div></div></div><div class="bn" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bn" aria-describedby="9" aria-labelledby="9" role="tooltip"><div tabindex="-1" class="bf"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="ah fs aj fo al am an mf ap aq ar fe mg mh lv mi mj mk ml mm t mn mo mp mq mr ms mt v mu mv mw"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"></path></svg><div class="k j e"><p class="bg b bh ab eb">Share</p></div></button></div></div></div></div></div></div></div></div></div></div><p id="fde9" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">Most teams I have worked with rely heavily on anecdotal evidence when it comes to evasion. If an operator is asked why they chose a technique over another, the most common response I have heard is “ because it worked last time.” In situations where we are encountering a new defensive solution, we use our past experiences combined with best practices and hope we land, but ultimately it is a shot in the dark.</p><figure class="ny nz oa ob oc od nv nw paragraph-image"><div role="button" tabindex="0" class="oe of fr og bi oh"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="nv nw nx"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*tuVyY_oSLkR-qMsS2fnBYQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*tuVyY_oSLkR-qMsS2fnBYQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*tuVyY_oSLkR-qMsS2fnBYQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*tuVyY_oSLkR-qMsS2fnBYQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*tuVyY_oSLkR-qMsS2fnBYQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*tuVyY_oSLkR-qMsS2fnBYQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tuVyY_oSLkR-qMsS2fnBYQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*tuVyY_oSLkR-qMsS2fnBYQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*tuVyY_oSLkR-qMsS2fnBYQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*tuVyY_oSLkR-qMsS2fnBYQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*tuVyY_oSLkR-qMsS2fnBYQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*tuVyY_oSLkR-qMsS2fnBYQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*tuVyY_oSLkR-qMsS2fnBYQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*tuVyY_oSLkR-qMsS2fnBYQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi me oi c" width="700" height="337" loading="eager" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*tuVyY_oSLkR-qMsS2fnBYQ.png"></picture></div></div><figcaption class="oj fm ok nv nw ol om bg b bh ab eb" data-selectable-paragraph="">Even some pretty prolific groups are using this same tactic. Source: <a class="ah on" href="https://threatintel.blog/OPBlueRaven-Part2/" rel="noopener ugc nofollow" target="_blank">https://threatintel.blog/OPBlueRaven-Part2/</a></figcaption></figure><p id="932d" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">While this is a valid approach to solving the problem, there is definitely room for improvement. For example, if our process is to rely heavily on anecdotal evidence, what happens if the vendor changes something from the last time we ran into them? In instances where we are seeing something for the first time, how do we increase our odds by using data rather than our best guesses?</p><h3 id="5878" class="oo op hl bg oq or os ef ot ou ov eh ow ni ox oy oz nm pa pb pc nq pd pe pf pg bl" data-selectable-paragraph="">A Different Approach</h3><p id="519d" class="pw-post-body-paragraph mx my hl mz b na ph nc nd ne pi ng nh ni pj nk nl nm pk no np nq pl ns nt nu he bl" data-selectable-paragraph="">What if instead of testing TTPs against each solution, cataloging the ones that worked, and updating them over time, we instead looked at the capabilities of the solution first and then pruned our larger list available of TTPs down?</p><p id="9692" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">To explore this idea, I looked at user mode API/function hooks implemented on target systems by numerous EDR vendors and sought to create a solution that would dynamically evade them without relying on any previous experience or information.</p><blockquote class="pm pn po"><p id="b531" class="mx my pp mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph=""><strong class="mz hm">Note:</strong> This is just one approach to one small portion of the evasion puzzle. Function hooks were picked as the topic of this post due to their simplicity, but there are tons of other things at play that the techniques in this post could be applied to (e.g. driver callbacks, ETW, filters, etc.). There has also been a ton of research around evading function hooks, especially lately. I’ve included some additional links at the end of this post for those interested.</p></blockquote><h2 id="c329" class="pq op hl bg oq pr ps pt ot pu pv pw ow px py pz qa qb qc qd qe qf qg qh qi qj bl" data-selectable-paragraph="">What are User Mode Function Hooks?</h2><p id="88f9" class="pw-post-body-paragraph mx my hl mz b na ph nc nd ne pi ng nh ni pj nk nl nm pk no np nq pl ns nt nu he bl" data-selectable-paragraph="">This topic has been getting a ton of attention lately, so I won’t dive too far into the weeds. The links at the bottom of this post go into far greater detail than I will for the sake of brevity.</p><p id="4d2e" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">In short, one of the most common ways for EDR solutions to monitor for suspicious API calls is to intercept them. This is done by injecting their own DLL into a process, patching important functions inside of <code class="de qk ql qm qn b">ntdll.dll</code> to jump to a function in their DLL, proxying the API call and extracting information from the call and return value from inside their DLL, and then returning the value from the API call back to the user. This is referred to as function hooking and should be completely seamless to the user.</p><figure class="ny nz oa ob oc od nv nw paragraph-image"><div class="nv nw qo"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*aQ5J-IoOtSuSE9KS-eJeKA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*aQ5J-IoOtSuSE9KS-eJeKA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*aQ5J-IoOtSuSE9KS-eJeKA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*aQ5J-IoOtSuSE9KS-eJeKA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*aQ5J-IoOtSuSE9KS-eJeKA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*aQ5J-IoOtSuSE9KS-eJeKA.png 1100w, https://miro.medium.com/v2/resize:fit:1262/format:webp/1*aQ5J-IoOtSuSE9KS-eJeKA.png 1262w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 631px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*aQ5J-IoOtSuSE9KS-eJeKA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*aQ5J-IoOtSuSE9KS-eJeKA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*aQ5J-IoOtSuSE9KS-eJeKA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*aQ5J-IoOtSuSE9KS-eJeKA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*aQ5J-IoOtSuSE9KS-eJeKA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*aQ5J-IoOtSuSE9KS-eJeKA.png 1100w, https://miro.medium.com/v2/resize:fit:1262/1*aQ5J-IoOtSuSE9KS-eJeKA.png 1262w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 631px"><img alt="" class="bi me oi c" width="631" height="181" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:631/1*aQ5J-IoOtSuSE9KS-eJeKA.png"></picture></div><figcaption class="oj fm ok nv nw ol om bg b bh ab eb" data-selectable-paragraph="">Extremely simplified hooked NtCreateFile()diagram</figcaption></figure><p id="9ff5" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">EDRs most often hook these functions’ correlating Native APIs (e.g. <code class="de qk ql qm qn b">NtOpenProcess</code>, <code class="de qk ql qm qn b">NtAllocateVirtualMemory</code>) inside of <code class="de qk ql qm qn b">ntdll.dll</code>. After interception and collections, the parameters provided to these functions are correlated with other data points to determine if some malicious activity occurred on the system. For example, if <code class="de qk ql qm qn b">OpenProcess()</code> is used to open a handle on a remote process, <code class="de qk ql qm qn b">VirtualAlloc()</code> is used to allocated a RWX section of memory, <code class="de qk ql qm qn b">WriteMemory()</code> is used to write some data to the allocated block, <code class="de qk ql qm qn b">CreateRemoteThread()</code> is used to create a new thread, and a new process is created, it is probably a reasonable assumption that remote process injection just occurred.</p><h2 id="9eae" class="pq op hl bg oq pr ps pt ot pu pv pw ow px py pz qa qb qc qd qe qf qg qh qi qj bl" data-selectable-paragraph="">Detecting User Mode Function Hooks</h2><p id="3757" class="pw-post-body-paragraph mx my hl mz b na ph nc nd ne pi ng nh ni pj nk nl nm pk no np nq pl ns nt nu he bl" data-selectable-paragraph="">Thankfully, detecting these hooks is trivial due to some predictable values being changed. Because these hooks patch <code class="de qk ql qm qn b">ntdll.dll</code>, we can check specific functions to see if their instructions don’t match the expected values. These functions follow a predictable format as their jobs are to make the SYSCALLs.</p><p id="f295" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">All x64 Windows SYSCALLs must follow this general calling convention:</p><pre class="ny nz oa ob oc qp qn qq qr ak qs bl"><span id="cd76" class="oo op hl qn b qt qu qv m qw qx" data-selectable-paragraph="">MOV R10, RCX<br>MOV EAX, &lt;SYSCALL_NUMBER&gt;h<br>SYSCALL<br>RETN</span></pre><p id="e7f8" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph=""><strong class="mz hm">If there is a modification to this specific flow, it is a high fidelity indicator that function hooks are in place.</strong> Let’s take a look at what this may look like. Below is an example of an unmodified <code class="de qk ql qm qn b">NtAllocateVirtualMemory().</code></p><figure class="ny nz oa ob oc od nv nw paragraph-image"><div role="button" tabindex="0" class="oe of fr og bi oh"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="nv nw qy"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*cy66BUO0sSp-KpnAiQctGQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*cy66BUO0sSp-KpnAiQctGQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*cy66BUO0sSp-KpnAiQctGQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*cy66BUO0sSp-KpnAiQctGQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*cy66BUO0sSp-KpnAiQctGQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*cy66BUO0sSp-KpnAiQctGQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cy66BUO0sSp-KpnAiQctGQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*cy66BUO0sSp-KpnAiQctGQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*cy66BUO0sSp-KpnAiQctGQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*cy66BUO0sSp-KpnAiQctGQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*cy66BUO0sSp-KpnAiQctGQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*cy66BUO0sSp-KpnAiQctGQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*cy66BUO0sSp-KpnAiQctGQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*cy66BUO0sSp-KpnAiQctGQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi me oi c" width="700" height="155" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*cy66BUO0sSp-KpnAiQctGQ.png"></picture></div></div></figure><p id="c9ca" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">Now if we look at a process which has been hooked by an EDR, <code class="de qk ql qm qn b">NtAllocateVirtualMemory()</code> looks a bit different.</p><figure class="ny nz oa ob oc od nv nw paragraph-image"><div role="button" tabindex="0" class="oe of fr og bi oh"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="nv nw qz"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*iu_Hfuc79Qtmkzrl86zA3Q.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*iu_Hfuc79Qtmkzrl86zA3Q.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*iu_Hfuc79Qtmkzrl86zA3Q.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*iu_Hfuc79Qtmkzrl86zA3Q.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*iu_Hfuc79Qtmkzrl86zA3Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*iu_Hfuc79Qtmkzrl86zA3Q.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iu_Hfuc79Qtmkzrl86zA3Q.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*iu_Hfuc79Qtmkzrl86zA3Q.png 640w, https://miro.medium.com/v2/resize:fit:720/1*iu_Hfuc79Qtmkzrl86zA3Q.png 720w, https://miro.medium.com/v2/resize:fit:750/1*iu_Hfuc79Qtmkzrl86zA3Q.png 750w, https://miro.medium.com/v2/resize:fit:786/1*iu_Hfuc79Qtmkzrl86zA3Q.png 786w, https://miro.medium.com/v2/resize:fit:828/1*iu_Hfuc79Qtmkzrl86zA3Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*iu_Hfuc79Qtmkzrl86zA3Q.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*iu_Hfuc79Qtmkzrl86zA3Q.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi me oi c" width="700" height="158" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*iu_Hfuc79Qtmkzrl86zA3Q.png"></picture></div></div></figure><p id="8517" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">As you can see, there’s jump to <code class="de qk ql qm qn b">0x7ffc01e60168</code> (the 3 breakpoint traps following the jump are insignificant) thrown in the middle. This is commonly referred to as a trampoline. This trampoline diverts execution to an alternative function, likely a DLL injected by an EDR to collect information. This function inside the DLL will execute the real function on behalf of the user and may observe any return values.</p><h2 id="8a25" class="pq op hl bg oq pr ps pt ot pu pv pw ow px py pz qa qb qc qd qe qf qg qh qi qj bl" data-selectable-paragraph="">Recreating EDR</h2><p id="aec3" class="pw-post-body-paragraph mx my hl mz b na ph nc nd ne pi ng nh ni pj nk nl nm pk no np nq pl ns nt nu he bl" data-selectable-paragraph="">Since most EDR companies don’t like researchers poking their stuff and purchasing licenses legitimately is cost-prohibitive for an individual, I decided to just write my own to emulate the functionality we’re interested in.</p><p id="df22" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">There are a few options that that would allow us to hook functions, including Microsoft’s Detours, EasyHook, and MinHook. I chose to use <a class="ah on" href="https://frida.re/" rel="noopener ugc nofollow" target="_blank">Frida</a> due to the its <a class="ah on" href="https://github.com/frida/frida-python" rel="noopener ugc nofollow" target="_blank">Python bindings</a> for simplicity and its relatively good <a class="ah on" href="https://frida.re/docs/home/" rel="noopener ugc nofollow" target="_blank">documentation</a>.</p><blockquote class="pm pn po"><p id="3658" class="mx my pp mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph=""><strong class="mz hm">Note:</strong> If you’d like to replicate EDRs as closely as possible, I’d recommend using Detours as that is what most of the agents I’ve worked with are using under the hood.</p></blockquote><p id="b769" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">Frida does everything we need to do — spawns a process with the main thread in a suspended state, patches out the hooked functions we want to target with a trampoline, resumes the thread, and then gives us back output. I’ve written a really simple Frida script to hook some of the Native APIs used during textbook <code class="de qk ql qm qn b">CreateRemoteThread</code>-based shellcode injection and published it here</p><p id="37bb" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph=""><a class="ah on" href="https://gist.github.com/matterpreter/cf9c8c48d0a95a9699f240c4f37d8fd7" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/matterpreter/cf9c8c48d0a95a9699f240c4f37d8fd7</a></p><figure class="ny nz oa ob oc od nv nw paragraph-image"><div class="nv nw ra"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*slWjaERvsNTcDqoAqQ25zw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*slWjaERvsNTcDqoAqQ25zw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*slWjaERvsNTcDqoAqQ25zw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*slWjaERvsNTcDqoAqQ25zw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*slWjaERvsNTcDqoAqQ25zw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*slWjaERvsNTcDqoAqQ25zw.png 1100w, https://miro.medium.com/v2/resize:fit:1034/format:webp/1*slWjaERvsNTcDqoAqQ25zw.png 1034w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 517px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*slWjaERvsNTcDqoAqQ25zw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*slWjaERvsNTcDqoAqQ25zw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*slWjaERvsNTcDqoAqQ25zw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*slWjaERvsNTcDqoAqQ25zw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*slWjaERvsNTcDqoAqQ25zw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*slWjaERvsNTcDqoAqQ25zw.png 1100w, https://miro.medium.com/v2/resize:fit:1034/1*slWjaERvsNTcDqoAqQ25zw.png 1034w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 517px"><img alt="" class="bi me oi c" width="517" height="551" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:517/1*slWjaERvsNTcDqoAqQ25zw.png"></picture></div><figcaption class="oj fm ok nv nw ol om bg b bh ab eb" data-selectable-paragraph=""><code class="de qk ql qm qn b">CreateRemoteThread </code>shellcode injection detected using the Frida script</figcaption></figure><h2 id="5810" class="pq op hl bg oq pr ps pt ot pu pv pw ow px py pz qa qb qc qd qe qf qg qh qi qj bl" data-selectable-paragraph="">Programmatically Detecting the Hooks</h2><p id="fe16" class="pw-post-body-paragraph mx my hl mz b na ph nc nd ne pi ng nh ni pj nk nl nm pk no np nq pl ns nt nu he bl" data-selectable-paragraph="">Because we know that these functions follow a specific format and any modification to this format can be assumed to be a hook, detecting hooks is fairly straight forward.</p><div class="vu us vv vw ac r cv"><div class="vx vy vz wa wb m fm"><h2 class="wc b wd we wf wg wh">Get Matt Hand’s stories in&nbsp;your&nbsp;inbox</h2></div><div class="cs m fm"><p class="bg b bh ab eb">Join Medium for free to get updates from&nbsp;this&nbsp;writer.</p></div><div class="wl tb wm wn ta wo ac"><span class="bg b bh ab bl"><div class="wp ac cv"><div class="ac wp fj fi bq wq wr de ls ws wt wu wv ww wx wy"><input class="wz al aj an xa xb gd le bm xc bi" placeholder="Enter your email" type="text" value=""></div></div></span><div class="i l tr cb"><div class="wi wj wk"><button class="bg b bh ab xd sh xe xf xg xh vb fc fd xi xj xk fh fi fj fk bn fl fm">Subscribe</button></div></div><div class="bi k j e"><button class="bg b bh ab xd sh xe xf xg xh vb fc fd xi xj xk fh bi fi fj fk bn fl fm">Subscribe</button></div></div><div class="sf m"><div id="g-recaptcha"></div></div></div><p id="1265" class="pw-post-body-paragraph mx my hl mz b na nc nd ne ng nh ni nk nl nm no np nq ns nt vw nu he bl" data-selectable-paragraph="">To detect the hooks, we can simply get a pointer to the function we’re concerned with in our current process’ loaded <code class="de qk ql qm qn b">ntdll.dll</code> and the check for any deviation from the standard pattern of instructions. To demonstrate this, I’m releasing a simple POC alongside this post, which can be found <a class="ah on" href="https://github.com/matterpreter/OffensiveCSharp/tree/master/HookDetector" rel="noopener ugc nofollow" target="_blank">here</a> as part of the OffensiveC# repository.</p><figure class="ny nz oa ob oc od nv nw paragraph-image"><div role="button" tabindex="0" class="oe of fr og bi oh"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="nv nw rb"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*HRRnmlqmL-5Wk1P9OBqCMg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*HRRnmlqmL-5Wk1P9OBqCMg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*HRRnmlqmL-5Wk1P9OBqCMg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*HRRnmlqmL-5Wk1P9OBqCMg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*HRRnmlqmL-5Wk1P9OBqCMg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*HRRnmlqmL-5Wk1P9OBqCMg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HRRnmlqmL-5Wk1P9OBqCMg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*HRRnmlqmL-5Wk1P9OBqCMg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*HRRnmlqmL-5Wk1P9OBqCMg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*HRRnmlqmL-5Wk1P9OBqCMg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*HRRnmlqmL-5Wk1P9OBqCMg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*HRRnmlqmL-5Wk1P9OBqCMg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*HRRnmlqmL-5Wk1P9OBqCMg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*HRRnmlqmL-5Wk1P9OBqCMg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi me oi c" width="700" height="267" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*HRRnmlqmL-5Wk1P9OBqCMg.png"></picture></div></div></figure><p id="be5a" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">The screenshot above shows the hooks placed by the Frida script from earlier being detected by HookDetector.</p><h2 id="02a3" class="pq op hl bg oq pr ps pt ot pu pv pw ow px py pz qa qb qc qd qe qf qg qh qi qj bl" data-selectable-paragraph="">Evading the Hooks</h2><p id="56c7" class="pw-post-body-paragraph mx my hl mz b na ph nc nd ne pi ng nh ni pj nk nl nm pk no np nq pl ns nt nu he bl" data-selectable-paragraph="">Now that we can reliably detect this specific shellcode injection technique as a simulated EDR agent and have tooling to detect which Native API functions are hooked, we can create a new payload which strategically evades the hooked functions. There has been a ton of work related to evading user mode hooks, but most center around 2 techniques — making direct SYSCALLs or module remapping. Some of my favorites are:</p><ul class=""><li id="f475" class="mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu rc rd re bl" data-selectable-paragraph=""><strong class="mz hm">D/Invoke</strong> — <a class="ah on" href="https://github.com/cobbr/SharpSploit/tree/master/SharpSploit/Execution/DynamicInvoke" rel="noopener ugc nofollow" target="_blank">https://github.com/cobbr/SharpSploit/tree/master/SharpSploit/Execution/DynamicInvoke</a></li><li id="b66f" class="mx my hl mz b na rf nc nd ne rg ng nh ni rh nk nl nm ri no np nq rj ns nt nu rc rd re bl" data-selectable-paragraph=""><strong class="mz hm">SysWhispers</strong> — <a class="ah on" href="https://github.com/jthuraisamy/SysWhispers" rel="noopener ugc nofollow" target="_blank">https://github.com/jthuraisamy/SysWhispers</a></li><li id="5585" class="mx my hl mz b na rf nc nd ne rg ng nh ni rh nk nl nm ri no np nq rj ns nt nu rc rd re bl" data-selectable-paragraph=""><strong class="mz hm">Dumpert </strong>— <a class="ah on" href="https://github.com/outflanknl/Dumpert" rel="noopener ugc nofollow" target="_blank">https://github.com/outflanknl/Dumpert</a></li></ul><p id="81fe" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">Any of the techniques employed by the tools above are viable options, but each has their tradeoff. For the sake of simplicity, I’m going to test our hypothesis using only the finest, hand-crafted, artisanal SYSCALLs using C# delegates as described in <a class="ah on" href="https://jhalon.github.io/utilizing-syscalls-in-csharp-2/" rel="noopener ugc nofollow" target="_blank">Jack Halon’s post</a> on the topic. Here’s a sample of what a call to <code class="de qk ql qm qn b">NtAllocateVirtualMemory()</code> would look like:</p><figure class="ny nz oa ob oc od"><div class="rk ga m fr"><div class="rl rm m"></div></div></figure><p id="0d06" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">To test our evasion, I replaced the call to <code class="de qk ql qm qn b">VirtualAlloc()</code> in the <code class="de qk ql qm qn b">SimpleCRT.exe</code> PoC from above with our SYSCALL code and ran it through our Frida script. The call to <code class="de qk ql qm qn b">WriteProcessMemory()</code> is detected as it wasn’t modified, but it wasn’t able to catch our memory allocation 😎</p><figure class="ny nz oa ob oc od nv nw paragraph-image"><div role="button" tabindex="0" class="oe of fr og bi oh"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="nv nw rn"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*fRyDE7yEpDG-oeK7JSwfZw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*fRyDE7yEpDG-oeK7JSwfZw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*fRyDE7yEpDG-oeK7JSwfZw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*fRyDE7yEpDG-oeK7JSwfZw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*fRyDE7yEpDG-oeK7JSwfZw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*fRyDE7yEpDG-oeK7JSwfZw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fRyDE7yEpDG-oeK7JSwfZw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*fRyDE7yEpDG-oeK7JSwfZw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*fRyDE7yEpDG-oeK7JSwfZw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*fRyDE7yEpDG-oeK7JSwfZw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*fRyDE7yEpDG-oeK7JSwfZw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*fRyDE7yEpDG-oeK7JSwfZw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*fRyDE7yEpDG-oeK7JSwfZw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*fRyDE7yEpDG-oeK7JSwfZw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi me oi c" width="700" height="221" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*fRyDE7yEpDG-oeK7JSwfZw.png"></picture></div></div></figure><h2 id="d834" class="pq op hl bg oq pr ps pt ot pu pv pw ow px py pz qa qb qc qd qe qf qg qh qi qj bl" data-selectable-paragraph="">Dynamic Evasion</h2><p id="c2f6" class="pw-post-body-paragraph mx my hl mz b na ph nc nd ne pi ng nh ni pj nk nl nm pk no np nq pl ns nt nu he bl" data-selectable-paragraph="">What if we took the ability to automatically detect which functions are hooked and applied that knowledge to our tooling? To show what this may look like, I’ve written a simple implementation of a staging server which receives the data about function hooks from a stager, compiles a stage using only APIs that are not hooked or by directly calling the SYSCALLs of those which are. The server then returns this compiled assembly back to the stager which runs it in line.</p><p id="53f2" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">Here is the architecture:</p><figure class="ny nz oa ob oc od nv nw paragraph-image"><div class="nv nw ro"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*2SK0b9w92tDupeYh5Ss3bQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*2SK0b9w92tDupeYh5Ss3bQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*2SK0b9w92tDupeYh5Ss3bQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*2SK0b9w92tDupeYh5Ss3bQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*2SK0b9w92tDupeYh5Ss3bQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*2SK0b9w92tDupeYh5Ss3bQ.png 1100w, https://miro.medium.com/v2/resize:fit:1358/format:webp/1*2SK0b9w92tDupeYh5Ss3bQ.png 1358w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 679px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*2SK0b9w92tDupeYh5Ss3bQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*2SK0b9w92tDupeYh5Ss3bQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*2SK0b9w92tDupeYh5Ss3bQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*2SK0b9w92tDupeYh5Ss3bQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*2SK0b9w92tDupeYh5Ss3bQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*2SK0b9w92tDupeYh5Ss3bQ.png 1100w, https://miro.medium.com/v2/resize:fit:1358/1*2SK0b9w92tDupeYh5Ss3bQ.png 1358w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 679px"><img alt="" class="bi me oi c" width="679" height="507" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:679/1*2SK0b9w92tDupeYh5Ss3bQ.png"></picture></div></figure><blockquote class="pm pn po"><p id="d71c" class="mx my pp mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">I’ve opted to stick with the .NET Framework in my payload and server implementations for simplicity, its ability to easily (de)serialize data, the <a class="ah on" href="https://jhalon.github.io/utilizing-syscalls-in-csharp-2/" rel="noopener ugc nofollow" target="_blank">existing research</a> on making SYSCALLs through delegates, and support for the <code class="de qk ql qm qn b">ICodeCompiler</code> interface , which allows for easily programmatic compilation of source files. This technique is language agnostic though and could be implemented in another language with minimal effort.</p></blockquote><h3 id="c16e" class="oo op hl bg oq or os ef ot ou ov eh ow ni ox oy oz nm pa pb pc nq pd pe pf pg bl" data-selectable-paragraph="">Testing our Technique</h3><p id="ad9f" class="pw-post-body-paragraph mx my hl mz b na ph nc nd ne pi ng nh ni pj nk nl nm pk no np nq pl ns nt nu he bl" data-selectable-paragraph="">To prove out this concept, I’ve written a tool named SHAPESHIFTER which fills the role of the staging server. On start, it compiles the Stage 0 payload and starts a simple TCP server.</p><p id="0bda" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">When Stage 0 lands on the target, it checks for hooks using the same technique as HookDetector and then sends the results back to the server.</p><p id="6e78" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">The server receives the data from Stage 0 and dynamically generates and compiles Stage 1 which only uses API calls which aren’t hooked and SYSCALLs for those which are. The server sends this compiled Stage 1 back to Stage 0, which loads and calls Stage 1’s entry point.</p><p id="afe7" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph=""><a class="ah on" href="https://github.com/matterpreter/SHAPESHIFTER" rel="noopener ugc nofollow" target="_blank">https://github.com/matterpreter/SHAPESHIFTER</a></p><figure class="ny nz oa ob oc od"><div class="rk ga m fr"><div class="rp rm m"></div></div></figure><blockquote class="pm pn po"><p id="3320" class="mx my pp mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">You may be thinking “why doesn’t he just make one payload which evades all the hooks?” That is a completely fair point, but one thing to consider is that using SYSCALLs and undocumented APIs is risky from the perspective of someone who will end up supporting tooling like this over the long-term. Because SYSCALL numbers and undocumented API calling conventions are subject to <a class="ah on" href="https://j00ru.vexillium.org/syscalls/nt/64/" rel="noopener ugc nofollow" target="_blank">change at anytime</a> by Microsoft, the more we use either of these, the more time we will have to spend testing against the specific Windows version(s) we’re targeting. Also, by using a “dynamic” payload, you’re less likely to fall victim to static signatures.</p></blockquote><h3 id="e4b9" class="oo op hl bg oq or os ef ot ou ov eh ow ni ox oy oz nm pa pb pc nq pd pe pf pg bl" data-selectable-paragraph="">Future Work</h3><p id="c930" class="pw-post-body-paragraph mx my hl mz b na ph nc nd ne pi ng nh ni pj nk nl nm pk no np nq pl ns nt nu he bl" data-selectable-paragraph="">We can use this server as an intermediary between our target and our primary C2 or potentially as a C2 itself. If we can maintain the state of which functions are hooked per agent, we can apply the same technique of only calling unhooked APIs or direct SYSCALLs for all of our post-exploitation tooling. This technique could also be leveraged by existing C2 frameworks/agents which make use of <a class="ah on" href="https://www.cobaltstrike.com/help-opsec#:~:text=Post-Exploitation%20Jobs" rel="noopener ugc nofollow" target="_blank">fork-and-run</a>.</p><h2 id="5f3f" class="pq op hl bg oq pr ps pt ot pu pv pw ow px py pz qa qb qc qd qe qf qg qh qi qj bl" data-selectable-paragraph="">Defensive Considerations</h2><p id="d0e6" class="pw-post-body-paragraph mx my hl mz b na ph nc nd ne pi ng nh ni pj nk nl nm pk no np nq pl ns nt nu he bl" data-selectable-paragraph="">On the defense side, we need to understand that while our telemetry sources can be avoided by attackers, there are other choke points where we can catch malicious activity. For example, even though we can bypass user mode function hooks with SHAPESHIFTER, we can still be caught by static AV signatures on the Stage 0 agent, the EDR driver (via process creation and requests to open a process handle), ETW providers (e.g. <code class="de qk ql qm qn b">Microsoft-DotNET-Runtime</code>), and network monitoring catching the callback. As with function hooks, these sources can also be<a class="ah on" href="https://github.com/outflanknl/TamperETW" rel="noopener ugc nofollow" target="_blank"> tampered with</a> or <a class="ah on" href="https://posts.specterops.io/shhmon-silencing-sysmon-via-driver-unload-682b5be57650" rel="noopener ugc nofollow" target="_blank">outright disabled</a>.</p><p id="ec7b" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">Unfortunately, trying to detect this specific technique is pretty difficult. We could try to detect making direct SYSCALLs by using something like the <code class="de qk ql qm qn b"><a class="ah on" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.windows.eventtracing.syscalls?view=trace-processor-dotnet-1.0" rel="noopener ugc nofollow" target="_blank">Microsoft.Windows.EventTracing.Syscalls</a></code> namespace in .NET, but collecting and triaging data from this source at scale could prove difficult due to volume.</p><p id="2d46" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">A more reasonable approach (albeit a little less exciting) is to break apart the tooling you rely on for endpoint detection into capability/telemetry groups, look at how these can be subverted, and add them as a portion of your blind spots and considerations in your detection strategy.</p><h3 id="22be" class="oo op hl bg oq or os ef ot ou ov eh ow ni ox oy oz nm pa pb pc nq pd pe pf pg bl" data-selectable-paragraph="">Side Note: A Plea to Microsoft</h3><p id="7d99" class="pw-post-body-paragraph mx my hl mz b na ph nc nd ne pi ng nh ni pj nk nl nm pk no np nq pl ns nt nu he bl" data-selectable-paragraph="">Due to the susceptibility of user mode function hooks to evasion, I don’t believe that this approach will be tenable in the near future as tradecraft continues to evolve. What I believe would be a far better solution would be to open the <code class="de qk ql qm qn b">EtwTi*</code> kernel mode ETW providers to vendors, similarly to what was done with AMSI, through the MVI. Because these hooks exist in the kernel, evasion related to making direct/unmodified SYSCALLs isn’t effective. Combine this with the existing coverage of most of the common APIs we use for injection, the relative difficulty of getting code execution in the kernel to tamper with the providers, and the removed complexity of dealing with DLL injection and it is clear that this capability would be a huge step forward.</p><p id="509f" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph=""><strong class="mz hm">Update December 16, 2020: </strong>There doesn’t appear to be any public documentation from Microsoft regarding this , but it is possible to get events from the <code class="de qk ql qm qn b">Microsoft-Windows-Threat-Intelligence</code> provider using an ELAM driver and protected processes. <a class="ah on" href="https://twitter.com/pathtofile" rel="noopener ugc nofollow" target="_blank">@pathtofile</a> has a great blog post and tool demonstrating how to do so <a class="ah on" href="https://blog.tofile.dev/2020/12/16/elam.html" rel="noopener ugc nofollow" target="_blank">here</a>.</p><h2 id="0050" class="pq op hl bg oq pr ps pt ot pu pv pw ow px py pz qa qb qc qd qe qf qg qh qi qj bl" data-selectable-paragraph="">Conclusion</h2><p id="73ee" class="pw-post-body-paragraph mx my hl mz b na ph nc nd ne pi ng nh ni pj nk nl nm pk no np nq pl ns nt nu he bl" data-selectable-paragraph="">At their core, EDR agents are just pieces of software which collect data from a finite number of available sources on the host. If we can cut off the supply of data to the agent, we can avoid detection regardless of how sophisticated the correlation engine running on the server component is. Because agents collect data from multiple sources (e.g. hooked functions, ETW, driver callbacks) working in tandem, we need to understand the limitations of each these sources to identify blind spots. Once we’ve identified the blind spots, we can then tailor our TTPs to avoid hitting as many “sensors” as possible, giving us a higher chance of success during the operation.</p><p id="57d7" class="pw-post-body-paragraph mx my hl mz b na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu he bl" data-selectable-paragraph="">By removing the heavy reliance on anecdotal evidence from our evasion tradecraft and instead using a capability-driven approach, we will be more effective against new or unknown PSPs which we may not be familiar with.</p></div></div></div><div class="ac ci rq rr rs rt" role="separator"><span class="ru by bn rv rw rx"></span><span class="ru by bn rv rw rx"></span><span class="ru by bn rv rw"></span></div><div class="he hf hg hh hi"><div class="ac ci"><div class="cp bi gq gr gs gt"><h2 id="4106" class="pq op hl bg oq pr ry pt ot pu rz pw ow px sa pz qa qb sb qd qe qf sc qh qi qj bl" data-selectable-paragraph="">Additional Resources</h2><ul class=""><li id="b2ec" class="mx my hl mz b na ph nc nd ne pi ng nh ni pj nk nl nm pk no np nq pl ns nt nu rc rd re bl" data-selectable-paragraph=""><a class="ah on" href="https://thewover.github.io/Dynamic-Invoke/" rel="noopener ugc nofollow" target="_blank">https://thewover.github.io/Dynamic-Invoke/</a></li><li id="7f3e" class="mx my hl mz b na rf nc nd ne rg ng nh ni rh nk nl nm ri no np nq rj ns nt nu rc rd re bl" data-selectable-paragraph=""><a class="ah on" href="https://www.mdsec.co.uk/2020/08/firewalker-a-new-approach-to-generically-bypass-user-space-edr-hooking/" rel="noopener ugc nofollow" target="_blank">https://www.mdsec.co.uk/2020/08/firewalker-a-new-approach-to-generically-bypass-user-space-edr-hooking/</a></li><li id="4cac" class="mx my hl mz b na rf nc nd ne rg ng nh ni rh nk nl nm ri no np nq rj ns nt nu rc rd re bl" data-selectable-paragraph=""><a class="ah on" href="https://www.ired.team/offensive-security/defense-evasion/bypassing-cylance-and-other-avs-edrs-by-unhooking-windows-apis" rel="noopener ugc nofollow" target="_blank">https://www.ired.team/offensive-security/defense-evasion/bypassing-cylance-and-other-avs-edrs-by-unhooking-windows-apis</a></li><li id="d9ba" class="mx my hl mz b na rf nc nd ne rg ng nh ni rh nk nl nm ri no np nq rj ns nt nu rc rd re bl" data-selectable-paragraph=""><a class="ah on" href="https://jhalon.github.io/utilizing-syscalls-in-csharp-2/" rel="noopener ugc nofollow" target="_blank">https://jhalon.github.io/utilizing-syscalls-in-csharp-2/</a></li><li id="7714" class="mx my hl mz b na rf nc nd ne rg ng nh ni rh nk nl nm ri no np nq rj ns nt nu rc rd re bl" data-selectable-paragraph=""><a class="ah on" href="https://www.fuzzysecurity.com/tutorials/29.html" rel="noopener ugc nofollow" target="_blank">https://www.fuzzysecurity.com/tutorials/29.html</a></li></ul></div></div></div></div></section></div></div></article></div><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="sd se ac jl"><div class="sf ac"><a class="sg ak ao aq" rel="noopener follow" href="https://medium.com/tag/evasion?source=post_page-----1fe0bac57aa---------------------------------------" data-discover="true"><div class="sh fr de si gv sj sk bg b bh ab bl gc">Evasion</div></a></div></div></div></div><div class="m"></div><div class="sz m"><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="ac iv it ir ta tb"><div class="tc td te tf tg th ti tj tk tl ac cw"><div class="i l"><a tabindex="0" rel="noopener follow" href="https://medium.com/@matterpreter?source=post_page---post_author_info--1fe0bac57aa---------------------------------------" data-discover="true"><div class="m fr"><img alt="Matt Hand" class="m fk by tm tn de" width="48" height="48" loading="lazy" src="https://miro.medium.com/v2/resize:fill:48:48/2*HFgLEKa86-RKIOoc4CfbOA.png"><div class="gj by m tm tn fw o ak to"></div></div></a></div><div class="k j e"><a tabindex="0" rel="noopener follow" href="https://medium.com/@matterpreter?source=post_page---post_author_info--1fe0bac57aa---------------------------------------" data-discover="true"><div class="m fr"><img alt="Matt Hand" class="m fk by tp tq de" width="64" height="64" loading="lazy" src="https://miro.medium.com/v2/resize:fill:64:64/2*HFgLEKa86-RKIOoc4CfbOA.png"><div class="gj by m tp tq fw o ak to"></div></div></a></div><div class="k j e tr cb"><div class="ac"><button class="uz ze aq ac ci r zk kt zl" style="border: 1px solid rgba(8, 8, 8, 0.22);"><span class="bg b bh ab bl bi"><span class="bn zi">Follow</span></span></button></div></div></div><div class="ac cv cd"><div class="ts tt tu tv tw m"><a class="ah ai aj al am an ao ap aq ar as at au av ac r" rel="noopener follow" href="https://medium.com/@matterpreter?source=post_page---post_author_info--1fe0bac57aa---------------------------------------" data-discover="true"><h2 class="pw-author-name bg ty tz ua ub uc ud ue ni oy oz nm pb pc nq pe pf bl"><span class="he tx">Written by Matt Hand</span></h2><div class="uf ac"><div><div class="ac" aria-describedby="15" aria-labelledby="15" role="tooltip"><div tabindex="-1" class="bf"><div class="ac jj"><div class="ac"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 16 16"><path fill="#437AFF" d="M15.163 8c0 .65-.459 1.144-.863 1.575-.232.244-.471.5-.563.719s-.086.543-.092.875c-.006.606-.018 1.3-.49 1.781-.47.481-1.15.494-1.744.5-.324.006-.655.013-.857.094s-.465.337-.704.575c-.422.412-.906.881-1.542.881-.637 0-1.12-.469-1.543-.881-.239-.238-.49-.482-.704-.575-.214-.094-.532-.088-.857-.094-.593-.006-1.273-.019-1.744-.5s-.484-1.175-.49-1.781c-.006-.332-.012-.669-.092-.875-.08-.207-.33-.475-.563-.719-.404-.431-.863-.925-.863-1.575s.46-1.144.863-1.575c.233-.244.472-.5.563-.719.092-.219.086-.544.092-.875.006-.606.019-1.3.49-1.781s1.15-.494 1.744-.5c.325-.006.655-.012.857-.094.202-.081.465-.337.704-.575C7.188 1.47 7.671 1 8.308 1s1.12.469 1.542.881c.239.238.49.481.704.575s.533.088.857.094c.594.006 1.273.019 1.745.5.47.481.483 1.175.49 1.781.005.331.011.669.091.875s.33.475.563.719c.404.431.863.925.863 1.575"></path><path fill="#fff" d="M7.328 10.5c.195 0 .381.08.519.22.137.141.215.331.216.53 0 .066.026.13.072.177a.24.24 0 0 0 .346 0 .25.25 0 0 0 .071-.177c.001-.199.079-.389.216-.53a.73.73 0 0 1 .519-.22h1.959c.13 0 .254-.053.346-.146a.5.5 0 0 0 .143-.354V6a.5.5 0 0 0-.143-.354.49.49 0 0 0-.346-.146h-1.47c-.324 0-.635.132-.865.366-.23.235-.359.552-.359.884v2.5c0 .066-.025.13-.071.177a.24.24 0 0 1-.346 0 .25.25 0 0 1-.072-.177v-2.5c0-.332-.13-.65-.359-.884A1.21 1.21 0 0 0 6.84 5.5h-1.47a.49.49 0 0 0-.346.146A.5.5 0 0 0 4.88 6v4c0 .133.051.26.143.354a.49.49 0 0 0 .347.146z"></path></svg></div></div></div></div></div></div></a><div class="sf ac ix"><div class="m cb"><span class="pw-follower-count bg b bh ab eb"><a class="ah ai aj fo al am an ao ap aq ar as at jg" rel="noopener follow" href="https://medium.com/@matterpreter/followers?source=post_page---post_author_info--1fe0bac57aa---------------------------------------" data-discover="true">476 followers</a></span></div><div class="bg b bh ab eb ac qw"><span class="ug m" aria-hidden="true"><span class="bg b bh ab eb">·</span></span><a class="ah ai aj fo al am an ao ap aq ar as at jg" rel="noopener follow" href="https://medium.com/@matterpreter/following?source=post_page---post_author_info--1fe0bac57aa---------------------------------------" data-discover="true">5 following</a></div></div><div class="uh m"><p class="bg b bh ab bl">Red team guy gone purple @preludeorg 💜 | Author of Evading EDR <a class="ah ai aj fo al am an ao ap aq ar as at on hf he" href="http://nostarch.com/evading-edr" rel="noopener  ugc nofollow">http://nostarch.com/evading-edr</a> 📖 | Security research &amp; windows internals 🦠</p></div></div></div><div class="i l"><div class="ac"><button class="uz ze aq ac ci r zk kt zl" style="border: 1px solid rgba(8, 8, 8, 0.22);"><span class="bg b bh ab bl bi"><span class="bn zi">Follow</span></span></button></div></div></div></div></div></div><div class="ui uj uk ul um m"><div class="un bi s sz"></div><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="ac r cw"><h2 class="bg ty pr pt ot pu pw ow px pz qa qb qd qe qf qh qi bl">Responses (1)</h2><div class="ac uo"><div><div class="bn" aria-describedby="16" aria-labelledby="16" role="tooltip"><div tabindex="-1" class="bf"><a class="up uq" href="https://policy.medium.com/medium-rules-30e5502c4eb4?source=post_page---post_responses--1fe0bac57aa---------------------------------------" rel="noopener follow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" aria-label="Shield with a checkmark" viewBox="0 0 25 25"><path fill-rule="evenodd" d="M11.987 5.036a.754.754 0 0 1 .914-.01c.972.721 1.767 1.218 2.6 1.543.828.322 1.719.485 2.887.505a.755.755 0 0 1 .741.757c-.018 3.623-.43 6.256-1.449 8.21-1.034 1.984-2.662 3.209-4.966 4.083a.75.75 0 0 1-.537-.003c-2.243-.874-3.858-2.095-4.897-4.074-1.024-1.951-1.457-4.583-1.476-8.216a.755.755 0 0 1 .741-.757c1.195-.02 2.1-.182 2.923-.503.827-.322 1.6-.815 2.519-1.535m.468.903c-.897.69-1.717 1.21-2.623 1.564-.898.35-1.856.527-3.026.565.037 3.45.469 5.817 1.36 7.515.884 1.684 2.25 2.762 4.284 3.571 2.092-.81 3.465-1.89 4.344-3.575.886-1.698 1.299-4.065 1.334-7.512-1.149-.039-2.091-.217-2.99-.567-.906-.353-1.745-.873-2.683-1.561m-.009 9.155a2.672 2.672 0 1 0 0-5.344 2.672 2.672 0 0 0 0 5.344m0 1a3.672 3.672 0 1 0 0-7.344 3.672 3.672 0 0 0 0 7.344m-1.813-3.777.525-.526.916.917 1.623-1.625.526.526-2.149 2.152z" clip-rule="evenodd"></path></svg></a></div></div></div></div></div><div class="ur us ut uu uv uw ux m"><div><div class="bg b bh ab bl"><div class="ym"><div class="yu m"><div class="yv ac r"><div class="m fr"><img alt="" class="m fk by bz ca de" width="32" height="32" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fill:32:32/1*dmbNkD5D-u45r44go_cf0g.png"><div class="gj by m bz ca fw o ak to"></div></div><div class="bo ac cu cv ci"><p class="bg b bh ab eb">Write a response</p></div></div><div class="de bq ac cv yn yo"><div class="ac cv fr"><span data-dd-action-name="Susi presentation tracker respond_sidebar"><a class="ah ai aj fo al am an ao ap aq ar as at au av" rel="noopener follow" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40matterpreter%2Fadventures-in-dynamic-evasion-1fe0bac57aa&amp;source=---post_responses--1fe0bac57aa---------------------respond_sidebar------------------" data-discover="true"><div class="wq m"><p class="bg b bh ab eb">What are your thoughts?</p></div></a></span><div class="cw yp eb ac yq xq yr"><span class="bg b bh ab eb"><div class="ac"><div><div class="bn" aria-describedby="29" aria-labelledby="29" role="tooltip"><div tabindex="-1" class="bf"><span role="button" aria-label="Bold (⌘B)" class="yw yx yy yz bq ly ci za zb zc" tabindex="0"><svg width="21" height="21"><path fill-rule="evenodd" d="M10.308 17.993h-5.92l.11-.894.783-.12c.56-.11.79-.224.79-.448V5.37c0-.225-.113-.336-.902-.448H4.5l-.114-.894h6.255c4.02 0 5.58 1.23 5.58 3.13 0 1.896-1.78 3.125-3.79 3.463v.11c2.69.34 4.25 1.56 4.25 3.57 0 2.35-2.01 3.69-6.37 3.69l.02.01h-.02zm-.335-12.96H8.967V10.5h1.23c1.788 0 2.79-1.23 2.79-2.683 0-1.685-1.004-2.803-3.006-2.803v.02zm-.223 6.36h-.783v5.588l1.225.23h.22c1.67 0 3.01-1.004 3.01-2.792 0-2.122-1.566-3.016-3.69-3.016h.018z"></path></svg></span></div></div></div><div><div class="bn" aria-describedby="30" aria-labelledby="30" role="tooltip"><div tabindex="-1" class="bf"><span role="button" aria-label="Italic (⌘I)" class="yw yx yy yz bq ly ci za zb zc" tabindex="0"><svg width="21" height="21"><path fill-rule="evenodd" d="M9.847 18.04c-.533 0-2.027-.64-1.92-.853l2.027-7.68-.64-.214-1.387 1.494-.427-.427c.534-1.173 1.707-2.667 2.774-2.667.533 0 2.24.534 2.133.854l-2.133 7.786.533.214 1.6-1.067.427.427c-.64 1.066-1.92 2.133-2.987 2.133m2.347-11.733c-.96 0-1.387-.64-1.387-1.387 0-1.067.747-1.92 1.493-1.92.854 0 1.387.64 1.387 1.493-.107 1.067-.747 1.814-1.493 1.814"></path></svg></span></div></div></div></div></span><div class="ys tr ac yq xq yr"><div class="yt"><button class="bg b ec ab bl zd uy uz va lx lu vb fc fd fe vc vd ve fh fi fj fk bn fl fm" data-testid="CancelResponseButton">Cancel</button></div><button class="bg b ec ab xd zd xe xf xg xh vb fc fd xi xj xk fh fi fj fk bn fl fm" disabled="" data-testid="ResponseRespondButton">Respond</button></div></div></div></div></div></div></div></div></div><div class="rq m"><button class="bg b bh ab bl sh uy uz va lx lu vb fc fd fe vc vd ve fh vf vg vh vi vj fi fj fk bn fl fm">See all responses</button></div></div></div></div><div class="vk vl vm vn vo m bx"><div class="i l k"><div class="un bi vp vq"></div><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="vr ac ku jl"><div class="vs vt m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://help.medium.com/hc/en-us?source=post_page-----1fe0bac57aa---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Help</p></a></div><div class="vs vt m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://status.medium.com/?source=post_page-----1fe0bac57aa---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Status</p></a></div><div class="vs vt m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" rel="noopener follow" href="https://medium.com/about?autoplay=1&amp;source=post_page-----1fe0bac57aa---------------------------------------" data-discover="true"><p class="bg b ec ab eb">About</p></a></div><div class="vs vt m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" rel="noopener follow" href="https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----1fe0bac57aa---------------------------------------" data-discover="true"><p class="bg b ec ab eb">Careers</p></a></div><div class="vs vt m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="mailto:pressinquiries@medium.com" rel="noopener follow"><p class="bg b ec ab eb">Press</p></a></div><div class="vs vt m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://blog.medium.com/?source=post_page-----1fe0bac57aa---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Blog</p></a></div><div class="vs vt m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----1fe0bac57aa---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Privacy</p></a></div><div class="vs vt m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://policy.medium.com/medium-rules-30e5502c4eb4?source=post_page-----1fe0bac57aa---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Rules</p></a></div><div class="vs vt m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----1fe0bac57aa---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Terms</p></a></div><div class="vs m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://speechify.com/medium?source=post_page-----1fe0bac57aa---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Text to speech</p></a></div></div></div></div></div></div></div></div></div></div></div></div>





































<div height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" data-original-tag="iframe"></div>
<div><div class="grecaptcha-badge" data-style="bottomright" style="width: 256px; height: 60px; display: block; transition: right 0.3s; position: fixed; bottom: 14px; right: -186px; box-shadow: gray 0px 0px 5px; border-radius: 2px; overflow: hidden;"><div class="grecaptcha-logo"><div title="reCAPTCHA" width="256" height="60" role="presentation" name="a-uftvvdxdu044" frameborder="0" scrolling="no" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-top-navigation allow-modals allow-popups-to-escape-sandbox allow-storage-access-by-user-activation" src="https://www.google.com/recaptcha/enterprise/anchor?ar=1&amp;k=6Le-uGgpAAAAAPprRaokM8AKthQ9KNGdoxaGUvVp&amp;co=aHR0cHM6Ly9tZWRpdW0uY29tOjQ0Mw..&amp;hl=en&amp;v=vUgXt_KV952_-5BB2jjloYzl&amp;size=invisible&amp;anchor-ms=20000&amp;execute-ms=30000&amp;cb=bva11atpsay1" data-original-tag="iframe">

<title>reCAPTCHA</title>

<link rel="stylesheet" type="text/css" href="https://www.gstatic.com/recaptcha/releases/vUgXt_KV952_-5BB2jjloYzl/styles__ltr.css">


<div id="rc-anchor-alert" class="rc-anchor-alert"></div>

<div class="rc-anchor rc-anchor-invisible rc-anchor-light  rc-anchor-invisible-hover"><div id="recaptcha-accessible-status" class="rc-anchor-aria-status" aria-hidden="true">Recaptcha requires verification. </div><div class="rc-anchor-error-msg-container" style="display:none"><span class="rc-anchor-error-msg" aria-hidden="true"></span></div><div class="rc-anchor-normal-footer"><div class="rc-anchor-logo-large" role="presentation"><div class="rc-anchor-logo-img rc-anchor-logo-img-large"></div></div><div class="rc-anchor-pt"><a href="https://www.google.com/intl/en/policies/privacy/" target="_blank">Privacy</a><span aria-hidden="true" role="presentation"> - </span><a href="https://www.google.com/intl/en/policies/terms/" target="_blank">Terms</a></div></div><div class="rc-anchor-invisible-text"><span>protected by <strong>reCAPTCHA</strong></span><div class="rc-anchor-pt"><a href="https://www.google.com/intl/en/policies/privacy/" target="_blank" style="">Privacy</a><span aria-hidden="true" role="presentation"> - </span><a href="https://www.google.com/intl/en/policies/terms/" target="_blank" style="">Terms</a></div></div></div></div></div><div class="grecaptcha-error"></div><textarea id="g-recaptcha-response-100000" name="g-recaptcha-response" class="g-recaptcha-response" style="width: 250px; height: 40px; border: 1px solid rgb(193, 193, 193); margin: 10px 25px; padding: 0px; resize: none; display: none;"></textarea></div></div></body></html>