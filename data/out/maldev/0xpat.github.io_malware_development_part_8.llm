Title:
Malware development part 8 – COFF injection and in-memory execution

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how to execute MSVC-generated COFF `.obj` files directly from memory by building a minimal COFF loader, similar in concept to Cobalt Strike’s Beacon Object Files (BOFs).  
- It breaks down COFF structure (sections, symbol table, relocations, linker directives) and shows why relocations are required to turn raw `.text` bytes into runnable code.  
- The author implements a PoC loader that parses the object, allocates memory, copies code and static data, resolves imports (via `LoadLibrary`/`GetProcAddress` or alternative module enumeration), applies relocations, and then calls the entry function.  
- It also discusses extending the model with a custom “Beacon-like” API by exposing additional imported functions to the object code.  
- The technique is useful for red teams and malware developers for modular payload delivery and in-memory execution without a full PE loader, and for blue teams to understand a common post-exploitation execution primitive.  
- Caveats include assumptions like a single entry function, no CRT initialization, and sensitivity to compiler optimizations.

Technical Focus:
- COFF object format internals (MSVC `.obj`): sections, `.drectve`, `.rdata`, `.text`
- Relocation processing and symbol resolution for in-memory execution
- Import resolution from linker directives and `__imp_` symbols
- Manual loader design: memory layout, RWX/`VirtualProtect`, calling conventions (x64)
- BOF-style execution model and custom API exposure

Use Cases:
- In-memory execution of COFF/BOF-style modules delivered over C2
- Building custom BOF loaders for post-exploitation frameworks
- Researching detection opportunities around object-file loading and relocation behavior
- Rapid prototyping of modular payloads without producing a full PE executable

Keywords:
COFF, MSVC, .obj, Beacon Object File, BOF, in-memory execution, relocations, COFF symbol table, .drectve, .text, .rdata, LoadLibrary, GetProcAddress, VirtualProtect, PEB, InMemoryOrderModuleList, x64 calling convention, C2 payload delivery, manual loader