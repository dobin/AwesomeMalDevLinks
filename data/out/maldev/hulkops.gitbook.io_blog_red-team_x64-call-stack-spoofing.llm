Title:
x64 Call Stack Spoofing

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how to spoof an x64 thread call stack on Windows by building synthetic stack frames so stack unwinding appears legitimate to security products that inspect call stacks.  
- It addresses the key weakness of simple return-address spoofing: broken unwind chains that lead to incomplete stack unwinding and easy detection.  
- The technique dynamically computes stack-frame sizes using Windows x64 exception unwinding metadata in the `.pdata` section (RUNTIME_FUNCTION / UNWIND_INFO) rather than hardcoding frame layouts that vary across Windows builds.  
- It uses a JOP-style gadget (e.g., `jmp qword ptr [rbx]`) as a fake return address and performs the target WinAPI invocation via `jmp` (not `call`) to avoid pushing a real return address.  
- An assembly “Spoof” routine constructs frames resembling `RtlUserThreadStart` and `BaseThreadInitThunk`, sets up fastcall arguments (including shadow space), executes the API, then restores the original stack to prevent crashes.  
- Useful primarily for red teamers, implant developers, and malware researchers; it also includes detection notes (e.g., “missing call” artifacts) relevant to defenders.

Technical Focus:
- Windows x64 stack frames, prologue/epilogue behavior, non-volatile register saving
- Stack unwinding via `.pdata`, RUNTIME_FUNCTION, UNWIND_INFO, UNWIND_CODE parsing
- Synthetic stack frame construction for call stack spoofing
- JOP gadgets as synthetic return addresses
- Windows x64 fastcall calling convention and shadow space
- `jmp` vs `call` tradeoffs for call stack integrity

Use Cases:
- Evading user-mode EDR call-stack based detections during WinAPI execution
- Building stealthier loaders/implants that mask API call origins
- Researching/demonstrating unwind-aware stack manipulation techniques
- Developing defensive detections for anomalous unwind/call relationships (missing `call`)

Keywords:
Windows x64, call stack spoofing, return address spoofing, stack unwinding, `.pdata`, RUNTIME_FUNCTION, UNWIND_INFO, UNWIND_CODE, SEH, IMAGE_DIRECTORY_ENTRY_EXCEPTION, UWOP_ALLOC_SMALL, UWOP_ALLOC_LARGE, UWOP_PUSH_NONVOL, UWOP_PUSH_MACHFRAME, JOP gadget, `jmp [rbx]`, fastcall, shadow space, RtlUserThreadStart, BaseThreadInitThunk, EDR telemetry