Title:
Revisiting the User-Defined Reflective Loader Part 1: Simplifying Development

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post introduces UDRL-VS, a Visual Studio-based template added to Cobalt Strike’s Arsenal Kit to make developing and debugging User-Defined Reflective Loaders (UDRLs) easier.  
- It explains reflective loading requirements (memory allocation, import resolution, relocations, entry point execution) and contrasts “loader inside DLL” (Stephen Fewer/Beacon default) vs “prepended loader” (DoublePulsar/sRDI-style) approaches.  
- The core contribution is a workflow to build a position-independent loader as a PE, debug it in VS (Debug build), then extract the `.text` section as shellcode and prepend/stomp it onto Beacon (Release builds).  
- It covers practical compiler/linker settings for PIC, function ordering using `#pragma code_seg` (e.g., `.text$a` and `.text$z`), and x64 vs x86 differences in locating the appended Beacon payload.  
- The template adds QoL helpers like compile-time API hashing, a debug-only `PRINT()` that resolves APIs at runtime, and PIC-safe string macros using `constexpr`.  
- It also shows how to operationalize the loader via Aggressor Script by either prepending the loader to Beacon or overwriting Beacon’s exported `ReflectiveLoader()`.

Technical Focus:
- Reflective DLL loading / in-memory PE mapping (imports, relocations, entry point)
- Position Independent Code (PIC) constraints in Windows loaders
- Function/section ordering with `#pragma code_seg` and linker section sorting (`.text$*`)
- x86 vs x64 addressing differences (RIP-relative vs absolute) and `_ReturnAddress()` usage
- Compile-time hashing for API/module resolution
- Extracting `.text` as shellcode and integrating with Cobalt Strike Beacon via CNA/Aggressor

Use Cases:
- Build and debug custom Cobalt Strike UDRLs in Visual Studio
- Create DoublePulsar-style “prepended loader + Beacon” payloads
- Replace (stomp) Beacon’s default `ReflectiveLoader()` with a custom loader
- Rapid regression testing of PIC loaders via local shellcode execution script
- Implement loader-level changes to alter Beacon loading behavior for evasion research

Keywords:
Cobalt Strike, Beacon, UDRL, User-Defined Reflective Loader, reflective DLL injection, Stephen Fewer, DoublePulsar, sRDI, PE format, imports, relocations, entry point, position independent code, Visual Studio, pragma code_seg, .text section extraction, RIP-relative addressing, _ReturnAddress, compile-time hashing, Aggressor Script, CNA, setup_reflective_loader, NtFlushInstructionCache, GetProcAddress, LoadLibraryA, VirtualAlloc