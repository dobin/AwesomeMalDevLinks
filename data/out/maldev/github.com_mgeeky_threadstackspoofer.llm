Title:
Thread Stack Spoofing / Call Stack Spoofing PoC (ThreadStackSpoofer)

Type:
GitHub Tool

Short Summary (4–8 sentences max):
ThreadStackSpoofer is a C++ proof-of-concept demonstrating “thread/call stack spoofing” as an in-memory evasion technique for injected shellcode. It targets scanners/analysts that walk thread stacks and flag return addresses that point into non-image, privately allocated memory (e.g., VirtualAlloc’d shellcode regions). The PoC hooks `kernel32!Sleep` so that when a Beacon sleeps, a callback (`MySleep`) temporarily overwrites a controlled return address on the stack with `0`, effectively truncating/terminating stack unwinding and hiding shellcode-related frames. The repo documents both a newer, simpler approach (return-address overwrite) and an older approach using `StackWalk64` (via dbghelp). It’s primarily useful for red team tool authors and malware researchers building custom loaders, and it highlights limitations: the resulting stack can be “unwindable”/anomalous and is not a full fake-frame stack spoofer. The README also outlines what a “true” spoofer would require on x64: reverse-emulating Windows unwind metadata (`.pdata`, `RtlVirtualUnwind`) to craft believable frames.

Technical Focus:
- Thread call stack inspection evasion (stack/call stack spoofing)
- API hooking of `kernel32!Sleep` / `SleepEx` for implant “sleep” interception
- Return address manipulation via `_AddressOfReturnAddress()` and frame pointers (RBP/EBP)
- Windows x64 stack unwinding internals (`RtlLookupFunctionEntry`, `RtlVirtualUnwind`, UNWIND_INFO/UWOP)
- Shellcode loading/execution (`VirtualAlloc`, `memcpy`, `CreateThread`)
- dbghelp-based stack walking (`SymInitialize`, `StackWalk64`) in older implementation

Use Cases:
- Integrate call-stack hiding into custom shellcode loaders (especially Cobalt Strike Beacon-style sleep loops)
- Evaluate/replicate commercial C2 in-memory evasion behaviors in lab environments
- Research and develop detections for anomalous/unwind-broken thread stacks and Sleep-hooking patterns
- Prototype advanced x64 fake-frame construction using `.pdata` unwind metadata

Keywords:
ThreadStackSpoofer, call stack spoofing, thread stack spoofing, in-memory evasion, shellcode loader, Cobalt Strike Beacon, kernel32 Sleep hook, SleepEx, return address overwrite, _AddressOfReturnAddress, RBP, EBP, VirtualAlloc, CreateThread, dbghelp.dll, StackWalk64, SymInitialize, x64 unwinding, RtlVirtualUnwind, RtlLookupFunctionEntry, UNWIND_INFO, UWOP, .pdata, IMAGE_DIRECTORY_ENTRY_EXCEPTION, SEC_PRIVATE