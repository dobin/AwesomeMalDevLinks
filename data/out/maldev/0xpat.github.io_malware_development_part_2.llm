Title:
Malware development part 2 – anti dynamic analysis & sandboxes

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post walks through common anti–dynamic analysis techniques used by Windows malware to evade automated sandboxes and analyst VMs.  
- It demonstrates gating payload execution (a XOR-decrypted x64 reverse shell shellcode launcher) behind environment fingerprinting checks so sandboxes fail to extract network IoCs (e.g., C2 IP/handler).  
- Techniques include VM detection via hardware/resource constraints, device/vendor strings, VM artifacts (files/registry), process/module/window enumeration for analysis tools, and “seasoned system” heuristics (USB history, recent files, uptime).  
- It also covers sandbox-specific evasions such as requiring real internet connectivity/expected HTTP responses, user interaction (message boxes, mouse movement), and sleep/uptime tricks including KUSER_SHARED_DATA tickcount validation.  
- Finally, it explains user-mode hook detection/unhooking by comparing in-memory function bytes to the on-disk DLL image, and bypassing hooks via direct syscalls (NtCreateThreadEx), noting syscall ID versioning and SysWhispers for portability.  
- Useful primarily for red teamers, malware developers, and defenders studying evasion tradecraft and sandbox limitations.

Technical Focus:
- VM/sandbox fingerprinting (resources, devices, artifacts, WMI/SetupAPI)
- Anti-analysis heuristics (process/module/window enumeration, parent process checks)
- “Human/real system” signals (recent files, USBSTOR history, uptime, screen resolution)
- Anti-sandbox execution gating (WinHTTP connectivity and response checks, user interaction)
- Sleep fast-forward detection (GetTickCount64 vs KUSER_SHARED_DATA)
- Hook detection/unhooking and direct syscalls (ntdll exports, NtCreateThreadEx, SysWhispers)

Use Cases:
- Build sandbox-aware droppers/launchers that suppress payload execution in analysis environments
- Reduce dynamic IoC extraction by delaying/gating network activity and shellcode execution
- Detect and remediate user-mode API hooks in-process (compare to clean on-disk images)
- Implement direct syscall stubs to bypass user-mode EDR hooks on sensitive APIs
- Create defensive test cases to validate sandbox realism and EDR hooking coverage

Keywords:
Windows malware development, dynamic analysis evasion, sandbox detection, VM detection, VirtualBox artifacts, WMI, SetupDiGetClassDevs, IOCTL_DISK_GET_DRIVE_GEOMETRY, GetAdaptersAddresses, MAC OUI, USBSTOR registry, Recent files, NetGetJoinInformation, GetTickCount64, NtDelayExecution, KUSER_SHARED_DATA, API hooking, unhooking ntdll, PE export parsing, NtCreateThreadEx, direct syscalls, SysWhispers, WinHTTP