# https://www.mdsec.co.uk/2020/12/bypassing-user-mode-hooks-and-direct-invocation-of-system-calls-for-red-teams/

<!DOCTYPE html><!--[if lt IE 7 ]><html lang="en-GB" class="no-js ie ie6 lte7 lte8 lte9"><![endif]--><!--[if IE 7 ]><html lang="en-GB" class="no-js ie ie7 lte7 lte8 lte9"><![endif]--><!--[if IE 8 ]><html lang="en-GB" class="no-js ie ie8 lte8 lte9"><![endif]--><!--[if IE 9 ]><html lang="en-GB" class="no-js ie ie9 lte9"><![endif]--><!--[if (gt IE 9)|!(IE)]><!--><html lang="en-GB" class=" js flexbox flexboxlegacy canvas canvastext postmessage no-websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers no-applicationcache svg inlinesvg" dir="ltr"><!--<![endif]-->
	    
	<body class="wp-singular post-template-default single single-post postid-2505 single-format-standard wp-theme-mdsec">
    <!--[if lt IE 7]>
        <div class="browse-happy">
        	 <a href="https://www.mdsec.co.uk">
				<div id="logo">Logo</div>
			</a>
        	<p>You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        </div>    	
    <![endif]-->              
	
	<!-- Site Wrapper Start --> 
	<div class="site-wrapper">
		
	<!-- Header Start --> 
	
    <!-- Header End --> 
		
		
	<div class="subnav">
		<section class="content-wrapper">
			<ul class="service-list clearfix">
				<li class="item" style="">
					<a href="https://www.mdsec.co.uk/our-services/adversary-simulation/">
						<div class="service-icon">
							<img src="https://www.mdsec.co.uk/wp-content/themes/mdsec/img/icons/icon-adversary.svg" alt="Adversary" width="300" height="150">
						</div>
						<hgroup>
							<h2>
								Adversary Simulation
							</h2>
						</hgroup>
						<p>Our best in class red team can deliver a holistic cyber attack simulation to provide a true evaluation of your organisation’s cyber resilience.</p>
						
					</a>
				</li>
				<li class="item" style="">
					<a href="https://www.mdsec.co.uk/our-services/applicaton-security/">
						<div class="service-icon">
							<img src="https://www.mdsec.co.uk/wp-content/themes/mdsec/img/icons/icon-application-security.svg" alt="Application Security" width="300" height="150">
						</div>
						<hgroup>
							<h2>
								Application <br>Security
							</h2>
						</hgroup>
						<p>Leverage the team behind the industry-leading Web Application and Mobile Hacker’s Handbook series.</p>
					</a>
				</li>
				<li class="item" style="">
					<a href="https://www.mdsec.co.uk/our-services/penetration-testing/">
						<div class="service-icon">
							<img src="https://www.mdsec.co.uk/wp-content/themes/mdsec/img/icons/icon-penetration-testing.svg" alt="Penetration Testing" width="300" height="150">
						</div>
						<hgroup>
							<h2>
								Penetration <br>Testing
							</h2>
						</hgroup>
						<p>MDSec’s penetration testing team is trusted by companies from the world’s leading technology firms to global financial institutions.</p>
					</a>
				</li>
				<li class="item" style="">
					<a href="https://www.mdsec.co.uk/our-services/response/">
						<div class="service-icon">
							<img src="https://www.mdsec.co.uk/wp-content/themes/mdsec/img/icons/icon-response.svg" alt="Response" width="300" height="150">
						</div>
						<hgroup>
							<h2>
								Response
							</h2>
						</hgroup>
						<p>Our certified team work with customers at all stages of the Incident Response lifecycle through our range of proactive and reactive services.</p>
					</a>
				</li>
			</ul>
		</section>		
	</div>
	<div class="subnav-kc">
		<section class="content-wrapper">
			<ul class="service-list clearfix">
				<li>
					<a href="https://www.mdsec.co.uk/knowledge-centre/research/">
						<hgroup>
							<h2>
								Research
							</h2>
						</hgroup>
						<p>MDSec’s dedicated research team periodically releases white papers, blog posts, and tooling.</p>
					</a>
				</li>
				<li>
					<a href="https://www.mdsec.co.uk/knowledge-centre/training/">
						<hgroup>
							<h2>
								Training
							</h2>
						</hgroup>
						<p>MDSec’s training courses are informed by our security consultancy and research functions, ensuring you benefit from the latest and most applicable trends in the field.</p>
					</a>
				</li>
				<li>
					<a href="https://www.mdsec.co.uk/knowledge-centre/insights/">
						<hgroup>
							<h2>
								Insights
							</h2>
						</hgroup>
						<p>View insights from MDSec’s consultancy and research teams.</p>
					</a>
				</li>
			</ul>
		</section>		
	</div>		

	
	<section class="insights-single-header">
		<div class="content-wrapper">
			<div class="the-category">
			<span class="category">ActiveBreach</span>			</div>
			<h1>Bypassing User-Mode Hooks and Direct Invocation of System Calls for Red Teams</h1>
		</div>
	</section>

	<section class="full-width-wrapper white pad20-120">
		<div class="content-wrapper">
			<div class="breadcrumb-wrapper">
				
			</div>	

		</div>
		
		<div class="insights-content">
		
<h2 class="wp-block-heading">Introduction</h2>



<p>The motivation to bypass user-mode hooks initially began with improving the success rate of&nbsp;<a href="https://attack.mitre.org/techniques/T1055/" rel="noreferrer noopener" target="_blank">process injection</a>. There can be legitimate reasons to perform injection.&nbsp;<a href="https://docs.microsoft.com/en-us/windows/win32/winauto/uiauto-msaa" rel="noreferrer noopener" target="_blank">UI Automation and Active Accessibility</a>&nbsp;will use it to read and write memory of a GUI process.&nbsp;<a href="https://docs.microsoft.com/en-us/visualstudio/debugger/introducing-spy-increment" rel="noreferrer noopener" target="_blank">Spy++</a>&nbsp;uses it to log window messages sent and received between processes. But in most cases, it’s used for one of the following:</p>



<ul class="wp-block-list"><li>Hiding code inside a legitimate process to evade, prolong detection and removal.</li><li>Executing code in the context of another user or elevating privileges.</li><li>Modifying memory to cheat at online games.</li></ul>



<p>And another less cited reason is to prevent all the above completing. Generally, process injection from&nbsp;<em>user-mode</em>&nbsp;(UM) applications needs the following steps.</p>



<ol class="wp-block-list"><li>Open a target process.</li><li>Allocate new or use existing memory to store code.</li><li>Write code with optional data to target process.</li><li>Execute code via new or existing thread.</li></ol>



<p>While it’s relatively simple to implement, the most common problem red teamers, game cheats and malware developers encounter today is&nbsp;<em>kernel-mode</em>&nbsp;(KM) notifications,&nbsp;<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/filter-manager-concepts" rel="noreferrer noopener" target="_blank">mini-filter drivers</a>&nbsp;and UM hooks installed by security vendors. UM hooks usually exist for system calls located inside NTDLL, which is about as close to the kernel as a UM process can be. With full access to the kernel, you’d assume security vendors have total control over the system and can block any type of malicious activity quite easily. But as some of you will know already, Windows has a security feature builtin since Vista called PatchGuard (PG) that protects critical areas of the kernel from being modified. Those areas include:</p>



<ul class="wp-block-list"><li>System Service Descriptor Table (SSDT)</li><li>Global Descriptor Table (GDT)</li><li>Interrupt Descriptor Table (IDT)</li><li>System images (<code>ntoskrnl.exe</code>, <code>ndis.sys</code>, <code>hal.dll</code>)</li><li>Processor MSRs (syscall)</li></ul>



<p>PG (much to the disappointment of security vendors and malware developers) restricts any software making extensions to the Windows kernel (even those for legitimate reasons). And up until its introduction, it was commonplace for security vendors to patch the SSDT. (something also used by early versions of&nbsp;<a href="https://github.com/weixu8/RegMon" rel="noreferrer noopener" target="_blank">RegMon</a>&nbsp;by&nbsp;<a href="https://docs.microsoft.com/en-us/sysinternals/" rel="noreferrer noopener" target="_blank">Sysinternals</a>). Microsoft’s position is that&nbsp;<em>any</em>&nbsp;software, whether malicious or not, that patches the kernel can lead to reliability, performance and, most importantly, security issues. Following the release of PG, security vendors had to completely redesign their anti-malware solutions. Circumventing PG is an option, but it’s not a safe, longterm solution for software intended to protect your operating system.</p>



<p>In this post we will catalogue the most popular and effective techniques for bypassing user-mode hooks, outlining advantages and disadvantages of each approach for red teamers where relevant. Finally, we will conclude with some approaches that can be used by defenders to protect or detect these techniques. </p>



<h2 class="wp-block-heading">Kernel-Mode Notifications</h2>



<p>Before exploring UM hook bypass methods, it’s worth noting that as an alternative to patching or hooking in the kernel, Windows facilitates receiving notifications about events useful in detecting malware. The more common events include creation, termination of a process or thread and the mapping of an image/DLL for execution.</p>



<figure class="wp-block-image size-full is-resized"><img fetchpriority="high" decoding="async" src="https://www.mdsec.co.uk/wp-content/uploads/2020/12/Screenshot-2020-12-30-at-09.47.10.png" alt="" class="wp-image-2509" width="907" height="376"></figure>



<p>Microsoft recommends security vendors use&nbsp;<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/filter-manager-concepts" rel="noreferrer noopener" target="_blank">mini-filter</a>&nbsp;drivers to intercept, examine and optionally block I/O events. A significant amount of file system and network functionality is implemented via the&nbsp;<a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntdeviceiocontrolfile" rel="noreferrer noopener" target="_blank">NtDeviceIoControlFile</a>&nbsp;system call.</p>



<h2 class="wp-block-heading">Bypass Methods</h2>



<p>Since Microsoft doesn’t provide a legitimate way for kernel components to receive notifications about memory operations, this forces vendors to install UM hooks in each process. In response to this, various techniques to bypass them have been devised and what follows is a brief description and source code in C to demonstrate some of those methods currently being used.</p>



<h3 class="wp-block-heading">1. Export Address Table (EAT)</h3>



<p>It’s common for malware to resolve the address of system calls using a combination of&nbsp;<a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulehandlea" rel="noreferrer noopener" target="_blank">GetModuleHandle</a>&nbsp;and&nbsp;<a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress" rel="noreferrer noopener" target="_blank">GetProcAddress</a>. Another way is to manually locate <code>NTDLL.dll</code> in the Process Environment Block (PEB) and find the system call through parsing the Export Address Table (EAT). The following code is what you might see used to parse the EAT.</p>



<pre class="wp-block-code"><code class="hljs properties"><span class="hljs-attr">static</span>
<span class="hljs-attr">LPVOID</span>
<span class="hljs-attr">WINAPI</span> <span class="hljs-string"></span>
<span class="hljs-attr">GetProcAddressFromEAT(</span>
    <span class="hljs-attr">LPVOID</span> <span class="hljs-string">DllBase, </span>
    <span class="hljs-attr">const</span> <span class="hljs-string">char *FunctionName)</span>
<span class="hljs-attr">{</span>
    <span class="hljs-attr">PIMAGE_DOS_HEADER</span>       <span class="hljs-string">DosHeader;</span>
    <span class="hljs-attr">PIMAGE_NT_HEADERS</span>       <span class="hljs-string">NtHeaders;</span>
    <span class="hljs-attr">DWORD</span>                   <span class="hljs-string">NumberOfNames, VirtualAddress;</span>
    <span class="hljs-attr">PIMAGE_DATA_DIRECTORY</span>   <span class="hljs-string">DataDirectory;</span>
    <span class="hljs-attr">PIMAGE_EXPORT_DIRECTORY</span> <span class="hljs-string">ExportDirectory;</span>
    <span class="hljs-attr">PDWORD</span>                  <span class="hljs-string">Functions;</span>
    <span class="hljs-attr">PDWORD</span>                  <span class="hljs-string">Names;</span>
    <span class="hljs-attr">PWORD</span>                   <span class="hljs-string">Ordinals;</span>
    <span class="hljs-attr">PCHAR</span>                   <span class="hljs-string">Name;</span>
    <span class="hljs-attr">LPVOID</span>                  <span class="hljs-string">ProcAddress=NULL;</span>
    
    <span class="hljs-attr">DosHeader</span>      = <span class="hljs-string">(PIMAGE_DOS_HEADER)DllBase;</span>
    <span class="hljs-attr">NtHeaders</span>      = <span class="hljs-string">RVA2VA(PIMAGE_NT_HEADERS, DllBase, DosHeader-&gt;e_lfanew);</span>
    <span class="hljs-attr">DataDirectory</span>  = <span class="hljs-string">(PIMAGE_DATA_DIRECTORY)NtHeaders-&gt;OptionalHeader.DataDirectory;</span>
    <span class="hljs-attr">VirtualAddress</span> = <span class="hljs-string">DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress;</span>

    <span class="hljs-attr">if</span> <span class="hljs-string">(VirtualAddress==0) return NULL;</span>
    
    <span class="hljs-attr">ExportDirectory</span> = <span class="hljs-string">RVA2VA(PIMAGE_EXPORT_DIRECTORY, DllBase, VirtualAddress);</span>
    <span class="hljs-attr">NumberOfNames</span>   = <span class="hljs-string">ExportDirectory-&gt;NumberOfNames;</span>

    <span class="hljs-attr">if</span> <span class="hljs-string">(NumberOfNames==0) return NULL;</span>
    
    <span class="hljs-attr">Functions</span> = <span class="hljs-string">RVA2VA(PDWORD,DllBase, ExportDirectory-&gt;AddressOfFunctions);</span>
    <span class="hljs-attr">Names</span>     = <span class="hljs-string">RVA2VA(PDWORD,DllBase, ExportDirectory-&gt;AddressOfNames);</span>
    <span class="hljs-attr">Ordinals</span>  = <span class="hljs-string">RVA2VA(PWORD, DllBase, ExportDirectory-&gt;AddressOfNameOrdinals);</span>
    
    <span class="hljs-attr">do</span> <span class="hljs-string">{</span>
      <span class="hljs-attr">Name</span> = <span class="hljs-string">RVA2VA(PCHAR, DllBase, Names[NumberOfNames-1]);</span>
      <span class="hljs-meta">if(lstrcmpA(Name,</span> <span class="hljs-string">FunctionName) == 0) {</span>
        <span class="hljs-attr">ProcAddress</span> = <span class="hljs-string">RVA2VA(LPVOID, DllBase, Functions[Ordinals[NumberOfNames-1]]);</span>
        <span class="hljs-attr">return</span> <span class="hljs-string">ProcAddress;</span>
      <span class="hljs-attr">}</span>
    <span class="hljs-meta">}</span> <span class="hljs-string">while (--NumberOfNames &amp;&amp; ProcAddress == NULL);</span>
    
    <span class="hljs-attr">return</span> <span class="hljs-string">ProcAddress;</span>
<span class="hljs-attr">}</span>
</code></pre>



<p>If using the base address of NTDLL already in memory, this won’t bypass any UM hooks for system calls. It’s fine if you wish to bypass KERNEL32 or KERNELBASE hooks, but you can just as well use <code>GetProcAddress</code> to make life easier.</p>



<p>Usually, offsec tools will attempt to unhook system calls after calling a function like this and it can work well against many security products. Lately, however, more reputable vendors are either blocking the attempt to unhook or simply restoring the hooks shortly after unhooking has occurred. A hook on <code>NtProtectVirtualMemory</code> could easily intercept attempts to overwrite hooks.</p>



<h3 class="wp-block-heading">2. Dual-load 1 (Section)</h3>



<p>KnownDlls is a directory in the object namespace that contains section objects for the most common DLLs loaded by a process. It’s intended to improve performance by reducing the load time for an executable and it’s possible to map a new copy of NTDLL into a process by opening the section name “<code>\KnownDlls\ntdll.dll</code>“. Once the section object is mapped, we can resolve the address of system calls as described in the previous method. There’s a kernel notification for loading an image and if an EDR or AV spotted NTDLL.dll being loaded a second time, it’s probably going to examine the process for malware or at the very least notify the user of suspicious activity.</p>



<p>While you can use&nbsp;<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwopensection" rel="noreferrer noopener" target="_blank">NtOpenSection</a>&nbsp;and&nbsp;<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwmapviewofsection" rel="noreferrer noopener" target="_blank">NtMapViewOfSection</a>&nbsp;to load a new copy, the other problem is that these are likely to be hooked already. Some products won’t hook&nbsp;<a href="https://twitter.com/aionescu/status/943679990226235393" target="_blank" rel="noreferrer noopener">NtMapViewOfSectionEx</a>, but that’s only available since Windows 10 1803 and it still doesn’t prevent a kernel notification for the mapping.</p>



<pre class="wp-block-code"><code class="hljs php">    NTSTATUS          Status;
    LARGE_INTEGER     SectionOffset;
    SIZE_T            ViewSize;
    PVOID             ViewBase;
    HANDLE            SectionHandle;
    OBJECT_ATTRIBUTES ObjectAttributes;
    UNICODE_STRING    KnownDllsNtDllName;
    FARPROC           <span class="hljs-function"><span class="hljs-keyword">Function</span></span>;
    
    INIT_UNICODE_STRING(
      KnownDllsNtDllName, 
      L<span class="hljs-string">"\\KnownDlls\\ntdll.dll"</span>
      );
    
    InitializeObjectAttributes(
        &amp;ObjectAttributes,
        &amp;KnownDllsNtDllName,
        OBJ_CASE_INSENSITIVE,
        <span class="hljs-number">0</span>,
        <span class="hljs-keyword">NULL</span>
        );

    Status = NtOpenSection(
              &amp;SectionHandle, 
              SECTION_MAP_EXECUTE | SECTION_MAP_READ | SECTION_QUERY, 
              &amp;ObjectAttributes
              );
    
    <span class="hljs-keyword">if</span>(!NT_SUCCESS(Status)) {
      SET_LAST_NT_ERROR(Status);
      printf(<span class="hljs-string">"Unable to open section %ld\n"</span>, GetLastError());
      <span class="hljs-keyword">goto</span> cleanup;
    }
    
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Set the offset to start mapping from.</span>
    <span class="hljs-comment">//</span>
    SectionOffset.LowPart = <span class="hljs-number">0</span>;
    SectionOffset.HighPart = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Set the desired base address and number of bytes to map.</span>
    <span class="hljs-comment">//</span>
    ViewSize = <span class="hljs-number">0</span>;
    ViewBase = <span class="hljs-keyword">NULL</span>;
    
    Status = NtMapViewOfSection(
              SectionHandle,
              NtCurrentProcess(),
              &amp;ViewBase,
              <span class="hljs-number">0</span>,              <span class="hljs-comment">// ZeroBits</span>
              <span class="hljs-number">0</span>,              <span class="hljs-comment">// CommitSize</span>
              &amp;SectionOffset,
              &amp;ViewSize,
              ViewShare,
              <span class="hljs-number">0</span>,
              PAGE_EXECUTE_READ
              );
              
    <span class="hljs-keyword">if</span>(!NT_SUCCESS(Status)) {
      SET_LAST_NT_ERROR(Status);
      printf(<span class="hljs-string">"Unable to map section %ld\n"</span>, GetLastError());
      <span class="hljs-keyword">goto</span> cleanup;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">Function</span> = <span class="hljs-params">(FARPROC)</span><span class="hljs-title">GetProcAddressFromEAT</span><span class="hljs-params">(ViewBase, <span class="hljs-string">"NtOpenProcess"</span>)</span></span>;
    
    printf(<span class="hljs-string">"NtOpenProcess : %p, %ld\n"</span>, <span class="hljs-function"><span class="hljs-keyword">Function</span>, <span class="hljs-title">GetLastError</span><span class="hljs-params">()</span>)</span>;
    
cleanup:
    <span class="hljs-keyword">if</span>(ViewBase != <span class="hljs-keyword">NULL</span>) {
      NtUnmapViewOfSection(
        NtCurrentProcess(), 
        ViewBase
        );
    }
    
    <span class="hljs-keyword">if</span>(SectionHandle != <span class="hljs-keyword">NULL</span>) {
      NtClose(SectionHandle);
    }
</code></pre>



<h3 class="wp-block-heading">3. Dual-load 2 (Disk)</h3>



<p>The only additional step when compared to the previous method is that we open a file handle to <code>C:\Windows\System32\NTDLL.dll</code> and use it to create a new section object with the <code>SEC_IMAGE</code> page protection. Then we map the object for reading or executing.&nbsp;<a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntopenfile" rel="noreferrer noopener" target="_blank">NtOpenFile</a>,&nbsp;<a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntcreatefile" rel="noreferrer noopener" target="_blank">NtCreateFile</a>&nbsp;can be hooked, but even if they aren’t, this doesn’t solve the problems highlighted in the previous method.</p>



<pre class="wp-block-code"><code class="hljs php">    NTSTATUS          Status;
    LARGE_INTEGER     SectionOffset;
    SIZE_T            ViewSize;
    PVOID             ViewBase=<span class="hljs-keyword">NULL</span>;
    HANDLE            FileHandle=<span class="hljs-keyword">NULL</span>, SectionHandle=<span class="hljs-keyword">NULL</span>;
    OBJECT_ATTRIBUTES ObjectAttributes;
    IO_STATUS_BLOCK   StatusBlock;
    UNICODE_STRING    FileName;
    FARPROC           <span class="hljs-function"><span class="hljs-keyword">Function</span></span>;
    
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Try open ntdll.dll on disk for reading.</span>
    <span class="hljs-comment">//</span>
    INIT_UNICODE_STRING(
      FileName, 
      L<span class="hljs-string">"\\??\\C:\\Windows\\System32\\ntdll.dll"</span>
      );
    
    InitializeObjectAttributes(
        &amp;ObjectAttributes,
        &amp;FileName,
        OBJ_CASE_INSENSITIVE,
        <span class="hljs-number">0</span>,
        <span class="hljs-keyword">NULL</span>
        );

    Status = NtOpenFile(
              &amp;FileHandle, 
              FILE_READ_DATA, 
              &amp;ObjectAttributes,
              &amp;StatusBlock, 
              FILE_SHARE_READ, 
              <span class="hljs-keyword">NULL</span>
              );
    
    <span class="hljs-keyword">if</span>(!NT_SUCCESS(Status)) {
      SET_LAST_NT_ERROR(Status);
      printf(<span class="hljs-string">"NtOpenFile failed %ld\n"</span>, GetLastError());
      <span class="hljs-keyword">goto</span> cleanup;
    }
    
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Create section</span>
    <span class="hljs-comment">//</span>
    Status = NtCreateSection(
              &amp;SectionHandle, 
              SECTION_ALL_ACCESS, 
              <span class="hljs-keyword">NULL</span>, 
              <span class="hljs-keyword">NULL</span>, 
              PAGE_READONLY, 
              SEC_IMAGE, 
              FileHandle
              );

    <span class="hljs-keyword">if</span>(!NT_SUCCESS(Status)) {
      SET_LAST_NT_ERROR(Status);
      printf(<span class="hljs-string">"NtCreateSection failed %ld\n"</span>, GetLastError());
      <span class="hljs-keyword">goto</span> cleanup;
    }
    
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Set the offset to start mapping from.</span>
    <span class="hljs-comment">//</span>
    SectionOffset.LowPart = <span class="hljs-number">0</span>;
    SectionOffset.HighPart = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Set the desired base address and number of bytes to map.</span>
    <span class="hljs-comment">//</span>
    ViewSize = <span class="hljs-number">0</span>;
    ViewBase = <span class="hljs-keyword">NULL</span>;
    
    Status = NtMapViewOfSection(
              SectionHandle,
              NtCurrentProcess(),
              &amp;ViewBase,
              <span class="hljs-number">0</span>,              <span class="hljs-comment">// ZeroBits</span>
              <span class="hljs-number">0</span>,              <span class="hljs-comment">// CommitSize</span>
              &amp;SectionOffset,
              &amp;ViewSize,
              ViewShare,
              <span class="hljs-number">0</span>,
              PAGE_EXECUTE_READ
              );
              
    <span class="hljs-keyword">if</span>(!NT_SUCCESS(Status)) {
      SET_LAST_NT_ERROR(Status);
      printf(<span class="hljs-string">"Unable to map section %ld\n"</span>, GetLastError());
      <span class="hljs-keyword">goto</span> cleanup;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">Function</span> = <span class="hljs-params">(FARPROC)</span><span class="hljs-title">GetProcAddressFromEAT</span><span class="hljs-params">(ViewBase, <span class="hljs-string">"NtOpenProcess"</span>)</span></span>;
    
    printf(<span class="hljs-string">"NtOpenProcess : %p, %ld\n"</span>, <span class="hljs-function"><span class="hljs-keyword">Function</span>, <span class="hljs-title">GetLastError</span><span class="hljs-params">()</span>)</span>;
    
cleanup:
    <span class="hljs-keyword">if</span>(ViewBase != <span class="hljs-keyword">NULL</span>) {
      NtUnmapViewOfSection(
        NtCurrentProcess(), 
        ViewBase
        );
    }
    
    <span class="hljs-keyword">if</span>(SectionHandle != <span class="hljs-keyword">NULL</span>) {
      NtClose(SectionHandle);
    }    
    
    <span class="hljs-keyword">if</span>(FileHandle != <span class="hljs-keyword">NULL</span>) {
      NtClose(FileHandle);
    }
</code></pre>



<h3 class="wp-block-heading">4. Extracting SSN Code Stub (Disk)</h3>



<p>Open a file handle to <code>C:\Windows\System32\NTDLL.dll</code>. Create and map a section object with <code>SEC_COMMIT</code> and <code>PAGE_READONLY</code> page protection. (to try bypass any hooks and notifications). The system call that attacker needs is then resolved by parsing of the PE header and copying the call stub to executable memory. One could also use it to overwrite any potential hooks in the existing copy of NTDLL, but that will require using <code>NtProtectVirtualMemory</code>, which may already be hooked. Most system calls are usually no more than 32 bytes, but if the length of stub is required, 64-bit PE files support an exception directory which can be used to calculate it. <code>NtOpenFile</code>, <code>NtCreateFile</code>,&nbsp;<a href="https://docs.microsoft.com/en-us/windows/win32/devnotes/ntreadfile" rel="noreferrer noopener" target="_blank">NtReadFile</a>&nbsp;might be hooked and reading <code>NTDLL.dll</code> from disk will look suspicious.</p>



<pre class="wp-block-code"><code class="hljs properties"><span class="hljs-attr">static</span>
<span class="hljs-attr">DWORD</span> <span class="hljs-string"></span>
<span class="hljs-attr">WINAPI</span>
<span class="hljs-attr">RvaToOffset(</span>
    <span class="hljs-attr">PIMAGE_NT_HEADERS</span> <span class="hljs-string">NtHeaders, </span>
    <span class="hljs-attr">DWORD</span> <span class="hljs-string">Rva) </span>
<span class="hljs-attr">{</span>
    <span class="hljs-attr">PIMAGE_SECTION_HEADER</span> <span class="hljs-string">SectionHeader;</span>
    <span class="hljs-attr">DWORD</span>                 <span class="hljs-string">i, Size;</span>
    
    <span class="hljs-meta">if(Rva</span> =<span class="hljs-string">= 0) return 0;</span>
    
    <span class="hljs-attr">SectionHeader</span> = <span class="hljs-string">IMAGE_FIRST_SECTION(NtHeaders);</span>
    
    <span class="hljs-meta">for(i</span> = <span class="hljs-string">0; i&lt;NUMBER_OF_SECTIONS(NtHeaders); i++) {</span>
      
      <span class="hljs-attr">Size</span> = <span class="hljs-string">SectionHeader[i].Misc.VirtualSize ?</span>
             <span class="hljs-meta">SectionHeader[i].Misc.VirtualSize</span> : <span class="hljs-string">SectionHeader[i].SizeOfRawData;</span>
               
      <span class="hljs-meta">if(SectionHeader[i].VirtualAddress</span> <span class="hljs-string">&lt;= Rva &amp;&amp;</span>
        <span class="hljs-attr">Rva</span> <span class="hljs-string">&lt;= (DWORD)SectionHeader[i].VirtualAddress + SectionHeader[i].SizeOfRawData)</span>
      <span class="hljs-attr">{</span>
        <span class="hljs-meta">if(Rva</span> <span class="hljs-string">&gt;= SectionHeader[i].VirtualAddress &amp;&amp;</span>
           <span class="hljs-attr">Rva</span> <span class="hljs-string">&lt;  SectionHeader[i].VirtualAddress + Size) {</span>
          
          <span class="hljs-attr">return</span> <span class="hljs-string">SectionHeader[i].PointerToRawData + (Rva - SectionHeader[i].VirtualAddress);</span>
        <span class="hljs-attr">}</span>
      <span class="hljs-attr">}</span>
    <span class="hljs-attr">}</span>
    <span class="hljs-attr">return</span> <span class="hljs-string">0;</span>
<span class="hljs-attr">}</span>

<span class="hljs-attr">static</span>
<span class="hljs-attr">PVOID</span>
<span class="hljs-attr">WINAPI</span>
<span class="hljs-attr">GetProcAddressFromMappedDLL(</span>
    <span class="hljs-attr">PVOID</span> <span class="hljs-string">DllBase, </span>
    <span class="hljs-attr">const</span> <span class="hljs-string">char *FunctionName) </span>
<span class="hljs-attr">{</span>
    <span class="hljs-attr">PIMAGE_DOS_HEADER</span>       <span class="hljs-string">DosHeader;</span>
    <span class="hljs-attr">PIMAGE_NT_HEADERS</span>       <span class="hljs-string">NtHeaders;</span>
    <span class="hljs-attr">PIMAGE_SECTION_HEADER</span>   <span class="hljs-string">SectionHeader;</span>
    <span class="hljs-attr">PIMAGE_DATA_DIRECTORY</span>   <span class="hljs-string">DataDirectory;</span>
    <span class="hljs-attr">PIMAGE_EXPORT_DIRECTORY</span> <span class="hljs-string">ExportDirectory;</span>
    <span class="hljs-attr">DWORD</span>                   <span class="hljs-string">Rva, Offset, NumberOfNames;</span>
    <span class="hljs-attr">PCHAR</span>                   <span class="hljs-string">Name;</span>
    <span class="hljs-attr">PDWORD</span>                  <span class="hljs-string">Functions, Names;</span>
    <span class="hljs-attr">PWORD</span>                   <span class="hljs-string">Ordinals;</span>
    
    <span class="hljs-attr">DosHeader</span> = <span class="hljs-string">(PIMAGE_DOS_HEADER)DllBase;</span>
    <span class="hljs-attr">NtHeaders</span>  = <span class="hljs-string">(PIMAGE_NT_HEADERS)((PBYTE)DllBase + DosHeader-&gt;e_lfanew);</span>
    <span class="hljs-attr">DataDirectory</span> = <span class="hljs-string">(PIMAGE_DATA_DIRECTORY)NtHeaders-&gt;OptionalHeader.DataDirectory;</span>
    
    <span class="hljs-attr">Rva</span> = <span class="hljs-string">DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress;</span>
    <span class="hljs-attr">Offset</span> = <span class="hljs-string">RvaToOffset(NtHeaders, Rva);</span>

    <span class="hljs-attr">ExportDirectory</span> = <span class="hljs-string">(PIMAGE_EXPORT_DIRECTORY)((PBYTE)DllBase + Offset);</span>
    <span class="hljs-attr">NumberOfNames</span> = <span class="hljs-string">ExportDirectory-&gt;NumberOfNames;</span>

    <span class="hljs-attr">Offset</span> = <span class="hljs-string">RvaToOffset(NtHeaders, ExportDirectory-&gt;AddressOfNames);        </span>
    <span class="hljs-attr">Names</span> = <span class="hljs-string">(PDWORD)((PBYTE)DllBase + Offset);</span>

    <span class="hljs-attr">Offset</span> = <span class="hljs-string">RvaToOffset(NtHeaders, ExportDirectory-&gt;AddressOfFunctions);        </span>
    <span class="hljs-attr">Functions</span> = <span class="hljs-string">(PDWORD)((PBYTE)DllBase + Offset);</span>
    
    <span class="hljs-attr">Offset</span> = <span class="hljs-string">RvaToOffset(NtHeaders, ExportDirectory-&gt;AddressOfNameOrdinals);</span>
    <span class="hljs-attr">Ordinals</span> = <span class="hljs-string">(PWORD)((PBYTE)DllBase + Offset);</span>
    
    <span class="hljs-attr">do</span> <span class="hljs-string">{</span>
      <span class="hljs-attr">Name</span> = <span class="hljs-string">(PCHAR)(RvaToOffset(NtHeaders, Names[NumberOfNames - 1]) + (PBYTE)DllBase);</span>

      <span class="hljs-meta">if(lstrcmpA(Name,</span> <span class="hljs-string">FunctionName) == 0) {</span>

        <span class="hljs-attr">return</span> <span class="hljs-string">(PVOID)((PBYTE)DllBase + RvaToOffset(NtHeaders, Functions[Ordinals[NumberOfNames - 1]]));</span>
      <span class="hljs-attr">}</span>
    <span class="hljs-meta">}</span> <span class="hljs-string">while (--NumberOfNames);</span>
    
    <span class="hljs-attr">return</span> <span class="hljs-string">NULL;</span>
<span class="hljs-attr">}</span>
</code></pre>



<h3 class="wp-block-heading">5. Extracting SSN (Disk)</h3>



<p>It’s the exact same as the previous method described, except we only extract the System Service Number (SSN) and manually execute it with a code stub of our own.&nbsp;<a href="https://github.com/hfiref0x/SyscallTables" rel="noreferrer noopener" target="_blank">SyscallTables</a>&nbsp;demonstrates dumping the numbers, while&nbsp;<a href="https://github.com/am0nsec/HellsGate" rel="noreferrer noopener" target="_blank">Hell’s Gate</a> demonstrates using them.</p>



<h3 class="wp-block-heading">6. FireWalker</h3>



<p><a href="https://www.mdsec.co.uk/2020/08/firewalker-a-new-approach-to-generically-bypass-user-space-edr-hooking/" rel="noreferrer noopener" target="_blank">FireWalker: A New Approach to Generically Bypass User-Space EDR Hooking</a>&nbsp;works by installing a Vectored Exception Handler and setting the CPU trap flag to single-step through a Win32 API or system call. The exception handler then attempts to locate the original system call stub. Another approach to this is using a disassembler and separate routines to build a call graph of the system call. Windows has a builtin disassembler that can be used to calculate the length of an instruction. The downside is that it doesn’t provide a binary view of an opcode, so the&nbsp;<a href="https://github.com/zyantific/zydis" rel="noreferrer noopener" target="_blank">Zydis</a>&nbsp;disassembler library may be a better option. Internally, the debugger engine for windows has support for building a call graph of a function (to support the uf command in WinDbg), but unfortunately there’s no API exposed to developers.&nbsp;</p>



<h3 class="wp-block-heading">7. SysWhispers</h3>



<p><a href="https://github.com/jthuraisamy/SysWhispers" rel="noreferrer noopener" target="_blank">SysWhispers</a>&nbsp;contains a Python script that will construct a code stub for system calls to run on AMD64/x64 systems. The stub is compatible with Windows between XP/2003 and 10/2019. The generator uses SSNs taken from&nbsp;<a href="https://j00ru.vexillium.org/syscalls/nt/64/" rel="noreferrer noopener" target="_blank">a list</a>&nbsp;maintained by&nbsp;<a href="https://twitter.com/j00ru" rel="noreferrer noopener" target="_blank">j00ru</a>. And the correct SSN is selected at runtime based on the version of the operating system that’s detected via the PEB. In more recent versions of Windows, there’s also the option of using&nbsp;<a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/structs/kuser_shared_data/index.htm" rel="noreferrer noopener" target="_blank">KUSER_SHARED_DATA</a>&nbsp;to read the&nbsp;<a href="https://gist.github.com/slaeryan/2c73c4c4e33dfd7d8ce38312aacc9324" rel="noreferrer noopener" target="_blank">major, minor and build version</a>. SysWhispers is currently popular among red teamers for bypassing AV and EDR. The following is an example code stub generated for <code>NtOpenProcess</code>:</p>



<pre class="wp-block-code"><code class="hljs properties"><span class="hljs-attr">NtOpenProcess</span>:<span class="hljs-string"></span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">rax, [gs:60h]                       ; Load PEB into RAX.</span>
<span class="hljs-attr">NtOpenProcess_Check_X_X_XXXX</span>:               <span class="hljs-string">; Check major version.</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">dword [rax+118h], 5</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_5_X_XXXX</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">dword [rax+118h], 6</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_Check_6_X_XXXX</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">dword [rax+118h], 10</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_Check_10_0_XXXX</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_SystemCall_Unknown</span>
<span class="hljs-attr">NtOpenProcess_Check_6_X_XXXX</span>:               <span class="hljs-string">; Check minor version for Windows Vista/7/8.</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">dword [rax+11ch], 0</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_Check_6_0_XXXX</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">dword [rax+11ch], 1</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_Check_6_1_XXXX</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">dword [rax+11ch], 2</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_6_2_XXXX</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">dword [rax+11ch], 3</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_6_3_XXXX</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_SystemCall_Unknown</span>
<span class="hljs-attr">NtOpenProcess_Check_6_0_XXXX</span>:               <span class="hljs-string">; Check build number for Windows Vista.</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 6000</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_6_0_6000</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 6001</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_6_0_6001</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 6002</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_6_0_6002</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_SystemCall_Unknown</span>
<span class="hljs-attr">NtOpenProcess_Check_6_1_XXXX</span>:               <span class="hljs-string">; Check build number for Windows 7.</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 7600</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_6_1_7600</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 7601</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_6_1_7601</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_SystemCall_Unknown</span>
<span class="hljs-attr">NtOpenProcess_Check_10_0_XXXX</span>:              <span class="hljs-string">; Check build number for Windows 10.</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 10240</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_10_0_10240</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 10586</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_10_0_10586</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 14393</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_10_0_14393</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 15063</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_10_0_15063</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 16299</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_10_0_16299</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 17134</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_10_0_17134</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 17763</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_10_0_17763</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 18362</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_10_0_18362</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 18363</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_10_0_18363</span>
	<span class="hljs-attr">cmp</span> <span class="hljs-string">word [rax+120h], 19041</span>
	<span class="hljs-attr">je</span>  <span class="hljs-string">NtOpenProcess_SystemCall_10_0_19041</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_SystemCall_Unknown</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_5_X_XXXX</span>:          <span class="hljs-string">; Windows XP and Server 2003</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0023h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_6_0_6000</span>:          <span class="hljs-string">; Windows Vista SP0</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0023h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_6_0_6001</span>:          <span class="hljs-string">; Windows Vista SP1 and Server 2008 SP0</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0023h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_6_0_6002</span>:          <span class="hljs-string">; Windows Vista SP2 and Server 2008 SP2</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0023h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_6_1_7600</span>:          <span class="hljs-string">; Windows 7 SP0</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0023h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_6_1_7601</span>:          <span class="hljs-string">; Windows 7 SP1 and Server 2008 R2 SP0</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0023h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_6_2_XXXX</span>:          <span class="hljs-string">; Windows 8 and Server 2012</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0024h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_6_3_XXXX</span>:          <span class="hljs-string">; Windows 8.1 and Server 2012 R2</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0025h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_10_0_10240</span>:        <span class="hljs-string">; Windows 10.0.10240 (1507)</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0026h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_10_0_10586</span>:        <span class="hljs-string">; Windows 10.0.10586 (1511)</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0026h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_10_0_14393</span>:        <span class="hljs-string">; Windows 10.0.14393 (1607)</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0026h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_10_0_15063</span>:        <span class="hljs-string">; Windows 10.0.15063 (1703)</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0026h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_10_0_16299</span>:        <span class="hljs-string">; Windows 10.0.16299 (1709)</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0026h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_10_0_17134</span>:        <span class="hljs-string">; Windows 10.0.17134 (1803)</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0026h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_10_0_17763</span>:        <span class="hljs-string">; Windows 10.0.17763 (1809)</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0026h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_10_0_18362</span>:        <span class="hljs-string">; Windows 10.0.18362 (1903)</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0026h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_10_0_18363</span>:        <span class="hljs-string">; Windows 10.0.18363 (1909)</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0026h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_10_0_19041</span>:        <span class="hljs-string">; Windows 10.0.19041 (2004)</span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">eax, 0026h</span>
	<span class="hljs-attr">jmp</span> <span class="hljs-string">NtOpenProcess_Epilogue</span>
<span class="hljs-attr">NtOpenProcess_SystemCall_Unknown</span>:           <span class="hljs-string">; Unknown/unsupported version.</span>
	<span class="hljs-attr">ret</span>
<span class="hljs-attr">NtOpenProcess_Epilogue</span>:<span class="hljs-string"></span>
	<span class="hljs-attr">mov</span> <span class="hljs-string">r10, rcx</span>
	<span class="hljs-attr">syscall</span>
	<span class="hljs-attr">ret</span>
</code></pre>



<h3 class="wp-block-heading">8. Sorting by System Call Address</h3>



<p>There’s a method of discovering SSNs that doesn’t require loading a new copy of NTDLL, doesn’t require unhooking, doesn’t require querying the PEB or <code>KUSER_SHARED_DATA</code> for version information, and doesn’t require reading them from code stubs manually. Moreover, it’s relatively simple to implement and should work successfully on all versions of Windows. Admittedly, it’s based on an&nbsp;<a href="https://blog.vincss.net/2020/03/re011-unpack-crypter-cua-malware-netwire-bang-x64dbg.html" rel="noreferrer noopener" target="_blank">unhooking technique</a>&nbsp;used in some ransomware that was first suggested by userman01 on discord. His comment was:</p>



<p><em>“An easy way to get syscall indices, even if AV overwrites them, … simply enumerate all Zw* stubs and then sort them by address.”</em></p>



<p>Sounds perfect! <code>GetSyscallList()</code> will parse the EAT of <code>NTDLL.dll</code>, locating all function names that begin with “Zw”. It replaces “Zw” with “Nt” before generating a hash of the function name. It then saves the hash and address of code stub to a table of <code>SYSCALL_ENTRY</code> structures. After gathering all the names, it uses a simple bubble sort of code addresses in ascending order. The SSN is the index of the system call stored in the table.&nbsp;</p>



<pre class="wp-block-code"><code class="hljs php"><span class="hljs-comment">#define RVA2VA(Type, DllBase, Rva) (Type)((ULONG_PTR) DllBase + Rva)</span>

<span class="hljs-keyword">static</span>
void
GetSyscallList(PSYSCALL_LIST <span class="hljs-keyword">List</span>) {
    PPEB_LDR_DATA           Ldr;
    PLDR_DATA_TABLE_ENTRY   LdrEntry;
    PIMAGE_DOS_HEADER       DosHeader;
    PIMAGE_NT_HEADERS       NtHeaders;
    DWORD                   i, j, NumberOfNames, VirtualAddress, Entries=<span class="hljs-number">0</span>;
    PIMAGE_DATA_DIRECTORY   DataDirectory;
    PIMAGE_EXPORT_DIRECTORY ExportDirectory;
    PDWORD                  Functions;
    PDWORD                  Names;
    PWORD                   Ordinals;
    PCHAR                   DllName, FunctionName;
    PVOID                   DllBase;
    PSYSCALL_ENTRY          Table;
    SYSCALL_ENTRY           Entry;
    
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Get the DllBase address of NTDLL.dll</span>
    <span class="hljs-comment">// NTDLL is not guaranteed to be the second in the list.</span>
    <span class="hljs-comment">// so it's safer to loop through the full list and find it.   </span>
    Ldr = (PPEB_LDR_DATA)NtCurrentTeb()-&gt;ProcessEnvironmentBlock-&gt;Ldr;
    
    <span class="hljs-comment">// For each DLL loaded</span>
    <span class="hljs-keyword">for</span> (LdrEntry=(PLDR_DATA_TABLE_ENTRY)Ldr-&gt;Reserved2[<span class="hljs-number">1</span>];
         LdrEntry-&gt;DllBase != <span class="hljs-keyword">NULL</span>; 
         LdrEntry=(PLDR_DATA_TABLE_ENTRY)LdrEntry-&gt;Reserved1[<span class="hljs-number">0</span>])
    {
      DllBase = LdrEntry-&gt;DllBase;
      DosHeader = (PIMAGE_DOS_HEADER)DllBase;
      NtHeaders = RVA2VA(PIMAGE_NT_HEADERS, DllBase, DosHeader-&gt;e_lfanew);
      DataDirectory = (PIMAGE_DATA_DIRECTORY)NtHeaders-&gt;OptionalHeader.DataDirectory;
      VirtualAddress = DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress;
      <span class="hljs-keyword">if</span>(VirtualAddress == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
      
      ExportDirectory = (PIMAGE_EXPORT_DIRECTORY) RVA2VA(ULONG_PTR, DllBase, VirtualAddress);
      
      <span class="hljs-comment">//</span>
      <span class="hljs-comment">// If this is NTDLL.dll, exit loop</span>
      <span class="hljs-comment">//</span>
      DllName = RVA2VA(PCHAR,DllBase, ExportDirectory-&gt;Name);

      <span class="hljs-keyword">if</span>((*(ULONG*)DllName | <span class="hljs-number">0x20202020</span>) != <span class="hljs-string">'ldtn'</span>) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">if</span>((*(ULONG*)(DllName + <span class="hljs-number">4</span>) | <span class="hljs-number">0x20202020</span>) == <span class="hljs-string">'ld.l'</span>) <span class="hljs-keyword">break</span>;
    }
    
    NumberOfNames = ExportDirectory-&gt;NumberOfNames;
    
    Functions = RVA2VA(PDWORD,DllBase, ExportDirectory-&gt;AddressOfFunctions);
    Names     = RVA2VA(PDWORD,DllBase, ExportDirectory-&gt;AddressOfNames);
    Ordinals  = RVA2VA(PWORD, DllBase, ExportDirectory-&gt;AddressOfNameOrdinals);
    
    Table     = <span class="hljs-keyword">List</span>-&gt;Table;
    
    <span class="hljs-keyword">do</span> {
      FunctionName = RVA2VA(PCHAR, DllBase, Names[NumberOfNames<span class="hljs-number">-1</span>]);
      <span class="hljs-comment">//</span>
      <span class="hljs-comment">// Is this a system call?</span>
      <span class="hljs-comment">//</span>
      <span class="hljs-keyword">if</span>(*(USHORT*)FunctionName == <span class="hljs-string">'wZ'</span>) {
        <span class="hljs-comment">//</span>
        <span class="hljs-comment">// Save Hash of system call and the address.</span>
        <span class="hljs-comment">//</span>
        Table[Entries].Hash = HashSyscall(<span class="hljs-number">0x4e000074</span>, &amp;FunctionName[<span class="hljs-number">2</span>]);
        Table[Entries].Address = Functions[Ordinals[NumberOfNames<span class="hljs-number">-1</span>]];
        
        Entries++;
        <span class="hljs-keyword">if</span>(Entries == MAX_SYSCALLS) <span class="hljs-keyword">break</span>;
      }
    } <span class="hljs-keyword">while</span> (--NumberOfNames);
    
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Save total number of system calls found.</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-keyword">List</span>-&gt;Entries = Entries;
    
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Sort the list by address in ascending order.</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;Entries - <span class="hljs-number">1</span>; i++) {
      <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;Entries - i - <span class="hljs-number">1</span>; j++) {
        <span class="hljs-keyword">if</span>(Table[j].Address &gt; Table[j+<span class="hljs-number">1</span>].Address) {
          <span class="hljs-comment">//</span>
          <span class="hljs-comment">// Swap entries.</span>
          <span class="hljs-comment">//</span>
          Entry.Hash = Table[j].Hash;
          Entry.Address = Table[j].Address;
          
          Table[j].Hash = Table[j+<span class="hljs-number">1</span>].Hash;
          Table[j].Address = Table[j+<span class="hljs-number">1</span>].Address;
          
          Table[j+<span class="hljs-number">1</span>].Hash = Entry.Hash;
          Table[j+<span class="hljs-number">1</span>].Address = Entry.Address;
        }
      }
    }
}
</code></pre>



<p>Just to demonstrate how it might work in amd64/x64 assembly, the following is based on the above code:</p>



<pre class="wp-block-code"><code class="hljs properties">      <span class="hljs-meta">;</span> <span class="hljs-string">*************************************************</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">Gather a list of system calls by parsing the</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">export address table of NTDLL.dll</span>
      <span class="hljs-attr">;</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">Generate a hash of the syscall name and save</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">the relative virtual address to a table.</span>
      <span class="hljs-attr">;</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">Sort table entries by virtual address in ascending order.</span>
      <span class="hljs-attr">;</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">**************************************************</span>
      
<span class="hljs-meta">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%ifndef</span> <span class="hljs-string">BIN</span>
        <span class="hljs-attr">global</span> <span class="hljs-string">GetSyscallList_amd64</span>
<span class="hljs-attr">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%endif</span>
      
<span class="hljs-attr">GetSyscallList_amd64</span>:<span class="hljs-string"></span>
      <span class="hljs-meta">;</span> <span class="hljs-string">save non-volatile registers</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">rcx points to SYSCALL_LIST.</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">it's saved last.</span>
      <span class="hljs-attr">pushx</span>   <span class="hljs-string">rsi, rbx, rdi, rbp, rcx</span>
      
      <span class="hljs-attr">push</span>    <span class="hljs-string">TEB.ProcessEnvironmentBlock</span>
      <span class="hljs-attr">pop</span>     <span class="hljs-string">r11</span>
      <span class="hljs-attr">mov</span>     <span class="hljs-string">rax, [gs:r11]</span>
      <span class="hljs-attr">mov</span>     <span class="hljs-string">rax, [rax+PEB.Ldr]</span>
      <span class="hljs-attr">mov</span>     <span class="hljs-string">rdi, [rax+PEB_LDR_DATA.InLoadOrderModuleList + LIST_ENTRY.Flink]</span>
      <span class="hljs-attr">jmp</span>     <span class="hljs-string">scan_dll</span>
      
      <span class="hljs-attr">;</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">Because NTDLL.dll is not guaranteed to be second in the list of DLLs,</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">we search until a match is found.</span>
      <span class="hljs-attr">;</span>
<span class="hljs-attr">next_dll</span>:    <span class="hljs-string"></span>
      <span class="hljs-attr">mov</span>     <span class="hljs-string">rdi, [rdi+LDR_DATA_TABLE_ENTRY.InLoadOrderLinks + LIST_ENTRY.Flink]</span>
<span class="hljs-attr">scan_dll</span>:<span class="hljs-string"></span>
      <span class="hljs-attr">mov</span>     <span class="hljs-string">rbx, [rdi+LDR_DATA_TABLE_ENTRY.DllBase]</span>
      <span class="hljs-meta">;</span>       <span class="hljs-string"></span>
      <span class="hljs-attr">mov</span>     <span class="hljs-string">esi, [rbx+IMAGE_DOS_HEADER.e_lfanew]</span>
      <span class="hljs-attr">add</span>     <span class="hljs-string">esi, r11d             ; add 60h or TEB.ProcessEnvironmentBlock</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">ecx = IMAGE_DATA_DIRECTORY[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress</span>
      <span class="hljs-attr">mov</span>     <span class="hljs-string">ecx, [rbx+rsi+IMAGE_NT_HEADERS.OptionalHeader + \
                           IMAGE_OPTIONAL_HEADER.DataDirectory + \
                           IMAGE_DIRECTORY_ENTRY_EXPORT * IMAGE_DATA_DIRECTORY_size + \
                           IMAGE_DATA_DIRECTORY.VirtualAddress - \
                           TEB.ProcessEnvironmentBlock]</span>
      <span class="hljs-attr">jecxz</span>   <span class="hljs-string">next_dll ; if no exports, try next module in the list</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">rsi = offset IMAGE_EXPORT_DIRECTORY.Name </span>
      <span class="hljs-attr">lea</span>     <span class="hljs-string">rsi, [rbx+rcx+IMAGE_EXPORT_DIRECTORY.Name]</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">NTDLL?</span>
      <span class="hljs-attr">lodsd</span>
      <span class="hljs-attr">xchg</span>    <span class="hljs-string">eax, esi</span>
      <span class="hljs-attr">add</span>     <span class="hljs-string">rsi, rbx</span>
      
      <span class="hljs-attr">;</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">Convert to lowercase by setting bit 5 of each byte.</span>
      <span class="hljs-attr">;</span>
      <span class="hljs-attr">lodsd</span>
      <span class="hljs-attr">or</span>      <span class="hljs-string">eax, 0x20202020</span>
      <span class="hljs-attr">cmp</span>     <span class="hljs-string">eax, 'ntdl'</span>
      <span class="hljs-attr">jnz</span>     <span class="hljs-string">next_dll</span>

      <span class="hljs-attr">lodsd</span>
      <span class="hljs-attr">or</span>      <span class="hljs-string">eax, 0x20202020</span>
      <span class="hljs-attr">cmp</span>     <span class="hljs-string">eax, 'l.dl'</span>
      <span class="hljs-attr">jnz</span>     <span class="hljs-string">next_dll</span>
      
      <span class="hljs-attr">;</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">Load address of SYSCALL_LIST.Table</span>
      <span class="hljs-attr">;</span>
      <span class="hljs-attr">pop</span>     <span class="hljs-string">rdi</span>
      <span class="hljs-attr">push</span>    <span class="hljs-string">rdi</span>
      <span class="hljs-attr">scasd</span>           <span class="hljs-string">; skip Entries</span>
      <span class="hljs-attr">push</span>    <span class="hljs-string">0       ; Entries = 0</span>
      
      <span class="hljs-meta">;</span> <span class="hljs-string">rsi = offset IMAGE_EXPORT_DIRECTORY.Name </span>
      <span class="hljs-attr">lea</span>     <span class="hljs-string">rsi, [rbx+rcx+IMAGE_EXPORT_DIRECTORY.NumberOfNames]</span>
      <span class="hljs-attr">lodsd</span>                  <span class="hljs-string">; eax = NumberOfNames</span>
      <span class="hljs-attr">xchg</span>    <span class="hljs-string">eax, ecx</span>
 
      <span class="hljs-meta">;</span> <span class="hljs-string">r8 = IMAGE_EXPORT_DIRECTORY.AddressOfFunctions</span>
      <span class="hljs-attr">lodsd</span>
      <span class="hljs-attr">xchg</span>    <span class="hljs-string">eax, r8d       </span>
      <span class="hljs-attr">add</span>     <span class="hljs-string">r8, rbx        ; r8 = RVA2VA(r8, rbx)</span>
      
      <span class="hljs-meta">;</span> <span class="hljs-string">rbp = IMAGE_EXPORT_DIRECTORY.AddressOfNames</span>
      <span class="hljs-attr">lodsd</span>
      <span class="hljs-attr">xchg</span>    <span class="hljs-string">eax, ebp       </span>
      <span class="hljs-attr">add</span>     <span class="hljs-string">rbp, rbx       ; rbp = RVA2VA(rbp, rbx)</span>
      
      <span class="hljs-meta">;</span> <span class="hljs-string">r9 = IMAGE_EXPORT_DIRECTORY.AddressOfNameOrdinals      </span>
      <span class="hljs-attr">lodsd</span>
      <span class="hljs-attr">xchg</span>    <span class="hljs-string">eax, r9d</span>
      <span class="hljs-attr">add</span>     <span class="hljs-string">r9, rbx        ; r9 = RVA2VA(r9, rbx)</span>
<span class="hljs-attr">find_syscall</span>:<span class="hljs-string"></span>
      <span class="hljs-attr">mov</span>     <span class="hljs-string">esi, [rbp+rcx*4-4]    ; rsi = AddressOfNames[rcx-1]</span>
      <span class="hljs-attr">add</span>     <span class="hljs-string">rsi, rbx</span>
      <span class="hljs-attr">lodsw</span>
      <span class="hljs-attr">cmp</span>     <span class="hljs-string">ax, 'Zw'       ; system call?</span>
      <span class="hljs-attr">loopne</span>  <span class="hljs-string">find_syscall    </span>
      <span class="hljs-attr">jne</span>     <span class="hljs-string">sort_syscall</span>
      
      <span class="hljs-meta">;</span> <span class="hljs-string">hash the system call name</span>
      <span class="hljs-attr">xor</span>     <span class="hljs-string">eax, eax</span>
      <span class="hljs-attr">mov</span>     <span class="hljs-string">edx, 0x4e000074     ; "Nt"</span>
<span class="hljs-attr">hash_syscall</span>:<span class="hljs-string"></span>
      <span class="hljs-attr">lodsb</span>
      <span class="hljs-attr">test</span>    <span class="hljs-string">al, al</span>
      <span class="hljs-attr">jz</span>      <span class="hljs-string">get_address</span>
      <span class="hljs-attr">ror</span>     <span class="hljs-string">edx, 8</span>
      <span class="hljs-attr">add</span>     <span class="hljs-string">edx, eax</span>
      <span class="hljs-attr">jmp</span>     <span class="hljs-string">hash_syscall</span>
      
<span class="hljs-attr">get_address</span>:<span class="hljs-string"></span>
      <span class="hljs-attr">movzx</span>   <span class="hljs-string">eax, word[r9+rcx*2]  ; eax = AddressOfNameOrdinals[rcx]</span>
      <span class="hljs-attr">mov</span>     <span class="hljs-string">eax, [r8+rax*4]      ; eax = AddressOfFunctions[eax]</span>
      
      <span class="hljs-attr">stosd</span>                        <span class="hljs-string">; save Address</span>
      <span class="hljs-attr">xchg</span>    <span class="hljs-string">eax, edx </span>
      <span class="hljs-attr">stosd</span>                        <span class="hljs-string">; save Hash</span>
      
      <span class="hljs-attr">inc</span>     <span class="hljs-string">dword[rsp]           ; Entries++</span>
      
      <span class="hljs-meta">;</span> <span class="hljs-string">exports remaining?</span>
      <span class="hljs-attr">test</span>    <span class="hljs-string">ecx, ecx</span>
      <span class="hljs-attr">jnz</span>     <span class="hljs-string">find_syscall</span>
     
      <span class="hljs-attr">;</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">Bubble sort.</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">Arranges Table entries by Address in ascending order.</span>
      <span class="hljs-attr">;</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">Based on the 16-byte sort code by Jibz</span>
      <span class="hljs-attr">;</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">https://gist.github.com/jibsen/8afc36995aadb896b649</span>
      <span class="hljs-attr">;</span>
      
<span class="hljs-attr">sort_syscall</span>:<span class="hljs-string"></span>
      <span class="hljs-attr">pop</span>     <span class="hljs-string">rax              ; Entries</span>
      <span class="hljs-attr">pop</span>     <span class="hljs-string">rdi              ; List</span>
      <span class="hljs-attr">stosd</span>                    <span class="hljs-string">; List-&gt;Entries = Entries</span>
      <span class="hljs-attr">lea</span>     <span class="hljs-string">ecx, [eax - 1]   ; ecx = Entries - 1</span>
<span class="hljs-attr">outerloop</span>:<span class="hljs-string"></span>
      <span class="hljs-attr">push</span>    <span class="hljs-string">rcx              ; save rcx for outer loop</span>
      <span class="hljs-attr">push</span>    <span class="hljs-string">rdi              ; rdi = Table</span>
      
      <span class="hljs-attr">push</span>    <span class="hljs-string">rdi              ; rsi = Table</span>
      <span class="hljs-attr">pop</span>     <span class="hljs-string">rsi</span>
<span class="hljs-attr">innerloop</span>:<span class="hljs-string"></span>
      <span class="hljs-attr">lodsq</span>                    <span class="hljs-string">; load Address + Hash</span>
      <span class="hljs-attr">cmp</span>     <span class="hljs-string">eax, [rsi]       ; do we need to swap?</span>
      <span class="hljs-attr">jbe</span>     <span class="hljs-string">order_ok</span>
      <span class="hljs-attr">xchg</span>    <span class="hljs-string">rax, [rsi]       ; if so, this is first step</span>
<span class="hljs-attr">order_ok</span>:<span class="hljs-string"></span>
      <span class="hljs-attr">stosq</span>                    <span class="hljs-string">; second step, or just write back rax</span>
      <span class="hljs-attr">loop</span>    <span class="hljs-string">innerloop</span>
      <span class="hljs-attr">pop</span>     <span class="hljs-string">rdi</span>
      <span class="hljs-attr">pop</span>     <span class="hljs-string">rcx              ; restore number of elements</span>
      <span class="hljs-attr">loop</span>    <span class="hljs-string">outerloop        ; rcx is used for both loops</span>

<span class="hljs-attr">exit_get_list</span>:<span class="hljs-string"></span>
      <span class="hljs-meta">;</span> <span class="hljs-string">restore non-volatile registers</span>
      <span class="hljs-attr">popx</span>   <span class="hljs-string">rsi, rbx, rdi, rbp</span>
      <span class="hljs-attr">ret</span>
</code></pre>



<p>To resolve a system call name to SSN, we can use the following function. Given the hash of a system call name we wish to use, this will search the table for a match and return the SSN. If the system call is not supported by the operating system, this function will simply return FALSE:</p>



<pre class="wp-block-code"><code class="hljs php"><span class="hljs-comment">//</span>
<span class="hljs-comment">// Get the System Service Number from list.</span>
<span class="hljs-comment">//</span>
<span class="hljs-keyword">static</span>
BOOL
GetSSN(PSYSCALL_LIST <span class="hljs-keyword">List</span>, DWORD Hash, PDWORD Ssn) {
    DWORD i;

    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-keyword">List</span>-&gt;Entries; i++) {
      <span class="hljs-keyword">if</span>(Hash == <span class="hljs-keyword">List</span>-&gt;Table[i].Hash) {
        *Ssn = i;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">TRUE</span>;
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">FALSE</span>;
}
</code></pre>



<p>And assembly:</p>



<pre class="wp-block-code"><code class="hljs properties">      <span class="hljs-attr">;</span>
      <span class="hljs-meta">;</span> <span class="hljs-string">Lookup the System Service Number for a hash.</span>
      <span class="hljs-attr">;</span>
<span class="hljs-attr">GetSSN_amd64</span>:<span class="hljs-string"></span>
      <span class="hljs-attr">lea</span>     <span class="hljs-string">r9, [rcx+4]         ; r9 = List-&gt;Table</span>
      <span class="hljs-attr">mov</span>     <span class="hljs-string">ecx, dword[rcx]     ; ecx = List-&gt;Entries </span>
      <span class="hljs-attr">or</span>      <span class="hljs-string">ebx, -1             ; i = -1</span>
<span class="hljs-attr">search_table</span>:<span class="hljs-string"></span>
      <span class="hljs-attr">inc</span>     <span class="hljs-string">ebx                 ; i++</span>
      <span class="hljs-attr">cmp</span>     <span class="hljs-string">edx, [r9+rbx*8+4]   ; our hash?</span>
      <span class="hljs-attr">loopne</span>  <span class="hljs-string">search_table        ; loop until found or no entries left</span>
      <span class="hljs-attr">jne</span>     <span class="hljs-string">exit_search</span>
      <span class="hljs-attr">mov</span>     <span class="hljs-string">dword[r8], ebx      ; if found, save SSN</span>
<span class="hljs-attr">exit_search</span>:<span class="hljs-string"></span>
      <span class="hljs-attr">sete</span>    <span class="hljs-string">al                  ; return TRUE or FALSE</span>
      <span class="hljs-attr">ret</span>
</code></pre>



<p>The code stub used to execute an SSN can be embedded in the <code>.text</code> section of the PoC, but might make more sense moving to an area of memory that won’t be detected as a manual call:</p>



<pre class="wp-block-code"><code class="hljs properties"><span class="hljs-attr">InvokeSsn_amd64</span>:<span class="hljs-string"></span>
      <span class="hljs-attr">pop</span>     <span class="hljs-string">rax            ; return address</span>
      <span class="hljs-attr">pop</span>     <span class="hljs-string">r10</span>
      <span class="hljs-attr">push</span>    <span class="hljs-string">rax            ; save in shadow space as _rcx</span>
      
      <span class="hljs-attr">push</span>    <span class="hljs-string">rcx            ; rax = ssn </span>
      <span class="hljs-attr">pop</span>     <span class="hljs-string">rax</span>
      
      <span class="hljs-attr">push</span>    <span class="hljs-string">rdx            ; rcx = arg1</span>
      <span class="hljs-attr">pop</span>     <span class="hljs-string">r10</span>
      
      <span class="hljs-attr">push</span>    <span class="hljs-string">r8             ; rdx = arg2</span>
      <span class="hljs-attr">pop</span>     <span class="hljs-string">rdx</span>
      
      <span class="hljs-attr">push</span>    <span class="hljs-string">r9             ; r8 = arg3</span>
      <span class="hljs-attr">pop</span>     <span class="hljs-string">r8</span>
                             <span class="hljs-meta">;</span> <span class="hljs-string">r9 = arg4</span>
      <span class="hljs-attr">mov</span>     <span class="hljs-string">r9, [rsp + SHADOW_SPACE_size]</span>
        
      <span class="hljs-attr">syscall</span>
      <span class="hljs-attr">jmp</span>     <span class="hljs-string">qword[rsp+SHADOW_SPACE._rcx]</span>
</code></pre>



<p>The following code demonstrates how to use the above functions to invoke <code>ntdll!NtAllocateVirtualMemory</code>:</p>



<pre class="wp-block-code"><code class="hljs cpp">    SYSCALL_LIST   List;
    DWORD          SsnId, SsnHash;
    InvokeSsn_t    InvokeSsn;
    
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Gather a list of system calls from the Export Address Table.</span>
    <span class="hljs-comment">//</span>
    GetSyscallList(&amp;List);

    {
      <span class="hljs-comment">//</span>
      <span class="hljs-comment">// Test allocating virtual memory</span>
      <span class="hljs-comment">// </span>
      SsnHash = ct_HashSyscall(<span class="hljs-string">"NtAllocateVirtualMemory"</span>);
      <span class="hljs-keyword">if</span>(!GetSSN(&amp;List, SsnHash, &amp;SsnId)) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Unable to find SSN for NtAllocateVirtualMemory : %08lX.\n"</span>, SsnHash);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
      }
                    
      PVOID BaseAddress = <span class="hljs-literal">NULL</span>;
      SIZE_T RegionSize = <span class="hljs-number">4096</span>;
      ULONG flAllocationType = MEM_COMMIT | MEM_RESERVE;
      ULONG flProtect = PAGE_READWRITE;
      NTSTATUS Status;
      
      InvokeSsn = (InvokeSsn_t)&amp;InvokeSsn_stub;

      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Invoking SSN : %ld\n"</span>, SsnId);
          
      Status = InvokeSsn(
                SsnId, 
                NtCurrentProcess(),
                &amp;BaseAddress, 
                <span class="hljs-number">0</span>,
                &amp;RegionSize,
                flAllocationType,
                flProtect
                );
        
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Status : %s (%08lX)\n"</span>, 
        Status == STATUS_SUCCESS ? <span class="hljs-string">"Success"</span> : <span class="hljs-string">"Failed"</span>, Status);
      
      <span class="hljs-keyword">if</span>(BaseAddress != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Releasing memory allocated at %p\n"</span>, BaseAddress);
        VirtualFree(BaseAddress, <span class="hljs-number">0</span>, MEM_RELEASE | MEM_DECOMMIT);
      }
    }
</code></pre>



<p>Shortly after writing code based on the idea suggested by userman01, another project that implements the same idea was discovered&nbsp;<a href="https://github.com/crummie5/FreshyCalls" rel="noreferrer noopener" target="_blank">here</a>.</p>



<h2 class="wp-block-heading">Detecting Manual Invocation</h2>



<p>What can defenders do to protect themselves?</p>



<h3 class="wp-block-heading">Byte Signatures and Emulation</h3>



<p>Unless obfuscated/encrypted, the code stubs inside an image to execute one or more system calls will clearly indicate malicious intent because there’s no legitimate reason for a non-Microsoft application to execute them directly. The only exception would be cirvumventing UM hooks installed by a malicious application. A&nbsp;<a href="https://virustotal.github.io/yara/" rel="noreferrer noopener" target="_blank">YARA</a>&nbsp;signature for the “syscall” instruction or a rule for Fireeye’s&nbsp;<a href="https://github.com/fireeye/capa" rel="noreferrer noopener" target="_blank">CAPA</a>&nbsp;to automate discovery is a good start. Generally, any non-Microsoft application that reads the PEB or <code>KUSER_SHARED_DATA</code> are simple indicators of something malicious being executed. Emulation of code with the&nbsp;<a href="https://github.com/unicorn-engine/unicorn" rel="noreferrer noopener" target="_blank">Unicorn Engine</a>&nbsp;to detect a stub inside obfuscated/encrypted code is also an idea that understandably takes more time and effort to implement.</p>



<h3 class="wp-block-heading">Mitigation Policies</h3>



<p>Microsoft provide&nbsp;<a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/exploit-protection-reference" rel="noreferrer noopener" target="_blank">a range of mitigation policies</a>&nbsp;that can be enforced upon a process to block malicious code from executing. Import and Export Address Filtering are two potential ways that could prevent enumeration of the system call names. There’s also&nbsp;<a href="https://docs.microsoft.com/en-us/windows/win32/api/winnt/ne-winnt-process_mitigation_policy" rel="noreferrer noopener" target="_blank">ProcessSystemCallDisablePolicy</a>&nbsp;to disable Win32k system calls for syscalls in <code>user32.dll</code> or <code>win32u.dll</code>. Another policy that remains undocumented by Microsoft is&nbsp;<strong><code>ProcessSystemCallFilterPolicy</code></strong>.</p>



<h3 class="wp-block-heading">Instrumentation Callback</h3>



<p><a href="https://www.codeproject.com/Articles/543542/Windows-x64-system-service-hooks-and-advanced-debu" rel="noreferrer noopener" target="_blank">Windows x64 system service hooks and advanced debugging</a>&nbsp;describes the&nbsp;<em><a href="http://www.hexacorn.com/blog/2020/04/09/code-injection-everyone-forgets-about/" rel="noreferrer noopener" target="_blank">ProcessInstrumentationCallback</a></em>&nbsp;info class that was also discussed by&nbsp;<a href="https://twitter.com/aionescu" rel="noreferrer noopener" target="_blank">Alex Ionescu</a>&nbsp;at Recon 2015 in his&nbsp;<a href="https://github.com/ionescu007/HookingNirvana" rel="noreferrer noopener" target="_blank">Hooking Nirvana presentation</a>. It allows post-processing of system calls and can be used to detect manual invocation. Defenders could install the callback and after each invocation examine the return address to determine if it originated from within <code>NTDLL.dll</code>, <code>user32.dll</code>, <code>Win32u.dll</code> or some other area of memory system calls shouldn’t exist.</p>



<p><a href="https://github.com/x64dbg/ScyllaHide" rel="noreferrer noopener" target="_blank">ScyllaHide</a>&nbsp;is an Anti-Anti-Debug library that uses this method of detection. However, at the time of writing this, it only checks if the call originated from inside the host image. A simple bypass is to change the return address to a location outside it. As you can see, it’s also possible to manipulate the <code>NTSTATUS</code> value of a system call.</p>



<pre class="wp-block-code"><code class="hljs php">ULONG_PTR
NTAPI
InstrumentationCallback(
    _In_ ULONG_PTR ReturnAddress,
    _Inout_ ULONG_PTR ReturnVal
    )
{
    PVOID ImageBase = NtCurrentPeb()-&gt;ImageBaseAddress;
    PIMAGE_NT_HEADERS NtHeaders = RtlImageNtHeader(ImageBase);
    
    <span class="hljs-comment">// is the return address within the host image?</span>
    <span class="hljs-keyword">if</span> (ReturnAddress &gt;= (ULONG_PTR)ImageBase &amp;&amp;
        ReturnAddress &lt; (ULONG_PTR)ImageBase + NtHeaders-&gt;OptionalHeader.SizeOfImage)
    {
      <span class="hljs-comment">// manual system call detected.</span>
    }
}
</code></pre>



<p>The following code installs the callback:</p>



<pre class="wp-block-code"><code class="hljs yaml">    <span class="hljs-string">//</span> <span class="hljs-string">Windows</span> <span class="hljs-number">7</span><span class="hljs-number">-8.1</span> <span class="hljs-string">require</span> <span class="hljs-string">SE_DEBUG</span> <span class="hljs-string">for</span> <span class="hljs-string">this</span> <span class="hljs-string">to</span> <span class="hljs-string">work,</span> <span class="hljs-string">even</span> <span class="hljs-string">on</span> <span class="hljs-string">the</span> <span class="hljs-string">current</span> <span class="hljs-string">process</span>
    <span class="hljs-string">BOOLEAN</span> <span class="hljs-string">SeDebugWasEnabled;</span>
    <span class="hljs-string">Status</span> <span class="hljs-string">=</span> <span class="hljs-string">RtlAdjustPrivilege(SE_DEBUG_PRIVILEGE,</span> <span class="hljs-literal">TRUE</span><span class="hljs-string">,</span> <span class="hljs-literal">FALSE</span><span class="hljs-string">,</span> <span class="hljs-string">&amp;SeDebugWasEnabled);</span>

    <span class="hljs-string">PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION</span> <span class="hljs-string">InstrumentationCallbackInfo;</span>

    <span class="hljs-string">InstrumentationCallbackInfo.Version</span>  <span class="hljs-string">=</span> <span class="hljs-number">0</span><span class="hljs-string">;</span>
    <span class="hljs-string">InstrumentationCallbackInfo.Reserved</span> <span class="hljs-string">=</span> <span class="hljs-number">0</span><span class="hljs-string">;</span>
    <span class="hljs-string">InstrumentationCallbackInfo.Callback</span> <span class="hljs-string">=</span> <span class="hljs-string">InstrumentationCallback;</span>

    <span class="hljs-string">Status</span> <span class="hljs-string">=</span> <span class="hljs-string">NtSetInformationProcess(</span>
              <span class="hljs-string">ProcessHandle,</span>
              <span class="hljs-string">ProcessInstrumentationCallback,</span>
              <span class="hljs-string">&amp;InstrumentationCallbackInfo,</span>
              <span class="hljs-string">sizeof(InstrumentationCallbackInfo)</span>
              <span class="hljs-string">);</span>
</code></pre>



<p>Fortunately for red teams, it’s possible to remove any callback with <code>NtSetInformationProcess</code> by setting the callback to NULL.</p>



<h3 class="wp-block-heading">Intel Processor Trace (IPT)</h3>



<p><a href="https://software.intel.com/content/www/us/en/develop/articles/pin-a-binary-instrumentation-tool-downloads.html" rel="noreferrer noopener" target="_blank">Intel’s binary instrumentation</a>&nbsp;tool, which facilitates tracing at instruction level with triggering and filtering capabilities, can be used to intercept&nbsp;<a href="https://software.intel.com/sites/landingpage/pintool/docs/81205/Pin/html/group__PIN__SYSCALL__API.html" rel="noreferrer noopener" target="_blank">system calls</a>&nbsp;before and after execution. Intel Skylake and later CPU models also support IPT, that provides similar functionality on Windows 10 since build 1803.</p>



<ul class="wp-block-list"><li><a href="https://github.com/ionescu007/winipt" rel="noreferrer noopener" target="_blank">WinIPT for Windows RS5</a></li><li><a href="https://github.com/intelpt/WindowsIntelPT" rel="noreferrer noopener" target="_blank">Windows Intel PT Support Driver</a></li></ul>



<h2 class="wp-block-heading">Further Research</h2>



<ul class="wp-block-list"><li><a href="https://www.mdsec.co.uk/2019/03/silencing-cylance-a-case-study-in-modern-edrs/" rel="noreferrer noopener" target="_blank">Silencing Cylance: A Case Study in Modern EDRs</a></li><li><a href="https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/" rel="noreferrer noopener" target="_blank">Red Team Tactics: Combining Direct System Calls and sRDI to bypass AV/EDR</a></li><li><a href="https://0x00sec.org/t/userland-api-monitoring-and-code-injection-detection/5565" rel="noreferrer noopener" target="_blank">Userland API Monitoring and Code Injection Detection]</a></li><li><a href="https://0x00sec.org/t/defeating-userland-hooks-ft-bitdefender/12496" rel="noreferrer noopener" target="_blank">Defeating Userland Hooks (ft. Bitdefender)</a></li><li><a href="https://threatvector.cylance.com/en_us/home/universal-unhooking-blinding-security-software.html" rel="noreferrer noopener" target="_blank">Universal Unhooking: Blinding Security</a></li><li><a href="https://blog.malwarebytes.com/threat-analysis/2016/11/floki-bot-and-the-stealthy-dropper/" rel="noreferrer noopener" target="_blank">Floki Bot and the stealthy dropper</a></li><li><a href="https://www.cyberbit.com/blog/endpoint-security/latest-trickbot-variant-has-new-tricks-up-its-sleeve/" rel="noreferrer noopener" target="_blank">Latest Trickbot Variant has New Tricks Up Its Sleeve</a></li><li><a href="https://www.cyberbit.com/blog/endpoint-security/malware-mitigation-when-direct-system-calls-are-used/" rel="noreferrer noopener" target="_blank">Malware Mitigation when Direct System Calls are Used</a></li><li><a href="https://www.crummie5.club/freshycalls/" rel="noreferrer noopener" target="_blank">FreshyCalls: Syscalls Freshly Squeezed!</a></li><li><a href="https://improsec.com/tech-blog/win32k-system-call-filtering-deep-dive" rel="noreferrer noopener" target="_blank">Win32k System Call Filtering Deep Dive</a></li><li><a href="https://teamhydra.blog/2020/09/18/implementing-direct-syscalls-using-hells-gate/" rel="noreferrer noopener" target="_blank">Implementing Direct Syscalls Using Hell’s Gate</a></li><li><a href="https://www.ired.team/offensive-security/defense-evasion/how-to-unhook-a-dll-using-c++" rel="noreferrer noopener" target="_blank">Full DLL Unhooking with C++</a></li><li><a href="https://jhalon.github.io/utilizing-syscalls-in-csharp-1/" rel="noreferrer noopener" target="_blank">Red Team Tactics: Utilizing Syscalls in C# – Prerequisite Knowledge</a></li><li><a href="https://jhalon.github.io/utilizing-syscalls-in-csharp-2/" rel="noreferrer noopener" target="_blank">Red Team Tactics: Utilizing Syscalls in C# – Writing The Code</a></li><li><a href="https://www.ired.team/offensive-security/defense-evasion/bypassing-cylance-and-other-avs-edrs-by-unhooking-windows-apis" rel="noreferrer noopener" target="_blank">Bypassing Cylance and other AVs/EDRs by Unhooking Windows APIs</a></li><li><a href="https://medium.com/@fsx30/bypass-edrs-memory-protection-introduction-to-hooking-2efb21acffd6" rel="noreferrer noopener" target="_blank">Bypass EDR’s memory protection, introduction to hooking</a></li><li><a href="https://github.com/slaeryan/AQUARMOURY/tree/master/Shellycoat" rel="noreferrer noopener" target="_blank">Shellycoat</a></li><li><a href="https://breakdev.org/defeating-antivirus-real-time-protection-from-the-inside/" rel="noreferrer noopener" target="_blank">Defeating Antivirus Real-time Protection From The Inside</a></li><li><a href="https://www.solomonsklash.io/syscalls-for-shellcode-injection.html" rel="noreferrer noopener" target="_blank">Using Syscalls to Inject Shellcode on Windows</a></li><li><a href="https://resources.infosecinstitute.com/topic/hooking-system-service-dispatch-table-ssdt/" rel="noreferrer noopener" target="_blank">Hooking the System Service Dispatch Table (SSDT)</a></li><li><a href="https://www.oguzkartal.net/blog/index.php/2019/08/26/intercepting-the-windows-10-system-service-call-using-the-weakness-caused-by-the-dynamic-trace-support/" rel="noreferrer noopener" target="_blank">Intercepting the Windows 10 (1903) System Service call using the weakness caused by the dynamic trace support.</a></li><li><a href="https://github.com/microsoft/DTrace-on-Windows" rel="noreferrer noopener" target="_blank">Dynamic Tracing on Windows</a></li><li><a href="https://darungrim.com/research/2020-05-07-UsingIntelPTForVulnerabilityTriagingWithIPTAnalyzer.html" rel="noreferrer noopener" target="_blank">Using Intel PT for Vulnerability Triaging with IPTAnalyzer</a></li><li><a href="https://medium.com/yarden-shafir/yes-more-callbacks-the-kernel-extension-mechanism-c7300119a37a" rel="noreferrer noopener" target="_blank">Yes, More Callbacks — The Kernel Extension Mechanism</a></li><li><a href="https://www.fireeye.com/blog/threat-research/2012/06/bypassing-process-monitoring.html" rel="noreferrer noopener" target="_blank">How Advanced Malware Bypasses Process Monitoring</a></li><li><a href="https://www.fireeye.com/blog/threat-research/2019/10/staying-hidden-on-the-endpoint-evading-detection-with-shellcode.html" rel="noreferrer noopener" target="_blank">Staying Hidden on the Endpoint: Evading Detection with Shellcode</a></li><li><a href="https://github.com/everdox/InfinityHook" rel="noreferrer noopener" target="_blank">InfinityHook</a></li><li><a href="http://www.uninformed.org/?v=3&amp;a=3&amp;t=sumry" rel="noreferrer noopener" target="_blank">Bypassing PatchGuard on Windows x64 by Skywing</a></li></ul>



<p>This blog post was written by <a href="https://twitter.com/modexpblog" target="_blank" rel="noreferrer noopener">@modexpblog</a>.</p>
		</div>
		
		<div class="author">
			<div class="content-wrapper clearfix">
				<div class="author-avatar">
					<img alt="" src="https://secure.gravatar.com/avatar/9cb7b62409a4b5ef00769dca4ba852fc49229c9729d600fc2637daf77068c31c?s=96&amp;d=wp_user_avatar&amp;r=g" class="avatar avatar-96 photo" height="96" width="96" decoding="async">				</div>
				<div class="author-meta">
					<div class="author-meta__content">
						<span>written by</span>
						<h4>MDSec Research</h4>
					</div>
				</div>
			</div>
		</div>
		<section class="testing">
	<div class="content-wrapper">
		<h2>Ready to engage<br>with MDSec?</h2>
		<div class="button">
			<a href="https://www.mdsec.co.uk/contact">
				Get in touch
			</a>
		</div>
	</div>
</section>		
	</section>




	<section class="newsletter">
	<div class="content-wrapper clearfix">
		<div class="newsletter-left">
			<p>
				Stay updated with the latest <br>news from MDSec.
			</p>
		</div>
		<div class="newsletter-right">
			<div class="frm_forms  with_frm_style frm_style_formidable-style" id="frm_form_2_container">
<form enctype="multipart/form-data" method="post" class="frm-show-form  frm_js_validate " id="form_newslettersignupform">
<div class="frm_form_fields ">
<fieldset>
<legend class="frm_screen_reader">Newsletter Signup Form</legend>

<div class="frm_fields_container">





<div id="frm_field_10_container" class="frm_form_field form-field  frm_none_container frm_full">
    <label for="field_nkjbj" id="field_nkjbj_label" class="frm_primary_label">Email
        <span class="frm_required"></span>
    </label>
    <input type="email" id="field_nkjbj" name="item_meta[10]" value="" placeholder="Enter your email for updates" data-invmsg="Email is invalid" aria-invalid="false">
    
    
</div>
<div id="frm_field_11_container" class="frm_form_field form-field  frm_none_container frm_first frm_full">
    <label for="g-recaptcha-response" id="field_ah4d8_label" class="frm_primary_label" style="display: none;">
        <span class="frm_required"></span>
    </label>
    <div id="field_ah4d8" class="frm-g-recaptcha" data-sitekey="6Lc27L0ZAAAAAMV4QCtKwWRbT-Hm1FnY6IKqcSxw" data-size="invisible" data-theme="light" data-rid="0"><div class="grecaptcha-badge" data-style="bottomright" style="width: 256px; height: 60px; display: block; transition: right 0.3s; position: fixed; bottom: 14px; right: -186px; box-shadow: gray 0px 0px 5px; border-radius: 2px; overflow: hidden;"><div class="grecaptcha-logo"><div title="reCAPTCHA" width="256" height="60" role="presentation" name="a-vqeh4wsubhmb" frameborder="0" scrolling="no" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-top-navigation allow-modals allow-popups-to-escape-sandbox allow-storage-access-by-user-activation" src="https://www.google.com/recaptcha/api2/anchor?ar=1&amp;k=6Lc27L0ZAAAAAMV4QCtKwWRbT-Hm1FnY6IKqcSxw&amp;co=aHR0cHM6Ly93d3cubWRzZWMuY28udWs6NDQz&amp;hl=en&amp;v=vUgXt_KV952_-5BB2jjloYzl&amp;theme=light&amp;size=invisible&amp;anchor-ms=20000&amp;execute-ms=30000&amp;cb=z37vhz7el0f4" data-original-tag="iframe">

<title>reCAPTCHA</title>

<link rel="stylesheet" type="text/css" href="https://www.gstatic.com/recaptcha/releases/vUgXt_KV952_-5BB2jjloYzl/styles__ltr.css">


<div id="rc-anchor-alert" class="rc-anchor-alert"></div>

<div class="rc-anchor rc-anchor-invisible rc-anchor-light  rc-anchor-invisible-hover"><div id="recaptcha-accessible-status" class="rc-anchor-aria-status" aria-hidden="true">Recaptcha requires verification. </div><div class="rc-anchor-error-msg-container" style="display:none"><span class="rc-anchor-error-msg" aria-hidden="true"></span></div><div class="rc-anchor-normal-footer"><div class="rc-anchor-logo-large" role="presentation"><div class="rc-anchor-logo-img rc-anchor-logo-img-large"></div></div><div class="rc-anchor-pt"><a href="https://www.google.com/intl/en/policies/privacy/" target="_blank">Privacy</a><span aria-hidden="true" role="presentation"> - </span><a href="https://www.google.com/intl/en/policies/terms/" target="_blank">Terms</a></div></div><div class="rc-anchor-invisible-text"><span>protected by <strong>reCAPTCHA</strong></span><div class="rc-anchor-pt"><a href="https://www.google.com/intl/en/policies/privacy/" target="_blank" style="">Privacy</a><span aria-hidden="true" role="presentation"> - </span><a href="https://www.google.com/intl/en/policies/terms/" target="_blank" style="">Terms</a></div></div></div></div></div><div class="grecaptcha-error"></div><textarea id="g-recaptcha-response" name="g-recaptcha-response" class="g-recaptcha-response" style="width: 250px; height: 40px; border: 1px solid rgb(193, 193, 193); margin: 10px 25px; padding: 0px; resize: none; display: none;"></textarea></div></div>
    
    
</div>
	
			<div id="frm_field_29_container">
			<label for="field_zwyz0" style="display:none;">
				If you are human, leave this field blank.			</label>
			<input id="field_zwyz0" type="text" class="frm_form_field form-field frm_verify" name="item_meta[29]" value="" style="display:none;">
		</div>
		<div class="frm_submit">

<button class="frm_button_submit" type="submit">Submit</button>

</div></div>
</fieldset>
</div>

</form>
</div>
			
		</div>
	</div>
</section>

		</div>
	<!-- Site Wrapper End -->
	
	<!-- Footer Start -->	
	

	<div class="end clearfix">
		<div class="end__left">
			Copyright 2026 MDSec
		</div>
		<div class="end__right">
			<!--<a href="#">Privacy Policy</a>-->
		</div>
	</div>
	<!-- Footer End -->
	
    










	
			
	
	



    	    			




</body><!-- Body End --></html>