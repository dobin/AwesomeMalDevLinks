Title:
Revisiting the UDRL Part 3: Beacon User Data

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how Cobalt Strike’s User-Defined Reflective Loader (UDRL) and Sleepmask were historically misaligned due to Beacon using static/heuristic memory layout calculations tied to malleable C2 settings, which could cause crashes or leave unmasked code.  
- In Cobalt Strike 4.10, Beacon User Data (BUD) is expanded so loaders can report runtime-accurate virtual memory allocations and PE section metadata to Beacon, allowing Sleepmask to mask the correct regions without relying on static assumptions.  
- The article details the new BUD memory-tracking structures (regions/sections) and helper APIs in UDRL-VS to record allocations and per-section properties for cleanup and masking.  
- A case study shows loading Beacon plus an External C2 DLL in one payload (DoublePulsar/sRDI-style prepend loader), tracking both allocations in BUD, and masking both modules at runtime using Sleepmask-VS.  
- It also covers thread synchronization for safe masking of the External C2 thread using non-blocking pipe reads (PeekNamedPipe) and event objects passed via BUD custom data, with a new `ExternalC2Sleep()` routine in Sleepmask-VS.  
- Useful for red team tool developers and operators building custom loaders, Sleepmasks, BOFs, and External C2 channels who need reliable runtime masking across varied memory layouts.

Technical Focus:
- Beacon User Data (BUD) interface and versioning (CS 4.9/4.10)
- Runtime memory/section tracking for masking (ALLOCATED_MEMORY_REGION/SECTION)
- Reflective loading / prepend loaders (DoublePulsar, sRDI patterns)
- Sleepmask integration and runtime XOR masking of PE sections
- External C2 “pass thru” mode and SMB/named-pipe transport
- Thread synchronization via Windows events and non-blocking I/O (PeekNamedPipe)

Use Cases:
- Build UDRLs that provide accurate section maps to Sleepmask to prevent partial masking/crashes
- Track and mask additional in-memory modules (External C2 DLLs, post-ex DLLs, BOFs support allocations)
- Create single-file payloads that bundle Beacon + custom comms layer while retaining Aggressor Script transformations
- Implement coordinated masking for multi-threaded components using event-based synchronization
- Improve cleanup of loader-allocated memory regions after execution

Keywords:
Cobalt Strike 4.10, UDRL, Sleepmask, Beacon User Data, BUD, UDRL-VS, Sleepmask-VS, reflective loader, sRDI, DoublePulsar, VirtualAlloc, PE sections, memory regions, VirtualProtect, External C2, pass thru mode, SMB Beacon, named pipe, PeekNamedPipe, CreateEventA, WaitForSingleObject, SignalObjectAndWait, Aggressor Script, runtime masking, XORSections