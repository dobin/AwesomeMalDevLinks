Title:
SLE(A)PING Issues: SWAPPALA and Reflective DLL Friends Forever

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post documents the author’s attempt to combine SWAPPALA (DLL address “swap/hide” via remapping) with a reflective DLL loader to give the payload “sleep” capability while masquerading behind a legitimate DLL mapping.  
- The initial approach reused Ekko/EkkoQua-style sleep (NtContinue + stack manipulation) but crashed in processes with modern mitigations (CFG, shadow stack, stack cookies), because the stack duplication/ROP-like context tricks caused the thread to be terminated before key APIs (e.g., MapViewOfFileEx) executed.  
- The author replaces EkkoQua with a new “Sleaping” method: create multiple threads in a suspended state (each with its own clean stack), set their CONTEXT (RIP/RCX/RDX/R8/R9 + stack args) to call UnmapViewOfFile/MapViewOfFileEx, and schedule execution via timer queue callbacks that call ResumeThread.  
- Threads are made to exit cleanly by placing ExitThread as the return address because suspended-thread stacks are zeroed and would otherwise AV on return.  
- A notable observation is that ResumeThread did not require CFG “whitelisting” in their testing, reducing one potential crash/IOC compared to other indirect-call patterns.  
- Useful for red teamers/malware developers exploring stealthy in-memory remapping + sleep orchestration that survives common Windows exploit mitigations.

Technical Focus:
- SWAPPALA-style section remapping (private malicious section ↔ legitimate DLL at same base)
- Reflective DLL loading / PIC loader routines
- Windows thread CONTEXT manipulation (GetThreadContext/SetThreadContext) on x64 calling convention
- Timer queue execution (CreateTimerQueueTimer) and timer-thread callbacks
- Process mitigations impact (CFG, shadow stack, stack cookies) on sleep/ROP-like techniques
- Memory mapping APIs (MapViewOfFileEx, UnmapViewOfFile)

Use Cases:
- Implementing “sleep”/dormancy for in-memory payloads without NtContinue-based chains
- Hiding a reflective DLL behind a legitimate DLL mapping during idle periods
- Building alternative execution chains that avoid stack “byte fights” and >4-argument call issues
- Researching how Windows mitigations break common sleep/ROP patterns and how to adapt
- Prototyping stealth tradecraft around section mapping/unmapping in remote processes

Keywords:
SWAPPALA, reflective DLL injection, in-memory evasion, MapViewOfFileEx, UnmapViewOfFile, CreateThread, CREATE_SUSPENDED, GetThreadContext, SetThreadContext, CONTEXT, x64 calling convention, ROP chain, NtContinue, Ekko, Control Flow Guard, CFG, shadow stack, stack cookie, CreateTimerQueueTimer, ResumeThread, ExitThread, memory mapping, section remapping