Title:
PART 2: How I Met Your Beacon – Cobalt Strike

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes practical detection strategies for Cobalt Strike (tested on 4.6.1) across both host memory and network telemetry, accounting for malleable profile variability.  
- It focuses on in-memory hunting, including how Sleep Mask Kit configurations change what can be signatured (e.g., plaintext vs XOR-masked data, and the RWX tradeoff when `userwx` is enabled).  
- It outlines process/thread-level indicators such as suspicious executable memory regions (RX/RWX + MEM_COMMIT), beacon thread characteristics (sleep APIs like `SleepEx`/`NtDelayExecution`, unresolved virtual-memory frames, odd start addresses), and notes limits of stack spoofing coverage.  
- It covers module stomping detection by identifying anomalous PEB loader entries caused by `LoadLibraryExA(..., DONT_RESOLVE_DLL_REFERENCES)` (e.g., NULL EntryPoint and `ImageDLL` false).  
- On the network side, it provides multiple fingerprints for Cobalt Strike’s NanoHTTPD-based team server via malformed `Range` headers and bad URL percent-encoding, including an example Nuclei template.  
- It is primarily useful for blue teams and threat hunters building high-confidence detections, but also informs red teams about observable artifacts and OpSec tradeoffs.

Technical Focus:
- Sleep Mask Kit (`sleep_mask`, `userwx`) and in-memory obfuscation tradeoffs (RX vs RWX)
- Memory scanning/YARA signatures for beacon artifacts
- Thread/call-stack indicators (SleepEx/NtDelayExecution, virtual memory frames, fibers)
- Module stomping implementation artifacts in PEB/LDR_DATA_TABLE_ENTRY
- Network fingerprinting of Cobalt Strike team servers (NanoHTTPD quirks)
- Nuclei-based active scanning templates for C2 identification

Use Cases:
- Build endpoint hunting queries for suspicious RX/RWX private memory regions and beacon-like threads
- Write/validate YARA rules targeting non-obfuscated Sleep Mask code paths
- Detect Cobalt Strike module stomping by auditing PEB loader metadata anomalies
- Identify likely Cobalt Strike team servers via safe active probing (Range header / bad encoding)
- Create Nuclei templates and scanning playbooks for external C2 discovery and triage

Keywords:
Cobalt Strike, Beacon, Sleep Mask Kit, malleable C2 profile, userwx, RWX, PAGE_EXECUTE_READWRITE, PAGE_EXECUTE_READ, MEM_COMMIT, YARA, memory scanning, Process Hacker, thread start address, SleepEx, NtDelayExecution, call stack, fibers, RtlUserFiberStart, module stomping, PEB, LDR_DATA_TABLE_ENTRY, LoadLibraryExA, DONT_RESOLVE_DLL_REFERENCES, NanoHTTPD, Range header, percent-encoding, Nuclei template, C2 fingerprinting