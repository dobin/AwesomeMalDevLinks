Title:
Malware development part 5 – tips & tricks

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post covers practical Windows malware development techniques aimed at evasion and analysis resistance in a 64-bit environment.  
- It demonstrates parent PID spoofing using `CreateProcess` with `PROC_THREAD_ATTRIBUTE_PARENT_PROCESS` to manipulate parent/child process lineage used by behavioral detections.  
- It discusses “process protection” via process mitigation policies (blocking non-Microsoft DLLs and prohibiting dynamic code) to hinder EDR injection and debugging, with notes on the tradeoff that dynamic code prohibition breaks executable memory allocation.  
- For payload/config obfuscation, it shows RC4-based encryption and a brute-force runtime key-cracking approach validated via hashing to avoid hardcoded keys and potentially delay sandbox analysis.  
- It also outlines runtime key delivery over HTTP (WinHTTP) or DNS TXT queries, and introduces environmental keying (MITRE T1480.001) to restrict execution/decryption to specific targets.  
- The post includes a PEB-walking technique to read environment variables (e.g., `COMPUTERNAME`) without calling standard Windows APIs, reducing observable telemetry.

Technical Focus:
- Parent PID spoofing via `STARTUPINFOEX` / `PROC_THREAD_ATTRIBUTE_PARENT_PROCESS`
- Process mitigation policies (`PROC_THREAD_ATTRIBUTE_MITIGATION_POLICY`, ACG, DLL blocking)
- Data/config encryption and obfuscation (RC4, hashing for validation)
- Runtime brute-force decryption / time-based anti-sandbox delays
- Key retrieval over WinHTTP and DNS TXT (`DnsQuery_A`)
- Environmental keying and PEB-based environment variable access (`PEB`, `_RTL_USER_PROCESS_PARAMETERS`)

Use Cases:
- Spoofing process lineage to evade parent/child behavioral rules
- Hardening a process against EDR userland DLL injection and dynamic analysis
- Hiding embedded strings, shellcode, and C2 configuration with non-static keys
- Delaying sandbox detonation via expensive computations or brute-force key search
- Delivering decryption keys via network channels (HTTP/DNS) for staged execution
- Target-locking payload execution/decryption to specific hosts/domains/users

Keywords:
Windows malware development, PPID spoofing, CreateProcessA, STARTUPINFOEX, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, process mitigation policy, ACG, PROCESS_CREATION_MITIGATION_POLICY_BLOCK_NON_MICROSOFT_BINARIES_ALWAYS_ON, PROCESS_CREATION_MITIGATION_POLICY_PROHIBIT_DYNAMIC_CODE_ALWAYS_ON, SetProcessMitigationPolicy, RC4, Bcrypt, brute-force decryption, djb2 hash, WinHTTP, DnsQuery_A, DNS TXT, environmental keying, MITRE T1480.001, PEB, RTL_USER_PROCESS_PARAMETERS, __readgsqword, sandbox evasion, EDR evasion