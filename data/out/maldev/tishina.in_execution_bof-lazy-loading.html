# https://tishina.in/execution/bof-lazy-loading

<!DOCTYPE html><html lang="en"><body class="styled-scrollbars theme-dark">
<div class="published-container print is-readable-line-width has-navigation has-outline" style=""><div class="site-body"><div class="site-body-left-column"><div class="site-body-left-column-inner"><a class="site-body-left-column-site-logo" aria-label=" logo" href="https://tishina.in/home"><img aria-hidden="true" src="https://publish-01.obsidian.md/access/c7ce07c5421851d0d6a9c4b6320620d9/images/simple.png" style=""></a><a class="site-body-left-column-site-name" aria-label="" href="https://tishina.in/home"></a><div class="site-body-left-column-site-theme-toggle" style="display: none;"></div><div class="search-view-outer"><div class="search-view-container"><span class="published-search-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-search"><path d="m21 21-4.34-4.34"></path><circle cx="11" cy="11" r="8"></circle></svg></span><input class="search-bar" tabindex="0" type="text" placeholder="Search page or heading..."></div></div><div class="nav-view-outer"><div class="nav-view"><div class="tree-item"><div class="tree-item-self mod-root is-clickable" data-path=""><div class="tree-item-inner"></div></div><div class="tree-item-children"><div class="tree-item is-collapsed"><div class="tree-item-self mod-collapsible is-clickable" data-path="appsec"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner">appsec</div></div></div><div class="tree-item"><div class="tree-item-self mod-collapsible is-clickable" data-path="execution"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner">execution</div></div><div class="tree-item-children" style=""><div class="tree-item"><div class="tree-item-self is-clickable mod-active" data-path="execution/bof-lazy-loading.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/bof-lazy-loading">bof-lazy-loading</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/byovm.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/byovm">byovm</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/caveman-bofs.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/caveman-bofs">caveman-bofs</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/DOUBLEGOD-and-insomnia-loader.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/DOUBLEGOD-and-insomnia-loader">DOUBLEGOD-and-insomnia-loader</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/golang-winmaldev-basics.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/golang-winmaldev-basics">golang-winmaldev-basics</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/linux-evasion-primitives.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/linux-evasion-primitives">linux-evasion-primitives</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/nim-fibers.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/nim-fibers">nim-fibers</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/nim-noload-dll-hollowing.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/nim-noload-dll-hollowing">nim-noload-dll-hollowing</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/phase-dive-sleep-obfuscation.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/phase-dive-sleep-obfuscation">phase-dive-sleep-obfuscation</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/pyd-execute-assembly.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/pyd-execute-assembly">pyd-execute-assembly</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/python-inmemory-bof.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/python-inmemory-bof">python-inmemory-bof</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/replacing-memfd-with-fuse.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/replacing-memfd-with-fuse">replacing-memfd-with-fuse</a></div></div></div></div></div><div class="tree-item is-collapsed"><div class="tree-item-self mod-collapsible is-clickable" data-path="initial-access"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner">initial-access</div></div></div><div class="tree-item is-collapsed"><div class="tree-item-self mod-collapsible is-clickable" data-path="ops"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner">ops</div></div></div><div class="tree-item is-collapsed"><div class="tree-item-self mod-collapsible is-clickable" data-path="opsec"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner">opsec</div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="home.md"><div class="tree-item-inner"><a href="https://tishina.in/home">home</a></div></div></div></div></div></div></div></div></div><div class="site-body-center-column"><div class="site-header"><div class="clickable-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-menu"><path d="M4 5h16"></path><path d="M4 12h16"></path><path d="M4 19h16"></path></svg></div><a class="site-header-logo" aria-hidden="true" href="https://tishina.in/home" style=""><img src="https://publish-01.obsidian.md/access/c7ce07c5421851d0d6a9c4b6320620d9/images/simple.png"></a><a class="site-header-text" href="https://tishina.in/home"></a></div><div class="render-container"><div class="render-container-inner"><div class="publish-renderer"><div class="markdown-preview-view markdown-rendered node-insert-event" tabindex="-1" style="outline: none;"><div class="markdown-preview-sizer markdown-preview-section" style="padding-bottom: 0px;"><div class="markdown-preview-pusher" style="width: 1px; height: 0.1px; margin-bottom: 0px;"></div><div class="mod-header mod-ui"><h1 class="page-header">bof-lazy-loading</h1></div><div class="el-h1"><h1 data-heading="tl;dr" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>tl;dr <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">This article presents an easy/lazy way of integrating BOFs into your nim projects without implementing a full-scale COFF loader. This is a way I've first seen implemented in <code>sliver</code> C2.</p></div><div class="el-h1"><h1 data-heading="COFF files" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>COFF files <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">COFF files (<code>.o/.obj</code>) are widely used for in-memory execution (in Cobalt Strike, for example), as they provide a more structured primitive for extensions than raw shellcode and allow the COFF loader to implement necessary primitives (like <code>BeaconPrintf</code> or WinAPI resolution) in any way desired.</p></div><div class="el-h1"><h1 data-heading="loading COFF" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>loading COFF <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">Dynamically loading object files is mostly about resolving and applying relocations to the <code>.obj</code> (while loading missing libraries). The best resource for creating your own and understaning how COFF loading works, imo, is 0xpats blog -- <a rel="noopener nofollow" class="external-link" href="https://0xpat.github.io/Malware_development_part_8/" target="_blank">https://0xpat.github.io/Malware_development_part_8/</a></p></div><div class="el-p"><p dir="auto">I, however, am way too lazy to rewrite from scratch what's already on GitHub -- the <a data-tooltip-position="top" aria-label="https://github.com/trustedsec/COFFLoader" rel="noopener nofollow" class="external-link" href="https://github.com/trustedsec/COFFLoader" target="_blank">trustedsec/COFFLoader</a> repository, and namely, the <code>sliver</code> <a data-tooltip-position="top" aria-label="https://github.com/sliverarmory/COFFLoader/" rel="noopener nofollow" class="external-link" href="https://github.com/sliverarmory/COFFLoader/" target="_blank">fork</a> of it, as the developers have done the work of creating a DLL export out of <code>RunCOFF</code> for us. </p></div><div class="el-p"><p dir="auto">Instead of properly reimplementing COFF loading, why not just load a DLL that will do everything for us? It's way easier to detect, but WCYD.</p></div><div class="el-p"><p dir="auto">Thus, the approach becomes very simple:</p></div><div class="el-pre"><pre class="language-j"><code data-line="0" class="language-j is-loaded">load COFFLoader reflectively in<span class="token verb keyword">-</span>memory <span class="token verb keyword">-</span><span class="token verb keyword">&gt;</span>
	GetProcAddress<span class="token punctuation">(</span>LoadAndRun<span class="token punctuation">)</span> <span class="token verb keyword">-</span><span class="token verb keyword">&gt;</span>
		build argument array <span class="token verb keyword">-</span><span class="token verb keyword">&gt;</span>
			LoadAndRun<span class="token punctuation">(</span>COFF<span class="token verb keyword">,</span> callback<span class="token punctuation">)</span> <span class="token verb keyword">-</span><span class="token verb keyword">&gt;</span>
				wait for callback and process output
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h1"><h1 data-heading="COFF arguments" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>COFF arguments <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">Beacon Object File argument format is very simple:</p></div><div class="el-pre"><pre class="language-j"><code data-line="0" class="language-j is-loaded">len<span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token verb keyword">|</span>len<span class="token punctuation">(</span>arg1<span class="token punctuation">)</span><span class="token verb keyword">|</span> <span class="token conjunction variable">..</span><span class="token conjunction variable">.</span> arg1 <span class="token conjunction variable">..</span><span class="token conjunction variable">.</span>  <span class="token verb keyword">|</span> len<span class="token punctuation">(</span>arg2<span class="token punctuation">)</span> <span class="token verb keyword">|</span> <span class="token conjunction variable">..</span><span class="token conjunction variable">.</span>
 <span class="token number">4</span> bytes  <span class="token number">4</span> bytes   len<span class="token punctuation">(</span>arg1<span class="token punctuation">)</span> bytes  <span class="token number">4</span> bytes
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Despite argument length being provided, it is still expected that C strings are null-terminated. Lengths are little-endian, and the overall message length is never used by LoadAndRun, as it is supplied as a separate argument.</p></div><div class="el-p"><p dir="auto">If you do not want to generate them yourself, use trustedsec's <code>beacon_generate.py</code> and hex-decode the result.</p></div><div class="el-h1"><h1 data-heading="PoC code" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>PoC code <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">Also available on <a data-tooltip-position="top" aria-label="https://github.com/zimnyaa/nim-lazy-bof" rel="noopener nofollow" class="external-link" href="https://github.com/zimnyaa/nim-lazy-bof" target="_blank">GitHub</a>. The PoC provided loads and runs <code>whoami.o</code> without arguments. The COFFLoader DLL provided on GitHub also prints beacon argument parser state, which I've used for debugging, but it is interchangeable with the DLL from <code>sliverarmory</code> releases.</p></div><div class="el-pre"><pre class="language-nim"><code data-line="0" class="language-nim is-loaded"><span class="token keyword">import</span> winim
<span class="token keyword">import</span> std<span class="token operator">/</span>dynlib
<span class="token keyword">import</span> system
<span class="token keyword">import</span> ptr_math

<span class="token keyword">import</span> memlib

<span class="token comment"># wstring -&gt; string </span>
<span class="token keyword">proc</span> <span class="token function">lpwstrc</span><span class="token punctuation">(</span>bytes<span class="token operator">:</span> array<span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">,</span> WCHAR<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token operator">=</span>
  result <span class="token operator">=</span> <span class="token function">newString</span><span class="token punctuation">(</span>bytes<span class="token operator">.</span>len<span class="token punctuation">)</span>
  <span class="token function">copyMem</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token keyword">addr</span><span class="token punctuation">,</span> bytes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">.</span>unsafeAddr<span class="token punctuation">,</span> bytes<span class="token operator">.</span>len<span class="token punctuation">)</span>


<span class="token comment"># BOF output callback</span>
<span class="token keyword">proc</span> <span class="token function">callback</span><span class="token punctuation">(</span>data<span class="token operator">:</span> cstring<span class="token punctuation">,</span> status<span class="token operator">:</span> int<span class="token punctuation">)</span><span class="token operator">:</span> int <span class="token punctuation">{.</span>gcsafe<span class="token punctuation">,</span> stdcall<span class="token punctuation">.}</span> <span class="token operator">=</span> 
  echo <span class="token string">"[!] CALLBACK CALLED"</span>
  echo data
  <span class="token keyword">return</span>

<span class="token comment">#  in-memory loading the COFFLoader dll</span>
<span class="token keyword">const</span> coffloader <span class="token operator">=</span> <span class="token function">staticReadDll</span><span class="token punctuation">(</span><span class="token string">"COFFLoader.x64.dll"</span><span class="token punctuation">)</span>
<span class="token keyword">proc</span> <span class="token function">loadcoff</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> LPVOID<span class="token punctuation">,</span> length<span class="token operator">:</span> int<span class="token punctuation">,</span> callback<span class="token operator">:</span> <span class="token function">proc</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> cstring<span class="token punctuation">,</span> status<span class="token operator">:</span> int<span class="token punctuation">)</span> <span class="token operator">:</span> int <span class="token punctuation">{.</span>stdcall<span class="token punctuation">,</span> gcsafe<span class="token punctuation">.}</span><span class="token punctuation">)</span> <span class="token operator">:</span> int <span class="token punctuation">{.</span>cdecl<span class="token punctuation">,</span> memlib<span class="token operator">:</span> coffloader<span class="token punctuation">,</span> importc<span class="token operator">:</span> <span class="token string">"LoadAndRun"</span><span class="token punctuation">.}</span>

<span class="token comment"># constant entrypoint arg</span>
<span class="token keyword">var</span> entrypoint_arg<span class="token operator">:</span> array<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> byte<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>byte <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x67</span><span class="token punctuation">,</span> <span class="token number">0x6f</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">]</span> <span class="token comment"># len(c"go"), c"go"</span>

<span class="token comment"># COFF arguments (empty)</span>
<span class="token keyword">var</span> coff_arg<span class="token operator">:</span> array<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> byte<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>byte <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">]</span>



<span class="token comment"># COFF file</span>
<span class="token keyword">var</span> coff_file <span class="token operator">=</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">"whoami.o"</span><span class="token punctuation">)</span>


echo <span class="token string">"[+] Starting with "</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
echo <span class="token string">"[+] loadcoff address -&gt; "</span><span class="token punctuation">,</span> <span class="token function">toHex</span><span class="token punctuation">(</span><span class="token function">cast[int]</span><span class="token punctuation">(</span>loadcoff<span class="token punctuation">)</span><span class="token punctuation">)</span>



echo <span class="token string">"[+] callback address -&gt; "</span><span class="token punctuation">,</span> <span class="token function">toHex</span><span class="token punctuation">(</span><span class="token function">cast[int]</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> loader_args <span class="token operator">=</span> <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>coff_file<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>entrypoint_arg<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>coff_arg<span class="token punctuation">)</span><span class="token punctuation">,</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span>

echo <span class="token string">"[!] VirtualAlloc "</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">" to "</span><span class="token punctuation">,</span> <span class="token function">toHex</span><span class="token punctuation">(</span><span class="token function">cast[int]</span><span class="token punctuation">(</span>loader_args<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># "go" entrypoint</span>
<span class="token function">copyMem</span><span class="token punctuation">(</span>loader_args<span class="token punctuation">,</span> <span class="token keyword">addr</span> entrypoint_arg<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>entrypoint_arg<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># file size</span>
<span class="token keyword">var</span> coffsize <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>coff_file<span class="token punctuation">)</span>
<span class="token function">copyMem</span><span class="token punctuation">(</span>loader_args <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>entrypoint_arg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>coff_size<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

<span class="token comment"># file bytes</span>
<span class="token function">copyMem</span><span class="token punctuation">(</span>loader_args <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>entrypoint_arg<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>coff_file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>coff_file<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># args</span>
<span class="token function">copyMem</span><span class="token punctuation">(</span>loader_args <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>entrypoint_arg<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>coff_file<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token keyword">addr</span> coff_arg<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>coff_arg<span class="token punctuation">)</span><span class="token punctuation">)</span>

echo <span class="token string">"[!] memory copied"</span>
echo <span class="token string">"[!] args will be: ( "</span><span class="token punctuation">,</span> <span class="token function">toHex</span><span class="token punctuation">(</span><span class="token function">cast[int]</span><span class="token punctuation">(</span>loader_args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">", "</span><span class="token punctuation">,</span> <span class="token function">toHex</span><span class="token punctuation">(</span><span class="token function">cast[int]</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>coff_file<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>entrypoint_arg<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>coff_arg<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">", "</span><span class="token punctuation">,</span> <span class="token function">toHex</span><span class="token punctuation">(</span><span class="token function">cast[int]</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">" )"</span>

<span class="token keyword">discard</span> <span class="token function">loadcoff</span><span class="token punctuation">(</span>loader_args<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>coff_file<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>entrypoint_arg<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>coff_arg<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-blockquote"><blockquote dir="auto">
<p><span alt="Pasted image 20220419171238.png" src="Pasted image 20220419171238.png" class="internal-embed image-embed is-loaded"><img alt="Pasted image 20220419171238.png" src="https://publish-01.obsidian.md/access/c7ce07c5421851d0d6a9c4b6320620d9/images/Pasted%20image%2020220419171238.png"></span><br>
running the loader</p>
</blockquote></div><div class="mod-footer mod-ui"></div></div></div><div class="extra-title"><span class="extra-title-text">bof-lazy-loading</span><span aria-label="Close page" role="button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></span></div></div></div><div class="not-found-container" style="display: none;"><div class="not-found-image"></div><div class="not-found-title">Not found</div><div class="not-found-description">This page does not exist</div></div><div class="site-body-right-column"><div class="site-body-right-column-inner"><div class="graph-view-outer"><div class="list-item published-section-header"><span class="published-section-header-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-git-fork"><circle cx="12" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="6" r="3"></circle><path d="M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9"></path><path d="M12 12v3"></path></svg></span><span>Interactive graph</span></div><div class="graph-view-container"><div class="graph-view" style="display: none;"></div><div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-arrow-up-right"><path d="M7 7h10v10"></path><path d="M7 17 17 7"></path></svg></div><div class="graph-icon graph-global" role="button" aria-label="Global Graph" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-git-fork"><circle cx="12" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="6" r="3"></circle><path d="M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9"></path><path d="M12 12v3"></path></svg></div></div></div><div class="outline-view-outer node-insert-event"><div class="list-item published-section-header"><span class="published-section-header-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-list"><path d="M3 5h.01"></path><path d="M3 12h.01"></path><path d="M3 19h.01"></path><path d="M8 5h13"></path><path d="M8 12h13"></path><path d="M8 19h13"></path></svg></span><span>On this page</span></div><div class="outline-view"><div class="tree-item"><div class="tree-item-self is-clickable mod-active"><div class="tree-item-inner">tl;dr</div></div><div class="tree-item-children"></div></div><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">COFF files</div></div><div class="tree-item-children"></div></div><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">loading COFF</div></div><div class="tree-item-children"></div></div><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">COFF arguments</div></div><div class="tree-item-children"></div></div><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">PoC code</div></div><div class="tree-item-children"></div></div></div></div></div></div></div><div class="site-footer"><a href="https://publish.obsidian.md/" target="_blank">Powered by Obsidian Publish</a></div></div></div><div class="nav-backdrop"></div></div></body></html>