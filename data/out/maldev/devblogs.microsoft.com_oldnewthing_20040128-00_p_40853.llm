Title:
Another reason not to do anything scary in your DllMain: Inadvertent deadlock

Type:
Blog Post

Short Summary (4â€“8 sentences max):
- This post explains why executing complex logic inside `DllMain` is dangerous due to the Windows loader lock being held during DLL load/unload and thread attach/detach notifications.  
- It describes how calling APIs that consult the loaded-module list (e.g., `GetModuleHandle`, `GetModuleFileName`) can require the loader lock, and how taking your own locks in `DllMain` can violate lock ordering.  
- A concrete deadlock scenario is shown where one thread holds a DLL critical section then calls `GetModuleFileName` (needs loader lock), while another thread holds the loader lock during `DLL_THREAD_DETACH` and blocks trying to enter that same critical section in `DllMain`.  
- The key guidance is to treat the loader lock as part of your lock hierarchy and avoid waiting on synchronization primitives or calling loader-lock-taking APIs from `DllMain`.  
- Useful for Windows developers, malware authors, and red teamers writing injection/persistence DLLs who need reliability and want to avoid hard-to-debug hangs.

Technical Focus:
- Windows loader lock semantics
- `DllMain` constraints (`DLL_THREAD_DETACH` and other reasons)
- Lock hierarchy / lock ordering
- Deadlock patterns involving `CRITICAL_SECTION`
- Module enumeration / loader-dependent Win32 APIs (`GetModuleFileName`, `GetModuleHandle`)

Use Cases:
- Designing safe DLL initialization for injected modules and in-process tooling
- Debugging unexplained process hangs during DLL load/unload or thread exit
- Refactoring `DllMain` to defer work to worker threads or explicit init routines
- Creating coding standards for synchronization and API usage in Windows DLLs

Keywords:
Windows loader lock, DllMain, DLL_THREAD_DETACH, deadlock, lock hierarchy, CRITICAL_SECTION, synchronization, GetModuleFileName, GetModuleHandle, module list, loader, thread detach notification, DLL injection, initialization order, Win32 API, Raymond Chen, The Old New Thing