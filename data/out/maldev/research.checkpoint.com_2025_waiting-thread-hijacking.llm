Title:
Waiting Thread Hijacking: A Stealthier Version of Thread Execution Hijacking

Type:
Blog Post

Short Summary (4–8 sentences max):
- This write-up introduces “Waiting Thread Hijacking” (WTH), a process injection execution technique that hijacks an existing *waiting* thread rather than creating/suspending threads or setting thread context.  
- It targets threads in a waiting state (notably `WrQueue`, common in thread pools) and achieves execution by overwriting the return address on the thread’s stack so that, when the syscall wait completes, control flows into attacker shellcode.  
- The method aims to bypass EDR detections that commonly trigger on `SuspendThread/ResumeThread`, `SetThreadContext`, remote thread creation, or APC-related telemetry/permissions.  
- Required access is reduced to typical VM read/write/alloc permissions on the process and `THREAD_GET_CONTEXT` on the thread, avoiding `THREAD_SET_CONTEXT` and `THREAD_SUSPEND_RESUME`.  
- The post details how to enumerate candidate threads via `NtQuerySystemInformation(SystemProcessInformation)`, validate return targets (e.g., `ntdll/kernel32/kernelbase`), and use a stub that preserves registers/flags and then jumps back to the original return address for stability.  
- It also discusses “execution flow obfuscation” by splitting allocation/write/protect/hijack steps across child processes to break process-centric behavioral signatures.  
- Useful for red teams and malware researchers evaluating stealthy execution primitives; also valuable for defenders designing detections around remote stack tampering and suspicious cross-process memory writes.

Technical Focus:
- Thread pool / waiting-thread internals (`WrQueue`, `TppWorkerThread`, `NtWaitForWorkViaWorkerFactory`)
- Remote stack manipulation (return address overwrite) for code execution
- Process/thread enumeration via `NtQuerySystemInformation(SystemProcessInformation)`
- Cross-process memory operations (`VirtualAllocEx`, `WriteProcessMemory`, `VirtualProtectEx`, `ReadProcessMemory`)
- EDR evasion trade-offs (avoiding `SetThreadContext`, `SuspendThread`, APC telemetry)
- Behavioral-signature evasion via step-splitting across child processes

Use Cases:
- Stealthy in-memory implant execution inside a medium-integrity 64-bit target without creating new threads
- Red team testing of EDR coverage beyond classic thread hijacking/APC injection detections
- Researching detections for remote stack/return-address tampering and thread-wait transitions
- Building PoCs to compare “write is allowed, execute is blocked” EDR configurations
- Developing behavioral analytics for suspicious sequences of remote VM operations + thread context reads

Keywords:
process injection, thread execution hijacking, waiting thread, WrQueue, thread pool, TppWorkerThread, NtWaitForWorkViaWorkerFactory, GetQueuedCompletionStatus, NtRemoveIoCompletion, NtQuerySystemInformation, SystemProcessInformation, SYSTEM_THREAD_INFORMATION, GetThreadContext, THREAD_GET_CONTEXT, VirtualAllocEx, WriteProcessMemory, VirtualProtectEx, ReadProcessMemory, return address overwrite, stack pointer (RSP), EDR evasion, ETW, ObRegisterCallbacks, PsSetCreateThreadNotifyRoutine