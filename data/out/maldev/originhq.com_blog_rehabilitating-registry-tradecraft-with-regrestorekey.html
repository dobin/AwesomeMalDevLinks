# https://www.originhq.com/blog/rehabilitating-registry-tradecraft-with-regrestorekey

<!DOCTYPE html><!--UCl_a0aupBtM8Ugyf9aS0--><html lang="en"><body class="inter_fe8b9d92-module__LINzvG__variable"><div><!--$--><!--/$--></div><div class="relative w-full bg-[#ccc] font-sans min-h-screen text-white"><div class="fixed inset-0 z-[3] w-full h-full mix-blend-difference pointer-events-none" style="background:url(&quot;/bg-1.png&quot;) center center no-repeat;background-size:cover;filter:blur(0px) brightness(0.5) contrast(1.5) grayscale(1)"></div><canvas id="noise-canvas" class="fixed inset-0 z-[1] w-full h-full pointer-events-none mix-blend-difference grayscale" width="1919" height="992"></canvas><div class="fixed top-0 bottom-0 left-0 w-[42px] md:w-[54px] flex flex-col justify-between items-center z-[1] bg-[rgba(190,190,190,0.5)]"></div><div class="fixed top-0 bottom-0 left-0 w-[42px] md:w-[54px] flex flex-col justify-end items-center z-10 py-[20px] px-[10px] md:py-[30px] md:px-[15px]"><a href="https://www.originhq.com/"><svg width="100%" viewBox="0 0 52 224" xmlns="http://www.w3.org/2000/svg" class="fill-[#333] hover:fill-white transition-colors cursor-pointer"><path d="M45.2947 223.464L-2.55369e-07 223.464L-7.65283e-07 211.799L4.2081 211.799L4.2081 218.386L41.0866 218.386L41.0866 211.799L45.2947 211.799L45.2947 223.464ZM42.4006 202.419L40.3764 205.367L2.94744 179.834L4.97159 176.869L42.4006 202.419ZM22.6385 174.685C26.5211 174.685 29.8591 175.395 32.6527 176.816C35.4344 178.236 37.5769 180.183 39.0803 182.657C40.5717 185.119 41.3175 187.919 41.3175 191.056C41.3175 194.204 40.5717 197.016 39.0803 199.49C37.5769 201.952 35.4285 203.893 32.6349 205.313C29.8414 206.734 26.5092 207.444 22.6385 207.444C18.7559 207.444 15.4238 206.734 12.642 205.313C9.84848 203.893 7.70596 201.952 6.21449 199.49C4.71117 197.016 3.95951 194.204 3.95951 191.056C3.95951 187.919 4.71117 185.119 6.21449 182.657C7.70596 180.183 9.84848 178.236 12.642 176.816C15.4238 175.395 18.7559 174.685 22.6385 174.685ZM22.6385 180.118C19.6792 180.118 17.1875 180.597 15.1633 181.556C13.1274 182.503 11.5885 183.805 10.5469 185.463C9.49337 187.108 8.96662 188.972 8.96662 191.056C8.96662 193.151 9.49337 195.021 10.5469 196.666C11.5885 198.312 13.1274 199.614 15.1633 200.573C17.1875 201.52 19.6792 201.993 22.6385 201.993C25.5978 201.993 28.0954 201.52 30.1314 200.573C32.1555 199.614 33.6944 198.312 34.7479 196.666C35.7895 195.021 36.3104 193.151 36.3104 191.056C36.3104 188.972 35.7895 187.108 34.7479 185.463C33.6944 183.805 32.1555 182.503 30.1314 181.556C28.0954 180.597 25.5978 180.118 22.6385 180.118ZM-3.08861e-06 158.647L45.2947 158.647L45.2947 170.313L41.0866 170.313L41.0866 163.725L4.20809 163.725L4.20809 170.313L-2.5787e-06 170.313L-3.08861e-06 158.647ZM22.6385 104.128C26.5211 104.128 29.8591 104.838 32.6527 106.259C35.4344 107.679 37.5769 109.627 39.0803 112.101C40.5717 114.563 41.3175 117.362 41.3175 120.499C41.3175 123.648 40.5717 126.459 39.0803 128.933C37.5769 131.395 35.4285 133.336 32.6349 134.757C29.8414 136.177 26.5092 136.887 22.6385 136.887C18.7559 136.887 15.4238 136.177 12.642 134.757C9.84848 133.336 7.70596 131.395 6.21448 128.933C4.71117 126.459 3.95951 123.648 3.95951 120.499C3.95951 117.362 4.71117 114.563 6.21448 112.101C7.70596 109.627 9.84848 107.679 12.642 106.259C15.4238 104.838 18.7559 104.128 22.6385 104.128ZM22.6385 109.561C19.6792 109.561 17.1875 110.041 15.1633 111C13.1274 111.947 11.5885 113.249 10.5469 114.906C9.49337 116.551 8.96661 118.416 8.96661 120.499C8.96661 122.594 9.49337 124.464 10.5469 126.11C11.5885 127.755 13.1274 129.057 15.1633 130.016C17.1875 130.963 19.6792 131.436 22.6385 131.436C25.5978 131.436 28.0954 130.963 30.1314 130.016C32.1555 129.057 33.6944 127.755 34.7479 126.11C35.7895 124.464 36.3104 122.594 36.3104 120.499C36.3104 118.416 35.7895 116.551 34.7479 114.906C33.6944 113.249 32.1555 111.947 30.1314 111C28.0954 110.041 25.5978 109.561 22.6385 109.561ZM40.8203 97.714L13.5476 97.714L13.5476 92.5826L17.88 92.5826L17.88 92.2985C16.4122 91.8013 15.258 90.9254 14.4176 89.6706C13.5653 88.4041 13.1392 86.9718 13.1392 85.3738C13.1392 85.0423 13.151 84.6517 13.1747 84.2019C13.1984 83.7402 13.228 83.3792 13.2635 83.1188L18.3416 83.1188C18.2824 83.3319 18.2173 83.7107 18.1463 84.2552C18.0634 84.7997 18.022 85.3442 18.022 85.8887C18.022 87.1434 18.2883 88.262 18.821 89.2445C19.3418 90.2152 20.0698 90.9846 21.005 91.5527C21.9283 92.1209 22.9818 92.405 24.1655 92.405L40.8203 92.405L40.8203 97.714ZM40.8203 78.5245L13.5476 78.5245L13.5476 73.2156L40.8203 73.2156L40.8203 78.5245ZM9.33948 75.8434C9.33948 76.7667 9.03172 77.5598 8.41618 78.2227C7.78882 78.8737 7.04308 79.1992 6.17897 79.1992C5.30302 79.1992 4.55728 78.8737 3.94175 78.2227C3.31439 77.5598 3.0007 76.7667 3.0007 75.8434C3.0007 74.9201 3.31439 74.1329 3.94175 73.4819C4.55728 72.819 5.30302 72.4876 6.17897 72.4876C7.04308 72.4876 7.78882 72.819 8.41618 73.4819C9.03172 74.1329 9.33948 74.9201 9.33948 75.8434ZM51.6158 54.6387C51.6158 56.8049 51.3317 58.6692 50.7635 60.2317C50.1953 61.7824 49.4436 63.049 48.5085 64.0314C47.5734 65.0139 46.5495 65.7478 45.4368 66.2331L43.5547 61.6699C44.0755 61.3503 44.6259 60.9242 45.206 60.3915C45.7978 59.847 46.3009 59.1131 46.7152 58.1898C47.1295 57.2547 47.3366 56.0532 47.3366 54.5854C47.3366 52.5731 46.8454 50.91 45.8629 49.5961C44.8923 48.2821 43.3416 47.6252 41.2109 47.6252L35.8487 47.6252L35.8487 47.9625C36.4287 48.2821 37.0739 48.7438 37.7841 49.3475C38.4943 49.9393 39.1098 50.7561 39.6307 51.7978C40.1515 52.8394 40.4119 54.1948 40.4119 55.8638C40.4119 58.0182 39.9088 59.9595 38.9027 61.6877C37.8847 63.4041 36.3873 64.7653 34.4105 65.7715C32.4219 66.7658 29.9775 67.263 27.0774 67.263C24.1773 67.263 21.6915 66.7717 19.62 65.7893C17.5485 64.7949 15.9624 63.4337 14.8615 61.7054C13.7488 59.9772 13.1925 58.0182 13.1925 55.8283C13.1925 54.1356 13.4766 52.7684 14.0447 51.7268C14.6011 50.6851 15.2521 49.8742 15.9979 49.2942C16.7436 48.7024 17.4006 48.2466 17.9687 47.927L17.9687 47.5364L13.5476 47.5364L13.5476 42.334L41.424 42.334C43.7677 42.334 45.6913 42.8785 47.1946 43.9675C48.6979 45.0565 49.8106 46.5303 50.5327 48.3887C51.2547 50.2353 51.6158 52.3186 51.6158 54.6387ZM36.0085 54.6919C36.0085 53.165 35.6534 51.8747 34.9432 50.8212C34.2211 49.7559 33.1913 48.9509 31.8537 48.4064C30.5043 47.8501 28.8885 47.5719 27.0064 47.5719C25.1716 47.5719 23.5559 47.8442 22.1591 48.3887C20.7623 48.9332 19.6733 49.7322 18.892 50.7857C18.099 51.8392 17.7024 53.1413 17.7024 54.6919C17.7024 56.29 18.1167 57.6216 18.9453 58.687C19.7621 59.7523 20.8748 60.5572 22.2834 61.1017C23.692 61.6344 25.2663 61.9008 27.0064 61.9008C28.7938 61.9008 30.3622 61.6285 31.7116 61.084C33.0611 60.5395 34.1146 59.7346 34.8722 58.6692C35.6297 57.592 36.0085 56.2663 36.0085 54.6919ZM40.8203 35.214L13.5476 35.214L13.5476 29.905L40.8203 29.905L40.8203 35.214ZM9.33948 32.5329C9.33948 33.4562 9.03171 34.2492 8.41618 34.9121C7.78882 35.5632 7.04308 35.8887 6.17897 35.8887C5.30302 35.8887 4.55728 35.5632 3.94175 34.9121C3.31438 34.2492 3.0007 33.4562 3.0007 32.5329C3.0007 31.6096 3.31438 30.8224 3.94175 30.1714C4.55728 29.5085 5.30302 29.177 6.17897 29.177C7.04308 29.177 7.78882 29.5085 8.41618 30.1714C9.03171 30.8224 9.33948 31.6096 9.33948 32.5329ZM24.6271 17.4538L40.8203 17.4538L40.8203 22.7628L13.5476 22.7628L13.5476 17.6669L17.9865 17.6669L17.9865 17.3296C16.5424 16.7022 15.3823 15.7197 14.5064 14.3821C13.6304 13.0327 13.1925 11.3341 13.1925 9.28623C13.1925 7.4278 13.5831 5.8002 14.3643 4.40342C15.1337 3.00664 16.2819 1.92354 17.8089 1.15413C19.3359 0.384716 21.2239 8.6091e-06 23.473 8.51079e-06L40.8203 7.75251e-06L40.8203 5.30896L24.1122 5.30896C22.1354 5.30896 20.5907 5.82387 19.478 6.8537C18.3534 7.88353 17.7912 9.29807 17.7912 11.0973C17.7912 12.3284 18.0575 13.4233 18.5902 14.3821C19.1229 15.3291 19.9041 16.0807 20.9339 16.6371C21.9519 17.1816 23.183 17.4538 24.6271 17.4538Z"></path></svg></a></div><div class="relative ml-[42px] md:ml-[54px] min-h-screen flex flex-col"><div class="relative pt-[20px] md:pt-[30px] px-[15px] md:px-[5vw] lg:px-[10vw] flex flex-col"><div class="absolute z-10 top-0 left-0 bottom-0 right-0 bg-[#333] mix-blend-difference"></div><div class="absolute z-10 top-0 left-0 bottom-0 right-0 bg-[#eeeeeecc]"></div><article class="relative z-10 prose prose-invert max-w-[800px]"><div class="relative w-max z-10 text-[12px] leading-[14px] md:text-[14px] md:leading-[18px] lg:text-[16px] lg:leading-[18px] md:uppercase font-[500] md:font-[600] text-[#999] rounded-[16px]">Next Generation <br> Endpoint Security</div><h1 class="mt-[24px] md:mt-[32px] lg:mt-[42px] text-[5vw] leading-[5vw] md:text-[36px] md:leading-[36px] font-black text-[#333] mb-4 uppercase">Rehabilitating Registry Tradecraft with RegRestoreKey</h1><div class="text-[#666] mb-8 text-sm uppercase">2025-11-13<!-- --> - <!-- -->Michael Barclay</div><div class="
              bg-[#e3e3e3] py-2 md:py-4 px-2 md:px-4
              block text-[14px] leading-[18px] lg:text-[16px] lg:leading-[22px] font-[400] text-[#333]
              [&amp;_*]:first:mt-0 [&amp;_*]:last:mb-0
              [&amp;_h1]:my-6 [&amp;_h1]:text-[18px] [&amp;_h1]:leading-[24px] [&amp;_h1]:font-[600]
              [&amp;_h2]:my-6 [&amp;_h2]:text-[16px] [&amp;_h2]:leading-[20px] [&amp;_h2]:font-[500]
              [&amp;_p]:my-6 [&amp;_p]:text-[14px] [&amp;_p]:leading-[22px]
              [&amp;_table]:my-6 [&amp;_table]:w-full [&amp;_table]:border-collapse [&amp;_th]:text-left [&amp;_th]:font-[600] [&amp;_th]:text-[14px]
              [&amp;_th]:px-3 [&amp;_th]:py-2 [&amp;_td]:px-3 [&amp;_td]:py-2 [&amp;_th]:border [&amp;_td]:border [&amp;_th]:border-[#ccc] [&amp;_td]:border-[#ccc] [&amp;_td]:text-[14px]
              [&amp;_a]:text-[#000] [&amp;_a]:hover:text-[#666] [&amp;_a]:cursor [&amp;_a]:border-b-1 [&amp;_a]:border-dotted [&amp;_a]:border-[#000] [&amp;_a]:hover:border-[#666]
              [&amp;_li_p]:py-0 [&amp;_li_p]:my-0
              [&amp;_ul]:mx-4 [&amp;_ul]:my-1 [&amp;_ul]:list-disc [&amp;_ul]:text-[14px] [&amp;_ul>li]:py-1 [&amp;_ul>li]:px-2
              [&amp;_ol]:mx-4 [&amp;_ol]:my-1 [&amp;_ol]:list-decimal [&amp;_ol]:text-[14px] [&amp;_ol>li]:py-1 [&amp;_ol>li]:px-2
              [&amp;_blockquote]:my-6 [&amp;_blockquote]:pl-4 [&amp;_blockquote]:border-l-[3px] [&amp;_blockquote]:border-[#999] [&amp;_blockquote]:text-[#555] [&amp;_blockquote]:italic
              [&amp;_pre]:text-[14px] [&amp;_pre]:block [&amp;_pre]:p-[10px] [&amp;_pre]:overflow-auto [&amp;_pre]:rounded
              [&amp;_code]:text-[14px] [&amp;>p>code]:only:block [&amp;>p>code]:only:p-[10px] [&amp;>p>code]:only:bg-[#eeeeee] [&amp;>p>code]:only:overflow-auto
              overflow-hidden
            "><article><p>If you have ever attempted to test the limits of out-of-the-box EDR detection strategies, you have likely found ample evasion opportunities that revolve around simply re-implementing or tweaking some existing (and well-covered) tradecraft. While these are a win in isolation, they often only evade naive detection strategies that are focused on specific execution mechanisms or superficial characteristics of observable artifacts like files and processes. These minute modifications of existing tradecraft require a similarly minor change in defensive capability to account for them.</p><p>So what does it look like to move beyond these superficial evasion attempts and force defenders to make big changes in how they collect telemetry and write detection rules?</p><p>This post will take registry primitives as an example to explore how we can (a) think critically about the ways that EDR products detect specific procedures, (b) design tooling that takes away their ability to observe those procedures, and (c) force vendors to make meaningful changes to telemetry collection and detection strategies.</p><h1>Creating Services in the Status Quo</h1><p>I have chosen to focus on service creation in this post because it is straightforward, but still requires the caller to both create a new registry key AND several specific values within that key. EDR products have robust coverage for standard approaches to registry primitives, so this example forces us to think creatively if we hope to create a service in a way that removes crucial telemetry. This post is really about registry primitives, not services.</p><p>Win32 API methods like <a href="https://learn.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-createservicew"><code>CreateServiceW</code></a> (and its lower level RPC equivalent <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-scmr/6a8ca926-9477-4dd4-b766-692fab07227e"><code>RCreateServiceW</code></a>) result in the creation of a new registry key and values that represent the configuration details of a new service. While the latter is responsible for formally <em>registering</em> the service with the Service Control Manager (SCM) so that it can be started without a reboot, this is not a strictly necessary step. Calling any of the CreateService methods (whether at the RPC layer or above it) will also result in the generation of two well-known events in the Windows Security Event Log:</p><ul><li><a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4697">4697(S): A service was installed in the system.</a></li><li><a href="https://www.manageengine.com/products/active-directory-audit/kb/system-events/event-id-7045.html">7045: A new service was installed in the system.</a></li></ul><p>On reboot, the SCM will parse all of the subkeys under <code>HKLM\SYSTEM\CurrentControlSet\Services\</code> and register each service with the SCM, so we really only need to create the registry representation of a service to be able to use it for something like persistence. With that in mind, I am going to focus my efforts on registry interaction, rather than finding less obvious ways to make Win32 or RPC calls that will inevitably generate well-known signal in the Event Log regardless of how I call them.</p><p>In the vast majority of cases, application authors will create new keys and values in the registry through Win32 API calls like <a href="https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeyexw"><code>RegCreateKeyEx</code></a> and <a href="https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa"><code>RegSetValueEx</code></a> (or their Native API and system call equivalents). If you were to consider this the only means to create new keys and values, the landscape for evasion is relatively limited. But some additional consideration of <em>how</em> EDR products observe these operations yields some additional ground for research.</p><h1>Observing Registry Interaction in the Status Quo</h1><p>If we move past the approach where we call <code>CreateService/RCreateService</code> and assume that we won’t have 4697 or 7045 events to observe, we have to identify a means to observe the creation of arbitrary registry keys and values to observe service creation. I will discuss the two most common ways to collect this telemetry—<a href="https://www.preludesecurity.com/blog/event-tracing-for-windows-etw-your-friendly-neighborhood-ipc-mechanism">Event Tracing for Windows (ETW)</a> and registry callback routines in the kernel. There are plenty of readily available resources online that discuss the structure of both of these telemetry generation mechanisms, so I will only describe the ways that EDR agents frequently use them.</p><h3>Microsoft-Windows-Kernel-Registry ETW</h3><p>The primary ETW provider for registry events is a kernel provider named <code>Microsoft-Windows-Kernel-Registry</code> (<code>{70eb4f03-c1de-4f73-a051-33d13d5413bd}</code>), which generates the following common events (among others):</p><table><thead><tr><th>CreateKey</th><th>EnumerateValueKey</th></tr></thead><tbody><tr><td>SetValueKey</td><td>QueryMultipleValueKey</td></tr><tr><td>OpenKey</td><td>SetInformationKey</td></tr><tr><td>DeleteKey</td><td>FlushKey</td></tr><tr><td>QueryKey</td><td>CloseKey</td></tr><tr><td>DeleteValueKey</td><td>QuerySecurityKey</td></tr><tr><td>QueryValueKey</td><td>SetSecurityKey</td></tr><tr><td>EnumerateKey</td><td></td></tr></tbody></table><p><code>Microsoft-Windows-Kernel-Registry</code> also provides a collection of performance tracking events with dizzyingly long template names and a limited number of fields documented in the manifest. I will discuss some of these events later in the post, but the above list represents the majority of ETW events that your average EDR sensor would ever think to collect.</p><p>When a sensor creates an Event Tracing Session to ingest ETW events, it must specify what subset of events it wishes to receive and, under certain circumstances, the verbosity of those events. Sensor developers must weigh the performance hit of collecting a given event with the value that it provides to the entire product’s observation and detection capabilities.</p><p>Luckily, the act of modifying which events a trace session ingests is well-documented for common providers. However, you are stuck with whatever Microsoft has decided to include in those events. Any additional context needed to make sense of that event data must be collected elsewhere and correlated in some way.</p><h1>Registry Callback Routines</h1><p>If we don’t want to (or can’t) collect registry telemetry from ETW in user mode, we will have to install a kernel driver and register a registry callback routine. These routines specify a type of interaction with the registry (creating a key, writing a value, etc.) and invoke a callback function when that type of interaction is handled by the relevant kernel driver.</p><p>When you want to register a kernel callback routine for a registry operation, you use the <code>CmRegisterCallback</code> NT API function. When you call this function, you must supply a pointer to the RegistryCallback routine you wish to register, which is of the type <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nc-wdm-ex_callback_function"><code>EX_CALLBACK_FUNCTION</code></a>.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://cdn.prod.website-files.com/686bd4d91556b08defea7eb6/6914eff045de3123236be1ab_image3.png" alt=""></p><p>If we look at the parameters for these callback functions, we see that the second parameter (<code>Argument1</code>) is a value that specifies the type of registry operation we wish to observe and intercept in the kernel. This value must be sourced from the <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ne-wdm-_reg_notify_class"><code>REG_NOTIFY_CLASS</code></a> enumeration, which is defined by Microsoft.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://cdn.prod.website-files.com/686bd4d91556b08defea7eb6/6914f00d814aeea5f23e05be_image7.png" alt=""></p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://cdn.prod.website-files.com/686bd4d91556b08defea7eb6/6914f025cc4b390f64af8d3d_image6.png" alt=""></p><p>Taking a look at the <code>REG_NOTIFY_CLASS</code> constants defined by Microsoft, we can see that they correspond to many of the types of registry actions that we are familiar with – creating a key (<code>RegNtPreCreateKey</code>/<code>RegNtPostCreateKey</code>), setting the value of a key (<code>RegNtSetValueKey</code>/<code>RegNtPreSetValueKey</code>), and others.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://cdn.prod.website-files.com/686bd4d91556b08defea7eb6/6914f03fad1ce1578775fc47_image12.png" alt=""></p><p>Each <code>REG_NOTIFY_CLASS</code> constant is associated with a specific structure that will be returned to the driver that registered a callback using that constant.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://cdn.prod.website-files.com/686bd4d91556b08defea7eb6/6914f055091e292e3e83bd37_image10.png" alt=""></p><p><code>REG_CREATE_KEY_INFORMATION</code> structures are returned to drivers when their registered callbacks use the <code>RegNtPreCreateKey</code> or <code>RegNtPreCreateKeyEx</code> constants</p><p>We have reached the first set of decision points that sensor developers must contend with when collecting registry telemetry via kernel callbacks—<em>Which operations do I care about enough to pay for in resources, bandwidth, and storage?</em></p><p>Beyond pre-selecting which registry operations they want to observe, EDR sensor developers must implement the logic that decides what to do with an intercepted operation. Imagine attempting to identify a straightforward persistence technique like run key persistence via registry callback routines. As part of your <code>RegistryCallback</code> routine, you have to:</p><ul><li>Identify which type of operation an event represents by inspecting the <code>REG_NOTIFY_CLASS</code> constant value.</li><li>If it is a <code>RegNtSetValueKey</code>, <code>RegPreNtSetValueKey</code>, or <code>RegPostNtSetValueKey</code> notification, identify which key’s value is being written by inspecting the <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_reg_set_value_key_information"><code>REG_SET_VALUE_KEY_INFORMATION</code></a> or <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_reg_post_operation_information"><code>REG_POST_OPERATION_INFORMATION</code></a> structure provided to the <code>RegistryCallback</code> routine.</li><li>If that key is one of several “run keys”, take some action.</li></ul><p>If we wanted to observe registry key creation and registry value writes via kernel callbacks, we might conceptualize it using something like the below diagram. On the left are example Win32 API calls that will send events to any driver that has registered a registry callback routine using the <code>REG_NOTIFY_CLASS</code> constant from the middle column. The receiving driver would then be presented with the details defined by the struct in the third column.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://cdn.prod.website-files.com/686bd4d91556b08defea7eb6/6914f0853b43931afd5970da_image9.png" alt=""></p><p>Specific ways of interacting with the registry (represented by specific Win32 API calls) can be observed by registering a registry callback routine using the relevant <code>REG_NOTIFY_CLASS</code> constant</p><p>There may be additional callback logic implemented by the intercepting driver at this point, but the danger of adding overheard to an already hot code path requires as much brevity as possible. Remember, you are collecting registry telemetry as <em>overhead</em> to other collection priorities as well.</p><p>If we have to make additional function calls to query the registry object in question and inspect its characteristics, it’s not all that difficult to introduce significant demands on the system if this logic gets too complex. On the other side of the distributed systems that we call EDR, logging and shipping everything without doing as much as possible on the sensor/agent side can balloon server and storage costs very quickly.</p><h1>Reacting to the Status Quo</h1><p>There are a lot of decisions to make when answering seemingly simple questions like “how do I know when a registry key has been created?”.</p><p>There are multiple “sources” to identify and instrument collection from, each with their own set of configurable parameters far beyond what I have presented above. Your answer also has to fit into a much larger serialization, processing, shipping, and cloud pipeline with its own set of requirements and prior content expectations. Each decision you make creates a specific path to evasion based on how that change interacts with the system as a whole. Like Virilio said, “when you invent the ship, you also invent the shipwreck”.</p><p>While there isn’t necessarily a wrong answer to this question, there are more or less risky decisions from a visibility perspective. I could register a registry callback with the <code>RegNtPreCreateKey</code> or <code>RegNtPostCreateKey</code> <code>REG_NOTIFY_CLASS</code> constant and call it a day, but a discerning attacker would be right to question whether that is the only operation that could result in the creation of a new registry key.</p><h3>Investigating Alternative Registry Operations</h3><p>Let’s assume that our target EDR sensor collects every single event generated by a registry callback registered with the <code>RegNtPreCreateKeyEx</code> or <code>RegNtPreSetValueKey REG_NOTIFY</code> constant. This should generate an event any time that a thread calls the <code>ZwCreateKey</code> or <code>ZwSetValueKey</code> native functions. Some form of this collection strategy seems to be the norm for current EDR products.</p><p>With this in mind, we can start looking at Microsoft docs for any additional functions that seem like they might change the contents of the registry or any <code>REG_NOTIFY</code> constants that suggest some other kind of poorly documented operation is possible. Our goal is to shift the collection requirements of defenders and force them to re-evaluate the tradeoffs they’ve already made peace with.</p><p>There are several functions in the <a href="https://learn.microsoft.com/en-us/windows/win32/api/winreg/">winreg header file</a> that might allow us to create and/or replace keys and values in the registry judging by name alone: <code>RegRestoreKey</code>, <code>RegCopyTree</code>, <code>RegLoadKey</code>, <code>RegReplaceKey</code>. This post is primarily about using <code>RegRestoreKey</code>, but it’s important to think through the distinctions between these functions.</p><table><thead><tr><th>Win32 API</th><th>Description</th></tr></thead><tbody><tr><td>RegRestoreKey</td><td>Takes a hive file on disk and overwrites the child sub-keys and values of a targeted key with the data in the supplied hive file.</td></tr><tr><td>RegCopyTree</td><td>Replaces one key (and its sub-keys/values) with another key and its sub-keys/values.</td></tr><tr><td>RegLoadKey</td><td>Similar to RegRestoreKey, but the targeted key must be a root key.</td></tr><tr><td>RegReplaceKey</td><td>Similar to RegRestoreKey, but instead of copying over the existing sub-key and its children, it replaces the file backing that sub-key on disk. This change does not take effect until the next reboot.</td></tr></tbody></table><p><code>RegRestoreKey</code> is an obvious choice for a first attempt because it allows us to target an arbitrary key and replace its child elements with content of our choosing (defined in a hive file). If we want to call this function, we will need to prepare a hive file that contains the key and value data that we want to use to overwrite some target key and its children. We can specify the sub-key we want to overwrite by supplying a handle <code>RegRestoreKey</code> via the <code>hKey</code> parameter.</p><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span>LSTATUS RegRestoreKeyW(</span></span>
<span class="line"><span>	[in] HKEY    hKey,</span></span>
<span class="line"><span>	[in] LPCWSTR lpFile,</span></span>
<span class="line"><span>	[in] DWORD   dwFlags</span></span>
<span class="line"><span>);</span></span></code></pre></div><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://cdn.prod.website-files.com/686bd4d91556b08defea7eb6/6914f15bd716546084e106e6_image14.png" alt=""></p><h3>Creating Services with RegRestoreKey</h3><p>While restoring a hive file from disk may be straightforward in isolation, there are some logistical hurdles involved with choosing a target sub-key and ensuring that your hive will not interrupt the normal behavior of the system when it is “restored”.</p><h4>Picking a Target Key</h4><p>Since we want to create a new service, we will need to create a new sub-key under <code>HKLM\CurrentControlSet\Services</code> and several registry values within that sub-key to define its configuration details. The resulting services sub-key should look something like this when we are done:</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://cdn.prod.website-files.com/686bd4d91556b08defea7eb6/6914f17c7116dee9b5beac99_image1.png" alt=""></p><p>Since <code>RegRestoreKey</code> takes a handle to the sub-key we want to overwrite, we actually have to pass a handle to the *parent* key of the sub-key we want to create. The sub-key has to already exist to get a handle to it. In our example, this means we must overwrite all of the service sub-keys starting from their common parent sub-key, <code>HKLM\CurrentControlSet\Services</code>.</p><p>In theory, you could create a dummy key just for the new service and target that for restore, but you would still generate a kernel callback event if there is a <code>RegNtPreCreateKeyEx</code> callback registered. For our purposes, we want to avoid creating a new sub-key in this registry path through <code>RegCreateKey</code> calls as we know that most EDR products are able to observe these operations.</p><h4>Constructing a Hive File to Restore</h4><p>The trick with creating our hive file is that its content will overwrite everything beneath that key — we are stuck restoring at the Services sub-key. So if we do not include all of its current child objects (keys and values) in our hive file, there is a potential to interrupt the normal behavior of the system. If our hive file only contains the key data for our new services key it will overwrite the main Services sub-key in place, deleting all previously installed services and leaving our new service’s configuration values as its only child objects.</p><p>Instead, we have to preserve the current state of all of the keys and values under <code>HKLM\CurrentControlSet\Services</code> before adding a new key and values at the appropriate place in the hierarchy. This now modified snapshot of the services installed in the registry must be saved as a hive file so a handle to it can be passed as a parameter to <code>RegRestoreKey</code>.</p><p>You can create a hive file in the regedit GUI, using the native reg utility, or by calling one of the <code>RegSaveKeyEx</code>* Win32 API methods. However, we will need to figure out how to parse and modify the resulting hive file in some way.</p><p>We have several options here:</p><ol><li><strong>Do everything manually (yuck)</strong><ol><li>Export a hive file on the target system from the Services key (<code>RegSaveKey</code>)</li><li>Transfer to attacker-controlled system</li><li>Load hive file on attacker-controlled system</li><li>Add new service key and export</li><li>Transfer modified hive file to target system</li><li>Restore data from modified hive file on target system (<code>RegRestoreKey</code>)</li></ol></li><li><strong>Export locally and modify exported file (no transfer)</strong><ol><li>Export a hive file from the Services key (<code>RegSaveKey</code>)</li><li>Parse resulting hive file and add new key and values in place in the hive file</li><li>Restore data from modified hive file (<code>RegRestoreKey</code>)</li></ol></li><li><strong>Parse the Services key, create hive file via Offline Registry Library</strong><ol><li>Create an in-memory representation of a hive file using <code>ORCreateHive</code></li><li>Open a handle to <code>HKLM\CurrentControlSet\Services</code>, enumerate its sub-keys, and all of their respective values</li><li>Copy data from each sub-key and value, creating their equivalent in the in-memory hive file via <code>ORCreateKey</code> and <code>ORSetValue</code></li><li>Create an additional key for our new service via <code>ORCreateKey</code></li><li>Create the values for our new service within that key via <code>ORSetValue</code></li><li>Write the offline registry hive to disk via <code>ORSaveHive</code></li></ol></li></ol><p>The manual option is logistically difficult and annoying to carry out, so we will opt for some way of crafting the hive file programmatically on the target system. One of my teammates sent me a publicly available means of carrying out the second approach, which can be found <a href="https://github.com/tccontre/Reg-Restore-Persistence-Mole/tree/main.">here</a>.</p><p>This POC follows the set of operations I laid out above for option #2 and <a href="https://github.com/tccontre/Reg-Restore-Persistence-Mole/blob/8db0c37792073f3e62b8875b268806c8a6ec4a37/RegReeper/RegReeper.cpp#L73">saves a hive file</a> for the <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Run</code> sub-key before adding a new value that references <code>C:\Users\Public\&lt;RANDOM_FILENAME&gt;.exe</code>. It then uses this modified hive file to call <code>RegRestoreKey</code> and overwrite the targeted key (HKCU run key) with the old data AND your new value.</p><p>We could extend this POC to implement more detailed hive file parsing and modification logic that accounts for services, but there are some small downsides to this approach. First, a call to <code>RegSaveKey</code> could potentially generate kernel callback notifications for a discerning EDR driver (assuming they have registered a callback with either of the <code>RegNtPostSaveKey</code> or <code>RegNtPreSaveKey</code> REG_NOTIFY constants). This wasn’t a problem for the original author because they were specifically targeting Sysmon, which does not register this registry callback routine. However, many commercial EDR sensors will provide serialized events related to <code>RegSaveKey</code> calls.</p><p>Option #3 uses the <a href="https://learn.microsoft.com/en-us/windows/win32/devnotes/offline-registry-library-portal">Offline Registry Library</a> to copy the already existing registry objects residing within the target key (the Services key) to an in-memory representation of a hive file. After building this hive file key by key and value by value, we can then insert our own sub-key and values before exporting it to a file. Because we are not calling <code>RegSaveKey</code>, we don’t have to worry about that set of callback notifications. If implemented correctly, we should only have to worry about observation when we call <code>RegRestoreKey</code>.</p><h3>Using the Offline Registry Library for Stealthier Hive File Creation</h3><p>While the additional step of rebuilding our own representation of the Services sub-key and its children in memory may sound daunting, it’s essentially an iterative copy/paste exercise using Win32 APIs from the [<a href="https://learn.microsoft.com/en-us/windows/win32/devnotes/offline-registry-library-portal">Offline Registry Library</a> and the <a href="https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-functions">standard registry library</a>.</p><ol><li><strong>Enumerate all currently installed services on the system, saving their names and configuration details as you go:</strong><ol><li>Open a handle to the <code>HKLM\SYSTEM\CurrentControlSet\Services</code> key (<code>RegOpenKeyExW</code>).</li><li>Enumerate all sub-keys of the <code>\Services</code> key (<code>RegEnumKeyEx</code>).</li><li>Open a handle to each sub-key (<code>RegOpenKeyExW</code>).</li><li>Enumerate each sub-key’s values (<code>RegEnumValueW</code>).</li><li>Query each value to get its name and current value (<code>RegQueryValueEx</code>).</li></ol></li><li><strong>Prepare an in-memory representation of the <code>HKLM\SYSTEM\CurrentControlSet\Services</code> key and its descendant keys and values:</strong><ol><li>Create an empty offline registry hive (<code>ORCreateHive</code>).</li><li>Write each saved service sub-key to the offline registry hive (<code>ORCreateKey</code>).</li><li>Create each service key’s relevant values in its offline equivalent (<code>ORSetValue</code>).</li><li>Make desired changes to the offline hive. In our example, this involves adding a new key and set of values that represent our new service (<code>ORCreateKey</code> and <code>ORSetValue</code>).</li></ol></li><li><strong>Write the offline registry hive to disk (<code>ORSaveHive</code>).</strong></li><li><strong>Reuse the original handle to the <code>HKLM\SYSTEM\CurrentControlSet\Services</code> key, along with the path to the newly written hive file created in memory, to overwrite the current content of that key and its descendants (<code>RegRestoreKeyW</code>).</strong><ol><li>In my testing, it was necessary to supply the <code>REG_FORCE_RESTORE</code> flag as part of the <code>dwFlags</code> parameter to <code>RegRestoreKeyW</code>.</li><li>In order to make this call, you must be able to enable the <code>SE_RESTORE_NAME</code> and <code>SE_BACKUP_NAME</code> privileges.</li><li>The <code>lpFile</code> parameter must be a valid path to a file on disk, but there is lots of room for creativity here.</li></ol></li></ol><p>There are obviously a few peculiarities surrounding where and how to target your registry restoration operations so that you don’t overwrite registry data unnecessarily. Aside from that, we are just copying, modifying, and overwriting the content of the registry starting from a specific key. The way this approach interacts with common detection strategies for registry-based tradecraft is much more interesting than the approach I outlined above.</p><div class="w-embed w-iframe w-script"><div style="padding:56.25% 0 0 0;position:relative"><div src="https://player.vimeo.com/video/1136252343?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479" frameborder="0" allow="autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media; web-share" referrerpolicy="strict-origin-when-cross-origin" style="position:absolute;top:0;left:0;width:100%;height:100%" title="Video" data-original-tag="iframe">
  
  
  
  <link rel="canonical" href="https://player.vimeo.com/video/1136252343">
  
  
  
  <title>Service Restoration Demo on Vimeo</title>
  
  <link rel="modulepreload" href="https://f.vimeocdn.com/p/4.46.30/js/player.module.js" crossorigin="anonymous">
  <link rel="modulepreload" href="https://f.vimeocdn.com/p/4.46.30/js/vendor.module.js" crossorigin="anonymous">
  <link rel="preload" href="https://f.vimeocdn.com/p/4.46.30/css/player.css" as="style">
<link rel="stylesheet" href="https://f.vimeocdn.com/p/4.46.30/css/player.css">




<div class="vp-placeholder" style="visibility: visible;">
    

    

    
        
    

    <div class="vp-placeholder-thumb"></div>
    <div class="vp-placeholder-carousel"></div>
    
    
</div>

<div id="player" class="player"></div>











</div></div></div><div class="p-4 bg-[#eee]"><div class="flex flex-row gap-1 mb-2"><div class="w-[20px]"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="100%" fill="currentColor"><path d="M479.89-296.39q13.23 0 22.01-8.68 8.79-8.68 8.79-21.9 0-13.22-8.68-22.01-8.68-8.79-21.9-8.79-13.23 0-22.01 8.68-8.79 8.69-8.79 21.91t8.68 22.01q8.68 8.78 21.9 8.78Zm-27.77-134.38h55.96v-238.31h-55.96v238.31Zm-110.43 283.5L147.27-341.58v-276.73l194.31-194.42h276.73l194.42 194.31v276.73L618.42-147.27H341.69Zm23.84-55.96h229.34l161.9-162.3v-229.34l-162.12-161.9H365.31L203.23-594.65v229.34l162.3 162.08ZM480-480Z"></path></svg></div><div class="text-[14px] font-[600]">Extremely important: Please read this part</div></div><div class="text-[14px] font-400">Please note that overwriting every single service key and its values based on iterative parsing and recreation is almost CERTAIN to lead to stability issues. This is likely due to the criticality of services to the driver loading and startup process during boot. DO NOT run the linked proof of concept on a system that you are not prepared to re-image or restore from a stable snapshot. I am releasing this tool in a "broken", but still demonstrative, state on purpose. If you want to use this in a non-POC context, you will need to make the modifications yourself.<br><br>This WILL happen to your system if you overwrite the entirety of the<!-- --> <code>HKLM\SYSTEM\CurrentControlSet\Services\</code> registry key. This is almost certainly the result of supplying the <code>REG_FORCE_RESTORE</code> <!-- -->flag to <code>RegRestoreKey</code>. It is likely possible to make this work, but I will leave that work up to you. In general, I would suggest simply choosing a different target registry key to overwrite.</div></div><h1>Quantifying Evasion</h1><p>Let’s step back and think about what we have accomplished:</p><p><strong>When in possession of a token with the <code>SE_RESTORE_NAME</code> and <code>SE_BACKUP_NAME</code> privileges enabled, we can create or modify an arbitrary registry key without making calls to <code>RegCreateKey</code>, <code>RegSetValue</code>, or any of their lower level equivalents that generate commonly collected registry telemetry.</strong></p><h3>Registry Callback Routines</h3><p>From the earlier discussion of registry callback routines, we know that EDR agents must make specific choices about which events are <em>valuable</em> enough to collect at scale. We also know that the “typical” collection strategy outlined for the sake of this example would not observe calls to <code>RegRestoreKey</code> because it generates an entirely different type of callback notification that isn’t covered by callbacks registered with any of the <code>RegNtPre/PostCreateKey*</code> or <code>RegNtPre/PostSetValueKey</code> constants. Drivers would need to also register a callback with either <code>RegNtPreRestoreKey</code> or <code>RegNtPostRestoreKey</code> to observe calls to <code>RegRestoreKey</code>.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://cdn.prod.website-files.com/686bd4d91556b08defea7eb6/6914f6840d337d347aa2d6eb_image8.png" alt=""></p><p><a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ne-wdm-_reg_notify_class">Link</a></p><p>Even if a driver had registered callbacks related to saving registry hives, which are commonly used to combat credential theft tradecraft, my proof of concept never saves a copy of an existing key as a hive file. Instead, the offline registry library allows us to <a href="https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsavekeyexw">skip calls like [<code>RegSaveKeyEx</code>]</a> by recreating the keys we wish to overwrite in an in-memory representation.</p><p>Callbacks registered with the above two <code>REG_NOTIFY_CLASS</code> constants are provided with a <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_reg_restore_key_information"><code>REG_RESTORE_KEY_INFORMATION</code></a> struct that provides information about the restore operation itself. Of particular note is the Flags field that can communicate when the <code>REG_FORCE_RESTORE</code> flag was supplied, which was required for me to get my proof of concept to work reliably.</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://cdn.prod.website-files.com/686bd4d91556b08defea7eb6/6914f6acddc7c382b2e684be_image13.png" alt=""></p><h3>ETW</h3><p>There may well be additional ETW providers that generate telemetry related to registry restore operations, but I will focus on <code>Microsoft-Windows-Kernel-Registry</code> (<code>{70eb4f03-c1de-4f73-a051-33d13d5413bd}</code>) as it is the most common. The list of events I provided earlier in this post intentionally left out a few interesting opportunities for detection. In addition to the succinctly named events like <code>CreateKey</code> or <code>DeleteKey</code>, there is a list of keywords with extremely long names that suggest they are intended primarily for performance tracking (ex. <code>Thisgroupofeventstrackstheperformanceof</code>...).</p><p>There are two events that appear to be directly related to registry restoration operations based on their names. The below shows the definition of these events in XML manifest for the Microsoft-Windows-Kernel-Registry ETW provider:</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://cdn.prod.website-files.com/686bd4d91556b08defea7eb6/6914f80385ac9ecaaf1ad9a5_a50fd03e.png" alt=""></p><p>`Thisgroupofeventstrackstheperformanceofrestoringhives.Start` and `Thisgroupofeventstrackstheperformanceofrestoringhives.Stop` declared</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://cdn.prod.website-files.com/686bd4d91556b08defea7eb6/6914f80385ac9ecaaf1ad9a8_f72caffc.png" alt=""></p><p>Fields for the `Thisgroupofeventstrackstheperformanceofloadinghives.Start` event, which uses the same template as `…performanceofmountinghivesfromexistingfiles…` events</p><p class="bg-[#ffffffff] p-[10px] border border-[#ccc] shadow-[2px_2px_0_0px_#00000011]"><img src="https://cdn.prod.website-files.com/686bd4d91556b08defea7eb6/6914f80385ac9ecaaf1ad9ab_e826a836.png" alt=""></p><p>Fields for the `Thisgroupofeventstrackstheperformanceofloadinghives.Stop` event</p><p>While testing, I was able to confirm the lack of <code>CreateKey</code> or <code>SetValue</code> events. However, I was able to see several ETW events related to the hive file itself.</p><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span>**Microsoft-Windows-Kernel-Registry/RegPerfTaskHiveRestore/Start**</span></span>
<span class="line"><span>ThreadID="16,816" </span></span>
<span class="line"><span>ProcessorNumber="1" </span></span>
<span class="line"><span>SourceFile="\Device\HarddiskVolume3\Users\mbarc\AppData\Local\Temp\restore_hive_runkey.hive" </span></span>
<span class="line"><span>Flags="8" // Flags == 0x00000008L == REG_FORCE_RESTORE</span></span></code></pre></div><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span>**Microsoft-Windows-Kernel-Registry/RegPerfTaskHiveRestore/Stop**</span></span>
<span class="line"><span>ThreadID="16,816" </span></span>
<span class="line"><span>ProcessorNumber="1" </span></span>
<span class="line"><span>DURATION_MSEC="6.154" </span></span>
<span class="line"><span>StatusCode="0"</span></span></code></pre></div><div><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span>**Microsoft-Windows-Kernel-Registry/RegPerfTaskHiveMount/RegPerfOpHiveMountBaseFileMounted**</span></span>
<span class="line"><span>ThreadID="16,816" </span></span>
<span class="line"><span>ProcessorNumber="1" </span></span>
<span class="line"><span>HiveFilePath="\Device\HarddiskVolume3\Users\mbarc\AppData\Local\Temp\restore_hive_runkey.hive" </span></span>
<span class="line"><span>FileSize="4,096" </span></span></code></pre></div><h1>How useful is this?</h1><p>The extent to which any tool or approach is <em>evasive</em> is always going to rely entirely on the nature of the detection strategies it seeks to evade. The approach I’ve outlined above and demonstrated in the linked proof of concept code is only evasive insofar as EDR products do not collect telemetry related to restore operations. At time of writing, I have not encountered an EDR product that presents any restore-related events to an end user, nor have I seen an alert related to this behavior in my limited testing.</p><p>However, the raw telemetry needed to at least observe attempts to restore data from a registry hive does exist in both user mode and kernel mode. Whether or not those events are sufficient to develop a working detection strategy is an additional question, but visibility is entirely possible already. Its absence is a design decision, not a technical limitation. While I focused on a specific use case for registry interaction (service creation) in this post, the approach reawakens any tradecraft that involves creating, modifying, or deleting a registry key or value. We often consider registry-centric persistence techniques like run keys and services to be unworthy of specific attention because they are “solved problems”, but I’m hoping that this post is a reminder that what is old is always new again.</p><h1>Reacting to Innovation</h1><p>Realistically, the usefulness of this approach for evasion is a matter of how long it takes for EDR vendors to address it and the extent to which their solution is thorough.</p><p>An ETW-centric strategy would likely require additional work from Microsoft, since the performance tracking events mentioned above represent the absolute bare minimum to identify a restoration operation. While I was able to see performance events from Microsoft-Windows-Kernel-Registry when I ran my PoC code, these events exclusively describe the hive file that is being used for the restore operation. They do not include information about which key is being targeted.</p><p>On the other hand, the registry callback routine telemetry is a bit more verbose and likely lends itself more to a thorough detection strategy, as defined by the <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_reg_restore_key_information"><code>REG_RESTORE_KEY_INFORMATION</code></a> struct. As long as you can follow the pointer to the registry key object that was targeted and query additional information about it, you can write a detection strategy that considers the <em>purpose</em> of the restore operation.</p><p>Regardless of what Windows provides, end users of EDR products have very few options to address this gap if their chosen agent doesn’t already observe and report information about registry restore operations. While there are tons of publicly available tools that help you configure and start trace sessions to collect events from ETW providers on your own, attempting to instrument this at an environment-wide level is the equivalent of building your own EDR. This isn’t so much a data volume problem—it’s a data selection problem.</p><h1>Vids &amp; Dids</h1><p><strong>PoC code is available</strong> <a href="https://github.com/preludeorg/Regstoration"><strong>here</strong></a><strong>.</strong></p><h1>A very important disclaimer about my example code!</h1><p>The linked PoC is INTENTIONALLY BROKEN! While it can successfully overwrite all of the services keys and their values without generating traditional key creation and value write telemetry, this is a wildly unstable and unpredictable action to take and CONSISTENTLY leads to a blue screen. If you would like to test it for yourself I would suggest either:</p><ul><li>restoring to a dummy key you create for testing so that you don’t overwrite the real services key (no arguments)</li><li>running the tool unmodified on a system that you KNOW you will be able to re-image or restore from snapshot (supply the path to the real services key)</li></ul><p>The tool will attempt to restore the services data in the hive file to <code>HKLM\\Software\\Test</code> if no arguments are supplied. If you would like to attempt to overwrite the real services key, you can supply that path as a string.</p><h1>Restoring Run Keys</h1><p>While I have chosen to release a PoC for this approach specific to a use case that is NOT useful in an operational context due to instability, the below video shows the addition of a registry run key value via a registry restore operation. This use case has not led to any observable instability on the system because system critical drivers do not rely on the integrity of services and their configuration values. It is likely possible to do the same with the services use case, but you will have to figure out which values are causing instability problems and how to account for them.</p></article></div></article></div><div class="relative py-[20px] md:py-[30px] px-[15px] md:px-[5vw] lg:px-[10vw] text-white flex flex-col"><div class="absolute z-10 top-0 left-0 bottom-0 right-0 bg-[#333] mix-blend-difference"></div><div class="absolute z-10 top-0 left-0 bottom-0 right-0 bg-[#eeeeeecc]"></div><div class="relative z-10 flex flex-col gap-[30px] md:gap-[40px]"><div class="relative z-10 flex flex-col gap-[10px]"><span class="block text-[12px] leading-[12px] lg:text-[14px] lg:leading-[14px] uppercase font-[400] text-[#666]">Blog</span><div class="relative z-10 flex flex-col md:flex-col gap-[10px] md:gap-[10px]"><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/process-preluding"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Process Preluding: Child Process Injection Before The Story Begins</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">John Uhlmann</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/praxis-announcement"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Introducing Praxis: An Adversarial Framework for Exploring Computer Use Agents on Endpoint</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">David Kaplan</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/semantic-protocol-confusion"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Semantic Protocol Confusion: When My LLM Thinks It's a Web Browser</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">David Kaplan</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/securitytrace-etw-ppl"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Check Your Privilege: The Curious Case of ETW's SecurityTrace Flag</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Connor McGarr</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/cua-kit-attacking-the-intelligent-endpoint"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">cua-kit: Attacking the Intelligent Endpoint</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Matt Hand</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/era-of-semantic-security"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">The Era of Semantic Security: Computer Use Agents and the End of Signatures</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Matt Hand</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/rehabilitating-registry-tradecraft-with-regrestorekey"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Rehabilitating Registry Tradecraft with RegRestoreKey</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Michael Barclay</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/escaping-loader-locks-with-postprocessinitroutine"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Escaping Loader Locks with PostProcessInitRoutine</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">John Uhlmann</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/time-for-the-next-generation-of-endpoint-security"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">It's (Finally) Time For The Next Generation of Endpoint Security</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Spencer Thompson</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/windows-arm64-internals-deconstructing-pointer-authentication"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Windows ARM64 Internals: Deconstructing Pointer Authentication</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Connor McGarr</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/unexpectedly-out-of-context-detecting-a-lockbit-sample"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Unexpectedly Out-Of-Context: Detecting a LockBit Sample</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Michael Barclay</span></a><a class="flex flex-col items-stretch gap-[5px] w-full md:max-w-[800px] p-[10px] cursor-pointer border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]" href="https://www.originhq.com/blog/introducing-runtime-memory-protection"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Introducing Runtime Memory Protection</span><span class="block text-[11px] uppercase leading-[11px] font-[500] text-[#666]">Research Team</span></a></div></div><div class="relative z-10 flex flex-col gap-[10px] max-w-[800px]"><span class="block text-[12px] leading-[12px] lg:text-[14px] lg:leading-[14px] uppercase font-[400] text-[#666]">Team</span><div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-1"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Michael Barclay</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Lewis Zimmerman</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Mitchell Turner</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Tyler Holmwood</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Jeff Hiner</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Matt Hand</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Matthew Palma</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">John Uhlmann</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Connor McGarr</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Isaac Chen</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Rose Singletary</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Robin Williams</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Mahina Kaholokula</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Keith Robertson</span><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">David Kaplan</span></div><p class="my-4 block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">Backed by Sequoia Capital, Brightmind Partners, IA Ventures and others</p><a href="https://www.originhq.com/jobs" class="w-max text-[10px] leading-[10px] md:text-[11px] md:leading-[11px] uppercase font-[500] px-3 py-2 rounded-[20px] cursor-pointer text-[#000] border border-[#ccc] bg-[#ccc] hover:bg-white hover:border-[#000] hover:shadow-[2px_2px_0_0px_#00000033]">explore our open job postings.</a></div><div class="relative z-10 flex flex-col gap-[10px] max-w-[800px]"><svg class="w-[60px] md:w-[70px]" viewBox="0 0 224 52" fill="#666" xmlns="http://www.w3.org/2000/svg"><path d="M-1.07586e-05 45.2947V0H11.6655V4.2081H5.07811V41.0866H11.6655V45.2947H-1.07586e-05ZM21.0449 42.4006L18.0975 40.3764L43.6301 2.94744L46.5953 4.97159L21.0449 42.4006ZM48.7793 22.6385C48.7793 26.5211 48.0691 29.8591 46.6486 32.6527C45.2282 35.4344 43.2809 37.5769 40.807 39.0803C38.3449 40.5717 35.5454 41.3175 32.4085 41.3175C29.2599 41.3175 26.4486 40.5717 23.9746 39.0803C21.5125 37.5769 19.5712 35.4285 18.1507 32.6349C16.7303 29.8414 16.0201 26.5092 16.0201 22.6385C16.0201 18.7559 16.7303 15.4238 18.1507 12.642C19.5712 9.84848 21.5125 7.70596 23.9746 6.21449C26.4486 4.71117 29.2599 3.95952 32.4085 3.95952C35.5454 3.95952 38.3449 4.71117 40.807 6.21449C43.2809 7.70596 45.2282 9.84848 46.6486 12.642C48.0691 15.4238 48.7793 18.7559 48.7793 22.6385ZM43.346 22.6385C43.346 19.6792 42.8666 17.1875 41.9078 15.1634C40.9609 13.1274 39.6588 11.5885 38.0016 10.5469C36.3562 9.49337 34.4919 8.96662 32.4085 8.96662C30.3134 8.96662 28.4431 9.49337 26.7978 10.5469C25.1524 11.5885 23.8503 13.1274 22.8915 15.1634C21.9445 17.1875 21.471 19.6792 21.471 22.6385C21.471 25.5978 21.9445 28.0954 22.8915 30.1314C23.8503 32.1555 25.1524 33.6944 26.7978 34.7479C28.4431 35.7895 30.3134 36.3104 32.4085 36.3104C34.4919 36.3104 36.3562 35.7895 38.0016 34.7479C39.6588 33.6944 40.9609 32.1555 41.9078 30.1314C42.8666 28.0954 43.346 25.5978 43.346 22.6385ZM64.8171 0V45.2947H53.1516V41.0866H59.739V4.2081H53.1516V0H64.8171ZM119.336 22.6385C119.336 26.5211 118.626 29.8591 117.205 32.6527C115.785 35.4344 113.838 37.5769 111.364 39.0803C108.902 40.5717 106.102 41.3175 102.965 41.3175C99.8165 41.3175 97.0052 40.5717 94.5312 39.0803C92.0691 37.5769 90.1278 35.4285 88.7074 32.6349C87.2869 29.8414 86.5767 26.5092 86.5767 22.6385C86.5767 18.7559 87.2869 15.4238 88.7074 12.642C90.1278 9.84848 92.0691 7.70596 94.5312 6.21449C97.0052 4.71117 99.8165 3.95952 102.965 3.95952C106.102 3.95952 108.902 4.71117 111.364 6.21449C113.838 7.70596 115.785 9.84848 117.205 12.642C118.626 15.4238 119.336 18.7559 119.336 22.6385ZM113.903 22.6385C113.903 19.6792 113.423 17.1875 112.464 15.1634C111.518 13.1274 110.215 11.5885 108.558 10.5469C106.913 9.49337 105.049 8.96662 102.965 8.96662C100.87 8.96662 98.9998 9.49337 97.3544 10.5469C95.709 11.5885 94.4069 13.1274 93.4481 15.1634C92.5012 17.1875 92.0277 19.6792 92.0277 22.6385C92.0277 25.5978 92.5012 28.0954 93.4481 30.1314C94.4069 32.1555 95.709 33.6944 97.3544 34.7479C98.9998 35.7895 100.87 36.3104 102.965 36.3104C105.049 36.3104 106.913 35.7895 108.558 34.7479C110.215 33.6944 111.518 32.1555 112.464 30.1314C113.423 28.0954 113.903 25.5978 113.903 22.6385ZM125.75 40.8203V13.5476H130.882V17.88H131.166C131.663 16.4122 132.539 15.258 133.793 14.4176C135.06 13.5653 136.492 13.1392 138.09 13.1392C138.422 13.1392 138.812 13.151 139.262 13.1747C139.724 13.1984 140.085 13.228 140.345 13.2635V18.3416C140.132 18.2824 139.753 18.2173 139.209 18.1463C138.664 18.0634 138.12 18.022 137.575 18.022C136.321 18.022 135.202 18.2884 134.22 18.821C133.249 19.3419 132.48 20.0698 131.911 21.005C131.343 21.9283 131.059 22.9818 131.059 24.1655V40.8203H125.75ZM144.94 40.8203V13.5476H150.249V40.8203H144.94ZM147.621 9.33949C146.697 9.33949 145.904 9.03172 145.241 8.41619C144.59 7.78882 144.265 7.04309 144.265 6.17898C144.265 5.30303 144.59 4.55729 145.241 3.94176C145.904 3.31439 146.697 3.00071 147.621 3.00071C148.544 3.00071 149.331 3.31439 149.982 3.94176C150.645 4.55729 150.977 5.30303 150.977 6.17898C150.977 7.04309 150.645 7.78882 149.982 8.41619C149.331 9.03172 148.544 9.33949 147.621 9.33949ZM168.825 51.6158C166.659 51.6158 164.795 51.3317 163.232 50.7635C161.682 50.1953 160.415 49.4437 159.433 48.5085C158.45 47.5734 157.716 46.5495 157.231 45.4368L161.794 43.5547C162.114 44.0755 162.54 44.6259 163.073 45.206C163.617 45.7978 164.351 46.3009 165.274 46.7152C166.209 47.1295 167.411 47.3366 168.879 47.3366C170.891 47.3366 172.554 46.8454 173.868 45.8629C175.182 44.8923 175.839 43.3416 175.839 41.2109V35.8487H175.502C175.182 36.4287 174.72 37.0739 174.117 37.7841C173.525 38.4943 172.708 39.1098 171.666 39.6307C170.625 40.1515 169.269 40.4119 167.6 40.4119C165.446 40.4119 163.505 39.9089 161.776 38.9027C160.06 37.8847 158.699 36.3873 157.693 34.4105C156.698 32.4219 156.201 29.9775 156.201 27.0774C156.201 24.1773 156.692 21.6915 157.675 19.62C158.669 17.5485 160.03 15.9624 161.759 14.8615C163.487 13.7488 165.446 13.1925 167.636 13.1925C169.329 13.1925 170.696 13.4766 171.737 14.0447C172.779 14.6011 173.59 15.2521 174.17 15.9979C174.762 16.7436 175.217 17.4006 175.537 17.9688H175.928V13.5476H181.13V41.424C181.13 43.7678 180.586 45.6913 179.497 47.1946C178.408 48.6979 176.934 49.8106 175.075 50.5327C173.229 51.2547 171.146 51.6158 168.825 51.6158ZM168.772 36.0085C170.299 36.0085 171.589 35.6534 172.643 34.9432C173.708 34.2211 174.513 33.1913 175.058 31.8537C175.614 30.5043 175.892 28.8885 175.892 27.0064C175.892 25.1716 175.62 23.5559 175.075 22.1591C174.531 20.7623 173.732 19.6733 172.678 18.892C171.625 18.099 170.323 17.7024 168.772 17.7024C167.174 17.7024 165.842 18.1167 164.777 18.9453C163.712 19.7621 162.907 20.8748 162.362 22.2834C161.83 23.692 161.563 25.2663 161.563 27.0064C161.563 28.7938 161.836 30.3622 162.38 31.7116C162.925 33.0611 163.73 34.1146 164.795 34.8722C165.872 35.6297 167.198 36.0085 168.772 36.0085ZM188.25 40.8203V13.5476H193.559V40.8203H188.25ZM190.931 9.33949C190.008 9.33949 189.215 9.03172 188.552 8.41619C187.901 7.78882 187.575 7.04309 187.575 6.17898C187.575 5.30303 187.901 4.55729 188.552 3.94176C189.215 3.31439 190.008 3.00071 190.931 3.00071C191.855 3.00071 192.642 3.31439 193.293 3.94176C193.956 4.55729 194.287 5.30303 194.287 6.17898C194.287 7.04309 193.956 7.78882 193.293 8.41619C192.642 9.03172 191.855 9.33949 190.931 9.33949ZM206.01 24.6271V40.8203H200.701V13.5476H205.797V17.9865H206.135C206.762 16.5424 207.744 15.3823 209.082 14.5064C210.431 13.6304 212.13 13.1925 214.178 13.1925C216.036 13.1925 217.664 13.5831 219.061 14.3643C220.457 15.1338 221.541 16.282 222.31 17.8089C223.079 19.3359 223.464 21.224 223.464 23.473V40.8203H218.155V24.1122C218.155 22.1354 217.64 20.5907 216.61 19.478C215.581 18.3535 214.166 17.7912 212.367 17.7912C211.136 17.7912 210.041 18.0575 209.082 18.5902C208.135 19.1229 207.383 19.9041 206.827 20.9339C206.283 21.9519 206.01 23.183 206.01 24.6271Z"></path></svg><div class="flex flex-row items-center gap-[10px]"><span class="block text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#000]">©2025 Origin Technology</span><a href="https://www.preludesecurity.com/" target="_blank" class="block text-[10px] leading-[10px] md:text-[11px] md:leading-[11px] uppercase font-[500] text-[#999] bg-[#ccc] py-[5px] px-[10px] rounded-[10px] hover:bg-[#fff] hover:text-[#666]">By Prelude</a></div><a href="mailto:contact@preludesecurity.com" class="text-[12px] leading-[14px] lg:text-[14px] lg:leading-[18px] font-[400] text-[#666] hover:text-[#000]">contact@preludesecurity.com</a></div></div></div></div></div><!--$--><!--/$--><next-route-announcer style="position: absolute;"><div aria-live="assertive" id="__next-route-announcer__" role="alert" style="position: absolute; border: 0px; height: 1px; margin: -1px; padding: 0px; width: 1px; clip: rect(0px, 0px, 0px, 0px); overflow: hidden; white-space: nowrap; overflow-wrap: normal;"></div></next-route-announcer></body></html>