Title:
Behind the Mask: Spoofing Call Stacks Dynamically with Timers

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post presents a PoC “call stack masking” technique that spoofs a sleeping thread’s call stack using timer callbacks, then restores the original stack before execution resumes.  
- It targets EDR/threat-hunting detections that flag threads whose call stacks contain return addresses in unbacked (injected) memory, including proactive inspection of “sleeping beacons.”  
- Instead of complex x64 unwind/ROP-based spoofing, it backs up the thread stack, overwrites it with a legitimate-looking stack (and start address), and restores it just-in-time around `WaitForSingleObject` sleeps.  
- The PoC supports both static spoofing (hard-coded known-good stack) and dynamic spoofing by enumerating accessible threads and cloning a suitable “Wait:UserRequest” stack from a real process.  
- It also discusses user-mode and kernel-mode call stack capture (e.g., Sysmon `RtlWalkFrameChain`, ETW Threat Intelligence provider) and why “anomalous but unbacked-free” stacks can still be suspicious.  
- Useful for red team/implant developers building sleep/OPSEC evasion, and for blue teams to understand emerging stack-based telemetry and potential detection points (e.g., timer artifacts).

Technical Focus:
- Call stack spoofing “at rest” (sleeping thread stack manipulation)
- Timer-queue timers as an external execution mechanism (Ekko-style)
- x64 stack layout/RSP prediction via `_AddressOfReturnAddress`
- EDR call stack inspection (user-mode hooks vs kernel capture)
- Thread start address and call stack cloning from legitimate threads
- ETW TI / Sysmon-style call stack collection and implications

Use Cases:
- Masking injected implant threads during sleep to evade stack-based hunting
- Generating “legitimate-looking” call stacks by cloning real waiting threads
- Evaluating/demonstrating detection gaps in call-stack-based telemetry
- Building test cases for tools that scan sleeping threads for unbacked frames
- Researching timer-based tradecraft and its forensic/detection footprint

Keywords:
call stack spoofing, call stack masking, sleeping beacons, thread stack overwrite, timer-queue timers, Ekko, WaitForSingleObjectEx, NtWaitForSingleObject, _AddressOfReturnAddress, RSP, x64 stack unwinding, UWOP_SET_FPREG, RtlWalkFrameChain, Sysmon, ETW Threat Intelligence, injected thread detection, unbacked memory, start address spoofing, Hunt-Sleeping-Beacons, CallStackMasker