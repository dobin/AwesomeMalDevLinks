Title:
Shellcode – Pt 4: Stager + Local Injection using Fibers

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post walks through building a Windows x64 shellcode stager that downloads a second-stage payload over HTTP(S)-style WinHTTP APIs and executes it locally using fibers.  
- It implements a minimal “instance” resolver that avoids static imports by walking the PEB to find loaded modules and parsing PE export tables to resolve function addresses at runtime.  
- The stager fetches a payload (example: Havoc agent shellcode) via WinHttpOpen/Connect/OpenRequest/SendRequest/ReceiveResponse/ReadData, allocates memory, copies the bytes, and transfers execution via CreateFiber + ConvertThreadToFiber + SwitchToFiber.  
- The author highlights stack alignment via a NASM WinMain stub and uses ntdll heap APIs (RtlAllocateHeap/RtlFreeHeap) for buffer management.  
- It’s primarily useful for red teamers, pentesters, and malware developers interested in custom stagers, import-less loaders, and alternative userland execution primitives.  
- The interesting angle is combining a small HTTP stager with fiber-based execution to avoid classic CreateThread-style patterns, while acknowledging the RWX allocation tradeoff.

Technical Focus:
- PEB traversal for module discovery (LdrModuleAddr)
- PE export parsing for API resolution (LdrFuncAddr)
- WinHTTP-based staged payload retrieval
- Fiber-based code execution (CreateFiber/ConvertThreadToFiber/SwitchToFiber)
- x64 calling convention and stack alignment in shellcode entry stubs
- Heap management via ntdll (RtlAllocateHeap/RtlFreeHeap)

Use Cases:
- Build a lightweight HTTP stager to fetch and run a larger second-stage payload
- Execute in-memory payloads without creating a new thread (fiber switching)
- Develop import-less shellcode loaders for evasive tradecraft experiments
- Deliver C2 agent shellcode (e.g., Havoc) in staged form
- Use as an exploit payload component where small first-stage code is required

Keywords:
Windows x64, shellcode stager, local injection, fibers, CreateFiber, SwitchToFiber, ConvertThreadToFiber, PEB traversal, Process Environment Block, PE export parsing, LdrModuleAddr, LdrFuncAddr, WinHTTP, WinHttpOpen, WinHttpConnect, WinHttpReadData, VirtualAlloc, RWX memory, RtlAllocateHeap, Havoc C2