# https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit

<!DOCTYPE html><html lang="en-US"><body class="wp-singular post-template-default single single-post postid-2828 single-format-standard wp-custom-logo wp-embed-responsive wp-theme-helpsystems wp-child-theme-cobalt-strike group-blog understrap-has-sidebar"><div id="consent_blackbar" lang="en">
            
            <div id="truste-consent-track" style="position: relative; z-index: 999999; border-top: 1px solid rgb(102, 102, 102);" class="ta-show ta-display-block">  <div id="truste-consent-content" style="overflow: hidden;">    <div id="truste-consent-text" class="truste-messageColumn" data-nosnippet="data-nosnippet">      <span class="hstitle">This website uses cookies. You may change your settings at any time.</span>    </div>    <div id="truste-consent-buttons" class="truste-buttonsColumn" data-nosnippet="data-nosnippet">      <span id="truste-repop-msg" style="padding: 7px 10px; background: #F9EDBE; border:1px solid #F0C36D; margin: 11px 0px 13px;font-size:11; line-height: 16px;color: #AF7501; display:none;"></span>       <button id="truste-consent-button">Accept</button>      <button id="truste-consent-required">Reject All</button>      <button id="truste-show-consent" aria-haspopup="dialog">Manage Cookies</button>    </div>  </div></div></div>
<div style="display:none;" id="teconsent" consent="undefined" aria-label="Open Cookie Preferences Modal" class="truste_caIcon_display" role="complementary"><a role="link" id="icon-id05616357057957672" tabindex="0" lang="en" aria-haspopup="dialog" aria-label="Cookie Preferences, opens a dedicated popup modal window" class="truste_cursor_pointer">Cookie Preferences</a></div>

	
<!-- TrustArc tag end -->
<!-- Google Tag Manager -->

<!-- End Google Tag Manager --><link rel="icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-32x32.png" sizes="32x32">
<link rel="icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-192x192.png" sizes="192x192">
<link rel="apple-touch-icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-180x180.png">

		
		


<!-- Google Tag Manager (noscript) -->

<!-- End Google Tag Manager (noscript) -->
<div class="site" id="page">

	<!-- ******************* The Navbar Area ******************* -->
	<!-- #wrapper-navbar -->

<div class="header-banner"> 
	<div class="jumbotron jumbotron-fluid bg-4 " style="background-image: ">
	<div class="banner-wrapper">
		<div class="container">
			<p class="yoast-breadcrumbs m-0"><span><span><a href="https://www.cobaltstrike.com/">Home</a></span> » <span><a href="https://www.cobaltstrike.com/blog/">Blog</a></span> » <span class="breadcrumb_last" aria-current="page">Create a proxy DLL with artifact kit</span></span></p>							<h1>Create a proxy DLL with artifact kit</h1>
								<p class="font-italic">Tuesday 02 November, 2021</p>

							</div>
	</div>
	</div>
</div>


<div class="wrapper" id="page-wrapper">

	<div class="container" id="content" tabindex="-1">
		<div class="row">
			<div class="col-lg-8 content-area" id="primary">

				<main class="site-main" id="main">
					<article class="post-2828 post type-post status-publish format-standard hentry cornerstone-red-team cta_type-blog" id="post-2828">


<div class="entry-content">
		
<p>DLL attacks (hijacking, proxying, etc) are a challenge defenders must face. They can be leveraged in a Red Team engagement to help measure these defenses. Have you used this technique? In this post, I’ll walk through an example of adding a DLL proxy to  beacon.dll for use in a DLL Proxy attack.</p>



<h2 class="wp-block-heading" id="what-is-a-dll-proxying">What is a DLL Proxying?</h2>



<p>To begin with, this is not a new technique. I’ve seen it used some, but not always understood in practice. Other DLL hijacking attacks tend to be used more often, but Red Teams can benefit by adding this technique to their toolbox. </p>



<p>DLL proxying is an attack that falls in the DLL hijacking category. </p>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p>Adversaries may execute their own malicious payloads by hijacking the search order used to load DLLs. Windows systems use a common method to look for required DLLs to load into a program.</p>
<cite>MITRE ATT&amp;CK defines this as <a href="https://attack.mitre.org/techniques/T1574/001/" target="_blank" rel="noreferrer noopener">Hijack Execution Flow:&nbsp;DLL Search Order Hijacking</a>.</cite></blockquote>



<p>A common way this is abused is to find a process that loads a “ghost” DLL. This is a DLL that is called by the process, but doesn’t actually exist. The calling process ignores this and continues. An attacker can add their own DLL in place of this ghost DLL. This works great, but can be rare. </p>



<div class="ghostkit-testimonial"><div class="ghostkit-testimonial-icon"><svg class="ghostkit-svg-icon ghostkit-svg-icon-fa" aria-hidden="true" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 448c-110.532 0-200-89.431-200-200 0-110.495 89.472-200 200-200 110.491 0 200 89.471 200 200 0 110.53-89.431 200-200 200zm107.244-255.2c0 67.052-72.421 68.084-72.421 92.863V300c0 6.627-5.373 12-12 12h-45.647c-6.627 0-12-5.373-12-12v-8.659c0-35.745 27.1-50.034 47.579-61.516 17.561-9.845 28.324-16.541 28.324-29.579 0-17.246-21.999-28.693-39.784-28.693-23.189 0-33.894 10.977-48.942 29.969-4.057 5.12-11.46 6.071-16.666 2.124l-27.824-21.098c-5.107-3.872-6.251-11.066-2.644-16.363C184.846 131.491 214.94 112 261.794 112c49.071 0 101.45 38.304 101.45 88.8zM298 368c0 23.159-18.841 42-42 42s-42-18.841-42-42 18.841-42 42-42 42 18.841 42 42z"></path></svg></div><div class="ghostkit-testimonial-content">

<p>What if you could modify an existing DLL without breaking the application that depends on that functionality?</p>

</div></div>



<p>This is DLL proxying. It allows an attacker to hijack the execution flow of a process but keep the original functionality of the application. Let’s walk through the attack flow.</p>



<p></p>



<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/proxy.def_.diagram-1024x710-1.png" alt="" class="wp-image-9307"><figcaption class="wp-element-caption">DLL Proxy Attack Flow Diagram</figcaption></figure>



<p>Let’s say some process uses math.dll to perform calculations. Someprocess.exe loads math.dll and makes calls to its exported functions as needed. This is why we use external libraries. </p>



<p>If we want to hijack this process, we could easily replace math.dll with something malicious, but this would break the application. We don’t want that. This may draw attention to what we are doing. We need to copy math.dll to original.dll. Replace math.dll with a version that will forward the the legitimate calls to the new original.dll. And finally, use math.dll to load whatever malicious function we want. <br></p>



<p>In order to do this we need…</p>



<ol class="wp-block-list">
<li>The ability to create and write files</li>



<li>The ability to find a target DLL that is loaded by an application</li>



<li>The ability to extract the exports from a target DLL</li>



<li>The ability to create a DLL that will ‘proxy’ the original exports to a copy of the original DLL</li>
</ol>


<div class="wp-block-group py-5 is-layout-flow wp-block-group-is-layout-flow">
<div class=" container">

<p>The post is using one technique for DLL proxying to specifically show how to use artifact kit to create this proxy DLL. There are several projects that explore this concept. A quick search can yield a wealth of resources on the topic. One of particular interest is the <a href="https://github.com/mandiant/DueDLLigence" target="_blank" rel="noreferrer noopener">DueDLLigence</a> project. It is an interesting approach that uses a framework to easily allow the development malicious DLLs.</p>
</div><!--/ .container -->
</div><!--/ .group -->



<h2 class="wp-block-heading" id="let-s-start-with-a-simple-dll-proxy-example">Let’s Start with a Simple DLL Proxy Example</h2>



<p>Let’s walk through a simple example to help clear this up.</p>



<p>This example uses code that can be found <a href="https://github.com/Cobalt-Strike/ProxyDLLExample" target="_blank" rel="noreferrer noopener">here</a>.</p>



<p>In this example we assume that the <strong>hello.dll</strong> is the DLL being call by our target process. It will become the target of our proxy attack. This is similar to math.dll in the diagram.</p>



<h3 class="wp-block-heading" id="steps-to-find-build-and-use-a-proxy-dll">Steps to find, build, and use a proxy DLL</h3>



<h4 class="wp-block-heading" id="1-understand-the-execution-flow-of-a-process-to-understand-which-dlls-are-loaded">1) Understand the execution flow of a process to understand which DLLs are loaded.</h4>



<p>We need to start by understanding which DLLs are loaded by a process. The <a href="https://docs.microsoft.com/en-us/sysinternals/">sysinternals</a> tool <strong>process explorer</strong> works great here.</p>


<div class="wp-block-group py-5 is-layout-flow wp-block-group-is-layout-flow">
<div class=" container">

<h2 class="wp-block-heading" id="real-world-tip">Real World Tip</h2>

<p>I won’t call out any vendor here. My examples simply use rundll32.exe as my ‘application’. Just consider rundll32.exe some real target (maybe a chat application) that uses hello.dll.</p>

<p>The AppData directory is a great place to find candidates for user level persistence. Unlike C:\Program Files, c:\users\USER\AppData is user controlled. Many applications are installed here. cough, cough, chat clients.</p>
</div><!--/ .container -->
</div><!--/ .group -->



<p></p>



<p>A quick tip on using process explorer is to filter out what you need before running. In this case, I only want to see Load Image from my target process. </p>



<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/procmon_filter.png" alt="" class="wp-image-9787"><figcaption class="wp-element-caption">Procmon Filter</figcaption></figure>



<p>To simulate an application starting up and making calls to its DLLs, I use: </p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_3381" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_3381_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_3381" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">rundll32.exe hello.dll, hello</code></td></tr></tbody></table></div></div></div></div>


<p>to have rundll32 call the hello function.</p>



<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/Hello_world.png" alt="" class="wp-image-9788"><figcaption class="wp-element-caption">rundll32 loads hello.dll and calls the hello function</figcaption></figure>



<p>In the process explorer output, we see that our application loads hello.dll</p>



<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/procmon_hello.dll_.png" alt="" class="wp-image-9789"><figcaption class="wp-element-caption">Procmon</figcaption></figure>



<p>Great, we found a candidate DLL in our target application. </p>



<p></p>



<p>Another option to search for targets is to use the <a href="https://github.com/EspressoCake/DLL_Imports_BOF" target="_blank" rel="noreferrer noopener">DLL_Imports_BOF</a>. This project allows you to search for target applications during an engagement.</p>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p>This is a&nbsp;<code>BOF</code>&nbsp;to enumerate&nbsp;<code>DLL</code>&nbsp;files to-be-loaded by a given&nbsp;<code>PE</code>&nbsp;file. Depending on the number of arguments, this will allow an operator to either view a listing of anticipated imported&nbsp;<code>DLL</code>&nbsp;files, or to view the imported functions for an anticipated&nbsp;<code>DLL</code>.</p>
</blockquote>



<p></p>



<p>No matter what you use, the goal is to understand what DLLs are in play and what exports those DLLs use. </p>



<h3 class="wp-block-heading" id="2-identify-the-dll-exports">2) Identify the DLL exports.</h3>



<p>DLL exports are the functions that an external process can call to use that functionality. It is a core feature of a DLL. </p>



<p>Look at the exports of hello.dll:</p>


<div class="wp-block-group py-5 is-layout-flow wp-block-group-is-layout-flow">
<div class=" container">
</div><!--/ .container -->
</div><!--/ .group -->



<p>If you are following along, compile hello.dll:</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_109729" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_109729_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_109729" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">x86_64-w64-mingw32-gcc -m64 -c -Os hello.c -Wall -shared -masm=intel</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="plain">x86_64-w64-mingw32-dllwrap -m64 --def hello.def hello.o -o hello.dll</code></td></tr></tbody></table></div></div></div></div>


<p>There are several ways to get the exported function from a DLL.</p>



<p>I included a simple python script, <strong>get_exports.py</strong>, to extract the exports and format for use in a .def file.</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_555102" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_555102_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_555102" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">python3 get_exports.py --target hello.dll</code></td></tr></tbody></table></div></div></div></div>


<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/get_exports.png" alt="" class="wp-image-9790"><figcaption class="wp-element-caption">get_exports.py output</figcaption></figure>



<p>You can also use something like <code>dumpbin</code> from Visual Studio</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_451844" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_451844_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_451844" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">dumpbin /exports hello.dll</code></td></tr></tbody></table></div></div></div></div>


<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/dumpbin_hello.dll_.png" alt="" class="wp-image-9791"><figcaption class="wp-element-caption">dumpbin output</figcaption></figure>



<p>The point of this is to get a list of the legitimate exported functions from the target DLL. This will give us what we need to build our proxy.</p>



<h3 class="wp-block-heading" id="3-build-the-proxy-dll">3) Build the proxy.dll.</h3>



<p>In this example, I’m writing a proxy in .C to be compiled with MinGW. This shows the process, but could be very different depending on how you build your DLL. No matter what you do, you will be generating a DLL that forward functions. </p>



<p>Add the exported functions to proxy.def:</p>



<p></p>



<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/proxy_def.png" alt="" class="wp-image-9792"><figcaption class="wp-element-caption">proxy.def updated with the hello.dll functions</figcaption></figure>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p>A module-definition or DEF file (*.def) is a text file containing one or more module statements that describe various attributes of a DLL. If you are not using the&nbsp;<strong><code>__declspec(dllexport)</code></strong>&nbsp;keyword to export the DLL’s functions, the DLL requires a DEF file.</p>
<cite>https://docs.microsoft.com/en-us/cpp/build/exporting-from-a-dll-using-def-files?view=msvc-160</cite></blockquote>



<p>Let’s break down the export <strong>hello=original.hello @1</strong>:</p>



<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/proxy.def_.diagram-1024x301-1.png" alt="" class="wp-image-9793"></figure>



<p>This is creating the “hello” export for proxy.dll. Calls made to this function are forwarded to the hello function in original.dll. The @1 is the ordinal. (Ordinals are another way a function may be called. It does not always need to match, but can help if ordinals are used.)</p>



<h4 class="wp-block-heading" id="proxy-c"><strong>proxy.c</strong></h4>



<p>proxy.c is a very basic DLL. It will run the payload function and if a remote target calls a remote function, it will proxy based on the exports set in proxy.def. The payload function is blocking. This is just a simple example. You should create a thread or use some other non-blocking method.</p>



<p>We are ready to compile proxy.dll</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_282029" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_282029_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_282029" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">x86_64-w64-mingw32-gcc -m64 -c -Os&nbsp; proxy.c -Wall -shared -masm=intel</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="plain">x86_64-w64-mingw32-dllwrap -m64 --def proxy.def proxy.o -o proxy.dll</code></td></tr></tbody></table></div></div></div></div>


<h3 class="wp-block-heading" id="4-move-the-files-to-the-target">4) Move the files to the target.</h3>



<p>To simulate a real attack you must:</p>



<ul class="wp-block-list">
<li>rename the original dll (hello.dll) to original.dll or what you set in the proxy.def file.</li>



<li>rename proxy.dll to the original file name (hello.dll)</li>
</ul>



<p>Output after moving and naming the files on the target system.</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_971106" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_971106_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_971106" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">Directory of Y:\temp\proxydll</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="plain">10/28/2021&nbsp; 01:53 PM&nbsp;&nbsp;&nbsp; &amp;lt;DIR&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="plain">10/28/2021&nbsp; 01:37 PM&nbsp;&nbsp;&nbsp; &amp;lt;DIR&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ..</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="plain">10/28/2021&nbsp; 01:37 PM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 280,185 hello.dll&nbsp;&nbsp;&nbsp; &amp;lt;- This was proxy.dll</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="plain">10/28/2021&nbsp; 01:23 PM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 280,167 original.dll &amp;lt;- This was hello.dll</code></td></tr></tbody></table></div></div></div></div>


<h3 class="wp-block-heading" id="5-test-the-proxy">5) Test the proxy.</h3>



<p>Let’s simulate some process following its normal process of loading hello.dll and calling the hello function by using rundll32.exe.</p>



<p>The following command acts more or less the same as an application starting, loading a DLL, and calling a function from that DLL.</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_756618" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_756618_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_756618" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">rundll32 hello.dll, hello</code></td></tr></tbody></table></div></div></div></div>


<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-9d6595d7 wp-block-columns-is-layout-flex">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/hello_from_proxy.png" alt="" class="wp-image-9794"><figcaption class="wp-element-caption">The payload function from the proxy DLL</figcaption></figure>
</div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/Hello_world-1.png" alt="" class="wp-image-9795"><figcaption class="wp-element-caption">The hello function from the original DLL</figcaption></figure>
</div>
</div>



<p>We called the proxy DLL (hello.dll) using rundll32 as an example target for a DLL loading attack. It executed our payload function and the original function.</p>



<p>That’s it. There really isn’t much to this attack, but it can be very effective. A proxy DLL is just a DLL that proxies legitimate calls and runs your own payload. Proxy attacks allow an attacker to hijack execution flow but keep the original functionality of the application.</p>



<h2 class="wp-block-heading" id="let-s-extend-this-to-the-cobalt-strike-artifact-kit">Let’s extend this to the Cobalt Strike Artifact Kit</h2>



<p>Licensed users of Cobalt Strike have access to the <a href="https://www.cobaltstrike.com/help-artifact-kit" target="_blank" rel="noreferrer noopener">artifact kit</a>.  This kit provide a way to modify several aspects of the .exe or .dll beacon payloads. Think of this as a beacon ‘loader’. The kit can be loaded by Cobalt Strike as an aggressor script to update how .exe or .dll payloads are built.</p>



<p>Now that we know the primitives from our example, we can easily update kit with the changes needed to convert beacon.dll into a proxy.</p>



<p><br>Modify the file <strong>src-main/dllmain.de</strong>f by adding <strong>hello=original.hello @1</strong> as an export option. This is the same as what was done in the example.</p>



<p><br>Build the kit using the build.sh script. By default, this will compile all kit techniques. Let it build them all. We will pick one to load.</p>



<p><br>Load the artifact kit aggressor script to tell Cobalt Strike to use the newly create template when building a payload. In this case we will use the ‘pipe’ technique. The aggressor script can be found in dist-pipe/artifact.cna after the build is complete.</p>



<p>Cobalt Strike -&gt; Script Manager<br>Load -&gt; dist-pipe/artifact.cna </p>



<p>Generate a Beacon DLL payload</p>



<p>Attacks -&gt; Packages -&gt; Windows Executable (S)</p>



<pre class="wp-block-code"><code>Listener: Choose Your listener
Output:   Windows DLL
x64:      X</code></pre>



<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/Screen-Shot-2021-10-29-at-12.17.40-PM.png" alt="" class="wp-image-9796"></figure>



<p>Click Generate and save as hello.dll.</p>



<p>Remember, this is the proxy DLL. It will replace the target DLL and the the target DLL will be renamed to original.dll.</p>



<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/artifact_output.png" alt="" class="wp-image-9797"><figcaption class="wp-element-caption">Modified version of artifact.cna to output messages to the script console when the artifact kit is used</figcaption></figure>



<p>Let’s take a look at this beacon DLL payload (hello.dll):</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_791877" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_791877_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_791877" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">dumpbin /exports hello.dll</code></td></tr></tbody></table></div></div></div></div>


<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/dumpbin_proxy.png" alt="" class="wp-image-9798"><figcaption class="wp-element-caption">exports of hello.dll (proxy)</figcaption></figure>



<p>We see the DLL has the default exports for beacon.dll and the new forwarding export.</p>



<p><br>Let’s test as we did before by using rundll32 as the target process that we want to attack.</p>


<div class="wp-block-syntaxhighlighter-code "><div id="highlighter_25341" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_25341_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_25341" menu="false" src="https://www.cobaltstrike.com/app/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="https://www.cobaltstrike.com/blog/create-a-proxy-dll-with-artifact-kit#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">rundll32 hello.dll, hello</code></td></tr></tbody></table></div></div></div></div>


<figure class="wp-block-image size-large"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/new_beacon.png" alt="" class="wp-image-9799"><figcaption class="wp-element-caption">Received a new beacon</figcaption></figure>



<p>hello.dll runs the beacon payload, and the hello function call was successfully proxied.</p>



<figure class="wp-block-image size-full"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/Hello_world-2.png" alt="" class="wp-image-9800"></figure>



<p>At this point, we turned beacon.dll in a proxy.</p>



<h2 class="wp-block-heading" id="what-next">What Next?</h2>



<p>This example only shows how to make beacon a DLL proxy. The artifact kit is a way to customize beacon.exe or beacon.dll. It can be used to help bypass AV/EDR. Consider exploring the possibilities of using the kit. Or, forget the artifact kit altogether and write your own beacon loader as a proxy DLL. </p>



<p>Using rundll32 isn’t exciting, but the attack technique itself is a great method for persistence. Many applications are installed in </p>



<p>c:\users\USER\AppData</p>



<p>This directory is writable by the user (vs something like c:\program files). This means an attacker with control over a target can find a target process and create a proxy DLL for that target. Take a look at the application installed in AppData, you may find a nice target. </p>



<h2 class="wp-block-heading" id="defensive-considerations">Defensive Considerations</h2>



<p>A great preventative control for this attack is for applications to validate the DLLs it loads. If a rouge/untrusted DLL is used, the application will not allow it to execute. During the writing of this post, I tested by targeting a popular chat application. It used digital signatures to validate the loaded DLLs. This worked great, except the user was presented with a popup asking if they would like to run the “untrusted” code. Clicking OK allowed my payload to run (partial win?).  Prevention is great, be we need to ensure we can detect attacks when it fails.</p>



<p>Do not allow user controlled applications to be installed in user controlled directories. Install applications in directories the user can use but not modify (i.e., C:\Program Files).</p>



<p>File integrity monitoring may help.</p>



<p>Fortunately, the payloads executed from this attack the same. The proxy DLL is just a loader. The payloads executed by this loader may be detected through the normal means of a robust security operations program. </p>



<p></p>



<h2 class="wp-block-heading" id="references">References</h2>



<ul class="wp-block-list">
<li>Example code <a href="https://github.com/Cobalt-Strike/ProxyDLLExample" target="_blank" rel="noreferrer noopener">https://github.com/Cobalt-Strike/ProxyDLLExample</a></li>



<li>MITRE ATT&amp;CK <a href="https://attack.mitre.org/techniques/T1574/001/" target="_blank" rel="noreferrer noopener">Hijack Execution Flow:&nbsp;DLL Search Order Hijacking</a></li>



<li>DueDLLigence <a href="https://github.com/mandiant/DueDLLigence" target="_blank" rel="noreferrer noopener">https://github.com/mandiant/DueDLLigence</a></li>



<li>DLL Imports BOF <a href="https://github.com/EspressoCake/DLL_Imports_BOF" target="_blank" rel="noreferrer noopener">DLL_Imports_BOF</a></li>



<li>A great post on DLL Hijacking <a href="https://www.netspi.com/blog/technical/adversary-simulation/adaptive-dll-hijacking/" target="_blank" rel="noreferrer noopener">https://www.netspi.com/blog/technical/adversary-simulation/adaptive-dll-hijacking/</a></li>
</ul>

</div><!-- .entry-content -->

<!-- .entry-footer -->

</article><!-- #post-2828 -->


				</main>
			</div> <!-- #primary -->
			
<div class="col-lg-4 align-self-start resource-sidebar widget-area"><!-- #resource-sidebar -->
        <div class="sidebar-content bg-7 mb-3">
        <div class=" container">
            <div class="row">
                <div class="col-12">
                                    <div class="author-description p-3 row">
                                                <div class="author-image col-5">
                             <img width="149" height="146" src="https://www.cobaltstrike.com/app/uploads/2023/07/joe-vest-circle-outline.png" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="" decoding="async" loading="lazy">                        </div>
                                                <div class=" col-7 pl-0">
                            <h4 class="author-title text-align-left font-weight-light">
                                <a href="https://www.cobaltstrike.com/profile/joe-vest">Joe Vest</a>
                            </h4>
                            <div></div>
                        </div>
                        <div class="col-12 text-center mt-2">
                            <a class=" btn-link view-profile" href="https://www.cobaltstrike.com/profile/joe-vest">View Profile</a>
                        </div>
                    </div>
                                </div>  <!-- #column -->
            </div> <!-- #row -->
        </div> <!-- #container -->
    </div>  <!-- #sidebar-content -->
            <div class="sidebar-content bg-7 mb-3">
        <div class=" container">
            <div class="row">
                <div class="col-12">
                                                                <div class="sidebar-content p-3">
                            <div class="block-title text-uppercase">
                            TOPICS
                            </div>
                            <ul class="list-group list-group-flush pt-2">
                            <li class="list-unstyled"><a href="https://www.cobaltstrike.com/blog?_sft_cornerstone=red-team" title="Red Team">Red Team</a></li>                            </ul>
                        </div>
                                    </div>  <!-- #column -->
            </div> <!-- #row -->
        </div> <!-- #container -->
    </div>  <!-- #sidebar-content -->
    </div><!-- #resource-sidebar -->
		</div><!-- .row -->
	</div><!-- #container -->
</div><!-- #page-wrapper -->



</div>



<div class="wpc-filters-overlay"></div>








<div height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" data-original-tag="iframe"></div>
<div class="ta-display-none" name="trustarc_notice" id="trustarcNoticeFrame" title="Trustarc Cross-Domain Consent Frame" src="https://consent.trustarc.com/get?name=crossdomain.html&amp;domain=helpsystems.com" data-original-tag="iframe"></div></body></html>