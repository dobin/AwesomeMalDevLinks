Title:
Living off the Process (LOTP) – Indirect Shellcode Writing via In-Process ROP + Thread Hijacking

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes a Windows x64 injection technique the author calls “Living off the Process,” aiming to minimize common EDR-detected artifacts (e.g., heavy WriteProcessMemory usage, new RWX allocations).  
- The core idea is to reuse what already exists inside a target process: pre-existing RWX memory regions, existing ROP gadgets in loaded modules, and an existing thread to hijack.  
- Shellcode is written indirectly into the remote process in 8-byte chunks by chaining a gadget like `mov [rax], r8; ret`, with small per-chunk assembly stubs that load `R8` (data) and `RAX` (destination) rather than calling WriteProcessMemory for the payload itself.  
- The operator builds a ROP chain and “fake stack,” then uses `SuspendThread`/`GetThreadContext`/`SetThreadContext` to redirect `RIP` to the first stub and `RSP` to the ROP chain, finally pivoting with `pop rsp; ret` to execute the written shellcode.  
- It includes practical code for gadget discovery (module enumeration + `ReadProcessMemory` scanning), RWX region discovery (`VirtualQueryEx`), and thread selection (`CreateToolhelp32Snapshot`).  
- Useful for red teamers and offensive researchers exploring lower-noise process injection tradeoffs and how ROP-based memory writes can replace direct remote-memory writes.

Technical Focus:
- ROP gadget discovery in remote processes (module enumeration + byte-pattern search)
- Indirect remote memory writing via gadgets (`mov [reg], reg; ret`) and per-chunk stubs
- Thread hijacking and context manipulation (`SuspendThread`, `GetThreadContext`, `SetThreadContext`)
- RWX memory region discovery and reuse (`VirtualQueryEx`, PAGE_EXECUTE_READWRITE)
- Stack pivoting / fake stack setup (`pop rsp; ret`)
- Windows x64 assembly/machine-code stub generation

Use Cases:
- Stealthier shellcode injection PoCs avoiding typical `VirtualAllocEx` + bulk `WriteProcessMemory` patterns
- Researching EDR telemetry gaps around thread-context hijacking and ROP-based writes
- Building tradecraft for “process-resident” execution using existing executable regions and gadgets
- Developing detections around suspicious `SetThreadContext` usage, stack pivots, and anomalous RWX region reuse

Keywords:
Windows 11, process injection, ROP chain, ROP gadgets, thread hijacking, SetThreadContext, GetThreadContext, SuspendThread, ResumeThread, VirtualQueryEx, ReadProcessMemory, WriteProcessMemory, EnumProcessModulesEx, PAGE_EXECUTE_READWRITE, RWX memory, stack pivot, pop rsp ret, x64dbg, shellcode, code stubs