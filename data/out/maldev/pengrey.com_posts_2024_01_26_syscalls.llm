Title:
Windows Syscalls: Direct vs Indirect System Calls, Userland Hooking, and Mitigations

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how Windows API calls flow from `kernel32.dll` to the Native API in `ntdll.dll`, and ultimately into the kernel via the `syscall` instruction and syscall stubs.  
- It focuses on how many EDR products collect telemetry by userland-hooking high-signal functions (often in `ntdll`) and why that approach can be bypassed.  
- The author contrasts direct syscalls (custom syscall stubs that avoid hooked userland APIs) with indirect syscalls (jumping into an unhooked `ntdll` syscall stub to make the call appear to originate from `ntdll`).  
- It highlights practical limitations: syscall numbers (SSNs) vary across Windows versions, and defenders can detect abnormal syscall origins or suspicious call stacks.  
- Mitigations discussed include call stack analysis and using ETW/ETW-Ti to capture and validate stack traces around sensitive syscalls, while noting attackers may counter with stack spoofing.  
- Useful for red teamers/malware developers building syscall-based evasion, and blue team/EDR engineers validating detection strategies beyond simple userland hooks.

Technical Focus:
- Windows API vs Native API (`kernel32.dll` → `ntdll.dll`)
- Syscall stubs, `syscall` instruction, syscall numbers (SSNs)
- Userland function hooking (inline JMP detours)
- Direct syscalls vs indirect syscalls (jump-to-stub)
- Call stack validation and anomaly detection
- ETW / ETW-Ti-based telemetry for stack collection

Use Cases:
- Implementing syscall-based EDR hook bypass techniques in implants/loaders
- Assessing EDR reliance on `ntdll`/userland hooks and testing detection gaps
- Building detections for abnormal syscall origin/call stack patterns
- Hardening telemetry pipelines with ETW/ETW-Ti stack capture and validation
- Researching/teaching Windows syscall execution flow and interception points

Keywords:
Windows syscalls, ntdll.dll, kernel32.dll, Native API, Windows API, syscall stub, syscall instruction, SSN, NtCreateFile, CreateFileW, userland hooking, inline hook, JMP detour, EDR evasion, direct syscall, indirect syscall, KiSystemCall64, call stack analysis, ETW, ETW-Ti, stack spoofing, PatchGuard