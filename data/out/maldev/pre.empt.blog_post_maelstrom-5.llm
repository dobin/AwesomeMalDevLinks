Title:
Maelstrom 5: Endpoint Protection (EDR) Behaviours — Kernel Callbacks, Hooking, and Thread Call Stacks

Type:
Blog Post

Short Summary (4–8 sentences max):
This post explains why a “working” Windows C2 implant often fails in real environments due to modern EDR telemetry and enforcement, emphasizing that execution ≠ evasion. It sets up a lab using HELK (Elastic + Sysmon) and a pseudo-EDR (“PreEmpt”) to observe detections. The core technical discussion covers three common EDR mechanisms: kernel callbacks (e.g., image-load notifications), user-mode API hooking (inline detours and DLL-based instrumentation), and call-stack/telemetry-based detection. It demonstrates how image-load callbacks can be triggered/spammed or avoided by changing loader behavior (e.g., avoiding `NtCreateSection`), referencing DarkLoadLibrary as a practical bypass. It also walks through building a simple userland hooker (MinHook) to detect/block suspicious memory operations (`NtAllocateVirtualMemory`, `NtProtectVirtualMemory`, `NtWriteVirtualMemory`) and discusses syscall-based approaches (SysWhispers/FreshyCalls) to evade user-mode hooks. Useful for red team/offensive tool developers and defenders who want to understand what EDRs actually observe and how bypasses change telemetry.

Technical Focus:
- Windows kernel callback telemetry (e.g., `PsSetLoadImageNotifyRoutine`, `ObRegisterCallbacks`)
- Image-load event generation and bypass via custom loaders (`NtCreateSection` vs `NtAllocateVirtualMemory`)
- User-mode API hooking / inline patching / MinHook-based instrumentation
- Direct syscalls and syscall-number resolution (SysWhispers family, FreshyCalls)
- Sysmon/Elastic (HELK) hunting for DLL load and process telemetry

Use Cases:
- Build a lab to validate what Sysmon/EDR telemetry is generated by implant behaviors
- Detect or block common injection patterns (RWX alloc → write → RX protect) via hooks
- Reduce or manipulate image-load telemetry (spoofing LDR entries, avoiding callback triggers)
- Evaluate syscall-based evasion against userland hooks and compare resulting artifacts
- Create defensive detections for anomalous module-load patterns and memory-protection transitions

Keywords:
EDR, Sysmon Event ID 7, HELK, Elastic, ETW, Windows kernel callbacks, PsSetLoadImageNotifyRoutine, ObRegisterCallbacks, NtCreateSection, NtMapViewOfSection, NtAllocateVirtualMemory, NtProtectVirtualMemory, NtWriteVirtualMemory, userland hooks, inline hooking, MinHook, NTDLL, direct syscalls, SysWhispers2, SysWhispers3, FreshyCalls, DarkLoadLibrary, LDR_DATA_TABLE_ENTRY