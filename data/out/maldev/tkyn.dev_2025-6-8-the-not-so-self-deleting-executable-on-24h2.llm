Title:
The Not So Self Deleting Executable on 24H2

Type:
Blog Post

Short Summary (4–8 sentences max):
This post analyzes why the common “self-delete executable” technique (open self with DELETE, rename primary :$DATA to an ADS, then set delete disposition) works on Windows 11 23H2 but fails on Windows 11 24H2. On 24H2, the file often remains on disk as a zero-length primary stream while the original contents persist in an alternate data stream, defeating track-clearing goals. The author traces the failure to NTFS behavior changes around setting delete disposition (notably in memory-mapped/image-section cases) by comparing ntfs.sys versions and debugging NTFS return paths with WinDbg NTSTATUS breakpoints. The fix is to use `NtSetInformationFile` with `FileDispositionInformationEx` and include `FILE_DISPOSITION_POSIX_SEMANTICS` alongside `FILE_DISPOSITION_DELETE`, which allows deletion to proceed on 24H2. A working updated PoC (and BOF demo) is provided, plus notes on relevant NTFS debug codes for other deletion failure scenarios. Useful for red teamers/malware developers maintaining reliable on-disk artifact cleanup across Windows versions, and for defenders understanding new filesystem semantics that affect “self-delete” tradecraft.

Technical Focus:
- NTFS delete disposition semantics changes in Windows 11 24H2
- Alternate Data Streams (ADS) and renaming `:$DATA`
- `SetFileInformationByHandle` vs `NtSetInformationFile` (native API)
- `FILE_DISPOSITION_INFORMATION_EX` and `FILE_DISPOSITION_POSIX_SEMANTICS`
- Kernel/NTFS debugging with WinDbg NTSTATUS breakpoints
- Memory-mapped image section deletion edge cases (`MmFlushImageSection`)

Use Cases:
- Updating self-deleting droppers/agents to work reliably on Windows 11 24H2
- Porting the corrected deletion logic into BOFs and post-ex tooling
- Reproducing and diagnosing NTFS deletion failures via Procmon + kernel debugging
- Blue-team validation/detections for ADS-based “failed self-delete” remnants

Keywords:
Windows 11 24H2, Windows 11 23H2, NTFS, ntfs.sys, self-delete, delete disposition, Alternate Data Streams, ADS, :$DATA, CreateFileW, DELETE access, SetFileInformationByHandle, FileRenameInfo, FILE_RENAME_INFO, NtSetInformationFile, FileDispositionInformationEx, FILE_DISPOSITION_INFORMATION_EX, FILE_DISPOSITION_POSIX_SEMANTICS, FILE_DISPOSITION_DELETE, WinDbg, Procmon, NTSTATUS, MmFlushImageSection, memory-mapped image section, BOF, Ghidra