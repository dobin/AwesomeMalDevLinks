Title:
LoadLibrary madness: dynamically load WinHTTP.dll

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post analyzes why a “manual map”/custom LoadLibrary implementation that avoids standard image-load telemetry breaks WinHTTP.dll, specifically causing WinHTTPOpen to fail with error 126.  
- The author shows that basic reflective loading (copy image, relocations, imports/IAT) is insufficient for full Win32 API compatibility and can trigger secondary LoadLibrary calls (and ETW) when other components can’t find the module.  
- The root cause is WinHTTP calling GetModuleHandleExA with GET_MODULE_HANDLE_EX_FLAG_FROM_ADDRESS, which relies on RtlPcToFileHeader; that routine consults LdrpInvertedFunctionTable and returns 0 when the module wasn’t registered like the native loader would.  
- Two fixes are presented: a “messy” workaround by hijacking GetModuleHandleExA resolution to emulate FROM_ADDRESS behavior via PEB module list scanning, and an “elegant” fix by implementing the missing loader behavior—adding an entry to LdrpInvertedFunctionTable (including .mrdata protection changes and security cookie handling).  
- It’s useful for red teamers/malware developers building OPSEC-conscious implants and for defenders understanding what “fully compatible” manual mapping requires and what artifacts it must touch.

Technical Focus:
- Manual mapping / custom DLL loader internals (relocations, imports, IAT)
- PEB loader lists and LdrpHashTable registration
- GetModuleHandleEx(GET_MODULE_HANDLE_EX_FLAG_FROM_ADDRESS) and RtlPcToFileHeader behavior
- LdrpInvertedFunctionTable and exception handling metadata registration
- .mrdata section protection changes (VirtualProtect) and loader data structures
- Reverse engineering WinHTTP/KERNELBASE/NTDLL loader paths

Use Cases:
- Building stealthier C2 agents that avoid standard LoadLibrary image-load telemetry
- Making manual-mapped DLLs compatible with Win32 APIs (GetModuleHandle/GetProcAddress/LoadLibrary interactions)
- Debugging “works with LoadLibrary but fails when manual-mapped” issues in complex Windows DLLs
- Developing detections around tampering/updates to loader structures (PEB lists, hash table, inverted function table)
- Hardening or validating EDR logic against custom loader behaviors

Keywords:
WinHTTP.dll, WinHTTPOpen, LoadLibrary, manual mapping, reflective DLL loading, ETW, EDR telemetry, PEB, LdrpHashTable, LdrpInsertDataTableEntry, GetModuleHandleExA, GET_MODULE_HANDLE_EX_FLAG_FROM_ADDRESS, BasepGetModuleHandleExW, RtlPcToFileHeader, LdrpInvertedFunctionTable, RtlInsertInvertedFunctionTable, .mrdata, VirtualQuery, VirtualProtect, NTDLL, KERNELBASE, SEH, security cookie, DarkLoadLibrary