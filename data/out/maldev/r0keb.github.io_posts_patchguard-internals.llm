Title:
PatchGuard Internals

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post reverse-engineers Windows Kernel Patch Protection (PatchGuard/KPP) on Windows 11 24H2 and explains how it detects kernel tampering and triggers bugcheck 0x109 (CRITICAL_STRUCTURE_CORRUPTION).  
- It outlines what PatchGuard monitors (e.g., IDT/GDT, MSRs, SSDT, kernel stacks/structures, global variables, and the KPP engine itself) and emphasizes its asynchronous, randomized checking model.  
- The author walks through initialization paths centered on `KiFilterFiberContext()` and related wrappers, including debugger-presence gating and exception-handler-based invocation from `KeInitAmd64SpecificState()`.  
- It describes the PatchGuard “context” structure, how code/pointers are copied and obfuscated (e.g., XOR-based decryption using copied routines like `CmpAppendDllSection`), and how verification entries store target pointers, sizes, and reference checksums.  
- Multiple scheduling/trigger methods are covered (timers + DPCs, PRCB-hidden DPCs via HAL routines, probabilistic system-thread creation with ETHREAD field spoofing, and hijacking legitimate periodic DPCs).  
- Finally, it surveys two bypass classes: boot-time patching (UEFI/bootloader/kernel pre-PG) and hypervisor/EPT “blue pill” approaches that hide modifications from PatchGuard’s view.  
- Useful for kernel exploit devs, rootkit/EDR/anti-cheat researchers, and defenders wanting to understand where integrity checks occur and what artifacts bypasses introduce.

Technical Focus:
- PatchGuard/KPP architecture and protected kernel invariants
- `KiFilterFiberContext()`-driven initialization and call chains in `ntoskrnl.exe`
- PatchGuard context layout, pointer/function harvesting, and XOR/obfuscation
- DPC/timer scheduling and PRCB field abuse for hidden execution
- Bugcheck pipeline (`KeBugCheckEx`/context capture) and 0x109 signaling
- Bypass strategies: boot-time patching vs VT-x/AMD-V hypervisor + EPT cloaking

Use Cases:
- Reverse engineering PatchGuard initialization and check scheduling on modern Windows builds
- Designing kernel instrumentation that avoids PatchGuard-protected structures (or understanding why it fails)
- Building detections for PatchGuard bypass artifacts (boot chain tampering, hypervisor/EPT anomalies, PRCB field misuse)
- Researching kernel integrity mechanisms relevant to EDR/anti-cheat and rootkit tradecraft
- Developing lab PoCs to reproduce 0x109 triggers and validate integrity-check hypotheses

Keywords:
PatchGuard, KPP, Kernel Patch Protection, Windows 11 24H2, ntoskrnl.exe, KiFilterFiberContext, KeInitAmd64SpecificState, PRCB, KDPC, DPC, KeSetCoalescableTimer, SSDT, IDT, GDT, MSR, ETHREAD, KeBugCheckEx, CRITICAL_STRUCTURE_CORRUPTION, 0x109, UEFI bootkit, Secure Boot, VT-x, AMD-V, EPT, hypervisor rootkit, Gbhv, EfiGuard