Title:
Bypassing PESieve and Moneta (The “easy” way I could find)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post details a proof-of-concept approach to evading two popular Windows in-memory scanners: Moneta (runtime IOC scanning like RWX private commits and inline hooks) and PeSieve (memory scanning for injected/modified PE-like regions).  
- For Moneta’s “executable private commit” IOC, it ports the Gargoyle technique to x64: using APC-triggered ROP chains to flip memory protections (RX↔RW) during sleep so the payload is non-executable while dormant without crashing the running thread.  
- To avoid Moneta’s inline-hook detection, it replaces patch-based hooks with a VEH-based redirection using hardware breakpoints (debug registers DR0–DR3) and a vectored exception handler to reroute APIs like Sleep/VirtualAlloc without modifying code bytes.  
- It integrates sRDI for reflective DLL-to-shellcode loading and adds self-cleanup to free the sRDI staging allocation to reduce suspicious regions.  
- For PeSieve, it adds stronger “sleep encryption” by calling advapi32’s SystemFunction032/033 (RC4) from outside the encrypted region, encrypting/decrypting both the beacon and loader around sleep with per-sleep random keys.  
- Useful for red teamers/malware developers building stealthy in-memory implants and for defenders to understand detection gaps and alternative hook telemetry.

Technical Focus:
- Gargoyle-style sleep masking (APC + ROP + VirtualProtect)
- Windows x64 calling convention and shadow space implications for ROP chains
- Hardware-breakpoint + VEH “context hooks” (debug registers, EXCEPTION_SINGLE_STEP)
- Reflective loading via sRDI and staged allocation cleanup (VirtualFree/VirtualQuery)
- Sleep-time payload encryption using SystemFunction032/033 (RC4) from advapi32
- Moneta/PeSieve IOC models (RWX private commits, inline hooks, PE-like memory scanning)

Use Cases:
- Implementing x64 sleep-masking to remove RWX/RX indicators during beacon sleep
- Hooking sensitive APIs (Sleep, VirtualAlloc, GetProcessHeap) without inline patching
- Reducing memory scanner hits by encrypting in-memory payload regions between tasks
- Building PoCs to validate/benchmark Moneta and PeSieve detection logic
- Developing defensive detections for debug-register abuse and VEH-based control-flow redirection

Keywords:
Moneta, PeSieve, Gargoyle, sleep masking, APC, QueueUserAPC, NtTestAlert, ROP chain, VirtualProtect, shadow space, x64 calling convention, VEH, AddVectoredExceptionHandler, EXCEPTION_SINGLE_STEP, hardware breakpoints, DR0 DR1 DR2 DR3 DR7, inline hook evasion, sRDI, reflective DLL injection, VirtualQuery, VirtualFree, SystemFunction032, SystemFunction033, advapi32, RC4, Cobalt Strike beacon, private commit RWX