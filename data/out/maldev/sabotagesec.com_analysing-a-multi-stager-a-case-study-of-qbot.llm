Title:
Analysing a Multi Stager: A case study of QBOT

Type:
Blog Post

Short Summary (4–8 sentences max):
This post is a practical “how-to” guide for analyzing multi-stage malware by pivoting debugging context across processes, using QBot as the case study. It focuses on the common problem where stage-2 executes inside a different (remote) process created and hollowed by stage-1, making single-process debugging insufficient. The author walks through identifying process hollowing by watching key APIs (e.g., GetThreadContext, NtProtectVirtualMemory, ZwWriteVirtualMemory, ResumeThread) and extracting the new entry point written into the target process. The technique uses two debuggers: one for the loader (stage-1) and one attached to the hollowed target (e.g., wermgr.exe) to continue analysis at the injected RWX region. It’s useful for malware analysts and threat researchers who need a repeatable workflow to “jump” into the next stage when execution is redirected. The key value is the methodical breakpointing and address pivoting approach that generalizes beyond QBot.

Technical Focus:
- Process hollowing workflow and entry point redirection
- Thread context manipulation (CONTEXT/EIP) via GetThreadContext
- Remote memory modification (NtProtectVirtualMemory, ZwWriteVirtualMemory)
- Multi-debugger pivoting between loader and target process
- Identifying injected code via RWX memory regions / memory maps

Use Cases:
- Debugging and reversing multi-stage Windows malware that injects into remote processes
- Locating and validating the true stage-2 entry point after hollowing
- Building repeatable lab workflows for staged payload analysis (VM snapshots, dual-debugger setup)
- Threat research triage when initial samples are droppers/loaders with unclear family attribution

Keywords:
QBot, QakBot, multi-stage malware, process hollowing, remote process injection, GetThreadContext, CONTEXT, EIP, ResumeThread, NtProtectVirtualMemory, ZwWriteVirtualMemory, wermgr.exe, msra.exe, iexplore.exe, RWX memory, entry point patching, reverse engineering, Windows internals, debugger pivoting, malware analysis