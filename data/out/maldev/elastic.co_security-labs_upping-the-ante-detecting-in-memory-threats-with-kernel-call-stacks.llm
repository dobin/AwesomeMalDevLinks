Title:
Upping the Ante: Detecting In-Memory Threats with Kernel Call Stacks

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes new kernel call stack–based detection capabilities introduced in Elastic Security Endpoint 8.8 to improve detection of in-memory tradecraft.  
- The problem addressed is attacker evasion of traditional memory signatures and behavior-only telemetry (e.g., sleep-based evasion, injection/hollowing that preserves “normal” process trees).  
- Elastic captures kernel-level call stacks for common endpoint events (process/file/registry/library) and enriches them with module/symbol context plus indicators like “unbacked” memory frames.  
- The article shows how call stack context increases fidelity for detections such as Office macro/XLL execution (e.g., `VBE7.dll`, `xlAutoOpen`), CLR loads from suspicious memory, and persistence via Run keys originating from unbacked code.  
- It also highlights using call stacks to reduce false positives and close evasion gaps in exclusions (e.g., excluding `splwow64.exe` only when the parent stack includes `winspool.drv!OpenPrinter`).  
- Useful primarily for Blue Teams/detection engineers and threat hunters, but also valuable for red teams to understand what modern EDRs can key on beyond user-mode telemetry.

Technical Focus:
- Kernel telemetry and kernel-mode call stack capture
- Call stack enrichment (modules, symbols) and stack-based anomaly detection
- Unbacked memory / RWX regions as execution provenance signals
- Detection of direct syscalls, callback-based evasion, and NTDLL unhooking
- Office macro/XLL execution tracing via stack modules/functions
- EQL-based detection engineering and tuning/exclusions

Use Cases:
- Hunt for process/file/registry activity originating from unbacked or injected code regions
- Increase confidence in Office macro and add-in execution detections using stack modules (e.g., `VBE7.dll`)
- Detect suspicious CLR/.NET runtime loads tied to in-memory loaders (e.g., execute-assembly patterns)
- Reduce noisy persistence detections (Run keys) by requiring suspicious stack provenance
- Identify masquerading/abnormal behavior in “core” Windows processes by profiling expected call stacks
- Build more resilient exclusions that are harder to bypass via hollowing/injection

Keywords:
Elastic Security 8.8, kernel call stacks, EDR telemetry, in-memory threats, unbacked memory, RWX, module stomping, direct syscalls, callback evasion, NTDLL unhooking, LdrLoadDll, Office macros, VBE7.dll, XLL, xlAutoOpen, CLR.DLL, mscoreei.dll, registry Run key, EQL, process hollowing, code injection, WerFault.exe masquerading, wermgr.exe, splwow64.exe, winspool.drv OpenPrinter, Sliver execute-assembly, Cobalt Strike, Brute Ratel, Nighthawk, StealthVector