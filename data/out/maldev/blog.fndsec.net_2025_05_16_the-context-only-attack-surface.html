# https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/

<!DOCTYPE html><html lang="en">

<body class="wp-singular post-template-default single single-post postid-1057 single-format-standard wp-custom-logo wp-embed-responsive wp-theme-pubjinjang is-block-theme customizer-styles-applied jetpack-reblog-enabled">

<a class="skip-link screen-reader-text" id="wp-skip-link" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#wp--skip-link--target">Skip to content</a><div class="wp-site-blocks">
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-2543d70e wp-block-columns-is-layout-flex">
<div class="wp-block-column has-base-color has-contrast-background-color has-text-color has-background is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:30vw">
<div class="wp-block-group is-layout-flow wp-block-group-is-layout-flow wp-container-2 is-position-sticky"></div>
</div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="padding-right:0;padding-left:0;flex-basis:70vw">
<div class="wp-block-group is-vertical is-content-justification-stretch is-layout-flex wp-container-core-group-is-layout-c22364a2 wp-block-group-is-layout-flex" style="border-style:none;border-width:0px;min-height:100vh;padding-top:var(--wp--preset--spacing--40);padding-bottom:var(--wp--preset--spacing--40)">
<main class="wp-block-group has-global-padding is-layout-constrained wp-block-group-is-layout-constrained" id="wp--skip-link--target">
<div class="wp-block-group has-global-padding is-layout-constrained wp-container-core-group-is-layout-41587877 wp-block-group-is-layout-constrained">

<h2 class="has-text-align-center wp-block-post-title">New Process Injection Class: The CONTEXT-Only Attack&nbsp;Surface</h2>


<div class="wp-block-group is-layout-grid wp-container-core-group-is-layout-7d7e7e1f wp-block-group-is-layout-grid"><div class="wp-block-post-date has-small-font-size"><time datetime="2025-05-16T13:25:23+03:00">May 16, 2025</time></div>

<div class="has-text-align-right wp-block-post-time-to-read has-small-font-size">25–37 minutes</div>

<div style="margin-right:0;margin-left:0;margin-top:0;margin-bottom:0" class="taxonomy-post_tag has-text-align-left wp-block-post-terms has-small-font-size"><span class="wp-block-post-terms__prefix">Tags: </span><a href="https://blog.fndsec.net/tag/process-injection/" rel="tag">process injection</a><span class="wp-block-post-terms__separator">, </span><a href="https://blog.fndsec.net/tag/windows/" rel="tag">windows</a></div>


<ul class="wp-block-jetpack-sharing-buttons has-small-icon-size jetpack-sharing-buttons__services-list is-content-justification-right is-layout-flex wp-container-jetpack-sharing-buttons-is-layout-4ae37c7b wp-block-jetpack-sharing-buttons-is-layout-flex" id="jetpack-sharing-serivces-list" style="margin-top:0;margin-right:0;margin-bottom:0;margin-left:0"><li class="jetpack-sharing-button__list-item tooltip"><a href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/" target="_blank" rel="nofollow noopener noreferrer" class="jetpack-sharing-button__button style-icon share-share" style="" data-service="share" data-shared="sharing-share-1057" aria-labelledby="sharing-share-1057"><span id="sharing-share-1057">Share using Native tools</span><svg class="social-logo social-logo-share" height="24" width="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path d="M18 16c-.788 0-1.499.31-2.034.807L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.048 4.118A2.981 2.981 0 0015 19a3 3 0 103-3z"></path></g></svg><span class="jetpack-sharing-button__service-label" aria-hidden="true">Share</span><span class="tooltiptext" aria-live="assertive">Copied to clipboard</span></a></li>

<li class="jetpack-sharing-button__list-item"><a href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/?share=x&amp;nb=1" target="_blank" rel="nofollow noopener noreferrer" class="jetpack-sharing-button__button style-icon share-x" style="" data-service="x" data-shared="sharing-x-1057" aria-labelledby="sharing-x-1057"><span id="sharing-x-1057">Share on X (Opens in new window)</span><svg class="social-logo social-logo-x" height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g><path d="M13.982 10.622L20.54 3h-1.554l-5.693 6.618L8.745 3H3.5l6.876 10.007L3.5 21h1.554l6.012-6.989L15.868 21h5.245l-7.131-10.378zm-2.128 2.474l-.697-.997-5.543-7.93H8l4.474 6.4.697.996 5.815 8.318h-2.387l-4.745-6.787z"></path></g></svg><span class="jetpack-sharing-button__service-label" aria-hidden="true">X</span></a></li>

<li class="jetpack-sharing-button__list-item"><a href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/?share=linkedin&amp;nb=1" target="_blank" rel="nofollow noopener noreferrer" class="jetpack-sharing-button__button style-icon share-linkedin" style="" data-service="linkedin" data-shared="sharing-linkedin-1057" aria-labelledby="sharing-linkedin-1057"><span id="sharing-linkedin-1057">Share on LinkedIn (Opens in new window)</span><svg class="social-logo social-logo-linkedin" height="24" width="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path d="M19.7 3H4.3A1.3 1.3 0 003 4.3v15.4A1.3 1.3 0 004.3 21h15.4a1.3 1.3 0 001.3-1.3V4.3A1.3 1.3 0 0019.7 3zM8.339 18.338H5.667v-8.59h2.672v8.59zM7.004 8.574a1.548 1.548 0 11-.002-3.096 1.548 1.548 0 01.002 3.096zm11.335 9.764H15.67v-4.177c0-.996-.017-2.278-1.387-2.278-1.389 0-1.601 1.086-1.601 2.206v4.249h-2.667v-8.59h2.559v1.174h.037c.356-.675 1.227-1.387 2.526-1.387 2.703 0 3.203 1.779 3.203 4.092v4.711z"></path></g></svg><span class="jetpack-sharing-button__service-label" aria-hidden="true">LinkedIn</span></a></li>

<li class="jetpack-sharing-button__list-item"><a href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/?share=whatsapp&amp;nb=1" target="_blank" rel="nofollow noopener noreferrer" class="jetpack-sharing-button__button style-icon share-whatsapp" style="" data-service="whatsapp" data-shared="sharing-whatsapp-1057" aria-labelledby="sharing-whatsapp-1057"><span id="sharing-whatsapp-1057">Share on WhatsApp (Opens in new window)</span><svg class="social-logo social-logo-whatsapp" height="24" width="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path d="M2.048 22l1.406-5.136a9.894 9.894 0 01-1.323-4.955C2.133 6.446 6.579 2 12.042 2a9.848 9.848 0 017.011 2.906 9.85 9.85 0 012.9 7.011c-.002 5.464-4.448 9.91-9.91 9.91h-.004a9.913 9.913 0 01-4.736-1.206L2.048 22zm5.497-3.172l.301.179a8.214 8.214 0 004.193 1.148h.003c4.54 0 8.235-3.695 8.237-8.237a8.189 8.189 0 00-2.41-5.828 8.182 8.182 0 00-5.824-2.416c-4.544 0-8.239 3.695-8.241 8.237a8.222 8.222 0 001.259 4.384l.196.312-.832 3.04 3.118-.819zm9.49-4.554c-.062-.103-.227-.165-.475-.289-.248-.124-1.465-.723-1.692-.806-.227-.083-.392-.124-.557.124-.165.248-.64.806-.784.971-.144.165-.289.186-.536.062-.248-.124-1.046-.385-1.991-1.229-.736-.657-1.233-1.468-1.378-1.715-.144-.248-.015-.382.109-.505.111-.111.248-.289.371-.434.124-.145.165-.248.248-.413.083-.165.041-.31-.021-.434s-.557-1.343-.763-1.839c-.202-.483-.407-.417-.559-.425-.144-.007-.31-.009-.475-.009a.91.91 0 00-.66.31c-.226.248-.866.847-.866 2.066 0 1.219.887 2.396 1.011 2.562.124.165 1.746 2.666 4.23 3.739.591.255 1.052.408 1.412.522.593.189 1.133.162 1.56.098.476-.071 1.465-.599 1.671-1.177.206-.58.206-1.075.145-1.179z"></path></g></svg><span class="jetpack-sharing-button__service-label" aria-hidden="true">WhatsApp</span></a></li></ul>
</div>


<div class="entry-content wp-block-post-content is-layout-flow wp-block-post-content-is-layout-flow">
<p class="wp-block-paragraph">Written by <strong><em>Yehuda Smirnov, Hoshea Yarden, Hai Vaknin and Noam Pomerantz</em></strong></p>



<ol><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#tl-dr">TL;DR</a></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#introduction-1">Introduction</a><ol><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#why-loadlibrary">Why LoadLibrary?</a></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#shared-memory-101">Shared Memory&nbsp;101</a></li></ol></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#pointer-only-loadlibrary-injection">Pointer‑Only LoadLibrary&nbsp;Injection</a></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#investigation-etw-lookup">Investigating Remote-Thread Creation Noise with ETW</a></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#createremotethread-setthreadcontext-injection">CreateRemoteThread + SetThreadContext Injection</a><ol><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#createremotethread-limitations">CreateRemoteThread Limitations</a></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#windows-x64-calling-convention-101">Windows x64 Calling Convention 101</a></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#troubleshooting-research-1">Troubleshooting &amp; Research</a></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#proof-of-concept">Proof of Concept</a></li></ol></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#ntcreatethread-context-injection">NtCreateThread Context Injection</a><ol><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#troubleshooting-research">Troubleshooting &amp; Research</a></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#proof-of-concept-1">Proof of Concept</a></li></ol></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#redirectthread-tool">RedirectThread Tool</a></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#injection-detection-logic-theory">Injection Detection Logic Theory</a></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#research-notes-1">Research Notes</a></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#a-note-on-ghostwriting-and-related-work">A Note on “GhostWriting” and Related Work</a></li><li><a class="wp-block-table-of-contents__entry" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#conclusion">Conclusion</a></li></ol>



<h1 class="wp-block-heading" id="tl-dr">TL;DR</h1>



<p class="wp-block-paragraph">Most process injection techniques follow a familiar pattern:<br><strong>allocate → write → execute</strong>.</p>



<p class="wp-block-paragraph">In this research, we ask: <em>what if we skip allocation and writing entirely?</em></p>



<p class="wp-block-paragraph">By focusing on <strong>execution-only primitives</strong>, we found distinct approaches to inject code <strong>without allocating / writing memory</strong>:</p>



<ol class="wp-block-list">
<li>Inject a DLL using <strong>only</strong> <code>CreateRemoteThread</code>.</li>



<li>Call arbitrary WinAPI functions with parameters using <strong><code>SetThreadContext</code></strong>.</li>



<li>Utilize <strong><code>NtCreateThread</code></strong> to remotely <span style="text-decoration: underline">allocate</span>, <span style="text-decoration: underline">write</span> and <span style="text-decoration: underline">execute</span> shellcode.</li>



<li>Expand the technique to APC functions such as <code>QueueUserAPC</code>.</li>
</ol>



<p class="has-text-align-center wp-block-paragraph"><strong>Find the <a href="https://github.com/Friends-Security/RedirectThread"><strong>RedirectThread </strong>Github repo here</a></strong></p>



<h1 class="wp-block-heading" id="introduction-1">Introduction</h1>



<p class="wp-block-paragraph">Modern <strong>Endpoint Detection &amp; Response (EDR)</strong> stacks typically watch for three signs of classic process‑injection:</p>



<ol class="wp-block-list">
<li>Allocation of fresh memory ( <code>VirtualAlloc[Ex]</code> )</li>



<li>Modification of that memory ( <code>WriteProcessMemory</code> , <code>VirtualProtect</code>)</li>



<li>Execution to it ( <code>CreateRemoteThread</code>, APCs, etc.). </li>
</ol>



<p class="wp-block-paragraph">Our goal in this research was to test the lower bound: <strong>can we trigger <em><strong>only</strong></em> the execution primitive, skipping both allocation and write primitives, yet still land malicious code in the target?</strong></p>



<p class="wp-block-paragraph">The idea started with a rumor that <span style="text-decoration: underline"><a href="http://by%20focusing%20exclusively%20on%20execution-only%20primitives,%20we%20uncovered%20four%20distinct%20approaches%20to%20hijacking%20execution%20without%20touching%20memory%20allocation%20or%20modification/">huge memory pages</a></span> are always allocated and mapped as <strong>read–write–execute (RWX)</strong>, even not specifically requesting these.</p>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p class="wp-block-paragraph">Post Research Note: when we tested this, it wasn’t the case. </p>
</blockquote>



<p class="wp-block-paragraph">This raised a natural question:<br><strong>Would security tools treat this differently from a typical RWX allocation?</strong></p>



<p class="wp-block-paragraph">If so, skipping the <strong>allocation part</strong> of the chain could bypass part of the usual detection logic. And if that’s possible, what about skipping the <strong>data injection</strong> step too?<strong> If the bytes we need already live inside the target, we might not actually have to write anything new at all.</strong></p>



<p class="wp-block-paragraph">This sparked an idea:</p>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p class="wp-block-paragraph"><em>If we already have valid, addressable data inside the target process, could we take the classic DLL injection – the <strong><em>LoadLibrary</em></strong></em> <em>method, and simply point it at existing data within the target process, then let Windows do the rest?</em></p>
</blockquote>



<h2 class="wp-block-heading" id="why-loadlibrary">Why LoadLibrary?</h2>



<p class="wp-block-paragraph"><code>LoadLibraryA/W</code> automatically appends “<strong>.dll</strong>” to whatever string pointer it receives and then resolves the usual DLL search order&nbsp;(<a href="https://stackoverflow.com/questions/14031749/where-is-loadlibrary-a-looking-for-the-file">stackoverflow.com</a>). With that behavior we can find an <strong>existing in‑process string</strong> (e.g. “<code>0</code>“) and drop a file named (for example) <code>0.dll</code> somewhere earlier in the search path.</p>



<p class="wp-block-paragraph">This would launch a remote thread whose start routine is <code>LoadLibraryA</code>, with its argument set to a character pointer (e.g., “<code>0</code>“), finally causing the DLL to be loaded into the target process.</p>



<p class="wp-block-paragraph"><em>But how are we going to find this existing in-process string?</em></p>



<h2 class="wp-block-heading" id="shared-memory-101">Shared Memory&nbsp;101</h2>



<p class="wp-block-paragraph">When Windows maps <strong>file‑backed sections</strong> (e.g.,&nbsp;<em><code>ntdll.dll</code></em>) into <em>multiple </em>user‑mode processes, the sections are backed by the <em>same</em> physical memory; each process merely receives its own virtual‑address view.</p>



<p class="wp-block-paragraph"><strong><a href="https://learn.microsoft.com/en-us/windows/win32/memory/memory-protection">Copy-On-Write</a></strong> protects <em>shared memory regions</em> until a process attempts to modify them. At that point, the <strong>kernel</strong> creates a <strong>private copy</strong> of the page to ensure the process <strong>does not alter</strong> memory that’s <em>shared across all processes</em> in the system.</p>



<p class="wp-block-paragraph">Since Windows Vista, <strong>ASLR randomizes</strong> base addresses every startup. <strong>System DLLs</strong> are loaded at a <strong>consistent base address across all processes</strong> to optimize relocation performance.<br>As a result, an offset like <code>ntdll + 0x4</code> should point to the <strong>same bytes</strong> in <em>all processes</em>.</p>



<p class="wp-block-paragraph">Then we can locate a pointer to a character locally and reuse the address when calling <code>LoadLibraryA</code> in the target process.</p>



<p class="wp-block-paragraph">Many convenient string literals live in <code>ntdll.dll</code> which is loaded by all processes. We chose to use “<code>0</code>” for our case.</p>



<hr class="wp-block-separator has-alpha-channel-opacity">



<h1 class="wp-block-heading" id="pointer-only-loadlibrary-injection">Pointer‑Only LoadLibrary&nbsp;Injection</h1>



<p class="wp-block-paragraph">The Proof‑of‑Concept below demonstrates the minimal steps required to turn that idea into a working process‑injection primitive.</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1489" data-permalink="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/image-59/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/05/image.png" data-orig-size="1283,804" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/05/image.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/05/image.png?w=1024" width="1024" height="641" src="https://blog.fndsec.net/wp-content/uploads/2025/05/image.png?w=1024" alt="" class="wp-image-1489"></figure>



<ol start="1" class="wp-block-list">
<li><strong>Locate an in‑process string</strong>
<ul class="wp-block-list">
<li>Search <code>ntdll.dll</code> for a static ASCII string such as “<code>0</code>” (<code>0x30 0x00</code>). Because the <strong>DLL is mapped at the same offset</strong> in both the target process and our own process, the virtual address should be valid across both processes.</li>
</ul>
</li>
</ol>



<figure class="wp-block-image aligncenter size-large has-custom-border"><img data-attachment-id="1100" data-permalink="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/image-49/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-4.png" data-orig-size="673,315" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-4.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-4.png?w=673" width="673" height="315" src="https://blog.fndsec.net/wp-content/uploads/2025/04/image-4.png?w=673" alt="" class="has-border-color has-contrast-border-color wp-image-1100"><figcaption class="wp-element-caption">ntdll.dll being mapped into the same addresses between processes</figcaption></figure>



<ul class="wp-block-list">
<li><strong>Prepare the payload DLL</strong>
<ul class="wp-block-list">
<li>Build <code>0.dll</code> with implant of choice.</li>



<li>Drop the DLL into a directory that resolves via search order.</li>
</ul>
</li>
</ul>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p class="wp-block-paragraph">We are <em>not</em> necessarily limited to classic search‑order hijacking. Perhaps it is possible to abuse <code>DefineDosDeviceW</code> or <strong>NT symbolic links</strong> to load the payload from arbitrary locations such as SMB shares or WebDAV mounts.</p>
</blockquote>



<ol start="2" class="wp-block-list">
<li><strong>Create the remote thread</strong></li>
</ol>



<ul class="wp-block-list">
<li><em>Note that the address of <code>LoadLibraryA</code> is obtained from our own process, similar to the method in step 1. </em></li>
</ul>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_77417" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HANDLE</code> <code class="cpp plain">hThread = CreateRemoteThread(</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">hProcess,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">NULL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="cpp comments">// default security</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="cpp comments">// default stack size</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">(LPTHREAD_START_ROUTINE)GetProcAddress(GetModuleHandleA(</code><code class="cpp string">"kernel32"</code><code class="cpp plain">), </code><code class="cpp string">"LoadLibraryA"</code><code class="cpp plain">),</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">(</code><code class="cpp color1 bold">LPVOID</code><code class="cpp plain">)0x7FFE0300, </code><code class="cpp comments">// pointer to shared NUL byte inside ntdll</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="cpp comments">// run immediately</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">NULL);</code></div></div></td></tr></tbody></table></div></div></div>


<ol start="3" class="wp-block-list">
<li><strong>Execution</strong>
<ul class="wp-block-list">
<li><code>LoadLibraryA</code> appends “.dll”, resolves the path, and loads <code>0.dll</code> into the target process:</li>
</ul>
</li>
</ol>



<figure class="wp-block-image size-full has-custom-border"><img data-attachment-id="2053" data-permalink="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/dllinject1/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/05/dllinject1.gif" data-orig-size="1233,648" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="dllinject1" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/05/dllinject1.gif?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/05/dllinject1.gif?w=1024" width="1233" height="648" src="https://blog.fndsec.net/wp-content/uploads/2025/05/dllinject1.gif" alt="" class="has-border-color has-contrast-border-color wp-image-2053"></figure>



<p class="wp-block-paragraph">We got an unexpected but exciting result:</p>



<ul class="wp-block-list">
<li>By skipping memory allocation and writing, a <strong>well-known injection technique has bypassed detection</strong> in two industry leading EDRs.
<ul class="wp-block-list">
<li>We also tested the <strong>regular DLL injection</strong> technique (which involves <em>writing memory</em>), and it was detected by both EDRs.</li>
</ul>
</li>



<li>This small tweak revealed that many techniques rely on the same early-stage behavior and how <strong>easily that behavior can be avoided</strong>.</li>
</ul>



<p class="wp-block-paragraph">This led us to rethink the injection chain:</p>



<ul class="wp-block-list">
<li>Most techniques follow the same pattern: <strong>inject data → trigger execution</strong>.</li>



<li>Across many of them, the <strong>execution trigger</strong> is the common piece.</li>
</ul>



<p class="wp-block-paragraph">So we asked:</p>



<ul class="wp-block-list">
<li><strong>Do we really need to inject data at all?</strong></li>



<li><strong>What if we just focused on the execution trigger?</strong></li>
</ul>



<p class="wp-block-paragraph">Instead of swapping out each part of the chain, we <strong>doubled down on the trigger</strong> and pushed to see <strong>how far we could go with just that</strong>.</p>



<hr class="wp-block-separator has-alpha-channel-opacity">



<h1 class="wp-block-heading" id="investigation-etw-lookup">Investigating Remote-Thread Creation Noise with ETW</h1>



<p class="wp-block-paragraph">Before diving deeper, we took a quick detour prompted by a simple question:</p>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p class="wp-block-paragraph"><strong>Is this just a detection oversight?</strong><br>Why don’t security products flag <em>any</em> remote thread creation as malicious? Isn’t it rare enough to catch with a simple whitelist?</p>
</blockquote>



<p class="wp-block-paragraph">Turns out — not at all. Remote thread creation is surprisingly common and is  used by:</p>



<ul class="wp-block-list">
<li>Application resource monitors</li>



<li>Performance profilers</li>



<li>Instrumentation and tracing tools</li>



<li>Debuggers, compatibility shims, accessibility helpers</li>



<li>Enterprise agents and endpoint frameworks</li>
</ul>



<p class="wp-block-paragraph">To measure the baseline “noise”, we wrote a small ETW-based tracer to capture and correlate thread creation events where the <strong>creator PID ≠ target PID</strong>. <strong>ETW</strong> gave us all the data we needed.</p>



<p class="wp-block-paragraph">Looking through the data captured of <strong>less than a minute</strong> <span style="text-decoration: underline">on a clean Windows install</span>, we already find some thread creation across different processes:</p>



<figure class="wp-block-image aligncenter size-large is-resized has-custom-border"><img data-attachment-id="1210" data-permalink="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/image-53/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-8.png" data-orig-size="757,752" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-8.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-8.png?w=757" loading="lazy" width="757" height="752" src="https://blog.fndsec.net/wp-content/uploads/2025/04/image-8.png?w=757" alt="" class="has-border-color has-contrast-border-color wp-image-1210" style="aspect-ratio:1.0066071057552461;width:603px;height:auto"><figcaption class="wp-element-caption"><a href="https://github.com/Friends-Security/RedirectThread/blob/master/ETWThreadCreationNoise/FindRemoteThreadsETW.ps1">FindRemoteThreads.ps1</a></figcaption></figure>



<p class="wp-block-paragraph">At this point, we already felt it was worth digging deeper into the execution trigger, while avoiding allocation and modification.</p>



<p class="wp-block-paragraph">If EDRs don’t flag malicious activity based on the execution step alone, even when using the infamous <code>CreateRemoteThread</code>, then the question becomes: <strong>how powerful is this primitive, and where can we take it next?</strong></p>



<hr class="wp-block-separator has-alpha-channel-opacity">



<h1 class="wp-block-heading" id="createremotethread-setthreadcontext-injection">CreateRemoteThread + SetThreadContext Injection</h1>



<p class="wp-block-paragraph">Our first thought on leveraging <code>CreateRemoteThread</code> further was to avoid dropping a DLL to disk and attempt to implement a memory only injection with it. We aimed to achieve a similar power to the classic remote <code>Allocate</code> → <code>Modify</code> → <code>Execute</code> chain.</p>



<p class="wp-block-paragraph"><strong>The obvious question is:</strong> why not just call those functions <em>directly</em> inside the remote process?</p>



<p class="wp-block-paragraph">If the new thread we create inside the target process is designed to allocate and modify memory <strong>within its own process</strong>, then we can simply take the existing techniques for remote memory allocation/modification and adapt them into <strong>‘self’-allocation/self-modification</strong> methods.</p>



<p class="wp-block-paragraph">Even better, we can use <strong>any local functionality</strong> already available in the target process for our primitives — instead of being restricted to just WinAPI or syscalls that support remote operations.</p>



<p class="wp-block-paragraph">After all, there’s <em>nothing</em> suspicious about a process reading from or writing to <strong>its own memory</strong>.</p>



<p class="wp-block-paragraph">We would basically change this:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1518" data-permalink="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/image-60/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/05/image-1.png" data-orig-size="1235,174" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/05/image-1.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/05/image-1.png?w=1024" loading="lazy" width="1024" height="144" src="https://blog.fndsec.net/wp-content/uploads/2025/05/image-1.png?w=1024" alt="" class="wp-image-1518"></figure>



<p class="wp-block-paragraph">With this:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1519" data-permalink="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/image-61/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/05/image-2.png" data-orig-size="1240,177" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/05/image-2.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/05/image-2.png?w=1024" loading="lazy" width="1024" height="146" src="https://blog.fndsec.net/wp-content/uploads/2025/05/image-2.png?w=1024" alt="" class="wp-image-1519"></figure>



<h2 class="wp-block-heading" id="createremotethread-limitations">CreateRemoteThread Limitations</h2>



<p class="wp-block-paragraph">The first problem we encountered with <strong><code>CreateRemoteThread</code></strong> was its <strong>parameter limitation</strong>. The API accepts only a pointer to the start routine (the code to execute) and a single pointer to its first argument.</p>



<p class="wp-block-paragraph">While one parameter is enough for simple APIs like <code>LoadLibrary</code>, calling more useful functions becomes difficult. For example, <code>VirtualAlloc</code> and <code>WriteProcessMemory</code> both require <strong>four parameters</strong>.</p>



<p class="wp-block-paragraph">Another issue is that any additional parameters (beyond the first) are <strong>not guaranteed to be NULL</strong>—they’re often just <strong>undefined garbage data</strong>. For instance, if you call <code>MessageBox</code>, you <em>will</em> get a message box in the remote process, but the <strong>title (2nd param)</strong> and <strong>text (3rd param)</strong> will likely be junk.</p>



<p class="wp-block-paragraph">For our targets, we needed <strong>full control over all four parameters</strong>. Luckily, there’s a straightforward method to achieve this, which also acts as an execution trigger: <strong>Hijacking Thread Context</strong>.</p>



<p class="wp-block-paragraph">By using APIs such as <code>SetThreadContext</code>, we can configure a target thread in the remote process to run <code>VirtualAlloc</code> and <code>WriteProcessMemory</code> with up to <strong>four controlled parameters</strong>.</p>



<p class="wp-block-paragraph">With this limitation bypassed, we’re now free to call <strong>runtime functions</strong> like <code>malloc</code>, <code>memset</code>, <code>memcpy</code>, and also <strong>system-native functions</strong> such as <code>RtlFillMemory</code>, <code>HeapAlloc</code> and more.</p>



<p class="wp-block-paragraph">Before we continue to exactly how, let’s do a quick <strong>refresher on the x64 calling convention</strong> and how it relates to the <code>CONTEXT</code> struct which we use extensively.</p>



<h2 class="wp-block-heading" id="windows-x64-calling-convention-101">Windows x64 Calling Convention 101</h2>



<p class="wp-block-paragraph">The <strong>x64 calling convention</strong> passes the first four arguments to a function via registers (<code>RCX</code>, <code>RDX</code>, <code>R8</code>, <code>R9</code>), and the remaining arguments are passed on the stack. </p>



<figure class="wp-block-image size-large has-custom-border"><img data-attachment-id="1137" data-permalink="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/image-51/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-6.png" data-orig-size="953,268" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-6.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-6.png?w=953" loading="lazy" width="953" height="268" src="https://blog.fndsec.net/wp-content/uploads/2025/04/image-6.png?w=953" alt="" class="has-border-color has-contrast-border-color wp-image-1137"><figcaption class="wp-element-caption">Taken from <a href="https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170#parameter-passing">MSDN</a></figcaption></figure>



<p class="is-style-default wp-block-paragraph">Practically speaking: If we can control the <code>CONTEXT</code> of a thread, we can <strong>set the <code>RIP</code> (instruction pointer) to any function we want</strong> to execute, and set up the registers to pass the appropriate arguments to that function.</p>



<p class="wp-block-paragraph">For our second injection proof-of-concept, we aimed to adapt the classic <strong>Thread Hijacking</strong> technique: <strong><code>SuspendThread</code> → <code>SetThreadContext</code> → <code>ResumeThread</code></strong> — but apply it to a <strong>newly created thread</strong>.</p>



<p class="wp-block-paragraph">Our intended flow looked like this:<br><strong><code>CreateRemoteThread</code> (Suspended) → <code>SetThreadContext</code> → <code>ResumeThread</code></strong></p>



<p class="wp-block-paragraph">This approach turned out to be <strong>challenging</strong>. However, we successfully worked around the issues while sticking to our rule: <strong>never use standard remote memory allocation or modification</strong>.</p>



<h2 class="wp-block-heading" id="troubleshooting-research-1">Troubleshooting &amp; Research</h2>



<p class="wp-block-paragraph">This section is about the problems we’ve encountered and how we overcame those, it gets a bit technical and perhaps heavy, but we wanted to share our methodology.</p>



<details style="border:1px solid #ccc;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.1);padding:0.5em;margin:1em 0"><summary style="cursor:pointer;font-weight:500">Show Sections</summary>



<h3 class="wp-block-heading" id="issue-empty-initial-stack">Issue – Empty Initial Stack</h3>



<p class="wp-block-paragraph"><strong>Setup</strong></p>



<p class="wp-block-paragraph">First we’ve tried creating a new thread in a <strong>suspended</strong> state. Then we overwrite its <code>CONTEXT</code> struct so that when we resume the thread, it jumps right into <code>VirtualAlloc</code>.</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_732426" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">RIP&nbsp; = &amp;pVirtualAlloc</code></div><div class="line number2 index1 alt1"><code class="cpp plain">RCX = param1</code></div><div class="line number3 index2 alt2"><code class="cpp plain">RDX = param2</code></div><div class="line number4 index3 alt1"><code class="cpp plain">R8&nbsp; = param3</code></div><div class="line number5 index4 alt2"><code class="cpp plain">R9&nbsp; = param4</code></div></div></td></tr></tbody></table></div></div></div>


<p class="wp-block-paragraph"><strong>Result</strong></p>



<p class="wp-block-paragraph">We get a <strong>memory access violation crash</strong> on the return from <code>VirtualAlloc</code>.</p>



<p class="wp-block-paragraph"><strong>Root cause</strong></p>



<ul class="wp-block-list">
<li>The thread starts with an <strong>empty stack</strong>.</li>



<li><code>VirtualAlloc</code> executes fine and returns to its caller, but the caller’s return address is zero. That is because the return address is normally <span style="text-decoration: underline">pushed to the stack by the thread‑startup stub</span>, which did not happen.</li>



<li>Dereferencing the null return address triggers the memory access violation.</li>
</ul>



<p class="wp-block-paragraph"><strong>Why <code>CreateRemoteThread</code> doesn’t crash in 1‑arg cases</strong></p>



<ul class="wp-block-list">
<li>When you let Windows launch a thread normally, execution begins in the<br><strong>native startup stub</strong> (<code>RtlUserThreadStart</code> → <code>BaseThreadInitThunk</code>).</li>



<li>The stub sets up a proper stack frame, calls your target routine, then<br>finishes with <code>ExitThread</code>.</li>



<li>However, when you forcibly set RIP to a function such as <code>VirtualAlloc</code>, the <strong>thread starts inside the function</strong> and seems to skip the native startup stub. This means <span style="text-decoration: underline">the thread can’t go to <code>ExitThread</code> once it’s done</span>. </li>
</ul>



<h3 class="wp-block-heading" id="trial-2-stealing-valid-stack-from-another-thread">Trial 2 – Stealing Valid Stack from Another Thread</h3>



<p class="wp-block-paragraph"><strong>Idea</strong></p>



<p class="wp-block-paragraph">Reuse the stack of a “sacrificial” thread that is sleeping forever using <code>SleepEx</code> (<code>NtDelayExecution</code>).<strong> </strong>The hope is that <strong>the call stack of the sacrificial sleep thread would be</strong> <strong>clean and safe to return through</strong>.<br>If the thread had been paused <strong>mid-call</strong>, say during stack setup (after the prologue but before the epilogue), we might need to <strong>realign the stack manually</strong>, e.g., adjusting <code>RSP += 16</code> to compensate.</p>



<p class="wp-block-paragraph"><strong>Plan</strong></p>



<ol class="wp-block-list">
<li><strong>Spawn sacrificial thread</strong> 
<ul class="wp-block-list">
<li><code>CreateRemoteThread( hProc, NULL, 0, Sleep, (LPVOID)INFINITE, 0, NULL);</code></li>
</ul>
</li>



<li><strong>Wait</strong> until the thread is inside <code>NtDelayExecution</code>.</li>



<li><strong>Grab its stack pointer</strong> 
<ul class="wp-block-list">
<li><code>CONTEXT ctx; </code></li>



<li><code>GetThreadContext(hSleep, &amp;ctx); </code></li>



<li><code>uintptr_t sleepRsp = ctx.Rsp;</code></li>
</ul>
</li>



<li><strong>Create a second thread (suspended)</strong> and overwrite its <code>CONTEXT</code>:</li>
</ol>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_564106" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">RIP = &amp;VirtualAlloc</code></div><div class="line number2 index1 alt1"><code class="cpp plain">RSP = sleepRsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="cpp comments">// borrow stack from the sleeping thread</code></div><div class="line number3 index2 alt2"><code class="cpp plain">RCX, RDX, R8, R9 = args </code><code class="cpp comments">// first four params</code></div></div></td></tr></tbody></table></div></div></div>


<ol start="5" class="wp-block-list">
<li><strong>Resume</strong> the second thread.</li>
</ol>



<p class="wp-block-paragraph"><strong>Outcome</strong></p>



<ul class="wp-block-list">
<li><strong>Crash</strong> on return to the native startup stub.</li>



<li>Reason: the borrowed stack is valid, <strong>but the new thread’s TEB is empty</strong>.
<ul class="wp-block-list">
<li><code>BaseThreadInitThunk</code> expects initialized fields (SEH list, TLS, etc.).</li>



<li>Dereferencing <code>TEB → NtTib.ExceptionList</code> (still NULL) triggers a memory access violation.</li>
</ul>
</li>
</ul>



<p class="wp-block-paragraph"><strong>Lesson</strong></p>



<p class="wp-block-paragraph">A good stack alone isn’t enough. Each thread gets a fresh <strong>Thread Environment Block (TEB)</strong>, and the kernel points the <code>GS</code> register to it. Returning into code that assumes those TEB fields are initialized will fail.</p>



<p class="wp-block-paragraph">Our next idea was to <strong>hijack the sleeping thread itself</strong> instead of repurposing its stack.</p>



<h3 class="wp-block-heading" id="trial-3-hijacking-the-sacrificial-sleep-thread">Trial 3 – Hijacking the Sacrificial Sleep Thread</h3>



<p class="wp-block-paragraph"><strong>Goal</strong><br>Hijack execution of a thread with a fully‑initialized TEB and stack <strong>after</strong> it enters <code>SleepEx</code>.</p>



<p class="wp-block-paragraph"><strong>Intended call‑stack</strong></p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_522006" class="syntaxhighlighter nogutter  plain"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="plain plain">RtlUserThreadStart</code></div><div class="line number2 index1 alt1"><code class="plain spaces">&nbsp;</code><code class="plain plain">↳ BaseThreadInitThunk</code></div><div class="line number3 index2 alt2"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">↳ Sleep → SleepEx → NtDelayExecution</code></div><div class="line number4 index3 alt1"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">↳ (context switch) → VirtualAlloc</code></div></div></td></tr></tbody></table></div></div></div>


<p class="wp-block-paragraph"><strong>Steps</strong></p>



<ol class="wp-block-list">
<li><strong>Launch a sleeper</strong> thread for 1 second:
<ul class="wp-block-list">
<li><code>HANDLE hT = CreateRemoteThread( hProc, NULL, 0, Sleep, (LPVOID)1000, 0, NULL);</code></li>
</ul>
</li>



<li><strong>Wait</strong> until <code>RIP</code> sits inside <code>NtDelayExecution</code>.</li>



<li><strong>Hijack context</strong> while the thread is still sleeping: 
<ul class="wp-block-list">
<li><code>RIP = &amp;VirtualAlloc </code></li>



<li><code>RCX,RDX,R8,R9 = desired parameters </code></li>



<li><code>RSP left unchanged</code></li>
</ul>
</li>



<li>Let the timer expire; the thread should resume directly in <code>VirtualAlloc</code>.</li>
</ol>



<p class="wp-block-paragraph"><strong>Outcome</strong></p>



<ul class="wp-block-list">
<li><code>RIP</code> <strong>changed as expected</strong> — execution reached <code>VirtualAlloc</code>.</li>



<li>All <strong>other registers were junk</strong>; <code>VirtualAlloc</code> failed and the process crashed on return.</li>
</ul>



<p class="wp-block-paragraph"><strong>Take‑away:</strong> during a timed sleep, only <code>RIP</code> is reliably written. The kernel’s wait‑resume path seems to overwrite or ignore the rest of the supplied context.</p>



<p class="wp-block-paragraph"><strong>Where we pivot next</strong></p>



<p class="wp-block-paragraph">A cleaner target is a thread that is <strong>running yet idle</strong> – not blocked in a kernel wait but is post initialization. <br>That insight leads to <strong>Trial 4</strong>, where we start the thread in a minimal endless‑loop gadget that is trivial to hijack.</p>



<h3 class="wp-block-heading" id="trial-4-sleep-alternative-the-loop-gadget-and-cfg">Trial 4 – Sleep alternative, the Loop Gadget and CFG</h3>



<p class="wp-block-paragraph"><strong>Idea</strong><br>Start the thread in a <em>busy‑wait</em> loop (<code>JMP -2</code>) that touches no registers, then hijack its context.</p>



<p class="wp-block-paragraph"><strong>Why the <code>EB FE</code> gadget?</strong></p>



<ul class="wp-block-list">
<li>It’s a two‑byte <strong>“<code>jmp ‑2</code>”</strong> instruction — an infinite loop.</li>



<li>Easy to locate in any executable module; we simply scan our own <code>ntdll</code> for it and reuse the same address in the target process.</li>



<li>Leaves every register except <strong>RIP</strong> untouched, so no collateral damage.</li>
</ul>



<p class="wp-block-paragraph"><strong>Expected call‑stack</strong></p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_837820" class="syntaxhighlighter nogutter  plain"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="plain plain">RtlUserThreadStart</code></div><div class="line number2 index1 alt1"><code class="plain spaces">&nbsp;</code><code class="plain plain">↳ BaseThreadInitThunk</code></div><div class="line number3 index2 alt2"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">↳ [loop gadget: EB FE]</code></div><div class="line number4 index3 alt1"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">↳ (context hijack) → VirtualAlloc</code></div></div></td></tr></tbody></table></div></div></div>


<p class="wp-block-paragraph"><strong>Procedure</strong></p>



<ol class="wp-block-list">
<li><strong>Create</strong> a remote thread whose start address is the loop gadget.</li>



<li><strong>Wait</strong> until it spins inside the loop.</li>



<li><strong>SetThreadContext</strong> 
<ul class="wp-block-list">
<li><code>RIP = &amp;VirtualAlloc </code></li>



<li><code>RCX,RDX,R8,R9 = params </code></li>



<li><code>RSP unchanged</code></li>
</ul>
</li>



<li>Thread executes our function (no suspend/resume needed; the thread is already running).</li>
</ol>



<p class="wp-block-paragraph"><strong>Result</strong></p>



<ul class="wp-block-list">
<li>Immediate <strong>Control‑Flow Guard (CFG) violation</strong> → process crash.</li>



<li>Root cause: <code>BaseThreadInitThunk</code> dispatches to the start address via an <strong>indirect jump that is CFG‑instrumented</strong>.<br>Our loop gadget wasn’t in the module’s valid call‑target bitmap, so CFG killed the thread before the loop even began.</li>
</ul>



<h3 class="wp-block-heading" id="trial-5-double-hijack-loop-gadget-pivot">Trial 5 – Double Hijack: Loop Gadget Pivot</h3>



<p class="wp-block-paragraph"><strong>Idea</strong></p>



<p class="wp-block-paragraph">Start with a normal thread startup into <code>Sleep</code> (<strong>to satisfy CFG</strong>), just like before. But this time, we <strong>hijack twice</strong>:</p>



<ol class="wp-block-list">
<li>First into a <strong>loop gadget</strong>, to gain stable execution control.</li>



<li>Then into the <strong>target function</strong> (e.g., <code>VirtualAlloc</code>) with full parameter control.</li>
</ol>



<p class="wp-block-paragraph">Previously, we tried replacing the sleep function with a gadget directly — but that skipped the thread’s natural startup logic. We still wanted the <strong>native thread initialization</strong> to happen first, then slide quietly into a dormant state until hijack time.</p>



<p class="wp-block-paragraph">The <strong>breakthrough</strong> was combining the two ideas:</p>



<ul class="wp-block-list">
<li>Let the thread start normally with <code>Sleep</code>.</li>



<li>When it hits <code>NtDelayExecution</code>, hijack it to a <strong>loop gadget</strong>.</li>



<li>From the loop, hijack again, this time fully setting the context (<code>RIP</code> + <code>RCX</code>, <code>RDX</code>, <code>R8</code>, <code>R9</code>).</li>
</ul>



<p class="wp-block-paragraph"><strong>Call Flow</strong></p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_375655" class="syntaxhighlighter nogutter  plain"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="plain plain">RtlUserThreadStart</code></div><div class="line number2 index1 alt1"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">↳ BaseThreadInitThunk</code></div><div class="line number3 index2 alt2"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">↳ ...</code></div><div class="line number4 index3 alt1"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">↳ NtDelayExecution (from Sleep)</code></div><div class="line number5 index4 alt2"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">↳ Context Hijack → Loop Gadget</code></div><div class="line number6 index5 alt1"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">↳ Context Hijack → VirtualAlloc (with params)</code></div></div></td></tr></tbody></table></div></div></div>


<p class="wp-block-paragraph"><strong>Execution Flow</strong></p>



<ol class="wp-block-list">
<li><strong><code>CreateRemoteThread</code></strong> with start address set to <code>Sleep</code>.</li>



<li><strong>Wait briefly</strong> for the thread to initialize and enter sleep.</li>



<li><strong>Hijack #1:</strong> Set <code>RIP</code> to the loop gadget. Leave everything else alone. No suspend/resume needed.</li>



<li><strong>Hijack #2:</strong> Set <code>RIP</code> to <code>VirtualAlloc</code>, with proper values in <code>RCX</code>, <code>RDX</code>, <code>R8</code>, and <code>R9</code>. Again, no suspend/resume required.</li>
</ol>



<p class="wp-block-paragraph"><strong>Outcome</strong></p>



<p class="wp-block-paragraph"><strong>Success.</strong> We now have a clean PoC that calls any local function in a remote thread with <strong>up to 4 parameters</strong>,<span style="text-decoration: underline"> without using any standard remote allocation or modification techniques</span>.</p>



<p class="wp-block-paragraph">This approach even plays nicely with <strong>APC delivery</strong>, since the thread <strong>returns normally</strong>, without being sacrificed. The only downside? <strong>Two waits</strong> are needed per invocation to let the thread reach its sleep, and then the loop gadget.</p>



<p class="wp-block-paragraph"><em>Maybe we can optimize it a little if we could find an alternative to the initialization + sleep stage.</em></p>



<h3 class="wp-block-heading" id="trial-6-fixing-the-stack-using-rop">Trial 6 – Fixing the Stack using ROP</h3>



<p class="wp-block-paragraph"><strong>Idea</strong></p>



<p class="wp-block-paragraph">Finally, we thought of a simpler solution: <strong>use a ROP gadget in the target process to sets up the stack with two return addresses</strong> – one for thread exit (<code>RtlExitThread</code>) and one for our target function. This single gadget, would suffice for our stack building purposes.</p>



<p class="wp-block-paragraph">Back in <strong>Trial 1</strong>, we ran into a problem: after the target function finished executing, the thread tried to <strong>return to a null address</strong> — a result of starting with an <strong>empty stack</strong>. We wanted more elegant ways to deal with this.</p>



<p class="wp-block-paragraph">Waiting for thread initialization, sleeping, and doing <strong>two context hijacks</strong> (as in Trial 5) worked — but it felt a bit heavy-handed.</p>



<p class="wp-block-paragraph"><strong>ROP Gadget</strong></p>



<p class="wp-block-paragraph">By using a <strong>ROP gadget</strong> already present in the target process, we could <strong>build a valid stack</strong> with just a single step.</p>



<p class="wp-block-paragraph">The ROP gadget looks like this:</p>



<pre class="wp-block-code"><code>push reg1
push reg2
ret</code></pre>



<p class="wp-block-paragraph">Where the two above registers are unique from one another, and are any of the following: <code>RAX/RBX/RBP/RDI/RSI/R10-15</code>.</p>



<p class="wp-block-paragraph">With this simple gadget we can provide any API with following Context<strong> </strong>struct:</p>



<ul style="margin-top:0;margin-bottom:0" class="wp-block-list">
<li><code>RIP</code> → Gadget address</li>



<li><code>RCX, RDX, R8, R9</code> → 4 arguments</li>



<li>Gadget register 1 → <code>RtlExitThread</code></li>



<li>Gadget register 2 → Pointer to Function (ex, <code>VirtualAlloc</code>)</li>
</ul>



<figure class="wp-block-image aligncenter size-large has-custom-border"><img data-attachment-id="1403" data-permalink="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/image-58/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-13.png" data-orig-size="739,233" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-13.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-13.png?w=739" loading="lazy" width="739" height="233" src="https://blog.fndsec.net/wp-content/uploads/2025/04/image-13.png?w=739" alt="" class="has-border-color has-contrast-border-color wp-image-1403"><figcaption class="wp-element-caption">Discovering ROP gadgets within Notepad.exe</figcaption></figure>



<p class="wp-block-paragraph" style="margin-top:0;margin-bottom:0">This way, we have managed to<strong> skip the initialization + sleep</strong> and <strong>create a clean stack</strong> <strong>which exits</strong> via <code>RtlExitThread</code> once the target function finishes its work.</p>



<p class="wp-block-paragraph"><strong>Call Flow</strong></p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_326499" class="syntaxhighlighter nogutter  plain"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="plain plain">ROP Gadget&nbsp; </code></div><div class="line number2 index1 alt1"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">↳ VirtualAlloc&nbsp; </code></div><div class="line number3 index2 alt2"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">↳ RtlExitThread</code></div></div></td></tr></tbody></table></div></div></div>


<ol class="wp-block-list">
<li>We <strong>scan the remote process</strong>‘ memory for the desired ROP gadget.</li>



<li>We create a new thread via <strong>CreateRemoteThread</strong>, in a <strong>suspended</strong> state. The thread’s start address is irrelevant.</li>



<li>We prepare a <strong>new context</strong>:
<ul class="wp-block-list">
<li>Set <code>RIP</code> to the <strong>ROP gadget</strong>.</li>



<li>Set the gadget’s input registers to:
<ul class="wp-block-list">
<li><code>VirtualAlloc</code> (function call target)</li>



<li><code>RtlExitThread</code> (post-call return target).</li>
</ul>
</li>



<li>Fill <code>RCX</code>, <code>RDX</code>, <code>R8</code>, and <code>R9</code> with the <strong>four <code>VirtualAlloc</code> parameters</strong>.</li>
</ul>
</li>



<li>We <strong>resume</strong> the thread and let it run.</li>
</ol>



<p class="wp-block-paragraph"><strong>Outcome</strong></p>



<p class="wp-block-paragraph">The thread successfully executes <code>VirtualAlloc</code> and then <strong>cleanly exits</strong> by returning into <code>RtlExitThread</code>—no crashes, no cleanup needed.</p>



</details>



<h2 class="wp-block-heading" id="proof-of-concept">Proof of Concept</h2>



<figure class="wp-block-image size-full has-custom-border"><img data-attachment-id="2076" data-permalink="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/inject/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/05/inject.gif" data-orig-size="1102,719" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="inject" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/05/inject.gif?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/05/inject.gif?w=1024" loading="lazy" width="1102" height="719" src="https://blog.fndsec.net/wp-content/uploads/2025/05/inject.gif" alt="" class="has-border-color has-contrast-border-color wp-image-2076"></figure>



<p class="wp-block-paragraph">The proof of concept performs the following:</p>



<ol class="wp-block-list">
<li>Searches the target process memory for a <strong>ROP gadget</strong> (<code>push reg1; push reg2; ret</code>)</li>



<li>Uses this gadget to call <code>VirtualAlloc</code>, <code>RtlFillMemory</code>, and execute shellcode
<ul class="wp-block-list">
<li>Creates a <strong>suspended thread</strong> using <code>CreateRemoteThread</code></li>



<li>Sets the thread’s <code>CONTEXT</code> with <code>SetThreadContext</code>, assigning:
<ul class="wp-block-list">
<li><code>RIP</code><strong> </strong>to the ROP gadget</li>



<li><code>RCX</code> – <code>R9</code> to function arguments</li>



<li>Stack values for <code>ExitThread</code> and the target function to <code>reg1</code> and <code>reg2</code></li>



<li>Calls <code>ResumeThread</code> to run the thread.</li>



<li>Each thread pushes the address of <code>ExitThread</code>, then the <strong>target function</strong>, and performs a <code>ret</code> to jump into the target function.</li>
</ul>
</li>
</ul>
</li>
</ol>



<hr class="wp-block-separator has-alpha-channel-opacity">



<h1 class="wp-block-heading" id="ntcreatethread-context-injection">NtCreateThread Context Injection</h1>



<p class="wp-block-paragraph">While <code>CreateRemoteThread</code> is widely used for thread injection, it only accepts: </p>



<ol class="wp-block-list">
<li>The start address of the thread</li>



<li>A pointer to the first argument. </li>
</ol>



<p class="wp-block-paragraph">This led us to wonder why it’s so limited, and what would happen if we investigated the underlying API (<strong><code>NtCreateThread</code></strong>) which provides more control over thread creation.</p>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p class="wp-block-paragraph">Post Research Note: This is a good moment to say – we thought that <code>CreateRemoteThread</code> calls <code>NtCreateThread</code> while <code>CreateRemoteThreadEx</code> calls <code>NtCreateThreadEx</code>.</p>



<p class="wp-block-paragraph"><strong>That is not true.</strong> In modern Windows, both APIs call <code>NtCreateThreadEx</code> which <strong>does not take a context struct as an argument</strong>. With <code>NtCreateThreadEx</code>, the kernel performs stack allocation in the remote process.</p>



<p class="wp-block-paragraph">With <code>NtCreateThread</code>, we can pass a <code><strong>CONTEXT</strong></code> structure, giving us control over <strong>the thread’s registers, stack, and the return address</strong>. </p>
</blockquote>



<p class="wp-block-paragraph">This sparked an idea: <strong>what if we avoid using SetContext APIs by supplying the </strong><code><strong>CONTEXT</strong></code><strong> structure to <code>NtCreateThread</code>?</strong></p>



<figure class="wp-block-image aligncenter size-large has-custom-border"><img data-attachment-id="1127" data-permalink="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/image-50/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-5.png" data-orig-size="427,439" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-5.png?w=292" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-5.png?w=427" loading="lazy" width="427" height="439" src="https://blog.fndsec.net/wp-content/uploads/2025/04/image-5.png?w=427" alt="" class="has-border-color has-contrast-border-color wp-image-1127"><figcaption class="wp-element-caption">NtCreateThread prototype from ntinternals</figcaption></figure>



<h2 class="wp-block-heading" id="troubleshooting-research">Troubleshooting &amp; Research</h2>



<p class="wp-block-paragraph">At first, what seemed like it would be a walk in the park, turned into a few nights worth of debugging. This section gets a bit debugging heavy as well, but again, we wanted to share the methodology and our conclusions. Feel free to skip ahead.</p>



<details style="border:1px solid #ccc;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.1);padding:0.5em;margin:1em 0"><summary style="cursor:pointer;font-weight:500">Show Sections</summary>



<h3 class="wp-block-heading" id="ntstatus-0xc0000022-access-denied">NTSTATUS 0xC0000022 – Access Denied</h3>



<p class="wp-block-paragraph">Our first PoC was simple (or so we thought):</p>



<ol style="margin-top:0;margin-bottom:0" class="wp-block-list">
<li>Obtain <strong><code>PROCESS_ALL_ACCESS</code></strong> handle to target process.</li>



<li>Get the <code>Sleep()</code> function address from our process.</li>



<li>Allocate a clean stack using <code>VirtualAllocEx</code> to the remote process (<em>we can likely can avoid this step</em> <em>by being a bit creative and combining previous ideas</em>)</li>



<li>Prepare <code>CONTEXT</code> Struct &amp; <code>TEB</code> struct in our process.</li>



<li>Call <code>NtCreateThread</code></li>
</ol>



<p class="wp-block-paragraph">However, we received an ‘<span style="text-decoration: underline">Access Denied</span>‘ <code>NTSTATUS</code> from the Syscall, even though we:</p>



<ul style="margin-top:0;margin-bottom:0" class="wp-block-list">
<li style="margin-top:0;margin-bottom:0">Used a high integrity injecting process with an admin token and <code>SeDebugPrivilege</code> enabled.</li>



<li>Injected into medium integrity processes – <code>notepad.exe</code>, <code>calc.exe</code>, <code>msedge.exe</code> and a dummy process we’ve created.</li>
</ul>



<p class="wp-block-paragraph">Looking in the internet, we didn’t find much info on the reason this happens, but ChatGPT gladly told us that the <code>NtCreateThread</code> syscall is <strong>a legacy syscall that will not work when used cross-process after Windows Vista</strong>:</p>



<figure class="wp-block-image size-large has-custom-border" style="margin-top:0;margin-bottom:0"><img data-attachment-id="1157" data-permalink="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/image-52/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-7.png" data-orig-size="1049,264" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-7.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/04/image-7.png?w=1024" loading="lazy" width="1024" height="257" src="https://blog.fndsec.net/wp-content/uploads/2025/04/image-7.png?w=1024" alt="" class="has-border-color has-contrast-border-color wp-image-1157"><figcaption class="wp-element-caption"><strong>ChatGPT o3 with search enabled</strong> (<a href="https://www.openrce.org/blog/view/1635/Using_NtCreateThreadEx_for_Remote_Thread_Execution_in_System_Process_for_Vista_%26_Windows7">openrce reference</a>) (<a href="https://securityxploded.com/ntcreatethreadex.php">securityxploded reference</a>)</figcaption></figure>



<p class="wp-block-paragraph"><span style="text-decoration: underline"><strong>That obviously seemed like a hallucination</strong></span>, especially when the sources GPT pointed to didn’t contain that wording explicitly, so we went ahead and did some kernel debugging.</p>



<h3 class="wp-block-heading" id="tracing-ntcreatethread-in-the-kernel">Tracing NtCreateThread in the Kernel</h3>



<p class="wp-block-paragraph">The general flow of the <code>NtCreateThread</code> syscall is:</p>



<figure class="wp-block-image aligncenter size-large"><img data-attachment-id="1187" data-permalink="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/diagram-3/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/04/diagram-2.png" data-orig-size="458,436" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="diagram" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/04/diagram-2.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/04/diagram-2.png?w=458" loading="lazy" width="458" height="436" src="https://blog.fndsec.net/wp-content/uploads/2025/04/diagram-2.png?w=458" alt="" class="wp-image-1187"></figure>



<h3 class="wp-block-heading" id="checks-nt-ntcreatethread-performs">Checks nt!NtCreateThread Performs</h3>



<p class="wp-block-paragraph">Before the kernel gets to <code>nt!PspCreateThread</code>, the <code>nt!NtCreateThread</code> wrapper does some basic housekeeping which include:</p>



<ul style="margin-top:0;margin-bottom:0" class="wp-block-list">
<li><strong>Verifies all pointers</strong> passed in (handles, <code>CLIENT_ID</code>, <code>CONTEXT</code>, <code>INITIAL_TEB</code>) are aligned and readable/writable.</li>



<li><strong>Scrubs the <code>CONTEXT</code> record</strong>, stripping out privileged flags and illegal register values.</li>



<li><strong>Sanity-checks the stack info</strong> in <code>INITIAL_TEB</code>, making sure a real stack was allocated and no “previous stack” fields are set.</li>



<li><strong>Zeros the output handle &amp; keeps the stack 16-byte aligned</strong> so any early error unwinds cleanly.</li>
</ul>



<p class="wp-block-paragraph">These are mostly safety checks, they’re not relevant to our troubleshooting but we thought to mention them.</p>



<h3 class="wp-block-heading" id="checks-nt-pspcreatethread-performs">Checks nt!PspCreateThread Performs</h3>



<p class="wp-block-paragraph"><code>PspCreateThread</code>&nbsp;is where the actual thread object (<code>ETHREAD</code>) is created and linked into the target process. It performs its own set of checks, some of which are more security-focused.</p>



<p class="wp-block-paragraph">The <code>PspCreateThead</code> is lacking on documentation, so we’ve tried our best reversing it. The prototype is as follows (when called from <code>NtCreateThread</code>):</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_793652" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">NTSTATUS __fastcall PspCreateThread(</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PHANDLE</code> <code class="cpp plain">RemoteThreadHandle,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">ACCESS_MASK DesiredAccess,</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">POBJECT_ATTRIBUTES ObjectAttributes,</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">HANDLE</code> <code class="cpp plain">RemoteProcessHandle,</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_EPROCESS *TargetProcObject,</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">__int64</code> <code class="cpp plain">__zero,</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">PCLIENT_ID ClientID,</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">PCONTEXT InitialContext,</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">PINITIAL_TEB InitialTeb,</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG</code> <code class="cpp plain">CreationFlagsRaw,</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG_PTR</code> <code class="cpp plain">IsSecureProcess,</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG_PTR</code> <code class="cpp plain">Spare,</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">InternalFlags)</code></div></div></td></tr></tbody></table></div></div></div>


<p class="wp-block-paragraph">First we have some <strong>initializations and caching of parameters</strong>:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_94199" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">callerThread = KeGetCurrentThread();</code></div><div class="line number2 index1 alt1"><code class="cpp plain">RemoteProcessHandle2 = RemoteProcessHandle;</code></div><div class="line number3 index2 alt2"><code class="cpp plain">RemoteThreadHandle2 = RemoteThreadHandle;</code></div><div class="line number4 index3 alt1"><code class="cpp plain">__zero_3 = __zero;</code></div><div class="line number5 index4 alt2"><code class="cpp plain">ClientID2 = ClientID;</code></div><div class="line number6 index5 alt1"><code class="cpp plain">InitialTeb2 = InitialTeb;</code></div><div class="line number7 index6 alt2"><code class="cpp plain">DesiredAccess2 = DesiredAccess;</code></div><div class="line number8 index7 alt1"><code class="cpp plain">callerProcess = (_EPROCESS *)callerThread-&gt;ApcState.Process;</code></div><div class="line number9 index8 alt2"><code class="cpp plain">InternalFlags2 = InternalFlags;</code></div><div class="line number10 index9 alt1"><code class="cpp plain">ObjectAttributes2 = ObjectAttributes;</code></div><div class="line number11 index10 alt2"><code class="cpp plain">CallerProcess2 = callerProcess;</code></div></div></td></tr></tbody></table></div></div></div>


<p class="wp-block-paragraph">Skip a bit forward, first, the <strong>kernel resolves the target process</strong>:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_268905" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">( RemoteProcessHandle )</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">LOBYTE(RemoteProcessHandle) = PreviousMode;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">result = ObpReferenceObjectByHandleWithTag(</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">RemoteProcessHandle2,</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">2LL,</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">PsProcessType,</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">RemoteProcessHandle,</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">0x72437350,</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">&amp;TargetProcessObject,</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">0LL,</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">0LL);</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">TargetProcessObject2 = (_EPROCESS *)TargetProcessObject;</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">goto</code> <code class="cpp plain">LABEL_5;</code></div><div class="line number15 index14 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p class="wp-block-paragraph">Afterwards, <strong>the kernel checks that resolving the target process was successful </strong>and jumps to perform a check using <code>PspIsProcessReadyForRemoteThread</code>:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_393346" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">CallerProcess3 = CallerProcess2;</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">( TargetProcessObject2 != CallerProcess2 )</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;</code><code class="cpp plain">{</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !PspIsProcessReadyForRemoteThread(TargetProcessObject2) )</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">0xC0000001; </code><code class="cpp comments">// STATUS_UNSUCCESSFUL</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CallerProcess3 = CallerProcess2;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;</code><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p class="wp-block-paragraph"><em>Now things start to get a bit weird.</em> There is a check to see if the target process is protected by virtualization and lives in VTL-1 (Secure Kernel), but since <code>NtCreateThread</code> always calls <code>PspCreateThread</code> with <code>IsSecureProcess = 0</code>, the check is skipped and is evaluated to <code>True</code> as part of the other conditions we can see just below.</p>



<p class="wp-block-paragraph">We reach the key check that caused the <strong>Access Denied</strong> error:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_507591" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">( !__zero_3 </code><code class="cpp comments">// Always true from NtCreateThread</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">&amp;&amp; !IsSecureProcess </code><code class="cpp comments">// Always true </code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">&amp;&amp; ((TargetProcessObject2-&gt;MitigationFlags &amp; 1) != 0</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">|| (CallerProcess3-&gt;MitigationFlags &amp; 1) != 0</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">|| (TargetProcessObject2-&gt;MitigationFlags2 &amp; 0x4000) != 0</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">|| (CallerProcess3-&gt;MitigationFlags2 &amp; 0x4000) != 0) )</code></div><div class="line number7 index6 alt2"><code class="cpp plain">{</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">0xC0000022;</code></div><div class="line number9 index8 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p class="wp-block-paragraph">The first two conditions evaluate to <strong>true</strong> when called from <code>NtCreateThread</code>. The next two checks (<code>MitigationFlags &amp; 1</code>) determine whether <strong>Control Flow Guard (CFG)</strong> is enabled in either our process or the target. The final two checks (<code>MitigationFlags2 &amp; 0x4000</code>) verify whether the <strong>Import Address Filter (IAF) mitigation</strong> is enabled on either processes.</p>



<p class="wp-block-paragraph">Just a bit later there’s a few other interesting checks which could return <strong>0x22</strong>:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_778114" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">( (TargetProcessObject2-&gt;Flags3 &amp; 1) != 0 </code><code class="cpp comments">// Minimal Process bit</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">&amp;&amp; !TargetProcessObject2-&gt;PicoContext </code><code class="cpp comments">// Not a Pico Process</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">&amp;&amp; InitialContext )</code></div><div class="line number4 index3 alt1"><code class="cpp plain">{</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">0xC0000022;</code></div><div class="line number6 index5 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p class="wp-block-paragraph">The first condition checks whether the target process is a <strong>Minimal Process</strong>. <strong><span style="text-decoration: underline">and</span> </strong>that is <span style="text-decoration: underline"><strong>not </strong>a Pico Process</span> and an <code>InitialContext</code> was provided (which it is from <code>NtCreateThread</code>. </p>



<p class="wp-block-paragraph">To sum up, if any of the following applies to the target process, <code>NtCreateThread</code> injection will fail:</p>



<ul class="wp-block-list">
<li><strong>Control Flow Guard</strong> is enabled</li>



<li><strong>Import Address Filtering (EAF)</strong> is enabled</li>



<li>The process is a <strong>Minimal Process</strong> and <strong>not a Pico process</strong>.</li>
</ul>



<p class="wp-block-paragraph">Therefore, the <code>NtCreateThread</code> syscall will likely work on most 3rd party programs, which are typically not compiled with CFG or IAF, and are typcially not Minimal processes. In contrast, most Microsoft binaries are typcially compiled with <strong>Control Flow Guard (CFG)</strong>.</p>



</details>



<h2 class="wp-block-heading" id="proof-of-concept-1">Proof of Concept</h2>



<figure class="wp-block-image size-full has-custom-border"><img data-attachment-id="2080" data-permalink="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/ntinject/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/05/ntinject.gif" data-orig-size="1306,771" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="ntinject" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/05/ntinject.gif?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/05/ntinject.gif?w=1024" loading="lazy" width="1306" height="771" src="https://blog.fndsec.net/wp-content/uploads/2025/05/ntinject.gif" alt="" class="has-border-color has-contrast-border-color wp-image-2080"></figure>



<p class="wp-block-paragraph">The proof of concept performs the following:</p>



<ol class="wp-block-list">
<li>Searches the target process memory for a <strong>ROP gadget</strong> (<code>push reg1; push reg2; ret</code>)</li>



<li>Uses this gadget to call <code>VirtualAlloc</code>, <code>RtlFillMemory</code>, and execute shellcode
<ul class="wp-block-list">
<li>Allocate an empty stack in the target process for the new thread using <code>VirtualAllocEx</code> (<em>we can likely avoid this step</em>)</li>



<li>Initialize <code>CONTEXT</code> struct, assigning:
<ul class="wp-block-list">
<li><code>RIP</code><strong> </strong>to the ROP gadget</li>



<li><code>RCX</code> – <code>R9</code> to function arguments</li>



<li>Stack values for <code>ExitThread</code> and the target function to <code>reg1</code> and <code>reg2</code></li>



<li>Each thread pushes the address of <code>ExitThread</code>, then the <strong>target function</strong>, and performs a <code>ret</code> to jump into the target function.</li>
</ul>
</li>



<li>Creates a thread using <code>NtCreateThread</code> with the given <code>CONTEXT</code> which executes immediately. </li>
</ul>
</li>
</ol>



<p class="wp-block-paragraph"><em>The new thread does not need a context hijack while belonging to the target process as its context is already pre-supplied.</em></p>



<hr class="wp-block-separator has-alpha-channel-opacity">



<h1 class="wp-block-heading" id="redirectthread-tool">RedirectThread Tool</h1>



<p class="has-text-align-center wp-block-paragraph"><strong>Find the <a href="https://github.com/Friends-Security/RedirectThread"><strong>RedirectThread </strong>Github repo here</a></strong></p>



<p class="wp-block-paragraph">To demonstrate the techniques from this blog in a practical and repeatable way, we built a command-line tool that implements the injection methods discussed. <strong><code>RedirectThread</code></strong> supports context-only process injections which include:</p>



<ul class="wp-block-list">
<li>Pointer-only DLL injection</li>



<li>Various APC injections</li>



<li><code>CreateRemoteThread</code> <strong>+ </strong><code>SetThreadContext</code> injection</li>



<li><code>NtCreateThread</code></li>
</ul>



<p class="wp-block-paragraph">Usage:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_732172" class="syntaxhighlighter nogutter  plain"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="plain plain">Usage: C:\RedirectThread.exe [options]</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="plain plain">Required Options:</code></div><div class="line number4 index3 alt1"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">--pid &lt;pid&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Target process ID to inject into</code></div><div class="line number5 index4 alt2"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">--inject-dll&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Perform DLL injection (hardcoded to "0.dll")</code></div><div class="line number6 index5 alt1"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">--inject-shellcode &lt;file&gt;&nbsp;&nbsp; Perform shellcode injection from file</code></div><div class="line number7 index6 alt2"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">--inject-shellcode-bytes &lt;hex&gt;&nbsp; Perform shellcode injection from hex string (e.g. 9090c3)</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="plain plain">Delivery Method Options:</code></div><div class="line number10 index9 alt1"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">--method &lt;method&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Specify code execution method</code></div><div class="line number11 index10 alt2"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">CreateRemoteThread&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Default, creates a remote thread</code></div><div class="line number12 index11 alt1"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">NtCreateThread&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Uses NtCreateThread (less traceable)</code></div><div class="line number13 index12 alt2"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">QueueUserAPC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Uses QueueUserAPC (requires --tid)</code></div><div class="line number14 index13 alt1"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">QueueUserAPC2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Uses QueueUserAPC2 (requires --tid)</code></div><div class="line number15 index14 alt2"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">NtQueueApcThread&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Uses NtQueueApcThread (requires --tid)</code></div><div class="line number16 index15 alt1"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">NtQueueApcThreadEx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Uses NtQueueApcThreadEx (requires --tid)</code></div><div class="line number17 index16 alt2"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">NtQueueApcThreadEx2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Uses NtQueueApcThreadEx2 (requires --tid)</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="plain plain">Context Method Options:</code></div><div class="line number20 index19 alt1"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">--context-method &lt;method&gt;&nbsp;&nbsp; Specify context manipulation method</code></div><div class="line number21 index20 alt2"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">rop-gadget&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Default, uses ROP gadget technique</code></div><div class="line number22 index21 alt1"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">two-step&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Uses a two-step thread hijacking approach</code></div><div class="line number23 index22 alt2">&nbsp;</div><div class="line number24 index23 alt1"><code class="plain plain">Additional Options:</code></div><div class="line number25 index24 alt2"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">--tid &lt;tid&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Target thread ID (required for APC methods)</code></div><div class="line number26 index25 alt1"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">--alloc-size &lt;size&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Memory allocation size in bytes (default: 4096)</code></div><div class="line number27 index26 alt2"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">--alloc-perm &lt;hex&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Memory protection flags in hex (default: 0x40)</code></div><div class="line number28 index27 alt1"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">--alloc-address &lt;hex&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Specify base address for allocation (hex, optional)</code></div><div class="line number29 index28 alt2"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">--use-suspend&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Use thread suspension for increased reliability</code></div><div class="line number30 index29 alt1"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">--verbose&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Enable verbose output</code></div><div class="line number31 index30 alt2"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">--enter-debug&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Pause execution at key points for debugger attachment</code></div><div class="line number32 index31 alt1">&nbsp;</div><div class="line number33 index32 alt2"><code class="plain plain">Example:</code></div><div class="line number34 index33 alt1"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">C:\RedirectThread.exe --pid 1234 --inject-dll mydll.dll</code></div><div class="line number35 index34 alt2"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">C:\RedirectThread.exe --pid 1234 --inject-shellcode payload.bin --verbose</code></div><div class="line number36 index35 alt1"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">C:\RedirectThread.exe --pid 1234 --inject-shellcode payload.bin --method NtCreateThread</code></div><div class="line number37 index36 alt2"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">C:\RedirectThread.exe --pid 1234 --inject-shellcode-bytes 9090c3 --method QueueUserAPC --tid 5678</code></div><div class="line number38 index37 alt1"><code class="plain spaces">&nbsp;&nbsp;</code><code class="plain plain">C:\RedirectThread.exe --pid 1234 --inject-shellcode-bytes $bytes --context-method two-step --method NtQueueUserApcThreadEx2 --tid 5678</code></div></div></td></tr></tbody></table></div></div></div>


<hr class="wp-block-separator has-alpha-channel-opacity">



<h1 class="wp-block-heading" id="injection-detection-logic-theory">Injection Detection Logic Theory</h1>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p class="wp-block-paragraph"><em>This section is about detection logic models commonly used in EDRs, and how execution-only techniques challenge their core assumptions.</em></p>
</blockquote>



<h4 class="wp-block-heading" id="1-thread-context-hijacking-by-itself-isn-t-evil">1.  “Thread‑Context Hijacking” by itself isn’t evil</h4>



<ul class="wp-block-list">
<li>A lone <strong>execution trigger</strong>. For example: suspending a thread, tweaking its <code>CONTEXT</code>, and resuming it doesn’t touch memory and therefore looks benign.</li>



<li>Modern EDRs typically label <em>process injection</em> when <strong>two or more</strong> of the following activities are tied together in the <em>same</em> victim process:</li>
</ul>



<figure class="wp-block-table"><table class="has-fixed-layout"><thead><tr><th>Activity</th><th>Typical API evidence</th><th>What it really means</th></tr></thead><tbody><tr><td><strong>Remote allocation</strong></td><td><code>VirtualAllocEx</code>, <code>MapViewOfFile3</code>, etc.</td><td>Create fresh pages <em>inside another</em> process</td></tr><tr><td><strong>Remote modification</strong></td><td><code>WriteProcessMemory</code>, <code>VirtualProtectEx</code></td><td>Change bytes or permissions in those pages</td></tr><tr><td><strong>Remote execution trigger</strong></td><td><code>CreateRemoteThread</code>, APC queueing, context hijack, UI‑callback registration</td><td>Force the target to jump to attacker‑controlled code</td></tr></tbody></table></figure>



<p class="wp-block-paragraph"><em>EDRs often model these as an ordered chain (1 → 2 → 3) or as any <strong>{2 of 3}</strong> combination.</em></p>



<p class="wp-block-paragraph">This check is often done as a correlation check with the start address of a new Thread or APC, or on the event of an any API call involved in the activity.</p>



<h4 class="wp-block-heading" id="2-why-execution-only-attacks-are-hard-to-see">2.  Why Execution‑Only Attacks Are Hard to See</h4>



<p class="wp-block-paragraph">A defended endpoint would have to:</p>



<ol class="wp-block-list">
<li>Spot <strong>Trigger #1</strong> (remote thread creation) – easy.</li>



<li>Spot <strong>Trigger #2</strong> (context hijack) – also easy.</li>



<li><strong>Elevate every subsequent local memory touch inside that thread to “remote”.</strong>
<ul class="wp-block-list">
<li>Requires tracing <em>all</em> syscalls <em>and</em> user‑mode helpers (<code>memset</code>, etc.).</li>



<li>Needs data‑flow (“taint”) analysis to prove the write originated from the foreign context.</li>



<li>Impractical at scale; borderline impossible in real time.</li>
</ul>
</li>
</ol>



<p class="wp-block-paragraph">Result: attackers who skip Activities 1 &amp; 2 and rely only on creative triggers could slip past detection.</p>



<h4 class="wp-block-heading" id="3-why-attackers-swap-triggers-more-than-allocators">3.  Why Attackers Swap Triggers More Than Allocators</h4>



<ul class="wp-block-list">
<li>The pool of “allocate/write remotely” APIs is tiny and heavily monitored.</li>



<li>The <strong>execution surface</strong> is huge: threads, APCs, timers, UI callbacks, UMS, DCOM marshaling, and so on. It’s a fertile ground for variants.</li>



<li>As EDRs hardened around memory ops, merely choosing an exotic trigger no longer guarantees stealth, yet it remains the easier and cheaper option.</li>
</ul>



<h4 class="wp-block-heading" id="4-weakness-in-the-2-of-3-philosophy">4.  Weakness in the 2 of 3 Philosophy</h4>



<p class="wp-block-paragraph">The model silently assumes “remote ≠ local”. Once an attacker coerces the victim into performing its <em>own</em> writes, that assumption fails:</p>



<ol class="wp-block-list">
<li><strong>Local write</strong> occurs (<code>memset</code> inside victim).</li>



<li>Write is actually driven by an external context hijack = logically <em>remote</em>.</li>



<li>Current telemetry can’t prove that causal link, which results in  no alert.</li>
</ol>



<p class="wp-block-paragraph">Unless the defender can <strong>join trigger telemetry with deep intra‑thread taint tracking</strong>, the injection hides in plain sight.</p>



<h4 class="wp-block-heading" id="5-takeaways-for-defenders">5. Takeaways for Defenders</h4>



<p class="wp-block-paragraph">For what we’ve discussed in the blog:</p>



<ul class="wp-block-list">
<li>Monitoring for rapid set of <strong>thread creation events in a short amount of time</strong> might prove useful.</li>



<li>Monitoring <strong>thread creation followed by a large number of <code>SetThreadContext</code></strong> (and similar APIs).</li>
</ul>



<p class="wp-block-paragraph">But the above detections are API specific, to get to the bottom of things we’d need to correlate <strong><em>who</em> </strong>requested the trigger, not just <strong><em>what</em> </strong>API was called.</p>



<hr class="wp-block-separator has-alpha-channel-opacity">



<h1 class="wp-block-heading" id="research-notes-1">Research Notes</h1>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p class="wp-block-paragraph">This is a section for things we did not pursue, unanswered questions and other details.</p>
</blockquote>



<h3 class="wp-block-heading" id="are-we-limited-to-4-arguments">Are we limited to 4 arguments?</h3>



<p class="wp-block-paragraph">No. The Windows x64 calling convention gives us four registers (<code>RCX</code>, <code>RDX</code>, <code>R8</code>, <code>R9</code>) for arguments, but if needed, additional arguments could be placed on the stack manually if we find better ROP chains.</p>



<h3 class="wp-block-heading" id="can-we-avoid-creating-hundreds-of-threads">Can we avoid creating hundreds of threads?</h3>



<p class="wp-block-paragraph">Probably yeah. We explored reusing the same thread <strong>by re-hijacking its context multiple times.</strong><br>Instead of pushing <code>RtlExitThread</code>, we could push a loop gadget (as discussed in the troubleshooting section <a href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#trial-5-double-hijack-loop-gadget-pivot">here</a> and recycle the thread.<br>This could reduce thread creation in cases where you want to perform multiple operations over time, especially for shellcode delivery.</p>



<p class="wp-block-paragraph">We could potentially <strong>hijack existing waiting-to-run threads</strong> in the right state such as DeferredReady/Ready waiting to run and restore their state later. This could also be done using the gadget by pushing the previous address instead of an exit. This would achieve a similar result to the earlier two-step approach with APCs, but with the efficiency of the later approach.</p>



<h3 class="wp-block-heading" id="can-we-avoid-readprocessmemory-to-find-rop-gadgets-1">Can we avoid <code>ReadProcessMemory</code> to find ROP gadgets?</h3>



<p class="wp-block-paragraph">Yes! While our approach was to <strong>search directly in memory</strong>, this certainly isn’t the only viable method. There are several potential alternatives which can work:</p>



<ul class="wp-block-list">
<li><strong>Option 1</strong>: Load the same DLLs used by the target process and scan them locally to find ROP gadgets within specific modules.</li>



<li><strong>Option 2</strong>: Parse the PE file from disk, locate the gadget, then calculate its memory address using <code>base address + offset</code>.</li>
</ul>



<p class="wp-block-paragraph">Each method has trade-offs in precision, stealth, and complexity. We chose in-memory scanning mainly for its simplicity.</p>



<h3 class="wp-block-heading" id="can-we-use-other-winapi-nt-functions-to-control-the-context">Can we use other WinAPI / NT functions to control the Context?</h3>



<p class="wp-block-paragraph">The answer is yes! While not all of APIs are suitable for cross process injection, some just might offer a bit of ‘stealthier’ way to achieve the same results.</p>



<p class="wp-block-paragraph">The following is a non-definitive list of APIs we’ve found that accept a <code>CONTEXT</code> struct. However, <strong>not all of them were tested</strong>, as <span style="text-decoration: underline">the list quickly grew too large</span> to completely explore.</p>



<ul class="wp-block-list">
<li>WinAPI:
<ul class="wp-block-list">
<li><code>SetThreadContext</code></li>



<li><code>SetThreadInformation</code></li>



<li><code>Wow64SetThreadContext</code></li>



<li><code>RtlWow64SetThreadContext</code></li>



<li><code>RtlRestoreContext</code></li>



<li><code>RtlRegisterFeatureConfigurationChangeNotification</code></li>



<li><code>RtlRegisterWait</code></li>



<li><code>SetUmsThreadInformation</code></li>



<li><code>EtwRegister</code></li>



<li><code>UpdateProcThreadAttribute</code></li>



<li><code>UmsThreadUserContext</code></li>
</ul>
</li>
</ul>



<ul class="wp-block-list">
<li>NT Functions:
<ul class="wp-block-list">
<li><code>NtSetContextThread</code></li>



<li><code>NtCreateThread</code></li>



<li><code>NtSetInformationThread</code>
<ul class="wp-block-list">
<li><code>ThreadWow64Context</code></li>



<li><code>ThreadCreateStateChange<strong> </strong></code></li>



<li><code>ThreadApplyStateChange</code></li>
</ul>
</li>



<li><code>NtContinue</code></li>



<li><code>NtContinueEx</code></li>



<li><code>ALLOCATE_VIRTUAL_MEMORY_EX_CALLBACK</code></li>



<li><code>EtwEventRegister</code></li>
</ul>
</li>
</ul>



<h3 class="wp-block-heading" id="optimizations">Optimizations?</h3>



<p class="wp-block-paragraph">Absolutely! plenty of optimizations could be made:</p>



<p class="wp-block-paragraph">We could improve <strong>gadget discovery</strong> logic by:</p>



<ul class="wp-block-list">
<li>Tolerate non-disruptive intermediate instructions (e.g., a gadget like <code>push rax; push rbx; mov r10, r11; ret</code>, where <code>mov r10, r11</code> has no side effects).</li>



<li>Look for other instructions. Eg. <code>push rax; call rbx;</code>.</li>



<li>Use <em>chains </em>instead of<em> </em>a monolith<strong>.</strong> Use one gadget to <em>prepare rsp</em>, a second to <em>save registers</em>, a third to <em>dispatch</em>. ROP.</li>
</ul>



<p class="wp-block-paragraph">We could improve <strong>two-step approach’ efficiency</strong> by:</p>



<ul class="wp-block-list">
<li>Using more than a single thread at a time, automating thread’s choice too. The writing/copying operation can be done for each byte in parallel.</li>



<li>Shortening the sleep timing, looking for better ways to detect when thread is ready for the next step.</li>



<li>Using the <code>Nt*</code> versions for the writing operation. As they support 3 parameters (perfect fit <code>RtlFillMemory</code>) we can skip the two-step hijack for the majority of the operation.<br></li>
</ul>



<h3 class="wp-block-heading" id="unexplored-ideas">Unexplored Ideas</h3>



<figure class="wp-block-table is-style-stripes"><table class="has-fixed-layout"><thead><tr><th><strong>Idea</strong></th><th><strong>Conclusions</strong></th></tr></thead><tbody><tr><td><strong>Catch the thread before it returns, suspend it, and reuse it</strong></td><td>Not explored. Seemed impractical due to tight timing. We didn’t investigate delaying the thread’s exit in a reliable way.</td></tr><tr><td><strong>Find a native function that accepts a callback (e.g., to redirect to <code>ExitThread</code>)</strong></td><td>We brainstormed a trampoline approach to redirect the call chain to an exit, but couldn’t find a good native candidate in NTDLL/Kernel32/KernelBase.</td></tr><tr><td><strong>Push an existing exit function already present on another thread’s stack</strong></td><td>Not explored. In theory, wait until a thread calls <code>ExitThread</code>, then reuse the stack pointer. But it’s a narrow and volatile time window, and likely dangerous.</td></tr><tr><td><strong>Find an exit function address already present in memory</strong></td><td>We scanned for common function pointers (like <code>ExitThread</code>, <code>RtlExitUserThread</code>) but didn’t find usable results. This sub-idea remains unresolved.</td></tr><tr><td><strong>Catch exceptions during bad returns via debug APIs</strong></td><td>Not explored. Likely violates the “no extra process hooks” principle of this research. Could be interesting in separate work.</td></tr><tr><td><strong>Inject a custom SEH (structured exception handler)</strong></td><td>Theoretically interesting. We wondered whether an execution-only setup could install a handler without modifying memory. Left untested.</td></tr></tbody></table></figure>



<h1 class="wp-block-heading" id="a-note-on-ghostwriting-and-related-work">A Note on “GhostWriting” and Related Work</h1>



<p class="wp-block-paragraph">When we kicked off this project we could find no public write-ups that fully skipped <strong>both</strong> <code>VirtualAlloc[Ex]</code>/<strong><code>WriteProcessMemory</code></strong> and still delivered x64 code. Only after nearing the end of our research did we stumble on the <em>GhostWriting</em> research [<a href="https://blog.sevagas.com/IMG/pdf/code_injection_series_part5.pdf">1</a>] [<a href="https://github.com/c0de90e7/GhostWriting">2</a>] [<a href="https://github.com/fern89/ghostwriting-2">3</a>], which is incredible.</p>



<p class="wp-block-paragraph">GhostWriting proposed the idea to steal an existing thread and manipulate its <code>CONTEXT</code> to run shellcode with no remote allocations. Our research started from the same intuition but diverged in three ways:</p>



<ol class="wp-block-list">
<li><strong>Pointer-only <code>LoadLibrary</code> injection.</strong> We show that feeding <code>LoadLibraryA</code> a pointer to an <em>in-process</em> ASCII literal (e.g., <code>"0"</code>) plus a disk file named <code>0.dll</code> achieves DLL loading with <strong>zero</strong> remote writes. GhostWriting focuses solely on raw shellcode.</li>



<li><strong>CreateRemoteThread ➜ SetThreadContext ROP pivot.</strong> Instead of hijacking a live GUI thread, we spin up <em>new</em> remote threads, repair their empty stacks with a <code>push reg; push reg; ret</code> gadget, and chain any WinAPI with up to four params. This workflow doesn’t appear in prior papers (as far as we know and happy to be corrected).</li>



<li><strong>Full x64 <code>NtCreateThread</code> PoC.</strong> Our demo supplies a crafted <code>CONTEXT</code> and <code>INITIAL_TEB</code> directly to <code>NtCreateThread</code>, along with a kernel-debug exploration of the CFG/IAF gates.</li>
</ol>



<p class="wp-block-paragraph">So while “execution-only” injection has history, we believe the variants, mitigations, and insights presented here push the idea into a new territory.</p>



<h1 class="wp-block-heading" id="conclusion">Conclusion</h1>



<p class="wp-block-paragraph">If you made it this far, you’ve earned a debugger coffee breakpoint, hope it was worth the stack space.</p>



<p class="wp-block-paragraph">Thanks for reading, sticking through the details, and joining us down this rabbit hole. <strong>If you’ve got follow-up ideas or ways to push this further, we’d love to hear them</strong>, someone out there always finds the next clever step.</p>
</div>


<div class="wp-block-group is-layout-flow wp-block-group-is-layout-flow" style="margin-top:48px;margin-bottom:48px;padding-top:5px;padding-bottom:5px">
<hr class="wp-block-separator has-alpha-channel-opacity">



<p class="has-text-align-center wp-block-paragraph" style="margin-top:14px;margin-bottom:0px;font-size:clamp(14px, 0.875rem + ((1vw - 3.2px) * 0.114), 15px);">Subscribe to get the latest posts sent to your email.</p>



<div class="wp-block-group has-global-padding is-layout-constrained wp-container-core-group-is-layout-8a438d05 wp-block-group-is-layout-constrained">	<div class="wp-block-jetpack-subscriptions__supports-newline wp-block-jetpack-subscriptions">
		<div class="wp-block-jetpack-subscriptions__container is-not-subscriber">
							<form action="https://wordpress.com/email-subscriptions" method="post" accept-charset="utf-8" data-blog="235352136" data-post_access_level="everybody" data-subscriber_email="" id="subscribe-blog">
					<div class="wp-block-jetpack-subscriptions__form-elements">
												<p id="subscribe-email">
							<label id="subscribe-field-label" for="subscribe-field" class="screen-reader-text">
								Type your email…							</label>
							<input required="required" type="email" name="email" autocomplete="email" class="no-border-radius " style="font-size: 16px;padding: 15px 23px 15px 23px;border-radius: 0px;border-width: 1px;" placeholder="Type your email…" value="" id="subscribe-field" title="Please fill in this field.">						</p>
												<p id="subscribe-submit">
							
							
							
							
							
							
							
														<button type="submit" class="wp-block-button__link no-border-radius" style="font-size: 16px;padding: 15px 23px 15px 23px;margin: 0; margin-left: 10px;border-radius: 0px;border-width: 1px;" name="jetpack_subscriptions_widget">
								Subscribe							<span class="jetpack-memberships-spinner">	<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">		<path d="M12,1A11,11,0,1,0,23,12,11,11,0,0,0,12,1Zm0,19a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z" opacity=".25" fill="currentColor"></path>		<path d="M10.14,1.16a11,11,0,0,0-9,8.92A1.59,1.59,0,0,0,2.46,12,1.52,1.52,0,0,0,4.11,10.7a8,8,0,0,1,6.66-6.61A1.42,1.42,0,0,0,12,2.69h0A1.57,1.57,0,0,0,10.14,1.16Z" class="jetpack-memberships-spinner-rotating" fill="currentColor"></path>	</svg></span></button>
						</p>
					</div>
				</form>
								</div>
	</div>
	</div>
</div>



<hr class="wp-block-separator has-alpha-channel-opacity">



<h2 class="wp-block-heading has-large-font-size" id="read-more">Read more</h2>



<div class="wp-block-group has-medium-font-size has-global-padding is-layout-constrained wp-block-group-is-layout-constrained"><div class="wp-block-newspack-blocks-carousel wp-block-newspack-blocks-carousel__autoplay-playing slides-per-view-3 wpnbpc" id="wp-block-newspack-carousel__1" data-current-post-id="9" data-slides-per-view="3" data-slide-count="6" data-aspect-ratio="0.75" data-autoplay="1" data-autoplay_delay="5"><button aria-label="Pause Slideshow" class="swiper-button swiper-button-pause"></button><button aria-label="Play Slideshow" class="swiper-button swiper-button-play"></button><div class="swiper swiper-initialized swiper-horizontal swiper-watch-progress swiper-backface-hidden"><div class="swiper-wrapper" style="width: 1632px; cursor: grab;">
			<article data-post-id="2153" class="post-has-image swiper-slide tag-azure tag-cloud tag-entraid tag-microsoft tag-powershell tag-ropc tag-security category-uncategorized type-post post swiper-slide-visible swiper-slide-fully-visible swiper-slide-active" style="width: 256px; height: 192px; margin-right: 16px;" aria-hidden="false" data-swiper-slide-index="0">
								<figure class="post-thumbnail">
										<a href="https://blog.fndsec.net/2026/01/13/evading-entraid-conditional-access-policies-via-cross-tenant-ropc/" rel="bookmark" aria-hidden="true">
																		<img width="1024" height="559" src="https://blog.fndsec.net/wp-content/uploads/2026/01/blogpost.png?w=1024" class="image-fit-cover wp-post-image" alt="Evading EntraID Conditional Access Policies via Cross-Tenant&nbsp;ROPC" object-fit="cover" layout="fill" decoding="async" loading="lazy" data-attachment-id="2224" data-permalink="https://blog.fndsec.net/2026/01/13/evading-entraid-conditional-access-policies-via-cross-tenant-ropc/blogpost/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2026/01/blogpost.png" data-orig-size="2816,1536" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="blogpost" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2026/01/blogpost.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2026/01/blogpost.png?w=1024">																</a>
									</figure>

									<div class="entry-wrapper">
						<h3 class="entry-title"><a href="https://blog.fndsec.net/2026/01/13/evading-entraid-conditional-access-policies-via-cross-tenant-ropc/" rel="bookmark">Evading EntraID Conditional Access Policies via Cross-Tenant&nbsp;ROPC</a></h3>
						<div class="entry-meta">
							<time class="entry-date published" datetime="2026-01-13T15:06:35+02:00">January 13, 2026</time>						</div><!-- .entry-meta -->
					</div><!-- .entry-wrapper -->
							</article>
			
			<article data-post-id="886" class="post-has-image swiper-slide tag-azure tag-defender_for_cloud tag-sharepoint tag-tool category-uncategorized type-post post swiper-slide-visible swiper-slide-fully-visible swiper-slide-next" style="width: 256px; height: 192px; margin-right: 16px;" data-swiper-slide-index="1" aria-hidden="true">
								<figure class="post-thumbnail">
										<a href="https://blog.fndsec.net/2025/04/02/breaking-down-sharepoint-walls/" rel="bookmark" tabindex="-1" aria-hidden="true">
																		<img width="1024" height="683" src="https://blog.fndsec.net/wp-content/uploads/2025/04/sp.png?w=1024" class="image-fit-cover wp-post-image" alt="Breaking Down SharePoint Walls: Hunting for Sensitive&nbsp;Files" object-fit="cover" layout="fill" decoding="async" loading="lazy" data-attachment-id="1019" data-permalink="https://blog.fndsec.net/2025/04/02/breaking-down-sharepoint-walls/sp/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2025/04/sp.png" data-orig-size="1536,1024" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="breaking-sharepoint-walls" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2025/04/sp.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2025/04/sp.png?w=1024">																</a>
									</figure>

									<div class="entry-wrapper">
						<h3 class="entry-title"><a href="https://blog.fndsec.net/2025/04/02/breaking-down-sharepoint-walls/" rel="bookmark" tabindex="-1">Breaking Down SharePoint Walls: Hunting for Sensitive&nbsp;Files</a></h3>
						<div class="entry-meta">
							<time class="entry-date published" datetime="2025-04-02T12:37:19+03:00">April 2, 2025</time>						</div><!-- .entry-meta -->
					</div><!-- .entry-wrapper -->
							</article>
			
			<article data-post-id="730" class="post-has-image swiper-slide tag-active-directory tag-bloodhound tag-defender-for-identity tag-powershell category-uncategorized type-post post swiper-slide-visible swiper-slide-fully-visible" style="width: 256px; height: 192px; margin-right: 16px;" data-swiper-slide-index="2" aria-hidden="true">
								<figure class="post-thumbnail">
										<a href="https://blog.fndsec.net/2024/11/25/shadowhound/" rel="bookmark" tabindex="-1" aria-hidden="true">
																		<img width="1024" height="574" src="https://blog.fndsec.net/wp-content/uploads/2024/11/logo-1.png?w=1024" class="image-fit-cover wp-post-image" alt="ShadowHound: A SharpHound Alternative Using Native&nbsp;PowerShell" object-fit="cover" layout="fill" decoding="async" loading="lazy" data-attachment-id="760" data-permalink="https://blog.fndsec.net/2024/11/25/shadowhound/logo-2/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2024/11/logo-1.png" data-orig-size="1228,688" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="logo" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2024/11/logo-1.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2024/11/logo-1.png?w=1024">																</a>
									</figure>

									<div class="entry-wrapper">
						<h3 class="entry-title"><a href="https://blog.fndsec.net/2024/11/25/shadowhound/" rel="bookmark" tabindex="-1">ShadowHound: A SharpHound Alternative Using Native&nbsp;PowerShell</a></h3>
						<div class="entry-meta">
							<time class="entry-date published" datetime="2024-11-25T13:43:55+02:00">November 25, 2024</time>						</div><!-- .entry-meta -->
					</div><!-- .entry-wrapper -->
							</article>
			
			<article data-post-id="435" class="post-has-image swiper-slide tag-windows tag-windows-defender category-uncategorized type-post post swiper-slide-visible swiper-slide-fully-visible" style="width: 256px; height: 192px; margin-right: 16px;" data-swiper-slide-index="3" aria-hidden="true">
								<figure class="post-thumbnail">
										<a href="https://blog.fndsec.net/2024/10/04/uncovering-exclusion-paths-in-microsoft-defender-a-security-research-insight/" rel="bookmark" tabindex="-1" aria-hidden="true">
																		<img width="731" height="343" src="https://blog.fndsec.net/wp-content/uploads/2024/10/image-4.png?w=731" class="image-fit-cover wp-post-image" alt="Peeking Behind the Curtain: Finding Defender’s&nbsp;Exclusions" object-fit="cover" layout="fill" decoding="async" loading="lazy" data-attachment-id="454" data-permalink="https://blog.fndsec.net/2024/10/04/uncovering-exclusion-paths-in-microsoft-defender-a-security-research-insight/image-5/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2024/10/image-4.png" data-orig-size="731,343" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2024/10/image-4.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2024/10/image-4.png?w=731">																</a>
									</figure>

									<div class="entry-wrapper">
						<h3 class="entry-title"><a href="https://blog.fndsec.net/2024/10/04/uncovering-exclusion-paths-in-microsoft-defender-a-security-research-insight/" rel="bookmark" tabindex="-1">Peeking Behind the Curtain: Finding Defender’s&nbsp;Exclusions</a></h3>
						<div class="entry-meta">
							<time class="entry-date published" datetime="2024-10-04T14:27:45+03:00">October 4, 2024</time>						</div><!-- .entry-meta -->
					</div><!-- .entry-wrapper -->
							</article>
			
			<article data-post-id="529" class="post-has-image swiper-slide tag-windows tag-wmi category-uncategorized type-post post swiper-slide-visible swiper-slide-fully-visible" style="width: 256px; height: 192px; margin-right: 16px;" data-swiper-slide-index="4" aria-hidden="true">
								<figure class="post-thumbnail">
										<a href="https://blog.fndsec.net/2024/09/11/wmi-research-and-lateral-movement/" rel="bookmark" tabindex="-1" aria-hidden="true">
																		<img width="697" height="583" src="https://blog.fndsec.net/wp-content/uploads/2024/10/1_3l7xcxc2ytymqyontvgzfg.png?w=697" class="image-fit-cover wp-post-image" alt="WMI Research and Lateral&nbsp;Movement" object-fit="cover" layout="fill" decoding="async" loading="lazy" data-attachment-id="543" data-permalink="https://blog.fndsec.net/2024/09/11/wmi-research-and-lateral-movement/1_3l7xcxc2ytymqyontvgzfg/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2024/10/1_3l7xcxc2ytymqyontvgzfg.png" data-orig-size="697,583" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="1_3L7xcXc2ytymqyoNtVGZfg" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2024/10/1_3l7xcxc2ytymqyontvgzfg.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2024/10/1_3l7xcxc2ytymqyontvgzfg.png?w=697">																</a>
									</figure>

									<div class="entry-wrapper">
						<h3 class="entry-title"><a href="https://blog.fndsec.net/2024/09/11/wmi-research-and-lateral-movement/" rel="bookmark" tabindex="-1">WMI Research and Lateral&nbsp;Movement</a></h3>
						<div class="entry-meta">
							<time class="entry-date published" datetime="2024-09-11T16:57:00+03:00">September 11, 2024</time>						</div><!-- .entry-meta -->
					</div><!-- .entry-wrapper -->
							</article>
			
			<article data-post-id="9" class="post-has-image swiper-slide tag-azure tag-webauthn tag-whfb category-uncategorized type-post post swiper-slide-visible swiper-slide-fully-visible" style="width: 256px; height: 192px; margin-right: 16px;" data-swiper-slide-index="5" aria-hidden="true">
								<figure class="post-thumbnail">
										<a href="https://blog.fndsec.net/2024/07/23/hook-line-and-sinker-phishing-windows-hello-for-business/" rel="bookmark" tabindex="-1" aria-hidden="true">
																		<img width="700" height="179" src="https://blog.fndsec.net/wp-content/uploads/2024/07/43817-1yqxubmuk-zar2nl9er_2dq.png?w=700" class="image-fit-cover wp-post-image" alt="Hook, Line and Sinker: Phishing Windows Hello for&nbsp;Business" object-fit="cover" layout="fill" decoding="async" loading="lazy" data-attachment-id="38" data-permalink="https://blog.fndsec.net/2024/07/23/hook-line-and-sinker-phishing-windows-hello-for-business/1yqxubmuk-zar2nl9er_2dq/" data-orig-file="https://blog.fndsec.net/wp-content/uploads/2024/07/43817-1yqxubmuk-zar2nl9er_2dq.png" data-orig-size="700,179" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="1*YQXUbMuk-ZAr2nl9ER_2dQ" data-image-description="" data-image-caption="" data-medium-file="https://blog.fndsec.net/wp-content/uploads/2024/07/43817-1yqxubmuk-zar2nl9er_2dq.png?w=300" data-large-file="https://blog.fndsec.net/wp-content/uploads/2024/07/43817-1yqxubmuk-zar2nl9er_2dq.png?w=700">																</a>
									</figure>

									<div class="entry-wrapper">
						<h3 class="entry-title"><a href="https://blog.fndsec.net/2024/07/23/hook-line-and-sinker-phishing-windows-hello-for-business/" rel="bookmark" tabindex="-1">Hook, Line and Sinker: Phishing Windows Hello for&nbsp;Business</a></h3>
						<div class="entry-meta">
							<time class="entry-date published" datetime="2024-07-23T09:37:20+03:00">July 23, 2024</time>						</div><!-- .entry-meta -->
					</div><!-- .entry-wrapper -->
							</article>
			</div><button class="swiper-button swiper-button-prev" aria-label="Previous Slide"></button><button class="swiper-button swiper-button-next" aria-label="Next Slide"></button></div><div class="swiper-pagination-bullets swiper-pagination-clickable swiper-pagination-horizontal"><button class="swiper-pagination-bullet swiper-pagination-bullet-active"><span>Slide 1</span></button><button class="swiper-pagination-bullet"><span>Slide 2</span></button><button class="swiper-pagination-bullet"><span>Slide 3</span></button><button class="swiper-pagination-bullet"><span>Slide 4</span></button><button class="swiper-pagination-bullet"><span>Slide 5</span></button><button class="swiper-pagination-bullet"><span>Slide 6</span></button></div></div></div>
</div>
</main>


</div>
</div>
</div>
</div>
<!-- wpcom_wp_footer -->





	

		<div style="display:none">
	<div class="grofile-hash-map-40c587ea7dfe8a8f5e82a6c549140908">
	</div>
	</div>
		<div id="jp-carousel-loading-overlay">
			<div id="jp-carousel-loading-wrapper">
				<span id="jp-carousel-library-loading">&nbsp;</span>
			</div>
		</div>
		<div class="jp-carousel-overlay" style="display: none;">

		<div class="jp-carousel-container">
			<!-- The Carousel Swiper -->
			<div class="jp-carousel-wrap swiper jp-carousel-swiper-container jp-carousel-transitions" itemscope="" itemtype="https://schema.org/ImageGallery">
				<div class="jp-carousel swiper-wrapper"></div>
				<div class="jp-swiper-button-prev swiper-button-prev">
					<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<mask id="maskPrev" mask-type="alpha" maskUnits="userSpaceOnUse" x="8" y="6" width="9" height="12">
							<path d="M16.2072 16.59L11.6496 12L16.2072 7.41L14.8041 6L8.8335 12L14.8041 18L16.2072 16.59Z" fill="white"></path>
						</mask>
						<g mask="url(#maskPrev)">
							<rect x="0.579102" width="23.8823" height="24" fill="#FFFFFF"></rect>
						</g>
					</svg>
				</div>
				<div class="jp-swiper-button-next swiper-button-next">
					<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<mask id="maskNext" mask-type="alpha" maskUnits="userSpaceOnUse" x="8" y="6" width="8" height="12">
							<path d="M8.59814 16.59L13.1557 12L8.59814 7.41L10.0012 6L15.9718 12L10.0012 18L8.59814 16.59Z" fill="white"></path>
						</mask>
						<g mask="url(#maskNext)">
							<rect x="0.34375" width="23.8822" height="24" fill="#FFFFFF"></rect>
						</g>
					</svg>
				</div>
			</div>
			<!-- The main close buton -->
			<div class="jp-carousel-close-hint">
				<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
					<mask id="maskClose" mask-type="alpha" maskUnits="userSpaceOnUse" x="5" y="5" width="15" height="14">
						<path d="M19.3166 6.41L17.9135 5L12.3509 10.59L6.78834 5L5.38525 6.41L10.9478 12L5.38525 17.59L6.78834 19L12.3509 13.41L17.9135 19L19.3166 17.59L13.754 12L19.3166 6.41Z" fill="white"></path>
					</mask>
					<g mask="url(#maskClose)">
						<rect x="0.409668" width="23.8823" height="24" fill="#FFFFFF"></rect>
					</g>
				</svg>
			</div>
			<!-- Image info, comments and meta -->
			<div class="jp-carousel-info">
				<div class="jp-carousel-info-footer">
					<div class="jp-carousel-pagination-container">
						<div class="jp-swiper-pagination swiper-pagination"></div>
						<div class="jp-carousel-pagination"></div>
					</div>
					<div class="jp-carousel-photo-title-container">
						<h2 class="jp-carousel-photo-caption"></h2>
					</div>
					<div class="jp-carousel-photo-icons-container">
						<a href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#" class="jp-carousel-icon-btn jp-carousel-icon-info" aria-label="Toggle photo metadata visibility">
							<span class="jp-carousel-icon">
								<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<mask id="maskInfo" mask-type="alpha" maskUnits="userSpaceOnUse" x="2" y="2" width="21" height="20">
										<path fill-rule="evenodd" clip-rule="evenodd" d="M12.7537 2C7.26076 2 2.80273 6.48 2.80273 12C2.80273 17.52 7.26076 22 12.7537 22C18.2466 22 22.7046 17.52 22.7046 12C22.7046 6.48 18.2466 2 12.7537 2ZM11.7586 7V9H13.7488V7H11.7586ZM11.7586 11V17H13.7488V11H11.7586ZM4.79292 12C4.79292 16.41 8.36531 20 12.7537 20C17.142 20 20.7144 16.41 20.7144 12C20.7144 7.59 17.142 4 12.7537 4C8.36531 4 4.79292 7.59 4.79292 12Z" fill="white"></path>
									</mask>
									<g mask="url(#maskInfo)">
										<rect x="0.8125" width="23.8823" height="24" fill="#FFFFFF"></rect>
									</g>
								</svg>
							</span>
						</a>
												<a href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#" class="jp-carousel-icon-btn jp-carousel-icon-comments" aria-label="Toggle photo comments visibility">
							<span class="jp-carousel-icon">
								<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<mask id="maskComments" mask-type="alpha" maskUnits="userSpaceOnUse" x="2" y="2" width="21" height="20">
										<path fill-rule="evenodd" clip-rule="evenodd" d="M4.3271 2H20.2486C21.3432 2 22.2388 2.9 22.2388 4V16C22.2388 17.1 21.3432 18 20.2486 18H6.31729L2.33691 22V4C2.33691 2.9 3.2325 2 4.3271 2ZM6.31729 16H20.2486V4H4.3271V18L6.31729 16Z" fill="white"></path>
									</mask>
									<g mask="url(#maskComments)">
										<rect x="0.34668" width="23.8823" height="24" fill="#FFFFFF"></rect>
									</g>
								</svg>

								<span class="jp-carousel-has-comments-indicator" aria-label="This image has comments."></span>
							</span>
						</a>
											</div>
				</div>
				<div class="jp-carousel-info-extra">
					<div class="jp-carousel-info-content-wrapper">
						<div class="jp-carousel-photo-title-container">
							<h2 class="jp-carousel-photo-title"></h2>
						</div>
						<div class="jp-carousel-comments-wrapper">
															<div id="jp-carousel-comments-loading">
									<span>Loading Comments...</span>
								</div>
								<div class="jp-carousel-comments"></div>
								<div id="jp-carousel-comment-form-container">
									<span id="jp-carousel-comment-form-spinner">&nbsp;</span>
									<div id="jp-carousel-comment-post-results"></div>
																														<form id="jp-carousel-comment-form">
												<label for="jp-carousel-comment-form-comment-field" class="screen-reader-text">Write a Comment...</label>
												<textarea name="comment" class="jp-carousel-comment-form-field jp-carousel-comment-form-textarea" id="jp-carousel-comment-form-comment-field" placeholder="Write a Comment..."></textarea>
												<div id="jp-carousel-comment-form-submit-and-info-wrapper">
													<div id="jp-carousel-comment-form-commenting-as">
																													<fieldset>
																<label for="jp-carousel-comment-form-email-field">Email (Required)</label>
																<input type="text" name="email" class="jp-carousel-comment-form-field jp-carousel-comment-form-text-field" id="jp-carousel-comment-form-email-field">
															</fieldset>
															<fieldset>
																<label for="jp-carousel-comment-form-author-field">Name (Required)</label>
																<input type="text" name="author" class="jp-carousel-comment-form-field jp-carousel-comment-form-text-field" id="jp-carousel-comment-form-author-field">
															</fieldset>
															<fieldset>
																<label for="jp-carousel-comment-form-url-field">Website</label>
																<input type="text" name="url" class="jp-carousel-comment-form-field jp-carousel-comment-form-text-field" id="jp-carousel-comment-form-url-field">
															</fieldset>
																											</div>
													<input type="submit" name="submit" class="jp-carousel-comment-form-button" id="jp-carousel-comment-form-button-submit" value="Post Comment">
												</div>
											</form>
																											</div>
													</div>
						<div class="jp-carousel-image-meta">
							<div class="jp-carousel-title-and-caption">
								<div class="jp-carousel-photo-info">
									<h3 class="jp-carousel-caption" itemprop="caption description"></h3>
								</div>

								<div class="jp-carousel-photo-description"></div>
							</div>
							<ul class="jp-carousel-image-exif" style="display: none;"></ul>
							<a class="jp-carousel-image-download" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#" target="_blank" style="display: none;">
								<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<mask id="mask0" mask-type="alpha" maskUnits="userSpaceOnUse" x="3" y="3" width="19" height="18">
										<path fill-rule="evenodd" clip-rule="evenodd" d="M5.84615 5V19H19.7775V12H21.7677V19C21.7677 20.1 20.8721 21 19.7775 21H5.84615C4.74159 21 3.85596 20.1 3.85596 19V5C3.85596 3.9 4.74159 3 5.84615 3H12.8118V5H5.84615ZM14.802 5V3H21.7677V10H19.7775V6.41L9.99569 16.24L8.59261 14.83L18.3744 5H14.802Z" fill="white"></path>
									</mask>
									<g mask="url(#mask0)">
										<rect x="0.870605" width="23.8823" height="24" fill="#FFFFFF"></rect>
									</g>
								</svg>
								<span class="jp-carousel-download-text"></span>
							</a>
							<div class="jp-carousel-image-map" style="display: none;"></div>
						</div>
					</div>
				</div>
			</div>
		</div>

		</div>
				<div id="actionbar" dir="ltr" class="actnbr-pub-jinjang actnbr-has-follow actnbr-has-actions">
		<ul>
								<li class="actnbr-btn actnbr-hidden no-display">
						<a class="actnbr-action actnbr-actn-comment" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/#comments">
							<svg class="gridicon gridicons-comment" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path d="M12 16l-5 5v-5H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2v9c0 1.1-.9 2-2 2h-7z"></path></g></svg>							<span>Comment						</span>
						</a>
					</li>
									<li class="actnbr-btn actnbr-hidden">
								<a class="actnbr-action actnbr-actn-follow " href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/">
			<svg class="gridicon" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path clip-rule="evenodd" d="m4 4.5h12v6.5h1.5v-6.5-1.5h-1.5-12-1.5v1.5 10.5c0 1.1046.89543 2 2 2h7v-1.5h-7c-.27614 0-.5-.2239-.5-.5zm10.5 2h-9v1.5h9zm-5 3h-4v1.5h4zm3.5 1.5h-1v1h1zm-1-1.5h-1.5v1.5 1 1.5h1.5 1 1.5v-1.5-1-1.5h-1.5zm-2.5 2.5h-4v1.5h4zm6.5 1.25h1.5v2.25h2.25v1.5h-2.25v2.25h-1.5v-2.25h-2.25v-1.5h2.25z" fill-rule="evenodd"></path></svg>
			<span>Subscribe</span>
		</a>
		<a class="actnbr-action actnbr-actn-following  no-display" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/">
			<svg class="gridicon" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 4.5H4V15C4 15.2761 4.22386 15.5 4.5 15.5H11.5V17H4.5C3.39543 17 2.5 16.1046 2.5 15V4.5V3H4H16H17.5V4.5V12.5H16V4.5ZM5.5 6.5H14.5V8H5.5V6.5ZM5.5 9.5H9.5V11H5.5V9.5ZM12 11H13V12H12V11ZM10.5 9.5H12H13H14.5V11V12V13.5H13H12H10.5V12V11V9.5ZM5.5 12H9.5V13.5H5.5V12Z" fill="#008A20"></path><path class="following-icon-tick" d="M13.5 16L15.5 18L19 14.5" stroke="#008A20" stroke-width="1.5"></path></svg>
			<span>Subscribed</span>
		</a>
							<div class="actnbr-popover tip tip-top-left actnbr-notice" id="follow-bubble">
							<div class="tip-arrow"></div>
							<div class="tip-inner actnbr-follow-bubble">
															<ul>
											<li class="actnbr-sitename">
			<a href="https://blog.fndsec.net/">
				<img loading="lazy" alt="" src="https://blog.fndsec.net/wp-content/uploads/2024/10/security-4.png?w=50" class="avatar avatar-50" height="50" width="50">				Security Friends' Research Blog			</a>
		</li>
										<div class="actnbr-message no-display"></div>
									<form method="post" action="https://subscribe.wordpress.com/" accept-charset="utf-8" style="display: none;">
																				<div>
										<input type="email" name="email" placeholder="Enter your email address" class="actnbr-email-field" aria-label="Enter your email address">
										</div>
										
										
										
										
																				<div class="actnbr-button-wrap">
											<button type="submit" value="Sign me up">
												Sign me up											</button>
										</div>
									</form>
									<li class="actnbr-login-nudge">
										<div>
											Already have a WordPress.com account? <a href="https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.fndsec.net%252F2025%252F05%252F16%252Fthe-context-only-attack-surface%252F">Log in now.</a>										</div>
									</li>
								</ul>
															</div>
						</div>
					</li>
							<li class="actnbr-ellipsis actnbr-hidden">
				<svg class="gridicon gridicons-ellipsis" height="24" width="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path d="M7 12c0 1.104-.896 2-2 2s-2-.896-2-2 .896-2 2-2 2 .896 2 2zm12-2c-1.104 0-2 .896-2 2s.896 2 2 2 2-.896 2-2-.896-2-2-2zm-7 0c-1.104 0-2 .896-2 2s.896 2 2 2 2-.896 2-2-.896-2-2-2z"></path></g></svg>				<div class="actnbr-popover tip tip-top-left actnbr-more">
					<div class="tip-arrow"></div>
					<div class="tip-inner">
						<ul>
								<li class="actnbr-sitename">
			<a href="https://blog.fndsec.net/">
				<img loading="lazy" alt="" src="https://blog.fndsec.net/wp-content/uploads/2024/10/security-4.png?w=50" class="avatar avatar-50" height="50" width="50">				Security Friends' Research Blog			</a>
		</li>
								<li class="actnbr-folded-follow">
										<a class="actnbr-action actnbr-actn-follow " href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/">
			<svg class="gridicon" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path clip-rule="evenodd" d="m4 4.5h12v6.5h1.5v-6.5-1.5h-1.5-12-1.5v1.5 10.5c0 1.1046.89543 2 2 2h7v-1.5h-7c-.27614 0-.5-.2239-.5-.5zm10.5 2h-9v1.5h9zm-5 3h-4v1.5h4zm3.5 1.5h-1v1h1zm-1-1.5h-1.5v1.5 1 1.5h1.5 1 1.5v-1.5-1-1.5h-1.5zm-2.5 2.5h-4v1.5h4zm6.5 1.25h1.5v2.25h2.25v1.5h-2.25v2.25h-1.5v-2.25h-2.25v-1.5h2.25z" fill-rule="evenodd"></path></svg>
			<span>Subscribe</span>
		</a>
		<a class="actnbr-action actnbr-actn-following  no-display" href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/">
			<svg class="gridicon" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 4.5H4V15C4 15.2761 4.22386 15.5 4.5 15.5H11.5V17H4.5C3.39543 17 2.5 16.1046 2.5 15V4.5V3H4H16H17.5V4.5V12.5H16V4.5ZM5.5 6.5H14.5V8H5.5V6.5ZM5.5 9.5H9.5V11H5.5V9.5ZM12 11H13V12H12V11ZM10.5 9.5H12H13H14.5V11V12V13.5H13H12H10.5V12V11V9.5ZM5.5 12H9.5V13.5H5.5V12Z" fill="#008A20"></path><path class="following-icon-tick" d="M13.5 16L15.5 18L19 14.5" stroke="#008A20" stroke-width="1.5"></path></svg>
			<span>Subscribed</span>
		</a>
								</li>
														<li class="actnbr-signup"><a href="https://wordpress.com/start/">Sign up</a></li>
							<li class="actnbr-login"><a href="https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.fndsec.net%252F2025%252F05%252F16%252Fthe-context-only-attack-surface%252F">Log in</a></li>
																<li class="actnbr-shortlink">
										<a href="https://wp.me/pfVvQc-h3">
											<span class="actnbr-shortlink__text">Copy shortlink</span>
											<span class="actnbr-shortlink__icon"><svg class="gridicon gridicons-checkmark" height="16" width="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path d="M9 19.414l-6.707-6.707 1.414-1.414L9 16.586 20.293 5.293l1.414 1.414"></path></g></svg></span>
										</a>
									</li>
																<li class="flb-report">
									<a href="https://wordpress.com/abuse/?report_url=https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/" target="_blank" rel="noopener noreferrer">
										Report this content									</a>
								</li>
															<li class="actnbr-reader">
									<a href="https://wordpress.com/reader/blogs/235352136/posts/1057">
										View post in Reader									</a>
								</li>
															<li class="actnbr-subs">
									<a href="https://subscribe.wordpress.com/">Manage subscriptions</a>
								</li>
																<li class="actnbr-fold"><a href="https://blog.fndsec.net/2025/05/16/the-context-only-attack-surface/">Collapse this bar</a></li>
														</ul>
					</div>
				</div>
			</li>
		</ul>
	</div>
	


	

















	


 


		 	



<p id="a11y-speak-intro-text" class="a11y-speak-intro-text" style="position:absolute;margin:-1px;padding:0;height:1px;width:1px;overflow:hidden;clip-path:inset(50%);border:0;word-wrap:normal !important;">Notifications</p><div id="a11y-speak-assertive" class="a11y-speak-region" style="position:absolute;margin:-1px;padding:0;height:1px;width:1px;overflow:hidden;clip-path:inset(50%);border:0;word-wrap:normal !important;" aria-live="assertive" aria-relevant="additions text" aria-atomic="true">Playing</div><div id="a11y-speak-polite" class="a11y-speak-region" style="position:absolute;margin:-1px;padding:0;height:1px;width:1px;overflow:hidden;clip-path:inset(50%);border:0;word-wrap:normal !important;" aria-live="polite" aria-relevant="additions text" aria-atomic="true"></div></body></html>