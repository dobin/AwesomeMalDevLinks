# https://www.blackhillsinfosec.com/a-different-take-on-dll-hijacking/

<!DOCTYPE html><html lang="en-US" data-wp-dark-mode-preset="0" style="">

<body class="wp-singular post-template-default single single-post postid-30482 single-format-standard wp-theme-themify-corporate tribe-js skin-default sidebar-none default_width no-home fixed-header-enabled tb_animation_on sidemenu-active" style="--wpdm-img-opacity: 1; --wpdm-vid-opacity: 1;"><div id="simple-banner" class="simple-banner"><div class="simple-banner-text"><span><a href="https://wildwesthackinfest.com/wild-west-hackin-fest-mile-high-2026/">Join us at Wild West Hackin' Fest @ Mile High in Denver for Training, Community, and Fun!</a></span></div></div>
<svg id="tf_svg" style="display:none"><defs><symbol id="tf-fab-youtube-square" viewBox="0 0 32 32"><path d="M11.69 12.63 17.63 16l-5.94 3.38v-6.75zM28 5v22q0 1.25-.88 2.13T25 30H3q-1.25 0-2.13-.88T0 27V5q0-1.25.88-2.13T3 2h22q1.25 0 2.13.88T28 5zm-2.63 11q0-3.69-.5-5.5-.37-1.63-2-2-.75-.25-2.96-.38T15.8 8H14q-7.13 0-8.88.5-1.62.38-2 2-.25.81-.37 2.19t-.13 2.37V16q0 3.75.5 5.5.38 1.63 2 2 .75.25 2.97.38t4.1.12H14q7.13 0 8.88-.5 1.62-.44 2-2 .25-.75.37-2.12t.13-2.38v-1z"></path></symbol><symbol id="tf-fab-linkedin-square" viewBox="0 0 32 32"><path d="M26 2q.81 0 1.4.6T28 4v24q0 .81-.6 1.4T26 30H2q-.81 0-1.4-.6T0 28V4q0-.81.6-1.4T2 2h24zM8.44 26h.06V12.62H4.31V26h4.13zM6.38 10.81q1 0 1.71-.72t.72-1.68-.72-1.7T6.37 6t-1.68.72-.7 1.69.7 1.68 1.68.72zM24 26v-7.31q0-1.5-.19-2.57t-.69-1.96-1.53-1.38-2.53-.47q-1.44 0-2.47.63t-1.47 1.5h-.06v-1.82h-4V26h4.19v-6.63q0-1.56.5-2.5t1.94-.93q.75 0 1.25.3t.65.95.22 1.09.07 1.22V26H24z"></path></symbol><symbol id="tf-fab-bluesky" viewBox="0 0 576 512"><path d="M123.6 34.5c66.4 50.1 137.9 151.5 164.2 206C314 186 385.5 84.5 452 34.5c48-36.1 125.6-64.1 125.6 24.9c0 17.8-10.1 149.2-16.1 170.5c-20.7 74.2-96.1 93.1-163.1 81.6c117.2 20 147 86.3 82.6 152.6C358.7 590 305.2 432.5 291.5 392.1c-2.5-7.5-3.7-10.9-3.7-7.9c0-3.1-1.2 .4-3.7 7.9C270.4 432.5 216.9 590 94.6 464.1C30.2 397.8 60 331.5 177.2 311.5C110.2 322.9 34.8 304 14.1 229.8C8.1 208.5-2 77.1-2 59.3c0-88.9 77.7-61 125.6-24.9z"></path></symbol><symbol id="tf-fab-discord" viewBox="0 0 32 32"><path d="M18.56 15.19q0 .75-.47 1.28t-1.15.53q-.44 0-.82-.25t-.59-.66-.22-.9q0-.38.13-.69t.34-.56.53-.38.63-.12q.68 0 1.15.5t.47 1.25zm-7.43-1.75q.68 0 1.15.5t.47 1.25-.47 1.28-1.15.53-1.16-.53-.47-1.28.47-1.25 1.15-.5zM28 3.3V32q-3.63-3.2-7.44-6.76l.88 3H3.24q-1.3 0-2.27-.97T0 24.94V3.3Q0 1.94.97.97T3.25 0h21.5q1.31 0 2.28.97T28 3.3zm-4.56 15.13q0-2.25-.57-4.6t-1.18-3.53l-.57-1.18q-.62-.5-1.34-.85t-1.25-.5-.97-.25-.69-.1h-.25l-.18.26q1.18.37 2.18.9t1.38.85l.37.31q-2.75-1.56-6-1.63T8.44 9.25l-.94.5q1.3-1.25 4.19-2.13l-.13-.18q-2.19 0-4.5 1.68-.25.5-.62 1.32T5.4 13.72t-.65 4.72q.12.31.47.69t1.6 1.06 2.8.69q.63-.7 1.07-1.32-.88-.25-1.6-.71T8.12 18l-.25-.31.29.15.28.16.12.06q2.13 1.2 4.72 1.4t5.28-.84q.94-.3 1.81-.93-.8 1.31-2.87 1.93l1.06 1.25q1 0 1.85-.28t1.37-.62.94-.69.53-.6z"></path></symbol><symbol id="tf-fab-x-twitter" viewBox="0 0 512 512"><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"></path></symbol><symbol id="tf-fas-podcast" viewBox="0 0 28 32"><path d="M16.69 30.56Q16.3 32 14 32t-2.69-1.44q-.44-1.56-.87-4.22T10 22.25q0-2.75 4-2.75t4 2.75q0 1.44-.44 4.1t-.87 4.21zM9.8 18.06q.32.32-.06.57-.88.62-1.31 1.56-.25.5-.57.12Q5 17.63 5 13.75q0-3.81 2.72-6.47t6.53-2.53q3.56.13 6.12 2.66T23 13.5q.12 4.05-2.88 6.8-.3.38-.56-.12-.44-.94-1.31-1.56-.38-.25-.06-.57 1.8-1.81 1.8-4.31 0-2.56-1.84-4.34t-4.4-1.66q-2.32.13-3.97 1.78T8 13.5q-.13 2.69 1.81 4.56zM14 0q5.81 0 9.9 4.1T28 14q0 4.13-2.19 7.5t-5.69 5.06q-.18.13-.37 0t-.13-.37q.25-1.69.32-2.94 2.31-1.5 3.69-3.94T25 14q0-1.81-.56-3.47t-1.6-3.03-2.37-2.38-3.03-1.56T14 3Q9.44 3 6.22 6.22T3 13.94q0 2.8 1.31 5.25t3.57 3.93q.18.13.18.32.07 1.18.32 2.75.06.25-.13.37t-.37 0Q4.3 24.87 2.16 21.5T0 14q0-5.81 4.1-9.9T14 0zm0 10q1.69 0 2.84 1.16T18 14t-1.16 2.84T14 18t-2.84-1.16T10 14t1.16-2.84T14 10z"></path></symbol></defs></svg><div id="pagewrap" class="hfeed site">

	<div id="headerwrap">

		
		
		<!-- /#header -->

        
	</div>
	<!-- /#headerwrap -->

	<div id="body" class="tf_clearfix">

		<!-- layout -->
<div id="layout" class="pagewidth tf_clearfix">
            <main id="content" class="tf_clearfix">
	    <article id="post-30482" class="post tf_clearfix post-30482 type-post status-publish format-standard has-post-thumbnail hentry category-c2 category-external category-matthew-eidelberg category-red-team category-tool-red-team tag-exploit-dev tag-malware-dev has-post-title has-post-date has-post-category has-post-tag has-post-comment no-post-author ">
	
	
			<div class="post-date-wrap">
			<time datetime="2024-09-26" class="post-date entry-date updated">
				<span class="day">26</span>
				<span class="month">Sep</span>
				<span class="year">2024</span>
			</time>
		</div>
	
	<div class="post-content">

					<p class="post-meta entry-meta">

									
				<span class="post-category"><a href="https://www.blackhillsinfosec.com/category/red-team/c2/" rel="tag" class="term-c2">C2</a>, <a href="https://www.blackhillsinfosec.com/category/red-team/external/" rel="tag" class="term-external">External/Internal</a>, <a href="https://www.blackhillsinfosec.com/category/author/matthew-eidelberg/" rel="tag" class="term-matthew-eidelberg">Matthew Eidelberg</a>, <a href="https://www.blackhillsinfosec.com/category/red-team/" rel="tag" class="term-red-team">Red Team</a>, <a href="https://www.blackhillsinfosec.com/category/red-team/tool-red-team/" rel="tag" class="term-tool-red-team">Red Team Tools</a></span>
									 <span class="post-tag"><a href="https://www.blackhillsinfosec.com/tag/exploit-dev/" rel="tag">Exploit Dev</a>, <a href="https://www.blackhillsinfosec.com/tag/malware-dev/" rel="tag">Malware Dev</a></span>				
							</p>
		
		<h1 class="post-title entry-title"><a href="https://www.blackhillsinfosec.com/a-different-take-on-dll-hijacking/">Proxying Your Way to Code Execution – A Different Take on DLL Hijacking&nbsp;</a></h1>
		        <div class="entry-content">

                                        
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-28f84493 wp-block-columns-is-layout-flex">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:7%">
<figure class="wp-block-image aligncenter size-thumbnail is-resized is-style-rounded"><img decoding="async" width="150" height="150" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/03/MEidelberg-150x150.png" alt="" class="wp-image-28189" style="width:77px"></figure>
</div>



<div class="wp-block-column is-vertically-aligned-center is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:50%">
<p>| <a href="https://x.com/Tyl0us" target="_blank" rel="noopener noreferrer">Matthew Eidelberg</a></p>
</div>
</div>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>


<figure class="wp-block-post-featured-image"><img fetchpriority="high" decoding="async" width="1280" height="720" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/BLOG_chalkboard_000691.png" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="" style="object-fit:cover;"></figure>


<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>In the ever-evolving landscape of cybersecurity, attackers continually devise new methods to exploit vulnerabilities in endpoints to execute malicious code. One such method that has recently become more and more popular is DLL hijacking. While DLL hijacking attacks can take on many different forms, this blog post will explore a specific type of attack called DLL proxying, providing insights into how it works, the potential risks it poses, and briefly the methodology for discovering these vulnerable DLLs, which led to the discovery of several zero-day vulnerable DLLs that Microsoft has acknowledged but opted to not fix at this time. As we discuss the methodology, we will also examine how to easily weaponize these DLLs for covert attacks. To begin, let’s first briefly discuss what DLL hijacking is.&nbsp;&nbsp;</p>



<h3 class="wp-block-heading"><strong>What is DLL Hijacking?&nbsp;</strong></h3>



<p>DLL hijacking encompasses numerous different techniques including DLL sidejacking and sideloading but at a high-level, DLL hijacking exploits the way Windows applications search for and load DLLs. When a process executes, it will look to load a series of DLLs in order to run properly. Sometimes a process will look in multiple locations on an endpoint before finding the right DLL, and in other cases, the DLL may not exist at all. By placing a malicious DLL in a location where the process will first look, an attacker can trick the process into loading their DLL instead of the legitimate one, allowing an attacker to execute arbitrary code with the same privileges as the running application. This technique is highly effective in circumventing security controls such as application allowlisting and even endpoint security controls, as valid (less scrutinized) applications load these DLLs as part of the application’s standard runtime procedure. In addition, by taking advantage of DLLs vulnerable to this, attackers can avoid the use of any Living off the Land binaries (LOLbins) to execute their malicious DLLs, which have been become the focus of a lot of detection-based products.&nbsp;</p>



<p>While highly effective, this technique does have its pitfalls. By hijacking a required DLL, an attacker can make the process unstable, or in most cases, cause the application to have missing functionality which then disrupts operations. This can draw unwanted attention from users or sys admins, especially when attackers are trying to be covert. Another issue is that most of the folders that processes check for DLLs require elevated privileges to write to them. Because of this, I started looking at alternative ways to achieve this type of an attack. This led me down a huge rabbit hole of research, which led to discovering what I like to call DLL proxy attacks.&nbsp;</p>



<h3 class="wp-block-heading"><strong>What Are DLL Proxying Attacks?&nbsp;</strong></h3>



<p>DLL proxying takes a different approach than traditional DLL hijacking. Rather than taking advantage of a process’s search order, DLL proxying relies on two things. The first is a misconfiguration in the access controls of the folder that the DLL exists in, that allow any user to write to the contents in that folder. This allows an attacker to drop a DLL into the same folder as the vulnerable DLL.&nbsp;&nbsp;</p>



<p>Now, you can’t have two DLLs with the same name in the same folder, so with this write permission, we can rename the DLL to whatever we want. This is important for the second part, the proxying aspect. The idea behind this technique is to still allow access to the functions in the DLL we’re targeting. To do this, we need to forward all traffic from our malicious DLL to the legitimate one; this ensures that we do not disrupt the application’s operations. When the application attempts to load the DLL, it will load the malicious DLL instead, effectively allowing our malicious code to run, as well forward any of the function requests to the legitimate DLL without disrupting or crashing. This turns our malicious DLL into a proxy between the application and the legitimate DLL.&nbsp;</p>



<figure class="wp-block-image aligncenter size-medium"><img decoding="async" width="500" height="340" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-1-500x340.png" alt="" class="wp-image-30484"><figcaption class="wp-element-caption"><em>Figure 1 – DLL Proxying Attack</em>&nbsp;</figcaption></figure>



<p>DLL proxying attacks are extremely effective because they do not require elevated privileges to perform them. Typically, when a program installs DLLs, these files are placed in directories with strict security permissions. These permissions ensure that only users with administrative privileges can write to or rename files in these directories. This protection mechanism is crucial, as it prevents low-privilege users from introducing malicious DLLs into folders where legitimate DLLs are stored, thereby safeguarding the system from potential hijacking attempts.&nbsp;</p>



<h4 class="wp-block-heading">Discovering Them&nbsp;</h4>



<p>Identifying DLLs that are vulnerable to DLL proxying is similar to finding hijackable DLLs. We need to look for any DLLs where a process loads when first executed. However, rather than missing DLLs or DLLs in a different path, we look for DLLs that get loaded at runtime and review the folder permissions. We do this by filtering out all locations we know are protected by default from allowing a low-privilege user from writing to them, such as System32 and any program files folders.&nbsp;&nbsp;</p>



<p>One effective tool for this purpose is <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/procmon" target="_blank" rel="noopener noreferrer">Process Monitor,</a> a free tool for Windows that monitors and displays real-time file system, registry, and process/thread activity. Process Monitor can be used to observe an application’s ‘Load Image’ events, which occur when the application loads a DLL. By filtering out specific file locations, this makes it possible to identify DLLs that could be proxied.&nbsp;</p>



<figure class="wp-block-image aligncenter size-medium"><img decoding="async" width="500" height="317" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/FIgure-2-500x317.png" alt="" class="wp-image-30485"><figcaption class="wp-element-caption"><em>Figure 2 – Search Filters</em>&nbsp;</figcaption></figure>



<p>To begin hunting, we start by launching applications. With Microsoft Office products, there are a lot of cross compatibility and support between other applications, specifically Outlook and Teams. By monitoring these applications, I noticed that Outlook would load several DLLs from AppData. Digging deeper into these events, I discovered vulnerable DLLs (for proxying) existed in both Microsoft Teams version 2 (aka Microsoft Teams for Work and School) and Microsoft Teams Classic.&nbsp; When Microsoft Teams v2 is configured with a user’s profile, it installs a package called TeamsMeetingAddin into Outlook (If Outlook is installed). The folder containing the associated DLLs for this add-in can be modified by low-privilege users to both rename the legitimate DLLs and add malicious DLLs. This means that the next time Outlook is launched, the malicious DLL is loaded by Outlook, leading to code execution in the Outlook process. All files in this directory can be modified by a low-privilege user.&nbsp;</p>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="255" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-3-1024x255.png" alt="" class="wp-image-30486"><figcaption class="wp-element-caption"><em>Figure 3 – Process Monitor Results – Outlook.exe</em>&nbsp;</figcaption></figure>



<p>The AppData folder in Windows is a hidden system directory used to store application-specific data and settings for individual user accounts. Each user account on a Windows system has its own AppData folder, which ensures that application data is kept separate and secure for each user. Because it’s focused on the user’s data, the user itself has permissions to write to anything in AppData. This makes it the perfect place to host malicious code and a very bad place to host legitimate DLLs that are used by processes. As we can see below, the folders where “TeamsMeetingAddin” exists is writeable by our low-privilege user.&nbsp;&nbsp;</p>



<figure class="wp-block-image aligncenter size-full is-resized"><img decoding="async" width="838" height="635" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-4.png" alt="" class="wp-image-30487" style="width:592px;height:auto"><figcaption class="wp-element-caption"><em>Figure 4 – OneAuth.dll’s Security Permissions</em>&nbsp;</figcaption></figure>



<p>So now we have a DLL that we know is loaded at execution, the folder permissions allow us to write a new DLL into it, and we can rename any DLLs in that folder. The next step is to create the proxy functionality. This is where definition files (.def) come into play. Definition files are text files containing one or more module statements that describe various attributes of a DLL. Using a .def file we can define all the exported functions and map them to the legitimate DLL that contains requested function. Because of this, we can rename the legitimate DLL to whatever we want (in the example below, we append -legitimate to the name), place our DLL in the same folder, and when a process loads it, it proxies any requests for functions outlined below, to the requests to the legitimate one.&nbsp;</p>



<figure class="wp-block-image aligncenter size-large is-resized"><img decoding="async" width="1024" height="210" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-5-1024x210.png" alt="" class="wp-image-30488" style="width:772px;height:auto"><figcaption class="wp-element-caption"><em>Figure 5 – Example – Def File</em>&nbsp;</figcaption></figure>



<p>Because of this, only one DLL is ever loaded (not OneAuth.dll and OneAuth-legitimate/dll), but when we look at the DLL’s export functions, we can see that each of the proxy functions call back to OneAuth-legitmate.dll. In the example, below our OneAuth.dll will just pop up a simple hello world statement, showing our DLL is loaded. When we deep dive into this, we can see that the legitimate one is referenced in the exports.&nbsp;</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="443" height="252" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-6.png" alt="" class="wp-image-30489"><figcaption class="wp-element-caption"><em>Figure 6 – Proof Of Concept – Outlook Popping a “Hello World” Message</em>&nbsp;</figcaption></figure>



<figure class="wp-block-image aligncenter size-full is-resized"><img decoding="async" width="915" height="386" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-7.png" alt="" class="wp-image-30490" style="width:687px;height:auto"><figcaption class="wp-element-caption"><em>Figure 7 – Our Evil OneAuth.dll Proxying the Functions to the Legitimate One</em>&nbsp;</figcaption></figure>



<p>I’ve observed the following DLLs susceptible to this attack.&nbsp;</p>



<p><span style="text-decoration: underline;">Microsoft Teams V2 or Microsoft Teams for Work or School&nbsp;</span></p>



<ul class="wp-block-list">
<li>C:\Users\{username}\AppData\Local\Microsoft\TeamsMeetingAddin\{version}\x64\OneAuth.dll&nbsp;</li>
</ul>



<p><em>Note: While reviewing numerous different versions of this plugin, I discovered that depending on the version, the folder name can change from TeamsMeetingAddin to TeamsMeetingAdd-in. I have been unable to get a straight answer as to why this happens, but it appears to be Microsoft Developer preference. (We will discuss more about this aspect in part two)</em>&nbsp;</p>



<p><span style="text-decoration: underline;">Microsoft Teams V1 or Microsoft Teams Classic&nbsp;</span></p>



<ul class="wp-block-list">
<li>C:\Users\{username}\AppData\Local\Microsoft\Teams\current\ffmpeg.dll&nbsp;</li>
</ul>



<ul class="wp-block-list">
<li>C:\Users\{username}\AppData\Local\Microsoft\Teams\current\resources\app.asar.unpacked\node_modules\slimcore\bin\SlimCV.dll&nbsp;</li>
</ul>



<h4 class="wp-block-heading">Weaponizing Them&nbsp;</h4>



<p>Once we have our DLL loaded into the process, we need something to trigger our code. Since we are proxying the functions to the legitimate DLL, the only way of running our malicious code is to put it in DLLMain function. Unfortunately, there can be issues with running your shellcode directly from DLLMain with DLLhijack attacks, specifically process deadlocking. Microsoft has documentation on DLL best practices (found <a href="https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-best-practices#deadlocks-caused-by-lock-order-inversion" target="_blank" rel="noopener noreferrer">here </a>if you’re interested in reading further about this). One of their recommendations is to “<em>Defer any calls in DllMain that can wait until later</em>.” This statement gave me an idea to create a separate thread and then sleep it for 10 seconds. This ensures our malicious code only runs after everything else is loaded into the process. By doing so, we can help stay under the radar as, from the user’s perspective, there is no disruption of services or features.&nbsp;&nbsp;</p>



<figure class="wp-block-image aligncenter size-large is-resized"><img decoding="async" width="1024" height="479" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-8-1024x479.png" alt="" class="wp-image-30491" style="width:780px;height:auto"><figcaption class="wp-element-caption"><em>Figure 8 – Sleep Delay code</em>&nbsp;</figcaption></figure>



<h3 class="wp-block-heading"><strong>Impacts of DLL Proxying Attacks&nbsp;</strong></h3>



<p>The impacts of DLL proxying attacks can be significant, as they allow attackers to bypass a variety of security controls. One of the key impacts is the ability to bypass application allowed listing. Application allowed listing is a security practice where only pre-approved applications are allowed to run on a system. Since the malicious code in a DLL proxying attack is loaded by a legitimate allowed application, it can often evade detection. Additionally, these attacks do not require any special permissions making them the perfect method for initial access.&nbsp;&nbsp;</p>



<h4 class="wp-block-heading">Microsoft’s Response&nbsp;</h4>



<p>As of right now, Microsoft has no plans on fixing or remediating these issues but acknowledges them as valid vulnerabilities. Their official response:&nbsp;</p>



<p><em>We determined your finding is valid but does not meet our bar for immediate servicing because even though DLLs associated with this add-in it only provides a low/moderate risk. However, we’ve marked your finding for future review as an opportunity to improve our products. I do not have a timeline for this review. As no further action is required at this time, I am closing this case.</em>&nbsp;</p>



<h3 class="wp-block-heading"><strong>Continuing this Research&nbsp;</strong></h3>



<p>While the news from Microsoft was not ideal, after reviewing some documentations, I discovered Microsoft Outlook and Microsoft Teams Classic were being decommissioned for their new counterparts olk.exe and ms-teams.exe (aka Microsoft Teams V2). After some investigation, I discovered that the new versions contain several security controls that prevents medium integrity and elevated users from accessing the install path for these products, protecting it from DLL sideloading and hijack attacks. While these controls are in place, it is possible to bypass these controls and still have these applications load a malicious DLL from anywhere on the endpoint using the registry.&nbsp;&nbsp;</p>



<p>To begin, we can see that these applications are installed in a different directory than the previous installations. This pathway, “C:\Program Files\WindowsApps\”, appeared to be heavily locked down. By attempting to access the folder to view the contents, we are denied access, even running as an Administrator.&nbsp;</p>



<figure class="wp-block-image aligncenter size-large is-resized"><img decoding="async" width="1024" height="227" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-9-1024x227.png" alt="" class="wp-image-30492" style="width:922px;height:auto"><figcaption class="wp-element-caption"><em>Figure 9 – Outlook OLK.exe File Path</em>&nbsp;</figcaption></figure>



<figure class="wp-block-image aligncenter size-full is-resized"><img decoding="async" width="905" height="698" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-10.png" alt="" class="wp-image-30493" style="width:565px;height:auto"><figcaption class="wp-element-caption"><em>Figure 10 – Admins not able to view the contents of the folder</em>&nbsp;</figcaption></figure>



<p>As these applications do not have any third-party or external addons that reside in user-controlled areas (i.e. Appdata), it’s not possible to do any DLL hijacking attacks in the traditional sense. Even with elevated permissions, it’s not possible to access or write to these folders. This reduces the likelihood of exploiting these applications using traditional methods. However, if we monitor these applications starting up using <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/procmon" target="_blank" rel="noopener noreferrer">Process Monitor</a>, we can see that that these applications load several system DLLs using COM.&nbsp;&nbsp;</p>



<p>COM objects (Component Object Model objects) are a key part of Microsoft’s framework for enabling software components to communicate with each other, regardless of the language they are written in. COM objects support features such as interprocess communication, versioning, and dynamic object creation, which are essential for building complex distributed systems and applications in the Windows operating environment. In this case, these queries for COM are being used to find the path to certain system DLLs, to then load. What makes these requests interesting is that they first check the Current User (HKCU) section of the registry; however, they are unable to find the proper registry values and then fall over to another section of the registry where the entries exist.&nbsp;</p>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="174" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-11-1024x174.png" alt="" class="wp-image-30494"><figcaption class="wp-element-caption"><em>Figure 11 – Tracking RegOpenKey Operations of OLK.exe</em>&nbsp;</figcaption></figure>



<figure class="wp-block-image aligncenter size-full is-resized"><img decoding="async" width="957" height="162" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-12.png" alt="" class="wp-image-30495" style="width:877px;height:auto"><figcaption class="wp-element-caption"><em>Figure 12 – Registry Key Containing DLL Information</em>&nbsp;</figcaption></figure>



<p>The HKEY_CURRENT_USER (HKCU) registry hive in Windows is a crucial component that stores configuration settings and preferences specific to the currently logged-in user. It includes information such as user-specific software settings, user interface configurations, and network connections, enabling a personalized experience for each user on a system. By isolating these settings from the broader system-wide configurations found in HKEY_LOCAL_MACHINE (HKLM), HKCU ensures that changes made by one user do not affect others. This means the current running user can read and write registry keys, even as a low-privilege user. Because of this, by adding a registry key containing the COM ID of the DLL the process is looking for in the HKCU\SOFTWARE\Classes\CLSID\, it is possible to have this process load a DLL from outside this WindowsApps or System32 folders.&nbsp;</p>



<figure class="wp-block-image aligncenter size-medium is-resized"><img decoding="async" width="500" height="442" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-13-500x442.png" alt="" class="wp-image-30496" style="width:455px;height:auto"><figcaption class="wp-element-caption"><em>Figure 13 – Permissions of the CLSID Folder – Allowing Low Priv Users Access</em>&nbsp;</figcaption></figure>



<p>As a result, any time the application runs, the process would pragmatically load our DLL instead of the system’s version found in “C:\Windows\System32\”. While this is one example, numerous applications and DLLs are susceptible to this because applications are looking in the HKCU section of the registry first.&nbsp;&nbsp;</p>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="244" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-14-1024x244.png" alt="" class="wp-image-30497"><figcaption class="wp-element-caption"><em>Figure 14 – OLK.exe Successfully Querying the HKCU COM Object</em>&nbsp;</figcaption></figure>



<p>As you can see from the image below, this works, and we are able to force the new version of Outlook to load our DLL. While we only have disclosed these new applications stored in the locked down WindowsApp folder, this issue is actually more widespread, affecting numerous other applications.&nbsp;</p>



<figure class="wp-block-image aligncenter size-full is-resized"><img decoding="async" width="935" height="360" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-15.png" alt="" class="wp-image-30498" style="width:709px;height:auto"><figcaption class="wp-element-caption"><em>Figure 15 – Loading Our DLL, Popping A Message Window</em>&nbsp;</figcaption></figure>



<p>To cast a wide net, we can use <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/procmon" target="_blank" rel="noopener noreferrer">Process Monitor</a> again, filtering to only look for any RegOpenKey Operations that start with “HKCU” and the result is “Name Not Found”. By monitoring for this, we can see what other applications that look for COM objects in HKCU that we can hijack. Over the course of a couple of hours of monitoring, it was discovered numerous applications that are native to the Windows system rely on querying these COM objects to load DLLs.&nbsp;&nbsp;</p>



<figure class="wp-block-image aligncenter size-full is-resized"><img decoding="async" width="1313" height="364" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-16.png" alt="" class="wp-image-30499" style="width:905px;height:auto"><figcaption class="wp-element-caption"><em>Figure 16 – Process Monitor Showing Other Process Doing the Same Behaviour&nbsp;</em>&nbsp;</figcaption></figure>



<p>With this extensive list of COM object UUIDs and the steps above, we can create numerous different POC DLLs that map to different DLL’s. By deploying these DLLs and registry keys in the HKCU\SOFTWARE\Classes\CLSID\ section of the registry of an endpoint with numerous applications typically found in a business, we can observe which other applications load these DLLs. The result was an even larger number of both native Windows and other applications. We can see this by monitoring for any Load Image operations from the folder containing our POC DLLs.&nbsp;</p>



<figure class="wp-block-image aligncenter size-full is-resized"><img decoding="async" width="900" height="542" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-17.png" alt="" class="wp-image-30500" style="width:636px;height:auto"><figcaption class="wp-element-caption"><em>Figure 17 – Process Loading Our POC DLL</em>&nbsp;</figcaption></figure>



<h4 class="wp-block-heading">Putting This Into Action&nbsp;</h4>



<p>Now the process of compiling and setting up these DLLs can be a bit arduous, so I have created a tool called FaceDancer to help automate this process. In the example below, I am going to choose to only target the process msedge. Using any DLL payload (in this case, I am using the vanilla DLL Cobalt Strike generates – with no evasion) of my choice, I can feed it into this tool, and it will generate me the following:&nbsp;</p>



<ul class="wp-block-list">
<li>The registry key settings I need to update.&nbsp;</li>
</ul>



<ul class="wp-block-list">
<li>A DLL that will proxy the execution of a DLL msedge loads using COM.&nbsp;</li>
</ul>



<figure class="wp-block-image aligncenter size-large is-resized"><img decoding="async" width="1024" height="513" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-18-1024x513.png" alt="" class="wp-image-30501" style="width:626px;height:auto"><figcaption class="wp-element-caption"><em>Figure 18 – FaceDancer Generating the DLL</em>&nbsp;</figcaption></figure>



<p>Once the registry keys are set, it is just a matter of time before a new instance msedge.exe is executed:&nbsp;</p>



<figure class="wp-block-image aligncenter size-full is-resized"><img decoding="async" width="918" height="205" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-19.png" alt="" class="wp-image-30502" style="width:790px;height:auto"><figcaption class="wp-element-caption"><em>Figure 19 – Msedge Loading our DLL</em>&nbsp;</figcaption></figure>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="245" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/Figure-20-1024x245.png" alt="" class="wp-image-30503"><figcaption class="wp-element-caption"><em>Figure 20 – Our DLL Calling Home Using Cobalt Strike</em>&nbsp;</figcaption></figure>



<h4 class="wp-block-heading">Microsoft’s Second Response&nbsp;</h4>



<p>We reached out to Microsoft again, stressing the importance of these issues. Microsoft responded with the following:&nbsp;</p>



<p><em>“Upon review this does not meet any of the categories of DLL planting issue that the MSRC services. For an attacker to leverage this to get code execution on a machine, they would have to already have code execution on the machine”</em>&nbsp;</p>



<p>What does this mean? Microsoft doesn’t recognize that these issues meet the requirements for what they consider DLL hijacking. Microsoft has its own terminology called DLL planting, which covers planting/hijacking/preloading DLL attacks. They primarily consider it a DLL planting if:&nbsp;</p>



<ul class="wp-block-list">
<li>An application searches for and loads a DLL from an unsafe location.&nbsp;</li>
</ul>



<ul class="wp-block-list">
<li>The DLL is not located in the directory where the application expects it, causing Windows to search other directories.&nbsp;</li>
</ul>



<ul class="wp-block-list">
<li>An attacker can place a malicious DLL in a directory that is searched before the legitimate one.&nbsp;</li>
</ul>



<p>As of right now, Microsoft will not be remediating or taking steps to mitigate this issue. What does this mean for businesses? Unfortunately, these vulnerabilities will remain as a forever-day until Microsoft changes its mind on recognizing these vulnerabilities as something worth fixing.&nbsp;As these processes are native to Windows and other applications such as Outlook and Teams, which are a critical part of day-to-day business, it makes it impossible for defenders to block these applications.&nbsp;Because of all of this, the only defensive measures that can be deployed are detection based.&nbsp;&nbsp;</p>



<h3 class="wp-block-heading"><strong>Disclosure Timeline&nbsp;</strong></h3>



<p>April 17<sup>th</sup> – Disclosed the first discovery to Microsoft.&nbsp;</p>



<p>April 25<sup>th</sup> – Received the following response from Microsoft, stating it’s a valid zero-day but will not fix it.&nbsp;&nbsp;</p>



<p>April 26<sup>th</sup> – Requested a review of their stance and provided more information.&nbsp;</p>



<p>April 26<sup>th</sup> – Received a message that no further action would be taken, and no CVE recognition would occur.&nbsp;&nbsp;</p>



<p>July 24<sup>th</sup> – Disclosed the second discovery to Microsoft.&nbsp;</p>



<p>August 1<sup>st</sup> – Case closed.&nbsp;</p>



<p><strong>More information about FaceDancer can be found here: </strong><a href="https://github.com/Tylous/FaceDancer" target="_blank" rel="noopener noreferrer">https://github.com/Tylous/FaceDancer</a>&nbsp;</p>



<hr class="wp-block-separator has-text-color has-alpha-channel-opacity has-background is-style-default" style="background-color:#6f7070;color:#6f7070">



<hr class="wp-block-separator has-text-color has-alpha-channel-opacity has-background is-style-default" style="background-color:#2a2a74;color:#2a2a74">



<p class="has-text-align-center">Loved this blog? </p>



<p class="has-text-align-center">Join us for a free one-hour Black Hills Information Security (BHIS) webcast with the author, Matt Eidelberg, as he share his latest research into new techniques which allow Windows users to side-load into native Windows processes.</p>



<p class="has-text-align-center">Learn more and register below:</p>



<p class="has-text-align-center has-large-font-size"><strong><a href="https://events.zoom.us/ev/AuipZvhPLYjSMQOcscrBgbSfFpDh_U_sXfmVRuU41J_-kGH0pllF~AspjWMYDM0RxeUeVdoLsMPa4AsEbuyAspq_bfcvDYauElPfNkroY9yAf-A?lmt=1726506953000">DLL Hijacking – A New Spin on Proxying Your Shellcode </a></strong></p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="1920" height="1080" src="https://www.blackhillsinfosec.com/wp-content/uploads/2024/09/DLL-Hijacking-A-New-Spin-on-Proxying-your-Shellcode-Matthew-Eidelbe-PROMO.png" alt="" class="wp-image-30547"></figure>



<hr class="wp-block-separator has-text-color has-alpha-channel-opacity has-background is-style-default" style="background-color:#2a2a74;color:#2a2a74">



<hr class="wp-block-separator has-text-color has-alpha-channel-opacity has-background is-style-default" style="background-color:#6f7070;color:#6f7070">


<!-- wp:themify-builder/canvas /-->
            
        </div><!-- /.entry-content -->
        

	</div>
	<!-- /.post-content -->
	
</article>
<!-- /.post -->

		<div class="post-nav tf_clearfix">
			<span class="prev"><a href="https://www.blackhillsinfosec.com/how-logging-strategies-can-affect-cyber-investigations/" rel="prev"><span class="arrow"></span> How Logging Strategies Can Affect Cyber Investigations w/ Kiersten &amp; James&nbsp;</a></span><span class="next"><a href="https://www.blackhillsinfosec.com/satellite-hacking/" rel="next"><span class="arrow"></span> Satellite Hacking</a></span>		</div>
		<!-- /.post-nav -->

	                
                    </main>
	</div>
<!-- /#layout -->

	    </div>
	<!-- /body -->

	<div id="footerwrap">

		<div id="footer-inner">

						
			<!-- /#footer -->
			
		</div>
		<!-- /.footer-inner -->

	</div>
	<!-- /#footerwrap -->

</div>
<!-- /#pagewrap -->

<!-- wp_footer -->

<div class="simple-banner simple-banner-text" style="display:none !important"></div>
<div class="wp-dark-mode-floating-switch wp-dark-mode-ignore wp-dark-mode-animation wp-dark-mode-animation-bounce " style="right: 10px; bottom: 10px;">
	<!-- call to action  -->
	
	<div class="wp-dark-mode-switch wp-dark-mode-ignore " tabindex="0" data-style="1" data-size="1" data-text-light="" data-text-dark="" data-icon-light="" data-icon-dark=""><div class="wp-dark-mode-switch-styled wp-dark-mode-switch-1" style="--wpdm-switch-scale: 1"><div class="_track wp-dark-mode-ignore"><div class="_icon wp-dark-mode-ignore"><svg viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg" class="wp-dark-mode-ignore"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.8956 0.505198C11.2091 0.818744 11.3023 1.29057 11.1316 1.69979C10.4835 3.25296 10.125 4.95832 10.125 6.75018C10.125 13.9989 16.0013 19.8752 23.25 19.8752C25.0419 19.8752 26.7472 19.5167 28.3004 18.8686C28.7096 18.6979 29.1814 18.7911 29.495 19.1046C29.8085 19.4182 29.9017 19.89 29.731 20.2992C27.4235 25.8291 21.9642 29.7189 15.5938 29.7189C7.13689 29.7189 0.28125 22.8633 0.28125 14.4064C0.28125 8.036 4.17113 2.57666 9.70097 0.269199C10.1102 0.098441 10.582 0.191653 10.8956 0.505198Z" fill="currentColor"></path></svg></div><div class="_icon wp-dark-mode-ignore"><svg viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg" class="wp-dark-mode-ignore"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.8956 0.505198C11.2091 0.818744 11.3023 1.29057 11.1316 1.69979C10.4835 3.25296 10.125 4.95832 10.125 6.75018C10.125 13.9989 16.0013 19.8752 23.25 19.8752C25.0419 19.8752 26.7472 19.5167 28.3004 18.8686C28.7096 18.6979 29.1814 18.7911 29.495 19.1046C29.8085 19.4182 29.9017 19.89 29.731 20.2992C27.4235 25.8291 21.9642 29.7189 15.5938 29.7189C7.13689 29.7189 0.28125 22.8633 0.28125 14.4064C0.28125 8.036 4.17113 2.57666 9.70097 0.269199C10.1102 0.098441 10.582 0.191653 10.8956 0.505198Z" fill="currentColor"></path></svg></div></div></div></div></div>		
		            <!--googleoff:all-->
            <!--noindex-->
            <!--noptimize-->
            
            <!--/noptimize-->
            <!--/noindex-->
            <!--googleon:all-->
            



<!-- SCHEMA BEGIN --><!-- /SCHEMA END -->



<div class="body-overlay"></div></body></html>