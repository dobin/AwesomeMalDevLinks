Title:
Depths of Windows APC (Kernel-mode internals and user-mode APC delivery)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post is a deep dive into Windows Asynchronous Procedure Calls (APCs), focusing on kernel-mode internals and how user-mode APCs are delivered from the kernel.  
- It explains core APC data structures (KAPC, KAPC_STATE, KTHREAD) and subtle behaviors such as APC environments when threads are attached to other processes (KeStackAttachProcess / KeUnstackDetachProcess).  
- The author highlights practical kernel-development pitfalls: kernel APC objects must live in NonPagedPool, APCs can be blocked via IRQL/critical regions, and RundownRoutine/driver-unload interactions can cause BSODs if not handled carefully.  
- It details how user-mode APCs are triggered on syscall return via KiDeliverApc/KiInitializeUserApc and ntdll!KiUserApcDispatcher, including “special user APCs” (NtQueueApcThreadEx behavior changes).  
- Several injection-related edge cases are covered, including early-process APC DLL injection hazards (kernel32 not initialized) and a PsSetLoadImageNotifyRoutine timing gotcha where the image is mapped but not yet initialized.  
- It compares QueueUserAPC vs Zw/NtQueueApcThread and documents an activation-context-related crash/corruption risk when QueueUserAPC targets remote processes, plus WOW64-specific techniques for queuing 64-bit APCs into 32-bit processes.  
- Useful for kernel driver developers, red teamers building injection primitives, and defenders wanting to understand APC-based execution and its failure modes.

Technical Focus:
- Windows kernel APC internals (KAPC/KAPC_STATE/KTHREAD, KiInsertQueueApc, KiDeliverApc)
- Thread attach/detach APC environments (Original/Attached/CurrentApcEnvironment)
- Kernel APC safety: NonPagedPool requirement, IRQL/APC_LEVEL, critical/guarded regions
- User-mode APC delivery path (KTRAP_FRAME manipulation, KiUserApcDispatcher, NtTestAlert/NtContinue)
- APC-based injection pitfalls (early kernel32 load, PsSetLoadImageNotifyRoutine timing)
- Native/WOW64 APC queuing (ZwQueueApcThread, RtlQueueApcWow64Thread, PsWrapApcWow64Thread) and CFG export suppression handling

Use Cases:
- Implementing reliable kernel-mode APC scheduling in drivers without BSODs
- Building/assessing APC-based DLL injection and early-load execution strategies
- Forcing user-mode APC delivery via NtTestAlert / alertable waits
- Cross-bitness (WOW64) remote module enumeration using APC + shared sections
- Debugging crashes caused by APC timing, activation contexts, or driver unload races
- Defensive analysis of APC-based execution chains and their prerequisites

Keywords:
Windows APC, KAPC, KAPC_STATE, KTHREAD, KeInitializeApc, KeInsertQueueApc, KeStackAttachProcess, KeUnstackDetachProcess, KiDeliverApc, KiInitializeUserApc, KiUserApcDispatcher, KTRAP_FRAME, NtQueueApcThread, ZwQueueApcThread, QueueUserAPC, NtTestAlert, NtContinue, PsSetLoadImageNotifyRoutine, ZwMapViewOfSection, NonPagedPool, IRQL, APC_LEVEL, RundownRoutine, ObfReferenceObject, driver unload, WOW64, RtlQueueApcWow64Thread, PsWrapApcWow64Thread, LdrLoadDll, LdrQueryProcessModuleInformation, Control Flow Guard, Export Suppression, SetProcessValidCallTargets