Title:
Memory Hiding Technique Series: Ekko – The basics

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post introduces the “Ekko” memory-hiding technique (based on MDSec NightHawk reversing) and explains the core primitive it relies on: driving execution via crafted CPU contexts and `NtContinue`.  
- It frames “context oriented programming” as using a `CONTEXT` structure to set `RIP` (control flow) and argument registers (`RCX/RDX/R8/R9`) to invoke APIs without a normal call chain.  
- The article walks through a minimal example that calls `MessageBox` by capturing a thread context with `RtlCaptureContext`, cloning/modifying it, and resuming execution through `NtContinue`.  
- It highlights a key x64 detail: adjusting `Rsp` (e.g., `Rsp -= 8`) to avoid stack corruption due to how `RtlCaptureContext` records `RSP` (with an offset) and how callees expect stack space/alignment.  
- Ekko’s broader flow is summarized: synchronization timer, APC-driven `NtContinue` context switches, `VirtualProtect` to change page permissions, `SysFunc032` for encrypt/decrypt of in-memory regions, sleeping, and `WaitForSingleObject` for exit coordination.  
- Useful for red teamers, malware developers, and defenders studying in-memory evasion patterns and unusual control-flow mechanisms that can bypass simplistic user-mode hooks/call-stack heuristics.

Technical Focus:
- Windows `CONTEXT` structure manipulation (x64 registers, calling convention)
- `NtContinue`-based control-flow redirection / context switching
- APC (Asynchronous Procedure Call) usage for staged execution
- Memory protection changes via `VirtualProtect`
- In-memory encryption/decryption via `SysFunc032` (SystemFunction032)
- Stack correctness/alignment pitfalls when resuming via crafted contexts

Use Cases:
- Implementing in-memory payload “sleep/encrypt/decrypt” to reduce scan exposure
- Building call-stack/CFG-evasive API invocation chains using `NtContinue`
- Researching/detecting anomalous `NtContinue` + APC patterns in user mode
- Debugging and validating context-based execution (RSP adjustments, crashes)

Keywords:
Ekko, memory hiding, NtContinue, CONTEXT, RtlCaptureContext, APC, Asynchronous Procedure Call, VirtualProtect, SysFunc032, SystemFunction032, ntdll.dll, x64 calling convention, RIP, RSP, RCX, RDX, R8, R9, MDSec NightHawk, in-memory encryption, context switching