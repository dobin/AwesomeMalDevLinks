Title:
Red Teaming in the age of EDR: Evasion of Endpoint Detection Through Malware Virtualisation

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes Fox-IT’s evolution of an evasive payload delivery framework that aims to survive modern EDR static and behavioral detection.  
- It argues polymorphic packers alone are increasingly detectable once decrypted code becomes executable, so it introduces a custom virtualization layer (VM + encrypted bytecode) to hide real instructions from both static and dynamic inspection.  
- The authors detail a position-independent VM design, a fixed-length instruction/operand format, in-place instruction encryption, and a transpiler pipeline that converts compiled x86-64 binaries into custom bytecode using iced-x86.  
- To interface with Windows, the VM implements a calling bridge for native APIs (x64 calling convention, argument counting) and supports callbacks by tagging function pointers.  
- For behavioral evasion, it adds “multi-VM execution” (vmcalls like vminit/vmexec) to interleave benign event-generating bytecode with malicious logic on the same thread, attempting to disrupt event-based heuristics (ETW/callback-driven telemetry).  
- It also discusses protecting the native VM itself via a polymorphic engine (instruction substitution, block reordering/insertion, NOPs) to reduce static signatures.  
- Useful primarily for red teams and malware/tooling developers; also valuable for blue teams to understand how virtualization-based obfuscation and event-noise strategies can undermine common EDR detection assumptions.

Technical Focus:
- Custom bytecode VM / virtualization-based obfuscation (x86-64 subset)
- Position-independent code (PIC) payload layout and shellcode-style embedding (EXE/DLL)
- In-place instruction encryption/decryption per dispatch cycle
- Transpiling x86-64 binaries to custom bytecode (iced-x86 disassembly)
- Windows x64 calling convention bridging for native API invocation; callback tagging
- Behavioral evasion via multi-VM interleaving to manipulate ETW/callback-derived signals

Use Cases:
- Building EDR-resistant loaders/stagers that avoid exposing decrypted native payloads
- Porting existing PIC tooling/BOFs into a virtualized execution environment
- Creating modular implants that fetch and execute bytecode instead of shellcode
- Obfuscating offensive tooling with polymorphic mutation + VM-based execution
- Defensive research: developing detections for VM dispatch loops, bytecode decrypt/re-encrypt patterns, and anomalous API-bridge behavior

Keywords:
EDR evasion, malware virtualization, custom VM, bytecode, opcode dispatch loop, in-place encryption, polymorphic engine, metamorphic code, packer, heuristics, ETW, PsSetCreateProcessNotifyRoutine, PsSetLoadImageNotifyRoutine, Windows x64 calling convention, __stdcall, shadow space, position-independent code, iced-x86, transpiler, API hooking