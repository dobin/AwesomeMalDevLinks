Title:
Gargoyle: a memory scanning evasion technique (hiding executable code in non-executable memory)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains “gargoyle,” a Windows technique that keeps a program’s entire code region in non-executable (RW) memory and only flips it to executable briefly to run, then reverts it back.  
- It targets a common performance optimization in live memory scanners/AV/EDR that prioritize scanning executable pages, demonstrating how that assumption can be bypassed.  
- The implementation uses Windows APC delivery via a waitable timer to periodically trigger execution, combined with a ROP gadget to pivot the stack into a crafted “stack trampoline.”  
- The trampoline invokes `VirtualProtectEx` to change page protections (RW ↔ RX) and then tail-calls into the payload, looping via `WaitForSingleObjectEx` in an alertable state.  
- The proof-of-concept is for 32-bit Windows and relies on locating a suitable gadget (example given in `mshtml.dll`) and carefully controlling callback arguments/stack layout.  
- Useful for red teamers, exploit developers, and malware researchers studying memory-scanning evasion and APC/ROP-based execution orchestration.

Technical Focus:
- Windows Asynchronous Procedure Calls (APC) and alertable waits
- Waitable timers (`CreateWaitableTimer`, `SetWaitableTimer`) as an execution trigger
- ROP gadget selection and stack pivoting (`pop esp; ret`)
- Stack trampoline construction to call `VirtualProtectEx`
- DEP/NX bypass mechanics via page protection flipping
- 32-bit Windows calling conventions and callback constraints (`__stdcall`/WINAPI)

Use Cases:
- Building PoCs to evaluate EDR/AV live-memory scanning assumptions (scan RX-only vs full memory)
- Periodic “execute-then-hide” payload staging for in-memory tooling
- Researching APC-based execution flows and constrained-context ROP
- Developing detections for suspicious `VirtualProtect*` transitions tied to APC/timer callbacks

Keywords:
gargoyle, memory scanning evasion, live memory analysis, Windows APC, APC queue, alertable state, CreateWaitableTimer, SetWaitableTimer, WaitForSingleObjectEx, VirtualProtectEx, DEP, NX, ROP, stack pivot, stack trampoline, mshtml.dll gadget, PAGE_READWRITE, PAGE_EXECUTE_READ, 32-bit Windows, calling conventions