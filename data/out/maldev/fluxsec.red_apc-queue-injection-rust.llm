Title:
EDR Evasion: APC Queue Injection in Rust

Type:
Blog Post (with GitHub PoC tool)

Short Summary (4–8 sentences max):
- This write-up demonstrates Windows APC (Asynchronous Procedure Call) queue injection implemented in Rust to execute shellcode inside a remote process without creating a new remote thread.  
- The goal is to reduce common EDR detections associated with classic injection patterns like `CreateRemoteThread`, while still using suspicious primitives such as remote memory allocation and `WriteProcessMemory`.  
- It explains the requirement for a target thread to enter an “alertable” state (e.g., via `SleepEx`, `WaitForSingleObjectEx`, etc.) for queued user-mode APCs to execute, and notes this as a practical limitation when choosing target processes.  
- The PoC allocates RWX memory in the target process, writes shellcode (example opens calc.exe), enumerates target threads via Toolhelp APIs, and queues the shellcode pointer to each thread using `QueueUserAPC`.  
- It highlights operational issues like multiple thread hits causing repeated payload execution and suggests adding a mutex in shellcode to enforce single execution.  
- Useful for red teamers/pentesters learning Windows injection tradecraft and defenders studying behavioral detection opportunities around APC queuing and remote memory operations.

Technical Focus:
- User-mode APC mechanics and “alertable” thread states
- Remote process memory allocation and shellcode staging (`VirtualAllocEx`, `WriteProcessMemory`)
- Thread enumeration via Toolhelp snapshot APIs (`CreateToolhelp32Snapshot`, `Thread32First/Next`)
- APC queuing with `QueueUserAPC` and function pointer casting (`PAPCFUNC`)
- Rust + windows-rs FFI for Win32 API interaction

Use Cases:
- Implementing alternative process injection that avoids `CreateRemoteThread`
- Testing EDR detections for APC queuing + remote memory write patterns
- Building/learning Rust-based Windows offensive tooling
- Evaluating which processes/threads are likely to become alertable for reliable execution
- Demonstrating tradeoffs/limitations of “classic” evasion techniques in modern environments

Keywords:
APC injection, QueueUserAPC, Asynchronous Procedure Call, alertable state, SleepEx, WaitForSingleObjectEx, VirtualAllocEx, WriteProcessMemory, OpenProcess, OpenThread, Toolhelp32Snapshot, THREADENTRY32, process injection, shellcode, RWX memory, windows-rs, Rust FFI, EDR evasion, thread enumeration, mutex (single-instance)