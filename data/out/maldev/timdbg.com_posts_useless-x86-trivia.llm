Title:
Useless x86 encoding trivia

Type:
Blog Post

Short Summary (4–8 sentences max):
- A collection of low-level x86/x64 “gotchas” learned while implementing an x86/amd64 CPU emulator for Microsoft Time Travel Debugging (TTD).  
- It highlights how the same instruction can have multiple encodings (e.g., `int3` as `CC` vs `CD 03`), and how prefixes (REX, address-size override) can be redundant, stacked, or change decoding in surprising ways.  
- The post covers architectural limits like the 15-byte maximum instruction length and shows how disassembly can differ depending on mode/segment defaults, including the x64 repurposing of `40–4F` from `INC/DEC reg` to REX prefixes.  
- It documents correctness pitfalls for emulation and reverse engineering, such as flag-update quirks (`INC` vs `ADD`, `CMPXCHG` vs `CMPXCHG8B/16B`) and shift-count masking (e.g., shifting by 32 on 32-bit operands can be a no-op).  
- It also explains practical segment-override behavior on Windows (FS/GS for TEB access), and how 32-bit vs 64-bit mode differ in how FS/GS bases are defined (GDT/LDT vs MSRs), including mention of `rdfsbase/rdgsbase`.  
- Useful primarily for emulator authors, reverse engineers, exploit developers, and debugger/tooling engineers who need accurate decoding and CPU-state modeling.

Technical Focus:
- x86/x64 instruction encoding variants and prefix semantics (REX, 0x67 address override)
- 15-byte instruction length limit and disassembler edge cases
- Mode-dependent decoding differences (32-bit vs 64-bit operand/address defaults)
- EFLAGS update quirks across arithmetic/atomic/shift instructions
- Shift/rotate count masking rules (1Fh/3Fh)
- Segment overrides and Windows TEB access via FS/GS; FS/GS base via GDT/LDT vs MSRs and FSGSBASE instructions

Use Cases:
- Implementing or validating an x86/x64 CPU emulator (correct decoding + flag behavior)
- Writing robust disassemblers/assemblers and avoiding prefix/REX misinterpretation
- Debugging tricky instruction streams (breakpoints, odd prefixes, mode confusion)
- Reverse engineering Windows internals patterns (TEB access via `fs:[...]` / `gs:[...]`)
- Crafting/recognizing obfuscated instruction encodings that confuse tooling

Keywords:
x86, amd64, instruction encoding, prefixes, REX, address-size override, 0x67, int3, CC opcode, 15-byte instruction limit, disassembly, WinDbg, INC/DEC vs ADD, EFLAGS, carry flag, overflow flag, shift count masking, 1Fh, 3Fh, segment override, FS, GS, TEB, WOW64, MSR, IA32_FS_BASE, IA32_GS_BASE, rdfsbase, rdgsbase, Time Travel Debugging, CPU emulation