Title:
Hyperspace – Hidden Address Spaces

Type:
Blog Post

Short Summary (4–8 sentences max):
This post describes a Windows kernel technique (“Hyperspace”) for creating and executing a thread inside a hidden, custom virtual address space by manipulating CR3 indirectly through scheduler-controlled process state. It explains how Windows stores the active page table base (CR3/DirectoryTableBase) in KPROCESS and how KiSwapContext loads CR3 during thread scheduling using KTHREAD->ApcState.Process. The core method clones an existing KPROCESS, replaces its DirectoryTableBase with a newly allocated PML4, and DKOM-swaps the running thread’s ApcState.Process to the fake KPROCESS so the next context switch runs the thread in the new address space. To keep the custom PML4 from being reclaimed by the memory manager (MiStealPage), it allocates contiguous memory, copies the PML4, frees it, then removes the physical range from the system via MmRemovePhysicalMemory. The article includes a demo showing CR3 changing after rescheduling and discusses limitations (thread/process creation/termination instability) and potential detection ideas (IPI/NMI/trap-based checks of CR3 vs current KPROCESS/RIP). It’s mainly useful for kernel exploit developers, red team operators with kernel primitives, and defenders studying abnormal address-space behavior.

Technical Focus:
- Windows x64 paging (CR3, PML4, PFN/dirbase)
- Scheduler context switching (KiSwapContext, KTHREAD/KTRAP_FRAME, APC state)
- DKOM (KTHREAD->ApcState.Process and KPROCESS cloning)
- Physical memory management (MmAllocateContiguousMemory, MmRemovePhysicalMemory, MiStealPage)
- Hidden/alternate address spaces and CR3 switching behavior
- Detection considerations using IPIs/NMIs and state consistency checks

Use Cases:
- Building stealthy kernel payload execution contexts using alternate page tables
- Researching CR3-based evasion and “hidden” memory mappings against EDR/forensics
- Prototyping custom address-space isolation for offensive kernel tooling
- Developing detections for anomalous CR3/KPROCESS mismatches during interrupts/context switches

Keywords:
Windows kernel, x64 paging, CR3, DirectoryTableBase, PML4, PFN, KPROCESS, EPROCESS, KTHREAD, KAPC_STATE, KTRAP_FRAME, KiSwapContext, DKOM, context switch, MmAllocateContiguousMemory, MmRemovePhysicalMemory, MiStealPage, IPI, NMI, VDM, PTM