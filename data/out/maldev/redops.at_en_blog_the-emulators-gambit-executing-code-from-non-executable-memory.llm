Title:
The Emulator’s Gambit: Executing Code from Non-Executable Memory

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explores executing “shellcode” stored in a non-executable PE section (e.g., `.data` mapped as `PAGE_READWRITE`) without calling `VirtualProtect`/`NtProtectVirtualMemory` to flip permissions to RX.  
- It demonstrates the baseline (RW→RX then execute) and the expected failure case (DEP/NX triggers `0xC0000005` on instruction fetch from RW memory).  
- The core technique combines hardware execution breakpoints (DR0/DR7), a Vectored Exception Handler (VEH), and per-instruction software emulation to avoid ever performing an instruction fetch from the NX page.  
- Because HWBPs trigger `EXCEPTION_SINGLE_STEP (0x80000004)` before the MMU’s NX check, the handler can read opcode bytes as data, emulate their effects by editing the thread `CONTEXT` (RIP/RSP/etc.), and “chain” the breakpoint to the next RIP.  
- The PoC emulates a minimal sequence (NOPs + RET) to show the concept; scaling requires a real x86-64 decoder/emulator and incurs heavy exception overhead.  
- Useful for red team/malware research and defenders studying telemetry gaps around memory-permission-change detections and exception/breakpoint-based execution.

Technical Focus:
- Windows DEP/NX and page protections (`PAGE_READWRITE`, `PAGE_EXECUTE_READ`)
- x86-64 debug registers and hardware breakpoints (DR0–DR7, DR6/DR7 semantics)
- Vectored Exception Handling (AddVectoredExceptionHandler, exception dispatch order)
- `EXCEPTION_SINGLE_STEP`-driven control flow and `CONTEXT` manipulation
- Instruction decoding/emulation (RIP/RSP updates; NOP/RET example)
- Breakpoint “chaining” to step through non-executable regions

Use Cases:
- Execute/decrypt payload bytes in-place in RW memory without calling memory-protection APIs
- Research alternative execution primitives that avoid RW→RX/RWX transitions
- Build detection ideas around abnormal HWBP usage and high-rate single-step exceptions
- Educational debugging/internals lab for Windows exception handling and CPU debug features

Keywords:
Windows, DEP, NX bit, MMU, PE sections, .data section, PAGE_READWRITE, VirtualProtect, NtProtectVirtualMemory, hardware breakpoints, debug registers, DR0, DR6, DR7, EXCEPTION_SINGLE_STEP, Vectored Exception Handling, AddVectoredExceptionHandler, CONTEXT, instruction emulation, x64dbg