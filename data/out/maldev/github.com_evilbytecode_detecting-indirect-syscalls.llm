Title:
Detecting-Indirect-Syscalls (Indirect Syscall Detector)

Type:
GitHub Tool

Short Summary (4–8 sentences max):
This repository provides a Windows x64 user-mode detector for “indirect syscalls” used to bypass EDR hooks in ntdll by jumping directly to the `syscall` instruction. It sets hardware execution breakpoints (DR0–DR3) on selected `syscall` instructions inside ntdll and uses a Vectored Exception Handler (VEH) to intercept `EXCEPTION_SINGLE_STEP` when those instructions execute. On each hit, it inspects the return address on the stack (RSP) and checks whether it falls within a whitelist of trusted module address ranges (e.g., ntdll, optionally other system DLLs). If the return address points to untrusted memory (heap/stack/allocated regions), it flags the event as likely indirect-syscall activity. The tool instruments all threads by enumerating them and updating their debug registers via `NtGetContextThread`/`NtSetContextThread`, with a follow-up scan to catch new threads. It’s primarily useful for Blue Teams/EDR engineers and defenders researching detection of Hell’s Gate/SysWhispers-style syscall evasion, and for Red Teams to understand detection constraints and bypass conditions (e.g., executing within trusted module ranges/ROP).

Technical Focus:
- Indirect syscall evasion (Hell’s Gate / SysWhispers patterns)
- x64 hardware breakpoints via debug registers (DR0–DR3, DR7)
- Vectored Exception Handling (VEH) and single-step exception flow
- Return-address validation / call-site provenance checking
- Thread enumeration and per-thread context modification (Nt* thread APIs)
- Trusted module range construction via PE export parsing

Use Cases:
- Detecting user-mode indirect syscall execution in a protected process
- Building PoC telemetry for syscall-evasion research and validation
- Evaluating EDR detection ideas based on call-site/return-address provenance
- Red team testing of indirect-syscall tradecraft against breakpoint/VEH-based detectors
- Extending trusted-module policies and measuring false positives/negatives

Keywords:
indirect syscalls, ntdll.dll, syscall instruction, Hell’s Gate, SysWhispers, hardware breakpoints, DR0, DR1, DR2, DR3, DR7, Vectored Exception Handler, VEH, EXCEPTION_SINGLE_STEP, trap flag, EFLAGS.TF, return address validation, RSP, NtGetContextThread, NtSetContextThread, CreateToolhelp32Snapshot, NtOpenThread, NtSuspendThread, PE exports, trusted module ranges, Windows x64