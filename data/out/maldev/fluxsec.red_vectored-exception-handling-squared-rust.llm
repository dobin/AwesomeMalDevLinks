Title:
Vectored Exception Handling Squared (VEH²) in Rust — Patchless AMSI bypass via hardware breakpoints

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post implements CrowdStrike’s “Vectored Exception Handling Squared” (VEH²) technique in Rust and explains the underlying Windows exception mechanics.  
- It targets the problem of “patchless” interception of sensitive routines (e.g., AMSI scanning) without modifying module code (avoiding common tamper detections like code hashing).  
- The core idea is to register a Vectored Exception Handler, trigger an initial exception (e.g., `int3`), and then modify the provided `CONTEXT` to set CPU debug registers (hardware breakpoints) without calling `SetThreadContext`/`NtSetContextThread` (and thus reducing ETW/API-call telemetry).  
- When the hardware breakpoint fires (`EXCEPTION_SINGLE_STEP`), the handler manipulates registers/stack (`RIP`, `RSP`, `RAX`) to spoof a return value and “return” from the target function without executing it.  
- It’s useful for red teamers, malware researchers, and defenders studying detection surface around VEH, debug registers, and AMSI/ETW bypass patterns.  
- It’s interesting because it demonstrates a stealthier breakpoint registration path by leveraging exception-delivered `CONTEXT` mutation rather than explicit thread-context syscalls.

Technical Focus:
- Vectored Exception Handling (AddVectoredExceptionHandler) and exception dispatch flow
- Hardware breakpoints via x86/x64 debug registers (DR0–DR7) and `EXCEPTION_SINGLE_STEP`
- `CONTEXT` structure manipulation (RIP/RSP/RAX + debug register flags)
- Patchless AMSI bypass concept (intercepting `AmsiScanBuffer`-like execution)
- Telemetry/detection implications of `SetThreadContext` → `NtSetContextThread` and ETW audit providers
- Threading caveats (per-thread breakpoints; COM/multithread considerations)

Use Cases:
- Implementing a patchless user-mode interception primitive for sensitive functions (AMSI/ETW-like targets)
- Researching EDR detection gaps around VEH handlers and debug-register usage
- Building PoCs to understand exception-based control-flow manipulation and stealth tradeoffs
- Developing defensive detections for anomalous VEH registration and debug register state changes

Keywords:
VEH, VEH², Vectored Exception Handling, AddVectoredExceptionHandler, EXCEPTION_BREAKPOINT, int3, EXCEPTION_SINGLE_STEP, hardware breakpoint, debug registers, DR0, DR7, DR6, CONTEXT, GetThreadContext, SetThreadContext, NtSetContextThread, ETW, Microsoft-Windows-Kernel-Audit-API-Calls, AMSI, AmsiScanBuffer, Rust, windows-sys, RIP, RSP, RAX