Title:
Running PEs Inline Without a Console

Type:
Blog Post

Short Summary (4–8 sentences max):
- This article documents research into capturing stdout/stderr from PE files executed “inline” (in-memory/in-process, e.g., inside Cobalt Strike Beacon) without calling `AllocConsole` and spawning `conhost.exe`.  
- It explains how different binaries and runtimes (MinGW/MSVCRT vs MSVC/UCRT) interact with console I/O, and how to redirect output by manipulating CRT `FILE` structures and using `_open_osfhandle` to map Win32 handles to file descriptors.  
- For `cmd.exe`, it shows how child process console inheritance is influenced by `PEB->ProcessParameters->ConsoleHandle` and an undocumented `ConsoleConnectionState` used by `BasepCreateProcessParameters`, enabling output capture without a real console.  
- For PowerShell, it details why simple handle spoofing fails (e.g., `CreateFile("CONOUT$")` triggers kernel-side console handle usage) and explores approaches like memory patching, CLR/IAT-style indirection, and ultimately hardware-breakpoint-based interception of `CreateFile` and `NtDeviceIoControlFile`.  
- It also covers operational caveats like PowerShell caching stdout handles across runs and reusing pipes via Cobalt Strike 4.9 key/value storage.  
- Useful for red team operators and tool developers building in-process loaders/BOFs who want to reduce telemetry from console allocation while still collecting command output.

Technical Focus:
- Windows console internals (`conhost.exe`, `AllocConsole`, `SetStdHandle`, `CONOUT$`)
- PEB / `RTL_USER_PROCESS_PARAMETERS` and `ConsoleHandle` behavior
- CRT stdout/stderr redirection (MSVCRT vs UCRT `FILE` layout, `_open_osfhandle`)
- Undocumented `ConsoleConnectionState` and `BasepCreateProcessParameters` influence on child processes
- PowerShell console host behavior and CLR NDirect (P/Invoke) resolution mechanics
- API interception via hardware breakpoints; syscall-level focus (`NtDeviceIoControlFile`, `NtCreateFile`)

Use Cases:
- Capture output from inline-executed tools (e.g., mimikatz, nanodump, custom utilities) without spawning `conhost.exe`
- Improve OPSEC/telemetry reduction for in-process execution frameworks (Beacon/BOF loaders)
- Build more compatible stdout/stderr redirection across different compiler runtimes (MinGW/MSVC, MSVCRT/UCRT)
- Research/detection engineering around console spoofing, PEB tampering, and API interception patterns

Keywords:
Windows console, conhost.exe, AllocConsole, SetStdHandle, PEB, RTL_USER_PROCESS_PARAMETERS, ConsoleHandle, stdout redirection, stderr redirection, MSVCRT, ucrtbase.dll, FILE structure, _open_osfhandle, cmd.exe, CreateProcessW, BasepCreateProcessParameters, ConsoleConnectionState, CONOUT$, PowerShell ConsoleHost, CLR NDirect, GetProcAddressForCaller, NtDeviceIoControlFile, NtCreateFile, CreateFile, hardware breakpoints, WinDbg, Ghidra, Cobalt Strike Beacon, BOF, in-memory execution, Inline-Execute-PE, No-Consolation