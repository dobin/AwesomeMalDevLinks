Title:
Timer Callbacks Spoofing to Improve your SLEAP and SWAPPALA Untold

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post extends the author’s SLEAPING/SWAPPALA “sleep mask” approach that swaps a reflective DLL mapping with a legitimate Microsoft DLL at the same base address during sleep to evade memory scanners.  
- It addresses a concrete detection from Hunt-Sleeping-Beacons (HSB): timer queue callbacks pointing to `kernel32!ResumeThread`, which HSB flags as suspicious.  
- The core technique is “timer callback spoofing”: enumerating `TpWorkerFactory` objects and locating timer structures that store the callback pointer, then temporarily overwriting `FinalizationCallback` to a benign “SafeCallback” while the implant is asleep.  
- Because hiding callbacks would prevent timers from firing, the author uses APC-driven execution (queued `NtContinue` contexts) plus Win32 Events to coordinate two suspended threads: one to hide callbacks and one to restore them after a sleep interval.  
- The post also fixes an additional HSB heuristic (“non-executable page in callstack”) by creating a new thread inside the sacrificial DLL’s address space and exiting the reflective loader thread to clean up the suspicious return address.  
- Useful for red teamers/malware developers building Windows sleep masks and for defenders understanding how threadpool timer telemetry can be tampered with.

Technical Focus:
- Windows Thread Pool internals (Timer Queues, `TpWorkerFactory`, `TP_TIMER` / cleanup group members)
- Timer callback pointer discovery and patching (`FinalizationCallback` overwrite)
- APC-based execution with `NtQueueApcThread` + `NtContinue` context chaining
- Event-based thread synchronization (`SetEvent`, `NtWaitForSingleObject`)
- Reflective DLL loading, mapping swap/unmap (`MapViewOfFileEx`, `UnmapViewOfFile`)
- Evasion of Hunt-Sleeping-Beacons heuristics (timer callback + callstack anomalies)

Use Cases:
- Implementing stealthier sleep masks that reduce timer-callback IOCs
- Researching/replicating HSB detections and developing counter-evasion PoCs
- Building controlled experiments for threadpool timer forensics and integrity monitoring
- Improving reflective-loader tradecraft by eliminating suspicious callstack artifacts

Keywords:
SLEAPING, SWAPPALA, sleep mask, Hunt-Sleeping-Beacons, HSB, timer queue, CreateTimerQueueTimer, WAITORTIMERCALLBACK, ResumeThread, Windows thread pool, TpWorkerFactory, NtQueryInformationWorkerFactory, NtQuerySystemInformation, NtQueryObject, TPP_CLEANUP_GROUP_MEMBER, FinalizationCallback, WriteProcessMemory, APC, NtQueueApcThread, NtContinue, NtAlertResumeThread, events, SetEvent, NtWaitForSingleObject, MapViewOfFileEx, UnmapViewOfFile, reflective DLL injection, callstack evasion, CFG (CfgAddressAdd)