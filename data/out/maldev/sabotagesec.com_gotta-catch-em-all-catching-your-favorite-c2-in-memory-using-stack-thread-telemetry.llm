Title:
Gotta Catch ‘Em all! Catching Your Favorite C2 In Memory Using Stack & Thread Telemetry

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes detecting in-memory C2 agents by continuously tracing thread call stacks and correlating frames with module/symbol backing.  
- It targets common stack-spoofing artifacts: abruptly truncated stacks (missing `RtlThreadStart`/`BaseThreadInitThunk`) and cases where the thread start address is not present anywhere in the unwound stack.  
- The author builds a custom “stack tracer” that monitors newly spawned processes, resolves RIP/return addresses to modules/symbols, and alerts on anomalies such as non-image-backed addresses and invalid return addresses.  
- It compares results across tools (Process Explorer vs Process Hacker) and explains discrepancies via different APIs for thread start address (`NtQueryInformationThread` with `ThreadQuerySetWin32StartAddress` vs `NtQuerySystemInformation` `SYSTEM_PROCESS_INFORMATION`).  
- Real-world examples include a commercial C2 with “out-of-the-box” stack spoofing issues, Fortra’s CallStackMasker producing a “too perfect” but inconsistent stack (start address not appearing in frames), and Havoc Demon’s NtTib/TEB swapping approach detectable via fluctuating `StackBase`.  
- Useful for detection engineers and blue teams building memory/thread telemetry detections, and for red teams validating whether their stack spoofing is internally consistent.

Technical Focus:
- Windows thread call stack unwinding and symbol/module resolution
- Stack spoofing artifacts (truncation, invalid return addresses, non-backed frames)
- Thread start address telemetry (`ThreadQuerySetWin32StartAddress`, `SYSTEM_PROCESS_INFORMATION`)
- TEB/NtTib manipulation and stack base swapping (Havoc Demon sleep obfuscation)
- Comparative tooling behavior (Process Explorer vs Process Hacker)
- WinINet-based network call visibility in stacks (`HttpSendRequestA`, etc.)

Use Cases:
- Detect in-memory C2 beacons by spotting anomalous thread stacks and start-address inconsistencies
- Validate/QA stack spoofing implementations for OPSEC regressions
- Build EDR/DFIR heuristics around non-image-backed return addresses and missing `BaseThreadInitThunk`/`RtlThreadStart`
- Identify sleep obfuscation via monitoring per-thread `StackBase` changes over time
- Triage suspicious threads showing WinINet/web-call frames combined with stack anomalies

Keywords:
Windows internals, call stack unwinding, stack spoofing, thread telemetry, thread start address, NtQueryInformationThread, ThreadQuerySetWin32StartAddress, NtQuerySystemInformation, SYSTEM_PROCESS_INFORMATION, TEB, NtTib, StackBase, BaseThreadInitThunk, RtlThreadStart, RtlUserThreadStart, Process Hacker, Process Explorer, WinINet, HttpSendRequestA, Havoc Demon, CallStackMasker, C2 beacon detection