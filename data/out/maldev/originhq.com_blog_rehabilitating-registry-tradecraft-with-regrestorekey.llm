Title:
Rehabilitating Registry Tradecraft with RegRestoreKey

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explores how to perform registry modifications (using service creation/persistence as the motivating example) in ways that evade common EDR telemetry focused on `RegCreateKey*`/`RegSetValue*` and their native equivalents.  
- It contrasts two dominant registry-observation approaches—`Microsoft-Windows-Kernel-Registry` ETW and kernel registry callback routines via `CmRegisterCallback`—and highlights the practical tradeoffs that lead vendors to collect only a subset of possible registry operations.  
- The core technique is using `RegRestoreKeyW` to overwrite a target key’s subkeys/values from a crafted hive file, avoiding the typical create/set registry primitives that many sensors key on.  
- It shows how to build the hive file locally using the Offline Registry Library (`ORCreateHive`, `ORCreateKey`, `ORSetValue`, `ORSaveHive`) to avoid `RegSaveKey*` telemetry, then restore with `REG_FORCE_RESTORE` (requiring `SeRestorePrivilege` and `SeBackupPrivilege`).  
- The author quantifies the evasion gap: defenders often miss `RegNtPre/PostRestoreKey` callbacks and may only see obscure ETW “RegPerfTaskHiveRestore” performance events that lack the target key path.  
- A PoC is provided but intentionally unstable for the services hive overwrite case (often causing BSOD), while the same concept is demonstrated as more practical for less critical keys like Run keys.

Technical Focus:
- Windows registry telemetry: ETW (`Microsoft-Windows-Kernel-Registry`) vs kernel callbacks (`CmRegisterCallback`, `REG_NOTIFY_CLASS`)
- Registry restore primitives: `RegRestoreKeyW`, `REG_FORCE_RESTORE`, `REG_RESTORE_KEY_INFORMATION`
- Offline Registry Library hive construction (`ORCreateHive`, `ORCreateKey`, `ORSetValue`, `ORSaveHive`)
- Privilege requirements: `SeRestorePrivilege` (`SE_RESTORE_NAME`), `SeBackupPrivilege` (`SE_BACKUP_NAME`)
- Persistence via registry-backed configuration (Services key, Run keys) without standard create/set APIs

Use Cases:
- Building red-team tradecraft to modify registry state while bypassing common “CreateKey/SetValue” detections
- Testing EDR coverage gaps around `RegNtPre/PostRestoreKey` and hive-restore ETW events
- Developing blue-team detections for registry hive restore activity (file path, flags, privilege use, targeted key context)
- Researching alternative registry mutation APIs (`RegRestoreKey`, `RegLoadKey`, `RegReplaceKey`, `RegCopyTree`) and their telemetry

Keywords:
RegRestoreKeyW, Windows Registry, EDR evasion, ETW, Microsoft-Windows-Kernel-Registry, CmRegisterCallback, REG_NOTIFY_CLASS, RegNtPreRestoreKey, RegNtPostRestoreKey, REG_RESTORE_KEY_INFORMATION, REG_FORCE_RESTORE, Offline Registry Library, ORCreateHive, ORCreateKey, ORSetValue, ORSaveHive, SeRestorePrivilege, SeBackupPrivilege, HKLM\\SYSTEM\\CurrentControlSet\\Services, persistence, service installation telemetry (4697, 7045)