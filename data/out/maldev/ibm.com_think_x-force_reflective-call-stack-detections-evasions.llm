Title:
Reflective call stack detections and evasions

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post analyzes how modern EDRs can detect reflectively loaded payloads (e.g., Cobalt Strike Beacon) by inspecting thread call stacks, and how attackers evade those detections with active call stack spoofing.  
- It outlines several practical detection ideas: unresolved return addresses (shellcode), truncated stacks that don’t unwind to normal thread start routines, mismatches between a thread’s start address and the expected bottom frames, and identifying “gadget” frames used to pivot execution.  
- The evasion side covers return-address spoofing using ROP-style gadgets in trusted modules plus non-volatile registers to preserve the real return target, and adding synthetic frames to make stacks appear to originate from legitimate thread start APIs.  
- It also describes how IBM’s public BokuLoader integrates these techniques (via LoudSunRun/SilentMoonwalk/Vulcan Raven lineage) by hooking imported WININET APIs to spoof stacks during network activity.  
- Additional implementation notes include replacing some direct syscalls with spoofed indirect syscalls, using HalosGate for syscall number resolution, and adding a gadget hunter to locate syscall gadgets in NTDLL.  
- Useful for red team/tooling developers building stealthy in-memory execution, and for blue team detection engineers/threat hunters designing call-stack-based telemetry and tuning strategies.

Technical Focus:
- Call stack inspection for in-memory/reflective loader detection
- Return address validation against loaded modules
- Active call stack spoofing (return-address spoofing, synthetic frames)
- Thread start address vs. call stack frame correlation
- API hooking of imported functions (WININET) for stack manipulation
- Indirect syscalls, HalosGate, syscall/gadget discovery in NTDLL

Use Cases:
- Build or evaluate call-stack-based detections for reflective loaders and shellcode
- Implement stack spoofing in offensive tooling to reduce EDR call-stack signal
- Threat hunting playbooks for suspicious/truncated stacks and module-less return addresses
- Research and tuning of heuristics around thread start frames and gadget usage
- Comparing public PoCs (AceLdr, SilentMoonwalk, Vulcan Raven, LoudSunRun) to vendor detection coverage

Keywords:
call stack spoofing, reflective loader, Cobalt Strike Beacon, BokuLoader, EDR telemetry, stack walking, return address hunting, unresolved return address, ROP gadget, jmp [rbx], non-volatile registers, synthetic stack frames, BaseThreadInitThunk, RtlUserThreadStart, WININET, API hooking, indirect syscalls, HalosGate, NTDLL, syscall gadget hunter