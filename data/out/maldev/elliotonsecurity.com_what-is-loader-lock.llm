Title:
What is Loader Lock?

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post reverse-engineers and explains Windows “loader lock” behavior and why `DllMain` runs while loader synchronization is held, making certain actions deadlock-prone.  
- It contrasts the legacy (Server 2003-era) model where loader lock broadly serialized most loader activity with modern Windows (10/22H2) where locking is more fine-grained.  
- The article shows how to inspect loader lock in WinDbg (`!critsec ntdll!LdrpLoaderLock`) and how to locate it via the PEB (`PEB->LoaderLock`) and query it with `RtlIsCriticalSectionLockedByThread`.  
- It maps which loader data structures are protected by which locks, highlighting `LdrpModuleDatatableLock` (SRW lock) for module lists/hash/RB-trees versus `LdrpLoaderLock` (critical section) for initialization/deinitialization ordering and dependency (DDAG) operations.  
- It discusses recursive acquisition (why `LoadLibrary` can appear to “work” inside `DllMain`) and why it’s still unsafe due to lock hierarchy and contention/priority inversion risks.  
- Useful for Windows reverse engineers, red team tool developers (injectors/loaders), and blue team analysts debugging hangs/crashes related to module loading.

Technical Focus:
- Windows loader internals (Ldr*, Ldrp* routines) and `DllMain` constraints  
- PEB/`PEB_LDR_DATA` module tracking structures (`LDR_DATA_TABLE_ENTRY`)  
- Synchronization primitives: Critical Sections vs SRW locks (exclusive)  
- Loader data structures: module linked lists, hash table (`LdrpHashTable`), red-black trees, DDAG dependency graph  
- WinDbg-based inspection and call-stack driven RE of loader paths (`LoadLibrary`/`FreeLibrary`)  

Use Cases:
- Debugging deadlocks/hangs caused by unsafe work in `DllMain` (thread creation, waits, COM, loader calls)
- Building safer DLL injection / reflective loading strategies that avoid loader-lock pitfalls
- Reverse engineering Windows module load/unload behavior and dependency initialization order
- Writing detections/telemetry for suspicious module load patterns by understanding loader state and structures

Keywords:
Windows loader, loader lock, LdrpLoaderLock, DllMain, DLL_PROCESS_ATTACH, DLL_PROCESS_DETACH, PEB, PEB_LDR_DATA, LDR_DATA_TABLE_ENTRY, InLoadOrderModuleList, InMemoryOrderModuleList, InInitializationOrderModuleList, LdrpModuleDatatableLock, SRW lock, critical section, RtlAcquireSRWLockExclusive, RtlEnterCriticalSection, RtlIsCriticalSectionLockedByThread, LdrLoadDll, LdrpInitializeGraphRecurse, LDR_DDAG_NODE, red-black tree, LdrpHashTable, WinDbg, !critsec, deadlock, lock hierarchy