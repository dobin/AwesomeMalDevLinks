Title:
Evading detection in memory – Pt 1: Sleep Obfuscation – Foliage

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains a Windows “sleep obfuscation” approach to reduce in-memory detection of C2 beacons/implants that reside in private RX memory (often produced via sRDI/reflective loading).  
- It focuses on how EDRs prioritize scanning executable, non-backed private regions and how thread call stacks can reveal execution returning into suspicious memory during sleep.  
- The technique (“Foliage”) uses APC-driven ROP-style execution by queuing `NtContinue` calls with crafted `CONTEXT` structures to run a chain that flips protections (RX→RW), encrypts the implant, sleeps, decrypts, and restores RX without directly executing from RW pages.  
- It demonstrates implementation using NTAPI primitives (event + suspended thread + APC queueing) and RC4-like routines (`SystemFunction040/041`) for in-place memory encryption/decryption.  
- The post also discusses detection IOCs (e.g., `NtTestAlert`/`VirtualProtect` patterns, suspicious stacks like `NtSignalAndWaitForSingleObject`) and introduces “stack duplication” to evade stack-based heuristics (e.g., Moneta/Elastic rules).  
- Useful for red teamers and malware developers building stealthy implants, and for blue teams understanding behavioral detections around sleep masking.

Technical Focus:
- Windows memory types (PRIVATE/MAPPED/IMAGE) and `VirtualQuery`/`MEMORY_BASIC_INFORMATION`
- Sleep obfuscation via `VirtualProtect` RX↔RW and in-memory encryption
- APC-based execution using `NtQueueApcThread` + `NtContinue` with crafted `CONTEXT`
- NTAPI thread/event orchestration (`NtCreateThreadEx`, `NtCreateEvent`, `NtSignalAndWaitForSingleObject`, `NtTestAlert`)
- Stack-based detection IOCs and “stack duplication” using `NtGetContextThread`/`NtSetContextThread` + `DuplicateHandle`

Use Cases:
- Implementing beacon sleep masking to reduce memory-scan exposure during idle periods
- Building APC/ROP-like execution chains that avoid executing from non-executable pages
- Testing/validating EDR detections for `VirtualProtect` + `NtTestAlert`/APC patterns
- Developing counter-forensics against stack-walk and thread-callstack heuristics
- Creating lab PoCs to compare tools like pe-sieve/Moneta against obfuscated implants

Keywords:
Windows internals, sleep obfuscation, memory scanning, EDR evasion, PRIVATE memory, VirtualProtect, VirtualQuery, MEMORY_BASIC_INFORMATION, APC, NtQueueApcThread, NtContinue, CONTEXT, NtTestAlert, NtCreateThreadEx, NtSignalAndWaitForSingleObject, SystemFunction040, SystemFunction041, RC4, call stack heuristics, stack duplication, Moneta, pe-sieve, sRDI, reflective loading