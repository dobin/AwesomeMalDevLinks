# https://whiteknightlabs.com/2024/07/31/layeredsyscall-abusing-veh-to-bypass-edrs/

<!DOCTYPE html><html lang="en-US" prefix="og: https://ogp.me/ns#" dir="ltr">

<body class="wp-singular post-template-default single single-post postid-26965 single-format-standard wp-embed-responsive wp-theme-hello-elementor ehf-template-hello-elementor ehf-stylesheet-hello-elementor et_monarch hello-elementor-default elementor-default elementor-template-canvas elementor-kit-27292 chrome e--ua-blink e--ua-chrome e--ua-webkit" data-elementor-device-mode="none">
	<!-- start Simple Custom CSS and JS -->
<!-- Add HTML code to the header or the footer.

For example, you can use the following code for loading the jQuery library from Google CDN:
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

or the following one for loading the Bootstrap library from jsDelivr:
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

-- End of the comment --> 

<!-- Google Tag Manager (noscript) -->

<!-- End Google Tag Manager (noscript) --><!-- end Simple Custom CSS and JS -->
		<div data-elementor-type="wpr-theme-builder" data-elementor-id="29780" class="elementor elementor-29780 post-26965 post type-post status-publish format-standard hentry category-uncategorized tag-call-stack tag-edr-evasion tag-indirect-syscall tag-layeredsyscall tag-offensive-security tag-veh">
				<div class="elementor-element elementor-element-1942ca1 e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-parent e-lazyloaded" data-id="1942ca1" data-element_type="container">
				<div class="elementor-element elementor-element-d4867ca elementor-widget__width-inherit elementor-widget elementor-widget-shortcode" data-id="d4867ca" data-element_type="widget" data-widget_type="shortcode.default">
				<div class="elementor-widget-container">
							<div class="elementor-shortcode">		<div data-elementor-type="container" data-elementor-id="29841" class="elementor elementor-29841">
				<div class="elementor-element elementor-element-ff046b7 elementor-hidden-desktop elementor-hidden-laptop elementor-hidden-tablet_extra elementor-hidden-tablet elementor-hidden-mobile_extra elementor-hidden-mobile e-flex e-con-boxed wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-parent e-lazyloaded" data-id="ff046b7" data-element_type="container">
					<div class="e-con-inner">
				<div class="elementor-element elementor-element-85f582a elementor-widget elementor-widget-html" data-id="85f582a" data-element_type="widget" data-widget_type="html.default">
				<div class="elementor-widget-container">
					<!-- Responsive Container -->
<div class="wkl-banner-container">
    
    <!-- The Image -->
    <img src="https://whiteknightlabs.com/wp-content/uploads/2025/12/WKL_Click-Here_R1-01.jpg" alt="White Knight Labs Training Bundle" class="wkl-banner-image">

    <!-- Area 1: Full Bundle -->
    <a href="https://buy.stripe.com/5kQcN55DFb5K8Rggfg9IQ0t" target="_blank" title="Full Bundle" class="wkl-link link-full-bundle"></a>

    <!-- Area 2: 2 Class Bundle -->
    <a href="https://buy.stripe.com/5kQbJ14zB7Ty8Rg9QS9IQ0y" target="_blank" title="2 Class Bundle" class="wkl-link link-2-class"></a>

    <!-- Area 3: 3 Class Bundle -->
    <a href="https://buy.stripe.com/fZu8wPc235Lq3wW0gi9IQ0x" target="_blank" title="3 Class Bundle" class="wkl-link link-3-class"></a>

</div>				</div>
				</div>
					</div>
				</div>
		<div class="elementor-element elementor-element-7e163265 z-header e-flex e-con-boxed wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-parent e-lazyloaded" data-id="7e163265" data-element_type="container">
					<div class="e-con-inner">
		<div class="elementor-element elementor-element-1d40857e e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="1d40857e" data-element_type="container">
				<div class="elementor-element elementor-element-1b9885cb z-logo elementor-widget elementor-widget-image" data-id="1b9885cb" data-element_type="widget" data-widget_type="image.default">
				<div class="elementor-widget-container">
																<a href="https://whiteknightlabs.com/">
							<img width="202" height="70" src="https://whiteknightlabs.com/wp-content/uploads/2024/08/Logo-v2.png" class="attachment-full size-full wp-image-27321" alt="White Knight Labs Logo">								</a>
															</div>
				</div>
				</div>
		<div class="elementor-element elementor-element-109d0bc6 e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="109d0bc6" data-element_type="container">
				<div class="elementor-element elementor-element-3d2d14f6 elementor-widget__width-auto hfe-submenu-icon-classic hfe-submenu-animation-slide_up z-menu elementor-widget-tablet__width-initial hfe-nav-menu__align-left hfe-link-redirect-child hfe-nav-menu__breakpoint-tablet elementor-widget elementor-widget-navigation-menu" data-id="3d2d14f6" data-element_type="widget" data-settings="{&quot;padding_horizontal_menu_item&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:0,&quot;sizes&quot;:[]},&quot;menu_space_between&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:44,&quot;sizes&quot;:[]},&quot;distance_from_menu_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:0,&quot;sizes&quot;:[]},&quot;padding_vertical_dropdown_item&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:14,&quot;sizes&quot;:[]},&quot;padding_horizontal_menu_item_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_horizontal_menu_item_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_horizontal_menu_item_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_horizontal_menu_item_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_horizontal_menu_item_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_vertical_menu_item&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:15,&quot;sizes&quot;:[]},&quot;padding_vertical_menu_item_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_vertical_menu_item_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_vertical_menu_item_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_vertical_menu_item_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_vertical_menu_item_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;menu_space_between_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;menu_space_between_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;menu_space_between_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;menu_space_between_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;menu_space_between_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;menu_row_space&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;menu_row_space_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;menu_row_space_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;menu_row_space_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;menu_row_space_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;menu_row_space_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;dropdown_border_radius&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;top&quot;:&quot;&quot;,&quot;right&quot;:&quot;&quot;,&quot;bottom&quot;:&quot;&quot;,&quot;left&quot;:&quot;&quot;,&quot;isLinked&quot;:true},&quot;dropdown_border_radius_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;top&quot;:&quot;&quot;,&quot;right&quot;:&quot;&quot;,&quot;bottom&quot;:&quot;&quot;,&quot;left&quot;:&quot;&quot;,&quot;isLinked&quot;:true},&quot;dropdown_border_radius_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;top&quot;:&quot;&quot;,&quot;right&quot;:&quot;&quot;,&quot;bottom&quot;:&quot;&quot;,&quot;left&quot;:&quot;&quot;,&quot;isLinked&quot;:true},&quot;dropdown_border_radius_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;top&quot;:&quot;&quot;,&quot;right&quot;:&quot;&quot;,&quot;bottom&quot;:&quot;&quot;,&quot;left&quot;:&quot;&quot;,&quot;isLinked&quot;:true},&quot;dropdown_border_radius_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;top&quot;:&quot;&quot;,&quot;right&quot;:&quot;&quot;,&quot;bottom&quot;:&quot;&quot;,&quot;left&quot;:&quot;&quot;,&quot;isLinked&quot;:true},&quot;dropdown_border_radius_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;top&quot;:&quot;&quot;,&quot;right&quot;:&quot;&quot;,&quot;bottom&quot;:&quot;&quot;,&quot;left&quot;:&quot;&quot;,&quot;isLinked&quot;:true},&quot;width_dropdown_item&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;220&quot;,&quot;sizes&quot;:[]},&quot;width_dropdown_item_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;width_dropdown_item_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;width_dropdown_item_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;width_dropdown_item_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;width_dropdown_item_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_horizontal_dropdown_item&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_horizontal_dropdown_item_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_horizontal_dropdown_item_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_horizontal_dropdown_item_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_horizontal_dropdown_item_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_horizontal_dropdown_item_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_vertical_dropdown_item_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_vertical_dropdown_item_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_vertical_dropdown_item_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_vertical_dropdown_item_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;padding_vertical_dropdown_item_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;distance_from_menu&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;distance_from_menu_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;distance_from_menu_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;distance_from_menu_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;distance_from_menu_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_size&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_size_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_size_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_size_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_size_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_size_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_border_width&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_border_width_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_border_width_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_border_width_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_border_width_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_border_width_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_border_radius&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_border_radius_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_border_radius_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_border_radius_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_border_radius_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_border_radius_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]}}" data-widget_type="navigation-menu.default">
				<div class="elementor-widget-container">
								<div class="hfe-nav-menu hfe-layout-horizontal hfe-nav-menu-layout horizontal hfe-pointer__none" data-layout="horizontal">
				<div role="button" class="hfe-nav-menu__toggle elementor-clickable" aria-haspopup="true" aria-expanded="false">
					<span class="screen-reader-text">Menu</span>
					<div class="hfe-nav-menu-icon">
						<svg aria-hidden="true" class="e-font-icon-svg e-fas-align-justify" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M432 416H16a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-128H16a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-128H16a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-128H16A16 16 0 0 0 0 48v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16z"></path></svg>					</div>
				</div>
				
			</div>
							</div>
				</div>
				<div class="elementor-element elementor-element-2ce86a3 hfe-search-layout-icon elementor-hidden-tablet elementor-hidden-mobile_extra elementor-hidden-mobile elementor-widget elementor-widget-hfe-search-button" data-id="2ce86a3" data-element_type="widget" data-settings="{&quot;toggle_icon_size&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:20,&quot;sizes&quot;:[]},&quot;input_icon_size&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:200,&quot;sizes&quot;:[]},&quot;input_icon_size_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;input_icon_size_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;input_icon_size_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;input_icon_size_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;input_icon_size_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_icon_size_laptop&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_icon_size_tablet_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_icon_size_tablet&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_icon_size_mobile_extra&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]},&quot;toggle_icon_size_mobile&quot;:{&quot;unit&quot;:&quot;px&quot;,&quot;size&quot;:&quot;&quot;,&quot;sizes&quot;:[]}}" data-widget_type="hfe-search-button.default">
				<div class="elementor-widget-container">
							<form class="hfe-search-button-wrapper" role="search" action="https://whiteknightlabs.com/" method="get">

						<div class="hfe-search-icon-toggle">
				<input placeholder="" class="hfe-search-form__input" type="search" name="s" title="Search" value="" style="padding-right: 20px;">
				<i class="fas fa-search" aria-hidden="true"></i>
			</div>
					</form>
						</div>
				</div>
				</div>
					</div>
				</div>
				</div>
		<span class="wpr-template-edit-btn" data-permalink="https://whiteknightlabs.com/?elementor_library=z-header">Edit Template</span></div>
						</div>
				</div>
				</div>
		<div class="elementor-element elementor-element-5aa7457 e-flex e-con-boxed wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-parent e-lazyloaded" data-id="5aa7457" data-element_type="container" data-settings="{&quot;background_background&quot;:&quot;classic&quot;}">
					<div class="e-con-inner">
		<div class="elementor-element elementor-element-5ee8ea2 e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="5ee8ea2" data-element_type="container">
		<div class="elementor-element elementor-element-0708fe0 e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="0708fe0" data-element_type="container">
				<div class="elementor-element elementor-element-0d1c8bf elementor-widget elementor-widget-wpr-post-title" data-id="0d1c8bf" data-element_type="widget" data-widget_type="wpr-post-title.default">
				<div class="elementor-widget-container">
					<h1 class="wpr-post-title">LayeredSyscall – Abusing VEH to Bypass EDRs</h1>				</div>
				</div>
				</div>
				</div>
					</div>
				</div>
		<div class="elementor-element elementor-element-96821df e-flex e-con-boxed wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-parent e-lazyloaded" data-id="96821df" data-element_type="container">
					<div class="e-con-inner">
		<div class="elementor-element elementor-element-7ede4ff e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="7ede4ff" data-element_type="container">
				<div class="elementor-element elementor-element-f03e909 wpr-post-info-align-left elementor-widget__width-inherit elementor-widget elementor-widget-wpr-post-info" data-id="f03e909" data-element_type="widget" data-widget_type="wpr-post-info.default">
				<div class="elementor-widget-container">
					<ul class="wpr-post-info wpr-post-info-horizontal"><li class="wpr-post-info-author"><span>Adhithya Suresh Kumar</span></li><li class="wpr-post-info-date"><span>July 31, 2024</span></li><li class="wpr-post-info-taxonomy"><span>Uncategorized</span></li><li class="wpr-post-info-comments"></li></ul>				</div>
				</div>
				<div class="elementor-element elementor-element-c933496 elementor-widget__width-auto elementor-widget elementor-widget-wpr-post-media" data-id="c933496" data-element_type="widget" data-widget_type="wpr-post-media.default">
				<div class="elementor-widget-container">
					<div class="wpr-featured-media-wrap" data-caption="standard"></div>				</div>
				</div>
				<div class="elementor-element elementor-element-450bc4c elementor-widget__width-inherit z-post-content elementor-widget elementor-widget-wpr-post-content" data-id="450bc4c" data-element_type="widget" data-widget_type="wpr-post-content.default">
				<div class="elementor-widget-container">
					<div class="wpr-post-content">
<div class="wp-block-rank-math-toc-block" id="rank-math-toc"><h2>Table of Contents</h2></div>



<p>Asking any offensive security researcher how an EDR could be bypassed will result one of many possible answers, such as removing hooks, direct syscalls, indirect syscalls, etc. In this blog post, we will take a different perspective to abuse Vectored Exception Handlers (VEH) as a foundation to produce a legitimate thread call stack and employ indirect syscalls to bypass user-land EDR hooks.</p>



<p class="has-vivid-red-color has-pale-pink-background-color has-text-color has-background has-link-color has-small-font-size wp-elements-da99c5726fbef81db91a2579a0c40293"><strong>Disclaimer</strong>: The research below must only be used for ethical purposes. Please be responsible and do not use it for anything illegal. This is for educational purposes only. </p>



<h2 class="wp-block-heading" id="introduction">Introduction</h2>



<p>EDRs use user-land hooks that are usually placed in <code>ntdll.dll</code> or sometimes within the <code>kernel32.dll</code> that are loaded into every process in the Windows operating system. They implement their hooking procedure typically in one of two ways:</p>



<ul class="wp-block-list">
<li>Patch the first few bytes of the function to be hooked with a redirection (similar to the Microsoft Detours library)</li>



<li>Overwrite the function address within the IAT table of a dll that uses the function</li>
</ul>



<p>Hooks are not placed in every function within the target dll. Within <code>ntdll.dll</code>, most of the hooks are placed in the <code>Nt*</code> syscall wrapper functions. These hooks are often used to redirect the execution safely to the EDR’s dll to examine the parameters to determine if the process is performing any malicious actions.</p>



<p>Some popular bypasses for circumventing these hooks are:</p>



<ul class="wp-block-list">
<li><strong><a href="https://www.ired.team/offensive-security/defense-evasion/how-to-unhook-a-dll-using-c++" target="_blank" rel="noopener">Remapping ntdll.dll</a></strong>: Accessing a fresh copy of ntdll either from disk or <code>KnownDll </code>cache and remapping the hooked version with the fresh copy, either the section or the specific function bytes.</li>



<li><strong><a href="https://www.paloaltonetworks.com/blog/security-operations/a-deep-dive-into-malicious-direct-syscall-detection/" target="_blank" rel="noopener">Direct syscalls</a></strong>: Emulate what the <code>Nt*</code> syscall wrappers do within your program using the corresponding SSN and the syscall opcode.</li>



<li><strong><a href="https://redops.at/en/blog/direct-syscalls-vs-indirect-syscalls" target="_blank" rel="noopener">Indirect syscalls</a></strong>: Set up the syscall parameters within your program and redirect execution using a <code>jmp</code> instruction to the address within <code>ntdll.dll </code>where the syscall opcode resides.</li>
</ul>



<p>There are more bypass techniques, such as blocking any unsigned dll from being loaded, blocking the EDR’s dll from being loaded by <a href="https://malwaretech.com/2024/02/bypassing-edrs-with-edr-preload.html" target="_blank" rel="noopener">monitoring <code>LdrLoadDll</code></a>, etc.</p>



<p>On the flipside, there are detection strategies that could be employed to detect and perhaps prevent the above-mentioned evasion techniques:</p>



<ul class="wp-block-list">
<li><strong>Detecting Remapping ntdll.dll</strong>
<ul class="wp-block-list">
<li>If a process contains two instances of ntdll.dll within its memory space, it is usually a clear sign of suspicious behavior.</li>
</ul>
</li>



<li><strong>Detecting Direct Syscalls</strong>
<ul class="wp-block-list">
<li>When direct syscalls are performed, the EDR could register an instrumentation callback to check where the user-land code resumes from. And if it returned to the process rather than returning to the ntdll.dll address space, then it is a clear indication that a direct syscall took place.</li>
</ul>
</li>



<li><strong>Detecting Indirect Syscalls</strong>
<ul class="wp-block-list">
<li>Since this technique involves jumping to the ntdll.dll address space to perform the syscall event, the previous detection would fail. However, a thread call stack analysis would reveal that there is an anomalous behavior since there are no legitimate calls through various Windows APIs, rather it is just the process to ntdll.dll.</li>
</ul>
</li>
</ul>



<p>The research presented below attempts to address the above detection strategies.</p>



<hr class="wp-block-separator has-alpha-channel-opacity">



<h2 class="wp-block-heading" id="layered-syscall-overview">LayeredSyscall – Overview</h2>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a1eb31&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a1eb31" class="wp-block-image size-full wp-lightbox-container"><img fetchpriority="high" decoding="async" width="1024" height="625" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-40.png" alt="A fun little graph for LayeredSyscall" class="wp-image-27064"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">LayeredSyscall – Overview of the control flow</figcaption></figure>



<p>The general idea is to generate a legitimate call stack before performing the indirect syscall while switching modes to the kernel land and also to support up to 12 arguments. Additionally, the call stack could be of the user’s choice, with the assumption that one of the stack frames satisfies the size requirement for the number of arguments of the intended<code> Nt*</code> syscall. The implemented concept could also allow the user to produce not only the legitimate call stack but also the indirect syscall in between the user’s chosen Windows API, if needed.</p>



<p>Vectored Exception Handler (VEH) is used to provide us with control over the context of the CPU without the need to raise any alarms. As exception handlers are not widely attributed as malicious behavior, they provide us with access to hardware breakpoints, which will be abused to act as a hook.</p>



<p>To note, the call stack generation mentioned here is not constructed by the tool or by the user, but rather performed by the system, without the need to perform unwinding operations of our own or separate allocations in memory. This means the call stack could be changed by simply calling another Windows API if detections for one are present.</p>



<h2 class="wp-block-heading" id="veh-handler-1-add-hw-bp">VEH Handler #1 – <code>AddHwBp</code></h2>



<p>We register the first handler required to set up the hardware breakpoint at two key areas, the <code>syscall </code>opcode and the <code>ret </code>opcode, both within <code>Nt*</code> syscall wrappers within <code>ntdll.dll</code>.</p>



<p>The handler is registered to handle <code>EXCEPTION_ACCESS_VIOLATION</code>, which is generated by the tool, just before the actual call to the syscall takes place. This could be performed in many ways, but we’ll use the basic reading of a null pointer to generate the exception.</p>



<p>However, since we must support any syscall that the user could call, we need a generic approach to set the breakpoint. We can implement a wrapper function that takes one argument and proceeds to trigger the exception. Furthermore, the handler can retrieve the address of the <code>Nt*</code> function by accessing the <code>RCX</code> register, which stores the first argument passed to the wrapper function.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a1f2b2&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a1f2b2" class="wp-block-image size-full wp-lightbox-container"><img decoding="async" width="1022" height="188" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-19.png" alt="" class="wp-image-27010"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 834px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Triggering ACCESS_VIOLATION exception</figcaption></figure>



<p>Once retrieved, we perform a memory scan to find out the offset where the syscall opcode and the <code>ret</code> opcode (just after the syscall opcode) are present. We can do this by checking that the opcodes<code> 0x0F</code> and <code>0x05</code> are adjacent to each other like in the code below.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a1f893&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a1f893" class="wp-block-image size-large wp-lightbox-container"><img decoding="async" width="1024" height="195" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-20-1024x195.png" alt="" class="wp-image-27011"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Finding syscall opcode by scanning the memory</figcaption></figure>



<p>Syscalls in Windows as seen in the following screenshot are constructed using the opcodes, 0x0F and 0x05. Two bytes after the start of the syscall, you can find the ret opcode, 0xC3.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a1fe8a&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a1fe8a" class="wp-block-image size-full wp-lightbox-container"><img loading="lazy" decoding="async" width="866" height="151" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-41.png" alt="" class="wp-image-27065"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 990px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">syscall opcode – 0xF and 0x5; ret opcode – 0xC3</figcaption></figure>



<p>Hardware breakpoints are set using the registers <code>Dr0, Dr1, Dr2, </code>and <code>Dr3</code> where <code>Dr6 </code>and <code>Dr7 </code>are used to modify the necessary flags for their corresponding register. The handler uses <code>Dr0 </code>and <code>Dr1 </code>to set the breakpoint at the <code>syscall </code>and the <code>ret </code>offset. As seen in the code below, we enable them by accessing the <code>ExceptionInfo-&gt;ContextRecord-&gt;Dr0</code> or <code>Dr1</code>. We also set the last and the second bit of the <code>Dr7 </code>register to let the processor know that the breakpoint is enabled.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a203f4&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a203f4" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="731" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-21-1024x731.png" alt="" class="wp-image-27012"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">AddHwBp() Exception Handler for ACCESS_VIOLATION</figcaption></figure>



<p>As you can see in the image below, the exception is thrown because we are trying to read a null pointer address.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a20955&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a20955" class="wp-block-image size-full is-resized wp-lightbox-container"><img loading="lazy" decoding="async" width="712" height="160" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-42.png" alt="" class="wp-image-27066" style="width:823px;height:auto"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 1033px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Disassembly of exception triggering code</figcaption></figure>



<p>Once the exception is thrown, the handler will take charge and place the breakpoints.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a20ed8&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a20ed8" class="wp-block-image size-full wp-lightbox-container"><img loading="lazy" decoding="async" width="1720" height="571" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-2.png" alt="Breaking at the syscall entry address and setting the breakpoint using our VEH handler" class="wp-image-26985"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 136px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Placing the breakpoint at syscall opcode</figcaption></figure>



<p>Take note, once the exception is triggered, it is necessary to step the <code>RIP </code>register to the number of bytes required to pass the opcode that generated the exception. In this case, it was 2 bytes.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a21412&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a21412" class="wp-block-image size-full wp-lightbox-container"><img loading="lazy" decoding="async" width="1725" height="556" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-3.png" alt="Instructions that generated the exception is skipped" class="wp-image-26986"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 131px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Incrementing RIP past the exception triggering code</figcaption></figure>



<p>After that, the CPU will continue the rest of the exception and this will perform as our hooks. We will see this performed in the second handler below.</p>



<h2 class="wp-block-heading" id="veh-handler-2-handler-hw-bp">VEH Handler #2 – <code>HandlerHwBp</code></h2>



<p>This handler contains three major parts:</p>



<ul class="wp-block-list">
<li>To save the context and initiate the generation of the user-chosen call stack</li>



<li>To properly return to the process without crashing</li>



<li>To find the right place to redirect the execution and bypass the hook by performing an indirect syscall</li>
</ul>



<h3 class="wp-block-heading" id="part-1-handling-the-syscall-breakpoint">Part #1 – Handling the Syscall Breakpoint</h3>



<p>Hardware breakpoints, when executed by the system, generate an exception code,<code> EXCEPTION_SINGLE_STEP</code>, which is checked to handle our breakpoints. In the first order of the control flow, we check if the exception was generated at the <code>Nt*</code> syscall start using the member <code>ExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionAddress</code>, which points to the address where the exception was generated.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a21b6a&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a21b6a" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="128" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-22-1024x128.png" alt="" class="wp-image-27013"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Checking for the hardware breakpoint at the syscall opcode</figcaption></figure>



<p>We proceed to save the context of the CPU when the exception was generated. This allows us to query the arguments stored, which according to Microsoft’s calling convention, are stored in <code>RCX, RDX, R8</code>, and <code>R9, </code>and also allows us to use the <code>RSP </code>register to query the rest of the arguments, which will be further explained later.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a220c1&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a220c1" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="120" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-23-1024x120.png" alt="" class="wp-image-27014"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Changing control flow to the benign function</figcaption></figure>



<p>Once stored, we can change the <code>RIP </code>to point to our demo function; in this case, we use a simple <code>MessageBox()</code>.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a225fa&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a225fa" class="wp-block-image size-full wp-lightbox-container"><img loading="lazy" decoding="async" width="1546" height="529" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-4.png" alt="Changing RIP to the function the user wants" class="wp-image-26987"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 310px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Debugger view of changing the RIP to the benign function start address</figcaption></figure>



<p>The demo function below is responsible for generating the legitimate call stack we require, and this could be changed by the user as needed.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a22b4f&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a22b4f" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="276" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-24-1024x276.png" alt="" class="wp-image-27015"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">MessageBox() being used as the demo function</figcaption></figure>



<h3 class="wp-block-heading" id="part-2-generating-legitimate-call-stack">Part #2 – Generating Legitimate Call Stack</h3>



<p>The general idea is to redirect the execution to the benign Windows API call, then generate the legitimate call stack and redirect to execute the indirect syscall. Although we have hooks at the <code>syscall </code>and <code>ret </code>instruction, there comes a problem where we would need to know where to stop the execution to redirect to execute the indirect syscall.</p>



<p>We use the Trap Flag (TF) that is used by debuggers to perform single-step execution. There are other ways to do this part, like using <code>ACCESS_VIOLATION</code>, page guard violation, etc. To enable the trap flag, we can use the <code>EFlags</code> register. Since we already have access to the context, we can enable it using the following snippet of code.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a23135&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a23135" class="wp-block-image size-full is-resized wp-lightbox-container"><img loading="lazy" decoding="async" width="806" height="141" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-25.png" alt="" class="wp-image-27016" style="width:823px;height:auto"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 1033px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Enabling trace flag to handle instruction tracing</figcaption></figure>



<p>To generate the legitimate call stack, we need to wait for a certain condition to take place by the system (i.e., the calls must reach the address space of <code>ntdll.dll</code> because most <code>Nt*</code> syscalls are usually redirected from within ntdll.dll). This ensures that the call stack looks as legitimate as possible to the eye of an observer, if not too keen that is.</p>



<p>This could be checked in many ways, but for the sake of simplicity, we can get the handle to <code>ntdll.dll</code> and use <code>GetModuleInformation()</code> to get the base and the end of the dll. Once queried, we can check if the exception address, which is generated due to the trap flag, is within its address space.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a236df&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a236df" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="176" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-26-1024x176.png" alt="" class="wp-image-27017"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Storing the information of ntdll.dll base and end address</figcaption></figure>



<p>We use a simple structure to store the information, which is initialized at the start of the tool.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a23c68&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a23c68" class="wp-block-image aligncenter size-full wp-lightbox-container"><img loading="lazy" decoding="async" width="394" height="129" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-27.png" alt="" class="wp-image-27018"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 16px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">DllInfo struct definition</figcaption></figure>



<p>If the conditions are satisfied, we can proceed to redirect the execution to the intended syscall. This would first require us to retrieve the saved context that we had from breaking at the syscall opcode and setting up the syscall.</p>



<p>Syscalls in Windows are set up in the following manner:</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a241ef&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a241ef" class="wp-block-image size-full is-resized wp-lightbox-container"><img loading="lazy" decoding="async" width="796" height="138" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-5.png" alt="How syscalls are implemented in windows" class="wp-image-26988" style="width:821px;height:auto"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 1035px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">How syscalls look in windows</figcaption></figure>



<p>We need to retrieve the saved context, but before that, we will need to save the current stack pointer, <code>RSP</code>, to a temp variable so that it can be retrieved. Since overwriting the stack pointer with the saved stack pointer would change the call stack entirely, which would defeat our purpose, we need to save and restore the current stack pointer just after the copy.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a2474e&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a2474e" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="87" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-28-1024x87.png" alt="" class="wp-image-27019"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Storing the stack pointer to restore it later</figcaption></figure>



<p>This keeps the call stack from changing and, at the same time, have our initial state of arguments from the intended syscall.</p>



<p>EDR hooks are usually placed in the form of<code> jmp</code> instructions at the start or a couple of instructions later from the<code> Nt*</code> syscall start address.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a24cd5&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a24cd5" class="wp-block-image aligncenter size-full wp-lightbox-container"><img loading="lazy" decoding="async" width="447" height="185" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-29.png" alt="" class="wp-image-27020"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 16px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">How EDR usually hooks into a function</figcaption></figure>



<p>So, if we emulate the syscall functionality within our handler, and then change the RIP to the syscall opcode address, we can effectively bypass the EDR hook without the need to touch it.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a2521f&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a2521f" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="175" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-30-1024x175.png" alt="" class="wp-image-27021"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Emulating the syscall within our exception handler</figcaption></figure>



<p>We can proceed to emulate the syscall before changing the <code>RIP</code> to the syscall opcode.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a257b2&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a257b2" class="wp-block-image size-full wp-lightbox-container"><img loading="lazy" decoding="async" width="1619" height="415" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-8.png" alt="Emulating the syscall" class="wp-image-26993"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 237px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Debugger view of emulating the syscall in the exception handler</figcaption></figure>



<p>This vectored syscall approach was previously documented here: <a href="https://cyberwarfare.live/bypassing-av-edr-hooks-via-vectored-syscall-poc/" target="_blank" data-type="link" data-id="https://cyberwarfare.live/bypassing-av-edr-hooks-via-vectored-syscall-poc/" rel="noreferrer noopener">Bypassing AV/EDR Hooks via Vectored Syscall</a>. This would avoid the usage of inline assembly code, or accessing the context using winapis.</p>



<p>But there is a catch. Some functions called within the system support argument count less than 4, but if we want to support almost all syscalls then we would need to support up to 12 at least.</p>



<h3 class="wp-block-heading" id="part-2-5-support-4-arguments">Part #2.5 – Support &gt;4 Arguments</h3>



<p>While generating our call stack using Windows APIs, we also need to consider the size of the stack that each of those Windows APIs allocates. This is crucial to us since the Windows calling convention stores arguments greater than 4 within the stack space.</p>



<p>The Windows calling convention works as follows,</p>



<ul class="wp-block-list">
<li>Store the first 4 arguments within the registers, <code>RCX, RDX, R8, and R9</code></li>



<li>Allocate 8 bytes for the return address</li>



<li>Allocate another 4 x 8 bytes, for saving the first 4 arguments</li>



<li>Allocate for variables and other stuff</li>
</ul>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a25f65&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a25f65" class="wp-block-image aligncenter size-full wp-lightbox-container"><img loading="lazy" decoding="async" width="424" height="741" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-43.png" alt="" class="wp-image-27068"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 16px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">How stack is set up in windows</figcaption></figure>



<p>For further reference, check out the following: <a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/windows-x64-calling-convention-stack-frame" target="_blank" rel="noopener">Windows x64 Calling Convention: Stack Frame</a></p>



<p>So this means we would need to first find an appropriate function that would support a stack size of up to 12 arguments, which we could consider as greater than <code>0x58 </code>bytes. Once we manage to find an appropriate function, we need to wait for that function to execute a call instruction to some other function. This call instruction will be intersected the moment it touches the inner function. This is to make sure that not only do we have enough stack space allocated but also a legitimate return address to run back to. To do this, we can once again use our memory scanning approach, although with a few caveats that we will solve.</p>



<p>As shown in the following screenshot, we do not have enough stack space in certain function frames to store more than 4 arguments without corrupting the stack.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a26566&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a26566" class="wp-block-image size-full wp-lightbox-container"><img loading="lazy" decoding="async" width="1681" height="611" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-12.png" alt="Insufficient stack space" class="wp-image-26997"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 175px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Call stack if inappropriate function</figcaption></figure>



<p>Most function frames allocate the stack at the beginning of the function by using the <code>sub rsp, #size</code> instruction. </p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a26ad7&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a26ad7" class="wp-block-image size-full wp-lightbox-container"><img loading="lazy" decoding="async" width="1720" height="579" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-10.png" alt="Finding an appropriate function frame to support enough stack allocation" class="wp-image-26995"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 136px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Checking for the appropriate stack size</figcaption></figure>



<p>We can find a match to this instruction by checking the opcode, <code>0xEC8348</code>, and extracting the highest byte will result in the size of the stack in most cases.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a26fed&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a26fed" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="276" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-31-1024x276.png" alt="" class="wp-image-27022"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Finding the right size, in this case 0x58 or greater</figcaption></figure>



<p>One major caveat is that sometimes the function frames can be smaller than expected, and in such cases, it is easy to reach the end of the frame, which is usually a <code>ret </code>instruction. Therefore, we will need to break the loop if we find the <code>ret </code>opcode before finding the stack size. This can be checked by adding the following snippet of code:</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a27577&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a27577" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="52" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-32-1024x52.png" alt="" class="wp-image-27023"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Exiting in case the function frame is short</figcaption></figure>



<p>We use a global flag, <code>IsSubRsp</code>, to find out if we performed the first step, which leads us to the second step: wait until a <code>call </code>instruction takes place within the same function frame we want.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a27ade&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a27ade" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="207" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-33-1024x207.png" alt="" class="wp-image-27024"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Checking if the function frame contains call instruction</figcaption></figure>



<p>Again, this can be done by checking the exception address against the opcode of the call instruction, 0xE8.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a27fe5&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a27fe5" class="wp-block-image size-full wp-lightbox-container"><img loading="lazy" decoding="async" width="1619" height="386" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-11.png" alt="Appropriate function frame found since it has a call instruction within" class="wp-image-26996"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 237px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Appropriate function frame found</figcaption></figure>



<p>Another caveat is to make sure that the function frame does not exit, which would mean we reset our counter back to 0 to let it know that we are yet to find the appropriate function.</p>



<p>Assuming that we find the right function frame that both contains the appropriate stack size and also proceeds to execute a call instruction, we can proceed to store the rest of the arguments from the saved context onto the stack frame we just found. It starts from <code>5 x 8</code> bytes after that start <code>RSP</code>.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a2854e&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a2854e" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="196" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-34-1024x196.png" alt="" class="wp-image-27025"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Storing all the arguments in the stack</figcaption></figure>



<p>Hence, this allows for a clean stack, without corrupting the stack by overwriting the return values due to the lack of stack space. The call stack integrity is maintained.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a28a8f&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a28a8f" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="374" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-13-1024x374.png" alt="Appropriate stack frame found" class="wp-image-26998"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Appropriate stack found</figcaption></figure>



<p>So, this would mean that our constraints changed to:</p>



<ul class="wp-block-list">
<li>The calls must reach into <code>ntdll.dll</code> address space</li>



<li>The call must support the appropriate stack size</li>



<li>The call must support the calling of another function within itself</li>
</ul>



<h3 class="wp-block-heading" id="part-3-handling-the-ret-breakpoint">Part #3 – Handling the ret Breakpoint</h3>



<p>Once the stack is set up and the syscall is executed, it will proceed to hit the <code>ret </code>opcode where we had already placed the hardware breakpoint. The final step is to ensure that we can return safely to the original calling function and not to the user-chosen Windows API function we used to generate the call stack, although that could also be done and we will discuss it later.</p>



<p>Since the stack frame is currently pointing to the legitimate call stack from the Windows API that was invoked, once <code>ret </code>is executed, it will immediately return to normal execution. Rather, we could point it back to the saved context’s <code>RSP, </code>which would make <code>ret </code>pop the address out of the stack and return to the function that called the <code>Nt*</code> syscall, bypassing the need to execute any further for the legitimate Windows API call.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a29190&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a29190" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="191" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-35-1024x191.png" alt="" class="wp-image-27026"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Returning back to our original wrapper function</figcaption></figure>



<p>We also clear the registers from the hardware breakpoints we set so that we can reuse them for multiple syscalls.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a296cd&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a296cd" class="wp-block-image size-full wp-lightbox-container"><img loading="lazy" decoding="async" width="1721" height="782" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-14.png" alt="Changing the stack to point back to our original function by modifying the RSP at ret breakpoint" class="wp-image-26999"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 135px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Debugger view of restoring the stack</figcaption></figure>



<h2 class="wp-block-heading" id="exposing-the-function-wrappers">Exposing the Function Wrappers</h2>



<p>We have provided a header file within our tool that needs to be included to use the wrapper functions for the <code>Nt*</code> syscall. This was inspired by the work done by <a href="https://x.com/rad9800" target="_blank" rel="noreferrer noopener">rad9800</a>, which you can check out over here, <a href="https://github.com/rad9800/TamperingSyscalls" target="_blank" rel="noreferrer noopener">TamperingSyscals</a></p>



<p>By parsing <a href="https://github.com/klezVirus/SysWhispers3/blob/master/data/prototypes.json" target="_blank" rel="noreferrer noopener">SysWhispers3</a>‘s prototypes, we can generate the header file for the syscall we prefer.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a29cba&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a29cba" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="219" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-36-1024x219.png" alt="" class="wp-image-27027"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Wrapper function to call the original Nt* syscall</figcaption></figure>



<p>Since the SSN of the syscalls keeps changing for every version of Windows, we also need to support grabbing the SSN dynamically for the version of Windows that is currently running on the system. So we included the <code>GetSsnByName()</code> provided by <a href="https://www.mdsec.co.uk/" target="_blank" rel="noreferrer noopener">MDSec</a> over here, <a href="https://www.mdsec.co.uk/2022/04/resolving-system-service-numbers-using-the-exception-directory/" target="_blank" rel="noreferrer noopener">Resolving System Service Numbers using the Exception Directory</a> There are various methods to retrieve SSN, like Halo’s gate, the Syswhispers tool, and others.</p>



<h2 class="wp-block-heading" id="usage">Usage</h2>



<p>Below is a sample piece of code to show the usage of how the function wrappers could be used. We have included the commonly used syscall functions from <code>ntdll.dll</code> within the header file in the tool.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a2a2b9&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a2a2b9" class="wp-block-image size-full wp-lightbox-container"><img loading="lazy" decoding="async" width="1450" height="943" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-50.png" alt="" class="wp-image-27102"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 406px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Usage of LayeredSyscall with the NtCreateUserProcess syscall</figcaption></figure>



<h2 class="wp-block-heading" id="results">Results</h2>



<h3 class="wp-block-heading" id="call-stack-analysis">Call Stack Analysis</h3>



<p>Before our tool is executed, the indirect syscall will produce the call stack. This is a clear indication of suspicious behavior since no legitimate function calls are going through till it reaches ntdll.dll.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a2a8e4&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a2a8e4" class="wp-block-image size-full is-resized wp-lightbox-container"><img loading="lazy" decoding="async" width="761" height="302" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-44.png" alt="" class="wp-image-27070" style="width:823px;height:auto"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 1033px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Thread call stack of an indirect syscall taking place</figcaption></figure>



<p>Now, once our tool runs, we can see the call stack generated when the syscall took place.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a2ae1c&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a2ae1c" class="wp-block-image size-full is-resized wp-lightbox-container"><img loading="lazy" decoding="async" width="761" height="449" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-45.png" alt="" class="wp-image-27071" style="width:823px;height:auto"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 1033px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Legitimate thread call stack with LayeredSyscall</figcaption></figure>



<h3 class="wp-block-heading" id="testing-against-an-edr">Testing Against an EDR</h3>



<p>We also chose to showcase the efficacy of this tool by testing this against an existing EDR. Sophos Intercept X was chosen for our test environment.</p>



<p>As for the malicious method we wanted to test, we went with the age old Process Hollowing technique. Since it is a widely detected technique, it would be a good choice to see the before and after versions using our technique.</p>



<p>Our original process hollowing method, was immediately detected by the EDR.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a2b444&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a2b444" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="371" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-48-1024x371.png" alt="Sophos EDR detects typical process injection" class="wp-image-27074"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Sophos Intercept X (EDR) detects typical process injection</figcaption></figure>



<p>Now, let us use our tool to wrap all our system call functions and run the test again.</p>



<figure data-wp-context="{&quot;imageId&quot;:&quot;69959d8a2b9b1&quot;}" data-wp-interactive="core/image" data-wp-key="69959d8a2b9b1" class="wp-block-image size-large wp-lightbox-container"><img loading="lazy" decoding="async" width="1024" height="598" data-wp-class--hide="state.isContentHidden" data-wp-class--show="state.isContentVisible" data-wp-init="callbacks.setButtonStyles" data-wp-on--click="actions.showLightbox" data-wp-on--load="callbacks.setButtonStyles" data-wp-on-window--resize="callbacks.setButtonStyles" src="https://whiteknightlabs.com/wp-content/uploads/2024/07/image-49-1024x598.png" alt="" class="wp-image-27075"><button class="lightbox-trigger" type="button" aria-haspopup="dialog" aria-label="Enlarge" data-wp-init="callbacks.initTriggerButton" data-wp-on--click="actions.showLightbox" data-wp-style--right="state.imageButtonRight" data-wp-style--top="state.imageButtonTop" style="right: 832px; top: 16px;">
			<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 12 12">
				<path fill="#fff" d="M2 0a2 2 0 0 0-2 2v2h1.5V2a.5.5 0 0 1 .5-.5h2V0H2Zm2 10.5H2a.5.5 0 0 1-.5-.5V8H0v2a2 2 0 0 0 2 2h2v-1.5ZM8 12v-1.5h2a.5.5 0 0 0 .5-.5V8H12v2a2 2 0 0 1-2 2H8Zm2-12a2 2 0 0 1 2 2v2h-1.5V2a.5.5 0 0 0-.5-.5H8V0h2Z"></path>
			</svg>
		</button><figcaption class="wp-element-caption">Sophos Intercept X (EDR) does not detect LayeredSyscall wrapped process injection</figcaption></figure>



<p>As the screenshot above shows, the executable successfully injects the sample <code>MessageBox </code>payload with no alerts from the EDR as well. <em>(The alert shown is from the previous test).</em></p>



<hr class="wp-block-separator has-alpha-channel-opacity">



<h2 class="wp-block-heading" id="conclusion">Conclusion</h2>



<p>This research and the tool were meant as a different take on how one could equip indirect syscalls or other methods such as sleep obfuscations, which might require a legitimate stack to work undetected. Since constructing our stack in a program can usually get corrupted if not developed carefully, this tool allows the operating system to generate the necessary call stack without much hassle, adding to the fact that any Windows API could potentially be used. Also, this is not to say that the bypass method would work for every EDR out there since it requires more thorough testing against many other EDRs and detection techniques to call it a global bypass.</p>



<p>Link to the tool: <a href="https://github.com/WKL-Sec/LayeredSyscall" target="_blank" rel="noopener">https://github.com/WKL-Sec/LayeredSyscall</a></p>



<h3 class="wp-block-heading" id="potential-detections">Potential Detections</h3>



<p>As of now, detections against this technique would require one to check for maliciously registered exception handlers within a particular program. Other detections could also include flagging anomalous stack behavior by implementing a heuristic against known call stack produced by Windows APIs.</p>



<h2 class="wp-block-heading" id="references">References</h2>



<ul class="wp-block-list">
<li><a href="https://malwaretech.com/2023/12/silly-edr-bypasses-and-where-to-find-them.html" target="_blank" rel="noreferrer noopener">https://malwaretech.com/2023/12/silly-edr-bypasses-and-where-to-find-them.html</a></li>



<li><a href="https://github.com/rad9800/TamperingSyscalls" target="_blank" rel="noreferrer noopener">https://github.com/rad9800/TamperingSyscalls</a></li>



<li><a href="https://github.com/Dec0ne/HWSyscalls" target="_blank" rel="noreferrer noopener">https://github.com/Dec0ne/HWSyscalls</a></li>



<li><a href="https://labs.withsecure.com/publications/spoofing-call-stacks-to-confuse-edrs" target="_blank" rel="noreferrer noopener">https://labs.withsecure.com/publications/spoofing-call-stacks-to-confuse-edrs</a></li>



<li><a href="https://www.codereversing.com/archives/594#:~:text=Defining%20the%20exception%20handler&amp;text=On%20Windows%2C%20when%20a%20hardware,Dr0%20register%20has%20been%20hit" target="_blank" rel="noopener"></a><a href="https://www.codereversing.com/archives/594#:~:text=Defining%20the%20exception%20handler&amp;text=On%20Windows%2C%20when%20a%20hardware,Dr0%20register%20has%20been%20hit" target="_blank" rel="noreferrer noopener">https://www.codereversing.com/archives/594#:~:text=Defining the exception handler&amp;text=On Windows%2C when a hardware,Dr0 register has been hit</a></li>



<li><a href="https://www.mdsec.co.uk/2022/04/resolving-system-service-numbers-using-the-exception-directory/" target="_blank" rel="noreferrer noopener">https://www.mdsec.co.uk/2022/04/resolving-system-service-numbers-using-the-exception-directory/</a></li>



<li><a href="https://github.com/klezVirus/SysWhispers3/blob/master/data/prototypes.json" target="_blank" rel="noreferrer noopener">https://github.com/klezVirus/SysWhispers3/blob/master/data/prototypes.json</a></li>



<li><a href="https://www.x86matthew.com/view_post?id=writeprocessmemory_apc" target="_blank" rel="noreferrer noopener">https://www.x86matthew.com/view_post?id=writeprocessmemory_apc</a></li>



<li><a href="https://github.com/Xacone/BestEdrOfTheMarket" target="_blank" rel="noopener">https://github.com/Xacone/BestEdrOfTheMarket</a></li>
</ul>



<hr class="wp-block-separator has-alpha-channel-opacity">



<ul class="wp-block-social-links is-layout-flex wp-block-social-links-is-layout-flex"><li class="wp-social-link wp-social-link-linkedin  wp-block-social-link"><a href="https://www.linkedin.com/company/white-knight-labs/" class="wp-block-social-link-anchor" target="_blank" rel="noopener"><svg width="24" height="24" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path d="M19.7,3H4.3C3.582,3,3,3.582,3,4.3v15.4C3,20.418,3.582,21,4.3,21h15.4c0.718,0,1.3-0.582,1.3-1.3V4.3 C21,3.582,20.418,3,19.7,3z M8.339,18.338H5.667v-8.59h2.672V18.338z M7.004,8.574c-0.857,0-1.549-0.694-1.549-1.548 c0-0.855,0.691-1.548,1.549-1.548c0.854,0,1.547,0.694,1.547,1.548C8.551,7.881,7.858,8.574,7.004,8.574z M18.339,18.338h-2.669 v-4.177c0-0.996-0.017-2.278-1.387-2.278c-1.389,0-1.601,1.086-1.601,2.206v4.249h-2.667v-8.59h2.559v1.174h0.037 c0.356-0.675,1.227-1.387,2.526-1.387c2.703,0,3.203,1.779,3.203,4.092V18.338z"></path></svg><span class="wp-block-social-link-label screen-reader-text">LinkedIn</span></a></li>

<li class="wp-social-link wp-social-link-x  wp-block-social-link"><a href="https://x.com/WKL_cyber" class="wp-block-social-link-anchor"><svg width="24" height="24" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path d="M13.982 10.622 20.54 3h-1.554l-5.693 6.618L8.745 3H3.5l6.876 10.007L3.5 21h1.554l6.012-6.989L15.868 21h5.245l-7.131-10.378Zm-2.128 2.474-.697-.997-5.543-7.93H8l4.474 6.4.697.996 5.815 8.318h-2.387l-4.745-6.787Z"></path></svg><span class="wp-block-social-link-label screen-reader-text">X</span></a></li>

<li class="wp-social-link wp-social-link-wordpress  wp-block-social-link"><a href="https://whiteknightlabs.com/blog/" class="wp-block-social-link-anchor"><svg width="24" height="24" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path d="M12.158,12.786L9.46,20.625c0.806,0.237,1.657,0.366,2.54,0.366c1.047,0,2.051-0.181,2.986-0.51 c-0.024-0.038-0.046-0.079-0.065-0.124L12.158,12.786z M3.009,12c0,3.559,2.068,6.634,5.067,8.092L3.788,8.341 C3.289,9.459,3.009,10.696,3.009,12z M18.069,11.546c0-1.112-0.399-1.881-0.741-2.48c-0.456-0.741-0.883-1.368-0.883-2.109 c0-0.826,0.627-1.596,1.51-1.596c0.04,0,0.078,0.005,0.116,0.007C16.472,3.904,14.34,3.009,12,3.009 c-3.141,0-5.904,1.612-7.512,4.052c0.211,0.007,0.41,0.011,0.579,0.011c0.94,0,2.396-0.114,2.396-0.114 C7.947,6.93,8.004,7.642,7.52,7.699c0,0-0.487,0.057-1.029,0.085l3.274,9.739l1.968-5.901l-1.401-3.838 C9.848,7.756,9.389,7.699,9.389,7.699C8.904,7.67,8.961,6.93,9.446,6.958c0,0,1.484,0.114,2.368,0.114 c0.94,0,2.397-0.114,2.397-0.114c0.485-0.028,0.542,0.684,0.057,0.741c0,0-0.488,0.057-1.029,0.085l3.249,9.665l0.897-2.996 C17.841,13.284,18.069,12.316,18.069,11.546z M19.889,7.686c0.039,0.286,0.06,0.593,0.06,0.924c0,0.912-0.171,1.938-0.684,3.22 l-2.746,7.94c2.673-1.558,4.47-4.454,4.47-7.771C20.991,10.436,20.591,8.967,19.889,7.686z M12,22C6.486,22,2,17.514,2,12 C2,6.486,6.486,2,12,2c5.514,0,10,4.486,10,10C22,17.514,17.514,22,12,22z"></path></svg><span class="wp-block-social-link-label screen-reader-text">WordPress</span></a></li></ul>
</div>				</div>
				</div>
				</div>
		<div class="elementor-element elementor-element-0c49398 e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="0c49398" data-element_type="container">
				<div class="elementor-element elementor-element-62f14cd elementor-widget__width-inherit wpr-search-form-style-inner wpr-search-form-position-right elementor-widget elementor-widget-wpr-search" data-id="62f14cd" data-element_type="widget" data-widget_type="wpr-search.default">
				<div class="elementor-widget-container">
					
		<form role="search" method="get" class="wpr-search-form" action="https://whiteknightlabs.com/" autocomplete="off">

			<div class="wpr-search-form-input-wrap elementor-clearfix">
				<input class="wpr-search-form-input" placeholder="Search..." aria-label="Search" type="search" name="s" title="Search" value="" wpr-query-type="all" wpr-taxonomy-type="" number-of-results="2" ajax-search="yes" show-description="" number-of-words="30" show-ajax-thumbnails="yes" show-view-result-btn="yes" show-product-price="no" view-result-text="View Results" no-results="No Results Found" exclude-without-thumb="" link-target="_blank" password-protected="no" attachments="no">
				
		<button class="wpr-search-form-submit" aria-label="Search" type="submit">
							<i class="fas fa-search"></i>
					</button>

					</div>

					</form>
		<div class="wpr-data-fetch">
			<span class="wpr-close-search"></span>
			<ul></ul>
					</div>
		
						</div>
				</div>
				<div class="elementor-element elementor-element-2b851b1 elementor-widget__width-initial elementor-widget elementor-widget-heading" data-id="2b851b1" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h4 class="elementor-heading-title elementor-size-default">Recent Posts</h4>				</div>
				</div>
				<div class="elementor-element elementor-element-9dfaca4 elementor-widget elementor-widget-elementskit-post-list" data-id="9dfaca4" data-element_type="widget" data-widget_type="elementskit-post-list.default">
				<div class="elementor-widget-container">
					<div class="ekit-wid-con">		<ul class="elementor-icon-list-items ekit-post-list-wrapper ">
						<li class="elementor-icon-list-item   ">
				<a href="https://whiteknightlabs.com/2026/01/20/backdooring-electron-applications/">
													<span class="elementor-icon-list-icon">
									<svg aria-hidden="true" class="e-font-icon-svg e-fas-angle-right" viewBox="0 0 256 512" xmlns="http://www.w3.org/2000/svg"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"></path></svg>								</span>
												<div class="ekit_post_list_content_wraper">
						
						<span class="elementor-icon-list-text">Backdooring Electron Applications</span>

											</div>
				</a>
			</li>
					<li class="elementor-icon-list-item   ">
				<a href="https://whiteknightlabs.com/2026/01/13/uefi-vulnerability-analysis-using-ai-part-3-scaling-understanding-not-just-context/">
													<span class="elementor-icon-list-icon">
									<svg aria-hidden="true" class="e-font-icon-svg e-fas-angle-right" viewBox="0 0 256 512" xmlns="http://www.w3.org/2000/svg"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"></path></svg>								</span>
												<div class="ekit_post_list_content_wraper">
						
						<span class="elementor-icon-list-text">UEFI Vulnerability Analysis Using AI Part 3: Scaling Understanding, Not Just Context</span>

											</div>
				</a>
			</li>
					<li class="elementor-icon-list-item   ">
				<a href="https://whiteknightlabs.com/2026/01/06/the-new-chapter-of-egress-communication-with-cobalt-strike-user-defined-c2/">
													<span class="elementor-icon-list-icon">
									<svg aria-hidden="true" class="e-font-icon-svg e-fas-angle-right" viewBox="0 0 256 512" xmlns="http://www.w3.org/2000/svg"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"></path></svg>								</span>
												<div class="ekit_post_list_content_wraper">
						
						<span class="elementor-icon-list-text">The New Chapter of Egress Communication with Cobalt Strike User-Defined C2</span>

											</div>
				</a>
			</li>
					<li class="elementor-icon-list-item   ">
				<a href="https://whiteknightlabs.com/2025/12/30/uefi-vulnerability-analysis-using-ai-part-2-breaking-the-token-barrier/">
													<span class="elementor-icon-list-icon">
									<svg aria-hidden="true" class="e-font-icon-svg e-fas-angle-right" viewBox="0 0 256 512" xmlns="http://www.w3.org/2000/svg"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"></path></svg>								</span>
												<div class="ekit_post_list_content_wraper">
						
						<span class="elementor-icon-list-text">UEFI Vulnerability Analysis using AI Part 2: Breaking the Token Barrier</span>

											</div>
				</a>
			</li>
					<li class="elementor-icon-list-item   ">
				<a href="https://whiteknightlabs.com/2025/12/23/just-in-time-for-runtime-interpretation-unmasking-the-world-of-llvm-ir-based-jit-execution/">
													<span class="elementor-icon-list-icon">
									<svg aria-hidden="true" class="e-font-icon-svg e-fas-angle-right" viewBox="0 0 256 512" xmlns="http://www.w3.org/2000/svg"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"></path></svg>								</span>
												<div class="ekit_post_list_content_wraper">
						
						<span class="elementor-icon-list-text">Just-in-Time for Runtime Interpretation - Unmasking the World of LLVM IR Based JIT Execution</span>

											</div>
				</a>
			</li>
				</ul>
		</div>				</div>
				</div>
				<div class="elementor-element elementor-element-8bf564f elementor-widget__width-initial elementor-hidden-desktop elementor-hidden-laptop elementor-hidden-tablet_extra elementor-hidden-tablet elementor-hidden-mobile_extra elementor-hidden-mobile elementor-widget elementor-widget-heading" data-id="8bf564f" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h4 class="elementor-heading-title elementor-size-default">Recent Comments</h4>				</div>
				</div>
				</div>
					</div>
				</div>
		<div class="elementor-element elementor-element-6d888cf e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-parent e-lazyloaded" data-id="6d888cf" data-element_type="container">
				<div class="elementor-element elementor-element-cc439d8 elementor-widget__width-inherit elementor-widget elementor-widget-shortcode" data-id="cc439d8" data-element_type="widget" data-widget_type="shortcode.default">
				<div class="elementor-widget-container">
							<div class="elementor-shortcode">		<div data-elementor-type="container" data-elementor-id="29844" class="elementor elementor-29844">
				<div class="elementor-element elementor-element-1ce5d837 e-flex e-con-boxed wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-parent e-lazyloaded" data-id="1ce5d837" data-element_type="container" data-settings="{&quot;background_background&quot;:&quot;classic&quot;}">
					<div class="e-con-inner">
		<div class="elementor-element elementor-element-7eab5b5b e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="7eab5b5b" data-element_type="container">
		<div class="elementor-element elementor-element-58fceb5d e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="58fceb5d" data-element_type="container" id="chat" data-settings="{&quot;background_background&quot;:&quot;classic&quot;}">
		<div class="elementor-element elementor-element-101eed42 e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="101eed42" data-element_type="container">
				<div class="elementor-element elementor-element-6858cb7b elementor-widget elementor-widget-heading" data-id="6858cb7b" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h3 class="elementor-heading-title elementor-size-default">Let’s Chat</h3>				</div>
				</div>
				<div class="elementor-element elementor-element-48f9184f elementor-widget elementor-widget-heading" data-id="48f9184f" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h4 class="elementor-heading-title elementor-size-default">Strengthen your digital stronghold.</h4>				</div>
				</div>
				<div class="elementor-element elementor-element-4c26ee5a elementor-widget elementor-widget-image" data-id="4c26ee5a" data-element_type="widget" data-widget_type="image.default">
				<div class="elementor-widget-container">
															<img width="42" height="7" src="https://whiteknightlabs.com/wp-content/uploads/2024/08/desigen-1.png" class="attachment-full size-full wp-image-27367" alt="desigen">															</div>
				</div>
				<div class="elementor-element elementor-element-427c13a4 elementor-widget elementor-widget-text-editor" data-id="427c13a4" data-element_type="widget" data-widget_type="text-editor.default">
				<div class="elementor-widget-container">
									<p>Reach out to us today and discover the potential of bespoke cybersecurity solutions designed to reduce your business risk.</p>								</div>
				</div>
				</div>
		<div class="elementor-element elementor-element-63003e38 e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="63003e38" data-element_type="container">
				<div class="elementor-element elementor-element-3b4eaecd elementor-widget elementor-widget-shortcode" data-id="3b4eaecd" data-element_type="widget" data-widget_type="shortcode.default">
				<div class="elementor-widget-container">
							<div class="elementor-shortcode">
<div class="wpcf7 js" id="wpcf7-f27543-o1" lang="en-US" dir="ltr" data-wpcf7-id="27543">
<div class="screen-reader-response"><p role="status" aria-live="polite" aria-atomic="true"></p> <ul></ul></div>
<form action="https://whiteknightlabs.com/2024/07/31/layeredsyscall-abusing-veh-to-bypass-edrs/#wpcf7-f27543-o1" method="post" class="wpcf7-form init" aria-label="Contact form" novalidate="novalidate" data-status="init">
<div style="display: none;">






</div>
<div class="z-form main">
	<div class="z-input z-50">
		<p><span class="wpcf7-form-control-wrap" data-name="first-name"><input size="40" maxlength="400" class="wpcf7-form-control wpcf7-text wpcf7-validates-as-required" aria-required="true" aria-invalid="false" placeholder="First Name *" value="" type="text" name="first-name"></span>
		</p>
	</div>
	<div class="z-input z-50">
		<p><span class="wpcf7-form-control-wrap" data-name="last-name"><input size="40" maxlength="400" class="wpcf7-form-control wpcf7-text wpcf7-validates-as-required" aria-required="true" aria-invalid="false" placeholder="Last Name *" value="" type="text" name="last-name"></span>
		</p>
	</div>
	<div class="z-input z-50">
		<p><span class="wpcf7-form-control-wrap" data-name="your-email"><input size="40" maxlength="400" class="wpcf7-form-control wpcf7-email wpcf7-validates-as-required wpcf7-text wpcf7-validates-as-email" aria-required="true" aria-invalid="false" placeholder="Email Address *" value="" type="email" name="your-email"></span>
		</p>
	</div>
	<div class="z-input z-50">
		<p><span class="wpcf7-form-control-wrap" data-name="company-name"><input size="40" maxlength="400" class="wpcf7-form-control wpcf7-text wpcf7-validates-as-required" aria-required="true" aria-invalid="false" placeholder="Company *" value="" type="text" name="company-name"></span>
		</p>
	</div>
	<div class="z-input z-100">
		<p><span class="wpcf7-form-control-wrap" data-name="phone-number"><input size="40" maxlength="400" class="wpcf7-form-control wpcf7-tel wpcf7-validates-as-required wpcf7-text wpcf7-validates-as-tel" aria-required="true" aria-invalid="false" placeholder="Phone Number *" value="" type="tel" name="phone-number"></span>
		</p>
	</div>
	<div class="z-input z-100">
		<p><span class="wpcf7-form-control-wrap" data-name="your-message"><textarea cols="5" rows="1" maxlength="2000" class="wpcf7-form-control wpcf7-textarea wpcf7-validates-as-required" id="myTextarea" aria-required="true" aria-invalid="false" placeholder="Message *" name="your-message"></textarea></span>
		</p>
	</div>
	<div class="z-input z-100 z_mathcaptcha">
		<p></p><div class="dscf7-captcha-container"><div class="dscf7-question-container"><span class="dscf7_lt">What is 5 + 3 ? <a id="tag-generator-panel-dscf7captcha" class="dscf7_refresh_captcha" aria-label="Refresh captcha"><img class="dscf7_captcha_icon" src="https://whiteknightlabs.com/wp-content/plugins/ds-cf7-math-captcha/assets/img/icons8-refresh-30.png" alt="Refresh icon"><img class="dscf7_captcha_reload_icon" src="https://whiteknightlabs.com/wp-content/plugins/ds-cf7-math-captcha/assets/img/446bcd468478f5bfb7b4e5c804571392_w200.gif" alt="Refreshing captcha" style="display:none; width:30px"></a></span></div><div class="dscf7-answer-container"><label for="tag-generator-panel-dscf7captcha-input" class="screen-reader-text">Answer for 5 + 3</label><span class="wpcf7-form-control-wrap" data-name="tag-generator-panel-dscf7captcha"><input type="text" id="tag-generator-panel-dscf7captcha-input" aria-label="Answer for 5 + 3" aria-invalid="false" aria-required="true" class="wpcf7-form-control wpcf7-text wpcf7-validates-as-required" size="5" value="" name="tag-generator-panel-dscf7captcha" placeholder="Type your answer" style=""></span></div></div>
		<p></p>
	</div>
	<div class="z-input z-100 recaptcha">
		<p></p><div id="cf7sr-69959d8a7911b" class="cf7sr-g-recaptcha" data-theme="light" data-type="image" data-size="normal" data-sitekey="6Lf5uk4qAAAAADW8LDQroQXmnKEJ9v6E92gR0Rn9"><div style="width: 304px; height: 78px;"><div><div title="reCAPTCHA" width="304" height="78" role="presentation" name="a-7xa0237d0zuh" frameborder="0" scrolling="no" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-top-navigation allow-modals allow-popups-to-escape-sandbox allow-storage-access-by-user-activation" src="https://www.google.com/recaptcha/api2/anchor?ar=1&amp;k=6Lf5uk4qAAAAADW8LDQroQXmnKEJ9v6E92gR0Rn9&amp;co=aHR0cHM6Ly93aGl0ZWtuaWdodGxhYnMuY29tOjQ0Mw..&amp;hl=en&amp;type=image&amp;v=vUgXt_KV952_-5BB2jjloYzl&amp;theme=light&amp;size=normal&amp;anchor-ms=20000&amp;execute-ms=30000&amp;cb=7qj5qzax6oi0" data-original-tag="iframe">

<title>reCAPTCHA</title>

<link rel="stylesheet" type="text/css" href="https://www.gstatic.com/recaptcha/releases/vUgXt_KV952_-5BB2jjloYzl/styles__ltr.css">


<div id="rc-anchor-alert" class="rc-anchor-alert"></div>

<div id="rc-anchor-container" class="rc-anchor rc-anchor-normal rc-anchor-light"><div id="recaptcha-accessible-status" class="rc-anchor-aria-status" aria-hidden="true">Recaptcha requires verification. </div><div class="rc-anchor-error-msg-container" style="display:none"><span class="rc-anchor-error-msg" aria-hidden="true"></span></div><div class="rc-anchor-content"><div class="rc-inline-block"><div class="rc-anchor-center-container"><div class="rc-anchor-center-item rc-anchor-checkbox-holder"><span class="recaptcha-checkbox goog-inline-block recaptcha-checkbox-unchecked rc-anchor-checkbox" role="checkbox" aria-checked="false" id="recaptcha-anchor" tabindex="0" dir="ltr" aria-labelledby="recaptcha-anchor-label"><div class="recaptcha-checkbox-border" role="presentation"></div><div class="recaptcha-checkbox-borderAnimation" role="presentation"></div><div class="recaptcha-checkbox-spinner" role="presentation"><div class="recaptcha-checkbox-spinner-overlay"></div></div><div class="recaptcha-checkbox-checkmark" role="presentation"></div></span></div></div></div><div class="rc-inline-block"><div class="rc-anchor-center-container"><label class="rc-anchor-center-item rc-anchor-checkbox-label" aria-hidden="true" role="presentation" id="recaptcha-anchor-label"><span aria-live="polite" aria-labelledby="recaptcha-accessible-status"></span>I'm not a robot</label></div></div></div><div class="rc-anchor-normal-footer"><div class="rc-anchor-logo-portrait" aria-hidden="true" role="presentation"><div class="rc-anchor-logo-img rc-anchor-logo-img-portrait"></div><div class="rc-anchor-logo-text">reCAPTCHA</div></div><div class="rc-anchor-pt"><a href="https://www.google.com/intl/en/policies/privacy/" target="_blank">Privacy</a><span aria-hidden="true" role="presentation"> - </span><a href="https://www.google.com/intl/en/policies/terms/" target="_blank">Terms</a></div></div></div><div style="display: none;" data-original-tag="iframe"></div></div></div><textarea id="g-recaptcha-response" name="g-recaptcha-response" class="g-recaptcha-response" style="width: 250px; height: 40px; border: 1px solid rgb(193, 193, 193); margin: 10px 25px; padding: 0px; resize: none; display: none;"></textarea></div><div style="display: none;" data-original-tag="iframe"></div></div><span class="wpcf7-form-control-wrap cf7sr-recaptcha" data-name="cf7sr-recaptcha"></span>
		<p></p>
	</div>
	<div class="z-input submit">
		<p><input class="wpcf7-form-control wpcf7-submit has-spinner" type="submit" value="Submit"><span class="wpcf7-spinner"></span>
		</p>
	</div>
</div><div class="wpcf7-response-output" aria-hidden="true"></div>
</form>
</div>
</div>
						</div>
				</div>
				</div>
				</div>
		<div class="elementor-element elementor-element-1c22b186 e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="1c22b186" data-element_type="container">
				<div class="elementor-element elementor-element-33cf1247 elementor-widget elementor-widget-image" data-id="33cf1247" data-element_type="widget" data-widget_type="image.default">
				<div class="elementor-widget-container">
																<a href="https://whiteknightlabs.com/">
							<img width="216" height="199" src="https://whiteknightlabs.com/wp-content/uploads/2024/08/footer-logo.png" class="attachment-full size-full wp-image-27553" alt="footer logo">								</a>
															</div>
				</div>
				</div>
		<div class="elementor-element elementor-element-37cf010d e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="37cf010d" data-element_type="container">
				<div class="elementor-element elementor-element-4aaeaa0f e-grid-align-left elementor-shape-rounded elementor-grid-0 elementor-widget elementor-widget-social-icons" data-id="4aaeaa0f" data-element_type="widget" data-widget_type="social-icons.default">
				<div class="elementor-widget-container">
							<div class="elementor-social-icons-wrapper elementor-grid" role="list">
							<span class="elementor-grid-item" role="listitem">
					<a class="elementor-icon elementor-social-icon elementor-social-icon-linkedin-in elementor-repeater-item-24943ce" href="https://www.linkedin.com/company/white-knight-labs/" target="_blank">
						<span class="elementor-screen-only">Linkedin-in</span>
						<svg class="e-font-icon-svg e-fab-linkedin-in" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"></path></svg>					</a>
				</span>
							<span class="elementor-grid-item" role="listitem">
					<a class="elementor-icon elementor-social-icon elementor-social-icon-x-twitter elementor-repeater-item-0648e80" href="https://twitter.com/WKL_cyber" target="_blank">
						<span class="elementor-screen-only">X-twitter</span>
						<svg class="e-font-icon-svg e-fab-x-twitter" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"></path></svg>					</a>
				</span>
							<span class="elementor-grid-item" role="listitem">
					<a class="elementor-icon elementor-social-icon elementor-social-icon-discord elementor-repeater-item-a00d66c" href="https://discord.gg/qRGBT2TcEV" target="_blank">
						<span class="elementor-screen-only">Discord</span>
						<svg class="e-font-icon-svg e-fab-discord" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M297.216 243.2c0 15.616-11.52 28.416-26.112 28.416-14.336 0-26.112-12.8-26.112-28.416s11.52-28.416 26.112-28.416c14.592 0 26.112 12.8 26.112 28.416zm-119.552-28.416c-14.592 0-26.112 12.8-26.112 28.416s11.776 28.416 26.112 28.416c14.592 0 26.112-12.8 26.112-28.416.256-15.616-11.52-28.416-26.112-28.416zM448 52.736V512c-64.494-56.994-43.868-38.128-118.784-107.776l13.568 47.36H52.48C23.552 451.584 0 428.032 0 398.848V52.736C0 23.552 23.552 0 52.48 0h343.04C424.448 0 448 23.552 448 52.736zm-72.96 242.688c0-82.432-36.864-149.248-36.864-149.248-36.864-27.648-71.936-26.88-71.936-26.88l-3.584 4.096c43.52 13.312 63.744 32.512 63.744 32.512-60.811-33.329-132.244-33.335-191.232-7.424-9.472 4.352-15.104 7.424-15.104 7.424s21.248-20.224 67.328-33.536l-2.56-3.072s-35.072-.768-71.936 26.88c0 0-36.864 66.816-36.864 149.248 0 0 21.504 37.12 78.08 38.912 0 0 9.472-11.52 17.152-21.248-32.512-9.728-44.8-30.208-44.8-30.208 3.766 2.636 9.976 6.053 10.496 6.4 43.21 24.198 104.588 32.126 159.744 8.96 8.96-3.328 18.944-8.192 29.44-15.104 0 0-12.8 20.992-46.336 30.464 7.68 9.728 16.896 20.736 16.896 20.736 56.576-1.792 78.336-38.912 78.336-38.912z"></path></svg>					</a>
				</span>
					</div>
						</div>
				</div>
				<div class="elementor-element elementor-element-2ebf3ca1 elementor-widget__width-inherit elementor-widget-mobile__width-inherit word-break elementor-widget elementor-widget-heading" data-id="2ebf3ca1" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h4 class="elementor-heading-title elementor-size-default"><a href="tel:877-864-4204"><span class="z-sm-txt">Call:</span> 877-864-4204</a></h4>				</div>
				</div>
				<div class="elementor-element elementor-element-7b256e3 elementor-widget__width-inherit elementor-widget-mobile__width-inherit word-break elementor-widget elementor-widget-heading" data-id="7b256e3" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h4 class="elementor-heading-title elementor-size-default"><a href="mailto:sales@whiteknightlabs.com"><span class="z-sm-txt">Email:</span> sales@whiteknightlabs.com</a></h4>				</div>
				</div>
				<div class="elementor-element elementor-element-4f60bd52 elementor-widget__width-auto elementor-widget-mobile__width-inherit elementor-widget elementor-widget-heading" data-id="4f60bd52" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h4 class="elementor-heading-title elementor-size-default"><a href="https://whiteknightlabs.com/2024/07/31/layeredsyscall-abusing-veh-to-bypass-edrs/#chat">Send us a message</a></h4>				</div>
				</div>
				</div>
		<div class="elementor-element elementor-element-2bc54d9f e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="2bc54d9f" data-element_type="container">
				<div class="elementor-element elementor-element-553d18bf elementor-widget elementor-widget-heading" data-id="553d18bf" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h4 class="elementor-heading-title elementor-size-default">Assessment</h4>				</div>
				</div>
				<div class="elementor-element elementor-element-2d71046c elementor-icon-list--layout-traditional elementor-list-item-link-full_width elementor-widget elementor-widget-icon-list" data-id="2d71046c" data-element_type="widget" data-widget_type="icon-list.default">
				<div class="elementor-widget-container">
							<ul class="elementor-icon-list-items">
							<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/vip-home-cybersecurity-assessments">

											<span class="elementor-icon-list-text">VIP Home Security</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/password-audit-service">

											<span class="elementor-icon-list-text">Password Audit</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/embedded-security-testing">

											<span class="elementor-icon-list-text">Embedded Devices</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/osint-services">

											<span class="elementor-icon-list-text">OSINT</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/active-directory-security-assessment">

											<span class="elementor-icon-list-text">AD Assessment</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/dark-web-scanning">

											<span class="elementor-icon-list-text">Dark Web Scanning</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/smart-contract-audit">

											<span class="elementor-icon-list-text">Smart Contract Audit</span>
											</a>
									</li>
						</ul>
						</div>
				</div>
				</div>
		<div class="elementor-element elementor-element-33adade e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="33adade" data-element_type="container">
				<div class="elementor-element elementor-element-6e5c9881 elementor-widget elementor-widget-heading" data-id="6e5c9881" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h4 class="elementor-heading-title elementor-size-default">Penetration Testing</h4>				</div>
				</div>
				<div class="elementor-element elementor-element-7e0b5fa6 elementor-icon-list--layout-traditional elementor-list-item-link-full_width elementor-widget elementor-widget-icon-list" data-id="7e0b5fa6" data-element_type="widget" data-widget_type="icon-list.default">
				<div class="elementor-widget-container">
							<ul class="elementor-icon-list-items">
							<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/network-penetration-testing-services">

											<span class="elementor-icon-list-text">Network Penetration Test</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/web-application-penetration-testing">

											<span class="elementor-icon-list-text">Web App Penetration Test</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/mobile-application-penetration-testing">

											<span class="elementor-icon-list-text">Mobile App Penetration Test</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/wireless-penetration-testing">

											<span class="elementor-icon-list-text">Wireless Penetration Test</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/cloud-penetration-testing">

											<span class="elementor-icon-list-text">Cloud Penetration Test</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/physical-penetration-testing/">

											<span class="elementor-icon-list-text">Physical Penetration Testing</span>
											</a>
									</li>
						</ul>
						</div>
				</div>
				</div>
		<div class="elementor-element elementor-element-7c47117b e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="7c47117b" data-element_type="container">
				<div class="elementor-element elementor-element-c6209e2 elementor-widget elementor-widget-heading" data-id="c6209e2" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h4 class="elementor-heading-title elementor-size-default">Simulation and Emulation</h4>				</div>
				</div>
				<div class="elementor-element elementor-element-4c4cbd23 elementor-icon-list--layout-traditional elementor-list-item-link-full_width elementor-widget elementor-widget-icon-list" data-id="4c4cbd23" data-element_type="widget" data-widget_type="icon-list.default">
				<div class="elementor-widget-container">
							<ul class="elementor-icon-list-items">
							<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/red-team-engagements">

											<span class="elementor-icon-list-text">Red Team – Adversarial Emulation</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/social-engineering-testing">

											<span class="elementor-icon-list-text">Social Engineering Attack Simulation</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/ransomware-attack-simulation">

											<span class="elementor-icon-list-text">Ransomware Attack Simulation</span>
											</a>
									</li>
						</ul>
						</div>
				</div>
				</div>
		<div class="elementor-element elementor-element-4de94cfd e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="4de94cfd" data-element_type="container">
				<div class="elementor-element elementor-element-5b571d67 elementor-widget elementor-widget-heading" data-id="5b571d67" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h4 class="elementor-heading-title elementor-size-default">Compliance and Advisory</h4>				</div>
				</div>
				<div class="elementor-element elementor-element-6870f4aa elementor-icon-list--layout-traditional elementor-list-item-link-full_width elementor-widget elementor-widget-icon-list" data-id="6870f4aa" data-element_type="widget" data-widget_type="icon-list.default">
				<div class="elementor-widget-container">
							<ul class="elementor-icon-list-items">
							<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/framework-consulting">

											<span class="elementor-icon-list-text">Framework Consulting</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/gap-assessments">

											<span class="elementor-icon-list-text">Gap Assessments</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/compliance-as-a-service-caas">

											<span class="elementor-icon-list-text">Compliance-as-a-Service</span>
											</a>
									</li>
								<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/devsecops-engineering">

											<span class="elementor-icon-list-text">DevSecOps Engineering</span>
											</a>
									</li>
						</ul>
						</div>
				</div>
				</div>
		<div class="elementor-element elementor-element-f113810 e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="f113810" data-element_type="container">
				<div class="elementor-element elementor-element-5020e699 elementor-widget elementor-widget-heading" data-id="5020e699" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h4 class="elementor-heading-title elementor-size-default">Incident Response</h4>				</div>
				</div>
				<div class="elementor-element elementor-element-6374f95f elementor-icon-list--layout-traditional elementor-list-item-link-full_width elementor-widget elementor-widget-icon-list" data-id="6374f95f" data-element_type="widget" data-widget_type="icon-list.default">
				<div class="elementor-widget-container">
							<ul class="elementor-icon-list-items">
							<li class="elementor-icon-list-item">
											<a href="https://whiteknightlabs.com/incident-response">

											<span class="elementor-icon-list-text">Incident Response</span>
											</a>
									</li>
						</ul>
						</div>
				</div>
				</div>
		<div class="elementor-element elementor-element-667852e4 e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="667852e4" data-element_type="container">
				<div class="elementor-element elementor-element-18d18b57 elementor-widget-mobile__width-inherit elementor-widget elementor-widget-heading" data-id="18d18b57" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h4 class="elementor-heading-title elementor-size-default">Copyright © <span class="z-date">2026</span> White Knight Labs | All rights reserved</h4>				</div>
				</div>
				</div>
		<div class="elementor-element elementor-element-6e54881 e-con-full e-flex wpr-particle-no wpr-jarallax-no wpr-parallax-no wpr-sticky-section-no e-con e-child" data-id="6e54881" data-element_type="container">
				<div class="elementor-element elementor-element-d52ea8f elementor-widget-mobile__width-inherit elementor-widget elementor-widget-heading" data-id="d52ea8f" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
					<h4 class="elementor-heading-title elementor-size-default"><a href="https://whiteknightlabs.com/contact-us/">Contact Us</a></h4>				</div>
				</div>
				</div>
				</div>
					</div>
				</div>
				</div>
		<span class="wpr-template-edit-btn" data-permalink="https://whiteknightlabs.com/?elementor_library=z-footer">Edit Template</span></div>
						</div>
				</div>
				</div>
				</div>
		
    
    
    	<div class="ald_laser_loader">
		<div class="ald_loader_progress"></div>
	</div>
	

<link rel="modulepreload" href="https://whiteknightlabs.com/wp-includes/js/dist/script-modules/interactivity/index.min.js?ver=66c613f68580994bb00a" id="@wordpress/interactivity-js-modulepreload" fetchpriority="low">

			
					<div class="wp-lightbox-overlay zoom" data-wp-interactive="core/image" data-wp-router-region="{ &quot;id&quot;: &quot;core/image-overlay&quot;, &quot;attachTo&quot;: &quot;body&quot; }" data-wp-key="wp-lightbox-overlay" data-wp-context="{}" data-wp-bind--role="state.roleAttribute" data-wp-bind--aria-label="state.currentImage.ariaLabel" data-wp-bind--aria-modal="state.ariaModal" data-wp-class--active="state.overlayEnabled" data-wp-class--show-closing-animation="state.overlayOpened" data-wp-watch="callbacks.setOverlayFocus" data-wp-on--keydown="actions.handleKeydown" data-wp-on--touchstart="actions.handleTouchStart" data-wp-on--touchmove="actions.handleTouchMove" data-wp-on--touchend="actions.handleTouchEnd" data-wp-on--click="actions.hideLightbox" data-wp-on-window--resize="callbacks.setOverlayStyles" data-wp-on-window--scroll="actions.handleScroll" data-wp-bind--style="state.overlayStyles" tabindex="-1">
				<button type="button" aria-label="Close" style="fill: #000" class="close-button">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false"><path d="m13.06 12 6.47-6.47-1.06-1.06L12 10.94 5.53 4.47 4.47 5.53 10.94 12l-6.47 6.47 1.06 1.06L12 13.06l6.47 6.47 1.06-1.06L13.06 12Z"></path></svg>
				</button>
				<div class="lightbox-image-container">
					<figure data-wp-bind--class="state.currentImage.figureClassNames" data-wp-bind--style="state.figureStyles">
						<img data-wp-bind--alt="state.currentImage.alt" data-wp-bind--class="state.currentImage.imgClassNames" data-wp-bind--style="state.imgStyles" data-wp-bind--src="state.currentImage.currentSrc" alt="" src="https://whiteknightlabs.com/2024/07/31/layeredsyscall-abusing-veh-to-bypass-edrs/">
					</figure>
				</div>
				<div class="lightbox-image-container">
					<figure data-wp-bind--class="state.currentImage.figureClassNames" data-wp-bind--style="state.figureStyles">
						<img data-wp-bind--alt="state.currentImage.alt" data-wp-bind--class="state.currentImage.imgClassNames" data-wp-bind--style="state.imgStyles" data-wp-bind--src="state.enlargedSrc" alt="" src="https://whiteknightlabs.com/2024/07/31/layeredsyscall-abusing-veh-to-bypass-edrs/">
					</figure>
				</div>
				<div class="scrim" style="background-color: #fff" aria-hidden="true"></div>
		</div>






























<span id="elementor-device-mode" class="elementor-screen-only"></span>










<!-- start Simple Custom CSS and JS -->

<!-- end Simple Custom CSS and JS -->


<!-- start Simple Custom CSS and JS -->


<!-- end Simple Custom CSS and JS -->
	

<div><div class="grecaptcha-badge" data-style="bottomright" style="width: 256px; height: 60px; display: block; transition: right 0.3s; position: fixed; bottom: 14px; right: -186px; box-shadow: gray 0px 0px 5px; border-radius: 2px; overflow: hidden;"><div class="grecaptcha-logo"><div title="reCAPTCHA" width="256" height="60" role="presentation" name="a-fe710klijh6r" frameborder="0" scrolling="no" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-top-navigation allow-modals allow-popups-to-escape-sandbox allow-storage-access-by-user-activation" src="https://www.google.com/recaptcha/api2/anchor?ar=1&amp;k=6Ld41o8nAAAAADAuJxe8J3eOEGgDXu8elQwOe0yA&amp;co=aHR0cHM6Ly93aGl0ZWtuaWdodGxhYnMuY29tOjQ0Mw..&amp;hl=en&amp;v=vUgXt_KV952_-5BB2jjloYzl&amp;size=invisible&amp;anchor-ms=20000&amp;execute-ms=30000&amp;cb=ulzydlyi5nnm" data-original-tag="iframe">

<title>reCAPTCHA</title>

<link rel="stylesheet" type="text/css" href="https://www.gstatic.com/recaptcha/releases/vUgXt_KV952_-5BB2jjloYzl/styles__ltr.css">


<div id="rc-anchor-alert" class="rc-anchor-alert"></div>

<div class="rc-anchor rc-anchor-invisible rc-anchor-light  rc-anchor-invisible-hover"><div id="recaptcha-accessible-status" class="rc-anchor-aria-status" aria-hidden="true">Recaptcha requires verification. </div><div class="rc-anchor-error-msg-container" style="display:none"><span class="rc-anchor-error-msg" aria-hidden="true"></span></div><div class="rc-anchor-normal-footer"><div class="rc-anchor-logo-large" role="presentation"><div class="rc-anchor-logo-img rc-anchor-logo-img-large"></div></div><div class="rc-anchor-pt"><a href="https://www.google.com/intl/en/policies/privacy/" target="_blank">Privacy</a><span aria-hidden="true" role="presentation"> - </span><a href="https://www.google.com/intl/en/policies/terms/" target="_blank">Terms</a></div></div><div class="rc-anchor-invisible-text"><span>protected by <strong>reCAPTCHA</strong></span><div class="rc-anchor-pt"><a href="https://www.google.com/intl/en/policies/privacy/" target="_blank" style="">Privacy</a><span aria-hidden="true" role="presentation"> - </span><a href="https://www.google.com/intl/en/policies/terms/" target="_blank" style="">Terms</a></div></div></div><div style="display: none;" data-original-tag="iframe"></div></div></div><div class="grecaptcha-error"></div><textarea id="g-recaptcha-response-100000" name="g-recaptcha-response" class="g-recaptcha-response" style="width: 250px; height: 40px; border: 1px solid rgb(193, 193, 193); margin: 10px 25px; padding: 0px; resize: none; display: none;"></textarea></div></div><div style="background-color: rgb(255, 255, 255); border: 1px solid rgb(204, 204, 204); box-shadow: rgba(0, 0, 0, 0.2) 2px 2px 3px; position: absolute; transition: visibility linear 0.3s, opacity 0.3s linear; opacity: 0; visibility: hidden; z-index: 2000000000; left: 0px; top: -10000px;"><div style="width: 100%; height: 100%; position: fixed; top: 0px; left: 0px; z-index: 2000000000; background-color: rgb(255, 255, 255); opacity: 0.05;"></div><div class="g-recaptcha-bubble-arrow" style="border: 11px solid transparent; width: 0px; height: 0px; position: absolute; pointer-events: none; margin-top: -11px; z-index: 2000000000;"></div><div class="g-recaptcha-bubble-arrow" style="border: 10px solid transparent; width: 0px; height: 0px; position: absolute; pointer-events: none; margin-top: -10px; z-index: 2000000000;"></div><div style="z-index: 2000000000; position: relative;"><div title="recaptcha challenge expires in two minutes" name="c-7xa0237d0zuh" frameborder="0" scrolling="no" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-top-navigation allow-modals allow-popups-to-escape-sandbox allow-storage-access-by-user-activation" src="https://www.google.com/recaptcha/api2/bframe?hl=en&amp;v=vUgXt_KV952_-5BB2jjloYzl&amp;k=6Lf5uk4qAAAAADW8LDQroQXmnKEJ9v6E92gR0Rn9&amp;bft=0dAFcWeA773wWIFkGUrDHnxr_jRwi8P4e4I84qyTgWZs5M2RetetdoKZ-abU5U8eCSsj4f3dYI6BgY8OxYPhgWv5mjbKYjenMdPg" style="width: 100%; height: 100%;" data-original-tag="iframe">


<title>reCAPTCHA</title>

<link rel="stylesheet" type="text/css" href="https://www.gstatic.com/recaptcha/releases/vUgXt_KV952_-5BB2jjloYzl/styles__ltr.css">



<div></div></div></div></div></body></html>