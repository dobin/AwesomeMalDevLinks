# https://tishina.in/execution/phase-dive-sleep-obfuscation

<!DOCTYPE html><html lang="en"><body class="styled-scrollbars theme-dark">
<div class="published-container print is-readable-line-width has-navigation has-outline" style=""><div class="site-body"><div class="site-body-left-column"><div class="site-body-left-column-inner"><a class="site-body-left-column-site-logo" aria-label=" logo" href="https://tishina.in/home"><img aria-hidden="true" src="https://publish-01.obsidian.md/access/c7ce07c5421851d0d6a9c4b6320620d9/images/simple.png" style=""></a><a class="site-body-left-column-site-name" aria-label="" href="https://tishina.in/home"></a><div class="site-body-left-column-site-theme-toggle" style="display: none;"></div><div class="search-view-outer"><div class="search-view-container"><span class="published-search-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-search"><path d="m21 21-4.34-4.34"></path><circle cx="11" cy="11" r="8"></circle></svg></span><input class="search-bar" tabindex="0" type="text" placeholder="Search page or heading..."></div></div><div class="nav-view-outer"><div class="nav-view"><div class="tree-item"><div class="tree-item-self mod-root is-clickable" data-path=""><div class="tree-item-inner"></div></div><div class="tree-item-children"><div class="tree-item is-collapsed"><div class="tree-item-self mod-collapsible is-clickable" data-path="appsec"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner">appsec</div></div></div><div class="tree-item"><div class="tree-item-self mod-collapsible is-clickable" data-path="execution"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner">execution</div></div><div class="tree-item-children" style=""><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/bof-lazy-loading.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/bof-lazy-loading">bof-lazy-loading</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/byovm.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/byovm">byovm</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/caveman-bofs.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/caveman-bofs">caveman-bofs</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/DOUBLEGOD-and-insomnia-loader.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/DOUBLEGOD-and-insomnia-loader">DOUBLEGOD-and-insomnia-loader</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/golang-winmaldev-basics.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/golang-winmaldev-basics">golang-winmaldev-basics</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/linux-evasion-primitives.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/linux-evasion-primitives">linux-evasion-primitives</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/nim-fibers.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/nim-fibers">nim-fibers</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/nim-noload-dll-hollowing.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/nim-noload-dll-hollowing">nim-noload-dll-hollowing</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable mod-active" data-path="execution/phase-dive-sleep-obfuscation.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/phase-dive-sleep-obfuscation">phase-dive-sleep-obfuscation</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/pyd-execute-assembly.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/pyd-execute-assembly">pyd-execute-assembly</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/python-inmemory-bof.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/python-inmemory-bof">python-inmemory-bof</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="execution/replacing-memfd-with-fuse.md"><div class="tree-item-inner"><a href="https://tishina.in/execution/replacing-memfd-with-fuse">replacing-memfd-with-fuse</a></div></div></div></div></div><div class="tree-item is-collapsed"><div class="tree-item-self mod-collapsible is-clickable" data-path="initial-access"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner">initial-access</div></div></div><div class="tree-item is-collapsed"><div class="tree-item-self mod-collapsible is-clickable" data-path="ops"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner">ops</div></div></div><div class="tree-item is-collapsed"><div class="tree-item-self mod-collapsible is-clickable" data-path="opsec"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner">opsec</div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="home.md"><div class="tree-item-inner"><a href="https://tishina.in/home">home</a></div></div></div></div></div></div></div></div></div><div class="site-body-center-column"><div class="site-header"><div class="clickable-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-menu"><path d="M4 5h16"></path><path d="M4 12h16"></path><path d="M4 19h16"></path></svg></div><a class="site-header-logo" aria-hidden="true" href="https://tishina.in/home" style=""><img src="https://publish-01.obsidian.md/access/c7ce07c5421851d0d6a9c4b6320620d9/images/simple.png"></a><a class="site-header-text" href="https://tishina.in/home"></a></div><div class="render-container"><div class="render-container-inner"><div class="publish-renderer"><div class="markdown-preview-view markdown-rendered node-insert-event" tabindex="-1" style="outline: none;"><div class="markdown-preview-sizer markdown-preview-section" style="padding-bottom: 0px;"><div class="markdown-preview-pusher" style="width: 1px; height: 0.1px; margin-bottom: 0px;"></div><div class="mod-header mod-ui"><h1 class="page-header">phase-dive-sleep-obfuscation</h1></div><div class="el-h1"><h1 data-heading="tl;dr" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>tl;dr <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">PoC: <a rel="noopener nofollow" class="external-link" href="https://github.com/zimnyaa/PhaseDive/" target="_blank">https://github.com/zimnyaa/PhaseDive/</a></p></div><div class="el-p"><p dir="auto">This post explains the idea behind the PhaseDive Ekko fork meant to complicate <a data-tooltip-position="top" aria-label="https://github.com/Cracked5pider/Ekko" rel="noopener nofollow" class="external-link" href="https://github.com/Cracked5pider/Ekko" target="_blank">Ekko</a> detection with <a rel="noopener nofollow" class="external-link" href="https://github.com/WithSecureLabs/TickTock" target="_blank">https://github.com/WithSecureLabs/TickTock</a>.</p></div><div class="el-p"><p dir="auto">Before:<br>
<span alt="Pasted image 20221013181445.png" src="Pasted image 20221013181445.png" class="internal-embed image-embed is-loaded"><img alt="Pasted image 20221013181445.png" src="https://publish-01.obsidian.md/access/c7ce07c5421851d0d6a9c4b6320620d9/images/Pasted%20image%2020221013181445.png"></span><br>
After:<br>
<span alt="Pasted image 20221013182614.png" src="Pasted image 20221013182614.png" class="internal-embed image-embed is-loaded"><img alt="Pasted image 20221013182614.png" src="https://publish-01.obsidian.md/access/c7ce07c5421851d0d6a9c4b6320620d9/images/Pasted%20image%2020221013182614.png"></span></p></div><div class="el-h1"><h1 data-heading="Ekko idea" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Ekko idea <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">The main idea of the Ekko sleep obfuscation technique is creating a chain of timers with CreateTimerQueueTimer that point to NtContinue as a callback:</p></div><div class="el-pre"><pre class="language-c"><code data-line="0" class="language-c is-loaded"><span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> NtContinue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RopProtRW<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> NtContinue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RopMemEnc<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> NtContinue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RopDelay<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> NtContinue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RopMemDec<span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> NtContinue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RopProtRX<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> NtContinue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RopSetEvt<span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">By populating the <code>CONTEXT</code> struct, it is possible to use NtContinue with a single argument to make arbitrary calls by populating the registers with arguments:</p></div><div class="el-pre"><pre class="language-c"><code data-line="0" class="language-c is-loaded"><span class="token comment">// VirtualProtect( ImageBase, ImageSize, PAGE_EXECUTE_READWRITE, &amp;OldProtect );</span>
        RopProtRX<span class="token punctuation">.</span>Rsp  <span class="token operator">-=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>Rip   <span class="token operator">=</span> VirtualProtect<span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>Rcx   <span class="token operator">=</span> ImageBase<span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>Rdx   <span class="token operator">=</span> ImageSize<span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>R8    <span class="token operator">=</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>R9    <span class="token operator">=</span> <span class="token operator">&amp;</span>OldProtect<span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The timer chain thus is able to execute several functions in order without the need for the main image to be executed. This is used to change the protection of the main module, encrypt it, sleep, and revert the changes.</p></div><div class="el-h1"><h1 data-heading="Ekko detection" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Ekko detection <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">WithSecure have recently released a post with a PoC tool at <a rel="noopener nofollow" class="external-link" href="https://github.com/WithSecureLabs/TickTock" target="_blank">https://github.com/WithSecureLabs/TickTock</a> to detect Ekko. It is best explained in the article, but the main idea is scanning the process memory for timers, enumerating callback functions for these timers for any discovered references to <code>NtContinue</code>, and peeking <code>CONTEXT</code> structs.<br>
The detection result looks something like this:<br>
<span alt="Pasted image 20221013181445.png" src="Pasted image 20221013181445.png" class="internal-embed image-embed is-loaded"><img alt="Pasted image 20221013181445.png" src="https://publish-01.obsidian.md/access/c7ce07c5421851d0d6a9c4b6320620d9/images/Pasted%20image%2020221013181445.png"></span></p></div><div class="el-h1"><h1 data-heading="Trampoline bypasses" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Trampoline bypasses <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">It is evident that a huge chunk of visibility into what timers are doing is due to symbol resolution, which is easiest to bypass with trampolines.</p></div><div class="el-h2"><h2 data-heading="`CONTEXT.Rip` -> `VirtualProtect` detection" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span><code>CONTEXT.Rip</code> -&gt; <code>VirtualProtect</code> detection <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h2></div><div class="el-p"><p dir="auto">Suppose the detection logic is based upon resolving the functions the timers use as a callback. By finding a <code>jmp</code> gadget and using it like shown below, we can blind this detection.</p></div><div class="el-pre"><pre class="language-c"><code data-line="0" class="language-c is-loaded"><span class="token comment">// VirtualProtect( ImageBase, ImageSize, PAGE_EXECUTE_READWRITE, &amp;OldProtect );</span>
        RopProtRX<span class="token punctuation">.</span>Rsp  <span class="token operator">-=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>Rip   <span class="token operator">=</span> VirtualProtect<span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>Rcx   <span class="token operator">=</span> ImageBase<span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>Rdx   <span class="token operator">=</span> ImageSize<span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>R8    <span class="token operator">=</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>R9    <span class="token operator">=</span> <span class="token operator">&amp;</span>OldProtect<span class="token punctuation">;</span>
<span class="token comment">// IS CHANGED TO</span>
 <span class="token comment">// VirtualProtect( ImageBase, ImageSize, PAGE_EXECUTE_READWRITE, &amp;OldProtect );</span>
        RopProtRX<span class="token punctuation">.</span>Rsp  <span class="token operator">-=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>Rax   <span class="token operator">=</span> VirtualProtect<span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>Rip   <span class="token operator">=</span> ntdll_jmprax<span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>Rcx   <span class="token operator">=</span> ImageBase<span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>Rdx   <span class="token operator">=</span> ImageSize<span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>R8    <span class="token operator">=</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">;</span>
        RopProtRX<span class="token punctuation">.</span>R9    <span class="token operator">=</span> <span class="token operator">&amp;</span>OldProtect<span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The resulting detection is as follows:<br>
<span alt="Pasted image 20221013181947.png" src="Pasted image 20221013181947.png" class="internal-embed image-embed is-loaded"><img alt="Pasted image 20221013181947.png" src="https://publish-01.obsidian.md/access/c7ce07c5421851d0d6a9c4b6320620d9/images/Pasted%20image%2020221013181947.png"></span><br>
It is possible to spoof a wide range of functions by using different gadgets to redirect control flow.</p></div><div class="el-h2"><h2 data-heading="`NtContinue` timer detections" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span><code>NtContinue</code> timer detections <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h2></div><div class="el-p"><p dir="auto">But what if detections are designed to alert on <strong>any</strong> timers that point to <code>NtContinue</code>? It turns out that <code>ntdll.dll</code> has several <code>call &lt;ntdll.ZwContinue&gt;</code> gadgets we can use. I've baked mine statically into a PoC and probably broke something, so it needs to be changed to test on a different Windows installation.</p></div><div class="el-p"><p dir="auto">Thus, the timer queue became this:</p></div><div class="el-pre"><pre class="language-c"><code data-line="0" class="language-c is-loaded">        <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> ntdll_callzw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RopProtRW<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> ntdll_callzw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RopMemEnc<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> ntdll_callzw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RopDelay<span class="token punctuation">,</span>  <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> ntdll_callzw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RopMemDec<span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> ntdll_callzw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RopProtRX<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> ntdll_callzw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RopSetEvt<span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">And the detection was not able to properly resolve the functions:<br>
<span alt="Pasted image 20221013182614.png" src="Pasted image 20221013182614.png" class="internal-embed image-embed is-loaded"><img alt="Pasted image 20221013182614.png" src="https://publish-01.obsidian.md/access/c7ce07c5421851d0d6a9c4b6320620d9/images/Pasted%20image%2020221013182614.png"></span><br>
The timer callback calls were still doing the things they were supposed to, which is sleep masking:<br>
<span alt="Pasted image 20221013182709.png" src="Pasted image 20221013182709.png" class="internal-embed image-embed is-loaded"><img alt="Pasted image 20221013182709.png" src="https://publish-01.obsidian.md/access/c7ce07c5421851d0d6a9c4b6320620d9/images/Pasted%20image%2020221013182709.png"></span><br>
<span alt="Pasted image 20221013182700.png" src="Pasted image 20221013182700.png" class="internal-embed image-embed is-loaded"><img alt="Pasted image 20221013182700.png" src="https://publish-01.obsidian.md/access/c7ce07c5421851d0d6a9c4b6320620d9/images/Pasted%20image%2020221013182700.png"></span></p></div><div class="el-h1"><h1 data-heading="credits" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>credits <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">C5pider for Ekko<br>
WithSecureLabs for detection research</p></div><div class="mod-footer mod-ui"></div></div></div><div class="extra-title"><span class="extra-title-text">phase-dive-sleep-obfuscation</span><span aria-label="Close page" role="button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></span></div></div></div><div class="not-found-container" style="display: none;"><div class="not-found-image"></div><div class="not-found-title">Not found</div><div class="not-found-description">This page does not exist</div></div><div class="site-body-right-column"><div class="site-body-right-column-inner"><div class="graph-view-outer"><div class="list-item published-section-header"><span class="published-section-header-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-git-fork"><circle cx="12" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="6" r="3"></circle><path d="M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9"></path><path d="M12 12v3"></path></svg></span><span>Interactive graph</span></div><div class="graph-view-container"><div class="graph-view" style="display: none;"></div><div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-arrow-up-right"><path d="M7 7h10v10"></path><path d="M7 17 17 7"></path></svg></div><div class="graph-icon graph-global" role="button" aria-label="Global Graph" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-git-fork"><circle cx="12" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="6" r="3"></circle><path d="M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9"></path><path d="M12 12v3"></path></svg></div></div></div><div class="outline-view-outer node-insert-event"><div class="list-item published-section-header"><span class="published-section-header-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-list"><path d="M3 5h.01"></path><path d="M3 12h.01"></path><path d="M3 19h.01"></path><path d="M8 5h13"></path><path d="M8 12h13"></path><path d="M8 19h13"></path></svg></span><span>On this page</span></div><div class="outline-view"><div class="tree-item"><div class="tree-item-self is-clickable mod-active"><div class="tree-item-inner">tl;dr</div></div><div class="tree-item-children"></div></div><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">Ekko idea</div></div><div class="tree-item-children"></div></div><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">Ekko detection</div></div><div class="tree-item-children"></div></div><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">Trampoline bypasses</div></div><div class="tree-item-children"><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">CONTEXT.Rip -&gt; VirtualProtect detection</div></div><div class="tree-item-children"></div></div><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">NtContinue timer detections</div></div><div class="tree-item-children"></div></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">credits</div></div><div class="tree-item-children"></div></div></div></div></div></div></div><div class="site-footer"><a href="https://publish.obsidian.md/" target="_blank">Powered by Obsidian Publish</a></div></div></div><div class="nav-backdrop"></div></div></body></html>