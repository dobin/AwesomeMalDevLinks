Title:
Doubling Down: Detecting In-Memory Threats with Kernel ETW Call Stacks

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes how Elastic Security 8.11 expands kernel-level ETW (Threat-Intelligence provider) telemetry with call stack context to improve detection of in-memory attacks on Windows.  
- It addresses the fragility of user-mode API hooking (often bypassed via direct syscalls, unhooking, or call stack spoofing) by relying on kernel ETW visibility for security-relevant syscalls/APIs.  
- The authors explain implementation tradeoffs (event volume, deduplication, on-host processing vs SIEM streaming) and list newly instrumented APIs like VirtualAlloc/VirtualProtect/MapViewOfFile/WriteProcessMemory and injection-adjacent primitives.  
- Events are enriched with behavioral tags (e.g., direct_syscall, native_api, proxy_call, image_rop, unbacked_rwx, hollow_image) derived from call stack and memory characteristics.  
- The post includes example detection rules for direct/indirect syscalls, module stomping/image hollowing from unbacked memory, AMSI/WLDP patching, ETW patching, and remote hooking of NTDLL/KernelBase.  
- It’s most useful for blue teams and detection engineers building high-fidelity Windows in-memory threat detections, and for red teams to understand what kernel-callstack-aware EDR logic is keying on.

Technical Focus:
- Kernel ETW (Microsoft-Windows-Threat-Intelligence) telemetry and call stack capture
- In-memory tradecraft detection: injection, hollowing/stomping, RWX/unbacked memory
- Direct syscalls / indirect syscalls and NTDLL provenance validation
- Call stack analysis for proxying, ROP, indirect calls, and synthetic frames
- AMSI/WLDP and ETW patching detection via memory protection/write telemetry
- Telemetry engineering: deduplication, host-side detection vs SIEM streaming

Use Cases:
- Detect direct-syscall based injection chains that bypass user-mode hooks
- Identify suspicious VirtualProtect/VirtualAlloc patterns (permission “fluctuation”, RWX, PAGE_GUARD/NOACCESS)
- Hunt for module stomping / image hollowing originating from unbacked memory regions
- Alert on AMSI/WLDP tampering and ETW patching attempts in ntdll/related modules
- Detect remote process manipulation (WriteProcessMemory, APC injection, thread context changes) with call stack context
- Reduce alert triage time by using call stack summaries to attribute true callers

Keywords:
ETW, Microsoft-Windows-Threat-Intelligence, kernel telemetry, call stacks, Elastic Defend, Windows internals, VirtualAlloc, VirtualProtect, MapViewOfFile, WriteProcessMemory, QueueUserAPC, SetThreadContext, direct syscall, indirect syscall, NTDLL, NtProtectVirtualMemory, code injection, process hollowing, module stomping, AMSI bypass, WLDP, ETW patching, ROP, call stack spoofing, unbacked memory, RWX, detection engineering