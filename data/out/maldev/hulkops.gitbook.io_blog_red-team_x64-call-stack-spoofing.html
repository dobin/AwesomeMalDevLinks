# https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing

<!DOCTYPE html><html lang="en" class="rounded-corners theme-clean no-tint sidebar-default sidebar-list-default links-default depth-subtle __variable_7d5705 __variable_4d8f45 __variable_7857c7 font-Inter sheet-open:gutter-stable dark" style="color-scheme: dark;"><body class="site-background sheet-open:overflow-hidden"><div><!--$--><!--/$--></div><div class="pointer-events-none fixed inset-x-0 top-0 z-50 h-0.5 overflow-hidden hidden animate-fade-out-slow"><div class="h-full w-full origin-left animate-crawl bg-primary-solid theme-bold:bg-header-link"></div></div><div class="motion-safe:transition-all motion-safe:duration-300 lg:chat-open:mr-80 xl:chat-open:mr-96"><div class="flex flex-col lg:flex-row lg:justify-center px-4 pl-[max(env(safe-area-inset-left),1rem)] pr-[max(env(safe-area-inset-right),1rem)] sm:px-6 sm:pl-[max(env(safe-area-inset-left),1.5rem)] sm:pr-[max(env(safe-area-inset-right),1.5rem)] md:px-8 md:pl-[max(env(safe-area-inset-left),2rem)] md:pr-[max(env(safe-area-inset-right),2rem)] max-w-screen-2xl mx-auto site-width-wide:max-w-screen-4xl transition-[max-width] duration-300"><div id="side-sheet-overlay" class="fixed inset-0 z-40 items-start bg-tint-base/3 not-hydrated:opacity-0 starting:opacity-0 starting:backdrop-blur-none transition-[opacity,display,backdrop-filter] transition-discrete duration-250 dark:bg-tint-base/6 hidden opacity-0 backdrop-blur-none"></div><div class="contents"><div class="contents [--content-scroll-margin:calc(var(--spacing)*16)]"><main class="relative min-w-0 flex-1 max-w-screen-2xl py-8 break-anywhere @container page-width-default site-width-default page-has-toc"><div class="flex flex-col [&amp;>*+*]:mt-5 whitespace-pre-wrap"><h2 id="preface" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#preface"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_838qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_838qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Preface</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">In my previous blog, I discussed an implementation of x64 return address spoofing. While this technique spoofs the return address, it has a significant drawback: Spoofing the return address breaks the call stack chain and leads to easy detection. In this blog, we will build upon return address spoofing and look at spoofing the call stack of a thread.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This technique is not new, and extensive research has been done by <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://x.com/namazso"><code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">namazso</code> <svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_14g78qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_14g78qav5ukqiv5ubsnpfivb_)"></rect></svg></a>, <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://x.com/klezvirus"><code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">KlezVirus</code><svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_15078qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_15078qav5ukqiv5ubsnpfivb_)"></rect></svg></a>, <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://x.com/waldoirc"><code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">waldoirc</code><svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_15g78qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_15g78qav5ukqiv5ubsnpfivb_)"></rect></svg></a>, <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://x.com/trickster012"><code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">trickster012</code><svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_16078qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_16078qav5ukqiv5ubsnpfivb_)"></rect></svg></a>, and others. The aim of this blog will be to break down this technique into simpler parts and discuss how to implement call stack spoofing while calling any WinAPI. </p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The code for this project can be found on my <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://github.com/HulkOperator/CallStackSpoofer">GitHub<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_9g98qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9g98qav5ukqiv5ubsnpfivb_)"></rect></svg></a>.</p><h2 id="introduction" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#introduction"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_8b8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_8b8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Introduction</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This post will delve into the implementation of creating synthetic stack frames to mask the origin of API calls. By doing so, we can trick security solutions that monitor the call stacks to detect tampering with return addresses. First, let's observe the broken call stack from "return address spoofing".</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="eager" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252FGNGs2HhTHhPjvwh5wYAq%252Fret_addr_issue.png%3Falt%3Dmedia%26token%3D3339d1ee-d1ea-435c-ad00-f0dab1036576&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=37ceb855&amp;sv=2" width="394" height="242"></div><figcaption class="text-xs text-center text-tint mt-2">Incomplete Stack Unwinding</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The above image of a thread's call stack is an example of incomplete stack unwinding. The value of "0x4" is a leaked memory value, suggesting that the stack unwinding was terminated. In contrast, a thread with proper unwinding should be as follows:</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252F0s3ziTi89Do7YbS2iUZA%252Fnormal_stack_unwinding.png%3Falt%3Dmedia%26token%3D4139a6c0-ccbc-4840-ab0b-a2d84845e569&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=bb8152f4&amp;sv=2" width="393" height="292"></div><figcaption class="text-xs text-center text-tint mt-2">Normal Call Stack</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">By spoofing the call stack while calling an API, we will create synthetic stack frames with proper stack unwinding and then spoof the return address.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Before diving deep into the implementation, it's essential to understand how the x64 stack works.</p><h2 id="x64-stack-frame" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#x64-stack-frame"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_8p8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_8p8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">x64 Stack Frame</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The stack is a memory region within a process where space is allocated for functions to store their dependencies. The dependencies include allocating space for local variables and saving non-volatile registers. If a function modifies the non-volatile registers, it will be restored from the values saved on the stack.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Each function has its own stack frame, and when a function's execution has been completed, this frame is deallocated. Below is a simple demonstration of how the stack frame for the "Func" function is allocated and deallocated.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252FeGIpIYqmvgRpARU8iOLm%252Fstack.gif%3Falt%3Dmedia%26token%3D6782db36-d5ae-4666-9f69-faf0ffc1d893&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=fb217222&amp;sv=2" width="591" height="482"></div><figcaption class="text-xs text-center text-tint mt-2">Stack Allocation &amp; Deallocation</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Following is the disassembly of a simple function, which can be divided into three parts. The first is the function's prologue, the second is the function's body, and the last is the function's epilogue. The function's prologue is responsible for saving non-volatile registers and making space on the stack. On the other hand, the function's epilogue will reverse these instructions to deallocate the stack space and restore the values of non-volatile registers.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252FJDOVP1E6ZZGZZT9jQ6am%252Ffunction_stack.png%3Falt%3Dmedia%26token%3D90fa22d5-603a-4755-97bb-126d0114df02&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=6c430be4&amp;sv=2" width="343" height="427"></div><figcaption class="text-xs text-center text-tint mt-2">Function's Assembly</figcaption></picture></div></div></div><h2 id="call-stack" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#call-stack"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_958qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_958qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Call Stack</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">A Call stack represents all the functions that were called by the thread to reach its current execution state. In the image below, the execution is currently waiting at "NtUserWaitMessage+x014"; this function was called by "DialogBoxIndirectParamAorW". Going further down, we can see that the "MessageBoxA" was called by the "main" function, which is our code. Finally, the last two frames are called as Thread Initialising frames.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252FbdtPpT3GKYqk7zTQiPSJ%252Fcall_stack.png%3Falt%3Dmedia%26token%3D31147199-e0f8-4b5c-ba94-1dd6f20e31f0&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=1814be1b&amp;sv=2" width="397" height="330"></div><figcaption class="text-xs text-center text-tint mt-2">Call Stack of a thread executing MessageBoxA</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">At the current execution state, this is how the stack of the thread looks like</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252F0ovuhL7npjo4GiXhL3rq%252Fstack_values.png%3Falt%3Dmedia%26token%3D2987cc8f-6ea7-4a27-87b5-e8d5fc693a97&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=e9eec57c&amp;sv=2" width="554" height="545"></div><figcaption class="text-xs text-center text-tint mt-2">Entire Stack of a Thread</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">A quick and dirty approach to implementing stack spoofing would be to create a synthetic call stack using these values. However, this will not be a robust implementation and will fail across different builds/ versions of Windows. To avoid such issues, we need to identify the size of each stack frame dynamically, i.e., the size of the "RtlUserThreadStart" Frame, "BaseThreadInitThunk" Frame, etc.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">To dynamically calculate the stack size, we need to understand Exception Handling in Windows and the ".PDATA" section.</p><h2 id="exception-handling-and-.pdata" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#exception-handling-and-.pdata"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_9j8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9j8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Exception Handling &amp; .PDATA</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">When an exception is raised, the "exception dispatcher" checks if any exception handler is defined in the current function. If a handler doesn't exist, then the function's stack is unwound to restore the stack of the caller's frame and an exception handler is checked in the caller's function. This process is repeated until an exception handler is found or the whole call stack is unwound. The information required to unwind the stack of a function is defined within the ".PDATA" section. This section contains an array of "RUNTIME_FUNCTION" structures.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252F5Apx5ISvGwfUdOxeSH8W%252Fruntime_function.png%3Falt%3Dmedia%26token%3D484e18ce-027d-43d7-a0a0-18c23f78e34e&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=e5ec8b97&amp;sv=2" width="845" height="234"></div><figcaption class="text-xs text-center text-tint mt-2">RUNTIME_FUNCTION Structure</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This structure contains the offset to the addresses of a function's start and end instructions. Additionally, it includes the offset to the "UNWIND_INFO" structure.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252F3zBksLE2RW1tMLbsADtN%252Funwind_info.png%3Falt%3Dmedia%26token%3D7b525fc4-a3b1-4f4a-9df8-eec070340dce&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=d1bd88fd&amp;sv=2" width="529" height="418"></div><figcaption class="text-xs text-center text-tint mt-2">UNWIND_INFO</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The "UNWIND_INFO" structure contains an array of "UnwindCodes" and their count. Unwind Codes represent the instructions that are executed in a function's prologue. By going through this, we can calculate the size of the stack. We will consider only the following four Unwind Codes as they modify the size of a function's stack:</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">UWOP_ALLOC_SMALL</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">UWOP_PUSH_NONVOL</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">UWOP_ALLOC_LARGE</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">UWOP_PUSH_MACHFRAME</p></div></li></ul><h3 id="calculating-the-size-of-a-functions-stack" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#calculating-the-size-of-a-functions-stack"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_a18qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_a18qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Calculating the Size of a Function's Stack</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The first step is to obtain the address of the ".PDATA" section. This will be done using the below code:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_258qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">typedef struct _EXCEPTION_INFO {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	UINT64 hModule;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	UINT64 pExceptionDirectory;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	DWORD dwRuntimeFunctionCount;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">}EXCEPTION_INFO, *PEXCEPTION_INFO;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">PVOID RetExceptionAddress(PEXCEPTION_INFO pExceptionInfo) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	UINT64 pImgNtHdr, hModule;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	PIMAGE_OPTIONAL_HEADER64 pImgOptHdr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	hModule = pExceptionInfo-&gt;hModule;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	pImgNtHdr = hModule + ((PIMAGE_DOS_HEADER)hModule)-&gt;e_lfanew;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	pImgOptHdr = &amp;((PIMAGE_NT_HEADERS64)pImgNtHdr)-&gt;OptionalHeader;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	pExceptionInfo-&gt;pExceptionDirectory = hModule + pImgOptHdr-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_EXCEPTION].VirtualAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	pExceptionInfo-&gt;dwRuntimeFunctionCount = pImgOptHdr-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_EXCEPTION].Size / sizeof(RUNTIME_FUNCTION);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Using the ".PDATA" Section, we can calculate a function's stack size</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_298qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">DWORD RetStackSize(UINT64 hModule, UINT64 pFuncAddr) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	EXCEPTION_INFO sExceptionInfo = { 0 };<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	sExceptionInfo.hModule = hModule;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	RetExceptionAddress(&amp;sExceptionInfo);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	PRUNTIME_FUNCTION pRuntimeFunction = (PRUNTIME_FUNCTION)sExceptionInfo.pExceptionDirectory;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	DWORD dwStackSize = 0, dwFuncOffset = pFuncAddr - hModule;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	PUNWIND_INFO pUnwindInfo;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	PUNWIND_CODE pUnwindCode;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	// Loop Through RunTimeFunction structures until we find the structure for our target function<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	for (int i = 0; i &lt; sExceptionInfo.dwRuntimeFunctionCount; i++) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		if (dwFuncOffset &gt;= pRuntimeFunction-&gt;BeginAddress &amp;&amp; dwFuncOffset &lt;= pRuntimeFunction-&gt;EndAddress) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			break;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">		pRuntimeFunction++;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	// From the RunTimeFunction structure we need the offset to UnwindInfo structure<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	pUnwindInfo = ((PUNWIND_INFO)(hModule + pRuntimeFunction-&gt;UnwindInfoAddress));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	pUnwindCode = pUnwindInfo-&gt;UnwindCode; // UnwindCode Array<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // Loop Through the UnwindCodesArray and calculate Stack Size<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	for (int i = 0; i &lt; pUnwindInfo-&gt;CountOfUnwindCodes; i++) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">		UBYTE bUnwindCode = pUnwindCode[i].OpInfo;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">		switch (bUnwindCode)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		case UWOP_ALLOC_SMALL:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			dwStackSize += (pUnwindCode[i].OpInfo + 1) * 8;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			break;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		case UWOP_PUSH_NONVOL:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			if (pUnwindCode[i].OpInfo == 4)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				return 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			dwStackSize += 8;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			break;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		case UWOP_ALLOC_LARGE:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			if (pUnwindCode[i].OpInfo == 0) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				dwStackSize += pUnwindCode[i + 1].FrameOffset * 8;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				i++;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			else {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				dwStackSize += *(ULONG*)(&amp;pUnwindCode[i + 1]);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				i += 2;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			break;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		case UWOP_PUSH_MACHFRAME:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			if (pUnwindCode[i].OpInfo == 0)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				dwStackSize += 40;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				dwStackSize += 48;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		case UWOP_SAVE_NONVOL:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			i++;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			break;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		case UWOP_SAVE_NONVOL_FAR:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			i += 2;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			break;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		default:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			break;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Using the above code snippets, we can dynamically figure out the stack size of any function during runtime.</p><h3 id="gadget" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#gadget"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_ad8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_ad8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Gadget</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">To hide the return address of our code, we will be using JOP Gadgets as return addresses, which will, in turn, direct the execution flow back to us. An example of a JOP gadget is <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">jmp QWORD PTR [rbx]</code>. When this gets executed, the control flow is transferred to the address pointed by the value in <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">rbx</code>. Additionally, we can use any non-volatile register for this.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Using the following code snippet, we can obtain the address of our gadget within any module.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_2j8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">PVOID RetGadget(UINT64 hModule) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	PVOID pGadget = NULL;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	int r = rand() % 2, count = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	DWORD dwSize = ((PIMAGE_NT_HEADERS64)(hModule + ((PIMAGE_DOS_HEADER)hModule)-&gt;e_lfanew))-&gt;OptionalHeader.SizeOfImage;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	for (int i = 0; i &lt; dwSize - 1; i++) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">		if (((PBYTE)hModule)[i] == 0xff &amp;&amp; ((PBYTE)hModule)[i+1] == 0x23) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			pGadget = hModule + i;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			if (count &gt;= r) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				break;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">			count ++;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	return pGadget;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><h2 id="spoofing-the-stack" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#spoofing-the-stack"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_al8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_al8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Spoofing the Stack</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">In this section, we'll cover the steps for creating a synthetic stack frame.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252Fzt4fV0aOaVDHSJkZ1llL%252Fspoof_stack.jpeg%3Falt%3Dmedia%26token%3D3bb02ac0-94c1-4817-960d-de701044ac97&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=b1f0bbad&amp;sv=2" width="1280" height="958"></div><figcaption class="text-xs text-center text-tint mt-2">Call Stack Spoofing Flow</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Creating synthetic stack frames will be done using our "Spoof" function, which will be written in assembly. This function does the following steps:</p><ol class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'1.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Push "0" on the stack, which will terminate the stack unwinding.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'2.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Make space on the stack for "RtlUserThreadStart" Frame.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'3.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Push the Return Address "RtlUserThreadStart+0x21" on the stack.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'4.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Make space on the stack for "BaseThreadInitThunk" Frame.<!-- --></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'5.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Push the Return Address "BaseThreadInitThunk+0x14" on the stack.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'6.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Make space on the stack for our Gadget's Frame.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'7.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Push the Return Address to our gadget on the stack.</p></div></li></ol><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252FgChBOF96oKsEPpgk0GSk%252Fspoof_stack2.jpeg%3Falt%3Dmedia%26token%3D2e8dfcff-7e94-4181-9f47-92fa237594d8&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=ec0da6c3&amp;sv=2" width="1280" height="720"></div><figcaption class="text-xs text-center text-tint mt-2">Spoofed Stack Frames</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The above image represents the spoofed part of the stack. Before executing our WinAPI, we need to configure the required arguments. Windows x64 uses the fastcall calling convention. The first four arguments are stored in the registers <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">rcx</code>, <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">rdx</code>, <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">r8</code>, and <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">r9</code>. Any additional arguments are pushed to the stack from right to left. Then, 4 bytes of space are allocated on the stack, which is called as shadow space. After this, the WinAPI is called.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Since we have already created our spoofed stack frames, we cannot push or pop any values, as that would break the chain. Instead, we need to configure additional arguments on the existing stack, as depicted in the above image.</p><h2 id="assembly" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#assembly"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_b58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_b58qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Assembly</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">When writing code in high-level languages such as 'C', all the steps, including management of registers and modification of stack during a function call or when the function returns, are abstracted away. However, we need control over how the stack behaves; hence, we will be writing this section entirely in assembly.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">By using a structure to pass arguments to our "Spoof" function, the process of accessing all the arguments becomes simpler.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252Fy5Eq08ANA2BOjS8xrytZ%252Fstruct_def.png%3Falt%3Dmedia%26token%3D7d5eae6d-a59b-4007-9a47-f930d6305f7c&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=cb32257a&amp;sv=2" width="303" height="269"></div><figcaption class="text-xs text-center text-tint mt-2">STACK_INFO Struct</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The following series of instructions creates our synthetic stack frames.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252FDeIkXVPt6AhvlYYqfEuy%252Fassembly_1.png%3Falt%3Dmedia%26token%3Dc4d5d0ff-c553-462b-b027-7d99e2687c06&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=f438e3cb&amp;sv=2" width="1210" height="539"></div><figcaption class="text-xs text-center text-tint mt-2">Assembly Code - Part 1</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Now, we need to configure the arguments required for our target function.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252FDQqOaE6BeCN3XaFQCI5i%252Fassembly_2.png%3Falt%3Dmedia%26token%3D694499c1-4a1d-4400-8cb7-0c8bed575663&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=ca22e856&amp;sv=2" width="1068" height="388"></div><figcaption class="text-xs text-center text-tint mt-2">Assembly Code - Part 2</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Half the part is done. Technically, what we have done until now will spoof the stack and successfully execute our target API. However, when the API call returns, the program will crash. This is because we haven't configured our gadget yet.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">To avoid the crash, we have to revert the stack back to its original state. Hence, we will store the pointer to restore the stack within <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">rbx</code>. And when the gadget is executed control flow is given back to us.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Now, it's time to execute our target API, which will be done by using <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">jmp</code> instruction to our target API's address. Note that we are using the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">jmp</code> instruction instead of the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">call</code> instruction. If <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">call</code> is used, it pushes the current function's address on the stack. Instead, by using <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">jmp</code>, our gadget's address will act as the return address, indicating that the gadget's function is responsible for the call.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252F0tT2Dk6rF2hT79hoXe25%252Fassembly_3.png%3Falt%3Dmedia%26token%3D27e587b4-2223-4976-9c64-63d27d92f2e8&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=5cbf7e0b&amp;sv=2" width="938" height="323"></div><figcaption class="text-xs text-center text-tint mt-2">Assembly Code - Part 3</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">We have now executed the target API and obtained the control flow back. What is left is to restore the stack back to its original state.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252FxUh3U0L1f9SqRMV0EP9i%252Fassembly_4.png%3Falt%3Dmedia%26token%3Daf5e92c7-a4b3-4052-a388-25b0829450e4&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=3d1c477&amp;sv=2" width="1070" height="358"></div><figcaption class="text-xs text-center text-tint mt-2">Assembly Code - Part 4</figcaption></picture></div></div></div><h2 id="putting-it-all-together" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#putting-it-all-together"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_c18qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_c18qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Putting It All Together</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">We have all the bits and pieces ready for our trickery. Now, we'll use a function to orchestrate our circus.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_458qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">PVOID CallStackSpoof(UINT64 pTargetFunction, DWORD dwNumberOfArgs, ...) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	srand((time(0)));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	va_list va_args;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	STACK_INFO sStackInfo = { 0 };<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	UINT64 pGadget, pRtlUserThreadStart, pBaseThreadInitThunk;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	UINT64 pNtdll, pKernel32;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	pNtdll = GetModuleHandleA("ntdll");<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	pKernel32 = GetModuleHandleA("kernel32");<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	pGadget = RetGadget(pKernel32);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	pRtlUserThreadStart = GetProcAddress(pNtdll, "RtlUserThreadStart");<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	pBaseThreadInitThunk = GetProcAddress(pKernel32, "BaseThreadInitThunk");<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	sStackInfo.pGadgetAddress = pGadget;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	sStackInfo.dwGadgetSize = RetStackSize(pKernel32, pGadget);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	sStackInfo.pRtlUserThreadStart = pRtlUserThreadStart + 0x21;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	sStackInfo.dwRtlUserThreadStartSize = RetStackSize(pNtdll, pRtlUserThreadStart);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	sStackInfo.pBaseThreadInitThunk = pBaseThreadInitThunk + 0x14;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	sStackInfo.dwBaseThreadInitThunk = RetStackSize(pKernel32, pBaseThreadInitThunk);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	sStackInfo.pTargetFunction = pTargetFunction;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	if (dwNumberOfArgs &lt;= 4)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		sStackInfo.dwNumberOfArguments = 4;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	else if (dwNumberOfArgs % 2 != 0)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		sStackInfo.dwNumberOfArguments = dwNumberOfArgs + 1;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		sStackInfo.dwNumberOfArguments = dwNumberOfArgs;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	sStackInfo.pArgs = malloc(8 * sStackInfo.dwNumberOfArguments);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	va_start(va_args, dwNumberOfArgs);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	for (int i = 0; i &lt; dwNumberOfArgs; i++) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">		(&amp;sStackInfo.pArgs)[i] = va_arg(va_args, UINT64);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	va_end(va_args);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	return Spoof(&amp;sStackInfo);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><h2 id="results" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#results"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_c78qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_c78qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Results</div></h2><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_498qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">#include &lt;Windows.h&gt;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#include "spoofer.h"<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">int main() {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	HMODULE pUser32 = LoadLibraryA("User32");<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	UINT64 pMessageBoxA = GetProcAddress(pUser32, "MessageBoxA");<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	CallStackSpoof(pMessageBoxA, 4, NULL, "Text", "Caption", MB_YESNO);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Let's observe the call stack when "MessageBoxA" is called.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252FxPC8P8BbsL3ETMvDuY5h%252Fspoofed_mbox.png%3Falt%3Dmedia%26token%3D79aa8b88-a94e-4e16-a071-efb4079c934e&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=783efe20&amp;sv=2" width="699" height="558"></div><figcaption class="text-xs text-center text-tint mt-2">Spoofed Call Stack</figcaption></picture></div></div></div><h2 id="indicators-of-compromise" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#indicators-of-compromise"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_cf8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_cf8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Indicators of Compromise</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Similar to all techniques, call stack spoofing also has certain indicators of compromise. </p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The only reason for all the return addresses to be present on the Call Stack is that there was a call instruction involved. However, in the case of our gadget, there will be a missing call instruction.</p><h3 id="rtluserthreadstart" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#rtluserthreadstart"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_cl8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_cl8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">RtlUserThreadStart</div></h3><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252FTvtOhycJVJnMKRxlsVEz%252Fdetection_1.jpeg%3Falt%3Dmedia%26token%3D95dd0c7e-c959-4604-83d0-ceb89fb14506&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=17bd1c7c&amp;sv=2" width="663" height="167"></div></div></div></div><h3 id="basethreadinitthunk" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#basethreadinitthunk"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_cp8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_cp8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">BaseThreadInitThunk</div></h3><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252FtHevQv46nEuqsNAbi03N%252Fdetection_2.jpeg%3Falt%3Dmedia%26token%3D2903d725-ff79-41e9-82c8-40f8930db354&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=dccdef92&amp;sv=2" width="662" height="185"></div></div></div></div><h3 id="gadgets-address" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#gadgets-address"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_ct8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_ct8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Gadget's Address</div></h3><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-start"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://hulkops.gitbook.io/blog/~gitbook/image?url=https%3A%2F%2F1334214017-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FGdM1jIOKw0EWSCHRMsql%252Fuploads%252FWxX2tctakWqB5YRYdxnE%252Fdetection_3.jpeg%3Falt%3Dmedia%26token%3D1aa1c3fb-a30d-474d-bd63-fa9732d329f2&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=d3f229f4&amp;sv=2" width="662" height="169"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">From the above image, the missing "call" instruction indicates that there was no call instruction to push the gadget's address on the stack.</p><h2 id="references" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://hulkops.gitbook.io/blog/red-team/x64-call-stack-spoofing#references"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_d38qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_d38qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">References</div></h2><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://github.com/klezVirus/SilentMoonwalk">SilentMoonWalk by KlezVirus, Waldo-IRC, and Trickster0<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_jcd58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_jcd58qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://dtsec.us/2023-09-15-StackSpoofin/">Intro to Stack Spoofing by Nigerald<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_jcl58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_jcl58qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://codemachine.com/articles/x64_deep_dive.html">x64 Deep Dive by CodeMachine<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_jct58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_jct58qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://github.com/reactos/reactos">ReactOS<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_jd558qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_jd558qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li></ul></div><div class="flex flex-col md:flex-row mt-6 gap-2 max-w-3xl page-width-wide:max-w-screen-2xl mx-auto text-tint"><a class="group text-sm p-2.5 flex gap-4 flex-1 flex-row-reverse items-center pl-4 border border-tint-subtle rounded-sm circular-corners:rounded-2xl straight-corners:rounded-none hover:border-primary text-pretty md:p-4 md:text-base" href="https://hulkops.gitbook.io/blog"><span class="flex flex-col flex-1 text-right"><span class="text-xs">Previous</span><span class="text-tint-strong group-hover:text-primary line-clamp-2">Welcome</span></span><svg class="gb-icon hidden size-4 text-tint-subtle contrast-more:text-tint-strong group-hover:text-primary md:block"><title>chevron-left</title><defs><mask id="_R_4qqav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-left.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4qqav5ukqiv5ubsnpfivb_)"></rect></svg></a><a class="group text-sm p-2.5 flex gap-4 flex-1 flex-row items-center pr-4 border border-tint-subtle rounded-sm circular-corners:rounded-2xl straight-corners:rounded-none hover:border-primary text-pretty md:p-4 md:text-base" href="https://hulkops.gitbook.io/blog/red-team/x64-return-address-spoofing"><span class="flex flex-col flex-1"><span class="text-xs">Next</span><span class="text-tint-strong group-hover:text-primary line-clamp-2">x64 Return Address Spoofing</span></span><svg class="gb-icon hidden size-4 text-tint-subtle contrast-more:text-tint-strong group-hover:text-primary md:block"><title>chevron-right</title><defs><mask id="_R_5aqav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_5aqav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="mx-auto mt-6 page-api-block:ml-0 flex max-w-3xl page-full-width:max-w-screen-2xl flex-row flex-wrap items-center gap-4 text-tint contrast-more:text-tint-strong"><p class="mr-auto text-sm ">Last updated <time data-visual-test="transparent" datetime="2024-12-19T15:13:29.498Z" data-state="closed">1 year ago</time></p></div></main></div></div><!--$--><!--/$--></div></div></body></html>