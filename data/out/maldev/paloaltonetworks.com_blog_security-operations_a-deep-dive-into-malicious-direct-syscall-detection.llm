Title:
A Deep Dive Into Malicious Direct Syscall Detection

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how Windows system calls normally flow through user-mode API layers (kernel32/kernelbase/ntdll) and how many EDRs monitor them via user-mode inline hooks.  
- It details common evasion approaches that bypass those hooks, including manually mapping clean DLL copies, cloning DLLs to avoid hook placement, and implementing direct syscalls by executing custom syscall stubs.  
- The authors describe Cortex XDR’s approach: kernel-mode syscall interception that inspects the KTRAP_FRAME to recover the user-mode return RIP and attribute the syscall to the originating module (or unmapped shellcode).  
- Because direct syscalls can be legitimate (e.g., security tools, anti-cheat, Chromium), the post emphasizes behavioral/statistical analytics to distinguish rare/malicious patterns from normal baselines.  
- A real-world case study (Lumma Stealer) shows direct-syscall-based process injection, including runtime parsing of ntdll to extract syscall indices and use of Heaven’s Gate for WoW64 transitions.  
- Useful primarily for Blue Teams/EDR engineers and threat hunters, with value to red teamers for understanding detection surfaces beyond user-mode hook bypass.

Technical Focus:
- Windows syscall flow and syscall stubs (ntdll.dll/win32u.dll)
- User-mode inline hooking and hook bypass techniques
- Kernel-mode syscall interception and KTRAP_FRAME/RIP attribution
- Image/module tracking for return-address-to-module resolution
- Behavioral analytics/baselining for anomaly detection of direct syscalls
- WoW64/Heaven’s Gate and direct-syscall-based process injection

Use Cases:
- Build detections for direct syscalls by attributing syscall origin (ntdll vs non-ntdll vs shellcode)
- Hunt for injection chains using ZwCreateSection/ZwMapViewOfSection/ZwWriteVirtualMemory/ZwProtectVirtualMemory + thread context syscalls
- Validate whether an EDR’s telemetry survives common user-mode hook bypasses (manual map, DLL cloning, unhooking)
- Create baselines of “normal” direct-syscall usage per process/module to reduce false positives
- Malware analysis of syscall-index extraction and WoW64 transition wrappers (Heaven’s Gate)

Keywords:
direct syscall, Windows syscalls, ntdll.dll, win32u.dll, inline hooking, user-mode hooks, EDR bypass, kernel-mode interception, KTRAP_FRAME, RIP return address, WoW64, Heaven’s Gate, reflective DLL loading, manual mapping, DLL cloning, ImageTracker, anomaly detection, behavioral analytics, Lumma Stealer, process injection, ZwCreateSection, ZwMapViewOfSection, ZwWriteVirtualMemory, ZwProtectVirtualMemory, NtSetContextThread, NtSuspendThread, NtResumeThread, MurmurHash2