Title:
Mirage — Abusing VBS Enclaves to Hide Shellcode in VTL1 (PoC)

Type:
GitHub Tool

Short Summary (4–8 sentences max):
Mirage is a proof-of-concept memory evasion technique that leverages a vulnerable Virtualization-Based Security (VBS) enclave DLL to store payload data in VTL1 and only materialize executable shellcode in VTL0 briefly. It demonstrates calling vulnerable enclave functions (`SealSettings`/`UnsealSettings`) to shuttle shellcode from the enclave into an RWX buffer, execute it, then overwrite the buffer with a cleanup buffer to reduce post-execution memory artifacts. The looped “unseal → execute → wipe” workflow is intended to complicate EDR memory scanning and forensic capture by minimizing dwell time of recognizable shellcode in normal user-mode memory. The repo includes a known vulnerable `prefs_enclave_x64.dll` and references prior work related to CVE-2023-36880. It’s primarily useful for red teamers, offensive security researchers, and defenders studying emerging VBS/VTL-based evasion tradecraft. The key interest is the abuse of enclave boundaries (VTL1) as a staging area for payloads rather than traditional in-process obfuscation alone.

Technical Focus:
- Windows VBS enclaves and VTL0/VTL1 isolation
- Enclave API abuse via vulnerable functions (`SealSettings`, `UnsealSettings`)
- Shellcode staging, transient RWX allocation, and post-run memory wiping
- Memory evasion against user-mode scanning/forensics
- CVE-2023-36880-related research lineage (enclave exploitation)

Use Cases:
- Prototype VTL1-backed shellcode staging to reduce in-memory exposure in VTL0
- Research and validation of EDR detection gaps around enclave-mediated payload delivery
- Development of defensive detections for anomalous enclave loading/calls and RWX transitions
- Reproducing and studying vulnerable enclave behavior for patch verification and threat modeling

Keywords:
VBS, enclave, VTL1, VTL0, Virtualization-Based Security, Windows internals, shellcode, memory evasion, RWX memory, SealSettings, UnsealSettings, prefs_enclave_x64.dll, cleanup buffer, transient execution, EDR bypass research, CVE-2023-36880, user-mode telemetry, payload staging, Akamai research