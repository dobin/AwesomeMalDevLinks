# https://kylemistele.medium.com/a-beginners-guide-to-edr-evasion-b98cc076eb9a

<!DOCTYPE html><html lang="en" data-rh="lang" dir="ltr"><body><div id="root"><div class="a b c"><a href="https://kylemistele.medium.com/sitemap/sitemap.xml" class="d">Sitemap</a><div class="e f g h i j k l"></div><div></div><div class="m c"><div class="m n o p c" style="transform: translateY(0px);"><div class="q r s t u v w x y j e z ab"><a class="eb ai ec bg am b ao ap aq ar as at au av t v x j e r ed ab" href="https://play.google.com/store/apps/details?id=com.medium.reader&amp;referrer=utm_source%3DmobileNavBar&amp;source=post_page---top_nav_layout_nav-----------------------------------------" rel="noopener follow">Open in app<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="none" viewBox="0 0 10 10" class="ea"><path fill="currentColor" d="M.985 8.485a.375.375 0 1 0 .53.53zM8.75 1.25h.375A.375.375 0 0 0 8.75.875zM8.375 6.5a.375.375 0 1 0 .75 0zM3.5.875a.375.375 0 1 0 0 .75zm-1.985 8.14 7.5-7.5-.53-.53-7.5 7.5zm6.86-7.765V6.5h.75V1.25zM3.5 1.625h5.25v-.75H3.5z"></path></svg></a><div class="ac r"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><button class="bg b ee ef ep eg eh eq ei ej er es el et eu eo ev ew ex ey ez fa fb fc fd fe ff fg fh fi fj fk bn fl fm" data-testid="headerSignUpButton">Sign up</button></span></p><div class="fn m"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerSignInButton" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Fkylemistele.medium.com%2Fa-beginners-guide-to-edr-evasion-b98cc076eb9a&amp;source=post_page---top_nav_layout_nav-----------------------global_nav------------------" rel="noopener follow">Sign in</a></span></p></div></div></div><div class="q r s ac ae af"><div class="ac r ag"><a class="ah ai aj ak al am an ao ap aq ar as at au av ac" aria-label="Homepage" data-testid="headerMediumLogo" href="https://medium.com/?source=post_page---top_nav_layout_nav-----------------------------------------" rel="noopener follow"><svg xmlns="http://www.w3.org/2000/svg" width="719" height="160" fill="none" aria-labelledby="wordmark-medium-desc" viewBox="0 0 719 160" class="aw ax ay"><desc id="wordmark-medium-desc">Medium Logo</desc><path fill="#242424" d="m174.104 9.734.215-.047V8.02H130.39L89.6 103.89 48.81 8.021H1.472v1.666l.212.047c8.018 1.81 12.09 4.509 12.09 14.242V137.93c0 9.734-4.087 12.433-12.106 14.243l-.212.047v1.671h32.118v-1.665l-.213-.048c-8.018-1.809-12.089-4.509-12.089-14.242V30.586l52.399 123.305h2.972l53.925-126.743V140.75c-.687 7.688-4.721 10.062-11.982 11.701l-.215.05v1.652h55.948v-1.652l-.215-.05c-7.269-1.639-11.4-4.013-12.087-11.701l-.037-116.774h.037c0-9.733 4.071-12.432 12.087-14.242m25.555 75.488c.915-20.474 8.268-35.252 20.606-35.507 3.806.063 6.998 1.312 9.479 3.714 5.272 5.118 7.751 15.812 7.368 31.793zm-.553 5.77h65.573v-.275c-.186-15.656-4.721-27.834-13.466-36.196-7.559-7.227-18.751-11.203-30.507-11.203h-.263c-6.101 0-13.584 1.48-18.909 4.16-6.061 2.807-11.407 7.003-15.855 12.511-7.161 8.874-11.499 20.866-12.554 34.343q-.05.606-.092 1.212a50 50 0 0 0-.065 1.151 85.807 85.807 0 0 0-.094 5.689c.71 30.524 17.198 54.917 46.483 54.917 25.705 0 40.675-18.791 44.407-44.013l-1.886-.664c-6.557 13.556-18.334 21.771-31.738 20.769-18.297-1.369-32.314-19.922-31.042-42.395m139.722 41.359c-2.151 5.101-6.639 7.908-12.653 7.908s-11.513-4.129-15.418-11.63c-4.197-8.053-6.405-19.436-6.405-32.92 0-28.067 8.729-46.22 22.24-46.22 5.657 0 10.111 2.807 12.236 7.704zm43.499 20.008c-8.019-1.897-12.089-4.722-12.089-14.951V1.309l-48.716 14.353v1.757l.299-.024c6.72-.543 11.278.386 13.925 2.83 2.072 1.915 3.082 4.853 3.082 8.987v18.66c-4.803-3.067-10.516-4.56-17.448-4.56-14.059 0-26.909 5.92-36.176 16.672-9.66 11.205-14.767 26.518-14.767 44.278-.003 31.72 15.612 53.039 38.851 53.039 13.595 0 24.533-7.449 29.54-20.013v16.865h43.711v-1.746zM424.1 19.819c0-9.904-7.468-17.374-17.375-17.374-9.859 0-17.573 7.632-17.573 17.374s7.721 17.374 17.573 17.374c9.907 0 17.375-7.47 17.375-17.374m11.499 132.546c-8.019-1.897-12.089-4.722-12.089-14.951h-.035V43.635l-43.714 12.551v1.705l.263.024c9.458.842 12.047 4.1 12.047 15.152v81.086h43.751v-1.746zm112.013 0c-8.018-1.897-12.089-4.722-12.089-14.951V43.635l-41.621 12.137v1.71l.246.026c7.733.813 9.967 4.257 9.967 15.36v59.279c-2.578 5.102-7.415 8.131-13.274 8.336-9.503 0-14.736-6.419-14.736-18.073V43.638l-43.714 12.55v1.703l.262.024c9.459.84 12.05 4.097 12.05 15.152v50.17a56.3 56.3 0 0 0 .91 10.444l.787 3.423c3.701 13.262 13.398 20.197 28.59 20.197 12.868 0 24.147-7.966 29.115-20.43v17.311h43.714v-1.747zm169.818 1.788v-1.749l-.213-.05c-8.7-2.006-12.089-5.789-12.089-13.49v-63.79c0-19.89-11.171-31.761-29.883-31.761-13.64 0-25.141 7.882-29.569 20.16-3.517-13.01-13.639-20.16-28.606-20.16-13.146 0-23.449 6.938-27.869 18.657V43.643L545.487 55.68v1.715l.263.024c9.345.829 12.047 4.181 12.047 14.95v81.784h40.787v-1.746l-.215-.053c-6.941-1.631-9.181-4.606-9.181-12.239V66.998c1.836-4.289 5.537-9.37 12.853-9.37 9.086 0 13.692 6.296 13.692 18.697v77.828h40.797v-1.746l-.215-.053c-6.94-1.631-9.18-4.606-9.18-12.239V75.066a42 42 0 0 0-.578-7.26c1.947-4.661 5.86-10.177 13.475-10.177 9.214 0 13.691 6.114 13.691 18.696v77.828z"></path></svg></a><div class="az i"><div class="ac ak ba bb bc r bd be"><div class="bn" aria-describedby="searchResults" aria-labelledby="searchResults" aria-haspopup="listbox" role="listbox"></div><div class="bo bp ac"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg></div><input role="combobox" aria-controls="searchResults" aria-expanded="false" aria-label="search" data-testid="headerSearchInput" tabindex="0" class="ak bf bg bh ab bi bj bk bl bm" placeholder="Search" value=""></div></div></div><div class="i l x fp fq"><span data-dd-action-name="Susi presentation tracker new_post_topnav"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerWriteButton" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2Fnew-story&amp;source=---top_nav_layout_nav-----------------------new_post_topnav------------------" rel="noopener follow"><div class="bg b bh ab eb fr fs ac r ft fu fv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M14 4a.5.5 0 0 0 0-1zm7 6a.5.5 0 0 0-1 0zm-7-7H4v1h10zM3 4v16h1V4zm1 17h16v-1H4zm17-1V10h-1v10zm-1 1a1 1 0 0 0 1-1h-1zM3 20a1 1 0 0 0 1 1v-1zM4 3a1 1 0 0 0-1 1h1z"></path><path stroke="currentColor" d="m17.5 4.5-8.458 8.458a.25.25 0 0 0-.06.098l-.824 2.47a.25.25 0 0 0 .316.316l2.47-.823a.25.25 0 0 0 .098-.06L19.5 6.5m-2-2 2.323-2.323a.25.25 0 0 1 .354 0l1.646 1.646a.25.25 0 0 1 0 .354L19.5 6.5m-2-2 2 2"></path></svg>Write</div></a></span></div><div class="l k j e"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerSearchButton" href="https://medium.com/search?source=post_page---top_nav_layout_nav-----------------------------------------" rel="noopener follow"><div class="bg b bh ab eb fr fs ac r ft fu fv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Search</span></div></a></div><div class="ge i l k"><div class="ac r"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><button class="bg b ee ef ep eg eh eq ei ej er es el et eu eo ev ew ex ey ez fa fb fc fd fe ff fg fh fi fj fk bn fl fm" data-testid="headerSignUpButton">Sign up</button></span></p><div class="fn m"><p class="bg b ee ef eg eh ei ej ek el em eo eb"><span data-dd-action-name="Susi presentation tracker global_nav"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerSignInButton" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Fkylemistele.medium.com%2Fa-beginners-guide-to-edr-evasion-b98cc076eb9a&amp;source=post_page---top_nav_layout_nav-----------------------global_nav------------------" rel="noopener follow">Sign in</a></span></p></div></div></div><div class="m"><div><div class="bn" role="tooltip" aria-describedby="1" aria-labelledby="1"><div tabindex="-1" class="bf"><button class="ak gf ao ac r aq fr gg gh gi" aria-label="user options menu" data-testid="headerUserIcon"><div class="m fr"><img alt="" class="m fk by bz ca de" width="32" height="32" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fill:32:32/1*dmbNkD5D-u45r44go_cf0g.png"><div class="gj by m bz ca fw o ak gk"></div></div></button></div></div></div></div></div></div><div class="ac"><div class="cb i l k j cc" style="width: 0px;"></div><div class="cd bi ce cf cg ch" style="width: calc(100% + 0px);"><div class="m"><div data-focus-guard="true" tabindex="-1" style="width: 1px; height: 0px; padding: 0px; overflow: hidden; position: fixed; top: 1px; left: 1px;"></div><div data-focus-lock-disabled="disabled"><div class="rt" role="dialog" aria-modal="true" tabindex="-1"><div class="vx vy bi ed vz wa wb aq wc hd wd" aria-hidden="true" role="presentation"></div><div class="we vz wf wg wh vx ed fk wi wj wk lz wl wm wn wo wp wq wr ws wt wu ac cv wv" aria-hidden="true"><div class="ww gy"></div></div></div></div><div data-focus-guard="true" tabindex="-1" style="width: 1px; height: 0px; padding: 0px; overflow: hidden; position: fixed; top: 1px; left: 1px;"></div><div class="gl gm gn go gp m"><div class="ac ci"><div class="cp bi gq gr gs gt"></div></div><article><div class="m"><div class="m"><span class="m"></span><section><div><div class="fw gz wx hb hc hd"></div><div class="he hf hg hh hi"><div class="ac ci"><div class="cp bi gq gr gs gt"><div><h1 id="dbb5" class="pw-post-title hj hk hl bg hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie if ig ih bl" data-testid="storyTitle" data-selectable-paragraph="">A Beginner’s Guide to EDR Evasion</h1></div><div><h2 id="7551" class="pw-subtitle-paragraph ii hk hl bg b ij ik il im in io ip iq ir is it iu iv iw ix cx eb" data-selectable-paragraph="">Or, how to get past Crowdstrike/Defender ATP/Carbon Black on your next engagement</h2><div><div class="speechify-ignore ac cw"><div class="speechify-ignore bi m"><div class="ac iy iz ja jb jc jd je jf jg jh ji"><div class="ac r ji"><div class="ac jj"><div><div class="bn" aria-describedby="3" aria-labelledby="3" role="tooltip"><div tabindex="-1" class="bf"><a rel="noopener follow" href="https://kylemistele.medium.com/?source=post_page---byline--b98cc076eb9a---------------------------------------" data-discover="true"><div class="m jk jl by jm jn"><div class="m fr"><img alt="Kyle Mistele" class="m fk by bz ca de" width="32" height="32" loading="lazy" data-testid="authorPhoto" src="https://miro.medium.com/v2/resize:fill:32:32/1*am8R5BslswewzFMfLCX_3g.jpeg"><div class="jo by m bz ca fw o jp gk"></div></div></div></a></div></div></div></div><span class="bg b bh ab bl"><div class="jq ac r"><div class="ac r jr"><div class="ac r"><div><div class="bn" aria-describedby="4" aria-labelledby="4" role="tooltip"><div tabindex="-1" class="bf"><span class="bg b bh ab bl"><a class="ah ai aj fo al am an ao ap aq ar as at js" data-testid="authorName" rel="noopener follow" href="https://kylemistele.medium.com/?source=post_page---byline--b98cc076eb9a---------------------------------------" data-discover="true">Kyle Mistele</a></span></div></div></div></div><div class="jt bn"></div></div></div></span></div><div class="ac r ju"><span class="bg b bh ab eb"><div class="ac ag"><span data-testid="storyReadTime">16 min read</span><div class="jv jw m" aria-hidden="true"><span class="m" aria-hidden="true"><span class="bg b bh ab eb">·</span></span></div><span data-testid="storyPublishDate">Sep 25, 2021</span></div></span></div></div><div class="ac cw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km"><div class="i l x fp fq r"><div class="lc m"><div class="ac r ld le"><div class="pw-multi-vote-icon fr lf lg lh li"><span data-dd-action-name="Susi presentation tracker clap_footer"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerClapButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2Fb98cc076eb9a&amp;operation=register&amp;redirect=https%3A%2F%2Fkylemistele.medium.com%2Fa-beginners-guide-to-edr-evasion-b98cc076eb9a&amp;user=Kyle+Mistele&amp;userId=a69b88a388c4&amp;source=---header_actions--b98cc076eb9a---------------------clap_footer------------------" rel="noopener follow"><div><div class="bn" aria-describedby="5" aria-labelledby="5" role="tooltip"><div tabindex="-1" class="bf"><div class="lj aq lk ll lm ln ao lo lp lq li" role="presentation"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></div></div></div></a></span></div><div class="pw-multi-vote-count m lr ls lt lu lv lw lx"><p class="bg b ec ab eb"><span class="ly">--</span></p></div></div></div><div><div class="bn" aria-describedby="6" aria-labelledby="6" role="tooltip"><div tabindex="-1" class="bf"><button class="aq lj lz ma ac r fs mb mc" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="md"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"></path></svg></button></div></div></div></div><div class="ac r kn ko kp kq kr ks kt ku kv kw kx ky kz la lb"><div class="me l k j e"></div><div class="i l"><div><div class="bn" aria-describedby="7" aria-labelledby="7" role="tooltip"><div tabindex="-1" class="bf"><span data-dd-action-name="Susi presentation tracker bookmark_footer"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-testid="headerBookmarkButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fb98cc076eb9a&amp;operation=register&amp;redirect=https%3A%2F%2Fkylemistele.medium.com%2Fa-beginners-guide-to-edr-evasion-b98cc076eb9a&amp;source=---header_actions--b98cc076eb9a---------------------bookmark_footer------------------" rel="noopener follow"><span class=""><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25" class="eb mf" aria-label="Add to list bookmark button"><path fill="currentColor" d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .805.396L12.5 17l5.695 4.396A.5.5 0 0 0 19 21v-8.5a.5.5 0 0 0-1 0v7.485l-5.195-4.012a.5.5 0 0 0-.61 0L7 19.985z"></path></svg></span></a></span></div></div></div></div><div class="fk mg cu"><div class="m ag"><div class="ac ci"><div class="mh mi mj mk ml mm cp bi"><div class="ac"><span data-dd-action-name="Susi presentation tracker post_audio_button"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2Fplans%3Fdimension%3Dpost_audio_button%26postId%3Db98cc076eb9a&amp;operation=register&amp;redirect=https%3A%2F%2Fkylemistele.medium.com%2Fa-beginners-guide-to-edr-evasion-b98cc076eb9a&amp;source=---header_actions--b98cc076eb9a---------------------post_audio_button------------------" rel="noopener follow"><div><div class="bn" aria-describedby="53" aria-labelledby="53" role="tooltip"><div tabindex="-1" class="bf"><button aria-label="Listen" data-testid="audioPlayButton" class="ah fs aj fo al am an mn ap aq ar fe mo mp mc mq mr ms mt mu t mv mw mx my mz na nb v nc nd ne"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"></path></svg><div class="k j e"><p class="bg b bh ab eb">Listen</p></div></button></div></div></div></a></span></div></div></div></div></div><div class="bn" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bn" aria-describedby="9" aria-labelledby="9" role="tooltip"><div tabindex="-1" class="bf"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="ah fs aj fo al am an mn ap aq ar fe mo mp mc mq mr ms mt mu t mv mw mx my mz na nb v nc nd ne"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"></path></svg><div class="k j e"><p class="bg b bh ab eb">Share</p></div></button></div></div></div></div></div></div></div></div></div></div><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np fr nq bi nr"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="nf ng nh"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 640w, https://miro.medium.com/v2/resize:fit:720/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 720w, https://miro.medium.com/v2/resize:fit:750/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 750w, https://miro.medium.com/v2/resize:fit:786/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 786w, https://miro.medium.com/v2/resize:fit:828/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 828w, https://miro.medium.com/v2/resize:fit:1100/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 1100w, https://miro.medium.com/v2/resize:fit:1400/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi mm ns c" width="700" height="472" loading="eager" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*1gKTDUWOWW8ov3LeHc7RCA.jpeg"></picture></div></div></figure><p id="b5c7" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">In this post, I’m going to cover the process I used to write a shellcode loader to evade industry-leading EDR solutions and successfully run Cobalt Strike undetected on various endpoints during an engagement. This is basically a more in-depth version of a presentation I gave at Dallas Hackers Assocation.</p><p id="555f" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">None of the techniques discussed here are new per se. Rather, I took some existing tools and methodologies and combined them to achieve the effect that I wanted.</p><h2 id="3a1c" class="op oq hl bg or os ot il ou ov ow io ox oy oz pa pb pc pd pe pf pg ph pi pj pk bl" data-selectable-paragraph="">What this post is</h2><p id="41da" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">In this post, I’m going to cover a variety of topics, including:</p><ul class=""><li id="313a" class="nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo pq pr ps bl" data-selectable-paragraph="">The mechanics of API Hooking</li><li id="080d" class="nt nu hl nv b ij pt nx ny im pu oa ob oc pv oe of og pw oi oj ok px om on oo pq pr ps bl" data-selectable-paragraph="">Why API unhooking is important, but in this case not necessary</li><li id="9083" class="nt nu hl nv b ij pt nx ny im pu oa ob oc pv oe of og pw oi oj ok px om on oo pq pr ps bl" data-selectable-paragraph="">Talk about my process and methodology going into this project</li><li id="0711" class="nt nu hl nv b ij pt nx ny im pu oa ob oc pv oe of og pw oi oj ok px om on oo pq pr ps bl" data-selectable-paragraph="">Go over some of my favorite techniques for evading hooking and performing process injection</li></ul><h2 id="6584" class="op oq hl bg or os ot il ou ov ow io ox oy oz pa pb pc pd pe pf pg ph pi pj pk bl" data-selectable-paragraph="">What this post is not</h2><p id="31c6" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">This post is not a tool drop — I am not open-sourcing any of the tooling or code I wrote. This post is entirely theoretical, <em class="py">however</em>, a sufficiently technically skilled reader should be able to recreate something similar to my toolset from the techniques described here. If you’re reasonably skilled with Windows C++, reading documentation, and doing some creative googling, you should have no problem.</p><h2 id="efbc" class="op oq hl bg or os ot il ou ov ow io ox oy oz pa pb pc pd pe pf pg ph pi pj pk bl" data-selectable-paragraph="">Windows API Hooking</h2><p id="c878" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">Windows API hooking is one of the varieties of mechanics that most EDRs use to detect malicious behavior, and in particular, process injection. In order to bypass this type of detection, it’s very important to understand what API hooking is, how it works, and how to undo (“unhook”) it.</p><h3 id="ed97" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">Important Concepts</h3><p id="f61d" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">For the purposes of the rest of this post, it will help to think of a <strong class="nv hm">function </strong>as a <strong class="nv hm">pointer to a routine in memory</strong>. This routine is defined by a series of assembly instructions, which will vary depending on the processor architecture. These assembly instructions are several-byte opcodes.</p><p id="14ba" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">The <strong class="nv hm">Windows API</strong> is the interface through which we can programmatically access and manipulate system resources such as processes, threads, memory, and so forth. It is provided by a series of header files ( <code class="de qo qp qq qr b">.h</code> files in C++) that export various types and functions. The interface looks a little different in C#, but the underlying concepts are functionally the same.</p><p id="0a44" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">The most common header to import is <code class="de qo qp qq qr b">Windows.h</code>, but depending on the resources that we’re accessing and manipulating, we may import a variety of other headers such as <code class="de qo qp qq qr b">processthreadsapi.h</code>, or <code class="de qo qp qq qr b">memoryapi.h</code> . More information on headers like these can be found in the <a class="ah qs" href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/" rel="noopener ugc nofollow" target="_blank">Windows documentation</a>.</p><p id="cab9" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph=""><strong class="nv hm">API Hooking</strong> refers to a technique used by EDRs and other programs such as anti-cheat engines to redirect the flow of program execution when a certain function is called. When a hooked function is called, execution is redirected by the “hook” to some routine in a library that has been loaded into the process, before eventually returning to the normal flow of execution or terminating the call. Methods for this vary — some will be discussed further on in this post.</p><h3 id="609e" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">How the Windows API Works</h3><p id="2681" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">When a user makes a call to one of the functions exported by the system header files that make up the Windows API, execution jumps into the Windows library that the header is defining exports from. This library does some sanity checks, validation, and type conversions, and then will call an <em class="py">unexported</em> function in NTDLL.dll, kernel32.dll, or another system linked library. This function will then set up the appropriate registers with the correct syscall number before executing the <code class="de qo qp qq qr b">syscall</code> instruction that jumps from user-mode into kernel-mode.</p><p id="4c0b" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">It’s worth noting that the register values (parameters) that are set up and the syscall number actually vary from windows version to windows version, and even among various service packs and patch levels across the same windows version.</p><p id="08a0" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">Here’s an example of the normal execution flow for the Windows API call <code class="de qo qp qq qr b">CreateRemoteThread</code> .</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div class="nf ng qt"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*kE4453pAiqK6nJ3kIrDm5w.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*kE4453pAiqK6nJ3kIrDm5w.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*kE4453pAiqK6nJ3kIrDm5w.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*kE4453pAiqK6nJ3kIrDm5w.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*kE4453pAiqK6nJ3kIrDm5w.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kE4453pAiqK6nJ3kIrDm5w.png 1100w, https://miro.medium.com/v2/resize:fit:1316/format:webp/1*kE4453pAiqK6nJ3kIrDm5w.png 1316w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 658px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*kE4453pAiqK6nJ3kIrDm5w.png 640w, https://miro.medium.com/v2/resize:fit:720/1*kE4453pAiqK6nJ3kIrDm5w.png 720w, https://miro.medium.com/v2/resize:fit:750/1*kE4453pAiqK6nJ3kIrDm5w.png 750w, https://miro.medium.com/v2/resize:fit:786/1*kE4453pAiqK6nJ3kIrDm5w.png 786w, https://miro.medium.com/v2/resize:fit:828/1*kE4453pAiqK6nJ3kIrDm5w.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*kE4453pAiqK6nJ3kIrDm5w.png 1100w, https://miro.medium.com/v2/resize:fit:1316/1*kE4453pAiqK6nJ3kIrDm5w.png 1316w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 658px"><img alt="" class="bi mm ns c" width="658" height="342" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:658/1*kE4453pAiqK6nJ3kIrDm5w.png"></picture></div><figcaption class="qu fm qv nf ng qw qx bg b bh ab eb" data-selectable-paragraph="">Calling CreateRemoteThread via the Windows API.</figcaption></figure><p id="7725" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">First, the user imports the <code class="de qo qp qq qr b">processthreadsapi.h</code> header and calls <code class="de qo qp qq qr b">CreateRemoteThread</code> with the correct parameters. This function will do the sanity checks and so forth, and then it will call the unexported <code class="de qo qp qq qr b">NtCreateThreadEx</code> function in NTDLL.dll. This function will then set up the appropriate registers with parameters and the syscall number before executing the <code class="de qo qp qq qr b">syscall</code> instruction to jump into kernel-mode. Once the kernel-mode syscall is done executing, execution will return to userland and eventually back to the caller.</p><h3 id="7494" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">How API Hooking Works</h3><p id="8c9e" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">API Hooking can also be done either in the header function (e.g. <code class="de qo qp qq qr b">CreateRemoteThread</code>), or in the unexported NTDLL function (e.g. <code class="de qo qp qq qr b">NtCreateThreadEx</code>). Hooking is now more commonly done in the latter of the two because hooking in the former is easier to bypass.</p><p id="c7f8" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">When an EDR hooks various API functions, the EDR will load a library into all newly created processes. Then, it will proceed to “hook” Windows API functions that are commonly used by malware — most commonly, functions that have to do with process and thread creation and manipulation, memory mapping, etc. Common examples include <code class="de qo qp qq qr b">NtCreateThreadEx</code>, <code class="de qo qp qq qr b">NtMapViewOfSection</code>, <code class="de qo qp qq qr b">NtAllocateVirtualMemory</code>, and so forth. There are a variety of techniques for creating the actual hook (and most of them are similar), but the most common one involves replacing the first instruction of the unexported function in the system DLL with a <code class="de qo qp qq qr b">jmp</code> instruction that jumps to a routine in the EDR’s loaded library.</p><p id="6733" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">It’s worth noting that hooking is done at runtime — hooks are rarely added to NTDLL on disk; rather the EDR will hook NTDLL in memory once the process has loaded it.</p><p id="a3c7" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">EDRs use this technique to track which API calls are being called, in what sequence they are being called, and with what arguments they are being called. Certain sequences of API calls are known to be commonly abused, e.g. <code class="de qo qp qq qr b">NtOpenProcess</code> ( <code class="de qo qp qq qr b">OpenProcess</code>), <code class="de qo qp qq qr b">NtAllocateVirtualMemory</code> ( <code class="de qo qp qq qr b">VirtualAllocEx</code>), <code class="de qo qp qq qr b">NtWriteVirtualMemory</code> ( <code class="de qo qp qq qr b">WriteProcessMemory</code>), and then <code class="de qo qp qq qr b">NtCreateThreadEx</code> ( <code class="de qo qp qq qr b">CreateRemoteThread</code>). This technique is used commonly by malware, including by Cobalt Strike, to perform process injection. However, there are many other such sequences of API calls that are commonly malicious. By hooking functions to detect these sequences of calls, EDRs can detect the malicious behavior, and terminate the offending processes.</p><p id="4d62" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">Here’s an example of what a hooked API call’s execution flow might look like:</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np fr nq bi nr"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="nf ng qy"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*OVX1b77G_k7Yg9RMDCi7PA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*OVX1b77G_k7Yg9RMDCi7PA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*OVX1b77G_k7Yg9RMDCi7PA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*OVX1b77G_k7Yg9RMDCi7PA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*OVX1b77G_k7Yg9RMDCi7PA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*OVX1b77G_k7Yg9RMDCi7PA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OVX1b77G_k7Yg9RMDCi7PA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*OVX1b77G_k7Yg9RMDCi7PA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*OVX1b77G_k7Yg9RMDCi7PA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*OVX1b77G_k7Yg9RMDCi7PA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*OVX1b77G_k7Yg9RMDCi7PA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*OVX1b77G_k7Yg9RMDCi7PA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*OVX1b77G_k7Yg9RMDCi7PA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*OVX1b77G_k7Yg9RMDCi7PA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi mm ns c" width="700" height="290" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*OVX1b77G_k7Yg9RMDCi7PA.png"></picture></div></div></figure><p id="fb6a" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">Note that this assumes that the hook is being placed in the unexported NTDLL function, not in the exported API function.</p><p id="283c" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">When a process calls a function like <code class="de qo qp qq qr b">CreateRemoteThread</code>, execution will eventually jump into the corresponding unexported NTDLL function (here, <code class="de qo qp qq qr b">NtCreateThreadEx</code>). The first instruction of this function, since it is hooked, will be a <code class="de qo qp qq qr b">jmp</code> instruction that jumps into the EDR’s loaded library. The EDR may examine the parameters and will check to see what other syscalls have been made before it. Then the EDR will <em class="py">either </em>return execution to the unexported function before execution hits the <code class="de qo qp qq qr b">syscall</code> instruction and jumps into kernel mode, <em class="py">or</em> the EDR will detect a sequence of system calls that it identifies as malicious and terminate the process.</p><h2 id="e4b5" class="op oq hl bg or os ot il ou ov ow io ox oy oz pa pb pc pd pe pf pg ph pi pj pk bl" data-selectable-paragraph="">EDR Evasion through API Unhooking</h2><h3 id="21c2" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">Why do API Unhooking?</h3><p id="dcbb" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">So why should we do API Unhooking? Well, first of all, it allows us to avoid having our API call sequences detected by the EDR. If we can remove the hooks, we can (theoretically) avoid detection.</p><p id="af36" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">The EDR’s hooks are necessarily in our process’s memory space, and since we own the process, we can read/write to it, and we can therefore overwrite the hooks — we just have to replace the <code class="de qo qp qq qr b">jmp</code> instructions with the proper instructions.</p><h3 id="0d46" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">Limits to API Unhooking</h3><p id="8ac2" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">Of course, there are practical limits to this — certain process injection techniques can be and will be caught through means other than API hooking. For example, the <code class="de qo qp qq qr b">CreateRemoteThread</code> technique can be caught through other forms of telemetry, including monitoring process handles and threads, and the Windows event log. Some techniques are much more difficult to detect, but determining which those are is left as an exercise to the reader :)</p><h3 id="1810" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">Popular Ways to Unhook Hooked Windows API Calls</h3><p id="c0d0" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">There are a variety of ways to deal with API hooking, and everyone has their favorite. Common ones include but are not limited to the following:</p><p id="29fe" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph=""><strong class="nv hm">Overwriting in-memory hooks with your own copy of the routines at runtime</strong></p><p id="2a61" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">In this technique, you pack your own copy of the first few bytes of the unexported NTDLL functions in your executable and overwrite the hooks with these at runtime. You will of course have to reprotect the instructions before overwriting them since they’ll be in read-execute memory and you’ll need write permissions. One downside of this is that you have to know your OS and version/service pack since the routines can change depending on these factors.</p><p id="25ce" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph=""><strong class="nv hm">Mapping NTDLL from disk entirely over NTDLL in memory</strong></p><p id="c33d" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">Another popular technique is to read NTDLL off of the disk and then map it over the copy of NTDLL that's been loaded in memory. One of the downsides of this is that it can be technically complicated since you have to rebase addresses. This technique is also pretty easy to detect.</p><p id="3a4b" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph=""><strong class="nv hm">Retrieving NTDLL function stubs from disk at runtime and unhook</strong></p><p id="247a" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">The last technique that I’m going to discuss here is somewhere in between the two — you’re only overwriting the hooks for the calls you need, but you are reading the function stubs off of the NTDLL on disk so you don’t have to worry about portability as much.</p><h3 id="90f7" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">Upsides of API Unhooking</h3><p id="dc14" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">Clearly, there are a variety of techniques that you can choose that will allow you to be as surgical (or as imprecise) as you want. And ultimately, all of these techniques will allow you to flush out the EDR’s hooks. However, these techniques come with a few caveats.</p><h3 id="25fd" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">Downsides of API Unhooking</h3><p id="99e6" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">Unfortunately, the problem with doing API unhooking is that you still ultimately have to use hooked API calls to do the unhooking. As a result, your unhooking can actually be detected by the EDR and flagged as malicious. Of course, not all EDRs will necessarily detect this, but it’s still a risk.</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div class="nf ng qz"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*DbkBe_1OOaVDkRAxrd1jEA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*DbkBe_1OOaVDkRAxrd1jEA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*DbkBe_1OOaVDkRAxrd1jEA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*DbkBe_1OOaVDkRAxrd1jEA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*DbkBe_1OOaVDkRAxrd1jEA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*DbkBe_1OOaVDkRAxrd1jEA.png 1100w, https://miro.medium.com/v2/resize:fit:906/format:webp/1*DbkBe_1OOaVDkRAxrd1jEA.png 906w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 453px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*DbkBe_1OOaVDkRAxrd1jEA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*DbkBe_1OOaVDkRAxrd1jEA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*DbkBe_1OOaVDkRAxrd1jEA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*DbkBe_1OOaVDkRAxrd1jEA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*DbkBe_1OOaVDkRAxrd1jEA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*DbkBe_1OOaVDkRAxrd1jEA.png 1100w, https://miro.medium.com/v2/resize:fit:906/1*DbkBe_1OOaVDkRAxrd1jEA.png 906w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 453px"><img alt="" class="bi mm ns c" width="453" height="410" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:453/1*DbkBe_1OOaVDkRAxrd1jEA.png"></picture></div></figure><h2 id="4acc" class="op oq hl bg or os ot il ou ov ow io ox oy oz pa pb pc pd pe pf pg ph pi pj pk bl" data-selectable-paragraph="">EDR Evasion by Packing Your Own WinAPI Calls</h2><p id="d739" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">Of course, API unhooking isn’t the only way to evade EDRs. In this section, I’m going to cover my personal favorite technique for evasion.</p><div class="ue uf ug uh ac r cv"><div class="ui uj uk ul um m fm"><h2 class="un b uo up uq ur us">Get Kyle Mistele’s stories in&nbsp;your&nbsp;inbox</h2></div><div class="cs m fm"><p class="bg b bh ab eb">Join Medium for free to get updates from&nbsp;this&nbsp;writer.</p></div><div class="uw sd ux uy sc uz ac"><span class="bg b bh ab bl"><div class="va ac cv"><div class="ac va fj fi bq vb vc de lz vd ve vf vg vh vi vj"><input class="vk al aj an vl vm gd ln bm vn bi" placeholder="Enter your email" type="text" value=""></div></div></span><div class="i l st cb"><div class="ut uu uv"><button class="bg b bh ab vo ri vp vq vr vs vt fc fd vu vv vw fh fi fj fk bn fl fm">Subscribe</button></div></div><div class="bi k j e"><button class="bg b bh ab vo ri vp vq vr vs vt fc fd vu vv vw fh bi fi fj fk bn fl fm">Subscribe</button></div></div><div class="rg m"><div id="g-recaptcha"></div></div></div><p id="16b9" class="pw-post-body-paragraph nt nu hl nv b ij nx ny im oa ob oc oe of og oi oj ok om on uh oo he bl" data-selectable-paragraph="">So what if, instead of trying to use hooked functions to unhook functions, we just supplied our own copies of the functions that the EDR doesn’t know to hook? This is exactly what I’m proposing. By packing our own copies of the unexported functions in NTDLL that we want to use, we can completely avoid the EDR’s hooks by jumping straight from our program’s code into kernel mode, without having to go through the Windows API and hooked code. It’s very stealthy.</p><p id="14f0" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">“So I can just copy the routines from NTDLL I need and pack them into my executable before compiling it and dropping it on the target”?</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np fr nq bi nr"><span class="fw fx fy ao fz ga gb gc gd speechify-ignore">Press enter or click to view image in full size</span><div class="nf ng ra"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*iooEDaT4AWC7Ze-9S-9yCw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*iooEDaT4AWC7Ze-9S-9yCw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*iooEDaT4AWC7Ze-9S-9yCw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*iooEDaT4AWC7Ze-9S-9yCw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*iooEDaT4AWC7Ze-9S-9yCw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*iooEDaT4AWC7Ze-9S-9yCw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iooEDaT4AWC7Ze-9S-9yCw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*iooEDaT4AWC7Ze-9S-9yCw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*iooEDaT4AWC7Ze-9S-9yCw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*iooEDaT4AWC7Ze-9S-9yCw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*iooEDaT4AWC7Ze-9S-9yCw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*iooEDaT4AWC7Ze-9S-9yCw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*iooEDaT4AWC7Ze-9S-9yCw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*iooEDaT4AWC7Ze-9S-9yCw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi mm ns c" width="700" height="394" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*iooEDaT4AWC7Ze-9S-9yCw.png"></picture></div></div></figure><p id="6eb4" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">Unfortunately, the answer is no, because Windows is awful and makes life hard :(</p><p id="edd6" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">The long and short of it is that, as I mentioned earlier, the functions in NTDLL are setting up registers with things like syscall numbers and arguments before actually executing the <code class="de qo qp qq qr b">syscall</code> instruction. Unfortunately, the argument setup and syscall number change not only between Windows OS versions (XP, 7, 8, 10) but also frequently between service pack levels and patch levels. Therefore, copies of functions from NTDLL aren’t guaranteed to be portable from one system to another.</p><h3 id="1fab" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">So what’s the solution?</h3><p id="d583" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">Ultimately, what we need is assembly code to determine the OS version, service pack (if applicable), patch level, and other relevant attributes. Then, that code would need to provide versions of the NTDLL routines we want for all OSes/versions that we want to support in our loader, and would have to make the determination of which one to jump to. Suddenly, we’re dealing with a very complicated assembly routine instead of just a routine copied from NTDLL.</p><p id="b899" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">I hate x64 assembly, and can’t write it anyways — I learned ARM. As a result, writing that code myself was pretty much out of the question.</p><h3 id="2531" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">SysWhispers — Packing your own direct system calls</h3><p id="85fb" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">Fortunately, someone who is much smarter than I am and much better at x64 assembly than I am wrote a neat tool called <a class="ah qs" href="https://github.com/jthuraisamy/SysWhispers" rel="noopener ugc nofollow" target="_blank">SysWhispers</a>. Syswhispers automates a lot of the process for you and generally makes life easier for you. <a class="ah qs" href="https://github.com/jthuraisamy/SysWhispers2" rel="noopener ugc nofollow" target="_blank">Syswhispers 2</a> has since been released and makes life even easier. Syswhispers originally only supported x64 architectures, but there is also an <a class="ah qs" href="https://github.com/mai1zhi2/SysWhispers2_x86" rel="noopener ugc nofollow" target="_blank">unsupported fork</a> that claims to support x86, though I haven’t tested it and the readme is in a language I don’t speak :P</p><p id="70b7" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">The idea of the tool is to run the tool on a clean Windows installation (i.e. one without AV/EDR installed), and pick the Windows API calls that you want. SysWhispers will generate a <code class="de qo qp qq qr b">.asm</code> file and a <code class="de qo qp qq qr b">.h</code> file that you can include in your project (I recommend using Visual Studio, but of course you can use whatever you want). If you’re using Visual Studio, make sure to enable the Microsoft Macro Assembler in the project settings, and set the build type for the <code class="de qo qp qq qr b">.asm</code> file to “Macro Assembler” — neither of these things are done by default.</p><p id="b198" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">Then, you can use the functions exported in the header file to perform the operations. The interfaces will be identical to the corresponding unexported NTDLL functions, <em class="py">not</em> to the higher-level Windows API call provided by the system headers.</p><p id="26b6" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">Unfortunately, since the unexported NTDLL functions are also undocumented, it can take some doing to figure out how to set the arguments up properly, especially since some of them take widechar strings instead of standard ASCII c-strings. One resource that helped me a lot with this was the following unofficial documentation that someone put together: <a class="ah qs" href="http://undocumented.ntinternals.net/" rel="noopener ugc nofollow" target="_blank">http://undocumented.ntinternals.net</a>.</p><h2 id="5979" class="op oq hl bg or os ot il ou ov ow io ox oy oz pa pb pc pd pe pf pg ph pi pj pk bl" data-selectable-paragraph="">Performing Process Injection without Getting Detected</h2><p id="ab50" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">There are a variety of techniques for doing process injection — in this section, I’m only going to cover the technique that you should <strong class="nv hm">not </strong>use, and then my favorite technique.</p><h3 id="8161" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">How NOT to do process injection</h3><p id="4fd0" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">Do not, ever, under any circumstances, think you are going to get away with <code class="de qo qp qq qr b">CreateRemoteThread</code>-based process injection. Unless you uninstall the AV/EDR from your target, it’s not gonna happen. EDR’s don’t need API hooking to detect this technique, so all the unhooking and direct system calls in the world won’t help you if you’re up against Crowdstrike and decide it’s a good idea to try this.</p><p id="d787" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">This is detectable by monitoring processes and threads, by event logs, and a dozen other things. Seriously, don’t do it.</p><p id="e0e1" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">Fun fact: for those of you out there using Cobalt Strike, CS does this by default for process migration, and Meterpreter might as well. Windows Defender ATP for example actually identifies this technique as Cobalt Strike, even if you’re not using a CS shellcode. Just don’t do it.</p><h3 id="96fe" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">My favorite technique: APC Queue Injection</h3><p id="9de5" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">One of my favorite techniques for process injection is APC Queue injection. This has become an increasingly popular technique lately, at least in part because it’s darn near impossible to detect without API hooking — APCs and APC Queues are almost impossible to monitor, since Windows provides a way for you to queue up APCs, but not to query APC queues or gain any type of visibility whatsoever into them.</p><p id="10f5" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">APC Queue injection is great for executing shellcode in local processes 100% reliably, and can also be used for remote process injection, albeit with slightly less reliability — fortunately, there are ways to improve on it which I’ll cover.</p><h3 id="e6f6" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">So what on earth is an APC?</h3><p id="b959" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">As most programmers know, <strong class="nv hm">threads</strong> execute code concurrently (and often in parallel) within the same process. An <strong class="nv hm">Asynchronous Procedure Call (APC) </strong>executes code asynchronously in the context of a thread. APCs are peculiar to Windows, so you won’t find them on Linux.</p><p id="07ce" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">Essentially, each thread has an <strong class="nv hm">APC Queue</strong>, or a queue of APCs to execute. Adding an APC to a queue is about as simple as creating a thread, in that you just have to specify a routine for the APC to execute. To use an APC to execute our shellcode, we just specify a pointer to our shellcode in memory and queue that as an APC.</p><p id="a687" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">The reason you most likely have not heard of APCs is because they are most commonly used by the kernel. However, APCs can be queued from both user-mode and kernel-mode. The Windows API function to queue an APC is <code class="de qo qp qq qr b">QueueUserAPC</code>, and the undocumented NTDLL function that it calls is <code class="de qo qp qq qr b">NtQueueApcThread</code>.</p><h3 id="da25" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">The Problem with APCs</h3><p id="a5d7" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">Sounds pretty great so far, right? Unfortunately, there’s a somewhat significant caveat — a user-mode APC will only be picked up and executed by the thread it’s queued on if the thread is in an <strong class="nv hm">alertable state.</strong></p><p id="e5a7" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">Threads only enter alertable states when certain I/O-related functions are called, e.g. for IPC (inter-process communication) and so forth. As a result, finding alertable threads isn’t super easy. To make things worse, there’s no way to check which threads are in alertable states and which aren’t. You can find more on this, including a list of functions that will put threads in an alertable state, <a class="ah qs" href="https://docs.microsoft.com/en-us/windows/win32/fileio/alertable-i-o" rel="noopener ugc nofollow" target="_blank">here</a>.</p><h3 id="698b" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">A Solution for executing APCs</h3><p id="31f7" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">Fortunately, there are two possible solutions to this problem.</p><p id="1294" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">Option #1: we can elect to not perform process injection, and to inject into the APC queue of a thread in the launcher process. Then, we can force-flush the APC queue with an unexported NTDLL function. This entails a standalone launcher, that doesn’t do process injection, but with some userland PEB spoofing (e.g. PPID spoofing + command line spoofing) this can still be a viable option — I’ve had it work on engagements before.</p><p id="5a25" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">Option #2: We spray APCs across most/all of a process’s threads and hope for the best. The reliability of this depends on how many threads your target process has, and how much I/O the process is doing. I’ve found that I’ve achieved 100% success when targeting the main process of web browsers (chrome, firefox, etc.) — for example, Firefox’s main process that controls the child processes for additional tabs often has 50+ threads and does a lot of I/O. Often I’ll get 8+ beacons back. However, there’s a caveat to this — inject into too few threads, and you won’t get a beacon back. Inject into too many, and you risk making the process unresponsive or buggy for the user.</p><p id="e0c2" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">You can further increase your chances of success for option #2 by writing a tool to enumerate writable processes and their thread counts, and then pick one that looks viable. I wrote a program to do this, and even though I didn’t try and use unhooked API calls or direct syscalls, it wasn’t detected since it’s not technically doing anything “evil”. It’s a super easy program to write, so I won’t go into depth on this here.</p><h3 id="aa58" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">APC Queue Injection Mechanics</h3><p id="baa0" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">I put together a diagram that describes how to perform remote process injection via APC Queue injection — it’s important to note though that it does gloss over a few important things like opening processes and closing handles for the sake of brevity, but you should be able to infer these — once you’re done with a handle, close it. Simple.</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div class="nf ng rb"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*VENvYp4j0gEo16WicOrpTg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*VENvYp4j0gEo16WicOrpTg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*VENvYp4j0gEo16WicOrpTg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*VENvYp4j0gEo16WicOrpTg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*VENvYp4j0gEo16WicOrpTg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*VENvYp4j0gEo16WicOrpTg.png 1100w, https://miro.medium.com/v2/resize:fit:1310/format:webp/1*VENvYp4j0gEo16WicOrpTg.png 1310w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 655px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*VENvYp4j0gEo16WicOrpTg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*VENvYp4j0gEo16WicOrpTg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*VENvYp4j0gEo16WicOrpTg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*VENvYp4j0gEo16WicOrpTg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*VENvYp4j0gEo16WicOrpTg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*VENvYp4j0gEo16WicOrpTg.png 1100w, https://miro.medium.com/v2/resize:fit:1310/1*VENvYp4j0gEo16WicOrpTg.png 1310w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 655px"><img alt="" class="bi mm ns c" width="655" height="283" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:655/1*VENvYp4j0gEo16WicOrpTg.png"></picture></div><figcaption class="qu fm qv nf ng qw qx bg b bh ab eb" data-selectable-paragraph="">APC Queue Process Injection</figcaption></figure><p id="f192" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">So first, you’re going to open up your target process (omitted in the diagram above). Then, you’re going to allocate memory inside of it in read-write mode only — avoid read-write-execute memory at all costs, as it’s a red flag to EDRs and AV engines alike. Write your shellcode to it, then re-protect the memory as read-execute. This will of course break any self-decoding or self-decrypting shellcode, which I never recommend using — encrypt and encode your shellcode yourself, then decrypt it in memory before trying to execute it. <br>Once you’ve re-protected your shellcode in the remote process, you’re going to use a weird API function called <code class="de qo qp qq qr b">Createtoolhelp32Snapshot</code>, and then call <code class="de qo qp qq qr b">thread32first</code> to get a handle on the process’s first thread. Unfortunately, this process is necessary since thread IDs aren’t necessarily sequential. Once you open the thread, you’ll queue an APC to it, and then close it and move on to the next thread.</p><p id="3054" class="pw-post-body-paragraph nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo he bl" data-selectable-paragraph="">Alternatively, you can do your APC Queue injection in the local process, and therefore guarantee shellcode execution:</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div class="nf ng rc"><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*NQpNkeb2eE-dC5_eKq4poA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*NQpNkeb2eE-dC5_eKq4poA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*NQpNkeb2eE-dC5_eKq4poA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*NQpNkeb2eE-dC5_eKq4poA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*NQpNkeb2eE-dC5_eKq4poA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NQpNkeb2eE-dC5_eKq4poA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NQpNkeb2eE-dC5_eKq4poA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*NQpNkeb2eE-dC5_eKq4poA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*NQpNkeb2eE-dC5_eKq4poA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*NQpNkeb2eE-dC5_eKq4poA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*NQpNkeb2eE-dC5_eKq4poA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*NQpNkeb2eE-dC5_eKq4poA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*NQpNkeb2eE-dC5_eKq4poA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*NQpNkeb2eE-dC5_eKq4poA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"><img alt="" class="bi mm ns c" width="700" height="291" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fit:700/1*NQpNkeb2eE-dC5_eKq4poA.png"></picture></div><figcaption class="qu fm qv nf ng qw qx bg b bh ab eb" data-selectable-paragraph="">Doing APC Queue Injection in a local process</figcaption></figure><h2 id="4405" class="op oq hl bg or os ot il ou ov ow io ox oy oz pa pb pc pd pe pf pg ph pi pj pk bl" data-selectable-paragraph="">Putting it all together: building our shellcode loader</h2><p id="b84c" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">To build our EDR-evading shellcode loader, we have a few requirements:</p><ol class=""><li id="6f3c" class="nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo rd pr ps bl" data-selectable-paragraph="">Bypasses EDR hooking via direct system calls (as described above)</li><li id="1536" class="nt nu hl nv b ij pt nx ny im pu oa ob oc pv oe of og pw oi oj ok px om on oo rd pr ps bl" data-selectable-paragraph="">Decrypts encrypted shellcode in memory to avoid signature-based detections</li><li id="0956" class="nt nu hl nv b ij pt nx ny im pu oa ob oc pv oe of og pw oi oj ok px om on oo rd pr ps bl" data-selectable-paragraph="">Is capable of performing process injection without getting caught through other forms of telemetry.</li></ol><h3 id="b035" class="pz oq hl bg or qa qb ef ou qc qd eh ox oc qe qf qg og qh qi qj ok qk ql qm qn bl" data-selectable-paragraph="">Here’s the process you should follow:</h3><ol class=""><li id="9d2a" class="nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo rd pr ps bl" data-selectable-paragraph="">Generate your Cobalt Strike/other shellcode in a raw binary format</li><li id="a1e8" class="nt nu hl nv b ij pt nx ny im pu oa ob oc pv oe of og pw oi oj ok px om on oo rd pr ps bl" data-selectable-paragraph="">Encrypt the shellcode — you can use AES or just simple iterative XOR encryption with a key, just don’t use a one-byte key. All the in-memory evasion in the world won’t help you if you’re dropping unencrypted Cobalt Strike shellcode on-disk for AV/EDR to spot.</li><li id="6494" class="nt nu hl nv b ij pt nx ny im pu oa ob oc pv oe of og pw oi oj ok px om on oo rd pr ps bl" data-selectable-paragraph="">Generate the <code class="de qo qp qq qr b">.h</code> and <code class="de qo qp qq qr b">.asm</code> files that contain your the direct syscalls you want to use with SysWhispers.</li><li id="b413" class="nt nu hl nv b ij pt nx ny im pu oa ob oc pv oe of og pw oi oj ok px om on oo rd pr ps bl" data-selectable-paragraph="">Use these functions to perform APC Queue Injection in the local process or in a remote one.</li><li id="76a5" class="nt nu hl nv b ij pt nx ny im pu oa ob oc pv oe of og pw oi oj ok px om on oo rd pr ps bl" data-selectable-paragraph="">Profit.</li></ol><h2 id="fd51" class="op oq hl bg or os ot il ou ov ow io ox oy oz pa pb pc pd pe pf pg ph pi pj pk bl" data-selectable-paragraph="">(More) Caveats</h2><p id="cd13" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">A few parting notes and caveats:</p><ul class=""><li id="1b24" class="nt nu hl nv b ij nw nx ny im nz oa ob oc od oe of og oh oi oj ok ol om on oo pq pr ps bl" data-selectable-paragraph="">These techniques (for local process and remote process APC Queue Injection) worked when I tested them in July &amp; August of 2021 against Defender ATP and Crowdstrike— but this is no guarantee that they can’t or won’t be detected in the future, as always this is a point-in-time assessment.</li><li id="c2e1" class="nt nu hl nv b ij pt nx ny im pu oa ob oc pv oe of og pw oi oj ok px om on oo pq pr ps bl" data-selectable-paragraph="">This technique <strong class="nv hm">will not</strong> by itself get you past application whitelisting or application reputation scoring (the “protect your computer from potentially unwanted applications” option), which Defender ATP can do — although it’s not enabled by default. If you do run into reputation scoring, you may be able to bypass it via GUI (defender may present you with a dialog asking you if you want to run it anyways). If you run into application whitelisting, good luck.</li></ul><h2 id="3c15" class="op oq hl bg or os ot il ou ov ow io ox oy oz pa pb pc pd pe pf pg ph pi pj pk bl" data-selectable-paragraph="">Conclusion</h2><p id="ec0a" class="pw-post-body-paragraph nt nu hl nv b ij pl nx ny im pm oa ob oc pn oe of og po oi oj ok pp om on oo he bl" data-selectable-paragraph="">In this post, I’ve covered the techniques and processes that I used to develop a shellcode loader to bypass Crowdstrike and Windows Defender ATP and run Cobalt Strike on multiple engagements. While I didn’t share any code due to the sensitive nature of the topic, a sufficiently technical reader should be able to recreate something like what I have described from the details I have given. Thoughts, questions, feedback? Feel free to ping me on my <a class="ah qs" href="https://twitter.com/0xblacklight" rel="noopener ugc nofollow" target="_blank">Twitter</a>!</p></div></div></div></div></section></div></div></article></div><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="re rf ac ju"><div class="rg ac"><a class="rh ak ao aq" href="https://medium.com/tag/penetration-testing?source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><div class="ri fr de rj gv rk rl bg b bh ab bl gc">Penetration Testing</div></a></div><div class="rg ac"><a class="rh ak ao aq" href="https://medium.com/tag/red-team?source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><div class="ri fr de rj gv rk rl bg b bh ab bl gc">Red Team</div></a></div><div class="rg ac"><a class="rh ak ao aq" href="https://medium.com/tag/malware?source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><div class="ri fr de rj gv rk rl bg b bh ab bl gc">Malware</div></a></div><div class="rg ac"><a class="rh ak ao aq" href="https://medium.com/tag/hacking?source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><div class="ri fr de rj gv rk rl bg b bh ab bl gc">Hacking</div></a></div><div class="rg ac"><a class="rh ak ao aq" href="https://medium.com/tag/cybersecurity?source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><div class="ri fr de rj gv rk rl bg b bh ab bl gc">Cybersecurity</div></a></div></div></div></div><div class="m"></div><div class="sb m"><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="ac jh jf jd sc sd"><div class="se sf sg sh si sj sk sl sm sn ac cw"><div class="i l"><a tabindex="0" rel="noopener follow" href="https://kylemistele.medium.com/?source=post_page---post_author_info--b98cc076eb9a---------------------------------------" data-discover="true"><div class="m fr"><img alt="Kyle Mistele" class="m fk by so sp de" width="48" height="48" loading="lazy" src="https://miro.medium.com/v2/resize:fill:48:48/1*am8R5BslswewzFMfLCX_3g.jpeg"><div class="gj by m so sp fw o ak sq"></div></div></a></div><div class="k j e"><a tabindex="0" rel="noopener follow" href="https://kylemistele.medium.com/?source=post_page---post_author_info--b98cc076eb9a---------------------------------------" data-discover="true"><div class="m fr"><img alt="Kyle Mistele" class="m fk by sr ss de" width="64" height="64" loading="lazy" src="https://miro.medium.com/v2/resize:fill:64:64/1*am8R5BslswewzFMfLCX_3g.jpeg"><div class="gj by m sr ss fw o ak sq"></div></div></a></div><div class="k j e st cb"><div class="ac"></div></div></div><div class="ac cv cd"><div class="su sv sw sx sy m"><a class="ah ai aj al am an ao ap aq ar as at au av ac r" rel="noopener follow" href="https://kylemistele.medium.com/?source=post_page---post_author_info--b98cc076eb9a---------------------------------------" data-discover="true"><h2 class="pw-author-name bg ta tb tc td te tf tg oc qf qg og qi qj ok ql qm bl"><span class="he sz">Written by Kyle Mistele</span></h2></a><div class="rg ac jj"><div class="m cb"><span class="pw-follower-count bg b bh ab eb"><a class="ah ai aj fo al am an ao ap aq ar as at js" rel="noopener follow" href="https://kylemistele.medium.com/followers?source=post_page---post_author_info--b98cc076eb9a---------------------------------------" data-discover="true">258 followers</a></span></div><div class="bg b bh ab eb ac th"><span class="ti m" aria-hidden="true"><span class="bg b bh ab eb">·</span></span><a class="ah ai aj fo al am an ao ap aq ar as at js" rel="noopener follow" href="https://kylemistele.medium.com/following?source=post_page---post_author_info--b98cc076eb9a---------------------------------------" data-discover="true">14 following</a></div></div><div class="tj m"><p class="bg b bh ab bl"><span class="he">Student, hacker, OSCP. My other computer is your computer.</span></p></div></div></div><div class="i l"><div class="ac"></div></div></div></div></div></div><div class="tk m"><div class="tl bi s sb"></div><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="ac r cw"><h2 class="bg ta os il ou ov io ox oy pa pb pc pe pf pg pi pj bl">No responses yet</h2><div class="ac tm"><div><div class="bn" aria-describedby="15" aria-labelledby="15" role="tooltip"><div tabindex="-1" class="bf"><a class="tn to" href="https://policy.medium.com/medium-rules-30e5502c4eb4?source=post_page---post_responses--b98cc076eb9a---------------------------------------" rel="noopener follow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" aria-label="Shield with a checkmark" viewBox="0 0 25 25"><path fill-rule="evenodd" d="M11.987 5.036a.754.754 0 0 1 .914-.01c.972.721 1.767 1.218 2.6 1.543.828.322 1.719.485 2.887.505a.755.755 0 0 1 .741.757c-.018 3.623-.43 6.256-1.449 8.21-1.034 1.984-2.662 3.209-4.966 4.083a.75.75 0 0 1-.537-.003c-2.243-.874-3.858-2.095-4.897-4.074-1.024-1.951-1.457-4.583-1.476-8.216a.755.755 0 0 1 .741-.757c1.195-.02 2.1-.182 2.923-.503.827-.322 1.6-.815 2.519-1.535m.468.903c-.897.69-1.717 1.21-2.623 1.564-.898.35-1.856.527-3.026.565.037 3.45.469 5.817 1.36 7.515.884 1.684 2.25 2.762 4.284 3.571 2.092-.81 3.465-1.89 4.344-3.575.886-1.698 1.299-4.065 1.334-7.512-1.149-.039-2.091-.217-2.99-.567-.906-.353-1.745-.873-2.683-1.561m-.009 9.155a2.672 2.672 0 1 0 0-5.344 2.672 2.672 0 0 0 0 5.344m0 1a3.672 3.672 0 1 0 0-7.344 3.672 3.672 0 0 0 0 7.344m-1.813-3.777.525-.526.916.917 1.623-1.625.526.526-2.149 2.152z" clip-rule="evenodd"></path></svg></a></div></div></div></div></div><div class="tp tq tr ts tt m"><div><div class="bg b bh ab bl"><div class="wy"><div class="xg m"><div class="xh ac r"><div class="m fr"><img alt="" class="m fk by bz ca de" width="32" height="32" loading="lazy" role="presentation" src="https://miro.medium.com/v2/resize:fill:32:32/1*dmbNkD5D-u45r44go_cf0g.png"><div class="gj by m bz ca fw o ak sq"></div></div><div class="bo ac cu cv ci"><p class="bg b bh ab eb">Write a response</p></div></div><div class="de bq ac cv wz xa"><div class="ac cv fr"><span data-dd-action-name="Susi presentation tracker respond_sidebar"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fkylemistele.medium.com%2Fa-beginners-guide-to-edr-evasion-b98cc076eb9a&amp;source=---post_responses--b98cc076eb9a---------------------respond_sidebar------------------" rel="noopener follow"><div class="vb m"><p class="bg b bh ab eb">What are your thoughts?</p></div></a></span><div class="cw xb eb ac xc wc xd"><span class="bg b bh ab eb"><div class="ac"><div><div class="bn" aria-describedby="28" aria-labelledby="28" role="tooltip"><div tabindex="-1" class="bf"><span role="button" aria-label="Bold (⌘B)" class="xi xj xk xl bq mg ci xm xn xo" tabindex="0"><svg width="21" height="21"><path fill-rule="evenodd" d="M10.308 17.993h-5.92l.11-.894.783-.12c.56-.11.79-.224.79-.448V5.37c0-.225-.113-.336-.902-.448H4.5l-.114-.894h6.255c4.02 0 5.58 1.23 5.58 3.13 0 1.896-1.78 3.125-3.79 3.463v.11c2.69.34 4.25 1.56 4.25 3.57 0 2.35-2.01 3.69-6.37 3.69l.02.01h-.02zm-.335-12.96H8.967V10.5h1.23c1.788 0 2.79-1.23 2.79-2.683 0-1.685-1.004-2.803-3.006-2.803v.02zm-.223 6.36h-.783v5.588l1.225.23h.22c1.67 0 3.01-1.004 3.01-2.792 0-2.122-1.566-3.016-3.69-3.016h.018z"></path></svg></span></div></div></div><div><div class="bn" aria-describedby="29" aria-labelledby="29" role="tooltip"><div tabindex="-1" class="bf"><span role="button" aria-label="Italic (⌘I)" class="xi xj xk xl bq mg ci xm xn xo" tabindex="0"><svg width="21" height="21"><path fill-rule="evenodd" d="M9.847 18.04c-.533 0-2.027-.64-1.92-.853l2.027-7.68-.64-.214-1.387 1.494-.427-.427c.534-1.173 1.707-2.667 2.774-2.667.533 0 2.24.534 2.133.854l-2.133 7.786.533.214 1.6-1.067.427.427c-.64 1.066-1.92 2.133-2.987 2.133m2.347-11.733c-.96 0-1.387-.64-1.387-1.387 0-1.067.747-1.92 1.493-1.92.854 0 1.387.64 1.387 1.493-.107 1.067-.747 1.814-1.493 1.814"></path></svg></span></div></div></div></div></span><div class="xe st ac xc wc xd"><div class="xf"><button class="bg b ec ab bl xp xq xr xs mf mb vt fc fd fe xt xu xv fh fi fj fk bn fl fm" data-testid="CancelResponseButton">Cancel</button></div><button class="bg b ec ab vo xp vp vq vr vs vt fc fd vu vv vw fh fi fj fk bn fl fm" disabled="" data-testid="ResponseRespondButton">Respond</button></div></div></div></div></div></div></div></div></div></div></div></div><div class="tu tv tw tx ty m bx"><div class="i l k"><div class="tl bi tz ua"></div><div class="ac ci"><div class="cp bi gq gr gs gt"><div class="ub ac ld ju"><div class="uc ud m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://help.medium.com/hc/en-us?source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Help</p></a></div><div class="uc ud m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://status.medium.com/?source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Status</p></a></div><div class="uc ud m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://medium.com/about?autoplay=1&amp;source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">About</p></a></div><div class="uc ud m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Careers</p></a></div><div class="uc ud m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="mailto:pressinquiries@medium.com" rel="noopener follow"><p class="bg b ec ab eb">Press</p></a></div><div class="uc ud m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://blog.medium.com/?source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Blog</p></a></div><div class="uc ud m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Privacy</p></a></div><div class="uc ud m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://policy.medium.com/medium-rules-30e5502c4eb4?source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Rules</p></a></div><div class="uc ud m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Terms</p></a></div><div class="uc m"><a class="ah ai aj fo al am an ao ap aq ar as at au av" href="https://speechify.com/medium?source=post_page-----b98cc076eb9a---------------------------------------" rel="noopener follow"><p class="bg b ec ab eb">Text to speech</p></a></div></div></div></div></div></div></div></div></div></div></div></div>





































<div height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" data-original-tag="iframe"></div>
<div><div class="grecaptcha-badge" data-style="bottomright" style="width: 256px; height: 60px; display: block; transition: right 0.3s; position: fixed; bottom: 14px; right: -186px; box-shadow: gray 0px 0px 5px; border-radius: 2px; overflow: hidden;"><div class="grecaptcha-logo"><div title="reCAPTCHA" width="256" height="60" role="presentation" name="a-c84np5hv1oba" frameborder="0" scrolling="no" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-top-navigation allow-modals allow-popups-to-escape-sandbox allow-storage-access-by-user-activation" src="https://www.google.com/recaptcha/enterprise/anchor?ar=1&amp;k=6Le-uGgpAAAAAPprRaokM8AKthQ9KNGdoxaGUvVp&amp;co=aHR0cHM6Ly9reWxlbWlzdGVsZS5tZWRpdW0uY29tOjQ0Mw..&amp;hl=en&amp;v=vUgXt_KV952_-5BB2jjloYzl&amp;size=invisible&amp;anchor-ms=20000&amp;execute-ms=30000&amp;cb=d2a89yk9htpt" data-original-tag="iframe">

<title>reCAPTCHA</title>

<link rel="stylesheet" type="text/css" href="https://www.gstatic.com/recaptcha/releases/vUgXt_KV952_-5BB2jjloYzl/styles__ltr.css">


<div id="rc-anchor-alert" class="rc-anchor-alert"></div>

<div class="rc-anchor rc-anchor-invisible rc-anchor-light  rc-anchor-invisible-hover"><div id="recaptcha-accessible-status" class="rc-anchor-aria-status" aria-hidden="true">Recaptcha requires verification. </div><div class="rc-anchor-error-msg-container" style="display:none"><span class="rc-anchor-error-msg" aria-hidden="true"></span></div><div class="rc-anchor-normal-footer"><div class="rc-anchor-logo-large" role="presentation"><div class="rc-anchor-logo-img rc-anchor-logo-img-large"></div></div><div class="rc-anchor-pt"><a href="https://www.google.com/intl/en/policies/privacy/" target="_blank">Privacy</a><span aria-hidden="true" role="presentation"> - </span><a href="https://www.google.com/intl/en/policies/terms/" target="_blank">Terms</a></div></div><div class="rc-anchor-invisible-text"><span>protected by <strong>reCAPTCHA</strong></span><div class="rc-anchor-pt"><a href="https://www.google.com/intl/en/policies/privacy/" target="_blank" style="">Privacy</a><span aria-hidden="true" role="presentation"> - </span><a href="https://www.google.com/intl/en/policies/terms/" target="_blank" style="">Terms</a></div></div></div><div style="display: none;" data-original-tag="iframe"></div></div></div><div class="grecaptcha-error"></div><textarea id="g-recaptcha-response-100000" name="g-recaptcha-response" class="g-recaptcha-response" style="width: 250px; height: 40px; border: 1px solid rgb(193, 193, 193); margin: 10px 25px; padding: 0px; resize: none; display: none;"></textarea></div><div style="display: none;" data-original-tag="iframe"></div></div></body></html>