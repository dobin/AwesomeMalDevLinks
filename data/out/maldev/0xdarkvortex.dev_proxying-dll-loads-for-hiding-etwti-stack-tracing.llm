Title:
Hiding In PlainSight – Proxying DLL Loads To Hide From ETWTI Stack Tracing

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how EDRs use stack tracing (via userland hooks and ETW/ETWTI telemetry) to detect suspicious DLL loads originating from unbacked/executable (RX) memory such as shellcode.  
- It focuses on evading these detections by “proxying” `LoadLibrary` execution onto clean threadpool worker threads so the stack trace no longer points back to the malicious RX region.  
- The author discusses why common callback-based execution often fails due to mismatched callback prototypes/arguments and because the callback’s return address still appears in the stack frame.  
- A key technique is using a small assembly stub that *jumps* to `LoadLibraryA` (instead of calling it) after fixing registers, preventing the malicious callback frame/return address from being added to the call stack.  
- The example uses `TpAllocWork`/`TpPostWork` (ntdll threadpool APIs) and notes prior art with `RtlRegisterWait` and `RtlQueueWorkItem`, plus mentions discovering many other callback sites that can be similarly abused.  
- Useful primarily for red teamers, implant/C2 developers, and malware researchers studying ETW/stack-trace-based detections and evasions.

Technical Focus:
- ETW/ETWTI stack-walking telemetry for API attribution
- Userland hooking vs kernel/ETW-based detection of `LoadLibrary`/`LdrLoadDll`
- Windows threadpool callbacks (`TpAllocWork`, `TpPostWork`, `TpReleaseWork`)
- Stack frame/return address manipulation (CALL vs JMP)
- x64 calling convention/register shuffling (RCX/RDX) for callback argument fixing
- PEB/module enumeration to retrieve loaded module base addresses

Use Cases:
- Loading dependent DLLs from shellcode without exposing an RX-origin stack trace
- EDR evasion research around `LoadLibraryA`/`LdrLoadDll` attribution
- Building cleaner in-memory loaders that avoid “unbacked RX called LoadLibrary” heuristics
- Developing/detecting threadpool-based proxy execution patterns in implants
- Creating PoCs to validate stack-trace-based detections in security products

Keywords:
ETW, ETWTI, stack tracing, stack walking, call stack, return address, LoadLibraryA, LdrLoadDll, ntdll, kernel32, threadpool, TpAllocWork, TpPostWork, TpReleaseWork, RtlRegisterWait, RtlQueueWorkItem, QueueUserWorkItem, PEB, userland hooks, EDR evasion, x64 calling convention, shellcode, RX memory, callback abuse, assembly stub, JMP vs CALL