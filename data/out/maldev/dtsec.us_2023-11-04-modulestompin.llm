Title:
Module Stomping (and Advanced Module Stomping in a Reflective Loader)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains Module Stomping as an alternative to call stack spoofing: load/map a legitimate DLL, overwrite its executable section with payload code, and execute so stack return addresses resolve to a “real” module instead of private RX memory.  
- It demonstrates basic stomping (e.g., `LoadLibraryExA(..., DONT_RESOLVE_DLL_REFERENCES)`, `VirtualProtect`, `memcpy`, execute) and highlights the primary detection: on-disk vs in-memory section mismatches (e.g., PE-sieve).  
- It then covers “Advanced Module Stomping” variants that restore the original module bytes after execution to evade disk-vs-memory comparisons, referencing ModuleShifting, SweetDreams, and Brute Ratel’s Nightmare.  
- The author focuses on the harder case: using advanced stomping with a reflective loader/implant that must persist in memory, adapting sleep-obfuscation style context/APC chains (Foliage/Ekko concepts) to swap between implant and original module code safely.  
- A fork of AceLdr is described where IAT-hooked Sleep triggers a multi-step APC/NtContinue chain to protect memory, copy/restore module .text, encrypt/decrypt buffers, spoof thread context “at rest,” and resume execution.  
- The key remaining IOC discussed is Windows memory manager artifacts: loss of `SharedOriginal` / changes in Shared Working Set due to copy-on-write when writing to image-backed pages, which tools like Moneta can flag even if bytes are restored.

Technical Focus:
- Module stomping / image-backed payload execution
- Reflective loading and custom loaders (AceLdr-style layout/stub passing)
- Sleep obfuscation via APC chains and `NtContinue` (Foliage/Ekko patterns)
- Memory protection transitions (`NtProtectVirtualMemory`/`VirtualProtect`) and section restoration
- Detection tradeoffs: PE-sieve “modified module” vs Moneta `SharedOriginal` / shared working set heuristics

Use Cases:
- Hiding implant call stacks by ensuring return addresses map to legitimate modules
- Building reflective loaders that “sleep” while restoring clean module bytes
- Evaluating EDR/AV detections for module tampering and copy-on-write artifacts
- Developing/assessing memory scanners (PE-sieve/Moneta-style) and corresponding evasion limits

Keywords:
Module Stomping, Advanced Module Stomping, reflective loader, AceLdr, Foliage, Ekko, Brute Ratel Nightmare, PE-sieve, Moneta, SharedOriginal, Shared Working Set, copy-on-write, LoadLibraryExA, DONT_RESOLVE_DLL_REFERENCES, LdrLoadDll, NtContinue, APC, NtProtectVirtualMemory, NtSetContextThread, NtGetContextThread, SystemFunction032, IAT hook, Sleep obfuscation, .text section restoration