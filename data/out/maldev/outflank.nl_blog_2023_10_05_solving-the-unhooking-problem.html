# https://www.outflank.nl/blog/2023/10/05/solving-the-unhooking-problem/

<!DOCTYPE html><html lang="en-US" itemscope="" itemtype="https://schema.org/Article" class="chrome"><body class="wp-singular post-template-default single single-post postid-3160 single-format-standard wp-embed-responsive wp-theme-outflank mega-menu-main-menu"><div id="consent_blackbar" lang="en">
            
            <div id="truste-consent-track" style="position: relative; z-index: 999999; border-top: 1px solid rgb(102, 102, 102);" class="ta-show ta-display-block">  <div id="truste-consent-content" style="overflow: hidden;">    <div id="truste-consent-text" class="truste-messageColumn" data-nosnippet="data-nosnippet">      <span class="hstitle">This website uses cookies. You may change your settings at any time.</span>    </div>    <div id="truste-consent-buttons" class="truste-buttonsColumn" data-nosnippet="data-nosnippet">      <span id="truste-repop-msg" style="padding: 7px 10px; background: #F9EDBE; border:1px solid #F0C36D; margin: 11px 0px 13px;font-size:11; line-height: 16px;color: #AF7501; display:none;"></span>       <button id="truste-consent-button">Accept</button>      <button id="truste-consent-required">Reject All</button>      <button id="truste-show-consent" aria-haspopup="dialog">Manage Cookies</button>    </div>  </div></div></div>
<div id="teconsent" consent="undefined" aria-label="Open Cookie Preferences Modal" class="truste_caIcon_display" role="complementary"><a role="link" id="icon-id006666376041125466" tabindex="0" lang="en" aria-haspopup="dialog" aria-label="Cookie Preferences, opens a dedicated popup modal window" class="truste_cursor_pointer">Cookie Preferences</a></div>


  <!-- TrustArc tag end -->

<!-- Google Tag Manager start -->
        
        <!-- End Google Tag Manager -->
        
        
	
	
	<!-- This site is optimized with the Yoast SEO plugin v26.9 - https://yoast.com/product/yoast-seo-wordpress/ -->
	<title>Solving The "Unhooking" Problem | Outflank</title>
	
	<link rel="canonical" href="https://www.outflank.nl/blog/2023/10/05/solving-the-unhooking-problem/">
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<!-- / Yoast SEO plugin. -->


<link rel="alternate" type="application/rss+xml" title="Outflank » Feed" href="https://www.outflank.nl/feed/">
<link rel="alternate" type="application/rss+xml" title="Outflank » Comments Feed" href="https://www.outflank.nl/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="Outflank » Solving The “Unhooking” Problem Comments Feed" href="https://www.outflank.nl/blog/2023/10/05/solving-the-unhooking-problem/feed/">



<link rel="stylesheet" id="wp-block-library-css" href="https://www.outflank.nl/wp-includes/css/dist/block-library/style.min.css?ver=6.8.3" type="text/css" media="all">


<link rel="stylesheet" id="megamenu-css" href="https://www.outflank.nl/wp-content/uploads/maxmegamenu/style.css?ver=0c5a55" type="text/css" media="all">
<link rel="stylesheet" id="dashicons-css" href="https://www.outflank.nl/wp-includes/css/dashicons.min.css?ver=6.8.3" type="text/css" media="all">
<link rel="stylesheet" id="outflank-style-css" href="https://www.outflank.nl/wp-content/themes/outflank/style.css?ver=6.8.3" type="text/css" media="all">
<link rel="stylesheet" id="slick-css" href="https://www.outflank.nl/wp-content/themes/outflank/assets/css/slick.css?ver=6.8.3" type="text/css" media="all">


<link rel="https://api.w.org/" href="https://www.outflank.nl/wp-json/"><link rel="alternate" title="JSON" type="application/json" href="https://www.outflank.nl/wp-json/wp/v2/posts/3160"><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://www.outflank.nl/xmlrpc.php?rsd">
<link rel="shortlink" href="https://www.outflank.nl/?p=3160">
<link rel="alternate" title="oEmbed (JSON)" type="application/json+oembed" href="https://www.outflank.nl/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.outflank.nl%2Fblog%2F2023%2F10%2F05%2Fsolving-the-unhooking-problem%2F">
<link rel="alternate" title="oEmbed (XML)" type="text/xml+oembed" href="https://www.outflank.nl/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.outflank.nl%2Fblog%2F2023%2F10%2F05%2Fsolving-the-unhooking-problem%2F&amp;format=xml">

<link rel="stylesheet" id="294-css" href="https://www.outflank.nl/wp-content/uploads/custom-css-js/294.css?v=3883" type="text/css" media="all">

<link rel="stylesheet" id="17-css" href="https://www.outflank.nl/wp-content/uploads/custom-css-js/17.css?v=8269" type="text/css" media="all">
<link rel="pingback" href="https://www.outflank.nl/xmlrpc.php">
<link rel="icon" href="https://www.outflank.nl/wp-content/uploads/2022/03/cropped-outflank-favicon-32x32.png" sizes="32x32">
<link rel="icon" href="https://www.outflank.nl/wp-content/uploads/2022/03/cropped-outflank-favicon-192x192.png" sizes="192x192">
<link rel="apple-touch-icon" href="https://www.outflank.nl/wp-content/uploads/2022/03/cropped-outflank-favicon-180x180.png">


        <link href="https://www.outflank.nl/wp-content/themes/outflank/assets/fontawesome/css/all.min.css" rel="stylesheet">
    
    
        <div id="consent_blackbar"></div>
        <!-- Google Tag Manager (noscript) -->
        
        <!-- End Google Tag Manager (noscript) -->
        <a href="https://www.outflank.nl/blog/2023/10/05/solving-the-unhooking-problem/#content" class="skip-link screen-reader-text">Skip to the content</a><!-- start Simple Custom CSS and JS -->
<!-- Google Tag Manager (noscript) -->

<!-- End Google Tag Manager (noscript) -->

<!-- end Simple Custom CSS and JS -->
        
        <div id="container">    <section class="medium-header">
        <div class="dots"></div>
        <div class="gradient"></div>
        <div class="container big-header-text">
        <h1 class="color--white">Publications</h1>
        </div>
    </section>


    <section class="container ">
        <div class="wordpress">

            <div class="row">
                <div class="col-s-12 margin-bottom--lg text--intro">
                    <main id="content" role="main">
                                        <article id="post-3160" class="post-3160 post type-post status-publish format-standard hentry category-uncategorized tag-bof tag-detect-hooks tag-loadlibrary tag-opsec-safe tag-ost tag-syscalls tag-unhooking">

<div class="entry-content" itemprop="mainEntityOfPage">

<p>For avoiding EDR userland hooks, there are many ways to cook an egg:</p>



<p>Direct system calls (syscalls), Indirect syscalls, unhooking, hardware breakpoints, and bringing and loading your own version of a library. These methods each have advantages and disadvantages. When developing a C2 implant it’s nice to work with a combination of multiple of these. For instance, you could use a strong (in)direct syscall library for direct usermode to kernel transition, then use unhooking or hardware breakpoints for user mode-only (to bypass AMSI, ETW e.g.) functions.</p>



<p>Regarding system calls, excellent research has already been done. A small selection of relevant blog posts is Klezvirus’ post on <a href="https://klezvirus.github.io/RedTeaming/AV_Evasion/NoSysWhisper/">syswhispers</a>, MDSec’s post on <a href="https://www.mdsec.co.uk/2020/12/bypassing-user-mode-hooks-and-direct-invocation-of-system-calls-for-red-teams/">direct invocation of system calls</a> and our own blog post on <a href="https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/">combining direct system calls srdi</a>.</p>



<p>So, in this blog we’ll zoom in on protecting calls to user mode functions.</p>



<h2 class="wp-block-heading">Protecting Your Implant</h2>



<p>Protecting your implant’s calls to user mode functions works great when the implant code is in the developer’s control. However, there’s a catch. What happens if your C2 implant supports running external code, such as BOF’s or (C#) executables? The problem here is that this allows external code to be ran in the target implant’s process. This code can load additional libraries using <code>LoadLibrary</code>, which some EDRs hook right after the loading. Running an OPSEC sensitive BOF can easily lead to detection by an EDR, especially if no precautions are taken.</p>



<p>Some of this risk can easily be mitigated by linking-in a custom LoadLibrary wrapper, which performs a LoadLibrary and some unhooking on the target library before returning. However, this does not fully solve the problem and can lead to a cat and mouse game as a library can in turn, load another library as a dependency which can be hooked and needs to be unhooked, etc.</p>



<p>In the mind of an offensive security researcher, additional scenarios and thoughts quickly pop up. For example: The BOF/exe can decide to use a lower-level function, such as LoadLibraryExW, LdrLoadDll or LdrpLoadDll for OPSEC reasons. But perhaps the DLL was already loaded (and hooked) before the implant even started. Or what if we make the code try to resolve LoadLibrary itself? In this case, would it be better to hook LoadLibrary itself? Will that cause detections? Will it interfere with the sleepmask when the implant’s code is obfuscated during sleep? What happens if the host process itself performs a legitimate LoadLibrary?</p>



<p>While not trivial, this problem is solvable programmatically. The downside is that it will be hard to debug if something unexpected happens. Plus, it will be yet another black-box for the red team operator.</p>



<h2 class="wp-block-heading">The Better Solution for Implant Protection</h2>



<p>If we take one step back, we can see a better option: Protect the operator for running into hooks in all normal cases and let the operator choose between transparency or verbosity. This will protect the casual operator, yet at the same time allows experienced operators to learn about and influence hooks (i.e. unhook) where needed.</p>



<p>This involves creating a way for operators to load an additional library, check it for hooks, and clean it. Or for more simple usage, check and clean all processes’ library hooks. At Outflank we have our C2 framework called <a href="https://outflank.nl/videos/stage-1/">Stage1</a> as part of <a href="https://outflank.nl/datasheets/security-tooling-ost/">Outflank Security Tooling</a>. We have implemented this unhooking functionality in Stage1. It will detect and unhook function hooks as well as Import Address Table (IAT) hooks. You can see this in figures 1 and 2 below. By running the <code>hooks clean</code> command, Stage1 resolves a list of hooked user mode functions and unhooks them. The second command shows <code>hooks list</code> that, you guessed it correctly, detects userland API hooking. In this case, the command was executed after removing all hooks, to verify that they are not restored by the EDR.</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img fetchpriority="high" decoding="async" width="458" height="727" src="https://outflank.nl/wp-content/uploads/2023/10/hooks-clean.png" alt="" class="wp-image-3168"><figcaption class="wp-element-caption"><em>Figure 1. </em><code>hooks clean</code><em> command</em></figcaption></figure></div>

<div class="wp-block-image">
<figure class="aligncenter size-full"><img decoding="async" width="457" height="53" src="https://outflank.nl/wp-content/uploads/2023/10/hooks-list-after-clean.png" alt="" class="wp-image-3169"><figcaption class="wp-element-caption"><em>Figure 2. </em><code>hooks list</code><em> command</em> after cleaning</figcaption></figure></div>


<p>While the concept and implementation are simple, the result can be extremely valuable: It allows red team operators to learn about an EDR’s presence, its hooking strategy, and get a feel for how the EDR works. With this crucial knowledge, operators can modify their techniques, their BOFs, and Python wrappers for automation to pre-load and unhook libraries before usage (yes you read that right, Stage1 C2 uses Python for automation!)</p>



<p>But we can even take this another step further:</p>



<p>Part of Outflank Security Tooling is the tooling part. But another vital part is the trusted community of red teamers where knowledge is shared. OST provides Stage1 BOF Python automations for all OST tools as well as commonly used BOFs on Github such as TrustedSec’s BOF collections, Chlonium, etc. An example of automating this can be seen in the below Python code for a Stage1 C2 automation bot.</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img decoding="async" width="615" height="378" src="https://outflank.nl/wp-content/uploads/2023/09/Unhooking_problem_automation_python.png" alt="" class="wp-image-3163"><figcaption class="wp-element-caption"><em>Figure 3. Automation of BOF using Python</em></figcaption></figure></div>


<p>By sharing and documenting this knowledge in the OST community, we have much larger sample size than a single red team. With the power of automation we can further optimise for OPSEC.</p>



<h2 class="wp-block-heading">Wrapping Up</h2>



<p>Offensive developers tend to choose the technical approach. In this blog we’ve demonstrated that a less technical and more transparent approach has several important benefits: Operators want to learn more about hooking and by distributing this knowledge in our trusted community, we can stay ahead of EDRs and continue running operations.</p>



<p>Stage1 C2 is only a small piece of OST. If you’re interested in seeing more of the diverse offerings in this offensive toolset, we recommend scheduling an expert led demo.</p>



<div class="wp-block-buttons is-content-justification-center is-layout-flex wp-container-core-buttons-is-layout-16018d1d wp-block-buttons-is-layout-flex">
<div class="wp-block-button"><a class="wp-block-button__link wp-element-button" href="https://outflank.nl/demo-request/">Schedule a Demo</a></div>
</div>
<div class="entry-links"></div>
</div>
</article>                                                                
                    </main>
                </div>
            </div>
        </div>
    </section>
        </div>
        <div class="incident-overlay js-incident-overlay">
            
            <div class="dots"></div>
            <div class="gradient"></div>

            <button class="incident-overlay__close js-incident-overlay-trigger">
                <span></span>
                <span></span>
            </button>
            <section class="incident-overlay__content"><h2 class="widgettitle">Need help right away?<br>Call our emergency number</h2>
			<div class="textwidget"><p><a class="button button--highlight" href="tel:0202618996">+31 20 2618996</a></p>
<p>Or send us an <a href="mailto:info@outflank.nl?subject=[Incident%20-%20www.outflank.nl]">email</a> and we’ll get back to you as soon as possible</p>
</div>
		</section>        </div>
        
        
    


<div class="ta-display-none" name="trustarc_notice" id="trustarcNoticeFrame" title="Trustarc Cross-Domain Consent Frame" src="https://consent.trustarc.com/get?name=crossdomain.html&amp;domain=helpsystems.com" data-original-tag="iframe"></div>




    
</body></html>