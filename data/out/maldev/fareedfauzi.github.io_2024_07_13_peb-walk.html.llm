Title:
PEB Walk: Dynamically Resolving Windows APIs via the Process Environment Block

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how malware and shellcode use a “PEB walk” to find loaded modules (notably `ntdll.dll`/`kernel32.dll`) and resolve API addresses at runtime instead of relying on the Import Address Table (IAT).  
- The technique reduces static visibility of API usage, making quick triage via imports less effective and complicating reverse engineering.  
- It covers the relevant Windows internals structures (`PEB`, `PEB_LDR_DATA`, `LDR_DATA_TABLE_ENTRY`) and how to access the PEB in 32-bit processes via `fs:[0x30]` (TEB → PEB pointer).  
- A full C example demonstrates enumerating `InLoadOrderModuleList` to locate `kernel32.dll`, manually parsing its PE export table to find `LoadLibraryA`/`GetProcAddress`, then loading `user32.dll` and calling `MessageBoxA`.  
- The post also shows how to reverse such a sample in IDA Pro by adding custom struct definitions and applying them to decompiler variables to improve readability.  
- Useful primarily for malware analysts and reverse engineers; also relevant to red teamers and exploit/shellcode developers who need import-less API resolution.

Technical Focus:
- PEB/TEB access (`fs:[0x30]`) and process loader data
- Module enumeration via `PEB_LDR_DATA` linked lists (`InLoadOrderModuleList`)
- `LDR_DATA_TABLE_ENTRY` parsing to obtain module base addresses
- Manual PE export table parsing (`IMAGE_DOS_HEADER`, `IMAGE_NT_HEADERS`, `IMAGE_EXPORT_DIRECTORY`)
- Dynamic API resolution (`LoadLibraryA`, `GetProcAddress`) without IAT
- IDA Pro decompilation improvement via custom local types/struct application

Use Cases:
- Analyze malware/shellcode that hides imports and resolves APIs dynamically
- Build or understand import-less loaders and shellcode API resolvers
- Create reverse-engineering workflows in IDA for PEB-walk based samples
- Detect/triage binaries that avoid IAT-based behavioral inference

Keywords:
PEB walk, Process Environment Block, TEB, fs:[0x30], NtCurrentPeb, PEB_LDR_DATA, LDR_DATA_TABLE_ENTRY, InLoadOrderModuleList, kernel32.dll, ntdll.dll, user32.dll, IAT evasion, dynamic API resolution, LoadLibraryA, GetProcAddress, MessageBoxA, PE export parsing, IMAGE_EXPORT_DIRECTORY, IDA Pro, WinDbg !peb