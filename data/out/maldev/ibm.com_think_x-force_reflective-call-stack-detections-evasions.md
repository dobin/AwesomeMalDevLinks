# https://www.ibm.com/think/x-force/reflective-call-stack-detections-evasions

[Skip to content](https://www.ibm.com/think/x-force/reflective-call-stack-detections-evasions#main-content)[IBM logo](https://www.ibm.com/)

Software

Infrastructure

[Consulting](https://www.ibm.com/consulting?lnk=L0G)Support

[Overview](https://www.ibm.com/mysupport/s/?language=en_US&lnk=flathl)[Community](https://community.ibm.com/community/user/community?lnk=flathl)[Developer](https://developer.ibm.com/?lnk=flathl)[Documentation](https://www.ibm.com/docs/en?lnk=flathl)[IBM Cloud platform](https://www.ibm.com/products/cloud/support?lnk=flathl)[Implementation](https://www.ibm.com/products/expertlabs?lnk=flatitem)[Training](https://www.ibm.com/training/?lnk=flathl)[Technology Lifecycle Services](https://www.ibm.com/services/technology-lifecycle-services?lnk=flathl)[Think 2026](https://www.ibm.com/events/think)

[Cart](https://www.ibm.com/store/en/us/checkout)

My IBM
Log in


[Think](https://www.ibm.com/think)

- [Artificial intelligence](https://www.ibm.com/think/artificial-intelligence)
- [Cloud](https://www.ibm.com/think/cloud)
- [Security](https://www.ibm.com/think/security)
- [News](https://www.ibm.com/think/news)
- Videos






  - [Overview](https://www.ibm.com/think/videos)
  - [AI Academy](https://www.ibm.com/think/videos/ai-academy)
  - [Think 2025 on demand](https://www.ibm.com/think/videos/think-keynotes)
  - [Webinars](https://www.ibm.com/think/webinars)

- Reports






  - [Cost of a Data Breach Report 2025](https://www.ibm.com/reports/data-breach)
  - [The 2025 CEO Study](https://www.ibm.com/thought-leadership/institute-business-value/c-suite-study/ceo)
  - [IBM X-Force 2025 Threat Intelligence Index](https://www.ibm.com/thought-leadership/institute-business-value/report/2025-threat-intelligence-index)
  - [Industries in the AI era](https://www.ibm.com/thought-leadership/institute-business-value/report/industries-ai-era)
  - [Orchestrating agentic AI for intelligent business operations](https://www.ibm.com/thought-leadership/institute-business-value/report/agentic-process-automation)
  - [Scaling supply chain resilience: Agentic AI for autonomous operations](https://www.ibm.com/thought-leadership/institute-business-value/report/supply-chain-ai-automation-oracle)
  - [AI in Action report](https://www.ibm.com/think/reports/ai-in-action)
  - [State of Sustainability Readiness Report](https://www.ibm.com/think/reports/sustainability-readiness)
  - [View all IBV reports](https://www.ibm.com/thought-leadership/institute-business-value)

- Podcasts






  - [Overview](https://www.ibm.com/think/podcasts)
  - [AI in Action](https://www.ibm.com/think/podcasts/ai-in-action)
  - [Mixture of Experts](https://www.ibm.com/think/podcasts/mixture-of-experts)
  - [Security Intelligence](https://www.ibm.com/think/podcasts/security-intelligence)
  - [Smart Talks with IBM](https://www.ibm.com/think/podcasts/smart-talks)
  - [Techsplainers](https://www.ibm.com/think/podcasts/techsplainers)
  - [The Coherence Times](https://www.ibm.com/think/podcasts/the-coherence-times)
  - [Transformers Podcast](https://www.ibm.com/think/podcasts/transformers-podcast)

- Events






  - [Think 2026](https://www.ibm.com/events/think)
  - [Think on Tour](https://www.ibm.com/events/think/on-tour)
  - [TechXchange](https://www.ibm.com/events/techxchange)
  - [View all IBM Events](https://www.ibm.com/events)

- More






## Topics



  - [Analytics](https://www.ibm.com/think/analytics)
  - [Asset management](https://www.ibm.com/think/asset-management)
  - [Business automation](https://www.ibm.com/think/business-automation)
  - [Business operations](https://www.ibm.com/think/business-operations)
  - [Compute and servers](https://www.ibm.com/think/compute)
  - [DevOps](https://www.ibm.com/think/devops)
  - [IT automation](https://www.ibm.com/think/it-automation)
  - [IT infrastructure](https://www.ibm.com/think/it-infrastructure)
  - [Middleware](https://www.ibm.com/think/middleware)
  - [Network](https://www.ibm.com/think/network)
  - [Quantum](https://www.ibm.com/think/quantum)
  - [Security](https://www.ibm.com/think/security)
  - [Storage](https://www.ibm.com/think/storage)
  - [Sustainability](https://www.ibm.com/think/sustainability)

## Content types

  - [Explainers](https://www.ibm.com/think/topics)
  - [Insights](https://www.ibm.com/think/insights)
  - [News](https://www.ibm.com/think/news)
  - [Newsletters](https://www.ibm.com/subscribe)
  - [Reference architectures](https://www.ibm.com/think/architectures)
  - [Tutorials](https://www.ibm.com/think/tutorials)

## Industries

  - [Automotive](https://www.ibm.com/think/automotive)
  - [Banking](https://www.ibm.com/think/banking-financial-markets)
  - [Consumer Goods](https://www.ibm.com/think/consumer-goods)
  - [Energy & Utilities](https://www.ibm.com/think/energy)
  - [Government](https://www.ibm.com/think/government)
  - [Healthcare](https://www.ibm.com/think/healthcare)
  - [Manufacturing](https://www.ibm.com/think/manufacturing)
  - [Retail](https://www.ibm.com/think/retail)
  - [Telecommunications](https://www.ibm.com/think/telecommunications)
  - [Travel](https://www.ibm.com/think/travel-transportation)

[View all](https://www.ibm.com/think/search)

Subscribe

[Security](https://www.ibm.com/think/security)

# Reflective call stack detections and evasions

![Aerial view of hands typing on a computer](https://assets.ibm.com/is/image/ibm/pdf01705?dpr=on%2C1&wid=320&hei=196)

- [Overview](https://www.ibm.com/think/x-force/reflective-call-stack-detections-evasions#Overview)
- [Call stack detections and evasions](https://www.ibm.com/think/x-force/reflective-call-stack-detections-evasions#Call+stack+detections+and+evasions)
- [Bokuloader integration](https://www.ibm.com/think/x-force/reflective-call-stack-detections-evasions#Bokuloader+integration)
- [Closing thoughts](https://www.ibm.com/think/x-force/reflective-call-stack-detections-evasions#Closing+thoughts)

## Author

Bobby Cooke

Red Team Operator

Adversary Services, IBM X-Force Red

Dylan Tran

Student and Offensive Security Professional

In [a blog published](https://securityintelligence.com/x-force/defining-cobalt-strike-reflective-loader/) this March, we explored reflective loading through the lens of an offensive security tool developer, highlighting detection and evasion opportunities along the way. This time we are diving into call stack detections and evasions, and how BokuLoader reflectively loads call stack spoofing capabilities into beacon.

We created this blog and public release of BokuLoader during Dylan’s summer 2023 internship with IBM X-Force Red. While researching call stack spoofing for our in-house C2, this was one of the techniques identified — the X-Force Adversary Services team’s private C2 has much stealthier techniques implemented. The call stack evasion techniques that have been integrated into BokuLoader are not novel and are publicly disclosed. While these techniques are available to security vendors, detections for these evasions may not be present.

In this post, we have created hypothetical detections that could be implemented to detect publicly disclosed active call stack evasion techniques. Each detection has exceptions. Significant tuning would be required before they are deployed into customer environments.

While sharing call stack evasions from the perspective of an offensive operator, our intention is to equip threat hunters and detection engineers with knowledge on how to detect advanced malware from call stack traces.

## Call stack detections and evasions

### Call stack detection \#1 — Return address hunting

When analyzing a call stack, verify that the caller’s return address resolves to a loaded module. Unresolved addresses could hint to shellcode and be flagged as malicious. This detection exists in some form within most modern security solutions.

![Diagram of detecting shellcode by checking caller’s return address](https://assets.ibm.com/is/image/ibm/reflective-call-stack-detections-and-evasions-1:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

_Diagram of detecting shellcode by checking caller’s return address_

In this call stack below, a sleeping beacon’s return address is exposed.

![Default beacon with return address exposed in call stack while executing Sleep API](https://assets.ibm.com/is/image/ibm/reflective-call-stack-detections-and-evasions-2:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

_Default beacon with return address exposed in call stack while executing Sleep API_

### Evading call stack detection \#1 — Return address spoofing

One way to evade this detection is saving beacon’s return address in a non-volatile register before calling an API, then returning to beacon through a ROP gadget in a trusted DLL. Since non-volatile registers are restored by the called API, we can rely on their values persisting through the call.

While checking the return address of the caller, security solutions may be fooled into thinking our stack frame belongs to a trusted DLL API. When our thread finishes executing the called API, it takes a different path than the stack walker. Our thread returns to the gadget, and the gadget jumps our thread back home to beacon.

![Diagram of evading caller return address detection using return address spoofing](https://assets.ibm.com/is/image/ibm/reflective-call-stack-detections-and-evasions-3:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

_Diagram of evading caller return address detection using return address spoofing_

This clever trick was popularized by Namazso in a game hacking forum and then by Kyle Avery in his AceLdr reflective loader project, which he presented at DEFCON 2022.

Like BokuLoader, AceLdr adds call stack spoofing capabilities to beacon by reflectively hooking imported APIs. Before the hook passes execution to the API, beacon’s return address is stored on the stack. This stack address is saved into the nonvolatile ``Copy to clipboard
RBX
register and a ``Copy to clipboard
jmp \[rbx\]
gadget replaces the caller’s return address. To avoid a return address to the hook being pushed onto the stack, the AceLdr hook jumps to the API instead of calling it.

![AceLdr Call Stack Evasion Thread Execution Flow](https://assets.ibm.com/is/image/ibm/reflective-call-stack-detections-and-evasions-4:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

In the call stack below, we see the gadget’s return address which resolves to the ``Copy to clipboard
WININET
module, instead of a return address to our beacon shellcode.

![AceLdr beacon call stack with return address spoofing of InternetConnectA API](https://assets.ibm.com/is/image/ibm/reflective-call-stack-detections-and-evasions-5:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

_AceLdr beacon call stack with return address spoofing of InternetConnectA API_

While examining the AceLdr call stack above, we see it ends prematurely after the gadget stack frame. This is because the return address of the next stack frame is 0. Stack walkers typically walk down the call stack until the next stack frame has a return address of 0.

### Call stack detection \#2 — Truncated call stack

When analyzing a call stack, verify the call stack traces down to common thread start APIs such as``Copy to clipboard`BaseThreadInitThunk` & `RtlUserThreadStart`
. Call stack traces that end prematurely are suspicious and could be flagged for further investigation.

![Diagram of a suspicious call stack that uses the call stack truncation evasion](https://assets.ibm.com/is/image/ibm/reflective-call-stack-detections-and-evasions-6:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

_Diagram of a suspicious call stack that uses the call stack truncation evasion._

### Evading call stack detection \#2 — Synthetic frames

To evade this call stack tracing detection we can extend the first evasion by pushing fake thread start API frames to the stack. As long as we allocate memory on the stack for our fake frames, we can continue to add frames and avoid overwriting beacon’s real call stack.

![Diagram of evading call stack tracing detections using synthetic frames](https://assets.ibm.com/is/image/ibm/reflective-call-stack-detections-and-evasions-7:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

_Diagram of evading call stack tracing detections using synthetic frames_

Synthetic frames are used in the SilentMoonwalk project as the non-default option and are also used in the Vulcan Raven project.

### Call stack detection \#3 — Hunting for the thread start frame

When analyzing a call stack, verify that the third stack frame from the bottom is a return address to the thread’s start address function. If the call stack does not align with the thread’s start function, this may be suspicious and warrant further investigation. This detection technique could be leveraged to detect both modes of the SilentMoonwalk project and the new release of BokuLoader.

![Detecting suspicious call stack due to thread start address frame missing (Desynchronization technique — left, Synthetic Frame technique — right)](https://assets.ibm.com/is/image/ibm/reflective-call-stack-detections-and-evasions-8:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

_Detecting suspicious call stack due to thread start address frame missing (Desynchronization technique — left, Synthetic Frame technique — right)_

In the below screenshot we see a thread of OneDrive.exe has a start address, which aligns with the third lowest frame in the thread’s call stack.

![Stack thread](https://assets.ibm.com/is/image/ibm/reflective-call-stack-detections-and-evasions-9:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

_The symbol from a thread’s Start Address is normally present on its call stack_

This detection will likely result in a lot of false positives if implemented without proper tuning. While typical user programs launched from the desktop follow this pattern, there are many service and background processes that do not. Regardless of the noise, threat hunters and detection engineers may find this detection technique useful while investigating call stack traces.

### Call stack detection \#4 — Hunting for gadgets

All the evasion techniques we have described depend on a ``Copy to clipboard
jmp \[rbx\]
gadget to restore execution to a handler that returns to beacon. However, it is possible to also use other nonvolatile registers such as``Copy to clipboardrsi
and ``Copy to clipboard
rdi
.

## Bokuloader integration

For the public BokuLoader project, we have incorporated the call stack spoofing capabilities of the [LoudSunRun project](https://github.com/susMdT/LoudSunRun) by Dylan Tran. Dylan’s project is derived from the SilentMoonwalk and the Vulcan Raven projects. In this release of BokuLoader synthetic stack frames are used to evade call stack detections. The detection methods described in this post should be able to detect a BokuLoader beacon.

Active call stack spoofing has been applied to all `WININET` APIs imported by the Cobalt Strike HTTPS beacon. A hashing method has been included in the BokuLoader project and replaces the previously used string encryption method. This was done to save memory on the stack and avoid potential stack overflows which would crash beacon.

![Hook call stack spoof implementation for InternetOpenA](https://assets.ibm.com/is/image/ibm/reflective-call-stack-detections-and-evasions-10:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

_Hook call stack spoof implementation for InternetOpenA_

Some direct syscalls in BokuLoader have been replaced by spoofed indirect syscalls. To determine the syscall number, the HalosGate technique is still used. A simple gadget hunter has been added which searches for a syscall gadget within the executable section of the NTDLL module.

![Execution of NtProtectVirtualMemory NTAPI via spoofed indirect syscall](https://assets.ibm.com/is/image/ibm/reflective-call-stack-detections-and-evasions-11:16x9?fmt=png-alpha&dpr=on%2C1&wid=320&hei=180)

_Executing NtProtectVirtualMemory NTAPI via spoofed indirect syscall_

## Closing thoughts

We hope you found this post helpful and learned something new about call stack detections and evasions. If you are interested in learning more, check out Dylan’s recently released blog post “ [An Introduction into Stack Spoofing](https://dtsec.us/2023-09-15-StackSpoofin/).” Stay tuned for our next post!

Industry newsletter

### The latest tech news, backed by expert insights

Stay up to date on the most important—and intriguing—industry trends on AI, automation, data and beyond with the Think Newsletter. See the [IBM Privacy Statement](https://www.ibm.com/privacy).

### Thank you! You are subscribed.

- Account information


Current

We use your email to validate you are who you say you are, to create your IBMid, and to contact you for account related matters.

Business email

Your subscription will be delivered in English. You will find an unsubscribe link in every newsletter. You can manage your subscriptions or unsubscribe [here.](https://www.ibm.com/account/reg/us-en/signup?formid=news-urx-51525) Refer to our [IBM Privacy Statement](https://www.ibm.com/us-en/privacy) for more information.

Subscribe

Your subscription will be delivered in English. You will find an unsubscribe link in every newsletter. You can manage your subscriptions or unsubscribe [here](https://www.ibm.com/account/reg/signup?formid=news-urx-51525). Refer to our [IBM Privacy Statement](https://www.ibm.com/privacy) for more information.



Mixture of Experts \| 13 February, episode 94




![What do people really use AI for?](https://cdnsecakmi.kaltura.com/p/1773841/thumbnail/entry_id/1_m4234x30/width/1180)

### Decoding AI: Weekly News Roundup

Join our world-class panel of engineers, researchers, product leaders and more as they cut through the AI noise to bring you the latest in AI news and insights.

Watch all episodes of Mixture of Experts

##### References and resources

- BokuLoader: A proof-of-concept Cobalt Strike Reflective Loader that aims to recreate, integrate, and enhance Cobalt Strike’s evasion features — [https://github.com/boku7/BokuLoader](https://github.com/boku7/BokuLoader)
- Behind the Mask: Spoofing Call Stacks Dynamically with Timers —

[https://www.cobaltstrike.com/blog/behind-the-mask-spoofing-call-stacks-dynamically-with-timers](https://www.cobaltstrike.com/blog/behind-the-mask-spoofing-call-stacks-dynamically-with-timers)
- AceLdr: Cobalt Strike UDRL for memory scanner evasion — [https://github.com/kyleavery/AceLdr](https://github.com/kyleavery/AceLdr)
- SilentMoonwalk: PoC Implementation of a fully dynamic call stack spoofer — [https://github.com/klezVirus/SilentMoonwalk](https://github.com/klezVirus/SilentMoonwalk)
- Vulcan Raven: PoC implementation for spoofing arbitrary call stacks when making syscalls — [https://github.com/WithSecureLabs/CallStackSpoofer](https://github.com/WithSecureLabs/CallStackSpoofer)
- CallStackMasker: A PoC implementation for dynamically masking call stacks with timers — [https://github.com/Cobalt-Strike/CallStackMasker](https://github.com/Cobalt-Strike/CallStackMasker)
- LoudSunRun: Call stack synthetic frame spoofer with indirect syscalls — [https://github.com/susMdT/LoudSunRun](https://github.com/susMdT/LoudSunRun)
- ThreadStackSpoofer: Thread Stack Spoofing PoC — [https://github.com/mgeeky/ThreadStackSpoofer](https://github.com/mgeeky/ThreadStackSpoofer)

Link copied


Loading

START


END


START


END


[![close icon](https://consent.trustarc.com/get?name=ibm_close_icon.svg)](https://www.ibm.com/think/x-force/reflective-call-stack-detections-evasions#)

IBM web domains

ibm.com, ibm.org, ibm-zcouncil.com, insights-on-business.com, jazz.net, mobilebusinessinsights.com, promontory.com, proveit.com, ptech.org, s81c.com, securityintelligence.com, skillsbuild.org, softlayer.com, storagecommunity.org, think-exchange.com, thoughtsoncloud.com, alphaevents.webcasts.com, ibm-cloud.github.io, ibmbigdatahub.com, bluemix.net, mybluemix.net, ibm.net, ibmcloud.com, galasa.dev, blueworkslive.com, swiss-quantum.ch, blueworkslive.com, cloudant.com, ibm.ie, ibm.fr, ibm.com.br, ibm.co, ibm.ca, community.watsonanalytics.com, datapower.com, skills.yourlearning.ibm.com, bluewolf.com, carbondesignsystem.com, openliberty.io

![close icon](https://consent.trustarc.com/get?name=ibm_close_icon.svg)

About cookies on this siteOur websites require some cookies to function properly (required). In addition, other cookies may be used with your consent to analyze site usage, improve the user experience and for advertising.For more information, please review your cookie preferences options. By visiting our website, you agree to our processing of information as described in IBM’s [privacy statement](https://www.ibm.com/privacy). To provide a smooth navigation, your cookie preferences will be shared across the IBM web domains listed [here](https://www.ibm.com/think/x-force/reflective-call-stack-detections-evasions#truste_domain_list).

Accept allMore options

# Chat window

Return to assistant

AI

#### Powered by IBM watsonx

IBM watsonx is powered by the latest AI models to intelligently process conversations and provide help whenever and wherever you may need it.

Restart conversation

Close the chat window

AI

#### Powered by IBM watsonx

IBM watsonx is powered by the latest AI models to intelligently process conversations and provide help whenever and wherever you may need it.

Restart conversation

Close the chat window

The chat window has been closed