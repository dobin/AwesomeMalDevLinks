Title:
Perfect DLL Hijacking

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post reverse engineers the Windows loader to make DLL hijacking payloads reliable despite Loader Lock restrictions in `DllMain`.  
- It explains why common “universal” DLL hijacking approaches are fragile or noisy (e.g., `VirtualProtect` RWX transitions, pointer/return-address tricks impacted by mitigations like ACG and Intel CET).  
- The author demonstrates multiple techniques: a race-based approach using `CreateThread` (with pitfalls like pseudo-handles and `SuspendThread` deadlocks), a cleaner “escape at exit” approach using CRT `atexit` variants to run code outside Loader Lock, and a “full unlock” method that programmatically releases loader synchronization to run complex APIs directly from `DllMain`.  
- A concrete target (`OfflineScannerShell.exe` hijacking `mpclient.dll`) is used to validate techniques with a complex payload (`ShellExecute`) that normally deadlocks under Loader Lock.  
- Defensive guidance includes heuristics around suspicious behavior during `LdrpCallInitRoutine`, export-name duplication for static imports, monitoring user-writable PATH/CWD DLL loads, and using process mitigations like `MicrosoftSignedOnly`.  
- Useful for red teamers and exploit/tool developers needing stable DLL side-loading, and for defenders building detections/mitigations around loader behavior and DLL search order abuse.

Technical Focus:
- Windows Loader internals (`ntdll`, `LdrpLoaderLock`, `LdrpWorkInProgress`, loader events)
- `DllMain` / Loader Lock constraints and deadlock mechanics
- CRT exit handlers (`atexit`, `_onexit`, `_crt_atexit`) and CRT mismatch (MSVCRT vs UCRT)
- Threading/synchronization pitfalls (`CreateThread`, `SuspendThread`, heap locks, critical sections)
- DLL search order hijacking via CWD/PATH and static vs dynamic loads
- Mitigations/detections (Process Mitigation `MicrosoftSignedOnly`, export validation, call-site hooking)

Use Cases:
- Reliable DLL hijacking/side-loading payload execution without Loader Lock deadlocks
- Evasive in-process execution by deferring payload via CRT exit handlers
- Researching/weaponizing loader-state manipulation for constrained execution contexts
- Building detections for suspicious API usage during loader init routines
- Hardening Windows binaries against unsigned DLL loads using process mitigations

Keywords:
DLL hijacking, DLL side-loading, DLL preloading, DllMain, Loader Lock, ntdll.dll, LdrpLoaderLock, LdrUnlockLoaderLock, LdrpReleaseLoaderLock, LdrpWorkInProgress, critical section, WinDbg, atexit, _onexit, _crt_atexit, MSVCRT, UCRT ucrtbase.dll, CreateThread, SuspendThread, HeapAlloc, ShellExecute, CWD, PATH, MicrosoftSignedOnly, ACG, Intel CET, LdrpCallInitRoutine, OfflineScannerShell.exe, mpclient.dll