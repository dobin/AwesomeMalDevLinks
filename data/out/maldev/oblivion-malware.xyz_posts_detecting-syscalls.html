# https://oblivion-malware.xyz/posts/detecting-syscalls/

<!DOCTYPE html><html lang="en" dir="ltr" data-cast-api-enabled="true"><body class="date-20260218 en_US ltr  site-center-aligned site-as-giant-card webkit webkit-537" dir="ltr"><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Detoning Direct/Indirect Syscalls by several approachs</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><p>In this blog post, we’ll focus on the topic of <em>direct/indirect syscall</em>. I won’t go into detail about how a <em>syscall</em> works or the <em>hooking</em> mechanism. If you’re not familiar with the topic, you can check out my previous posts on <a href="https://oblivion-malware.xyz/posts/edr-archtecture/#hooked-flow-openprocess">hooking</a> and <a href="https://oblivion-malware.xyz/posts/direct-syscall/">direct syscall</a>.</p><p>This technique, for quite some time, has been (and still is) capable of executing APIs in a stealthy manner against some EDRs that rely on userland hooking, often allowing them to be bypassed.</p><p>Here, I’ll share my perspective on how this can be detected, present several alternatives, and highlight some of its weaknesses. We’ll discuss it from a static analysis point of view, as well as InstrumentationCallback, Guard Page + VEH, Call Stack, and ETW-TI.</p><h2 id="static"><span class="me-2">Static</span><a href="https://oblivion-malware.xyz/posts/detecting-syscalls/#static" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The simplest method would be to search for the syscall instruction within the analyzed code using YARA. Here’s an example rule:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="n">rule</span> <span class="n">SyscallHunter</span> <span class="p">{</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">meta</span><span class="o">:</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"Detecting syscall instruction in code"</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">author</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span><span class="o">=</span> <span class="s">"@ Oblivion"</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">date</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span><span class="o">=</span> <span class="s">"2025-04-02"</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">reference</span> <span class="err">&nbsp;</span> <span class="o">=</span> <span class="s">"https://oblivion-malware.xyz/posts/detecting-syscalls"</span>  

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">strings</span><span class="o">:</span> <span class="err">&nbsp;</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">$</span><span class="n">syscall_instruction</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="n">F</span> <span class="mo">05</span> <span class="p">}</span>

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">condition</span><span class="o">:</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">any</span> <span class="n">of</span> <span class="p">(</span> <span class="err">$</span><span class="n">syscall_instruction</span><span class="o">*</span> <span class="p">)</span> <span class="err">&nbsp;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div><p>Result when using it on a sample that implements HellsGate: </p><p>This could be bypassed by the attacker obfuscating the instruction, deobfuscating it at runtime, executing it, and then obfuscating it again. However, this approach is not commonly used. In most cases, the rule alone would already be sufficient for detection. Still, a defender could mitigate this technique, although it would require some effort. Another point is that this could lead to many false positives, since it’s not an uncommon byte sequence.</p><p>For static analysis, it’s more effective to use a disassembler and then perform a “grep” for the syscall instruction, as demonstrated below:</p><p></p><h2 id="instrumentationcallback"><span class="me-2">InstrumentationCallback</span><a href="https://oblivion-malware.xyz/posts/detecting-syscalls/#instrumentationcallback" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We can configure the return address of the syscall to wherever we want and determine where it’s being invoked from. If it originates from a memory region belonging to a DLL like win32u, ntdll, or others, it’s typically considered non-malicious. Otherwise, it’s flagged as malicious. We can also analyze its parameters to better understand what’s happening, along with the full call stack. Below is an example of how to enable/configure this:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">LONG</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span><span class="n">Status</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">HANDLE</span> <span class="err">&nbsp;</span><span class="n">ProcessHandle</span> <span class="err">&nbsp;</span><span class="o">=</span> <span class="o">::</span><span class="n">GetCurrentProcess</span><span class="p">();</span>

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION</span> <span class="n">InstCallbackInfo</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
  
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">InstCallbackInfo</span><span class="p">.</span><span class="n">Callback</span> <span class="o">=</span> <span class="n">CallbackFunction</span><span class="p">;</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">InstCallbackInfo</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">InstCallbackInfo</span><span class="p">.</span><span class="n">Version</span> <span class="err">&nbsp;</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">Status</span> <span class="o">=</span> <span class="o">::</span><span class="n">NtSetInformationProcess</span><span class="p">(</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">ProcessHandle</span><span class="p">,</span> <span class="p">(</span><span class="n">PROCESS_INFORMATION_CLASS</span><span class="p">)</span><span class="n">ProcessInstrumentationCallback</span><span class="p">,</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="o">&amp;</span><span class="n">InstCallbackInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">InstCallbackInfo</span> <span class="p">)</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="p">);</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="k">if</span> <span class="p">(</span> <span class="n">Status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div><p>One option for the attacker is to use the same approach but pass NULL in InstCallbackInfo.Callback = CallbackFunction;. We have an example of this behavior with SentinelOne EDR—it sets an InstrumentationCallback in addition to hooking certain functions. I’ll demonstrate when and how this happens in its implementation. First, we have the following code snippet running in x64dbg on a machine with SentinelOne installed:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="k">auto</span> <span class="n">WINAPI</span> <span class="nf">WinMain</span><span class="p">(</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">_In_</span> <span class="n">HINSTANCE</span> <span class="n">Instance</span><span class="p">,</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">_In_</span> <span class="n">HINSTANCE</span> <span class="n">PrevInstance</span><span class="p">,</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">_In_</span> <span class="n">PCHAR</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">CommandLine</span><span class="p">,</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">_In_</span> <span class="n">INT</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">ShowCmd</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">INT</span> <span class="p">{</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">NTSTATUS</span> <span class="n">NTAPI</span> <span class="p">(</span> <span class="o">*</span><span class="n">NtSetInformationProcess</span> <span class="p">)(</span> <span class="n">_In_</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span> <span class="n">_In_</span> <span class="n">PROCESS_INFORMATION_CLASS</span> <span class="n">ProcessInformationClass</span><span class="p">,</span> <span class="n">_In_</span> <span class="n">PVOID</span> <span class="n">ProcessInformation</span><span class="p">,</span> <span class="n">_In_</span> <span class="n">ULONG</span> <span class="n">ProcessInformationLength</span> <span class="p">);</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">NtSetInformationProcess</span> <span class="o">=</span> <span class="p">(</span> <span class="k">decltype</span><span class="p">(</span> <span class="n">NtSetInformationProcess</span> <span class="p">)</span> <span class="p">)</span><span class="o">::</span><span class="n">GetProcAddress</span><span class="p">(</span> <span class="o">::</span><span class="n">GetModuleHandleA</span><span class="p">(</span> <span class="s">"ntdll.dll"</span> <span class="p">),</span> <span class="s">"NtSetInformationProcess"</span> <span class="p">);</span>

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">LONG</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span><span class="n">Status</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">HANDLE</span> <span class="err">&nbsp;</span><span class="n">ProcessHandle</span> <span class="err">&nbsp;</span><span class="o">=</span> <span class="o">::</span><span class="n">GetCurrentProcess</span><span class="p">();</span>

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION</span> <span class="n">InstCallbackInfo</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">InstCallbackInfo</span><span class="p">.</span><span class="n">Callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">InstCallbackInfo</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">InstCallbackInfo</span><span class="p">.</span><span class="n">Version</span> <span class="err">&nbsp;</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="o">::</span><span class="n">VirtualAlloc</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">);</span>

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">Status</span> <span class="o">=</span> <span class="o">::</span><span class="n">NtSetInformationProcess</span><span class="p">(</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">ProcessHandle</span><span class="p">,</span> <span class="p">(</span><span class="n">PROCESS_INFORMATION_CLASS</span><span class="p">)</span><span class="n">ProcessInstrumentationCallback</span><span class="p">,</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="o">&amp;</span><span class="n">InstCallbackInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">InstCallbackInfo</span> <span class="p">)</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="p">);</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="k">if</span> <span class="p">(</span> <span class="n">Status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="o">::</span><span class="n">VirtualAlloc</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div><p>I overwrite the callback, effectively removing the one previously added by SentinelOne. Before doing that, I use <code class="language-plaintext highlighter-rouge">kernel32!VirtualAlloc</code> just to demonstrate its execution with the callback still active. Then, I call <code class="language-plaintext highlighter-rouge">kernel32!VirtualAlloc</code> again after removing the callback to show that it’s no longer in effect. Below is a demonstration video:</p><div width="800" height="400" src="https://www.youtube.com/embed/gZ8eiB2VCH8" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="" data-original-tag="iframe"><link rel="stylesheet" href="https://www.youtube.com/s/player/1798f86c/www-player.css" name="www-player" nonce=""><link rel="preload" href="https://www.youtube.com/s/player/1798f86c/player_es6.vflset/en_US/embed.js" name="player/embed" as="script" nonce=""><link rel="preconnect" href="https://i.ytimg.com/"><title>YouTube</title><link rel="canonical" href="https://www.youtube.com/watch?v=gZ8eiB2VCH8"><div id="player"></div></div><p>As we can see, we’re able to remove it without any issues—even though the <code class="language-plaintext highlighter-rouge">ntdll!NtSetInformationProcess</code> API is hooked. For some reason, SentinelOne allows its callback to be removed right under its nose.</p><h2 id="call-stack"><span class="me-2">Call Stack</span><a href="https://oblivion-malware.xyz/posts/detecting-syscalls/#call-stack" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>An approach I find quite effective is call stack analysis—Elastic EDR has been focusing on this method for quite some time. You can find a great write-up <a href="https://www.elastic.co/security-labs/peeling-back-the-curtain-with-call-stacks">here</a>. It’s very efficient for detecting shellcode execution in memory, especially when paying close attention to unbacked private memory regions with execution permissions being used by certain APIs.</p><p>For detecting direct syscalls, our main focus should be on the return address—specifically checking whether the caller into the kernel originates from a legitimate DLL such as <code class="language-plaintext highlighter-rouge">ntdll</code>, <code class="language-plaintext highlighter-rouge">win32u</code>, or others that contain syscall stubs, rather than from an executable. See the example below:</p><p></p><p>Above, we can see an execution of <code class="language-plaintext highlighter-rouge">ntdll!NtAllocateVirtualMemory</code> coming directly from the “HellsGate” executable, rather than through a Microsoft DLL as would normally be expected. This is already a strong indicator of direct syscall execution.</p><p>Now let’s take a look at an indirect syscall, paying closer attention to API “spoofing.” What happens in some approaches is that the attacker sets the SSN (System Service Number) of the desired function and then performs a <code class="language-plaintext highlighter-rouge">jmp</code> into the memory space of another API, jumping directly to the <em>syscall</em> instruction. When this is done, we get a call stack like the following:</p><ul><li><code class="language-plaintext highlighter-rouge">ntdll!NtAllocateVirtualMemory</code></li></ul><p></p><ul><li><code class="language-plaintext highlighter-rouge">ntdll!NtCreateThreadEx</code></li></ul><p></p><p>As we can observe, it’s quite easy to identify that API spoofing is happening—because in the case of <code class="language-plaintext highlighter-rouge">ntdll!NtCreateWaitCompletionPacket</code>, we actually see <code class="language-plaintext highlighter-rouge">ntdll!NtAllocateVirtualMemory</code> being executed in the kernel. This mismatch is a clear indicator of spoofing.</p><p>Elastic have the the great rule for direct syscalls, you can see rule <a href="https://www.elastic.co/docs/reference/security/prebuilt-rules/rules/windows/defense_evasion_suspicious_process_access_direct_syscall#rule-query">here</a></p><h2 id="page-guard--veh"><span class="me-2">Page Guard + VEH</span><a href="https://oblivion-malware.xyz/posts/detecting-syscalls/#page-guard--veh" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We implemented a hooking technique that differs from the conventional method, which usually involves overwriting the API with an unconditional jump (<code class="language-plaintext highlighter-rouge">jmp</code>). In our case, we add a vectored exception handler (VEH) and force an exception at the point where we want the hook to be triggered.</p><p>When the function is invoked and the exception is raised, we inspect the origin of the exception:</p><ul><li>If it originated from the base address of the function, we can treat it as a legitimate syscall.</li><li>If the exception is triggered at the <code class="language-plaintext highlighter-rouge">syscall</code> instruction, we know there was a jump directly to that instruction, bypassing the routine responsible for setting up the syscall number (SSN).</li></ul><p>To start, we change the memory protection of the functions we want to hook to <code class="language-plaintext highlighter-rouge">PAGE_EXECUTE_READ | PAGE_GUARD</code>.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">auto</span> <span class="n">Instance</span><span class="o">::</span><span class="n">SetGuardPageProt</span><span class="p">(</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">_In_</span> <span class="n">PVOID</span> <span class="n">Address</span><span class="p">,</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">_In_</span> <span class="n">ULONG</span> <span class="n">Size</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BOOL</span> <span class="p">{</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">ULONG</span> <span class="n">OldProt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="k">return</span> <span class="o">::</span><span class="n">VirtualProtect</span><span class="p">(</span> <span class="n">Address</span><span class="p">,</span> <span class="n">Size</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span> <span class="o">|</span> <span class="n">PAGE_GUARD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">OldProt</span> <span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div><p>We’ll create a structure and instantiate it globally.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">PVOID</span> <span class="n">FuncPtr</span><span class="p">;</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">PCHAR</span> <span class="n">FuncName</span><span class="p">;</span>
<span class="p">}</span> <span class="n">HOOK</span><span class="p">,</span> <span class="o">*</span><span class="n">PHOOK</span><span class="p">;</span>

<span class="n">HOOK</span> <span class="n">HookMgmt</span><span class="p">[</span><span class="n">FN_C</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div><p>Next, we’ll set the value of <code class="language-plaintext highlighter-rouge">FuncName</code> and loop through to retrieve the function’s address, changing its memory protection accordingly.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">HookMgmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">FuncName</span> <span class="o">=</span> <span class="p">{</span><span class="n">FUNC_OF_YOUR_CHOICE</span><span class="p">};</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">HookMgmt</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">FuncName</span> <span class="o">=</span> <span class="p">{</span><span class="n">FUNC_OF_YOUR_CHOICE</span><span class="p">};</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">HookMgmt</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">FuncName</span> <span class="o">=</span> <span class="p">{</span><span class="n">FUNC_OF_YOUR_CHOICE</span><span class="p">};</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">HookMgmt</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">FuncName</span> <span class="o">=</span> <span class="p">{</span><span class="n">FUNC_OF_YOUR_CHOICE</span><span class="p">};</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">HookMgmt</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">FuncName</span> <span class="o">=</span> <span class="p">{</span><span class="n">FUNC_OF_YOUR_CHOICE</span><span class="p">};</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> 
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="k">for</span> <span class="p">(</span> <span class="n">INT</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">HookMgmt</span> <span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">HookMgmt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">FuncPtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="o">::</span><span class="n">GetProcAddress</span><span class="p">(</span> <span class="p">(</span><span class="n">HMODULE</span><span class="p">)</span><span class="n">NtdllPtr</span><span class="p">,</span> <span class="n">HookMgmt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">FuncName</span> <span class="p">);</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="p">}</span>

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="k">for</span> <span class="p">(</span> <span class="n">INT</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">HookMgmt</span> <span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="n">Instance</span><span class="o">::</span><span class="n">SetGuardPageProt</span><span class="p">(</span> <span class="n">HookMgmt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">FuncPtr</span><span class="p">,</span> <span class="n">SYS_STUB_LENGTH</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">mPrint</span><span class="p">(</span> <span class="s">"error changing hook functions memory protection to page guard"</span> <span class="p">);</span> <span class="err">&nbsp;</span><span class="k">return</span> <span class="o">::</span><span class="n">GetLastError</span><span class="p">();</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="p">}</span>

<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="n">mPrint</span><span class="p">(</span> <span class="s">"# %d set page guard protection to %s at %p"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">HookMgmt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">FuncName</span><span class="p">,</span> <span class="n">HookMgmt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">FuncPtr</span> <span class="p">);</span>
<span class="err">&nbsp;</span> <span class="err">&nbsp;</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div><p>In our exception handling function, it will look something like this:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">auto</span> <span class="nf">DetourFunction</span><span class="p">(</span>
    <span class="n">_In_</span> <span class="n">PEXCEPTION_POINTERS</span> <span class="n">e</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LONG</span> <span class="p">{</span>
    <span class="n">mPrint</span><span class="p">(</span> <span class="s">"inside of exception handler"</span> <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ExceptionRecord</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span> <span class="o">==</span> <span class="n">EXCEPTION_GUARD_PAGE</span> <span class="p">)</span> <span class="p">{</span>    
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="n">memcmp</span><span class="p">(</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ExceptionRecord</span><span class="o">-&gt;</span><span class="n">ExceptionAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SyscallOpcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">SyscallOpcode</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">mPrint</span><span class="p">(</span> <span class="s">"potential indirect syscall jumping to instruction at %p"</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ExceptionRecord</span><span class="o">-&gt;</span><span class="n">ExceptionAddress</span> <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">mPrint</span><span class="p">(</span> <span class="s">"legitimate access at %p"</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ExceptionRecord</span><span class="o">-&gt;</span><span class="n">ExceptionAddress</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">EXCEPTION_CONTINUE_EXECUTION</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div><p>As I mentioned above, check if expcetion address == syscall instruction, thus knowing if a direct jmp was executed for that.</p><p>Note: This implementation is very simple and needs some adjustments to work properly, the code above is more for a demonstration of how it would be.</p><h2 id="etw-ti--kernel-callbacks"><span class="me-2">ETW-TI + Kernel Callbacks</span><a href="https://oblivion-malware.xyz/posts/detecting-syscalls/#etw-ti--kernel-callbacks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Summarize: it’s a mechanism that logs events from within the kernel, which makes it significantly harder to bypass—unlike standard ETW, which operates in userland and runs within ntdll.dll.</p><p>ETW-TI provides various keywords that we can use as a secure form of telemetry. Unlike userland solutions like hooking, this method offers more reliable and tamper-resistant visibility. Here’s a list of the two keyword sets: <a href="https://github.com/jdu2600/Windows10EtwEvents/blob/main/manifest/Microsoft-Windows-Threat-Intelligence.tsv">https://github.com/jdu2600/Windows10EtwEvents/blob/main/manifest/Microsoft-Windows-Threat-Intelligence.tsv</a>.</p><p>With these, we’re able to monitor actions such as memory allocation (local/remote), memory protection changes (local/remote), virtual memory writing (local/remote), and other behaviors listed in the linked manifest.</p><p>We also gain access to other valuable kernel-level events, such as:</p><ul><li>Process creation via <code class="language-plaintext highlighter-rouge">PsSetCreateProcessNotifyRoutine</code></li><li>Thread creation via <code class="language-plaintext highlighter-rouge">PsSetCreateThreadNotifyRoutine</code></li><li>Image loading via <code class="language-plaintext highlighter-rouge">PsSetLoadNotifyRoutine</code></li><li>Monitoring of handle operations like <code class="language-plaintext highlighter-rouge">DuplicateHandle</code>, <code class="language-plaintext highlighter-rouge">OpenProcess</code>, and <code class="language-plaintext highlighter-rouge">OpenThread</code> via <code class="language-plaintext highlighter-rouge">ObRegisterCallbacks</code>.</li></ul><p>So even if we can bypass userland from some hook we would still be able to know what is being done based on ETW-TI and Kernel Callbacks.</p><h2 id="epilogue"><span class="me-2">Epilogue</span><a href="https://oblivion-malware.xyz/posts/detecting-syscalls/#epilogue" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Here, we’ve covered several approaches from a detection standpoint, and I hope it’s clear how powerful the combination of these techniques can be.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="https://oblivion-malware.xyz/categories/detection-engineering/">Detection Engineering</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 "><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Detoning%20Direct/Indirect%20Syscalls%20by%20several%20approachs%20-%20Oblivion&amp;url=%2Fposts%2Fdetecting-syscalls%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Twitter" data-bs-original-title="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Detoning%20Direct/Indirect%20Syscalls%20by%20several%20approachs%20-%20Oblivion&amp;u=%2Fposts%2Fdetecting-syscalls%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Facebook" data-bs-original-title="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fdetecting-syscalls%2F&amp;text=Detoning%20Direct/Indirect%20Syscalls%20by%20several%20approachs%20-%20Oblivion" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Telegram" data-bs-original-title="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" data-title-succeed="Link copied successfully!" data-bs-original-title="Copy link"> <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="https://oblivion-malware.xyz/tags/windows/">Windows</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>
</body></html>