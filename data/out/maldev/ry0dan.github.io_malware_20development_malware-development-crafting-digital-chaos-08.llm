Title:
Malware Development – Crafting Digital Chaos (08): Thread Hijacking (Local & Remote)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains Windows thread hijacking: taking over an existing thread’s execution flow by suspending it, modifying its CPU context, and resuming it to run attacker-controlled code.  
- It demonstrates a local variant (creating a suspended thread in the same process) and remote variants targeting `notepad.exe` (either by spawning it suspended or by enumerating an already-running instance).  
- Core technique is editing the thread’s `CONTEXT` structure—specifically setting `RIP` to point to injected shellcode.  
- The remote injection path uses `VirtualAllocEx` + `WriteProcessMemory`, then `GetThreadContext`/`SetThreadContext` and `ResumeThread` to execute the payload.  
- It also covers process/thread discovery via Toolhelp snapshots (`CreateToolhelp32Snapshot`, `Process32First/Next`, `Thread32First/Next`) and opening handles with `OpenProcess`/`OpenThread`.  
- Useful for red teamers, pentesters, and malware developers studying classic process injection and execution techniques, and for defenders understanding telemetry points around thread context manipulation.

Technical Focus:
- Thread context manipulation (`CONTEXT`, `CONTEXT_CONTROL`, `RIP`)
- Thread control APIs (`CreateThread` with `CREATE_SUSPENDED`, `SuspendThread`/`ResumeThread`)
- Remote memory allocation and writing (`VirtualAllocEx`, `WriteProcessMemory`, `PAGE_EXECUTE_READWRITE`)
- Process and thread enumeration (Toolhelp32 snapshots)
- Handle acquisition and access rights (`OpenProcess`, `OpenThread`, `PROCESS_ALL_ACCESS`, `THREAD_ALL_ACCESS`)

Use Cases:
- Execute shellcode inside a target process without creating a remote thread (by reusing an existing thread)
- Build PoCs for process injection tradecraft and EDR telemetry validation
- Demonstrate differences between creating a suspended target process vs. hijacking a thread in an existing process
- Develop detections around `GetThreadContext`/`SetThreadContext` + suspicious memory protections and cross-process writes

Keywords:
thread hijacking, CONTEXT, GetThreadContext, SetThreadContext, RIP, CONTEXT_CONTROL, CreateThread, CREATE_SUSPENDED, ResumeThread, CreateProcessA, VirtualAlloc, VirtualAllocEx, WriteProcessMemory, OpenProcess, OpenThread, CreateToolhelp32Snapshot, Process32First, Thread32First, TH32CS_SNAPPROCESS, TH32CS_SNAPTHREAD, shellcode injection, notepad.exe, PAGE_EXECUTE_READWRITE