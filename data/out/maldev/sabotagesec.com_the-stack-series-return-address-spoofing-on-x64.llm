Title:
The Stack Series: Return Address Spoofing on x64

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains x64 return address spoofing as a way to mislead stack-based inspection performed by anti-cheat and EDR/security products.  
- It focuses on altering the return address used by a target Win32 API call so stack checks attribute the call to a “legitimate” module (e.g., a DLL) rather than injected/unknown code.  
- The author demonstrates the technique by IAT-hooking `MessageBoxA`, then invoking an assembly stub that replaces the return address with a gadget (`JMP QWORD PTR [RBX]`) found inside a chosen module.  
- A small parameter structure is used to pass the gadget address, target function pointer, and saved register state; a “fixup” trampoline restores stack/register state and jumps back to the original return address.  
- The article includes an x64 stack primer (shadow space/home space, calling convention, 16-byte alignment) to justify the exact stack offsets used.  
- Useful for red teamers, malware developers, and cheat developers studying call-stack evasion primitives; also relevant to blue teamers building detections around stack-walking anomalies.

Technical Focus:
- x64 Windows calling convention (RCX/RDX/R8/R9, shadow space, stack alignment)
- Return address spoofing / call stack deception
- IAT hooking (PE import parsing, thunk patching, `VirtualProtect`)
- ROP/gadget discovery in loaded modules (`FF 23` pattern)
- Assembly trampoline/fixup logic (register preservation, stack repair)
- Stack walking and module attribution concepts (anti-cheat/EDR perspective)

Use Cases:
- Hide suspicious API call origins during user-mode stack inspection
- Bypass simplistic anti-cheat checks that validate return addresses against game modules
- Build loaders/beacons that reduce obvious “unknown module” frames in call stacks
- Research/detect spoofing by validating unwind info vs. observed return addresses

Keywords:
x64, return address spoofing, stack walk, call stack, Windows calling convention, shadow space, home space, RSP alignment, IAT hooking, PE imports, IMAGE_IMPORT_DESCRIPTOR, thunk patching, VirtualProtect, MessageBoxA, Win32 API, gadget, ROP, JMP QWORD PTR [RBX], wininet.dll, trampoline, fixup, anti-cheat, EDR evasion, unwind information