Title:
An Introduction into Sleep Obfuscation (Ekko) + Bypassing Hunt Sleeping Beacons

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains Windows x64 “sleep obfuscation” using the Ekko technique, which hides an in-memory payload while it is idle by encrypting it and changing page protections.  
- It breaks down Ekko’s implementation details: timer queues execute callbacks on a separate thread, and `NtContinue` is used with crafted `CONTEXT` structures to perform ROP-style API invocation without a normal call chain from the payload.  
- The author then evaluates and targets the open-source detector Hunt Sleeping Beacons (HSB), which flags suspicious waiting threads based on wait reason/state and call stack patterns (e.g., timer/APC dispatchers, private RX memory, stomped modules).  
- To bypass HSB, the post replaces `WaitForSingleObject`-based delay with `Sleep` (changing the wait state) and adds ROP steps to backup/spoof/restore the main thread context (`GetThreadContext`/`SetThreadContext`) so the main thread’s stack appears benign during the sleep window.  
- It includes practical code snippets integrating the modified Ekko flow into a shellcode template/loader, highlighting race/timing caveats where detection can still occur between wait setup and callback execution.  
- Useful for red teamers and malware developers building stealthy implants, and for defenders understanding how timer-queue + `NtContinue` call-stack manipulation defeats naive “sleeping beacon” heuristics.

Technical Focus:
- Sleep obfuscation (encrypt-on-sleep, permission flipping)
- Timer queues and callback-thread execution (`CreateTimerQueueTimer`, `WT_EXECUTEINTIMERTHREAD`)
- `NtContinue` + `CONTEXT`-driven ROP/call-stack manipulation
- Memory region types and protections (Private vs Image, RW/RX/RWX)
- HSB detection logic (wait states, call stack to dispatcher, private RX/module stomping)
- Thread context spoofing (`GetThreadContext`/`SetThreadContext`, `DuplicateHandle`)

Use Cases:
- Implementing in-memory payload sleep encryption and RX/RW permission cycling
- Evading “sleeping beacon” scanners that rely on wait-state + call-stack heuristics
- Building shellcode/implant templates that reduce static in-memory signatures during idle
- Testing and hardening defensive detections against timer-queue/NtContinue-based obfuscation

Keywords:
Sleep obfuscation, Ekko, Hunt Sleeping Beacons, HSB, Windows x64, CreateTimerQueueTimer, timer queue, WT_EXECUTEINTIMERTHREAD, NtContinue, CONTEXT, RtlCaptureContext, ROP, call stack spoofing, WaitForSingleObject, Sleep, Wait:UserRequest, Wait:DelayExecution, VirtualProtect, SystemFunction032, cryptsp.dll, GetThreadContext, SetThreadContext, DuplicateHandle, private RX memory, module stomping, unbacked memory, NtDelayExecution