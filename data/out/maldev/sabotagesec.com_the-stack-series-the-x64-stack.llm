Title:
The Stack Series: The X64 Stack

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains Windows x64 stack fundamentals with emphasis on the Microsoft x64 calling convention and how stack frames are constructed and interpreted.  
- It covers why RSP is treated as “static” within a function body (changes are constrained to prologue/epilogue) and how volatile vs non-volatile registers affect what must be saved on the stack.  
- The author breaks down leaf vs non-leaf functions and why non-leaf functions require unwind metadata to support exception handling and reliable stack unwinding.  
- It details the role of the PE `.pdata` section and the `RUNTIME_FUNCTION`, `UNWIND_INFO`, and `UNWIND_CODE` structures used by Windows to unwind stacks on x64 (instead of x86-style EBP chaining/SEH frames).  
- Using WinDbg (`knf`, `.fnent`) examples, it shows how debuggers compute frame sizes from unwind codes (e.g., `UWOP_ALLOC_SMALL/LARGE`, `UWOP_PUSH_NONVOL`) to perform call stack walking.  
- Useful for red teamers, exploit devs, malware developers, and defenders who need to reason about stack traces, unwind correctness, and prerequisites for techniques like call stack spoofing.

Technical Focus:
- Microsoft x64 calling convention (RCX/RDX/R8/R9, shadow/homing space)
- Stack frame layout and RSP “static” rule (prologue/epilogue discipline)
- Volatile vs non-volatile register preservation
- Leaf vs non-leaf functions and unwind requirements
- Windows x64 exception handling and stack unwinding via `.pdata`
- WinDbg stack walking (`knf`, `.fnent`) and frame-size derivation from unwind codes

Use Cases:
- Reverse engineering function prologues/epilogues and stack frame layouts in x64 binaries
- Debugging crashes by understanding unwind metadata and accurate call stacks
- Building or analyzing call stack spoofing / stack manipulation techniques
- Validating compiler-generated unwind info for custom loaders/shellcode that must unwind safely
- Defensive analysis of suspicious stack traces and unwind anomalies

Keywords:
Windows x64, RSP, stack frame, calling convention, fastcall, RCX, RDX, R8, R9, shadow space, homing space, volatile registers, non-volatile registers, leaf function, non-leaf function, stack unwinding, exception handling, SEH, Vectored Exception Handling, .pdata, RUNTIME_FUNCTION, UNWIND_INFO, UNWIND_CODE, UWOP_ALLOC_SMALL, UWOP_ALLOC_LARGE, UWOP_PUSH_NONVOL, WinDbg, knf, .fnent, CreateRemoteThreadEx