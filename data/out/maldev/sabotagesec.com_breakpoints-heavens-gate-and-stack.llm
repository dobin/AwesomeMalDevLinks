Title:
Breakpoints, Heavens Gate and Stack

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how to execute Windows NT syscalls from a 32-bit (WoW64) process by directly invoking the WoW64 “Heaven’s Gate” transition into 64-bit mode, rather than relying on the normal ntdll stub flow.  
- It builds on a prior technique using hardware breakpoints and an exception handler to spoof return addresses and manipulate ESP, aiming for more covert syscall execution.  
- The author analyzes the WoW64 ntdll syscall stub flow (call edx → jumps → WoW64Transition → far jump with selector 0x33) and highlights that correct stack/register state at the gate is critical to avoid crashes.  
- A key technique is dynamically locating the Heaven’s Gate/KiFastSystemCall-style entry via the TIB (FS-based access) and then rewriting the thread context (EIP/EAX/ESP) inside an EXCEPTION_SINGLE_STEP handler.  
- The provided code demonstrates copying stack arguments to a new stack frame, pushing extra return addresses to emulate the original “call edx” side effects, setting EAX to the syscall number, and transferring execution to the gate.  
- Useful for red teamers, offensive tool developers, and malware researchers interested in WoW64 internals, direct syscall invocation, and call-stack/return-address spoofing to complicate user-mode monitoring.

Technical Focus:
- WoW64 syscall path and ntdll stub analysis
- Heaven’s Gate (far jump, segment selectors 0x33/0x23) transitions
- Hardware breakpoints (DR0) and EXCEPTION_SINGLE_STEP handling
- CPU context manipulation (EIP/EAX/ESP) and stack reconstruction
- TIB/TEB access via FS segment to resolve gate address dynamically
- Return address spoofing / stack spoofing for stealthier execution

Use Cases:
- Implementing WoW64 direct syscalls from 32-bit implants on 64-bit Windows
- Bypassing or reducing reliance on user-mode API hooks in ntdll stubs
- Building stealthy syscall dispatchers using VEH/SEH + debug registers
- Researching and reproducing WoW64 transition mechanics for tooling or detection testing

Keywords:
WoW64, Heaven’s Gate, WoW64Transition, ntdll, NtAllocateVirtualMemory, direct syscall, syscall stub, KiFastSystemCall, segment selector 0x33, FS segment, TIB, TEB, EXCEPTION_SINGLE_STEP, hardware breakpoints, DR0, CONTEXT, EIP, EAX, ESP, return address spoofing, stack manipulation