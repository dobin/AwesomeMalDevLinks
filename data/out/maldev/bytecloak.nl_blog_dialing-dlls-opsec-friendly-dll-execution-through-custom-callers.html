# https://bytecloak.nl/blog/dialing-dlls-opsec-friendly-dll-execution-through-custom-callers/

<!DOCTYPE html><html lang="en"><body class="__variable_f367f3 __variable_f04781 __variable_87318b bg-gray-950 font-inter text-base text-gray-200 antialiased" data-aos-easing="ease-out-sine" data-aos-duration="600" data-aos-delay="0"><div class="flex min-h-screen flex-col overflow-hidden supports-[overflow:clip]:overflow-clip"><main class="relative flex grow flex-col"><div class="pointer-events-none absolute left-1/2 top-0 -z-10 -translate-x-1/4" aria-hidden="true"><img class="max-w-none" src="https://bytecloak.nl/images/page-illustration.svg" width="846" height="594" alt="Page illustration"></div><div class="pointer-events-none absolute left-1/2 top-[400px] -z-10 -mt-20 -translate-x-full opacity-50" aria-hidden="true"><img class="max-w-none" src="https://bytecloak.nl/images/blurred-shape-gray.svg" width="760" height="668" alt="Blurred shape"></div><div class="pointer-events-none absolute left-1/2 top-[440px] -z-10 -translate-x-1/3" aria-hidden="true"><img class="max-w-none" src="https://bytecloak.nl/images/blurred-shape.svg" width="760" height="668" alt="Blurred shape"></div><section><div class="px-4 sm:px-6"><div class="py-12 md:py-20"><div class="mx-auto max-w-3xl"><article><figure class="relative my-8 overflow-hidden rounded-2xl border border-gray-800/80 before:absolute before:inset-0 before:-z-10 before:bg-linear-to-br before:from-gray-900 before:via-green-500/50 before:to-green-500 before:opacity-50 lg:-ml-32 lg:-mr-32"><img class="aspect-video w-full object-cover opacity-70 grayscale" src="https://bytecloak.nl/images/post-image-03.png" width="1024" height="576" alt="Dialing DLLs: OPSEC-friendly DLL execution through custom callers"></figure><div class="prose max-w-none text-green-200/65 prose-headings:scroll-mt-24 prose-headings:font-nacelle prose-headings:font-semibold prose-headings:text-gray-200 prose-h2:mb-4 prose-h2:text-2xl prose-a:font-medium prose-a:text-green-500 prose-a:no-underline hover:prose-a:underline prose-blockquote:border-l prose-blockquote:border-green-500 prose-blockquote:pl-4 prose-blockquote:font-normal prose-blockquote:italic prose-blockquote:text-green-200/65 prose-figcaption:mt-3 prose-figcaption:text-center prose-figcaption:text-sm prose-figcaption:text-gray-600 prose-strong:font-medium prose-strong:text-gray-200 prose-code:rounded prose-code:bg-gray-100 prose-code:px-1 prose-code:py-0.5 prose-code:font-mono prose-code:text-gray-900 prose-code:before:content-[''] prose-code:after:content-[''] prose-pre:border prose-pre:border-gray-700 prose-pre:bg-gray-900 prose-img:rounded-2xl md:prose-h2:text-3xl [&amp;_blockquote_p:first-of-type]:before:content-none [&amp;_blockquote_p:last-of-type]:after:content-none"><p>Dynamic Link Library (DLL) files are a great format for payload loaders, as they are generally less scrutinized than executable (EXE) files. The downside is that they cannot be executed on their own. The traditional way of executing a shellcode loader contained in a DLL was to use the living-off-the-land binary (LOLBIN) <code style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px">rundll32.exe</code>. This method is not stealthy. Modern endpoint detection and response (EDR) solutions often scrutinize libraries loaded by <code style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px">rundll32.exe</code> at the same level as executables, defeating the purpose of using a library in the first place. Alerts may also be generated simply due to the use of <code style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px">rundll32.exe</code>.</p>
<p>One way to execute DLLs in a relatively stealthy manner is through DLL hijacking. Much has been written about this technique, for example <a href="https://pentestlab.blog/2017/03/27/dll-hijacking/">here</a>, <a href="https://liberty-shell.com/sec/2019/03/12/dll-hijacking/">here</a>, and <a href="https://itm4n.github.io/windows-dll-hijacking-clarified/">here</a>. While hijacking provides the advantage of running a payload inside the process of a trusted executable, it still relies on an exploitation technique that can be detected and may negatively impact OPSEC. Furthermore, finding executables that are vulnerable to DLL hijacking can be time-consuming, and you may not want to expose your preferred hijacks in every situation.</p>
<p>Fortunately, there is an easy and benign way to trigger loaders in DLL files: simply call them. Libraries can be packaged with any executable file format that supports calling external functions from a DLL. These files are quick and easy to create, as they contain very little functionality. Moreover, this behavior is entirely benign, as calling functions from a DLL is its intended purpose.</p>
<p>While this concept is not groundbreaking, this post serves as a reminder for those who may occasionally overcomplicate their operations.</p>
<h2 id="generating-the-library"><a href="https://bytecloak.nl/blog/dialing-dlls-opsec-friendly-dll-execution-through-custom-callers/#generating-the-library" class="anchor-link"></a>Generating the library</h2>
<p>Before creating the custom caller, we first need to generate the loader DLL. Open the ByteCloak Portal and create a new artifact. Set the output format to Dynamic Link Library. These techniques work with payload execution from <code style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px">DllMain</code> as well as execution through payload trigger functions. For this example, we opt for the latter.</p>
<p>For simplicity, we add a single function export and configure it as our trigger function. In practice, it is preferable to define multiple exports to make the library appear more realistic. The screenshot below shows the configuration options used for the output format section.</p>
<figure><img src="https://bytecloak.nl/images/blog-003-image-01.png" alt="Output format configuration in the ByteCloak Portal" width="768" height="432" class="m-0 w-full" loading="lazy"><figcaption>Output format configuration in the ByteCloak Portal</figcaption></figure>
<h2 id="creating-a-custom-caller"><a href="https://bytecloak.nl/blog/dialing-dlls-opsec-friendly-dll-execution-through-custom-callers/#creating-a-custom-caller" class="anchor-link"></a>Creating a custom caller</h2>
<h3 id="native-caller"><a href="https://bytecloak.nl/blog/dialing-dlls-opsec-friendly-dll-execution-through-custom-callers/#native-caller" class="anchor-link"></a>Native caller</h3>
<p>A native caller can be implemented in any language that is compiled and linked into an executable. In this example, we use the C programming language. There are two ways to load and trigger the loader DLL from a native caller: run-time loading and compile-time linking.</p>
<p>A caller that implements run-time loading is functionally equivalent to <code style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px">rundll32.exe</code>, but it evades basic detections that rely on monitoring the use of the <code style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px">rundll32.exe</code> binary. An example implementation is shown below:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="c" data-theme="dracula"><code data-language="c" data-theme="dracula" style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px"><span data-line=""><span style="color:#6272A4">// caller.c</span></span>
<span data-line=""><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &lt;</span><span style="color:#F1FA8C">windows.h</span><span style="color:#E9F284">&gt;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#FF79C6">typedef</span><span style="color:#FF79C6"> void</span><span style="color:#F8F8F2"> (__stdcall </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2">PFN_MyTrigger)(</span><span style="color:#FF79C6">void</span><span style="color:#F8F8F2">);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> main</span><span style="color:#F8F8F2">() {</span></span>
<span data-line=""><span style="color:#F8F8F2">    HMODULE         hMyLibrary;</span></span>
<span data-line=""><span style="color:#F8F8F2">    PFN_MyTrigger   pMyTrigger;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">    hMyLibrary </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> LoadLibrary</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">MyLibrary.dll</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span data-line=""><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> (hMyLibrary </span><span style="color:#FF79C6">==</span><span style="color:#BD93F9"> NULL</span><span style="color:#F8F8F2">)</span></span>
<span data-line=""><span style="color:#FF79C6">        return</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">    pMyTrigger </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> (PFN_MyTrigger)</span><span style="color:#50FA7B">GetProcAddress</span><span style="color:#F8F8F2">(hMyLibrary, </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">MyTrigger</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span data-line=""><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> (pMyTrigger </span><span style="color:#FF79C6">==</span><span style="color:#BD93F9"> NULL</span><span style="color:#F8F8F2">)</span></span>
<span data-line=""><span style="color:#FF79C6">        return</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#50FA7B">    pMyTrigger</span><span style="color:#F8F8F2">();</span></span>
<span data-line=""><span style="color:#FF79C6">    return</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">;</span></span>
<span data-line=""><span style="color:#F8F8F2">}</span></span></code></pre></figure>
<p>This program performs the following steps:</p>
<ol>
<li>Uses <code style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px">LoadLibrary</code> to load the loader DLL into the process address space.</li>
<li>Uses <code style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px">GetProcAddress</code> to retrieve the address of the trigger function.</li>
<li>Calls the trigger function to initiate payload execution.</li>
</ol>
<p>To build the program, execute the following command in a Visual Studio command prompt:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="powershell" data-theme="dracula"><code data-language="powershell" data-theme="dracula" style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px"><span data-line=""><span style="color:#F8F8F2">cl caller.c</span></span></code></pre></figure>
<p>An example of a native caller that uses compile-time linking is shown below:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="c" data-theme="dracula"><code data-language="c" data-theme="dracula" style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px"><span data-line=""><span style="color:#6272A4">// caller.c</span></span>
<span data-line=""><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> main</span><span style="color:#F8F8F2">() {</span></span>
<span data-line=""><span style="color:#50FA7B">	MyTrigger</span><span style="color:#F8F8F2">();</span></span>
<span data-line=""><span style="color:#FF79C6">	return</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">;</span></span>
<span data-line=""><span style="color:#F8F8F2">}</span></span></code></pre></figure>
<p>This program directly calls the trigger function from the loader DLL. From a code perspective, this approach is much simpler. However, additional steps are required to build the program successfully. If we attempt to build it in the same way as before, the linker will fail because it does not understand how the loader DLL is structured.</p>
<p>To resolve this, we first create a module definition (.def) file that defines the exported functions:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="c" data-theme="dracula"><code data-language="c" data-theme="dracula" style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px"><span data-line=""><span style="color:#6272A4">// MyLibrary.def</span></span>
<span data-line=""><span style="color:#F8F8F2">LIBRARY   MyLibrary</span></span>
<span data-line=""><span style="color:#F8F8F2">EXPORTS</span></span>
<span data-line=""><span style="color:#F8F8F2">   MyTrigger   @</span><span style="color:#BD93F9">1</span></span></code></pre></figure>
<p>This definition file can be compiled into a library (.lib) file using the following command:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="powershell" data-theme="dracula"><code data-language="powershell" data-theme="dracula" style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px"><span data-line=""><span style="color:#F8F8F2">lib </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2">def:MyLibrary.def </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2">out:MyLibrary.lib </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2">machine:x64</span></span></code></pre></figure>
<p>We can now build the caller executable:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="powershell" data-theme="dracula"><code data-language="powershell" data-theme="dracula" style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px"><span data-line=""><span style="color:#F8F8F2">cl caller.c MyLibrary.lib</span></span></code></pre></figure>
<p>The resulting executable has the trigger function from the library added to its import address table. As a result, the Windows loader will automatically load the DLL into the process address space and resolve the function address during process initialization.</p>
<h3 id="net-caller"><a href="https://bytecloak.nl/blog/dialing-dlls-opsec-friendly-dll-execution-through-custom-callers/#net-caller" class="anchor-link"></a>.NET caller</h3>
<p>.NET assemblies are an excellent option for custom callers, especially when running .NET post-exploitation tools. When combined with a loader that injects the payload into the current process, the payload runs in a process where the .NET runtime has been loaded in the standard manner. This helps evade detections that attempt to identify post-exploitation tools based on .NET execution in native processes.</p>
<p>A minimal .NET caller may look like the following:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="c#" data-theme="dracula"><code data-language="c#" data-theme="dracula" style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px"><span data-line=""><span style="color:#6272A4">// Caller.cs</span></span>
<span data-line=""><span style="color:#FF79C6">using</span><span style="color:#8BE9FD;font-style:italic"> System</span><span style="color:#F8F8F2">;</span></span>
<span data-line=""><span style="color:#FF79C6">using</span><span style="color:#8BE9FD;font-style:italic"> System</span><span style="color:#F8F8F2">.</span><span style="color:#8BE9FD;font-style:italic">Runtime</span><span style="color:#F8F8F2">.</span><span style="color:#8BE9FD;font-style:italic">InteropServices</span><span style="color:#F8F8F2">;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#FF79C6">class</span><span style="color:#8BE9FD"> Caller</span></span>
<span data-line=""><span style="color:#F8F8F2">{</span></span>
<span data-line=""><span style="color:#F8F8F2">    [</span><span style="color:#8BE9FD;font-style:italic">DllImport</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">MyLibrary.dll</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, CallingConvention </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> CallingConvention.StdCall)]</span></span>
<span data-line=""><span style="color:#FF79C6">    internal</span><span style="color:#FF79C6"> static</span><span style="color:#FF79C6"> extern</span><span style="color:#FF79C6"> void</span><span style="color:#50FA7B"> MyTrigger</span><span style="color:#F8F8F2">();</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#FF79C6">    static</span><span style="color:#FF79C6"> void</span><span style="color:#50FA7B"> Main</span><span style="color:#F8F8F2">()</span></span>
<span data-line=""><span style="color:#F8F8F2">    {</span></span>
<span data-line=""><span style="color:#50FA7B">        MyTrigger</span><span style="color:#F8F8F2">();</span></span>
<span data-line=""><span style="color:#F8F8F2">    }</span></span>
<span data-line=""><span style="color:#F8F8F2">}</span></span></code></pre></figure>
<p>This program can be built using the following command:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="powershell" data-theme="dracula"><code data-language="powershell" data-theme="dracula" style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px"><span data-line=""><span style="color:#F8F8F2">csc Caller.cs</span></span></code></pre></figure>
<h3 id="scripting-engines"><a href="https://bytecloak.nl/blog/dialing-dlls-opsec-friendly-dll-execution-through-custom-callers/#scripting-engines" class="anchor-link"></a>Scripting engines</h3>
<p>Application whitelisting solutions may prevent the execution of unknown executables. Depending on the whitelist configuration, payload execution may still be possible through LOLBINs such as scripting engines. Developing evasive shellcode loaders in multiple scripting languages is time-consuming, but writing scripts that simply call a function from a DLL is not.</p>
<p>One important consideration when writing callers in a scripting language is the DLL search order. The first two callers were able to locate the DLL because the directory of the process executable is included in the search order. For scripts, however, the directory of the scripting engine is included, not the directory of the script itself. As a result, a DLL located in the same directory as the script is not automatically discovered by the Windows loader. This means that either the DLL must be placed in a directory that is part of the search order, or the script must specify the full path to the DLL.</p>
<p>Another caveat is that the DLL is loaded into the address space of the scripting engine, which means the bitness of the DLL must match that of the engine. In most cases, a 64-bit implementation is sufficient. However, for maximum compatibility, it is possible to include both 32-bit and 64-bit libraries and allow the script to select the appropriate one.</p>
<p>Below are examples of DLL callers implemented in three different scripting languages. For simplicity, these examples assume 64-bit scripting engines.</p>
<h4 id="powershell-caller"><a href="https://bytecloak.nl/blog/dialing-dlls-opsec-friendly-dll-execution-through-custom-callers/#powershell-caller" class="anchor-link"></a>PowerShell caller</h4>
<p>PowerShell is built on top of .NET and supports direct execution of .NET code. The example below leverages this capability to call the payload trigger function:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="powershell" data-theme="dracula"><code data-language="powershell" data-theme="dracula" style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px"><span data-line=""><span style="color:#6272A4"># caller.ps1</span></span>
<span data-line=""><span style="color:#F8F8F2">$dllPath </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> Join-Path</span><span style="color:#BD93F9"> $PSScriptRoot</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">MyLibrary.dll</span><span style="color:#E9F284">"</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#8BE9FD">Add-Type</span><span style="color:#E9F284"> @"</span></span>
<span data-line=""><span style="color:#F1FA8C">using System.Runtime.InteropServices;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F1FA8C">public static class Native</span></span>
<span data-line=""><span style="color:#F1FA8C">{</span></span>
<span data-line=""><span style="color:#F1FA8C">    [DllImport(@"</span><span style="color:#F8F8F2">$dllPath</span><span style="color:#F1FA8C">", CallingConvention = CallingConvention.StdCall)]</span></span>
<span data-line=""><span style="color:#F1FA8C">    public static extern void MyTrigger();</span></span>
<span data-line=""><span style="color:#F1FA8C">}</span></span>
<span data-line=""><span style="color:#E9F284">"@</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">[</span><span style="color:#FF79C6">Native</span><span style="color:#F8F8F2">]::MyTrigger()</span></span></code></pre></figure>
<h4 id="python-caller"><a href="https://bytecloak.nl/blog/dialing-dlls-opsec-friendly-dll-execution-through-custom-callers/#python-caller" class="anchor-link"></a>Python caller</h4>
<p>The default Python installation includes the <code style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px">ctypes</code> package, which provides support for calling functions from DLL files. The following example demonstrates how this can be used to trigger the payload:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="dracula"><code data-language="python" data-theme="dracula" style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px"><span data-line=""><span style="color:#6272A4"># caller.py</span></span>
<span data-line=""><span style="color:#FF79C6">import</span><span style="color:#F8F8F2"> os</span></span>
<span data-line=""><span style="color:#FF79C6">import</span><span style="color:#F8F8F2"> ctypes</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">script_dir </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> os.path.dirname(os.path.abspath(</span><span style="color:#BD93F9">__file__</span><span style="color:#F8F8F2">))</span></span>
<span data-line=""><span style="color:#F8F8F2">dll </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> ctypes.WinDLL(os.path.join(script_dir, </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">MyLibrary.dll</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">))</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">MyTrigger </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> dll.MyTrigger</span></span>
<span data-line=""><span style="color:#F8F8F2">MyTrigger.argtypes </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> []</span></span>
<span data-line=""><span style="color:#F8F8F2">MyTrigger.restype </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> None</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">MyTrigger()</span></span></code></pre></figure>
<h4 id="vba-caller"><a href="https://bytecloak.nl/blog/dialing-dlls-opsec-friendly-dll-execution-through-custom-callers/#vba-caller" class="anchor-link"></a>VBA caller</h4>
<p>Visual Basic for Applications (VBA) is the scripting language behind Office macros. While macros may not be the first mechanism you expect to work on systems with application whitelisting, VBA is also supported by various other applications, such as:</p>
<ul>
<li>SolidWorks (3D modeling)</li>
<li>CATIA (3D modeling)</li>
<li>ArcGIS (maps and geoprocessing)</li>
<li>CorelDraw (graphic design)</li>
<li>QuickBooks (accounting)</li>
</ul>
<p>VBA includes built-in functionality for calling functions from DLLs. However, because VBA code is compiled into a binary format, import statements cannot rely on run-time calculation of the library location. There are several ways to address this. The first option is to use a relative path and accept its usage limitations:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="vb" data-theme="dracula"><code data-language="vb" data-theme="dracula" style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px"><span data-line=""><span style="color:#FF79C6">Option Explicit</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">Declare PtrSafe</span><span style="color:#FF79C6"> Sub </span><span style="color:#F8F8F2">MyTrigger Lib </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">MyLibrary.dll</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2"> ()</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#FF79C6">Public Sub </span><span style="color:#50FA7B">CallMyTrigger</span><span style="color:#F8F8F2">()</span></span>
<span data-line=""><span style="color:#F8F8F2">    MyTrigger</span></span>
<span data-line=""><span style="color:#FF79C6">End Sub</span></span></code></pre></figure>
<p>This script can only be used after the loader DLL has been placed in a directory that is included in the DLL search order. Alternatively, a full path can be specified in the declaration:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="vb" data-theme="dracula"><code data-language="vb" data-theme="dracula" style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px"><span data-line=""><span style="color:#F8F8F2">Declare PtrSafe</span><span style="color:#FF79C6"> Sub </span><span style="color:#F8F8F2">MyTrigger Lib </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">C:\Full\Path\To\MyLibrary.dll</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2"> ()</span></span></code></pre></figure>
<p>This provides more flexibility in terms of library location, but still requires the file to be placed at a fixed path. If this is not an option, the DLL can be loaded at run time using <code style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px">LoadLibrary</code>:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="vb" data-theme="dracula"><code data-language="vb" data-theme="dracula" style="background:#282a36;color:#f8f8f2;padding:0.2em 0.0em;border-radius:4px"><span data-line=""><span style="color:#FF79C6">Option Explicit</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#FF79C6">    Private</span><span style="color:#F8F8F2"> Declare PtrSafe</span><span style="color:#FF79C6"> Function </span><span style="color:#F8F8F2">LoadLibraryA Lib </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">kernel32</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2"> _</span></span>
<span data-line=""><span style="color:#F8F8F2">        (ByVal lpLibFileName </span><span style="color:#FF79C6">As</span><span style="color:#8BE9FD;font-style:italic"> String</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">As</span><span style="color:#8BE9FD;font-style:italic"> LongPtr</span></span>
<span data-line=""><span style="color:#F8F8F2">    Declare PtrSafe</span><span style="color:#FF79C6"> Sub </span><span style="color:#F8F8F2">MyTrigger Lib </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">MyLibrary.dll</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2"> ()</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#FF79C6">Public Sub </span><span style="color:#50FA7B">CallMyTrigger</span><span style="color:#F8F8F2">()</span></span>
<span data-line=""><span style="color:#FF79C6">    Dim</span><span style="color:#F8F8F2"> dllPath </span><span style="color:#FF79C6">As</span><span style="color:#8BE9FD;font-style:italic"> String</span></span>
<span data-line=""><span style="color:#F8F8F2">    dllPath </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> ActiveDocument.Path </span><span style="color:#FF79C6">&amp;</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">\MyLibrary.dll</span><span style="color:#E9F284">"</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#FF79C6">    If</span><span style="color:#50FA7B"> LoadLibraryA</span><span style="color:#F8F8F2">(dllPath) </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 0</span><span style="color:#FF79C6"> Then</span></span>
<span data-line=""><span style="color:#FF79C6">        Exit Sub</span></span>
<span data-line=""><span style="color:#FF79C6">    End If</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">    MyTrigger</span></span>
<span data-line=""><span style="color:#FF79C6">End Sub</span></span></code></pre></figure>
<p>While this approach is the most convenient from an operator perspective, it may also attract additional scrutiny from EDR products. As always, the best solution depends on your specific requirements.</p>
<h2 id="additional-functionality"><a href="https://bytecloak.nl/blog/dialing-dlls-opsec-friendly-dll-execution-through-custom-callers/#additional-functionality" class="anchor-link"></a>Additional functionality</h2>
<p>Caller files also provide an opportunity to add functionality before, after, or during payload execution. This can be leveraged to include social engineering techniques, guardrails, or sandbox evasion logic if the built-in options in ByteCloak do not meet the unique requirements of an operation. Examples include:</p>
<ul>
<li>Rendering a complex graphical user interface window</li>
<li>Requesting user input and using that input to perform an action</li>
<li>Verifying that an intranet page is accessible from the current system before payload execution</li>
<li>Verifying that a trust relationship exists between the current userâ€™s domain and a target domain before payload execution</li>
</ul>
<h2 id="conclusion"><a href="https://bytecloak.nl/blog/dialing-dlls-opsec-friendly-dll-execution-through-custom-callers/#conclusion" class="anchor-link"></a>Conclusion</h2>
<p>Custom callers can be used to trigger shellcode loaders in DLL files in an OPSEC-safe manner. They are easy to develop, offer significant flexibility in terms of file formats, and allow additional functionality to be added to otherwise closed-source loaders.</p></div></article></div><div class="pointer-events-none absolute left-1/2 top-0 -z-10 -translate-x-1/4" aria-hidden="true"><img class="max-w-none" src="https://bytecloak.nl/images/page-illustration.svg" width="846" height="594" alt="Page illustration"></div><div class="pointer-events-none absolute left-1/2 top-[400px] -z-10 -mt-20 -translate-x-full opacity-50" aria-hidden="true"><img class="max-w-none" src="https://bytecloak.nl/images/blurred-shape-gray.svg" width="760" height="668" alt="Blurred shape"></div><div class="pointer-events-none absolute left-1/2 top-[440px] -z-10 -translate-x-1/3" aria-hidden="true"><img class="max-w-none" src="https://bytecloak.nl/images/blurred-shape.svg" width="760" height="668" alt="Blurred shape"></div><section><div class="mx-auto max-w-6xl px-4 sm:px-6"><div class="py-12 md:py-20"><div class="pb-12 text-center"></div><div><div class="mx-auto grid max-w-sm items-start gap-8 sm:max-w-none sm:grid-cols-2 lg:grid-cols-3"><article class="flex h-full flex-col transition-opacity "></article><article class="flex h-full flex-col transition-opacity "></article><article class="flex h-full flex-col transition-opacity "></article></div></div></div></div></section></div></div></section><section class="relative overflow-hidden"><div class="pointer-events-none absolute bottom-0 left-1/2 -z-10 -mb-24 ml-20 -translate-x-1/2" aria-hidden="true"><img alt="Blurred shape" loading="lazy" width="760" height="668" decoding="async" data-nimg="1" class="max-w-none" style="color:transparent" src="https://bytecloak.nl/_next/static/media/blurred-shape.b85797ad.svg"></div><div class="max-w6xl mx-auto px-4 sm:px-6"><div class="bg-linear-to-r from-transparent via-gray-800/50 py-12 md:py-20"><div class="mx-auto max-w-3xl text-center"><h2 class="animate-[gradient_6s_linear_infinite] bg-[linear-gradient(to_right,var(--color-green-300),var(--color-green-800),var(--color-green-200),var(--color-green-800),var(--color-green-400))] bg-[length:200%_auto] bg-clip-text pb-4 font-nacelle text-3xl font-semibold text-transparent md:text-4xl">Take your red team to the next level</h2><div class="mx-auto max-w-xs sm:flex sm:max-w-none sm:justify-center"><div data-aos="fade-up" data-aos-delay="400" class="aos-init"><a class="btn group mb-4 w-full bg-linear-to-t from-green-600 to-green-500 bg-[length:100%_100%] bg-[bottom] text-white shadow-[inset_0px_1px_0px_0px_--theme(--color-white/.16)] hover:bg-[length:100%_150%] sm:mb-0 sm:w-auto" href="https://bytecloak.nl/contact/request-quote"><span class="relative inline-flex items-center">Request Quote<span class="ml-1 tracking-normal text-white/50 transition-transform group-hover:translate-x-0.5">-&gt;</span></span></a></div><div data-aos="fade-up" data-aos-delay="600" class="aos-init"><a class="btn relative w-full bg-linear-to-b from-gray-800 to-gray-800/60 bg-[length:100%_100%] bg-[bottom] text-gray-300 before:pointer-events-none before:absolute before:inset-0 before:rounded-[inherit] before:border before:border-transparent before:[background:linear-gradient(to_right,var(--color-gray-800),var(--color-gray-700),var(--color-gray-800))_border-box] before:[mask-composite:exclude_!important] before:[mask:linear-gradient(white_0_0)_padding-box,_linear-gradient(white_0_0)] hover:bg-[length:100%_150%] sm:ml-4 sm:w-auto" href="https://bytecloak.nl/contact/request-trial">Request Trial</a></div></div></div></div></div></section></main></div>
<next-route-announcer style="position: absolute;"><div aria-live="assertive" id="__next-route-announcer__" role="alert" style="position: absolute; border: 0px; height: 1px; margin: -1px; padding: 0px; width: 1px; clip: rect(0px, 0px, 0px, 0px); overflow: hidden; white-space: nowrap; overflow-wrap: normal;"></div></next-route-announcer></body></html>