Title:
Interesting Technique to Launch a Shellcode

Type:
Blog Post

Short Summary (4–8 sentences max):
- This SANS ISC diary analyzes a malicious PowerShell script that loads and executes shellcode in-memory while avoiding the common “VirtualAlloc + copy + CreateThread” execution pattern that EDRs often flag.  
- The script is dropped by a Windows executable and reads a second-stage file from `%APPDATA%`, extracting two payload blobs at fixed offsets and copying them into newly allocated executable memory.  
- Instead of creating a new thread, it resolves `User32!CallWindowProcA` dynamically and uses it to execute the shellcode by passing the shellcode address as a function pointer.  
- The post walks through deobfuscation, key API usage, and debugging steps (breakpoints on the allocated region and on `CallWindowProcA`) to confirm control flow into the shellcode.  
- It’s useful for malware analysts and defenders looking for less-common shellcode execution primitives, and for red teamers studying alternative execution paths that may blend into GUI-like behavior.

Technical Focus:
- PowerShell obfuscation and string deobfuscation with conditional `IEX`
- In-memory shellcode staging via `VirtualAlloc` / `VirtualProtect`-style patterns
- Shellcode copying with `System.Runtime.InteropServices.Marshal::Copy`
- Dynamic API resolution and delegate invocation (`GetDelegateForFunctionPointer`)
- Shellcode execution via `User32!CallWindowProcA` (no new thread)
- Debugging/triage workflow (hardware breakpoints, API breakpoints)

Use Cases:
- Identify and hunt for non-`CreateThread` shellcode execution techniques in telemetry
- Build detection logic around suspicious `CallWindowProc*` usage with RWX memory regions
- Reverse engineer PowerShell loaders that stage payloads from disk with fixed offsets
- Develop and test EDR detection gaps around “exotic” Win32 callback-style execution

Keywords:
PowerShell, IEX, Invoke-Expression, shellcode, in-memory execution, VirtualAlloc, VirtualProtect, Marshal.Copy, GetDelegateForFunctionPointer, dynamic API resolution, User32.dll, CallWindowProcA, Win32 GUI API, callback execution, RWX memory, EDR evasion, hardware breakpoint, malware loader, process injection (local), SANS ISC diary