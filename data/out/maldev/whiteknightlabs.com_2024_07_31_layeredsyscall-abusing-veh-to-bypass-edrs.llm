Title:
LayeredSyscall – Abusing VEH to Bypass EDRs

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post presents “LayeredSyscall,” a technique/tool that uses Vectored Exception Handlers (VEH) plus hardware breakpoints to execute indirect syscalls while preserving a legitimate-looking thread call stack.  
- It targets common EDR user-mode hooking of `Nt*` syscall stubs in `ntdll.dll` (inline detours/IAT redirection) and the resulting detections based on anomalous call stacks or direct-syscall return addresses.  
- The approach sets HW breakpoints on the `syscall` and subsequent `ret` opcodes inside the chosen `Nt*` wrapper, then uses `EXCEPTION_SINGLE_STEP` handling to redirect execution through a benign Windows API to let the OS naturally build a plausible stack.  
- It supports syscalls with >4 arguments by locating a stack frame with sufficient `sub rsp, imm` allocation and a subsequent `call` instruction, then placing additional arguments onto that frame without corrupting return addresses.  
- SSNs are resolved dynamically (referencing MDSec’s exception-directory method) and wrappers are generated from SysWhispers3 prototypes.  
- Demonstrated impact includes evading Sophos Intercept X detection for a process hollowing test by wrapping syscalls with this VEH/HWBP-based flow.  
- Useful for red teams, offensive security researchers, and malware developers; also valuable to blue teams for understanding detection gaps around VEH/HWBP-assisted syscall evasion.

Technical Focus:
- User-mode EDR hook evasion (ntdll `Nt*` stubs)
- Vectored Exception Handling (VEH) for control-flow/context manipulation
- Hardware breakpoints (DR0–DR3, DR7) and `EXCEPTION_SINGLE_STEP`
- Indirect syscalls and syscall stub opcode scanning (`0F 05`, `C3`)
- Windows x64 calling convention and stack-frame/argument placement (>4 args)
- Dynamic System Service Number (SSN) resolution

Use Cases:
- Bypassing user-land EDR hooks without unhooking/remapping `ntdll.dll`
- Call-stack “legitimization” for syscall-based injection primitives
- Wrapping sensitive syscalls (e.g., process/thread/memory syscalls) to reduce telemetry
- Researching/demonstrating detection weaknesses in stack-based syscall heuristics
- Building PoCs for VEH/HWBP-based control-flow redirection in Windows

Keywords:
VEH, Vectored Exception Handler, hardware breakpoints, DR0, DR7, EXCEPTION_SINGLE_STEP, EXCEPTION_ACCESS_VIOLATION, ntdll.dll, Nt* syscalls, indirect syscall, syscall stub, 0F 05, ret opcode C3, user-mode hooks, inline detours, IAT hooking, call stack spoofing, Windows x64 calling convention, SSN resolution, SysWhispers3, process hollowing, Sophos Intercept X