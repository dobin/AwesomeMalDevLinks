# https://back.engineering/blog/29/03/2021/

<!DOCTYPE html><html itemscope="" class="dark" lang="en-us" itemtype="http://schema.org/WebPage"><body><div class="search-modal" aria-hidden="true" style="--color-primary:#121212"><div data-target="close-search-modal" class="search-modal-overlay"></div><div class="search-wrapper" data-image="true" data-description="true" data-tags="true" data-categories="true"><div class="search-wrapper-header"><label for="search-modal-input" style="margin-top:-1px"><span class="sr-only">search icon</span>
<svg viewBox="0 0 512 512" height="18" width="18" class="search-icon" data-type="search" style="display: initial;"><path fill="currentColor" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8.0 45.3s-32.8 12.5-45.3.0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9.0 208S93.1.0 208 0 416 93.1 416 208zM208 352a144 144 0 100-288 144 144 0 100 288z"></path></svg>
<svg viewBox="0 0 512 512" height="18" width="18" class="search-reset" data-type="reset" style="display: none;"><path fill="currentColor" d="M256 512A256 256 0 10256 0a256 256 0 100 512zM175 175c9.4-9.4 24.6-9.4 33.9.0l47 47 47-47c9.4-9.4 24.6-9.4 33.9.0s9.4 24.6.0 33.9l-47 47 47 47c9.4 9.4 9.4 24.6.0 33.9s-24.6 9.4-33.9.0l-47-47-47 47c-9.4 9.4-24.6 9.4-33.9.0s-9.4-24.6.0-33.9l47-47-47-47c-9.4-9.4-9.4-24.6.0-33.9z"></path></svg>
</label><input id="search-modal-input" type="text" data-search-input="" autocomplete="off" aria-label="Search" placeholder="Search Post..."></div><div class="search-wrapper-body"><div class="search-result" data-search-result=""></div><span class="search-result-empty"></span></div><div class="search-wrapper-footer"><span><kbd><svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M3.204 11h9.592L8 5.519 3.204 11zm-.753-.659 4.796-5.48a1 1 0 011.506.0l4.796 5.48c.566.647.106 1.659-.753 1.659H3.204a1 1 0 01-.753-1.659z"></path></svg>
</kbd><kbd><svg width="14" height="14" fill="currentColor" style="margin-top:1px" viewBox="0 0 16 16"><path d="M3.204 5h9.592L8 10.481 3.204 5zm-.753.659 4.796 5.48a1 1 0 001.506.0l4.796-5.48c.566-.647.106-1.659-.753-1.659H3.204a1 1 0 00-.753 1.659z"></path></svg>
</kbd>to navigate
</span><span><kbd><svg width="12" height="12" fill="currentColor" style="display:inline-block" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M14.5 1.5a.5.5.0 01.5.5v4.8a2.5 2.5.0 01-2.5 2.5H2.707l3.347 3.346a.5.5.0 01-.708.708l-4.2-4.2a.5.5.0 010-.708l4-4a.5.5.0 11.708.708L2.707 8.3H12.5A1.5 1.5.0 0014 6.8V2a.5.5.0 01.5-.5z"></path></svg>
</kbd>to select
</span><span class="search-result-info"></span>
<span data-target="close-search-modal"><kbd>ESC</kbd> to close</span></div></div></div><main><section class="section pt-7"><div class="container"><div class="row justify-center"><article class="lg:col-10"><h1 class="h2 mb-4">Hyperspace - Hidden Address Spaces</h1><ul class="mb-4"><li class="mr-4 inline-block"><a href="https://back.engineering/authors/idontcode/"><i class="fa-regular fa-circle-user mr-2"></i>IDontCode</a></li><li class="mr-4 inline-block"><i class="fa-regular fa-folder mr-2"></i>
<a href="https://back.engineering/categories/windows/">Windows</a></li><li class="mr-4 inline-block"><i class="fa-regular fa-clock mr-2"></i>
March 29, 2021</li></ul><div class="content mb-10"><details open="" class="table-of-content blog"><summary>Table of Contents</summary></details><p>Download link: <a href="https://githacks.org/_xeroxz/hyperspace">Hyperspace</a></p><h3 id="table-of-contents">Table Of Contents</h3><ul><li><a href="https://back.engineering/blog/29/03/2021/#intro">Introduction - Address Spaces</a></li><li><a href="https://back.engineering/blog/29/03/2021/#thread-scheduler">Thread Scheduler - Trap Frames and Control Registers</a></li><li><a href="https://back.engineering/blog/29/03/2021/#DKOM">DKOM - Direct Kernel Object Manipulation</a></li><li><a href="https://back.engineering/blog/29/03/2021/#windows-memory-manager">Windows Memory Manager - MiStealPage</a></li><li><a href="https://back.engineering/blog/29/03/2021/#example">Example - printf, malloc, etc</a></li><li><a href="https://back.engineering/blog/29/03/2021/#conclusions">Limitations - Crashes and Conclusions</a></li></ul><h2 id="intro">Introduction - Address Spaces</h2><p>An address space is defined as a region of memory. In this post I will be referring to an address space in reference to a 64bit virtual address space on x86 architecture. <em><strong>Control Register Three (CR3)</strong></em> contains the <em><strong>PFN (Page Frame Number)</strong></em> of the current <em><strong>Page Map Level Four (PML4)</strong></em>. It is also known as dirbase.</p><p>On Windows, each process has its own virtual address space. The CR3 value loaded into a logical processor is located inside of the KPROCESS structure.</p><pre tabindex="0"><code>&gt; dt -r _EPROCESS
ntdll!_EPROCESS
   +0x000 Pcb              : _KPROCESS
      +0x000 Header           : _DISPATCHER_HEADER
         +0x000 Lock             : Int4B
         +0x000 LockNV           : Int4B
         +0x000 Type             : UChar
         +0x001 Signalling       : UChar
         +0x002 Size             : UChar
         +0x003 Reserved1        : UChar
         +0x000 TimerType        : UChar
         // ....
         +0x000 MutantType       : UChar
         +0x001 MutantSize       : UChar
         +0x002 DpcActive        : UChar
         +0x003 MutantReserved   : UChar
         +0x004 SignalState      : Int4B
         +0x008 WaitListHead     : _LIST_ENTRY
      +0x018 ProfileListHead  : _LIST_ENTRY
         +0x000 Flink            : Ptr64 _LIST_ENTRY
         +0x008 Blink            : Ptr64 _LIST_ENTRY
      +0x028 DirectoryTableBase : Uint8B &lt;==== CR3 value
</code></pre><p><em><strong>Figure 1. EPROCESS contains a substruct of KPROCESS which contains DirectoryTableBase</strong></em></p><h2 id="thread-scheduler">Thread Scheduler - Trap Frames and Control Registers</h2><p>The Windows thread scheduler is responsible for scheduling logical processors (LP’s) to execute threads. A LP contains the current processor control block at the segment base of GS. This structure contains many things, many substructures, and most importantly the current KTHREAD.</p><pre tabindex="0"><code>&gt; dt _KPCR
ntdll!_KPCR
   +0x000 NtTib            : _NT_TIB
   +0x000 GdtBase          : Ptr64 _KGDTENTRY64
   +0x008 TssBase          : Ptr64 _KTSS64
   +0x010 UserRsp          : Uint8B
   +0x018 Self             : Ptr64 _KPCR
   +0x020 CurrentPrcb      : Ptr64 _KPRCB ; KPRCB contains KTHREAD

&gt; dt _KPRCB
ntdll!_KPRCB
   +0x000 MxCsr            : Uint4B
   +0x004 LegacyNumber     : UChar
   +0x005 ReservedMustBeZero : UChar
   +0x006 InterruptRequest : UChar
   +0x007 IdleHalt         : UChar
   +0x008 CurrentThread    : Ptr64 _KTHREAD ; KTHREAD contains KAPC_STATE

&gt; dt _KTHREAD
ntdll!_KTHREAD
   +0x000 Header           : _DISPATCHER_HEADER
   +0x018 SListFaultAddress : Ptr64 Void
   +0x020 QuantumTarget    : Uint8B
   +0x028 InitialStack     : Ptr64 Void
   // ...
   +0x080 SystemCallNumber : Uint4B
   +0x084 ReadyTime        : Uint4B
   +0x088 FirstArgument    : Ptr64 Void
   +0x090 TrapFrame        : Ptr64 _KTRAP_FRAME
   +0x098 ApcState         : _KAPC_STATE ; APC state contains KPROCESS
</code></pre><p><em><strong>Figure 2. KPCR-&gt;CurrentPrcb-&gt;CurrentThread-&gt;ApcState.Process to get current KPROCESS</strong></em></p><p>When a LP gets interrupted and rescheduled, all general purpose registers are moved into a trap frame, which is then located inside of the KTHREAD. When a LP gets interrupted in usermode, the trap frame <em><strong>KUMS_CONTEXT_HEADER</strong></em> is used, this also contains a <em><strong>KTRAP_FRAME</strong></em>. If a LP gets interrupted in CPL0 the KTRAP_FRAME is just used.</p><pre tabindex="0"><code>&gt; dt _KTRAP_FRAME
ntdll!_KTRAP_FRAME
   +0x000 P1Home           : Uint8B
   +0x008 P2Home           : Uint8B
   +0x010 P3Home           : Uint8B
   +0x018 P4Home           : Uint8B
   +0x020 P5               : Uint8B
   +0x028 PreviousMode     : Char
   +0x028 InterruptRetpolineState : UChar
   +0x029 PreviousIrql     : UChar
   +0x02a FaultIndicator   : UChar
   +0x02a NmiMsrIbrs       : UChar
   +0x02b ExceptionActive  : UChar
   +0x02c MxCsr            : Uint4B
   +0x030 Rax              : Uint8B
   +0x038 Rcx              : Uint8B
   +0x040 Rdx              : Uint8B
   +0x048 R8               : Uint8B
   +0x050 R9               : Uint8B
   +0x058 R10              : Uint8B
   +0x060 R11              : Uint8B
   +0x068 GsBase           : Uint8B
   +0x068 GsSwap           : Uint8B
   +0x070 Xmm0             : _M128A
   +0x080 Xmm1             : _M128A
   +0x090 Xmm2             : _M128A
   +0x0a0 Xmm3             : _M128A
   +0x0b0 Xmm4             : _M128A
   +0x0c0 Xmm5             : _M128A
   +0x0d0 FaultAddress     : Uint8B
   +0x0d0 ContextRecord    : Uint8B
   +0x0d8 Dr0              : Uint8B
   +0x0e0 Dr1              : Uint8B
   +0x0e8 Dr2              : Uint8B
   +0x0f0 Dr3              : Uint8B
   +0x0f8 Dr6              : Uint8B
   +0x100 Dr7              : Uint8B
   +0x108 DebugControl     : Uint8B
   +0x110 LastBranchToRip  : Uint8B
   +0x118 LastBranchFromRip : Uint8B
   +0x120 LastExceptionToRip : Uint8B
   +0x128 LastExceptionFromRip : Uint8B
   +0x130 SegDs            : Uint2B
   +0x132 SegEs            : Uint2B
   +0x134 SegFs            : Uint2B
   +0x136 SegGs            : Uint2B
   +0x138 TrapFrame        : Uint8B
   +0x140 Rbx              : Uint8B
   +0x148 Rdi              : Uint8B
   +0x150 Rsi              : Uint8B
   +0x158 Rbp              : Uint8B
   +0x160 ErrorCode        : Uint8B
   +0x160 ExceptionFrame   : Uint8B
   +0x168 Rip              : Uint8B
   // ...
</code></pre><p><em><strong>Figure 3. trapped registers, notice no CR3.</strong></em></p><p>As you can see from above, CR3 is not included in this trap frame. This is because the windows thread scheduler loads CR3 from KPROCESS-&gt;DirectoryTableBase. The thread scheduler gets the KPROCESS from KTHREAD-&gt;ApcState.Process (PsGetCurrentProcess).</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="display:flex"><span>v15 <span style="color:#f92672">=</span> v4<span style="color:#f92672">-&gt;</span>ApcState.Process;
</span></span><span style="display:flex"><span><span style="color:#66d9ef">if</span> ( v15 <span style="color:#f92672">!=</span> <span style="color:#f92672">*</span>(_KPROCESS <span style="color:#f92672">**</span>)(v3 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xB8</span>) )
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    v16 <span style="color:#f92672">=</span> v15<span style="color:#f92672">-&gt;</span>DirectoryTableBase;
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">if</span> ( (KiKvaShadow <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>    <span style="color:#75715e">// handle KVA shadowing stuff...
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex"><span>    <span style="color:#75715e">// change to new 
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span>    __writecr3(v16);
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p><em><strong>Figure 4. KiSwapContext snippet showing CR3 swap…</strong></em></p><h2 id="DKOM">DKOM - Direct Kernel Object Manipulation</h2><p>Given the information laid out above, we can easily make our own address space by allocating a naturally aligned (4kb aligned) physical page as our PML4. We can then make a new KPROCESS structure by cloning an existing one, and then DKOM its DirectoryTableBase with the new PML4. This will create a 1:1 KPROCESS except with a new PML4. Swapping KTHREAD-&gt;ApcState.Process with this newly created KPROCESS will make the next LP to execute this thread run in our new address space. Keep in mind that there are structures above KPROCESS and so it’s important that these are also copied.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="display:flex"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_KPROCESS</span>
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_DISPATCHER_HEADER</span> Header;              <span style="color:#75715e">//0x0
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_LIST_ENTRY</span> ProfileListHead;            <span style="color:#75715e">//0x18
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span>    ULONGLONG DirectoryTableBase;                  <span style="color:#75715e">//0x28 &lt;---- put new CR3 value here...
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_LIST_ENTRY</span> ThreadListHead;             <span style="color:#75715e">//0x30
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span>    ULONG ProcessLock;                             <span style="color:#75715e">//0x40
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> gap0[<span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">-</span> <span style="color:#66d9ef">sizeof</span> _KPROCESS];
</span></span><span style="display:flex"><span>};
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_KAPC_STATE</span>
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_LIST_ENTRY</span> ApcListHead[<span style="color:#ae81ff">2</span>];             <span style="color:#75715e">//0x0
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_KPROCESS</span><span style="color:#f92672">*</span> Process;                     <span style="color:#75715e">//0x20 &lt;----- swap this with new fake KPROCESS...
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">union</span>
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>        UCHAR InProgressFlags;                     <span style="color:#75715e">//0x28
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">struct</span>
</span></span><span style="display:flex"><span>        {
</span></span><span style="display:flex"><span>            UCHAR KernelApcInProgress:<span style="color:#ae81ff">1</span>;           <span style="color:#75715e">//0x28
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span>            UCHAR SpecialApcInProgress:<span style="color:#ae81ff">1</span>;          <span style="color:#75715e">//0x28
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span>        };
</span></span><span style="display:flex"><span>    };
</span></span><span style="display:flex"><span>};
</span></span></code></pre></div><p><em><strong>Figure 5. C++ structures and comments for fields to DKOM &amp; swap…</strong></em></p><h2 id="windows-memory-manager">Windows Memory Manager - MiStealPage</h2><p>The windows memory manager can and will steal PFN’s in order to keep as much contiguous physical memory as possible. This includes page tables. In order to prevent windows from stealing our newly allocated PML4, we can completely remove the physical memory from the system via MmRemovePhysicalMemory.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="display:flex"><span>NTSTATUS <span style="color:#a6e22e">MmAllocateCopyRemove</span>
</span></span><span style="display:flex"><span>(
</span></span><span style="display:flex"><span>    _In_ PVOID SrcPtr,
</span></span><span style="display:flex"><span>    _In_ ULONG DataSize,
</span></span><span style="display:flex"><span>    _Out_ PPHYSICAL_ADDRESS PhysPtr
</span></span><span style="display:flex"><span>)
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    LARGE_INTEGER AllocSize;
</span></span><span style="display:flex"><span>    PHYSICAL_ADDRESS MaxPhys;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    PVOID Alloc <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex"><span>    MaxPhys.QuadPart <span style="color:#f92672">=</span> MAXLONG64;
</span></span><span style="display:flex"><span>    AllocSize.QuadPart <span style="color:#f92672">=</span> DataSize;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>(Alloc <span style="color:#f92672">=</span> MmAllocateContiguousMemory(DataSize, MaxPhys)))
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">return</span> STATUS_FAIL_CHECK;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    memcpy(Alloc, SrcPtr, DataSize);
</span></span><span style="display:flex"><span>    <span style="color:#f92672">*</span>PhysPtr <span style="color:#f92672">=</span> MmGetPhysicalAddress(Alloc);
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    MmFreeContiguousMemory(Alloc);
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">return</span> MmRemovePhysicalMemory(PhysPtr, <span style="color:#f92672">&amp;</span>AllocSize);
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>Firstly we allocate contiguous physical memory via MmAllocateContiguousMemory, then we write the PML4E’s into this newly allocated page, then we MmFreeContiguousMemory. Lastly we then remove this physical memory entirely from the system. If you look in RAMMAP you can see that the physical memory ranges have now changed to reflect this removal.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="display:flex"><span>PHYSICAL_ADDRESS PageMapLevel4;
</span></span><span style="display:flex"><span>PVOID PageMapLevel4Virt;
</span></span><span style="display:flex"><span>NTSTATUS Result;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>PageMapLevel4.QuadPart <span style="color:#f92672">=</span> cr3{ __readcr3() }.pml4_pfn <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">12</span>;
</span></span><span style="display:flex"><span>PageMapLevel4Virt <span style="color:#f92672">=</span> MmGetVirtualForPhysical(PageMapLevel4);
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>PHYSICAL_ADDRESS PageMapLevel4Clone;
</span></span><span style="display:flex"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>NT_SUCCESS((Result <span style="color:#f92672">=</span> MmAllocateCopyRemove(PageMapLevel4Virt, <span style="color:#ae81ff">0x1000</span>, <span style="color:#f92672">&amp;</span>PageMapLevel4Clone))))
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    DbgPrint(<span style="color:#e6db74">"&gt; MmAllocateCopyRemove Failed With: 0x%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>, Result);
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">return</span> Result;
</span></span><span style="display:flex"><span>}
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>DbgPrint(<span style="color:#e6db74">"&gt; MmAllocateCopyRemove Success... </span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">Page Map Level 4 Clone: 0x%p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>,
</span></span><span style="display:flex"><span>    PageMapLevel4Clone.QuadPart);
</span></span></code></pre></div><pre tabindex="0"><code>&gt; MmAllocateCopyRemove Success... 
&gt; Page Map Level 4 Clone: 0x0000000217A59000
</code></pre><p><em><strong>Figure 6. C++ code calling MmAllocateCopyRemove</strong></em></p><div style="text-align:center"><img src="https://back.engineering/rammap.png" alt="RAMMAP showing physical page removal" style="max-width:800px;width:100%"></div><p><em><strong>Figure 7. RAMMAP showing that the physical page is removed…</strong></em></p><h2 id="example">Example - printf, etc</h2><p>In this example, the current processes main thread is hyperjmp’ed into a newly created address space which is 1:1 with the original address space. A loop is executed and each iteration simply prints the current CR3 value by syscalling into a windows routine which has the first few bytes of the syscall routine overwritten.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="display:flex"><span>vdm<span style="color:#f92672">::</span>read_phys_t _read_phys <span style="color:#f92672">=</span>
</span></span><span style="display:flex"><span>  [<span style="color:#f92672">&amp;</span>](<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> addr, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> buffer, std<span style="color:#f92672">::</span>size_t size) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">return</span> vdm<span style="color:#f92672">::</span>read_phys(addr, buffer, size);
</span></span><span style="display:flex"><span>};
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>vdm<span style="color:#f92672">::</span>write_phys_t _write_phys <span style="color:#f92672">=</span>
</span></span><span style="display:flex"><span>  [<span style="color:#f92672">&amp;</span>](<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> addr, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> buffer, std<span style="color:#f92672">::</span>size_t size) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">return</span> vdm<span style="color:#f92672">::</span>write_phys(addr, buffer, size);
</span></span><span style="display:flex"><span>};
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>vdm<span style="color:#f92672">::</span>vdm_ctx vdm(_read_phys, _write_phys);
</span></span><span style="display:flex"><span>ptm<span style="color:#f92672">::</span>ptm_ctx my_proc(<span style="color:#f92672">&amp;</span>vdm);
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>hyperspace<span style="color:#f92672">::</span>hyper_ctx hyperspace(<span style="color:#f92672">&amp;</span>my_proc);
</span></span><span style="display:flex"><span>hyperspace.hyper_jmp();
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> idx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0u</span>; idx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; <span style="color:#f92672">++</span>idx)
</span></span><span style="display:flex"><span>        std<span style="color:#f92672">::</span>printf(<span style="color:#e6db74">"[+] (old thread) hyperspace cr3 -&gt; 0x%p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>, vdm.readcr3());
</span></span><span style="display:flex"><span>}
</span></span><span style="display:flex"><span>hyperspace.hyper_ret();
</span></span></code></pre></div><pre tabindex="0"><code>[+] cr3 -&gt; 0x000000017232C000
// note that the LP has not been interrupted by the thread 
// scheduler at this point so CR3 is the same as the original...
[+] (old thread) hyperspace cr3 -&gt; 0x000000017232C000 
[+] (old thread) hyperspace cr3 -&gt; 0x0000000217D07000
[+] (old thread) hyperspace cr3 -&gt; 0x0000000217D07000
[+] (old thread) hyperspace cr3 -&gt; 0x0000000217D07000
[+] (old thread) hyperspace cr3 -&gt; 0x0000000217D07000
[+] (old thread) hyperspace cr3 -&gt; 0x0000000217D07000
[+] (old thread) hyperspace cr3 -&gt; 0x0000000217D07000
[+] (old thread) hyperspace cr3 -&gt; 0x0000000217D07000
[+] (old thread) hyperspace cr3 -&gt; 0x0000000217D07000
[+] (old thread) hyperspace cr3 -&gt; 0x0000000217D07000
</code></pre><p><em><strong>Figure 8. C++ Hyperspace Demo.</strong></em></p><h2 id="conclusions">Limitations - Crashes and Conclusions</h2><p>When executing inside of hyperspace, a thread cannot create a new thread, terminate, or create a new process. The address space will change the next time the windows thread scheduler reschedules a LP to execute the KTHREAD. Furthermore if you want to explicitly change the address space being executed in by the current LP you can change CR3 to the same value as the new DirectoryTableBase.</p><h3 id="possible-detections">Possible Detections</h3><p>If you are on a multi processor system another processor could fire an IPI or an NMI directed at all or just a single LP. This will cause the LP to trap its registers, however CR3 will not change. KeIpiGenericCall doesn’t switch the LP to system address space from my tests. One can check the current CR3, current KPROCESS, RIP, etc.</p></div><div class="row items-start justify-between"><div class="lg:col-6 mb-10 flex items-center lg:mb-0"><h5 class="mr-3">Tags:</h5><ul><li class="inline-block"><a class="bg-light hover:bg-primary dark:bg-darkmode-light dark:hover:bg-darkmode-primary dark:hover:text-text-dark m-1 block rounded px-3 py-1 hover:text-white" href="https://back.engineering/tags/windows-kernel/">Windows kernel</a></li><li class="inline-block"><a class="bg-light hover:bg-primary dark:bg-darkmode-light dark:hover:bg-darkmode-primary dark:hover:text-text-dark m-1 block rounded px-3 py-1 hover:text-white" href="https://back.engineering/tags/vdm/">Vdm</a></li><li class="inline-block"><a class="bg-light hover:bg-primary dark:bg-darkmode-light dark:hover:bg-darkmode-primary dark:hover:text-text-dark m-1 block rounded px-3 py-1 hover:text-white" href="https://back.engineering/tags/ptm/">Ptm</a></li></ul></div><div class="lg:col-6 flex items-center lg:justify-end"><h5>Share :</h5><div class="share-icons"><a class="share-link share-facebook" href="https://facebook.com/sharer/sharer.php?u=%2fblog%2f29%2f03%2f2021%2f" target="_blank" rel="noopener" aria-label="share facebook"><span class="share-icon"><svg viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"></path></svg>
</span></a><a class="share-link share-x" href="https://x.com/intent/tweet/?text=Hyperspace%20-%20Hidden%20Address%20Spaces&amp;url=%2fblog%2f29%2f03%2f2021%2f" target="_blank" rel="noopener" aria-label="share x"><span aria-hidden="true" class="share-icon"><svg viewBox="0 0 24 24"><path d="M8 2H1l8.26 11.015L1.45 22H4.1l6.388-7.349L16 22h7l-8.608-11.478L21.8 2h-2.65l-5.986 6.886zm9 18L5 4h2l12 16z"></path></svg>
</span></a><a class="share-link share-email" href="mailto:?subject=Hyperspace%20-%20Hidden%20Address%20Spaces&amp;body=%2fblog%2f29%2f03%2f2021%2f" target="_self" rel="noopener" aria-label="share email"><span aria-hidden="true" class="share-icon"><svg viewBox="0 0 24 24"><path d="M22 4H2C.9 4 0 4.9.0 6v12c0 1.1.9 2 2 2h20c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zM7.25 14.43l-3.5 2c-.08.05-.17.07-.25.07-.17.0-.34-.1-.43-.25-.14-.24-.06-.55.18-.68l3.5-2c.24-.14.55-.06.68.18.14.24.06.55-.18.68zm4.75.07c-.1.0-.2-.03-.27-.08l-8.5-5.5c-.23-.15-.3-.46-.15-.7.15-.22.46-.3.7-.14L12 13.4l8.23-5.32c.23-.15.54-.08.7.15.14.23.07.54-.16.7l-8.5 5.5c-.08.04-.17.07-.27.07zm8.93 1.75c-.1.16-.26.25-.43.25-.08.0-.17-.02-.25-.07l-3.5-2c-.24-.13-.32-.44-.18-.68s.44-.32.68-.18l3.5 2c.24.13.32.44.18.68z"></path></svg>
</span></a><span class="fediverse-share"><a class="share-link share-fediverse" aria-label="share fediverse"><span aria-hidden="true" class="share-icon"><svg viewBox="-10 -5 1034 1034" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M539 176q-32 0-55 22t-25 55 20.5 58 56 27 58.5-20.5 27-56-20.5-59T544 176h-5zm-87 95-232 118q20 20 25 48l231-118q-19-20-24-48zm167 27q-13 25-38 38l183 184q13-25 39-38zM477 320 342 585l40 40 143-280q-28-5-48-25zm104 16q-22 11-46 10l-8-1 21 132 56 9zM155 370q-32 0-55 22.5t-25 55 20.5 58 56.5 27 59-21 26.5-56-21-58.5-55.5-27h-6zm90 68q1 9 1 18-1 19-10 35l132 21 26-50zm225 36-26 51 311 49q-1-8-1-17 1-19 10-36zm372 6q-32 1-55 23t-24.5 55 21 58 56 27 58.5-20.5 27-56.5-20.5-59-56.5-27h-6zM236 493q-13 25-39 38l210 210 51-25zm-40 38q-21 11-44 10l-9-1 40 256q21-10 45-9l8 1zm364 22 48 311q21-10 44-9l10 1-46-294zm195 23-118 60 8 56 135-68q-20-20-25-48zm26 49-119 231q28 5 48 25l119-231q-28-5-48-25zM306 654l-68 134q28 5 48 25l60-119zm262 17-281 143q19 20 24 48l265-135zM513 771l-51 25 106 107q13-25 39-38zM222 795q-32 0-55.5 22.5t-25 55 21 57.5 56 27 58.5-20.5 27-56-20.5-58.5-56.5-27h-5zm89 68q2 9 1 18-1 19-9 35l256 41q-1-9-1-18 1-18 10-35zm335 0q-32 0-55 22.5t-24.5 55 20.5 58 56 27 59-21 27-56-20.5-58.5-56.5-27h-6z"></path></g></svg>
</span></a><span class="fediverse-input-wrapper" style="display:none"><input type="text" placeholder="Enter Fediverse Instance URL" class="fediverse-input">
<button class="fediverse-check-button">
Share
</button>
</span></span><button class="share-link share-copy">
<span class="share-icon"><svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-1.1.0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1.0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7-1c.55.0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 17H5V5h14v14z"></path></svg></span></button></div></div></div></article></div><div class="section pb-0"><h2 class="h3 mb-12">Related Posts</h2><div class="row"><div class="lg:col-4 md:col-6 mb-14"><div class="bg-body dark:bg-darkmode-body"><h4 class="mb-3"><a href="https://back.engineering/blog/23/08/2020/">Virtual Memory - Intro to Paging Tables</a></h4><ul class="mb-4"><li class="mr-4 inline-block"><i class="fa-regular fa-circle-user mr-2"></i>
<a href="https://back.engineering/authors/idontcode/" class="ms-1">IDontCode</a></li><li class="mr-4 inline-block"><i class="fa-regular fa-folder mr-1"></i>
<a href="https://back.engineering/categories/windows/" class="ms-1">Windows</a></li></ul><p class="mb-6">Virtual memory is probably one of the most interesting topics of modern computer science. Although virtual memory was originally designed back when physical memory was not an abundant resource to allow the use of disk space as ram, it has stuck with us, offering security, modularity, and flexibility. Unlike the rest of the content on my sites which is bound to an operating system, virtual memory is really a CPU level concept.</p><a class="btn btn-outline-primary btn-sm" href="https://back.engineering/blog/23/08/2020/">Read More</a></div></div><div class="lg:col-4 md:col-6 mb-14"><div class="bg-body dark:bg-darkmode-body"><h4 class="mb-3"><a href="https://back.engineering/blog/22/03/2021/">MSREXEC - Elevate Arbitrary WRMSR to Kernel Execution</a></h4><ul class="mb-4"><li class="mr-4 inline-block"><i class="fa-regular fa-circle-user mr-2"></i>
<a href="https://back.engineering/authors/idontcode/" class="ms-1">IDontCode</a></li><li class="mr-4 inline-block"><i class="fa-regular fa-folder mr-1"></i>
<a href="https://back.engineering/categories/windows/" class="ms-1">Windows</a></li></ul><p class="mb-6">MSREXEC is a library to elevate arbitrary MSR (Model Specific Register) writes to kernel execution. The project is extremely modular and open ended on how writes to MSR’s are achieved...</p><a class="btn btn-outline-primary btn-sm" href="https://back.engineering/blog/22/03/2021/">Read More</a></div></div><div class="lg:col-4 md:col-6 mb-14"><div class="bg-body dark:bg-darkmode-body"><h4 class="mb-3"><a href="https://back.engineering/blog/27/03/2021/">Reverse Injector - Merging Address Spaces</a></h4><ul class="mb-4"><li class="mr-4 inline-block"><i class="fa-regular fa-circle-user mr-2"></i>
<a href="https://back.engineering/authors/idontcode/" class="ms-1">IDontCode</a></li><li class="mr-4 inline-block"><i class="fa-regular fa-folder mr-1"></i>
<a href="https://back.engineering/categories/windows/" class="ms-1">Windows</a></li></ul><p class="mb-6">The bottom 256 PML4E’s are what map all code, data, and stacks. The 256th PML4E maps modules such as ntdll.dll, and other loaded modules. As you can foresee, some PML4E index’s overlap. In order to handle overlapping PML4E’s, Reverse Injector simply finds empty PML4E’s and inserts the remote PML4E’s into them.</p><a class="btn btn-outline-primary btn-sm" href="https://back.engineering/blog/27/03/2021/">Read More</a></div></div></div></div></div></section></main><div id="cookie-box" class="cookie-box">This site uses cookies. By continuing to use this website, you agree to their use.
<button id="cookie-button" class="cookie-box-button btn btn-sm btn-outline-primary">
I Accept</button></div>
</body></html>