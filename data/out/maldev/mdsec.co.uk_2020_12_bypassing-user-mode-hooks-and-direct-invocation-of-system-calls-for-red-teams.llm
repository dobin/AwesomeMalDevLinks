Title:
Bypassing User-Mode Hooks and Direct Invocation of System Calls for Red Teams

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post surveys practical techniques to bypass EDR/AV user-mode API hooks (primarily in `ntdll.dll`) by invoking Windows system calls directly.  
- It frames the problem around reliability of common offensive actions like process injection, which are often disrupted by user-mode hooks and kernel telemetry (image-load notifications, minifilter-based I/O monitoring), while PatchGuard limits kernel patching approaches.  
- Techniques covered include resolving syscalls via EAT parsing, mapping clean copies of `ntdll` (via `\KnownDlls` sections or from disk), extracting syscall stubs/SSNs from disk, and generic discovery approaches like FireWalker single-stepping.  
- It also discusses SysWhispers-style generated syscall stubs with runtime OS version selection, and an SSN derivation method that sorts `Zw*` export stub addresses to infer syscall indices without version checks.  
- Defensive guidance includes signature/emulation detection of syscall stubs, Windows mitigation policies (including syscall filtering), and using `ProcessInstrumentationCallback` and Intel PT/IPT to detect or trace manual syscalls.  
- Useful for red teams, malware developers, and defenders building detections around direct syscalls and hook bypass tradecraft.

Technical Focus:
- Windows user-mode hooking in `ntdll` and syscall dispatch mechanics
- Mapping/dual-loading `ntdll.dll` via `\KnownDlls` and `SEC_IMAGE` sections
- Export Address Table (EAT) parsing and PEB-based module discovery
- System Service Number (SSN) extraction/inference (Hell’s Gate / SysWhispers patterns)
- Vectored Exception Handling + trap flag single-stepping (FireWalker concept)
- Defensive detection via ProcessInstrumentationCallback, YARA/CAPA, and Intel PT

Use Cases:
- Implementing process injection primitives that avoid user-mode API hooks
- Building custom direct-syscall wrappers for sensitive NT APIs (e.g., memory/process/thread ops)
- Generating or dynamically resolving syscall numbers across Windows versions
- Creating detections for manual syscalls and suspicious `ntdll` remapping/unhooking behavior
- Evaluating EDR resilience against syscall-based evasion techniques

Keywords:
Windows syscalls, ntdll.dll, user-mode hooks, EDR bypass, direct system calls, SSN, System Service Number, Zw/Nt exports, Export Address Table, PEB, KUSER_SHARED_DATA, KnownDlls, NtMapViewOfSection, NtCreateSection, SEC_IMAGE, Vectored Exception Handler, trap flag, FireWalker, SysWhispers, Hell’s Gate, ProcessInstrumentationCallback, YARA, CAPA, Intel Processor Trace, PatchGuard, minifilter drivers, NtDeviceIoControlFile, process injection, unhooking