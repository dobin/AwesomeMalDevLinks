# https://www.cobaltstrike.com/blog/sleep-mask-update-in-cobalt-strike-4-5

<!DOCTYPE html><html lang="en-US"><body class="wp-singular post-template-default single single-post postid-2840 single-format-standard wp-custom-logo wp-embed-responsive wp-theme-helpsystems wp-child-theme-cobalt-strike group-blog understrap-has-sidebar"><div id="consent_blackbar" lang="en">
            
            <div id="truste-consent-track" style="position: relative; z-index: 999999; border-top: 1px solid rgb(102, 102, 102);" class="ta-show ta-display-block">  <div id="truste-consent-content" style="overflow: hidden;">    <div id="truste-consent-text" class="truste-messageColumn" data-nosnippet="data-nosnippet">      <span class="hstitle">This website uses cookies. You may change your settings at any time.</span>    </div>    <div id="truste-consent-buttons" class="truste-buttonsColumn" data-nosnippet="data-nosnippet">      <span id="truste-repop-msg" style="padding: 7px 10px; background: #F9EDBE; border:1px solid #F0C36D; margin: 11px 0px 13px;font-size:11; line-height: 16px;color: #AF7501; display:none;"></span>       <button id="truste-consent-button">Accept</button>      <button id="truste-consent-required">Reject All</button>      <button id="truste-show-consent" aria-haspopup="dialog">Manage Cookies</button>    </div>  </div></div></div>
<div style="display:none;" id="teconsent" consent="undefined" aria-label="Open Cookie Preferences Modal" class="truste_caIcon_display" role="complementary"><a role="link" id="icon-id004395486632566259" tabindex="0" lang="en" aria-haspopup="dialog" aria-label="Cookie Preferences, opens a dedicated popup modal window" class="truste_cursor_pointer">Cookie Preferences</a></div>

	
<!-- TrustArc tag end -->
<!-- Google Tag Manager -->

<!-- End Google Tag Manager --><link rel="icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-32x32.png" sizes="32x32">
<link rel="icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-192x192.png" sizes="192x192">
<link rel="apple-touch-icon" href="https://www.cobaltstrike.com/app/uploads/2023/06/cropped-android-chrome-512x512-2-180x180.png">

		
		


<!-- Google Tag Manager (noscript) -->

<!-- End Google Tag Manager (noscript) -->
<div class="site" id="page">

	<!-- ******************* The Navbar Area ******************* -->
	<!-- #wrapper-navbar -->

<div class="header-banner"> 
	<div class="jumbotron jumbotron-fluid bg-4 " style="background-image: ">
	<div class="banner-wrapper">
		<div class="container">
			<p class="yoast-breadcrumbs m-0"><span><span><a href="https://www.cobaltstrike.com/">Home</a></span> » <span><a href="https://www.cobaltstrike.com/blog/">Blog</a></span> » <span class="breadcrumb_last" aria-current="page">Sleep Mask Update in Cobalt Strike 4.5</span></span></p>							<h1>Sleep Mask Update in Cobalt Strike 4.5</h1>
								<p class="font-italic">Friday 17 December, 2021</p>

							</div>
	</div>
	</div>
</div>


<div class="wrapper" id="page-wrapper">

	<div class="container" id="content" tabindex="-1">
		<div class="row">
			<div class="col-lg-8 content-area" id="primary">

				<main class="site-main" id="main">
					<article class="post-2840 post type-post status-publish format-standard hentry cornerstone-releases cta_type-blog" id="post-2840">


<div class="entry-content">
		
<p>The Sleep Mask Kit was first introduced in <a href="https://www.cobaltstrike.com/blog/cobalt-strike-4-4-the-one-with-the-reconnect-button/" target="_blank" rel="noreferrer noopener">Cobalt Strike 4.4</a> to allow&nbsp;users to&nbsp;modify&nbsp;how the sleep mask function looks in memory&nbsp;in order to&nbsp;defeat static signatures&nbsp;that&nbsp;identified&nbsp;Beacon.&nbsp;This quickly took off in the community and its limits were pushed.&nbsp;Updates were <a href="https://www.cobaltstrike.com/blog/cobalt-strike-4-5-fork-run-youre-history/" target="_blank" rel="noreferrer noopener">made in 4.5</a> to help address some of these limits.</p>



<p>Licensed users can download the updated kit from<a href="https://www.cobaltstrike.com/scripts"> https://www.cobaltstrike.com/scripts</a></p>



<h3 class="wp-block-heading" id="what-s-new">What’s New?</h3>



<h4 class="wp-block-heading" id="increased-size">Increased size&nbsp;</h4>



<p>The size of the sleep mask executable code has been increased to 769 bytes from 289 bytes.&nbsp;</p>



<h4 class="wp-block-heading" id="heap-memory">Heap Memory&nbsp;</h4>



<p>A list of heap memory addresses has been added to the input to the sleep mask function.&nbsp;This allows for the ability to mask&nbsp;and unmask&nbsp;Beacon’s heap memory, which could be used to&nbsp;identify&nbsp;Beacon.</p>



<h3 class="wp-block-heading" id="compatibility">Compatibility</h3>



<p>Any sleep mask modifications for Cobalt Strike 4.4 will not be compatible with 4.5 because of the changes to the functions input.&nbsp;This also means the sleep mask modifications are also not backwards compatible.&nbsp; Users will need to&nbsp;have&nbsp;separate&nbsp;sleep mask&nbsp;versions&nbsp;for 4.4&nbsp;and 4.5.&nbsp;An updated sleep mask kit is available&nbsp;through the Cobalt Strike UI Help -&gt; Arsenal page.&nbsp;</p>



<h3 class="wp-block-heading" id="changes">Changes&nbsp;</h3>



<ul class="wp-block-list">
<li>Added a new <strong>HEAP_RECORDS</strong> data&nbsp;structure&nbsp;</li>



<li>Added a pointer to the <strong>HEAP_RECORDS</strong> data structure to the&nbsp;existing&nbsp;<strong>SLEEPMASKP</strong> structure&nbsp;</li>



<li>Added&nbsp;new loops to mask and unmask the heap memory identified by the <strong>HEAP_RECORDS</strong> structure.&nbsp;</li>
</ul>



<h3 class="wp-block-heading" id="limitations">Limitations</h3>



<p>These are the current limitations to the sleep mask kit for Cobalt Strike 4.5:</p>



<ul class="wp-block-list">
<li>The executable code size&nbsp;cannot&nbsp;exceed 769 bytes. If this occurs the default sleep mask function will be used.&nbsp;</li>



<li>Only one function can be defined in the source code file.&nbsp;</li>



<li>Use of external functions are not supported&nbsp;</li>
</ul>



<h3 class="wp-block-heading" id="example">Example</h3>



<p>For this example, the Sleep Mask Kit&nbsp;for Cobalt Strike version 4.5&nbsp;with&nbsp;a modification to the code to only mask and unmask when the sleep is larger than&nbsp;two seconds&nbsp;will be used.&nbsp;This allows&nbsp;for the ability to control the masking and unmasking of Beacon&nbsp;based on the current sleep time.&nbsp;&nbsp;</p>



<p>Generate a Beacon using the modified sleep mask and deploy it on your target system.&nbsp;The Beacon is now running and has a PID value of 5400&nbsp;for this example.&nbsp;</p>



<p>Using a Yara rule based on the&nbsp;<a href="https://github.com/CCob/BeaconEye" target="_blank" rel="noreferrer noopener">BeaconEye</a>&nbsp;project,&nbsp;beacon will be detected. The rule shows&nbsp;the memory address that triggered the detection&nbsp;as the current sleep time is set 1 second.</p>



<figure class="wp-block-image size-large"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/sleep-mask-beacon-eye-rule.png" alt="" class="wp-image-9292"><figcaption class="wp-element-caption">Detected at 0x7c7290</figcaption></figure>



<p>Using Process Hacker, open the process&nbsp;(5400)&nbsp;and look at the contents of&nbsp;memory at the found location of 0x7c7290.&nbsp;This is determined by finding the base address 0x7b0000 and subtracting from 0x7c7290&nbsp;to determine the offset&nbsp;within&nbsp;this block of heap memory.</p>



<figure class="wp-block-image size-large"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/sleep-mask-heap-unmasked.png" alt="" class="wp-image-9293"><figcaption class="wp-element-caption">Beacon’s configuration unmasked</figcaption></figure>



<p>The highlighted portion shows the signature that was used to identify&nbsp;Beacon, which represents Beacon’s configuration&nbsp;in the heap memory.&nbsp;</p>



<p>With the Cobalt Strike version 4.5 sleep mask this location in memory is provided&nbsp;as one of&nbsp;heap memory addresses&nbsp;in the <strong>HEAP_RECORDS</strong> list.&nbsp;Now, update the sleep time for this beacon to three seconds so it will mask&nbsp;itself&nbsp;while sleeping&nbsp;and then&nbsp;inspect this&nbsp;memory location&nbsp;again.&nbsp;</p>



<figure class="wp-block-image size-large"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/sleep-mask-heap-masked.png" alt="" class="wp-image-9294"><figcaption class="wp-element-caption">Beacon’s Configuration masked</figcaption></figure>



<p>Comparing this to the previous screenshot&nbsp;shows&nbsp;the&nbsp;heap&nbsp;memory is now masked.&nbsp;Running&nbsp;the Yara rule&nbsp;again shows that it does not&nbsp;detect the signature for Beacon’s configuration.</p>



<figure class="wp-block-image size-large"><img decoding="async" src="https://www.cobaltstrike.com/app/uploads/2023/01/sleep-mask-beacon-eye-rule-2.png" alt="" class="wp-image-9295"></figure>



<p>This is just one simple example of using the sleep mask to obfuscate Beacon in memory. </p>



<p></p>



<p>Enjoy!</p>



<p></p>



<h3 class="wp-block-heading" id="references">References</h3>



<ul class="wp-block-list">
<li>BeaconEye&nbsp;<a href="https://github.com/CCob/BeaconEye" target="_blank" rel="noreferrer noopener">https://github.com/CCob/BeaconEye</a>&nbsp;</li>
</ul>

</div><!-- .entry-content -->

<!-- .entry-footer -->

</article><!-- #post-2840 -->


				</main>
			</div> <!-- #primary -->
			
<div class="col-lg-4 align-self-start resource-sidebar widget-area"><!-- #resource-sidebar -->
        <div class="sidebar-content bg-7 mb-3">
        <div class=" container">
            <div class="row">
                <div class="col-12">
                                    <div class="author-description p-3 row">
                                                <div class="author-image col-5">
                             <img width="149" height="146" src="https://www.cobaltstrike.com/app/uploads/2023/07/joe-vest-circle-outline.png" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="" decoding="async" loading="lazy">                        </div>
                                                <div class=" col-7 pl-0">
                            <h4 class="author-title text-align-left font-weight-light">
                                <a href="https://www.cobaltstrike.com/profile/joe-vest">Joe Vest</a>
                            </h4>
                            <div></div>
                        </div>
                        <div class="col-12 text-center mt-2">
                            <a class=" btn-link view-profile" href="https://www.cobaltstrike.com/profile/joe-vest">View Profile</a>
                        </div>
                    </div>
                                </div>  <!-- #column -->
            </div> <!-- #row -->
        </div> <!-- #container -->
    </div>  <!-- #sidebar-content -->
            <div class="sidebar-content bg-7 mb-3">
        <div class=" container">
            <div class="row">
                <div class="col-12">
                                                                <div class="sidebar-content p-3">
                            <div class="block-title text-uppercase">
                            TOPICS
                            </div>
                            <ul class="list-group list-group-flush pt-2">
                            <li class="list-unstyled"><a href="https://www.cobaltstrike.com/blog?_sft_cornerstone=releases" title="Releases">Releases</a></li>                            </ul>
                        </div>
                                    </div>  <!-- #column -->
            </div> <!-- #row -->
        </div> <!-- #container -->
    </div>  <!-- #sidebar-content -->
    </div><!-- #resource-sidebar -->
		</div><!-- .row -->
	</div><!-- #container -->
</div><!-- #page-wrapper -->



</div>



<div class="wpc-filters-overlay"></div>




<div height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" data-original-tag="iframe"></div>
<div class="ta-display-none" name="trustarc_notice" id="trustarcNoticeFrame" title="Trustarc Cross-Domain Consent Frame" src="https://consent.trustarc.com/get?name=crossdomain.html&amp;domain=helpsystems.com" data-original-tag="iframe"></div></body></html>