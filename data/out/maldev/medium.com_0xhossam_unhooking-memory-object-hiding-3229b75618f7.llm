Title:
Unhooking & Memory Object Hiding (AV/EDR Evasion | Malware Development P — 3)

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains how EDRs commonly hook user-mode Windows APIs (primarily in `ntdll.dll`) to monitor suspicious behavior, and how attackers “unhook” to restore clean syscall stubs and evade telemetry.  
- It walks through identifying hooks in a debugger (e.g., `NtAdjustPrivilegesToken` showing a JMP trampoline) and then details multiple unhooking approaches.  
- Techniques include copying a clean `.text` section from a fresh on-disk mapped `ntdll.dll`, and syscall-number recovery approaches (Hell’s Gate / Halo’s Gate) that locate unhooked syscall stubs by pattern-matching instruction sequences and resolving syscall IDs dynamically.  
- It also covers “Perun’s Fart,” which avoids reading `ntdll` from disk by creating a suspended process, reading its in-memory clean `ntdll`, and copying the syscall region back into the current process.  
- The article references public implementations (e.g., TartarusGate/HellsGate, HalosGate) and provides C code snippets for mapping, parsing PE headers, changing memory protections, and patching.  
- Useful for red teamers and malware developers building user-mode evasion and direct/indirect syscall execution chains; also relevant to blue teamers for understanding common unhooking tradecraft and detection points.

Technical Focus:
- User-mode API hooking in `ntdll.dll` and trampoline/JMP detection
- PE parsing and section replacement (`.text`) for unhooking
- Direct/indirect syscalls and syscall number resolution (Hell’s Gate / Halo’s Gate)
- Suspended-process “clean module” harvesting + `ReadProcessMemory` (Perun’s Fart)
- Memory protection changes and patching (`VirtualProtect`, RWX transitions)
- EAT parsing, function hashing (djb2), and stub pattern matching

Use Cases:
- Restoring clean `ntdll` syscall stubs before executing sensitive actions (alloc/protect/thread creation)
- Building loaders that evade user-mode EDR hooks via direct syscalls
- Implementing “no-disk-read” unhooking by cloning `ntdll` from a suspended sacrificial process
- Defensive research: creating detections for `.text` patching, syscall-stub scanning, and suspicious `VirtualProtect` + `memcpy` patterns

Keywords:
ntdll.dll, EDR hooking, user-mode hooks, unhooking, syscall stubs, direct syscalls, indirect syscalls, Hell’s Gate, Halo’s Gate, TartarusGate, Perun’s Fart, PE headers, .text section, Export Address Table, djb2 hash, VirtualProtect, CreateFileMapping, MapViewOfFile, ReadProcessMemory, CREATE_SUSPENDED