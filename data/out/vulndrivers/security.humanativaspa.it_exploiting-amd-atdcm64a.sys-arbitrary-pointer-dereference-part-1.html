# https://security.humanativaspa.it/exploiting-amd-atdcm64a.sys-arbitrary-pointer-dereference-part-1/

<!DOCTYPE html><html class="no-touch webkit chrome chrome142 linux js no-hidpi datauri lenis screen-lg screen-md screen-sm screen-xs screen-xxs orientation_portrait" lang="en-US" xmlns="http://www.w3.org/1999/xhtml">
<body class="wp-singular post-template-default single single-post postid-4077 single-format-standard wp-theme-uncode wp-child-theme-uncode-child style-color-wayh-bg cookies-not-set group-blog hormenu-position-left megamenu-full-submenu hmenu hmenu-position-center header-full-width main-center-align menu-mobile-transparent menu-custom-padding menu-sticky-mobile menu-mobile-centered menu-mobile-off-canvas mobile-parallax-not-allowed ilb-no-bounce unreg qw-body-scroll-disabled megamenu-side-to-side no-qty-fx uncode-accessible wpb-js-composer js-comp-ver-8.7.1.2 vc_responsive uncode-loaded" data-border="0" style="margin-top: 0px; padding-top: 0px;">

		<a href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a.sys-arbitrary-pointer-dereference-part-1/#sections-container" class="screen-reader-shortcut btn btn-hover-nobg btn-accent btn-shadow btn-shadow-lg">Skip to main content</a>
			<div id="vh_layout_help"></div><div class="body-borders" data-border="0"><div class="top-border body-border-shadow"></div><div class="right-border body-border-shadow"></div><div class="bottom-border body-border-shadow"></div><div class="left-border body-border-shadow"></div><div class="top-border style-color-xsdn-bg"></div><div class="right-border style-color-xsdn-bg"></div><div class="bottom-border style-color-xsdn-bg"></div><div class="left-border style-color-xsdn-bg"></div></div>	<div class="box-wrapper">
		<div class="box-container" style="width: 1920px; margin-left: 0px;">
		
		<div class="menu-wrapper menu-sticky-mobile menu-no-arrows no-header" style="height: 957px;">
													
													
												</div>			
						<div class="main-wrapper">
				<div class="main-container">
					<div class="page-wrapper" role="main">
						<div class="sections-container" id="sections-container">
<article id="post-4077" class="page-body style-color-xsdn-bg post-4077 post type-post status-publish format-standard has-post-thumbnail hentry category-exploits category-vulnerabilities tag-windows tag-tutorial tag-red-teaming tag-atdcm64a tag-exploit-development tag-exploit tag-ida tag-vulnerability-research tag-reverse-engineering tag-static-analysis">
          <div class="post-wrapper">
          	<div class="post-body"><div class="post-content un-no-sidebar-layout"><div data-parent="true" class="vc_row has-bg need-focus style-color-wayh-bg row-container" id="row-unique-0"><div class="row-background background-element">
											<div class="background-wrapper">
												<div class="background-inner srcset-bg srcset-bg-async srcset-bg-init" style="background-repeat: no-repeat; background-position: center top; background-attachment: scroll; background-size: cover; background-image: url(&quot;https://hnsecurity.it/wp-content/uploads/2025/07/195503.jpg&quot;);" data-background-image="https://hnsecurity.it/wp-content/uploads/2025/07/195503.jpg" data-mobile-background-image="https://hnsecurity.it/wp-content/uploads/2025/07/195503-uai-900x507.jpg"></div>
												
											</div>
										</div><div class="row double-top-padding double-bottom-padding single-h-padding limit-width row-parent" data-imgready="true"><div class="wpb_row row-inner"><div class="wpb_column pos-middle pos-center align_center column_parent col-lg-12 single-internal-gutter"><div class="uncol style-light"><div class="uncoltable"><div class="uncell no-block-padding"><div class="uncont"><div class="uncode-single-media  text-center animate_when_almost_visible zoom-in"><div class="single-wrapper" style="max-width: 200px;"><div class="tmb tmb-light  img-circle tmb-bordered tmb-shadowed tmb-shadowed-darker-std tmb-img-ratio tmb-media-first tmb-media-last tmb-content-overlay tmb-no-bg"><div class="t-inside"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="uncode-single-media-wrapper img-circle img-thumbnail"><div class="dummy" style="padding-top: 100%;"></div><img decoding="async" class="srcset-auto wp-image-159895 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/AMD-uai-836x836.jpg" width="836" height="836" alt="" data-no-bp="" data-bp="720" data-uniqueid="159895-153448" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/AMD.jpg" data-path="2025/09/AMD.jpg" data-width="1600" data-height="836" data-singlew="200" data-singleh="200" data-crop="1" loading="lazy"></div>
					</div>
				</div></div></div></div></div><div class="vc_custom_heading_wrap "><div class="heading-text el-text"><h1 class="h2 text-color-lxmt-color"><span>Exploiting AMD atdcm64a.sys arbitrary pointer dereference – Part 1</span></h1></div><div class="clear"></div></div></div></div></div></div></div></div></div></div><div data-parent="true" class="vc_row row-container" id="row-unique-1"><div class="row limit-width row-parent" data-imgready="true"><div class="wpb_row row-inner"><div class="wpb_column pos-top pos-center align_left column_parent col-lg-6 single-internal-gutter"><div class="uncol style-light"><div class="uncoltable"><div class="uncell no-block-padding"><div class="uncont"><div class="uncode-info-box  font-weight-500"><span class="date-info">September 25, 2024</span><span class="uncode-ib-separator uncode-ib-separator-symbol">|</span><span class="author-wrap"><a href="https://hnsecurity.it/blog/author/ale98/"><span class="uncode-ib-avatar uncode-ib-avatar-size-md"><img alt="Alessandro Iandoli" src="https://secure.gravatar.com/avatar/644822f5d8329ca419a50c1f39c97de5ccd163d1932e4cdc60a6cc8cb64ed29e?s=40&amp;d=mm&amp;r=g" class="avatar avatar-40 photo" height="40" width="40" loading="lazy" decoding="async"></span></a><span class="author-info">By <a href="https://hnsecurity.it/blog/author/ale98/">Alessandro Iandoli</a></span></span></div></div></div></div></div></div><div class="wpb_column pos-top pos-center align_right align_left_tablet align_left_mobile column_parent col-lg-6 single-internal-gutter"><div class="uncol style-light"><div class="uncoltable"><div class="uncell no-block-padding"><div class="uncont"><div class="uncode-info-box container-text font-weight-500"><span class="category-info"> <a href="https://hnsecurity.it/blog/category/exploits/" title="View all posts in Exploits" class="">Exploits</a>, <a href="https://hnsecurity.it/blog/category/vulnerabilities/" title="View all posts in Vulnerabilities" class="">Vulnerabilities</a></span></div></div></div></div></div></div></div></div></div><div data-parent="true" class="vc_row has-bg need-focus style-color-xsdn-bg row-container" id="row-unique-2"><div class="row no-top-padding double-bottom-padding single-h-padding limit-width row-parent" data-imgready="true"><div class="wpb_row row-inner"><div class="wpb_column pos-top pos-center align_left column_parent col-lg-12 custom-tag-box single-internal-gutter"><div class="uncol style-light"><div class="uncoltable"><div class="uncell  vc_custom_1758437089857 no-block-padding" style="padding-top: 0px ;"><div class="uncont"><div class="uncode_text_column container-text"><div>
<div>
<p>After attending the <a href="https://apps.p.ost2.fyi/learning/course/course-v1:OpenSecurityTraining2+Exp4011_Windows_Kernel_UAF_KTM+2023_v1/home">OST2 – Exp4011</a> course, taught by <a href="https://x.com/saidelike">Cedric Halbronn</a> (a <strong>free course</strong> that I <strong>really recommend to follow</strong> to anyone interested in the topic), I decided to start doing vulnerability research on <strong>third-party Windows drivers</strong>. I already had a bit of academic experience in <strong>kernel exploit development</strong> by crafting some exploits (<a href="https://github.com/MrAle98/HEVD-StackOverflow-x64-SMEPBypass">stack overflow</a>, <a href="https://github.com/MrAle98/HEVD-ArbitraryWrite-Win10-x64">arbitrary write</a>, <a href="https://github.com/MrAle98/HEVD-sessionPoolOverflow-win10-x64">session pool overflow</a>) for the driver <a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver">HackSysExtremeVulnerableDriver</a>, so I decided to move on to real kernel drivers.</p>
<p>In this <a href="https://hnsecurity.it/tag/atdcm64a/">series</a> of blog posts I’ll describe how I found <strong>two vulnerabilities</strong> in a <strong>Windows kernel driver</strong> part of an <strong>old AMD software package</strong> and how I exploited them in order to achieve <strong>local privilege escalation</strong>. Probably, this article won’t be very useful for experienced exploit developers/vulnerability researchers, but I think it will be useful for <strong>red teamers</strong> that are <strong>looking for vulnerable drivers</strong> that are not blacklisted, in order to <strong>disable/bypass EDRs</strong>. In addition, I’ll focus on how to use<strong> IDA Pro</strong>&nbsp;to <strong>reverse and then debug drivers</strong> with the assistance of the pseudocode.</p>
</div>
<p>The series is divided in three parts as follows:</p>
<ul class="postList">
<li class="graf graf--li"><strong>Discovering the vulnerabilities</strong>&nbsp;(<a href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-1/">Part 1</a>) – This article</li>
<li class="graf graf--li"><strong>Confirming the vulnerabilities</strong>&nbsp;(<a href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-2/">Part 2</a>)</li>
<li class="graf graf--li"><strong>Exploitation</strong>&nbsp;(<a href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-3/">Part 3</a>)</li>
</ul>
</div>
<div>
<div>
<p>I assume the reader already has <strong>basic knowledge about Windows kernel driver development/exploitation</strong>. If that’s not the case, I suggest reading the following articles in order to gain a basic understanding of the <strong>interaction between user-mode processes and kernel-mode drivers</strong> and of protection mechanisms such as <strong>SMEP</strong>:</p>
</div>
<ul>
<li><a href="https://connormcgarr.github.io/Kernel-Exploitation-1/">https://connormcgarr.github.io/Kernel-Exploitation-1/</a></li>
<li><a href="https://connormcgarr.github.io/Kernel-Exploitation-2/">https://connormcgarr.github.io/Kernel-Exploitation-2/</a></li>
<li><a href="https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/">https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/</a></li>
<li><a href="https://voidsec.com/windows-drivers-reverse-engineering-methodology/">https://voidsec.com/windows-drivers-reverse-engineering-methodology/</a></li>
</ul>
<p>I also recommend following the <a href="https://apps.p.ost2.fyi/learning/course/course-v1:OpenSecurityTraining2+Dbg3011_WinDbg3+2023_v1/home">OST2 – Dbg3011</a> course, again taught by Cedric Halbronn, in order to become familiar with <strong>WinDbg</strong>.</p>
</div>
<div></div>
<div>
<h2>Disclosure</h2>
</div>
<p>The vulnerabilities were reported directly to the <a href="https://www.amd.com/en/resources/product-security.html">AMD product security team</a> on July 26th, 2024.</p>
<p>The AMD product security team replied the same day declaring that as the vulnerabilities affect an old software package that’s no longer maintained, <strong>they won’t be issuing a CVE ID or a security notice</strong>.</p>
<h2>Setting up the environment</h2>
<p>If you want to follow along I suggest you to create a <strong>Windows 11 VM</strong>.&nbsp; Specifically, I’m going to use the following build.</p>
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-monokai enlighter-l-raw enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">PS &gt; systeminfo</span></div></div><div class=""><div><span class="enlighter-text">Host Name:                 WINDOWS11</span></div></div><div class="enlighter-special"><div><span class="enlighter-text">OS Name:                   Microsoft Windows 11 Pro</span></div></div><div class="enlighter-special"><div><span class="enlighter-text">OS Version:                10.0.22631 N/A Build 22631</span></div></div><div class=""><div><span class="enlighter-text">OS Manufacturer:           Microsoft Corporation</span></div></div><div class=""><div><span class="enlighter-text">[...]</span></div></div></div><div class="enlighter-raw">PS &gt; systeminfo
Host Name:                 WINDOWS11
OS Name:                   Microsoft Windows 11 Pro
OS Version:                10.0.22631 N/A Build 22631
OS Manufacturer:           Microsoft Corporation
[...]</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="raw" data-enlighter-theme="monokai" data-enlighter-highlight="3,4">PS &gt; systeminfo
Host Name: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WINDOWS11
OS Name: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Microsoft Windows 11 Pro
OS Version: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10.0.22631 N/A Build 22631
OS Manufacturer: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Microsoft Corporation
[...]</pre>
</div>
<div>
<div>
<p>In addition, I provide here the <strong>hash of the ntoskrnl.exe</strong> file I have on my own Windows 11 VM.</p>
</div>
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-monokai enlighter-l-raw enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">PS &gt; get-filehash C:\Windows\System32\ntoskrnl.exe | select -expandProperty Hash </span></div></div><div class=""><div><span class="enlighter-text">0CE15480462E9CD3F7CBF2D44D2E393CF5674EE1D69A3459ADFA0E913A7A2AEB </span></div></div><div class=""><div><span class="enlighter-text">PS &gt;</span></div></div></div><div class="enlighter-raw">PS &gt; get-filehash C:\Windows\System32\ntoskrnl.exe | select -expandProperty Hash 
0CE15480462E9CD3F7CBF2D44D2E393CF5674EE1D69A3459ADFA0E913A7A2AEB 
PS &gt;</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="raw" data-enlighter-theme="monokai">PS &gt; get-filehash C:\Windows\System32\ntoskrnl.exe | select -expandProperty Hash 
0CE15480462E9CD3F7CBF2D44D2E393CF5674EE1D69A3459ADFA0E913A7A2AEB 
PS &gt;</pre>
<p>In the Windows 11 VM, setup <strong>network kernel debugging as follows</strong> (run all commands as administrator).</p>
</div>
</div>
<div>
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-monokai enlighter-l-raw enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">&gt; bcdedit /debug on</span></div></div><div class=""><div><span class="enlighter-text">&gt; bcdedit /dbgsettings net hostip:&lt;ip of your host machine&gt; port:&lt;port for example 50099&gt;</span></div></div></div><div class="enlighter-raw">&gt; bcdedit /debug on
&gt; bcdedit /dbgsettings net hostip:&lt;ip of your host machine&gt; port:&lt;port for example 50099&gt;</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="raw" data-enlighter-theme="monokai">&gt; bcdedit /debug on
&gt; bcdedit /dbgsettings net hostip:&lt;ip of your host machine&gt; port:&lt;port for example 50099&gt;</pre>
<p>Take note of the <strong>key</strong> that the last command outputs. You can always get it back running the following command (again, as administrator).</p>
</div>
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-monokai enlighter-l-raw enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">&gt; bcdedit /dbgsettings</span></div></div><div class=""><div><span class="enlighter-text">key                     1dins0yu1y3cp.k42pkhb9dnua.1evtrhpv56ygd.349y5ok12c1ul</span></div></div><div class=""><div><span class="enlighter-text">debugtype               NET</span></div></div><div class=""><div><span class="enlighter-text">hostip                  192.168.157.1</span></div></div><div class=""><div><span class="enlighter-text">port                    50001</span></div></div><div class=""><div><span class="enlighter-text">dhcp                    Yes</span></div></div><div class=""><div><span class="enlighter-text">The operation completed successfully.</span></div></div><div class=""><div><span class="enlighter-text">&gt;</span></div></div></div><div class="enlighter-raw">&gt; bcdedit /dbgsettings
key                     1dins0yu1y3cp.k42pkhb9dnua.1evtrhpv56ygd.349y5ok12c1ul
debugtype               NET
hostip                  192.168.157.1
port                    50001
dhcp                    Yes
The operation completed successfully.
&gt;</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="raw" data-enlighter-theme="monokai">&gt; bcdedit /dbgsettings
key &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1dins0yu1y3cp.k42pkhb9dnua.1evtrhpv56ygd.349y5ok12c1ul
debugtype &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NET
hostip &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;192.168.157.1
port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;50001
dhcp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Yes
The operation completed successfully.
&gt;</pre>
<p>Restart the VM so that changes will take effect.</p>
</div>
</div>
<div>
<h2>Analyzing the driver</h2>
</div>
<div>
<h3>Reversing the driver</h3>
</div>
<div>
<div>
<p>The vulnerable driver can be obtained following these steps:</p>
<ul>
<li>Download this <a href="https://drivers.amd.com/drivers/beta/win10-64bit-radeon-software-adrenalin-edition-18.12.1.1-dec5.exe">software package</a></li>
<li>Open the .exe with <strong>7zip</strong> and extract it. The driver is located at <strong>Packages\Drivers\Display\WT6A_INF\B336522\atdcm64a.sys</strong></li>
<li>Copy the driver both on your host machine (where you have IDA Pro or any other reversing framework) and on your VM</li>
</ul>
</div>
<div>
<p>If you are not able to download from the direct link, follow these steps:</p>
<ul>
<li>Navigate to this <a href="https://www.amd.com/en/support/downloads/previous-drivers.html/graphics/radeon-600-500-400/radeon-rx-500-series/radeon-rx-580.html">link</a></li>
<li>Expand the “Windows 10 – 64-bit Edition” tab</li>
<li>Download the package <strong>Adrenalin Edition 18.12.1.1 Optional</strong> (Release date: 2018-12-05)</li>
</ul>
<figure id="attachment_4205" aria-describedby="caption-attachment-4205" style="width: 1403px" class="wp-caption aligncenter"><img fetchpriority="high" decoding="async" class="wp-image-4205 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/09/2024-09-20-13_47_32-Clipboard-1.png" alt="" width="1403" height="656"><figcaption id="caption-attachment-4205" class="wp-caption-text">Driver download page</figcaption></figure>
<p>You can use <a href="https://www.osronline.com/article.cfm%5Earticle=157.htm">OSRLoader</a> to load the driver in the VM following the instructions&nbsp;<a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/loading-a-windows-kernel-driver-osr-driver-loader-debugging-with-source-code">here</a> (just look at the animated GIF and ignore the other steps).</p>
</div>
</div>
<div>
<div>
<p><em>Once the driver is loaded successfully in the VM, I suggest to create a <strong>snapshot of the VM</strong>. Usually the VM crashes many times especially during the exploit development phase. Having <strong>a snapshot allows to restart quickly</strong> from the point we want.</em></p>
</div>
<div>Now it is time to load the driver in <strong>IDA Pro</strong>. Once loaded, you are presented with the following interface:</div>
</div>
<div></div>
<div>
<figure id="attachment_3845" aria-describedby="caption-attachment-3845" style="width: 1915px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3845 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-53-1.png" alt="" width="1915" height="831"><figcaption id="caption-attachment-3845" class="wp-caption-text">Initial view in IDA Pro</figcaption></figure>
</div>
<div>
<div>
<p>IDA Pro already shows the entry point: the DriverEntry routine.</p>
<p>First thing I like to do is<strong> synchronize the decompiled View with the IDA View</strong>. Spawn the decompiled view with </p><div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">F5</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">F5</code>, &nbsp;right-click on the <strong>IDA View</strong> window and select <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Synchronize With -</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> Pseudocode - A</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Synchronize With -&gt; Pseudocode - A</code>.<p></p>
</div>
<div>
<figure id="attachment_3787" aria-describedby="caption-attachment-3787" style="width: 1574px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3787 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-1-1.png" alt="" width="1574" height="729"><figcaption id="caption-attachment-3787" class="wp-caption-text">Synchronizing views in IDA Pro</figcaption></figure>
<div>
<div></div>
<div>From now on it will keep<strong> both cursors on the two windows synchronized</strong>. If you scroll one window, IDA Pro automatically scrolls on the other one as well.</div>
<div>
<p>If you want you can also further <strong>synchronize</strong> the <strong>Hex View with IDA View and Pseudocode</strong> windows using the same procedure. Right-click on the <strong>Hex View</strong> window and then select </p><div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Synchronize With -</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> IDA VIEW A - Pseudocode - A</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Synchronize With -&gt; IDA VIEW A - Pseudocode - A</code>.<p></p>
<figure id="attachment_3788" aria-describedby="caption-attachment-3788" style="width: 1755px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3788 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-2-1.png" alt="" width="1755" height="821"><figcaption id="caption-attachment-3788" class="wp-caption-text">Synchronizing Hex View with IDA View and Pseudocode</figcaption></figure>
</div>
</div>
<div>
<div>
<p>The next steps here are:</p>
<ol>
<li>Identifying the <strong>symbolic link to the driver</strong> (so that we know <strong>how to get a handle</strong> to the driver <strong>from user-mode</strong>).</li>
<li>Identifying <strong>driver dispatch routines handling IRPs</strong>.</li>
</ol>
<p><em>In this case we will focus only on the <strong>IRP_MJ_DEVICE_CONTROL</strong> major function code but typically he <strong>IRP_MJ_READ IRP_MJ_WRITE and IRP_MJ_CREATE</strong> major function codes are also of interest.</em></p>
<div>
<div>Usually, the <strong>symbolic link is created in the DriverEntry routine</strong>. Quickly inspecting the DriverEntry routine it in IDA Pro reveals the name <strong>AtiDCM</strong>:</div>
</div>
<figure id="attachment_3790" aria-describedby="caption-attachment-3790" style="width: 824px" class="wp-caption aligncenter"><img decoding="async" class="size-full wp-image-3790" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-4-1.png" alt="" width="824" height="340"><figcaption id="caption-attachment-3790" class="wp-caption-text">Symbolic link with name AtiDCM</figcaption></figure>
</div>
<div>
<div></div>
<div>Right after the creation of the symbolic link, we may notice the driver sets some dispatch routines in the <strong>MajorFunction array</strong> of the <strong>DriverObject</strong> struct:</div>
</div>
</div>
<div>
<figure id="attachment_3791" aria-describedby="caption-attachment-3791" style="width: 759px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3791 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-5-1.png" alt="" width="759" height="391"><figcaption id="caption-attachment-3791" class="wp-caption-text">Definition of Dispatch routines in DriverObject</figcaption></figure>
</div>
<div>
<div>
<p>At this point I suggest to <strong>rename the indexes</strong> in the array with the corresponding <strong>IRP_MJ_XXX code</strong>. To do this you can:</p>
<ol>
<li>Click on the number and press <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">m</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">m</code>.</li>
<li>Select Yes in the popup.</li>
<li>Then <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Ctrl-F</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Ctrl-F</code> and type <strong>IRP_MJ</strong> in the search bar.</li>
<li>Select the appropriate entry and press ok.</li>
</ol>
</div>
<figure id="attachment_3792" aria-describedby="caption-attachment-3792" style="width: 439px" class="wp-caption alignleft"><img decoding="async" class="wp-image-3792" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-6-1.png" alt="" width="439" height="171"><figcaption id="caption-attachment-3792" class="wp-caption-text">Renaming index – Step 1-2</figcaption></figure>
<figure id="attachment_3793" aria-describedby="caption-attachment-3793" style="width: 427px" class="wp-caption alignright"><img decoding="async" class="wp-image-3793" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-7-1.png" alt="" width="427" height="156"><figcaption id="caption-attachment-3793" class="wp-caption-text">Renaming index – Step 3-4</figcaption></figure>
<figure id="attachment_3794" aria-describedby="caption-attachment-3794" style="width: 690px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3794" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-8-1.png" alt="" width="690" height="216"><figcaption id="caption-attachment-3794" class="wp-caption-text">Renaming index – result</figcaption></figure>
<div>In addition to renaming all the indexes I like to rename the function names. You can do it by:</div>
<div>
<ol>
<li>Clicking on the <strong>sub_XXXX</strong> you want to rename.</li>
<li>Press <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">n</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">n</code>.</li>
<li>Change the name and press <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Enter</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Enter</code>.</li>
</ol>
</div>
<div>
<figure id="attachment_3796" aria-describedby="caption-attachment-3796" style="width: 946px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3796 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-10-1.png" alt="" width="946" height="281"><figcaption id="caption-attachment-3796" class="wp-caption-text">Renaming the function to IrpDeviceIoControlHandler()</figcaption></figure>
</div>
</div>
<div>
<div>
<p>After that I suggest to <strong>change the function signature </strong>to the appropriate one. Based on <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_dispatch">MSDN</a>,&nbsp; the signature is the following:</p>
</div>
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-monokai enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">NTSTATUS </span><span class="enlighter-m0">DriverDispatch</span><span class="enlighter-g1">(</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">[</span><span class="enlighter-text">in, out</span><span class="enlighter-g1">]</span><span class="enlighter-text"> _DEVICE_OBJECT *DeviceObject,</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">[</span><span class="enlighter-text">in, out</span><span class="enlighter-g1">]</span><span class="enlighter-text"> _IRP *Irp</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">)</span></div></div></div><div class="enlighter-raw">NTSTATUS DriverDispatch(
  [in, out] _DEVICE_OBJECT *DeviceObject,
  [in, out] _IRP *Irp
)</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c" data-enlighter-theme="monokai">NTSTATUS DriverDispatch(
&nbsp; [in, out] _DEVICE_OBJECT *DeviceObject,
&nbsp; [in, out] _IRP *Irp
)</pre>
</div>
<div>
<p>To change the function signature:</p>
<ol>
<li>Click on the target function name.</li>
<li>Press <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">y</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">y</code>.</li>
<li>Insert the appropriate function signature.</li>
</ol>
</div>
<p><em>It is advisable to keep the same calling convention you find in the original definition. In this case it is __fastcall.</em></p>
<figure id="attachment_3797" aria-describedby="caption-attachment-3797" style="width: 1187px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3797 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-11-1.png" alt="" width="1187" height="204"><figcaption id="caption-attachment-3797" class="wp-caption-text">Redefining the function signature</figcaption></figure>
</div>
<div>
<div></div>
<div>Now we can move to our <strong>IrpDeviceIoControlHandler</strong> routine:</div>
<div>
<figure id="attachment_3798" aria-describedby="caption-attachment-3798" style="width: 916px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3798 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-12-1.png" alt="" width="916" height="188"><figcaption id="caption-attachment-3798" class="wp-caption-text">Pseudocode of IrpDeviceIoControlHandler()</figcaption></figure>
</div>
</div>
<div>
<div>If we inspect the first function we notice it actually returns a <strong>pointer in a global variable</strong> that points to a memory allocation obtained by calling <em>ExAllocatePoolWithTag()</em>:</div>
<div>
<figure id="attachment_3799" aria-describedby="caption-attachment-3799" style="width: 679px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3799 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-13-1.png" alt="" width="679" height="576"><figcaption id="caption-attachment-3799" class="wp-caption-text">Pseudocode of sub_1400033e8()</figcaption></figure>
</div>
<div>When the driver returns from the first function, it passes the returned pointer to the next function along with the whole IRP. If we give a quick look at the <strong>second function</strong> we may notice It is a big function that <strong>handles the different IOCTLs</strong>.</div>
<div></div>
<div>I suggest to rename both functions and change their function signature:</div>
<div>
<figure id="attachment_3801" aria-describedby="caption-attachment-3801" style="width: 913px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3801 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-15-1.png" alt="" width="913" height="181"><figcaption id="caption-attachment-3801" class="wp-caption-text">Reversed IrpDeviceIoControlHandler()</figcaption></figure>
</div>
<div>Now let’s start inspecting <em>InnerIrpDeviceIoCtlHandler()</em>:</div>
<div>
<figure id="attachment_3802" aria-describedby="caption-attachment-3802" style="width: 848px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3802 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-16-1.png" alt="" width="848" height="588"><figcaption id="caption-attachment-3802" class="wp-caption-text">Initial pseudocode of InnerIrpDeviceIoCtlHandler()</figcaption></figure>
</div>
<div>
<p>We can see it references multiple fields inside the IRP. If we give a look at the definition of the <a href="https://www.vergiliusproject.com/kernels/x64/windows-11/22h2/_IRP">IRP</a> and <a href="https://www.vergiliusproject.com/kernels/x64/windows-11/22h2/_IO_STACK_LOCATION">_IO_STACK_LOCATION</a>&nbsp; we can see the fields <em>CurrentStackLocation-&gt;Parameters</em> and <em>Irp-&gt;AssociatedIrp</em> are actually <strong>unions</strong>.</p>
</div>
<div>
<p>Taking the <em>CurrentStackLocation-&gt;Parameters</em> we can see that it’s a union that <strong>changes based on the IRP Major Function Code</strong> handled. As the current function handles a <strong>IRP_MJ_DEVICE_CONTROL</strong> function code, we should use <em>CurrentStackLocation-&gt;Parameters.DeviceIoControl</em> in IDA Pro.</p>
</div>
<div>
<p>To instruct IDA Pro to do so, you must:</p>
<ol>
<li>Click on the union field (<em>CurrentStackLication-&gt;Parameters</em>) press <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Alt + y</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Alt + y</code>.</li>
<li><div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">Ctrl + f</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">Ctrl + f</code> for searching for DeviceIoControl and then select the proper one (<em>Parameters.DeviceIoControl.IoControlCode </em>in this case).</li>
</ol>
</div>
</div>
<figure id="attachment_3805" aria-describedby="caption-attachment-3805" style="width: 498px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3805" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-19-1.png" alt="" width="498" height="385"><figcaption id="caption-attachment-3805" class="wp-caption-text">Searching the proper union field</figcaption></figure>
<div>
<div>Now we know the function accesses the <em>IoControlCode</em> variable, provided as input from user mode, and based on that it handles the IRP differently. Let’s inspect the following piece of decompiled code:</div>
</div>
<div>
<figure id="attachment_3807" aria-describedby="caption-attachment-3807" style="width: 848px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3807 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-21-1.png" alt="" width="848" height="512"><figcaption id="caption-attachment-3807" class="wp-caption-text">InnerIrpDeviceIoCtlHandler() before reversing</figcaption></figure>
</div>
<div>
<div>Notice it references <em>IoControlCode variable </em>and subtract 0x22e084. If the result is zero, it calls a function (passing as input <em>Irp-&gt;AssociatedIrp.MasterIrp</em>). This means that <em>0x22e084</em> is a valid IOCTL. If we decode it, for example with <a href="https://www.osronline.com/article.cfm%5Earticle=229.htm">OSR Online IOCTL Decoder</a> we notice the info <strong>METHOD_BUFFERED</strong>:</div>
<div>
<figure id="attachment_3804" aria-describedby="caption-attachment-3804" style="width: 526px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3804 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-18-1.png" alt="" width="526" height="459"><figcaption id="caption-attachment-3804" class="wp-caption-text">IOCTL decoded</figcaption></figure>
</div>
<div>Recalling <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/buffer-descriptions-for-i-o-control-codes">MSDN</a>, when using <strong>METHOD_BUFFERED</strong><em>,</em> the input and output buffer, passed from user mode, are represented by <em>Irp-&gt;AssociatedIrp.SystemBuffer</em>. At this point we are sure we can change the union <em>Irp-&gt;AssociatedIrp.MasterIrp</em> to be actually <em>Irp-&gt;AssociatedIrp.SystemBuffer</em>.</div>
<div></div>
<div>
<figure id="attachment_3808" aria-describedby="caption-attachment-3808" style="width: 870px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3808 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-22-1.png" alt="" width="870" height="540"><figcaption id="caption-attachment-3808" class="wp-caption-text">InnerIrpDeviceIoCtlHandler() after reversing</figcaption></figure>
</div>
</div>
<div>
<div>
<p>At this point we are interested in reversing and analyzing the code that handles our s<em>ystemBuffer</em> variable and see if there are any vulnerabilities.</p>
</div>
</div>
<h3>Identifying an arbitrary MSR read</h3>
<div>
<div>Inside our <em>InnerIrpDeviceIoCtlHandler()</em> we notice a <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">rdmsr</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">rdmsr</code> instruction (<em>__readmsr()</em> in the decompiled code).</div>
<div></div>
<div>
<figure id="attachment_3809" aria-describedby="caption-attachment-3809" style="width: 641px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3809 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-23-1.png" alt="" width="641" height="203"><figcaption id="caption-attachment-3809" class="wp-caption-text">Arbitrary MSR read</figcaption></figure>
</div>
<div>
<p>As we can see from the snippet of code above, the routine takes the <strong>input</strong> for the <em>__readmsr</em> instruction from the <em><strong>systemBuffer</strong></em> (that we control) and returns the <strong>output</strong> again in <em><strong>systemBuffer</strong></em>. This grants us the ability to <strong>read arbitrary MSRs!</strong></p>
</div>
</div>
<div>
<h3>Identifying an arbitrary pointer dereference</h3>
<div>After additional reversing of <em>InnerIrpIoCtlHandler()</em> and the functions called by <em>InnerIrpIoCtlHandler()</em> itself, we can see a call to <strong><em>callDriver()</em></strong> (a reversed function) passing as input multiple fields from <strong>s</strong><em><strong>ystemBuffer</strong></em>.</div>
<div></div>
<div>
<figure id="attachment_3811" aria-describedby="caption-attachment-3811" style="width: 608px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3811 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-25-1.png" alt="" width="608" height="666"><figcaption id="caption-attachment-3811" class="wp-caption-text">Call to callDriver()</figcaption></figure>
</div>
<div>Here’s the pseudocode of <strong><em>callDriver() </em></strong>after reversing:</div>
<div></div>
<div>
<figure id="attachment_3812" aria-describedby="caption-attachment-3812" style="width: 1046px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3812 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-26-1.png" alt="" width="1046" height="707"><figcaption id="caption-attachment-3812" class="wp-caption-text">Pseudocode of callDriver()</figcaption></figure>
</div>
<div>
<p>We can see it performs:</p>
<ol>
<li>A call to <strong><em>IoGetAttachedDeviceReference() </em></strong>passing as input the<strong> first parameter (that we fully control)</strong>.</li>
<li>A call to <strong><em>IofCallDriver()</em></strong> passing as input the <strong>output of <em>IoGetAttachedDeviceReference()</em></strong>.</li>
</ol>
</div>
<div>At this point we must reverse these two functions in order to understand what we are able to do.</div>
<div>
<p>Open another IDA Pro window and load the ntoskrnl.exe of the Windows 11 VM. After some reversing we get the shape of <em>IoGetAttachedDeviceReference()</em>:</p>
</div>
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-monokai enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">PDEVICE_OBJECT __stdcall </span><span class="enlighter-m0">IoGetAttachedDeviceReference</span><span class="enlighter-g1">(</span><span class="enlighter-text">PDEVICE_OBJECT DeviceObject</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k8">unsigned</span><span class="enlighter-text"> __int8 CurrentIrql; </span><span class="enlighter-c0">// di</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k5">char</span><span class="enlighter-text"> *v3; </span><span class="enlighter-c0">// rcx</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  _DEVICE_OBJECT *i; </span><span class="enlighter-c0">// rax</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  _DWORD *SchedulerAssist; </span><span class="enlighter-c0">// r8</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  __int64 v7; </span><span class="enlighter-c0">// r9</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k8">unsigned</span><span class="enlighter-text"> __int8 v8; </span><span class="enlighter-c0">// cl</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k2">struct</span><span class="enlighter-text"> _KPRCB *CurrentPrcb; </span><span class="enlighter-c0">// r9</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  _DWORD *v10; </span><span class="enlighter-c0">// r8</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k5">int</span><span class="enlighter-text"> v11; </span><span class="enlighter-c0">// eax</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k5">bool</span><span class="enlighter-text"> v12; </span><span class="enlighter-c0">// zf</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"> </span><span class="enlighter-g1">[</span><span class="enlighter-text">...</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class="enlighter-special"><div><span class="enlighter-text">  </span><span class="enlighter-k1">for</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> i = DeviceObject-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">AttachedDevice; i; i = i-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">AttachedDevice </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class="enlighter-special"><div><span class="enlighter-text">    DeviceObject = i;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> ObpTraceFlags </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">ObpPushStackInfo</span><span class="enlighter-g1">((</span><span class="enlighter-text">__int64</span><span class="enlighter-g1">)</span><span class="enlighter-text">&amp;DeviceObject</span><span class="enlighter-g1">[</span><span class="enlighter-text">-1</span><span class="enlighter-g1">]</span><span class="enlighter-text">.</span><span class="enlighter-m3">DeviceLock</span><span class="enlighter-text">.</span><span class="enlighter-m3">Header</span><span class="enlighter-text">.</span><span class="enlighter-m3">WaitListHead</span><span class="enlighter-text">, 1, 1u, 'tlfD'</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class="enlighter-special"><div><span class="enlighter-text">  </span><span class="enlighter-m0">ObpIncrPointerCount</span><span class="enlighter-g1">((</span><span class="enlighter-k8">volatile</span><span class="enlighter-text"> </span><span class="enlighter-k8">signed</span><span class="enlighter-text"> __int64 *</span><span class="enlighter-g1">)</span><span class="enlighter-text">&amp;DeviceObject</span><span class="enlighter-g1">[</span><span class="enlighter-text">-1</span><span class="enlighter-g1">]</span><span class="enlighter-text">.</span><span class="enlighter-m3">DeviceLock</span><span class="enlighter-text">.</span><span class="enlighter-m3">Header</span><span class="enlighter-text">.</span><span class="enlighter-m3">WaitListHead</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-m0">KxReleaseQueuedSpinLock</span><span class="enlighter-g1">((</span><span class="enlighter-k5">char</span><span class="enlighter-text"> *</span><span class="enlighter-g1">)</span><span class="enlighter-m0">KeGetPcr</span><span class="enlighter-g1">()</span><span class="enlighter-text">-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">NtTib.</span><span class="enlighter-m3">ArbitraryUserPointer</span><span class="enlighter-text"> + 160</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> KiIrqlFlags </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    v8 = </span><span class="enlighter-m0">KeGetCurrentIrql</span><span class="enlighter-g1">()</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">KiIrqlFlags &amp; 1</span><span class="enlighter-g1">)</span><span class="enlighter-text"> != 0 &amp;&amp; v8 </span><span class="enlighter-g1">&lt;</span><span class="enlighter-text">= 0xFu &amp;&amp; CurrentIrql </span><span class="enlighter-g1">&lt;</span><span class="enlighter-text">= 0xFu &amp;&amp; v8 </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">= 2u </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">      CurrentPrcb = </span><span class="enlighter-m0">KeGetCurrentPrcb</span><span class="enlighter-g1">()</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">      v10 = CurrentPrcb-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">SchedulerAssist;</span></div></div><div class=""><div><span class="enlighter-text">      v11 = ~</span><span class="enlighter-g1">(</span><span class="enlighter-k8">unsigned</span><span class="enlighter-text"> __int16</span><span class="enlighter-g1">)(</span><span class="enlighter-text">-1LL </span><span class="enlighter-g1">&lt;&lt;</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">CurrentIrql + 1</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">      v12 = </span><span class="enlighter-g1">(</span><span class="enlighter-text">v11 &amp; v10</span><span class="enlighter-g1">[</span><span class="enlighter-text">5</span><span class="enlighter-g1">])</span><span class="enlighter-text"> == 0;</span></div></div><div class=""><div><span class="enlighter-text">      v10</span><span class="enlighter-g1">[</span><span class="enlighter-text">5</span><span class="enlighter-g1">]</span><span class="enlighter-text"> &amp;= v11;</span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> v12 </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">KiRemoveSystemWorkPriorityKick</span><span class="enlighter-g1">(</span><span class="enlighter-text">CurrentPrcb</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-m0">__writecr8</span><span class="enlighter-g1">(</span><span class="enlighter-text">CurrentIrql</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class="enlighter-special"><div><span class="enlighter-text">  </span><span class="enlighter-k0">return</span><span class="enlighter-text"> DeviceObject;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">PDEVICE_OBJECT __stdcall IoGetAttachedDeviceReference(PDEVICE_OBJECT DeviceObject)
{
  unsigned __int8 CurrentIrql; // di
  char *v3; // rcx
  _DEVICE_OBJECT *i; // rax
  _DWORD *SchedulerAssist; // r8
  __int64 v7; // r9
  unsigned __int8 v8; // cl
  struct _KPRCB *CurrentPrcb; // r9
  _DWORD *v10; // r8
  int v11; // eax
  bool v12; // zf


 [...]
  for ( i = DeviceObject-&gt;AttachedDevice; i; i = i-&gt;AttachedDevice )
    DeviceObject = i;
  if ( ObpTraceFlags )
    ObpPushStackInfo((__int64)&amp;DeviceObject[-1].DeviceLock.Header.WaitListHead, 1, 1u, 'tlfD');
  ObpIncrPointerCount((volatile signed __int64 *)&amp;DeviceObject[-1].DeviceLock.Header.WaitListHead);
  KxReleaseQueuedSpinLock((char *)KeGetPcr()-&gt;NtTib.ArbitraryUserPointer + 160);
  if ( KiIrqlFlags )
  {
    v8 = KeGetCurrentIrql();
    if ( (KiIrqlFlags &amp; 1) != 0 &amp;&amp; v8 &lt;= 0xFu &amp;&amp; CurrentIrql &lt;= 0xFu &amp;&amp; v8 &gt;= 2u )
    {
      CurrentPrcb = KeGetCurrentPrcb();
      v10 = CurrentPrcb-&gt;SchedulerAssist;
      v11 = ~(unsigned __int16)(-1LL &lt;&lt; (CurrentIrql + 1));
      v12 = (v11 &amp; v10[5]) == 0;
      v10[5] &amp;= v11;
      if ( v12 )
        KiRemoveSystemWorkPriorityKick(CurrentPrcb);
    }
  }
  __writecr8(CurrentIrql);
  return DeviceObject;
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c" data-enlighter-highlight="16,17,37,20" data-enlighter-theme="monokai">PDEVICE_OBJECT __stdcall IoGetAttachedDeviceReference(PDEVICE_OBJECT DeviceObject)
{
&nbsp; unsigned __int8 CurrentIrql; // di
&nbsp; char *v3; // rcx
&nbsp; _DEVICE_OBJECT *i; // rax
&nbsp; _DWORD *SchedulerAssist; // r8
&nbsp; __int64 v7; // r9
&nbsp; unsigned __int8 v8; // cl
&nbsp; struct _KPRCB *CurrentPrcb; // r9
&nbsp; _DWORD *v10; // r8
&nbsp; int v11; // eax
&nbsp; bool v12; // zf


&nbsp;[...]
&nbsp; for ( i = DeviceObject-&gt;AttachedDevice; i; i = i-&gt;AttachedDevice )
&nbsp; &nbsp; DeviceObject = i;
&nbsp; if ( ObpTraceFlags )
&nbsp; &nbsp; ObpPushStackInfo((__int64)&amp;DeviceObject[-1].DeviceLock.Header.WaitListHead, 1, 1u, 'tlfD');
&nbsp; ObpIncrPointerCount((volatile signed __int64 *)&amp;DeviceObject[-1].DeviceLock.Header.WaitListHead);
&nbsp; KxReleaseQueuedSpinLock((char *)KeGetPcr()-&gt;NtTib.ArbitraryUserPointer + 160);
&nbsp; if ( KiIrqlFlags )
&nbsp; {
&nbsp; &nbsp; v8 = KeGetCurrentIrql();
&nbsp; &nbsp; if ( (KiIrqlFlags &amp; 1) != 0 &amp;&amp; v8 &lt;= 0xFu &amp;&amp; CurrentIrql &lt;= 0xFu &amp;&amp; v8 &gt;= 2u )
&nbsp; &nbsp; {
&nbsp; &nbsp; &nbsp; CurrentPrcb = KeGetCurrentPrcb();
&nbsp; &nbsp; &nbsp; v10 = CurrentPrcb-&gt;SchedulerAssist;
&nbsp; &nbsp; &nbsp; v11 = ~(unsigned __int16)(-1LL &lt;&lt; (CurrentIrql + 1));
&nbsp; &nbsp; &nbsp; v12 = (v11 &amp; v10[5]) == 0;
&nbsp; &nbsp; &nbsp; v10[5] &amp;= v11;
&nbsp; &nbsp; &nbsp; if ( v12 )
&nbsp; &nbsp; &nbsp; &nbsp; KiRemoveSystemWorkPriorityKick(CurrentPrcb);
&nbsp; &nbsp; }
&nbsp; }
&nbsp; __writecr8(CurrentIrql);
&nbsp; return DeviceObject;
}</pre>
<div>
<div>
<p>We can see that basically it walks the <em><strong>DeviceObject-&gt;AttachedDevice</strong></em> linked list and then <strong>returns the last element</strong> in the list. In addition, before returning we can see a call to <strong><em>ObpIncrPointerCount()</em></strong> passing as input </p><div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">DeviceObject-</span><span class="enlighter-n2">0x30</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">DeviceObject-0x30</code>. It is easier to see it in the disassembly listing (<div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">rbx</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">rbx</code>corresponds to <div class="enlighter-default enlighter-v-inline enlighter-t-enlighter enlighter-l-generic "><span class="enlighter"><span class="enlighter-text">DeviceObject</span></span></div><code class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">DeviceObject</code>):<p></p>
</div>
<div></div>
<div>
<figure id="attachment_3813" aria-describedby="caption-attachment-3813" style="width: 1700px" class="wp-caption aligncenter"><img decoding="async" class="wp-image-3813 size-full" src="https://hnsecurity.it/wp-content/uploads/2024/08/image-27-1.png" alt="" width="1700" height="257"><figcaption id="caption-attachment-3813" class="wp-caption-text">call to ObpIncrPointerCount passing DdeviceObject-0x30</figcaption></figure>
</div>
<div></div>
<div>
<p>Here’s the reversed <em>ObpIncrPointerCount()</em> function:</p>
</div>
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-monokai enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-k8">signed</span><span class="enlighter-text"> __int64 __fastcall __spoils</span><span class="enlighter-g1">&lt;</span><span class="enlighter-text">rax</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> </span><span class="enlighter-m0">ObpIncrPointerCount</span><span class="enlighter-g1">(</span><span class="enlighter-k8">volatile</span><span class="enlighter-text"> </span><span class="enlighter-k8">signed</span><span class="enlighter-text"> __int64 *a1</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k8">signed</span><span class="enlighter-text"> __int64 result; </span><span class="enlighter-c0">// rax</span><span class="enlighter-text"></span></div></div><div class="enlighter-special"><div><span class="enlighter-text">  result = </span><span class="enlighter-m0">_InterlockedIncrement64</span><span class="enlighter-g1">(</span><span class="enlighter-text">a1</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> result </span><span class="enlighter-g1">&lt;</span><span class="enlighter-text">= 1 </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">KeBugCheckEx</span><span class="enlighter-g1">(</span><span class="enlighter-text">0x18u, 0LL, </span><span class="enlighter-g1">(</span><span class="enlighter-text">ULONG_PTR</span><span class="enlighter-g1">)(</span><span class="enlighter-text">a1 + 6</span><span class="enlighter-g1">)</span><span class="enlighter-text">, 0x10uLL, result</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k0">return</span><span class="enlighter-text"> result;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">signed __int64 __fastcall __spoils&lt;rax&gt; ObpIncrPointerCount(volatile signed __int64 *a1)
{
  signed __int64 result; // rax
  result = _InterlockedIncrement64(a1);
  if ( result &lt;= 1 )
    KeBugCheckEx(0x18u, 0LL, (ULONG_PTR)(a1 + 6), 0x10uLL, result);
  return result;
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c" data-enlighter-highlight="4" data-enlighter-theme="monokai">signed __int64 __fastcall __spoils&lt;rax&gt; ObpIncrPointerCount(volatile signed __int64 *a1)
{
&nbsp; signed __int64 result; // rax
&nbsp; result = _InterlockedIncrement64(a1);
&nbsp; if ( result &lt;= 1 )
&nbsp; &nbsp; KeBugCheckEx(0x18u, 0LL, (ULONG_PTR)(a1 + 6), 0x10uLL, result);
&nbsp; return result;
}</pre>
<p>Notice the call to <strong><em>_InterlockedIncrement64()</em></strong>. This seems to grant us an <strong>arbitrary increment primitive</strong>. However, we have to consider that <em>callDriver()</em>, later on, calls <em><strong>ObfDereferenceObject()</strong></em> on the same <strong>AttachedDeviceReference</strong> variable.</p>
</div>
<div>
<p>If we reverse <em>ObfDereferenceObject()</em> we can see that the function <strong>decrements the same field that was previously incremented</strong>. This <em>compensating action</em> is going to <strong>null out our arbitrary increment</strong> making it very <strong>likely</strong> <strong>unexploitable</strong>.</p>
</div>
</div>
</div>
</div>
<div>
<div>
<div>
<p>Now let’s reverse <em>IofCallDriver()</em>:</p>
</div>
</div>
</div>
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-monokai enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">NTSTATUS __stdcall </span><span class="enlighter-m0">IofCallDriver</span><span class="enlighter-g1">(</span><span class="enlighter-text">PDEVICE_OBJECT DeviceObject, PIRP Irp</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  _IO_STACK_LOCATION *v2; </span><span class="enlighter-c0">// rax</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  __int64 MajorFunction; </span><span class="enlighter-c0">// r8</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> IopDispatchCallDriver </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> IopDispatchCallDriver == </span><span class="enlighter-n1">3</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-m0">IopPerfCallDriver</span><span class="enlighter-g1">((</span><span class="enlighter-text">PADAPTER_OBJECT</span><span class="enlighter-g1">)</span><span class="enlighter-text">DeviceObject</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">else</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-m0">IovCallDriver</span><span class="enlighter-g1">(</span><span class="enlighter-text">DeviceObject</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-k1">else</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> --Irp-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">CurrentLocation </span><span class="enlighter-g1">&lt;</span><span class="enlighter-text">= </span><span class="enlighter-n1">0</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-m0">KeBugCheckEx</span><span class="enlighter-g1">(</span><span class="enlighter-text">0x35u, </span><span class="enlighter-g1">(</span><span class="enlighter-text">ULONG_PTR</span><span class="enlighter-g1">)</span><span class="enlighter-text">Irp, 0LL, 0LL, 0LL</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    v2 = Irp-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Tail.</span><span class="enlighter-m3">Overlay</span><span class="enlighter-text">.</span><span class="enlighter-m3">CurrentStackLocation</span><span class="enlighter-text"> - </span><span class="enlighter-n1">1</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    Irp-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Tail.</span><span class="enlighter-m3">Overlay</span><span class="enlighter-text">.</span><span class="enlighter-m3">CurrentStackLocation</span><span class="enlighter-text"> = v2;</span></div></div><div class=""><div><span class="enlighter-text">    MajorFunction = v2-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">MajorFunction;</span></div></div><div class=""><div><span class="enlighter-text">    v2-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">DeviceObject = DeviceObject;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">_BYTE</span><span class="enlighter-g1">)</span><span class="enlighter-text">MajorFunction == </span><span class="enlighter-n1">22</span><span class="enlighter-text"> </span><span class="enlighter-g0">&amp;&amp;</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">unsigned __int8</span><span class="enlighter-g1">)(</span><span class="enlighter-text">v2-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">MinorFunction - </span><span class="enlighter-n1">2</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">&lt;</span><span class="enlighter-text">= 1u </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-m0">IopPoHandleIrp</span><span class="enlighter-g1">(</span><span class="enlighter-text">Irp</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">else</span><span class="enlighter-text"></span></div></div><div class="enlighter-special"><div><span class="enlighter-text">      </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-g1">((</span><span class="enlighter-m0">__int64</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">__fastcall *</span><span class="enlighter-g1">)(</span><span class="enlighter-text">PDEVICE_OBJECT</span><span class="enlighter-g1">))</span><span class="enlighter-text">DeviceObject-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">DriverObject-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">MajorFunction</span><span class="enlighter-g1">[</span><span class="enlighter-text">MajorFunction</span><span class="enlighter-g1">])(</span><span class="enlighter-text">DeviceObject</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">NTSTATUS __stdcall IofCallDriver(PDEVICE_OBJECT DeviceObject, PIRP Irp)
{
  _IO_STACK_LOCATION *v2; // rax
  __int64 MajorFunction; // r8

  if ( IopDispatchCallDriver )
  {
    if ( IopDispatchCallDriver == 3 )
      return IopPerfCallDriver((PADAPTER_OBJECT)DeviceObject);
    else
      return IovCallDriver(DeviceObject);
  }
  else
  {
    if ( --Irp-&gt;CurrentLocation &lt;= 0 )
      KeBugCheckEx(0x35u, (ULONG_PTR)Irp, 0LL, 0LL, 0LL);
    v2 = Irp-&gt;Tail.Overlay.CurrentStackLocation - 1;
    Irp-&gt;Tail.Overlay.CurrentStackLocation = v2;
    MajorFunction = v2-&gt;MajorFunction;
    v2-&gt;DeviceObject = DeviceObject;
    if ( (_BYTE)MajorFunction == 22 &amp;&amp; (unsigned __int8)(v2-&gt;MinorFunction - 2) &lt;= 1u )
      return IopPoHandleIrp(Irp);
    else
      return ((__int64 (__fastcall *)(PDEVICE_OBJECT))DeviceObject-&gt;DriverObject-&gt;MajorFunction[MajorFunction])(DeviceObject);
  }
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic" data-enlighter-highlight="24" data-enlighter-theme="monokai">NTSTATUS __stdcall IofCallDriver(PDEVICE_OBJECT DeviceObject, PIRP Irp)
{
  _IO_STACK_LOCATION *v2; // rax
  __int64 MajorFunction; // r8

  if ( IopDispatchCallDriver )
  {
    if ( IopDispatchCallDriver == 3 )
      return IopPerfCallDriver((PADAPTER_OBJECT)DeviceObject);
    else
      return IovCallDriver(DeviceObject);
  }
  else
  {
    if ( --Irp-&gt;CurrentLocation &lt;= 0 )
      KeBugCheckEx(0x35u, (ULONG_PTR)Irp, 0LL, 0LL, 0LL);
    v2 = Irp-&gt;Tail.Overlay.CurrentStackLocation - 1;
    Irp-&gt;Tail.Overlay.CurrentStackLocation = v2;
    MajorFunction = v2-&gt;MajorFunction;
    v2-&gt;DeviceObject = DeviceObject;
    if ( (_BYTE)MajorFunction == 22 &amp;&amp; (unsigned __int8)(v2-&gt;MinorFunction - 2) &lt;= 1u )
      return IopPoHandleIrp(Irp);
    else
      return ((__int64 (__fastcall *)(PDEVICE_OBJECT))DeviceObject-&gt;DriverObject-&gt;MajorFunction[MajorFunction])(DeviceObject);
  }
}</pre>
<div>
<p>The most interesting part of the function is the last line. It <strong>calls a function pointer</strong> inside the <strong>MajorFunction array</strong> part of <em><strong>DriverObject</strong></em> part of <em><strong>DeviceObject</strong></em>. Since <strong>we can control <em>DeviceObject</em></strong> then <strong>we can control the function pointer inside the MajorFunction array</strong>. This grants us the ability <strong>redirect the execution flow to an arbitrary location!</strong></p>
</div>
<h2>Wrapping up</h2>
</div>
</div>
</div>
<p>In this post we analyzed the driver EntryPoint with IDA Pro in order to retrieve the IOCTL handler. We analyzed the IOCTL handler, in order to retrieve the valid IoControlCodes and analyzed the functions in charge of handling the different IoControlCodes.</p>
<p>Finally, we spotted two vulnerabilities: an <strong>arbitrary MSR read</strong> and an <strong>arbitrary pointer dereference.</strong></p>
<p><em>You may have noticed that the <strong>driver analysis process</strong> (retrieving driver name, IOCTL dispatcher, IOCTL codes, …) can be quite tedious. If you want to <strong>automate the process</strong> I suggest you to give a look at the following <a href="https://github.com/VoidSec/DriverBuddyReloaded">project</a> that directly integrates into IDA Pro.</em></p>
<p>In <a href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-2/">Part 2</a> we will confirm both vulnerabilities with the help of IDA Pro’s Debugger.</p>
</div><div class="uncode_text_column mt-5"><span class="post-tags"><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/windows/">windows</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/tutorial/">Tutorial</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/red-teaming/">red teaming</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/atdcm64a/">atdcm64a</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/exploit-development/">exploit development</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/exploit/">exploit</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/ida/">ida</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/vulnerability-research/">vulnerability research</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/reverse-engineering/">reverse engineering</a><a class="custom-tag-box" href="https://hnsecurity.it/blog/tag/static-analysis/">static analysis</a></span>
</div></div></div></div></div></div></div></div></div><div data-parent="true" class="vc_row has-bg need-focus style-color-lxmt-bg row-container" id="row-unique-3"><div class="row double-top-padding double-bottom-padding single-h-padding full-width row-parent" data-imgready="true"><div class="wpb_row row-inner"><div class="wpb_column pos-top pos-center align_center column_parent col-lg-12 single-internal-gutter"><div class="uncol style-light"><div class="uncoltable"><div class="uncell no-block-padding"><div class="uncont"><div class="owl-carousel-wrapper">
													<div class="owl-carousel-container single-gutter test-init">												<div id="index-177493092" class="owl-carousel owl-element owl-height-equal owl-dots-outside owl-dots-single-block-padding owl-dots-align-center owl-loaded owl-drag showControls" data-dots="true" data-dotsmobile="true" data-navmobile="false" data-navspeed="400" data-autoplay="false" data-stagepadding="0" data-lg="5" data-md="3" data-sm="1" data-vp-height="false"><div class="owl-stage-outer"><div class="owl-stage" style="transform: translate3d(0px, 0px, 0px); transition: all; width: 3456px;"><div class="owl-item active index-active" data-index="1" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-78 grid-cat-91 tmb-id-5100 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/groovy-template-engine-exploitation-part-2/?media_link=1" class="pushed" aria-label="Groovy logo" target="_self" data-lb-index="0"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159919 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/GROOVY.jpg" width="1600" height="836" alt="Groovy logo" data-no-bp="" data-bp="720" data-uniqueid="159919-169659" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/GROOVY.jpg" data-path="2025/09/GROOVY.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-78 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/exploits/">Exploits</a></span><span class="t-entry-category t-entry-category-91 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/articles/">Articles</a></span></p><p class="t-entry-meta"><span class="t-entry-date">November 11, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/groovy-template-engine-exploitation-part-2/" target="_self">Groovy Template Engine Exploitation – Notes from a real case scenario, part 2</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item active index-active" data-index="2" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-81 tmb-id-159840 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/export-to-pdf-allows-local-file-inclusion-path-traversal-in-microsoft-365/?media_link=1" class="pushed" aria-label="Microsoft 365 logo" target="_self" data-lb-index="1"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159937 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/MIC-365.jpg" width="1600" height="836" alt="Microsoft 365 logo" data-no-bp="" data-bp="720" data-uniqueid="159937-502217" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/MIC-365.jpg" data-path="2025/09/MIC-365.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span></p><p class="t-entry-meta"><span class="t-entry-date">July 8, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/export-to-pdf-allows-local-file-inclusion-path-traversal-in-microsoft-365/" target="_self">Export to PDF allows local file inclusion/path traversal in Microsoft 365</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item active index-active" data-index="3" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-76 grid-cat-81 grid-cat-91 tmb-id-5512 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/my-zero-day-quest-bluehat-podcast/?media_link=1" class="pushed" aria-label="ZeroDay logo" target="_self" data-lb-index="2"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159967 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/ZERODAY.jpg" width="1600" height="836" alt="ZeroDay logo" data-no-bp="" data-bp="720" data-uniqueid="159967-451707" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/ZERODAY.jpg" data-path="2025/09/ZERODAY.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-76 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/events/">Events</a></span><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span><span class="t-entry-category t-entry-category-91 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/articles/">Articles</a></span></p><p class="t-entry-meta"><span class="t-entry-date">May 6, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/my-zero-day-quest-bluehat-podcast/" target="_self">My Zero Day Quest &amp; BlueHat Podcast</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.0012px);"></div></div></div>
							</div></div></div></div><div class="owl-item active index-active" data-index="4" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-78 grid-cat-81 tmb-id-5313 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/local-privilege-escalation-on-zyxel-usg-flex-h-series-cve-2025-1731/?media_link=1" class="pushed" aria-label="Zyxel Networks logo" target="_self" data-lb-index="3"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159969 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/ZYXEL.jpg" width="1600" height="836" alt="Zyxel Networks logo" data-no-bp="" data-bp="720" data-uniqueid="159969-196574" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/ZYXEL.jpg" data-path="2025/09/ZYXEL.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-78 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/exploits/">Exploits</a></span><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span></p><p class="t-entry-meta"><span class="t-entry-date">April 23, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/local-privilege-escalation-on-zyxel-usg-flex-h-series-cve-2025-1731/" target="_self">Local privilege escalation on Zyxel USG FLEX H Series (CVE-2025-1731)</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item active index-active" data-index="5" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-78 grid-cat-81 tmb-id-5027 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/cve-2024-49138-windows-clfs-heap-based-buffer-overflow-analysis-part-2/?media_link=1" class="pushed" aria-label="Microsoft logo" target="_self" data-lb-index="4"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159961 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/WIN.jpg" width="1600" height="836" alt="Microsoft logo" data-no-bp="" data-bp="720" data-uniqueid="159961-142766" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/WIN.jpg" data-path="2025/09/WIN.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-78 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/exploits/">Exploits</a></span><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span></p><p class="t-entry-meta"><span class="t-entry-date">January 29, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/cve-2024-49138-windows-clfs-heap-based-buffer-overflow-analysis-part-2/" target="_self">CVE-2024-49138 Windows CLFS heap-based buffer overflow analysis – Part 2</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item" data-index="6" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-78 grid-cat-81 tmb-id-4929 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/cve-2024-49138-windows-clfs-heap-based-buffer-overflow-analysis-part-1/?media_link=1" class="pushed" aria-label="Microsoft logo" target="_self" data-lb-index="5"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159961 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/WIN.jpg" width="1600" height="836" alt="Microsoft logo" data-no-bp="" data-bp="720" data-uniqueid="159961-762579" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/WIN.jpg" data-path="2025/09/WIN.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-78 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/exploits/">Exploits</a></span><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span></p><p class="t-entry-meta"><span class="t-entry-date">January 29, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/cve-2024-49138-windows-clfs-heap-based-buffer-overflow-analysis-part-1/" target="_self">CVE-2024-49138 Windows CLFS heap-based buffer overflow analysis – Part 1</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item" data-index="7" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-78 grid-cat-81 tmb-id-4228 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/from-arbitrary-pointer-dereference-to-arbitrary-read-write-in-latest-windows-11/?media_link=1" class="pushed" target="_self" data-lb-index="6"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159895 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/AMD.jpg" width="1600" height="836" alt="" data-no-bp="" data-bp="720" data-uniqueid="159895-624251" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/AMD.jpg" data-path="2025/09/AMD.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-78 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/exploits/">Exploits</a></span><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span></p><p class="t-entry-meta"><span class="t-entry-date">January 15, 2025</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/from-arbitrary-pointer-dereference-to-arbitrary-read-write-in-latest-windows-11/" target="_self">From arbitrary pointer dereference to arbitrary read/write in latest Windows 11</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item" data-index="8" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-81 grid-cat-91 tmb-id-4341 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/an-analysis-of-the-keycloak-authentication-system/?media_link=1" class="pushed" aria-label="KEYCLOAK logo" target="_self" data-lb-index="7"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159927 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/KEYCLOAK.jpg" width="1600" height="836" alt="KEYCLOAK logo" data-no-bp="" data-bp="720" data-uniqueid="159927-844439" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/KEYCLOAK.jpg" data-path="2025/09/KEYCLOAK.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span><span class="t-entry-category t-entry-category-91 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/articles/">Articles</a></span></p><p class="t-entry-meta"><span class="t-entry-date">October 30, 2024</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/an-analysis-of-the-keycloak-authentication-system/" target="_self">An analysis of the Keycloak authentication system</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div><div class="owl-item" data-index="9" style="width: 384px;"><div class="tmb tmb-carousel atc-typography-inherit tmb-iso-h33 tmb-round img-round-lg tmb-light tmb-text-showed tmb-overlay-anim tmb-content-left  grid-cat-78 grid-cat-81 tmb-id-4100 tmb-content-under tmb-media-first" style="transition-delay: 120ms; transition-duration: 320ms;"><div class="t-inside style-color-xsdn-bg no-anim srcset-lazy-animations"><div class="t-entry-visual"><div class="t-entry-visual-tc"><div class="t-entry-visual-cont"><div class="dummy" style="padding-top: 52.3%;"></div><a role="button" tabindex="-1" href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-3/?media_link=1" class="pushed" target="_self" data-lb-index="8"><div class="t-entry-visual-overlay"><div class="t-entry-visual-overlay-in style-color-wayh-bg" style="opacity: 0.5;"></div></div><img decoding="async" class="srcset-auto srcset-on-layout wp-image-159895 srcset-sizes-done" src="https://hnsecurity.it/wp-content/uploads/2025/09/AMD.jpg" width="1600" height="836" alt="" data-no-bp="" data-bp="720" data-uniqueid="159895-217783" data-guid="https://hnsecurity.it/wp-content/uploads/2025/09/AMD.jpg" data-path="2025/09/AMD.jpg" data-width="1600" data-height="836" data-singlew="2" data-singleh="33" data-crop="" loading="lazy"></a></div>
					</div>
				</div><div class="t-entry-text">
									<div class="t-entry-text-tc half-block-padding"><div class="t-entry"><p class="t-entry-meta"><span class="t-entry-category t-entry-category-78 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/exploits/">Exploits</a></span><span class="t-entry-category t-entry-category-81 t-entry-tax"><a class="bordered-cat tmb-term-evidence font-ui" href="https://hnsecurity.it/blog/category/vulnerabilities/">Vulnerabilities</a></span></p><p class="t-entry-meta"><span class="t-entry-date">October 9, 2024</span></p><h3 class="t-entry-title h5 title-scale "><a href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a-sys-arbitrary-pointer-dereference-part-3/" target="_self">Exploiting AMD atdcm64a.sys arbitrary pointer dereference – Part 3</a></h3><div class="t-entry-excerpt " style="transform: translateY(16.001px);"></div></div></div>
							</div></div></div></div></div></div>					<div class="owl-nav disabled"><button type="button" aria-label="Previous" class="owl-prev style-light style-override" style="margin-left: -16px;"><div class="owl-nav-container btn-default btn-hover-nobg" tabindex="0"><i class="fa fa-fw fa-angle-left"></i></div></button><button type="button" aria-label="Next" class="owl-next style-light style-override" style="margin-right: -16px;"><div class="owl-nav-container btn-default btn-hover-nobg" aria-label="Next" tabindex="0"><i class="fa fa-fw fa-angle-right"></i></div></button></div><div class="owl-dots uncode_index-dot_classes limit-width owl-dots-classes"><button class="owl-dot active" aria-label="Slide 1"><span></span></button><button class="owl-dot" aria-label="Slide 2"><span></span></button></div></div>	
	

	</div>				</div>
</div></div></div></div></div></div></div></div></div><div class="post-footer post-footer-light row-container"><div class="row-container">
		  					<div class="row row-parent style-light no-top-padding double-bottom-padding" style="max-width: 804px; margin: auto;">
									<div class="post-share">
	          						<div class="detail-container margin-auto">
													<div class="share-button share-buttons share-inline only-icon sharer-0" style="display: block;"><label class="social-export"><span></span></label></div>
												</div>
											</div>
								</div>
							</div></div></div>
          </div>
        </article>								</div><!-- sections container -->
							</div><!-- page wrapper -->
												
												<div class="overlay-menu-focus style-dark-bg "></div>					</div><!-- main container -->
				</div><!-- main wrapper -->
							</div><!-- box container -->
					</div><!-- box wrapper -->
		<div class="style-light footer-scroll-top footer-scroll-higher"><a href="https://hnsecurity.it/blog/exploiting-amd-atdcm64a.sys-arbitrary-pointer-dereference-part-1/#" class="scroll-top" aria-label="Scroll to top"><i class="fa fa-angle-up fa-stack btn-default btn-hover-nobg"></i></a></div>
	

































		
		
	
		<!-- Cookie Notice plugin v2.5.12 by Hu-manity.co https://hu-manity.co/ -->
		<div id="cookie-notice" role="dialog" class="cookie-notice-hidden cookie-revoke-hidden cn-position-bottom" aria-label="Cookie Notice" style="background-color: rgba(255,255,255,1);"><div class="cookie-notice-container" style="color: #2d2d2d"><span id="cn-notice-text" class="cn-text-container">We use cookies to improve your browsing experience and analyze our traffic. By clicking "Accept all", you consent to the use of cookies.</span><span id="cn-notice-buttons" class="cn-buttons-container"><button id="cn-accept-cookie" data-cookie-set="accept" class="cn-set-cookie cn-button cn-button-custom custom-link btn btn-cookiebanner border-width-0 btn-accent btn-circle" aria-label="Accept All">Accept All</button><button data-link-url="https://hnsecurity.it/privacy-policy/" data-link-target="_blank" id="cn-more-info" class="cn-more-info cn-button cn-button-custom custom-link btn btn-cookiebanner border-width-0 btn-accent btn-circle" aria-label="Privacy policy">Privacy policy</button></span><button type="button" id="cn-close-notice" data-cookie-set="accept" class="cn-close-icon" aria-label="Reject All"></button></div>
			
		</div>
		<!-- / Cookie Notice plugin -->

</body></html>