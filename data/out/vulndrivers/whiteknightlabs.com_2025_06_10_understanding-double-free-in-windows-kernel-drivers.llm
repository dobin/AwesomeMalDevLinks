Title:
Understanding Double Free in Windows Kernel Drivers

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains double-free vulnerabilities in Windows kernel-mode drivers and why they can corrupt the kernel pool allocator and lead to BSODs or potential code execution.  
- It walks through multiple vulnerable driver patterns: a classic `ExAllocatePoolWithTag` + double `ExFreePoolWithTag`, and an MDL lifecycle bug using `IoAllocateMdl` + double `IoFreeMdl`.  
- A user-mode PoC triggers the bug via an IOCTL to the driver, demonstrating a crash with `BUGCHECK_CODE: 0x4E (PFN_LIST_CORRUPT)` in the MDL case.  
- The article then shows a more realistic “wrapped cleanup” scenario where ownership is obscured by helper routines (e.g., `FreeHandle()`), making double-frees harder to spot in large codebases.  
- It closes with practical mitigation guidance (nulling pointers, state/ownership flags) and a checklist of common kernel deallocation APIs to audit.  
- Useful for kernel exploit dev learners, driver developers, and defenders doing code review or root-cause analysis of kernel crashes.

Technical Focus:
- Windows kernel pool allocation/free (`ExAllocatePoolWithTag`, `ExFreePoolWithTag`)
- MDL allocation/free and PFN corruption (`IoAllocateMdl`, `IoFreeMdl`, `PFN_LIST_CORRUPT`)
- IOCTL-driven bug triggering from user mode
- Double-free → heap/pool corruption → UAF/exploitation primitives
- Cleanup/ownership bugs via wrapper functions and scattered teardown paths
- Mitigations: pointer nulling, state tracking, centralized resource management

Use Cases:
- Auditing Windows drivers for double-free/UAF patterns in teardown paths
- Building minimal repro drivers and user-mode IOCTL harnesses for crash triage
- Developing kernel exploitation labs focused on pool/MDL corruption primitives
- Creating defensive code review checklists for kernel resource lifecycle management

Keywords:
Windows kernel, kernel driver, double free, ExAllocatePoolWithTag, ExFreePoolWithTag, IoAllocateMdl, IoFreeMdl, MDL, IOCTL, pool corruption, heap corruption, use-after-free, PFN_LIST_CORRUPT, bugcheck 0x4E, BSOD, KeDelayExecutionThread, DriverUnload, resource ownership, cleanup callback, kernel exploitation