Title:
(Anti-)Anti-Rootkit Techniques – Part II: Stomped Drivers and Hidden Threads

Type:
Blog Post

Short Summary (4–8 sentences max):
This post discusses evasions against a custom Windows anti-rootkit driver from Part I that detects manually mapped kernel drivers by looking for threads executing from unbacked memory. It focuses on two common anti-anti-rootkit techniques: driver “stomping” (overwriting an already-loaded legitimate driver’s code) and hiding kernel threads to avoid thread-origin checks. For stomping detection, it proposes verifying integrity by comparing a loaded driver’s in-memory `.text` section against the on-disk image, similar to user-mode module stomping detection. The implementation walks `\Driver` objects, derives the service name, resolves the driver path via the registry, and then performs disk-vs-memory section comparison (noting attacker spoofing opportunities). It’s useful for kernel security researchers and blue teams building anti-rootkit/anti-cheat telemetry, and for red teams understanding what integrity checks they must evade. The value is in mapping practical attacker tradeoffs (manual map vs stomp vs spoof) to concrete kernel-level detection ideas.

Technical Focus:
- Manual mapping detection via “unbacked memory” execution (kdmapper-style)
- Driver stomping / in-memory `.text` integrity verification
- Enumerating `\Driver` directory and `DRIVER_OBJECT` instances
- Registry-based driver service/path resolution
- Kernel synchronization while walking object directory hash buckets
- Evasion considerations (service/path spoofing, filesystem spoofing/hooks)

Use Cases:
- Build an anti-rootkit/anti-cheat driver that detects stomped kernel modules
- Add integrity checks for loaded drivers by validating `.text` against disk
- Threat model and test rootkit evasion paths (stomp vs manual map)
- Develop red-team PoCs to evaluate defensive coverage and bypasses
- Create detection engineering notes for kernel-resident tampering indicators

Keywords:
Windows kernel, rootkit, anti-rootkit, anti-cheat, driver stomping, module stomping, kdmapper, manual mapping, unbacked memory, DRIVER_OBJECT, \Driver directory, ZwOpenDirectoryObject, ObReferenceObjectByHandle, KeEnterCriticalRegion, ExAcquirePushLockExclusiveEx, .text section, registry service key, integrity check, hidden threads