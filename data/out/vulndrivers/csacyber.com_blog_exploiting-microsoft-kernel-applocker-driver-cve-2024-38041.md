# https://csacyber.com/blog/exploiting-microsoft-kernel-applocker-driver-cve-2024-38041

![Revisit consent button](https://cdn-cookieyes.com/assets/images/revisit.svg)

We value your privacy

We use cookies to enhance your browsing experience, serve personalised ads or content, and analyse our traffic. By clicking "Accept All", you consent to our use of cookies.

CustomiseReject AllAccept All

Customise Consent Preferences![](https://cdn-cookieyes.com/assets/images/close.svg)

We use cookies to help you navigate efficiently and perform certain functions. You will find detailed information about all cookies under each consent category below.

The cookies that are categorised as "Necessary" are stored on your browser as they are essential for enabling the basic functionalities of the site. ... Show more

NecessaryAlways Active

Necessary cookies are required to enable the basic features of this site, such as providing secure log-in or adjusting your consent preferences. These cookies do not store any personally identifiable data.

- Cookie

\_\_cf\_bm

- Duration

1 hour

- Description

This cookie, set by Cloudflare, is used to support Cloudflare Bot Management.


- Cookie

\_cfuvid

- Duration

session

- Description

Calendly sets this cookie to track users across sessions to optimize user experience by maintaining session consistency and providing personalized services


- Cookie

\_\_hssrc

- Duration

session

- Description

This cookie is set by Hubspot whenever it changes the session cookie. The \_\_hssrc cookie set to 1 indicates that the user has restarted the browser, and if the cookie does not exist, it is assumed to be a new session.


- Cookie

\_\_hssc

- Duration

1 hour

- Description

HubSpot sets this cookie to keep track of sessions and to determine if HubSpot should increment the session number and timestamps in the \_\_hstc cookie.


- Cookie

\_GRECAPTCHA

- Duration

6 months

- Description

Google Recaptcha service sets this cookie to identify bots to protect the website against malicious spam attacks.


- Cookie

rc::a

- Duration

Never Expires

- Description

This cookie is set by the Google recaptcha service to identify bots to protect the website against malicious spam attacks.


- Cookie

rc::f

- Duration

Never Expires

- Description

This cookie is set by the Google recaptcha service to identify bots to protect the website against malicious spam attacks.


- Cookie

rc::c

- Duration

session

- Description

This cookie is set by the Google recaptcha service to identify bots to protect the website against malicious spam attacks.


- Cookie

rc::b

- Duration

session

- Description

This cookie is set by the Google recaptcha service to identify bots to protect the website against malicious spam attacks.


- Cookie

cookieyes-consent

- Duration

1 year

- Description

CookieYes sets this cookie to remember users' consent preferences so that their preferences are respected on subsequent visits to this site. It does not collect or store any personal information about the site visitors.


Functional

Functional cookies help perform certain functionalities like sharing the content of the website on social media platforms, collecting feedback, and other third-party features.

- Cookie

yt-remote-device-id

- Duration

Never Expires

- Description

YouTube sets this cookie to store the user's video preferences using embedded YouTube videos.


- Cookie

ytidb::LAST\_RESULT\_ENTRY\_KEY

- Duration

Never Expires

- Description

The cookie ytidb::LAST\_RESULT\_ENTRY\_KEY is used by YouTube to store the last search result entry that was clicked by the user. This information is used to improve the user experience by providing more relevant search results in the future.


- Cookie

yt-remote-connected-devices

- Duration

Never Expires

- Description

YouTube sets this cookie to store the user's video preferences using embedded YouTube videos.


- Cookie

yt-remote-cast-installed

- Duration

session

- Description

The yt-remote-cast-installed cookie is used to store the user's video player preferences using embedded YouTube video.


- Cookie

yt-remote-session-app

- Duration

session

- Description

The yt-remote-session-app cookie is used by YouTube to store user preferences and information about the interface of the embedded YouTube video player.


- Cookie

yt-remote-session-name

- Duration

session

- Description

The yt-remote-session-name cookie is used by YouTube to store the user's video player preferences using embedded YouTube video.


- Cookie

yt-remote-fast-check-period

- Duration

session

- Description

The yt-remote-fast-check-period cookie is used by YouTube to store the user's video player preferences for embedded YouTube videos.


Analytics

Analytical cookies are used to understand how visitors interact with the website. These cookies help provide information on metrics such as the number of visitors, bounce rate, traffic source, etc.

- Cookie

\_\_hstc

- Duration

6 months

- Description

Hubspot set this main cookie for tracking visitors. It contains the domain, initial timestamp (first visit), last timestamp (last visit), current timestamp (this visit), and session number (increments for each subsequent session).


- Cookie

hubspotutk

- Duration

6 months

- Description

HubSpot sets this cookie to keep track of the visitors to the website. This cookie is passed to HubSpot on form submission and used when deduplicating contacts.


- Cookie

\_ga

- Duration

1 year 1 month 4 days

- Description

Google Analytics sets this cookie to calculate visitor, session and campaign data and track site usage for the site's analytics report. The cookie stores information anonymously and assigns a randomly generated number to recognise unique visitors.


- Cookie

\_ga\_\*

- Duration

1 year 1 month 4 days

- Description

Google Analytics sets this cookie to store and count page views.


Performance

Performance cookies are used to understand and analyse the key performance indexes of the website which helps in delivering a better user experience for the visitors.

No cookies to display.

Advertisement

Advertisement cookies are used to provide visitors with customised advertisements based on the pages you visited previously and to analyse the effectiveness of the ad campaigns.

- Cookie

YSC

- Duration

session

- Description

Youtube sets this cookie to track the views of embedded videos on Youtube pages.


- Cookie

VISITOR\_INFO1\_LIVE

- Duration

6 months

- Description

YouTube sets this cookie to measure bandwidth, determining whether the user gets the new or old player interface.


- Cookie

VISITOR\_PRIVACY\_METADATA

- Duration

6 months

- Description

YouTube sets this cookie to store the user's cookie consent state for the current domain.


- Cookie

yt.innertube::requests

- Duration

Never Expires

- Description

YouTube sets this cookie to register a unique ID to store data on what videos from YouTube the user has seen.


- Cookie

yt.innertube::nextId

- Duration

Never Expires

- Description

YouTube sets this cookie to register a unique ID to store data on what videos from YouTube the user has seen.


Uncategorised

Other uncategorised cookies are those that are being analysed and have not been classified into a category as yet.

- Cookie

\_\_Secure-ROLLOUT\_TOKEN

- Duration

6 months

- Description

Description is currently not available.


Reject AllSave My PreferencesAccept All

Powered by [![Cookieyes logo](https://cdn-cookieyes.com/assets/images/poweredbtcky.svg)](https://www.cookieyes.com/product/cookie-consent/?ref=cypbcyb&utm_source=cookie-banner&utm_medium=powered-by-cookieyes)

September 16, 2024


6 min read time


# Exploiting Microsoft Kernel Applocker Driver (CVE-2024-38041)

![Erwin Krazek](https://app.hubspot.com/settings/avatar/d41d8cd98f00b204e9800998ecf8427e)[Erwin Krazek](https://csacyber.com/blog/author/erwin-krazek)

[Penetration Testing](https://csacyber.com/blog/tag/penetration-testing)

![](https://csacyber.com/hubfs/kernelapp.png)

### Overview

In recent July Patch Tuesday Microsoft patched a vulnerability in the Microsoft Kernel driver appid.sys, which is the central driver behind [AppLocker](https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/applocker/applocker-overview), the application whitelisting technology built into Windows. The vulnerability, [CVE-2024-38041](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2024-38041), allows a local attacker to retrieve information that could lead to a Kernel Address Space Layout Randomization (KASLR) bypass which might become a requirement in future releases of windows.

This blog post details my process of patch diffing in the Windows kernel, analysing N-day vulnerability, finding the bug, and building a working exploit. This post doesn’t require any specialized Windows kernel knowledge to follow along, though a basic understanding of [memory disclosure bugs](https://en.wikipedia.org/wiki/Memory_leak) and operating system concepts is helpful. I’ll also cover the basics of patch diffing.

### Basics of Patch Diffing

Patch diffing is a common technique of comparing two binary builds of the same code – a known-vulnerable one and one containing a security fix. It is often used to determine the technical details behind ambiguously-worded bulletins, and to establish the root causes, attack vectors and potential variants of the vulnerabilities in question. The approach has attracted plenty of research and tooling development over the years, and has been shown to be useful for identifying so-called N-day bugs, which can be exploited against users who are slow to adopt latest security patches. Overall, the risk of post-patch vulnerability exploitation is inevitable for software which can be freely reverse-engineered, and is thus accepted as a natural part of the ecosystem.

In a similar vein, binary diffing can be utilized to discover discrepancies between two or more versions of a single product, if they share the same core code and coexist on the market, but are serviced independently by the vendor. One example of such software is the Windows operating system.

### KASLR in Windows 11 24H2

In previous Windows versions defeating KASLR has been trivial due to a number of syscalls including kernel pointers in their output. In Windows 11 24H2 however, as documented by Yarden Shafir in a [blog post](https://windows-internals.com/kaslr-leaks-restriction/) analysing the change, these kernel address leaks are no longer available to unprivileged callers.

In the absence of the classic KASLR bypasses, in order to determine the layout of the kernel an info leak or new technique is required.

### Patch Diff (Appid.sys)

In order to identify the specific cause of the vulnerability, we’ll compare the patched binary to the pre-patch binary and try to extract the difference using a tool called [BinDiff](https://www.zynamics.com/bindiff.html). I had already saved both binary versions on my computer, as I like to keep track of Patch Tuesday updates. Additionally, I had written a simple Python script to dump all drivers before applying monthly patches, and then doing the dump of the patched binaries afterward. However, we can use [Winbindex](https://winbindex.m417z.com/) to obtain two versions of appid.sys: one right before the patch and one right after, both for the same version of Windows.

![](https://csa.limited/assets/img/appid1.png)

Getting sequential versions of the binaries is important, as even using versions a few updates apart can introduce noise from differences that are not related to the patch, and cause you to waste time while doing your analysis. Winbindex has made patch analysis easier than ever, as you can obtain any Windows binary beginning from Windows 10. I loaded both of the files in [IDA Decompiler](https://hex-rays.com/) and ran the analysis. Afterward, the files can be exported into a BinExport format using the extension BinExport then being loaded into BinDiff tool.

![](https://csa.limited/assets/img/newdiff.png)

Creating a new diff

![](https://csa.limited/assets/img/bindiffsummary.png)

BinDiff summary comparing the pre and post-patch binaries

BinDiff works by matching functions in the binaries being compared using various algorithms. In this case there, we have applied function symbol information from Microsoft, so all the functions can be matched by name.

![](https://csa.limited/assets/img/matchedfunctions.png)

List of matched functions sorted by similarity

Above we see there is only one function that have a similarity less than 100%. The function that was changed by the patch is AipDeviceIoControlDispatch.

![](https://csa.limited/assets/img/newchecks.png)

New checks introduced

In the above image we can see the two highlighted in red blocks that have been added in the patched version of the driver. This code checks the [PreviousMode](https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/previousmode) of the incoming IOCTL packet in order to verify that the packet is coming from a kernel-mode rather then user-mode.

### Root cause analysis

The screenshots below shows the changed code pre and post-patch when looking at the decompiled function code of AipDeviceIoControlDispatch in IDA.

![](https://csa.limited/assets/img/prepatch.png)

Pre-patch version of appid.sys Windows 11 22H2

![](https://csa.limited/assets/img/postpatch.png)

Post-patch version of appid.sys Windows 11 22H2

This change shown above is the only update to the identified function. Some quick analysis showed that a check is being performed based on PreviousMode. If PreviousMode is zero (indicating that the call originates from the kernel) pointers are written to the output buffer specified in the SystemBuffer field. If, on the other hand, PreviousMode is not zero and Feature\_2619781439... is enabled then the driver will simply return STATUS\_INVALID\_DEVICE\_REQUEST (0xC0000010) error code.

### Exploitation

The first step is to communicate with the driver to trigger its vulnerability. To communicate with the driver, you typically need to find the Device Name, obtain a handle, and then send the appropriate [IOCTL](https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/introduction-to-i-o-control-codes) code to reach the vulnerability.

For this purpose, the IoCreateDevice function was analyzed in the DriverEntry function and the third argument of DeviceName is found to be \\\Device\\\AppID.

![](https://csa.limited/assets/img/codesnipexploit.png)

[Decoding](https://www.osronline.com/article.cfm%5earticle=229.htm) the 0x22A014 control code and extracting the RequiredAccess field reveals that a handle with write access is required to call it. Inspecting the device’s ACL (Access Control List; see the screenshot below), there are entries for local service, administrators, and appidsvc. While the entry for administrators does not grant write access, the entry for local service does.

![](https://csa.limited/assets/img/symlink.png)

As the [local service](https://learn.microsoft.com/en-us/windows/win32/services/localservice-account) account has reduced privileges compared to administrators, this also gives the vulnerability a somewhat higher impact than standard admin-to-kernel. This might be the reason Microsoft characterized the CVE as Privileges Required: Low, taking into account that local service processes do not always necessarily have to run at higher integrity levels.

Given the fact that I already have wrote an [exploit](https://github.com/Nero22k/Exploits/tree/main/Windows/CVE-2024-21338) for CVE-2024-21338 which is the same driver that we analyse so I will only provide the modified version of the code [here](https://github.com/Nero22k/Exploits/tree/main/Windows/CVE-2024-38041).

![](https://csa.limited/assets/img/sucess.png)

Successful Exploitation

### Summary

In this blog post we've covered patch diffing, root cause analysis and process of exploiting the vulnerability. It's important to monitor for new code additions as sometimes it can be fruitful for finding vulnerabilities.

Despite best efforts by Microsoft trying to follow secure coding practices, there are always things that gets often overlooked during code reviews which create vulnerabilities that attackers often are trying to exploit.

### Bibliography

[\[1\] – Diffing Binaries vs Anti-Diffing](https://www.blackhat.com/presentations/bh-usa-09/OH/BHUSA09-Oh-DiffingBinaries-SLIDES.pdf)

[\[2\] – Do you even Diff?](https://www.cisoplatform.com/profiles/blogs/bruh-do-you-even-diff-diffing-microsoft-patches-to-find-vulnerabi)

[\[3\] – KASLR Restrictions](https://windows-internals.com/kaslr-leaks-restriction/)

[\[4\] – Using Binary Diffing To Discover](https://googleprojectzero.blogspot.com/2017/10/using-binary-diffing-to-discover.html)

[\[5\] – Patch Tuesday Exploit Wednesday](https://securityintelligence.com/x-force/patch-tuesday-exploit-wednesday-pwning-windows-ancillary-function-driver-winsock/)

Related Posts

## You may also like this

[Similar Articles](https://csacyber.com/blog)

[![](https://csacyber.com/hs-fs/hubfs/social-engineering.jpg?width=624&height=427&name=social-engineering.jpg)](https://csacyber.com/blog/preparing-for-the-quantum-shift-why-post-quantum-readiness-cannot-wait)

February 6, 2026


4 min read


### [Preparing for the quantum shift: Why post-quantum readiness cannot wait](https://csacyber.com/blog/preparing-for-the-quantum-shift-why-post-quantum-readiness-cannot-wait)

The debate around quantum risk is gathering momentum, and rightly so. Research such as Mastercard’s...


[![David Woodfine](https://app.hubspot.com/settings/avatar/d41d8cd98f00b204e9800998ecf8427e)\\
\\
David Woodfine](https://csacyber.com/blog/author/david-woodfine)

[![](https://csacyber.com/hs-fs/hubfs/blog-banner-logo.png?width=624&height=427&name=blog-banner-logo.png)](https://csacyber.com/blog/cve-2026-21509-analysis-the-ghost-in-the-document)

February 2, 2026


11 min read


### [CVE-2026-21509 Analysis: The ghost in the document](https://csacyber.com/blog/cve-2026-21509-analysis-the-ghost-in-the-document)

In January 2026, Microsoft confirmed active exploitation of a high-severity zero-day,...


[![Steve Velcev](https://app.hubspot.com/settings/avatar/d41d8cd98f00b204e9800998ecf8427e)\\
\\
Steve Velcev](https://csacyber.com/blog/author/steve-velcev)

[![](https://csacyber.com/hs-fs/hubfs/CSR-bill.jpg?width=624&height=427&name=CSR-bill.jpg)](https://csacyber.com/blog/cyber-security-and-resilience-bill-what-it-means)

January 5, 2026


6 min read


### [Cyber Security and Resilience Bill: What it means for UK businesses](https://csacyber.com/blog/cyber-security-and-resilience-bill-what-it-means)

On 12 November 2025, the Government introduced the Cyber Security and Resilience (Network and...


[![CSA Cyber](https://csacyber.com/hs-fs/hubfs/CSA%20Cyber%20Logo%20FNL_Stacked.png?width=40&height=40&name=CSA%20Cyber%20Logo%20FNL_Stacked.png)\\
\\
CSA Cyber](https://csacyber.com/blog/author/csa-cyber)

Twitter Widget Iframe