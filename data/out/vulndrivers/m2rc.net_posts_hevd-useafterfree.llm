Title:
Exploiting HEVD Use-After-Free (NonPagedPool) on Windows 11

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post walks through exploiting a classic Use-After-Free (UAF) in the HackSysExtremeVulnerableDriver (HEVD) targeting the NonPagedPool on Windows 11 22H2 (without VBS).  
- It analyzes the vulnerable IOCTL handlers that allocate, free (without nulling a global pointer), and later use an object containing a kernel function pointer callback.  
- The exploit uses Windows kernel heap “feng shui” to reclaim the freed chunk by spraying NonPagedPool allocations via named pipes (NpFr-tagged allocations) and then allocating attacker-controlled “fake objects” to overwrite the dangling object.  
- Control-flow hijack is achieved by replacing the callback pointer, then executing ring-0 payload by placing shellcode in executable NonPagedPool memory and using a ntoskrnl gadget to jump/call into it.  
- The payload demonstrated is token-stealing shellcode to elevate the current process to SYSTEM, with notes about version-specific structure offsets (e.g., EPROCESS token offset changes).  
- It’s useful for kernel exploit developers, red teamers learning Windows kernel primitives, and defenders wanting to understand pool spraying and UAF exploitation mechanics.

Technical Focus:
- HEVD IOCTL attack surface and METHOD_NEITHER driver interaction
- NonPagedPool allocation/free behavior and dangling global pointers (UAF)
- Kernel pool heap spraying with pipes (NpFr allocations) and hole punching
- Function pointer overwrite and RIP control in kernel mode
- Executing shellcode from executable pool + gadget selection in ntoskrnl (retpoline thunk)
- Token stealing via _EPROCESS traversal and Token field overwrite

Use Cases:
- Building and understanding a full UAF-to-EoP exploit chain in a lab driver
- Practicing kernel heap manipulation (spray/defrag/hole punching) on modern Windows
- Developing/debugging kernel exploits with WinDBG, PoolMonX, DebugView, FileTest
- Creating detection ideas around abnormal pipe-based pool spraying and suspicious driver IOCTL usage

Keywords:
HEVD, HackSysExtremeVulnerableDriver, Windows 11 22H2, kernel exploitation, Use-After-Free, NonPagedPool, ExAllocatePoolWithTag, ExFreePoolWithTag, IOCTL, DeviceIoControl, METHOD_NEITHER, pool tag, _POOL_HEADER, heap feng shui, kernel heap spray, CreatePipe, WriteFile, NpFr, PoolMonX, WinDBG, DebugView, FileTest, function pointer overwrite, RIP control, ntoskrnl.exe, ROP gadget, _guard_retpoline_indirect_rax, token stealing, _EPROCESS, ActiveProcessLinks, privilege escalation, SYSTEM token