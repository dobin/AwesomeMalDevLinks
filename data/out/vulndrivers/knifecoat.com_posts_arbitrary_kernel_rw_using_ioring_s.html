# https://knifecoat.com/Posts/Arbitrary+Kernel+RW+using+IORING's

<!DOCTYPE html><html lang="en"><body class="styled-scrollbars theme-dark"><div class="published-container print is-readable-line-width has-navigation has-outline" style=""><div class="site-body"><div class="site-body-left-column"><div class="site-body-left-column-inner"><a class="site-body-left-column-site-logo" aria-label="KnifeCoat logo" href="https://knifecoat.com/Home"><img aria-hidden="true" src="https://publish-01.obsidian.md/access/a392b8cd24cdb828b4d4118fa8fc87d0/attachments/profile.png" style=""></a><a class="site-body-left-column-site-name" aria-label="KnifeCoat" href="https://knifecoat.com/Home">KnifeCoat</a><div class="site-body-left-column-site-theme-toggle" style="display: none;"></div><div class="search-view-outer"><div class="search-view-container"><span class="published-search-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-search"><path d="m21 21-4.34-4.34"></path><circle cx="11" cy="11" r="8"></circle></svg></span><input class="search-bar" tabindex="0" type="text" placeholder="Search page or heading..."></div></div><div class="nav-view-outer"><div class="nav-view"><div class="tree-item"><div class="tree-item-self mod-root is-clickable" data-path=""><div class="tree-item-inner"></div></div><div class="tree-item-children"><div class="tree-item"><div class="tree-item-self mod-collapsible is-clickable" data-path="Posts"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner">Posts</div></div><div class="tree-item-children" style="overflow-y: clip; height: 360px; transition: overflowY 100ms cubic-bezier(0.02, 0.01, 0.47, 1), height;"><div class="tree-item"><div class="tree-item-self is-clickable mod-active" data-path="Posts/Arbitrary Kernel RW using IORING's.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Arbitrary+Kernel+RW+using+IORING's">Arbitrary Kernel RW using IORING's</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/ASAR Format Spec.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/ASAR+Format+Spec">ASAR Format Spec</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Boyer-Moore Search Optimization ft. ChatGPT.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Boyer-Moore+Search+Optimization+ft.+ChatGPT">Boyer-Moore Search Optimization ft. ChatGPT</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Coverage guided fuzzing for native Android libraries (Frida &amp; Radamsa).md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Coverage+guided+fuzzing+for+native+Android+libraries+(Frida+%26+Radamsa)">Coverage guided fuzzing for native Android libraries (Frida &amp; Radamsa)</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/CVE-2022-21882, Paint By Numbers.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/CVE-2022-21882%2C+Paint+By+Numbers">CVE-2022-21882, Paint By Numbers</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Direct Kernel Object Manipulation (DKOM) attacks on ETW Providers.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Direct+Kernel+Object+Manipulation+(DKOM)+attacks+on+ETW+Providers">Direct Kernel Object Manipulation (DKOM) attacks on ETW Providers</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Feeling Unsafe, going past managed .NET.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Feeling+Unsafe%2C+going+past+managed+.NET">Feeling Unsafe, going past managed .NET</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Fuzzing Redux, leveraging AFL++ Frida-Mode on Android native libraries.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Fuzzing+Redux%2C+leveraging+AFL%2B%2B+Frida-Mode+on+Android+native+libraries">Fuzzing Redux, leveraging AFL++ Frida-Mode on Android native libraries</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Installing Burp Suite CA on Android 14.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Installing+Burp+Suite+CA+on+Android+14">Installing Burp Suite CA on Android 14</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/KDNET on Windows 11 over Hyper-V.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/KDNET+on+Windows+11+over+Hyper-V">KDNET on Windows 11 over Hyper-V</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Mo Money Mo Madness, with Frida.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Mo+Money+Mo+Madness%2C+with+Frida">Mo Money Mo Madness, with Frida</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/ObjectDataProvider Deserialization using a Xaml Formatter.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/ObjectDataProvider+Deserialization+using+a+Xaml+Formatter">ObjectDataProvider Deserialization using a Xaml Formatter</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/OWASP Mobile Application Security (MAS) p0wn.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/OWASP+Mobile+Application+Security+(MAS)+p0wn">OWASP Mobile Application Security (MAS) p0wn</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Reproducing WhatsApp CVE-2019-11932 with AFL &amp; Frida.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Reproducing+WhatsApp+CVE-2019-11932+with+AFL+%26+Frida">Reproducing WhatsApp CVE-2019-11932 with AFL &amp; Frida</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Runtime Android Object Instrumentation.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Runtime+Android+Object+Instrumentation">Runtime Android Object Instrumentation</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Scalable research tooling for agent systems.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Scalable+research+tooling+for+agent+systems">Scalable research tooling for agent systems</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Solid Block, adventures with Tensorflow and Reinforcement Learning (RL).md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Solid+Block%2C+adventures+with+Tensorflow+and+Reinforcement+Learning+(RL)">Solid Block, adventures with Tensorflow and Reinforcement Learning (RL)</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Speec No Evil.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Speec+No+Evil">Speec No Evil</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Tell you phone to link me at the coffee shop.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Tell+you+phone+to+link+me+at+the+coffee+shop">Tell you phone to link me at the coffee shop</a></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Posts/Writing Small .NET PE's.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Posts/Writing+Small+.NET+PE's">Writing Small .NET PE's</a></div></div></div></div></div><div class="tree-item is-collapsed"><div class="tree-item-self mod-collapsible is-clickable" data-path="Resources"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner">Resources</div></div></div><div class="tree-item is-collapsed"><div class="tree-item-self mod-collapsible is-clickable" data-path="Tools"><div class="tree-item-icon collapse-icon is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner">Tools</div></div></div><div class="tree-item"><div class="tree-item-self is-clickable" data-path="Home.md"><div class="tree-item-inner"><a href="https://knifecoat.com/Home">Home</a></div></div></div></div></div></div></div></div></div><div class="site-body-center-column"><div class="site-header"><div class="clickable-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-menu"><path d="M4 5h16"></path><path d="M4 12h16"></path><path d="M4 19h16"></path></svg></div><a class="site-header-logo" aria-hidden="true" href="https://knifecoat.com/Home" style=""><img src="https://publish-01.obsidian.md/access/a392b8cd24cdb828b4d4118fa8fc87d0/attachments/profile.png"></a><a class="site-header-text" href="https://knifecoat.com/Home">KnifeCoat</a></div><div class="render-container"><div class="render-container-inner"><div class="publish-renderer"><div class="markdown-preview-view markdown-rendered node-insert-event" tabindex="-1" style="outline: none;"><div class="markdown-preview-sizer markdown-preview-section" style="padding-bottom: 0px;"><div class="markdown-preview-pusher" style="width: 1px; height: 0.1px; margin-bottom: 0px;"></div><div class="mod-header mod-ui"></div><div class="el-pre mod-frontmatter mod-ui"><pre class="frontmatter" style="display: none;"><code class="language-yaml">tags:
  - Post
  - Windows
  - Exploit-Dev</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h1"><h1 data-heading="Intro" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Intro <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">Starting from Windows 22H2 (including 23H2 on insider) it is possible to use <code>IORING's</code> to create an arbitrary RW primitive. This assumes that you have a vulnerability that grants you an arbitrary write or some kind or increment. I will explain that in more detail below. This is all based on the excellent research done by <a data-tooltip-position="top" aria-label="https://twitter.com/yarden_shafir" rel="noopener nofollow" class="external-link" href="https://twitter.com/yarden_shafir" target="_blank">Yarden Shafir</a>, I have linked her posts about <code>IORING</code> below. My write-up skips a lot of details, it's more to have some colourful ex post facto notes. For more details about <code>IORING's</code> definitely consult the resources below. </p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><em>I/O Rings â€“ When One I/O Operation is Not Enough</em> - <a data-tooltip-position="top" aria-label="https://windows-internals.com/i-o-rings-when-one-i-o-operation-is-not-enough/" rel="noopener nofollow" class="external-link" href="https://windows-internals.com/i-o-rings-when-one-i-o-operation-is-not-enough/" target="_blank">here</a></li>
<li data-line="1" dir="auto"><em>IoRing vs. io_uring: a comparison of Windows and Linux implementations</em> - <a data-tooltip-position="top" aria-label="https://windows-internals.com/ioring-vs-io_uring-a-comparison-of-windows-and-linux-implementations/" rel="noopener nofollow" class="external-link" href="https://windows-internals.com/ioring-vs-io_uring-a-comparison-of-windows-and-linux-implementations/" target="_blank">here</a></li>
<li data-line="2" dir="auto"><em>One Year to I/O Ring: What Changed?</em> - <a data-tooltip-position="top" aria-label="https://windows-internals.com/one-year-to-i-o-ring-what-changed/" rel="noopener nofollow" class="external-link" href="https://windows-internals.com/one-year-to-i-o-ring-what-changed/" target="_blank">here</a></li>
<li data-line="3" dir="auto"><em>One I/O Ring to Rule Them All: A Full Read/Write Exploit Primitive on Windows 11</em> - <a data-tooltip-position="top" aria-label="https://windows-internals.com/one-i-o-ring-to-rule-them-all-a-full-read-write-exploit-primitive-on-windows-11/" rel="noopener nofollow" class="external-link" href="https://windows-internals.com/one-i-o-ring-to-rule-them-all-a-full-read-write-exploit-primitive-on-windows-11/" target="_blank">here</a></li>
</ul></div><div class="el-h1"><h1 data-heading="Setup" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Setup <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">You can create <code>IORING</code> objects with the following API.</p></div><div class="el-pre"><pre><code data-line="0" class="language-cs">[DllImport("kernelbase.dll")]  
internal static extern UInt32 CreateIoRing(  
    IORING_VERSION ioringVersion,  
    IORING_CREATE_FLAGS flags,  
    UInt32 submissionQueueSize,  
    UInt32 completionQueueSize,  
    ref IntPtr hRing);
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The most salient detail here is that the <code>IORING_VERSION</code> is important. The version of the <code>IORING</code> dictates what capabilities it has.</p></div><div class="el-pre"><pre><code data-line="0" class="language-cs">internal enum IORING_VERSION  
{  
    IORING_VERSION_INVALID = 0,  
    IORING_VERSION_1, // Read (21H2)
    IORING_VERSION_2, // Has a bugfix, I think, for v1 (21H2)
    IORING_VERSION_3 = 300 // Read, Write, Flush, Drain (22H2)
}
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">This primitive can technically be used, in part, from <code>21H2</code>. Counterintuitively, having <code>READ</code> permissions actually grants you <code>KM Write</code> and vice versa.</p></div><div class="el-p"><p dir="auto">When you create an <code>IORING</code> you get back a handle to interact with the object. This is not a <em>real handle</em> it is a pointer to a UM object for your <code>IORING</code>.</p></div><div class="el-pre"><pre><code data-line="0" class="language-cs">[StructLayout(LayoutKind.Sequential)]  
internal struct HIORING  
{  
    public IntPtr handle;  
    public NT_IORING_INFO Info;  
    public UInt32 IoRingKernelAcceptedVersion;  
    public IntPtr RegBufferArray;   // Pointer to array of IORING opperations
    public UInt32 BufferArraySize;  // Size of array of opperation pointers
    public IntPtr Unknown;  
    public UInt32 FileHandlesCount;  
    public UInt32 SubQueueHead;  
    public UInt32 SubQueueTail;  
}
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">At the same time a kernel object is also created.</p></div><div class="el-pre"><pre><code data-line="0" class="language-c">1: kd&gt; dt *!*IORING*
.....
1: kd&gt; dt ntkrnlmp!_IORING_OBJECT
   +0x000 Type             : Int2B
   +0x002 Size             : Int2B
   +0x008 UserInfo         : _NT_IORING_INFO
   +0x038 Section          : Ptr64 Void
   +0x040 SubmissionQueue  : Ptr64 _NT_IORING_SUBMISSION_QUEUE
   +0x048 CompletionQueueMdl : Ptr64 _MDL
   +0x050 CompletionQueue  : Ptr64 _NT_IORING_COMPLETION_QUEUE
   +0x058 ViewSize         : Uint8B
   +0x060 InSubmit         : Int4B
   +0x068 CompletionLock   : Uint8B
   +0x070 SubmitCount      : Uint8B
   +0x078 CompletionCount  : Uint8B
   +0x080 CompletionWaitUntil : Uint8B
   +0x088 CompletionEvent  : _KEVENT
   +0x0a0 SignalCompletionEvent : UChar
   +0x0a8 CompletionUserEvent : Ptr64 _KEVENT
   +0x0b0 RegBuffersCount  : Uint4B // Size of array of opperation pointers
   +0x0b8 RegBuffers       : Ptr64 Ptr64 _IOP_MC_BUFFER_ENTRY // Pointer to array of opperations
   +0x0c0 RegFilesCount    : Uint4B
   +0x0c8 RegFiles         : Ptr64 Ptr64 Void
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">You can then queue read and write operations for your <code>IORING</code>.</p></div><div class="el-pre"><pre><code data-line="0" class="language-cs">// Read data from a "file", can be used to overwrite data from the file at an arbitrary KM address

[DllImport("kernelbase.dll")]  
internal static extern UInt32 BuildIoRingReadFile(  
    IntPtr ioRing,  
    ref IORING_HANDLE_REF fileRef,  
    ref IORING_BUFFER_REF dataRef,  
    UInt32 numberOfBytesToRead,  
    UInt64 fileOffset,  
    IntPtr userData,  
    UInt32 sqeFlags);  

// Write data to a "file", can be used to write KM Memory to a file

[DllImport("kernelbase.dll")]  
internal static extern UInt32 BuildIoRingWriteFile(  
    IntPtr ioRing,  
    ref IORING_HANDLE_REF fileRef,  
    ref IORING_BUFFER_REF bufferRef,  
    UInt32 numberOfBytesToWrite,  
    UInt64 fileOffset,  
    FILE_WRITE_FLAGS writeFlags,  
    IntPtr userData,  
    UInt32 sqeFlags);
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Remember there is an array of max possible IO operations. For example if the number of operations is <code>0x5</code> then <code>RegBuffersCount</code> would be <code>0x5</code> and the buffer itself will be <code>0x5 * IntPtr.Size</code> in length.</p></div><div class="el-p"><p dir="auto">Finally you can submit your IO operations to trigger their use.</p></div><div class="el-pre"><pre><code data-line="0" class="language-cs">[DllImport("kernelbase.dll")]  
internal static extern UInt32 SubmitIoRing(  
    IntPtr ioRing,  
    UInt32 waitOperations,  
    UInt32 milliseconds,  
    ref UInt32 submittedEntries);
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h1"><h1 data-heading="How about pwn?" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>How about pwn? <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">So what is the idea here? Well, when you initialize your <code>IORING</code>, at that point the Kernel mode object will have empty placeholders for <code>RegBuffers</code> and <code>RegBuffersCount</code> (provided you don't pre-register a buffer).</p></div><div class="el-p"><p dir="auto">If you have a Kernel bug which gives you an arbitrary write or an increment then you can set values for those properties on the KM object (<code>_IORING_OBJECT</code>). The only thing you have to keep in mind is that you must be able to alloc data at the pointer that you specify in <code>RegBuffers</code>. Typically this will be a UM address you actually allocate (like with <code>NtAllocateVirtualMemory</code>). Keep in mind that you can provide a preferred base address to your allocator, you will need to do that if your bug is an arbitrary increment. As for the length, you only really need <code>0x8</code> bytes as you don't need to queue many operations (just one at a time). In my POC I continuously update the first array entry to read or write.</p></div><div class="el-p"><p dir="auto">What then are you allocating? It's not too complicated, the IO operations structs look like so:</p></div><div class="el-pre"><pre><code data-line="0" class="language-cs">[StructLayout(LayoutKind.Sequential)]  
internal struct IOP_MC_BUFFER_ENTRY  
{  
    public UInt16 Type;  
    public UInt16 Reserved;  
    public UInt32 Size;  
    public UInt32 ReferenceCount;  
    public UInt32 Flags;  
    public LIST_ENTRY GlobalDataLink;  
    public IntPtr Address; // Address to Read or Write
    public UInt32 Length;  // Amount of data to Read or Write
    public Byte AccessMode;  
    public UInt32 MdlRef;  
    public IntPtr Mdl;  
    [MarshalAs(UnmanagedType.ByValArray, SizeConst = 0x18)]  
    public Byte[] MdlRundownEvent; // _KEVENT  
    public IntPtr PfnArray;  
    [MarshalAs(UnmanagedType.ByValArray, SizeConst = 0x20)]  
    public Byte[] PageNodes;  
}
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Finally, once you have overwritten the KM <code>_IORING_OBJECT</code>, don't forget to set the same properties on the UM object (<code>HIORING.RegBufferArray</code> and <code>HIORING.BufferArraySize</code>). You should be able to do this because you created the <code>IORING</code> object and got the handle back which points at that UM structure.</p></div><div class="el-p"><p dir="auto">Then the idea becomes more clear:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><em>BuildIoRingReadFile</em> : Read data from a file handle, write that data at <code>IOP_MC_BUFFER_ENTRY.Address</code> for a length of <code>IOP_MC_BUFFER_ENTRY.Length</code>. This gives you arbitrary KM write.</li>
<li data-line="1" dir="auto"><em>BuildIoRingWriteFile</em>: Read data at <code>IOP_MC_BUFFER_ENTRY.Address</code> for a length of <code>IOP_MC_BUFFER_ENTRY.Length</code>, write that data to a file handle. This gives you arbitrary KM Read.</li>
<li data-line="2" dir="auto">As the "file" target you can create an actual file but the really elegant thing that Yarden does is use named pipes. This is possible because these pipes are technically just file objects. You can then read Kernel data from the pipe or write Kernel data to the pipe.</li>
</ul></div><div class="el-p"><p dir="auto"><span alt="giphy.gif" src="giphy.gif" class="internal-embed image-embed is-loaded"><img alt="giphy.gif" src="https://publish-01.obsidian.md/access/a392b8cd24cdb828b4d4118fa8fc87d0/Posts/attachments/giphy.gif"></span></p></div><div class="el-h1"><h1 data-heading="A guided tour in KD" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>A guided tour in KD <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">I just want to show some of these things in KD because it will make more sense. Here is the KM object for the <code>IORING</code> at creation time.</p></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20221120235232.png" src="Pasted image 20221120235232.png" class="internal-embed image-embed is-loaded"><img alt="Pasted image 20221120235232.png" src="https://publish-01.obsidian.md/access/a392b8cd24cdb828b4d4118fa8fc87d0/Posts/attachments/Pasted%20image%2020221120235232.png"></span></p></div><div class="el-p"><p dir="auto">Note that the <code>RegBuffers</code> and <code>RegBuffersCount</code> fields are empty.</p></div><div class="el-p"><p dir="auto">Then I trigger an arbitrary KM write bug to update those fields and set the count (<code>0x100</code>) and UM buffer (<code>0x000001f600310000</code>).</p></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20221120235644.png" src="Pasted image 20221120235644.png" class="internal-embed image-embed is-loaded"><img alt="Pasted image 20221120235644.png" src="https://publish-01.obsidian.md/access/a392b8cd24cdb828b4d4118fa8fc87d0/Posts/attachments/Pasted%20image%2020221120235644.png"></span></p></div><div class="el-p"><p dir="auto">Remember here that the buffer points at an array of structures. In this case the buffer has a length of <code>0x100 * IntPtr.Size</code> but remember that I said you only need a single entry. Note that here I have a friendly arbitrary write bug but if you have an increment you should have the allocator give you a more beautiful address, like <code>0x0000000001000000</code> ðŸ˜‰.</p></div><div class="el-p"><p dir="auto">Then later we queue an IO operation by writing the structure pointer to our UM buffer. Lets have a look at what the KM object looks like now. (Ignore the updated address, this is a different runtime of the POC).</p></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20221121000813.png" src="Pasted image 20221121000813.png" class="internal-embed image-embed is-loaded"><img alt="Pasted image 20221121000813.png" src="https://publish-01.obsidian.md/access/a392b8cd24cdb828b4d4118fa8fc87d0/Posts/attachments/Pasted%20image%2020221121000813.png"></span><br>
Notice that <code>RegBuffers</code> now no longer points at an empty buffer but that there is indeed a single IO operation structure (<code>_IOP_MC_BUFFER_ENTRY</code>) that was queued.</p></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20221121001018.png" src="Pasted image 20221121001018.png" class="internal-embed image-embed is-loaded"><img alt="Pasted image 20221121001018.png" src="https://publish-01.obsidian.md/access/a392b8cd24cdb828b4d4118fa8fc87d0/Posts/attachments/Pasted%20image%2020221121001018.png"></span></p></div><div class="el-p"><p dir="auto">We manually build this <code>struct</code> in our POC and write the pointer to the UM buffer (index 0 of the <code>RegBuffers</code> array). By just looking at the struct we can't tell if this is a read or a write operation but we can see that the target of the operation is at a Kernel address (<code>0xfffff8055a11da20</code>) and that the size of the operation is <code>0x8</code>. We are either reading 8 bytes at the address or overwriting 8 bytes at the address, depending on which function we called.</p></div><div class="el-h3"><h3 data-heading="Clean-up" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Clean-up <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h3></div><div class="el-p"><p dir="auto">When your process terminates you will bluescreen, this is because the <code>RegBuffers</code> pointer is not null and the kernel will try to free that address on exit. To avoid this you can use the <code>IORING</code> write primitive to set the <code>RegBuffers</code> pointer back to null before exiting.</p></div><div class="el-h1"><h1 data-heading="POC" dir="auto" class="publish-article-heading"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>POC <span class="clickable-icon" aria-label="Copy link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span></h1></div><div class="el-p"><p dir="auto">Here is a short video of the POC in action.</p></div><div class="el-iframe"><div allowfullscreen="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" frameborder="0" title="YouTube video player" src="cid:frame-1038F57D29028080D8E318C54423731F@mhtml.blink" height="315" width="100%" sandbox="allow-forms allow-modals allow-presentation allow-popups allow-same-origin allow-scripts" data-original-tag="iframe"></div></div><div class="mod-footer mod-ui"></div></div></div><div class="extra-title"><span class="extra-title-text">Arbitrary Kernel RW using IORING's</span><span aria-label="Close page" role="button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></span></div></div></div><div class="not-found-container" style="display: none;"><div class="not-found-image"></div><div class="not-found-title">Not found</div><div class="not-found-description">This page does not exist</div></div><div class="site-body-right-column"><div class="site-body-right-column-inner"><div class="graph-view-outer"><div class="list-item published-section-header"><span class="published-section-header-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-git-fork"><circle cx="12" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="6" r="3"></circle><path d="M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9"></path><path d="M12 12v3"></path></svg></span><span>Interactive graph</span></div><div class="graph-view-container"><div class="graph-view" style="display: none;"></div><div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-arrow-up-right"><path d="M7 7h10v10"></path><path d="M7 17 17 7"></path></svg></div><div class="graph-icon graph-global" role="button" aria-label="Global Graph" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-git-fork"><circle cx="12" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="6" r="3"></circle><path d="M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9"></path><path d="M12 12v3"></path></svg></div></div></div><div class="outline-view-outer node-insert-event"><div class="list-item published-section-header"><span class="published-section-header-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-list"><path d="M3 5h.01"></path><path d="M3 12h.01"></path><path d="M3 19h.01"></path><path d="M8 5h13"></path><path d="M8 12h13"></path><path d="M8 19h13"></path></svg></span><span>On this page</span></div><div class="outline-view"><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">Intro</div></div><div class="tree-item-children"></div></div><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">Setup</div></div><div class="tree-item-children"></div></div><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">How about pwn?</div></div><div class="tree-item-children"></div></div><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">A guided tour in KD</div></div><div class="tree-item-children"><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">Clean-up</div></div><div class="tree-item-children"></div></div></div></div><div class="tree-item"><div class="tree-item-self is-clickable"><div class="tree-item-inner">POC</div></div><div class="tree-item-children"></div></div></div></div></div></div></div><div class="site-footer"><a href="https://publish.obsidian.md/" target="_blank">Powered by Obsidian Publish</a></div></div></div><div class="nav-backdrop"></div></div></body></html>