Title:
Tale of Code Integrity & Driver Loads

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post analyzes how Windows “Core Isolation” settings—specifically Memory Integrity (HVCI) and the Microsoft vulnerable driver blocklist—change the execution path of kernel driver loading.  
- It walks through the end-to-end chain from `sc.exe` → `StartServiceW` (SecHost.dll) → SCM RPC (`services.exe`, MS-SCMR) → `Nt/ZwLoadDriver` and then into kernel-mode validation logic.  
- Using a known vulnerable driver as an example, it shows that enabling HVCI or the driver blocklist causes the load to fail due to signature/allowlist enforcement, returning `NTSTATUS 0xC0000603` (revoked/unverifiable signature).  
- The author demonstrates debugging a PPL-protected `services.exe` by clearing the `EPROCESS->Protection` field via local kernel debugging to trace the RPC call path.  
- In kernel debugging, the post identifies `MiValidateSectionSigningPolicy` as the decision point that checks the user configuration and conditionally calls deeper validation (`MiValidateSectionCreate` → `SeValidateImageHeader`).  
- Useful for Windows internals researchers, red teamers validating BYOVD feasibility, and defenders wanting to understand where driver blocklist enforcement occurs.

Technical Focus:
- VBS / HVCI (Hypervisor-Protected Code Integrity) and Core Isolation settings
- Windows driver load pipeline (`sc.exe`/SCM RPC → `NtLoadDriver`)
- PPL (Protected Process Light) debugging via `EPROCESS->Protection` manipulation
- Kernel code integrity enforcement (`MiValidateSectionSigningPolicy`, `SeValidateImageHeader`)
- NTSTATUS-based failure analysis (`0xC0000603`)
- Kernel debugging with KDNET/WinDbg

Use Cases:
- Determine whether a target host’s Core Isolation settings will block known-vulnerable drivers (BYOVD scenarios)
- Map and instrument the exact user-mode to kernel-mode call chain for driver loading
- Build detections around driver-load failures and CI enforcement points
- Reproduce and validate driver blocklist behavior in lab environments
- Support reverse engineering/tracing of Windows CI policy decisions

Keywords:
Windows Core Isolation, VBS, HVCI, Memory Integrity, Driver Blocklist, BYOVD, sc.exe, Service Control Manager, MS-SCMR, services.exe, SecHost.dll, StartServiceW, RPC, NtLoadDriver, ZwLoadDriver, PPL, EPROCESS Protection, kernel debugging, KDNET, WinDbg, MiValidateSectionSigningPolicy, MiValidateSectionCreate, SeValidateImageHeader, Code Integrity, NTSTATUS 0xC0000603, revoked certificate, driver signature enforcement, SLAT, EPT