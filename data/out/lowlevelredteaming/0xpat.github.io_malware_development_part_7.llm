Title:
Malware development part 7 – Secure Desktop keylogger

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post explains Windows “Secure Desktop” (e.g., UAC prompts and Winlogon UI) and how malware can target it to capture keystrokes.  
- It describes how desktops like `WINSTA0\DEFAULT` and `WINSTA0\WINLOGON` are isolated, and why normal user-mode keyloggers can’t see Secure Desktop input.  
- The author shows that a process can be created on a specific desktop via `CreateProcess` using `STARTUPINFO.lpDesktop`, assuming sufficient permissions.  
- A basic keylogger is implemented using `SetWindowsHookEx` with the `WH_KEYBOARD_LL` low-level keyboard hook and a message loop (`GetMessage`).  
- The key point is that if an attacker elevates to SYSTEM (or otherwise gains the required rights), they can run the hook on the Winlogon desktop and capture credentials typed into Secure Desktop prompts.  
- Useful primarily for malware developers and red teamers studying Windows UI isolation boundaries and credential interception opportunities.

Technical Focus:
- Windows Secure Desktop / Winlogon desktop isolation (`WINSTA0\WINLOGON`)
- Process creation on alternate desktops (`CreateProcess`, `STARTUPINFO.lpDesktop`)
- Low-level keyboard hooks (`SetWindowsHookEx`, `WH_KEYBOARD_LL`)
- Windows message loop requirements for hooks (`GetMessage`)
- Keystroke decoding (`KBDLLHOOKSTRUCT`, `GetKeyNameText`, `WM_KEY*` / `WM_SYSKEY*`)

Use Cases:
- Building a proof-of-concept Secure Desktop keylogger after privilege escalation
- Researching credential theft paths involving UAC/Winlogon UI
- Testing defensive monitoring around desktop switching and hook installation
- Training material for Windows internals and GUI security boundaries

Keywords:
Windows Secure Desktop, WINSTA0\\WINLOGON, WINSTA0\\DEFAULT, Winlogon, UAC, ConsentPromptBehaviorUser, ConsentPromptBehaviorAdmin, CreateProcessA, STARTUPINFO, lpDesktop, SetWindowsHookExA, WH_KEYBOARD_LL, KBDLLHOOKSTRUCT, GetMessageA, GetKeyNameTextA, WM_KEYDOWN, WM_KEYUP, WM_SYSKEYDOWN, SYSTEM privileges