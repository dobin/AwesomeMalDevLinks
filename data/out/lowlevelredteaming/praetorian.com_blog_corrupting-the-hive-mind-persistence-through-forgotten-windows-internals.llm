Title:
Corrupting the Hive Mind: Persistence Through Forgotten Windows Internals

Type:
Blog Post

Short Summary (4–8 sentences max):
- The post describes a low-privilege Windows persistence technique that avoids noisy registry API telemetry by modifying a user’s registry hive offline rather than calling standard `RegSetValue`/`RegCreateKey` APIs.  
- It abuses Mandatory User Profiles by dropping a crafted `NTUSER.MAN` into `%USERPROFILE%`, which takes precedence over `NTUSER.DAT` at next logon and can contain attacker-controlled HKCU autoruns.  
- The core enabler is the Offline Registry Library (`Offreg.dll`) and its `OR*` APIs (`OROpenHive`, `ORCreateKey`, `ORSetValue`, `ORSaveHive`) to build/modify a binary hive without touching the live registry.  
- Praetorian releases “Swarmer,” a tool that converts exported HKCU data (from `reg export` or BOF-based registry dumping) into a valid `NTUSER.MAN`, including an option to add a startup entry automatically.  
- Implementation details include using `RegLoadAppKeyW` to generate an initial hive file Windows will accept, then populating it via Offreg APIs.  
- It’s useful for red teams/offensive operators seeking stealthier per-user persistence, and for defenders to understand detection points like unexpected `NTUSER.MAN` creation and anomalous `Offreg.dll` loads.

Technical Focus:
- Mandatory User Profiles (`NTUSER.MAN`) hive precedence over `NTUSER.DAT`
- Offline Registry Library (`Offreg.dll`) and `OR*` offline hive manipulation APIs
- EDR evasion by avoiding standard Win32 Registry APIs and common run-key telemetry
- HKCU persistence via offline hive crafting and logon-time activation
- `RegLoadAppKeyW`-based hive initialization and C#/PInvoke implementation

Use Cases:
- Establish stealthier per-user persistence without direct `RegSetValue` calls
- Generate/modify HKCU autorun entries offline on an operator machine, then deploy the hive
- Post-exploitation persistence in environments with strong registry API monitoring
- Defensive hunting for `NTUSER.MAN` creation and suspicious `Offreg.dll` usage
- Testing EDR coverage gaps around offline hive editing and logon-time hive loading

Keywords:
Windows internals, persistence, registry hive, HKCU, NTUSER.DAT, NTUSER.MAN, Mandatory User Profile, Offreg.dll, Offline Registry Library, OROpenHive, ORCreateKey, ORSetValue, ORSaveHive, RegLoadAppKeyW, Run key, EDR evasion, BOF, reg export, C# P/Invoke, logon persistence