# https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/

<!DOCTYPE html><html lang="en-US"><body data-header-desktop="fixed" data-header-mobile="auto"><div id="mask"></div><div class="wrapper"><main class="main"><div class="container"><div class="toc" id="toc-auto" style="left: 1916px; visibility: visible; position: absolute; top: 100px;"><h2 class="toc-title">Contents</h2><div class="toc-content" id="toc-content-auto"></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Writing Beacon Object Files Without DFR</h1><div class="post-meta"><div class="post-meta-line"><span class="post-author"><a href="https://blog.cybershenanigans.space/whoami/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Matt Ehrnschwender</a></span></div><div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2024-11-18">2024-11-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;5347 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;26 minutes&nbsp;</div></div><div class="details toc" id="toc-static" data-kept=""><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span></div><div class="details-content toc-content" id="toc-content-static"></div></div><div class="content" id="content"><h2 id="intro" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#intro" class="header-mark"></a>Intro</h2><p><a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/beacon-object-files_main.htm" target="_blank" rel="noopener noreffer">Beacon Object Files</a> have become very popular for red teams to add additional capabilities on the fly without needing to include the overhead of a reflective DLL or .NET assembly. This advantage comes at the cost of Beacon Object Files being a little bit awkward to develop. One development quirk is the need to prefix imported symbols with the associated library name where the symbol can be found. This concept, known as <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/beacon-object-files_dynamic-func-resolution.htm" target="_blank" rel="noopener noreffer">Dynamic Function Resolution</a> (or DFR), is how the BOF tells the BOF loader where to find external symbols.</p><p>What if I told you that you do not need to write these DFR prototypes in your code when developing BOFs?</p><p><img class="lazyautosizes lazyloaded" src="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/images/meme.jpg" data-src="/posts/writing-bofs-without-dfr/images/meme.jpg" data-srcset="/posts/writing-bofs-without-dfr/images/meme.jpg, /posts/writing-bofs-without-dfr/images/meme.jpg 1.5x, /posts/writing-bofs-without-dfr/images/meme.jpg 2x" data-sizes="auto" alt="/posts/writing-bofs-without-dfr/images/meme.jpg" title="meme.jpg" width="525" height="475"></p><h2 id="tl-dr" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#tl-dr" class="header-mark"></a>TL; DR</h2><p><a href="https://www.man7.org/linux/man-pages/man1/objcopy.1.html" target="_blank" rel="noopener noreffer">objcopy</a> supports redefining symbol names in object files using the <code>--redefine-sym</code> or <code>--redefine-syms</code> flag. This can be used to translate imported symbols from the normal system definition to the DFR format during post-processing.</p><h2 id="the-need-for-dfr" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#the-need-for-dfr" class="header-mark"></a>The Need For DFR</h2><p>An important thing to note about Beacon Object Files is that the resulting file a BOF loader loads is a generic <a href="https://en.wikipedia.org/wiki/COFF" target="_blank" rel="noopener noreffer">COFF</a> file. This may seem rather obvious to people who have written BOFs before, but it is important to note because it helps identify what exactly a BOF loader has to work with and what data it lacks.</p><p>One piece of information that a COFF contains is a <a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#coff-symbol-table" target="_blank" rel="noopener noreffer">symbol table</a>. This is an array of structures listing both the symbols that the COFF defines and the external symbols that the COFF requires. Each symbol definition includes the name of the symbol as is declared in the source file itself. What the symbol table lacks is the name of the external library where the symbol can be found. The linker’s job is to take these symbols from the symbol table and search for them in a predefined set of libraries. Since BOFs do not go through a linking stage, this job is passed on to the BOF loader. Linkers will perform a brute-force style search to locate these symbols which is not the most ideal approach for a BOF loader.</p><p>This is where the DFR concept comes into play. Instead of performing this brute-force search every single time a BOF is loaded, the library names are instead integrated directly into the symbol name. The way this is done is by prefixing the symbol name with the library name and separating them with a dollar sign (<code>$</code>). For example, if a BOF requires the symbol <code>CreateFileA</code> and that symbol lives in <code>kernel32.dll</code>, the BOF would instead define the symbol <code>KERNEL32$CreateFileA</code> and the BOF loader will know to search for the <code>CreateFileA</code> symbol in <code>kernel32</code>.</p><h2 id="dfr-issues" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#dfr-issues" class="header-mark"></a>DFR Issues</h2><p>This method of prepending the library name along with the symbol name works and has been the pretty standard way of defining imports in BOFs but there can be some issues with this approach.</p><h3 id="mismatched-prototypes" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#mismatched-prototypes" class="header-mark"></a>Mismatched Prototypes</h3><p>Since an already declared symbol needs to be redeclared using the DFR format, this manual redeclaration could potentially not match the original one exactly due to a typo. For basic functions, this error may be easy to find but for more complicated functions, it can be a little bit more difficult to identify.</p><p>Some functions in the Windows API are known to include a rather large number of parameters. Take <a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createprocesswithlogonw" target="_blank" rel="noopener noreffer">CreateProcessWithLogonW</a> as an example. This is what the DFR declaration would look like in order to use this function in a BOF.</p><div class="highlight"><div class="chroma open"><div class="code-header language-c"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="DECLSPEC_IMPORT BOOL WINAPI ADVAPI32$CreateProcessWithLogonW(
	LPCWSTR lpUsername,
	LPCWSTR lpDomain,
	LPCWSTR lpPassword,
	DWORD dwLogonFlags,
	LPCWSTR lpApplicationName,
	LPWSTR lpCommandLine,
	DWORD dwCreationFlags,
	LPVOID lpEnvironment,
	LPCWSTR lpCurrentDirectory,
	LPSTARTUPINFOW lpStartupInfo,
	LPPROCESS_INFORMATION lpProcessInformation);
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">DECLSPEC_IMPORT</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">ADVAPI32</span><span class="err">$</span><span class="nf">CreateProcessWithLogonW</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPCWSTR</span> <span class="n">lpUsername</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPCWSTR</span> <span class="n">lpDomain</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPCWSTR</span> <span class="n">lpPassword</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">dwLogonFlags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPCWSTR</span> <span class="n">lpApplicationName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPWSTR</span> <span class="n">lpCommandLine</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">dwCreationFlags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPVOID</span> <span class="n">lpEnvironment</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPCWSTR</span> <span class="n">lpCurrentDirectory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPSTARTUPINFOW</span> <span class="n">lpStartupInfo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPPROCESS_INFORMATION</span> <span class="n">lpProcessInformation</span><span class="p">);</span>
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>If a parameter is swapped, omitted, or the type is wrong in the declaration, the function may not behave how it is expected to behave. The exact issue that occurs will depend on what part of the declaration is incorrect. In some cases, the function may work during one run but fail in another one. Like with many things related to C development, it just depends on how the computer is feeling at that moment in time if it is going to work or not ¯\_(ツ)_/¯.</p><p>Regardless of what error is returned when this type of issue occurs, this mistake can only be spotted by manually reviewing the code and double checking that the DFR prototype matches the original one exactly.</p><h4 id="c-the-savior" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#c-the-savior" class="header-mark"></a>C++, the Savior</h4><p>In the <a href="https://www.cobaltstrike.com/blog/simplifying-bof-development" target="_blank" rel="noopener noreffer">“Simplifying BOF Development: Debug, Test, and Save Your B(e)acon”</a> blog post by Fortra, <a href="https://x.com/HenriNurmi" target="_blank" rel="noopener noreffer">Henri Nurmi</a> mentioned using the C++11 <a href="https://en.cppreference.com/w/cpp/language/decltype" target="_blank" rel="noopener noreffer">decltype</a> specifier to help solve this issue.</p><p>This pattern is less error-prone since the new DFR symbol declaration is constructed directly from the original one.</p><p>The same <code>CreateProcessWithLogonW</code> prototype would look something like this using decltype.</p><div class="highlight"><div class="chroma open"><div class="code-header language-c"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="DECLSPEC_IMPORT decltype(CreateProcessWithLogonW) ADVAPI32$CreateProcessWithLogonW;
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">DECLSPEC_IMPORT</span> <span class="nf">decltype</span><span class="p">(</span><span class="n">CreateProcessWithLogonW</span><span class="p">)</span> <span class="n">ADVAPI32</span><span class="err">$</span><span class="n">CreateProcessWithLogonW</span><span class="p">;</span>
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>The original function prototype does not need to be manually rewritten since it is provided by decltype.</p><p>The caveat here is that you need a C++ compiler to compile the BOF so it requires dealing with some C++ specific nuances like <a href="https://learn.microsoft.com/en-us/cpp/build/reference/decorated-names?view=msvc-170" target="_blank" rel="noopener noreffer">name mangling</a> but it does make declaring DFR prototypes a lot easier.</p><h3 id="executable-generation" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#executable-generation" class="header-mark"></a>Executable Generation</h3><p>During the testing phases of developing a BOF, it is helpful to compile the code into an executable or integrate it into a testing framework. Adding the DFR specification to imported symbols means that they will not be resolvable by the system linker. The system linker is unaware of the DFR format and interprets the <code>&lt;library&gt;$&lt;symbol&gt;</code> value as the symbol name itself.</p><p>There are some workarounds for this.</p><hr><p>Filename: <code>examplebof.c</code></p><div class="highlight"><div class="chroma open"><div class="code-header language-c"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="#include <windows.h>
#include <lmcons.h>

#include &quot;beacon.h&quot;

DECLSPEC_IMPORT DWORD WINAPI KERNEL32$GetCurrentProcessId(void);
DECLSPEC_IMPORT BOOL WINAPI ADVAPI32$GetUserNameA(LPSTR, LPDWORD);

void go(void) {
    DWORD pid = KERNEL32$GetCurrentProcessId();
    BeaconPrintf(CALLBACK_OUTPUT, &quot;Current process id: %lu&quot;, pid);

    char username[UNLEN + 1] = {0};
    if (ADVAPI32$GetUserNameA(username, &amp;(DWORD){ sizeof(username) }) == TRUE) {
        BeaconPrintf(CALLBACK_OUTPUT, &quot;Username: %s&quot;, username);
    }
}

// Main function for building as an executable
int main() {
    go();
    return 0;
}
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;lmcons.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">"beacon.h"</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">DECLSPEC_IMPORT</span> <span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="n">KERNEL32</span><span class="err">$</span><span class="nf">GetCurrentProcessId</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECLSPEC_IMPORT</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">ADVAPI32</span><span class="err">$</span><span class="nf">GetUserNameA</span><span class="p">(</span><span class="n">LPSTR</span><span class="p">,</span> <span class="n">LPDWORD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">go</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">KERNEL32</span><span class="err">$</span><span class="nf">GetCurrentProcessId</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">BeaconPrintf</span><span class="p">(</span><span class="n">CALLBACK_OUTPUT</span><span class="p">,</span> <span class="s">"Current process id: %lu"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">username</span><span class="p">[</span><span class="n">UNLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ADVAPI32</span><span class="err">$</span><span class="nf">GetUserNameA</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">DWORD</span><span class="p">){</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="p">})</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BeaconPrintf</span><span class="p">(</span><span class="n">CALLBACK_OUTPUT</span><span class="p">,</span> <span class="s">"Username: %s"</span><span class="p">,</span> <span class="n">username</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Main function for building as an executable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">go</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div></div><hr><p>Attempting to compile this example BOF as an executable throws <code>undefined reference</code> errors when linking.</p><div class="highlight"><div class="chroma open"><div class="code-header language-bash"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example >> x86_64-w64-mingw32-gcc -o examplebof.exe examplebof.c
/usr/lib/gcc/x86_64-w64-mingw32/14.1.1/../../../../x86_64-w64-mingw32/bin/ld: /tmp/ccQizFTo.o:examplebof.c:(.text+0x14): undefined reference to `__imp_KERNEL32$GetCurrentProcessId'
/usr/lib/gcc/x86_64-w64-mingw32/14.1.1/../../../../x86_64-w64-mingw32/bin/ld: /tmp/ccQizFTo.o:examplebof.c:(.text+0x3b): undefined reference to `__imp_BeaconPrintf'
/usr/lib/gcc/x86_64-w64-mingw32/14.1.1/../../../../x86_64-w64-mingw32/bin/ld: /tmp/ccQizFTo.o:examplebof.c:(.text+0x73): undefined reference to `__imp_ADVAPI32$GetUserNameA'
/usr/lib/gcc/x86_64-w64-mingw32/14.1.1/../../../../x86_64-w64-mingw32/bin/ld: /tmp/ccQizFTo.o:examplebof.c:(.text+0x97): undefined reference to `__imp_BeaconPrintf'
collect2: error: ld returned 1 exit status
matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example 1 >>
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example &gt;&gt; x86_64-w64-mingw32-gcc -o examplebof.exe examplebof.c
</span></span><span class="line"><span class="cl">/usr/lib/gcc/x86_64-w64-mingw32/14.1.1/../../../../x86_64-w64-mingw32/bin/ld: /tmp/ccQizFTo.o:examplebof.c:<span class="o">(</span>.text+0x14<span class="o">)</span>: undefined reference to <span class="sb">`</span>__imp_KERNEL32<span class="nv">$GetCurrentProcessId</span><span class="s1">'
</span></span></span><span class="line"><span class="cl"><span class="s1">/usr/lib/gcc/x86_64-w64-mingw32/14.1.1/../../../../x86_64-w64-mingw32/bin/ld: /tmp/ccQizFTo.o:examplebof.c:(.text+0x3b): undefined reference to `__imp_BeaconPrintf'</span>
</span></span><span class="line"><span class="cl">/usr/lib/gcc/x86_64-w64-mingw32/14.1.1/../../../../x86_64-w64-mingw32/bin/ld: /tmp/ccQizFTo.o:examplebof.c:<span class="o">(</span>.text+0x73<span class="o">)</span>: undefined reference to <span class="sb">`</span>__imp_ADVAPI32<span class="nv">$GetUserNameA</span><span class="s1">'
</span></span></span><span class="line"><span class="cl"><span class="s1">/usr/lib/gcc/x86_64-w64-mingw32/14.1.1/../../../../x86_64-w64-mingw32/bin/ld: /tmp/ccQizFTo.o:examplebof.c:(.text+0x97): undefined reference to `__imp_BeaconPrintf'</span>
</span></span><span class="line"><span class="cl">collect2: error: ld returned <span class="m">1</span> <span class="nb">exit</span> status
</span></span><span class="line"><span class="cl">matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example <span class="m">1</span> &gt;&gt;
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>A common way of fixing this issue is by wrapping all of the DFR prototypes in an <code>#ifdef</code> macro and choosing which version of the symbol to use depending on if that macro is defined or not. The DFR symbol and the system symbol can be aliased to a common name in order to refer to the different variants based on the configuration.</p><hr><p>Filename: <code>examplebof.c</code></p><div class="highlight"><div class="chroma open"><div class="code-header language-c"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="#include <windows.h>
#include <lmcons.h>

#include &quot;beacon.h&quot;

#ifdef BOF
// Use DFR if `BOF` is defined

DECLSPEC_IMPORT DWORD WINAPI KERNEL32$GetCurrentProcessId(void);
#define kernel32_GetCurrentProcessId KERNEL32$GetCurrentProcessId

DECLSPEC_IMPORT BOOL WINAPI ADVAPI32$GetUserNameA(LPSTR, LPDWORD);
#define advapi32_GetUserNameA ADVAPI32$GetUserNameA

#else // BOF
// Do not use DFR if `BOF` is not defined

#define kernel32_GetCurrentProcessId GetCurrentProcessId
#define advapi32_GetUserNameA GetUserNameA

#endif // BOF

void go(void) {
    DWORD pid = kernel32_GetCurrentProcessId();
    BeaconPrintf(CALLBACK_OUTPUT, &quot;Current process id: %lu&quot;, pid);

    char username[UNLEN + 1] = {0};
    if (advapi32_GetUserNameA(username, &amp;(DWORD){ sizeof(username) }) == TRUE) {
        BeaconPrintf(CALLBACK_OUTPUT, &quot;Username: %s&quot;, username);
    }
}

#ifndef BOF
// Create a main function to wrap the BOF entrypoint
int main() {
    go();
    return 0;
}
#endif // BOF
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;lmcons.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">"beacon.h"</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef BOF
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Use DFR if `BOF` is defined
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">DECLSPEC_IMPORT</span> <span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="n">KERNEL32</span><span class="err">$</span><span class="nf">GetCurrentProcessId</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define kernel32_GetCurrentProcessId KERNEL32$GetCurrentProcessId
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">DECLSPEC_IMPORT</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">ADVAPI32</span><span class="err">$</span><span class="nf">GetUserNameA</span><span class="p">(</span><span class="n">LPSTR</span><span class="p">,</span> <span class="n">LPDWORD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define advapi32_GetUserNameA ADVAPI32$GetUserNameA
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#else </span><span class="c1">// BOF
</span></span></span><span class="line"><span class="cl"><span class="c1">// Do not use DFR if `BOF` is not defined
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define kernel32_GetCurrentProcessId GetCurrentProcessId
</span></span></span><span class="line"><span class="cl"><span class="cp">#define advapi32_GetUserNameA GetUserNameA
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">// BOF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">go</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">pid</span> <span class="o">=</span> <span class="nf">kernel32_GetCurrentProcessId</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">BeaconPrintf</span><span class="p">(</span><span class="n">CALLBACK_OUTPUT</span><span class="p">,</span> <span class="s">"Current process id: %lu"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">username</span><span class="p">[</span><span class="n">UNLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">advapi32_GetUserNameA</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">DWORD</span><span class="p">){</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="p">})</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BeaconPrintf</span><span class="p">(</span><span class="n">CALLBACK_OUTPUT</span><span class="p">,</span> <span class="s">"Username: %s"</span><span class="p">,</span> <span class="n">username</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef BOF
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Create a main function to wrap the BOF entrypoint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">go</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">// BOF
</span></span></span></code></pre></td></tr></tbody></table></div></div></div><hr><p>Passing in the <code>-DBOF</code> flag during compilation will use the DFR import declarations and omitting that flag will use the normal system declarations. Both of the symbols are aliased with <code>&lt;libname&gt;_&lt;symbol&gt;</code> so that the correct symbol is used when referring to them.</p><div class="highlight"><div class="chroma open"><div class="code-header language-bash"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="# For compiling with the BOF DFR imports
x86_64-w64-mingw32-gcc -DBOF -c -o examplebof.o examplebof.c

# For compiling the executable with the normal system imports
x86_64-w64-mingw32-gcc -o examplebof.exe examplebof.c
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># For compiling with the BOF DFR imports</span>
</span></span><span class="line"><span class="cl">x86_64-w64-mingw32-gcc -DBOF -c -o examplebof.o examplebof.c
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For compiling the executable with the normal system imports</span>
</span></span><span class="line"><span class="cl">x86_64-w64-mingw32-gcc -o examplebof.exe examplebof.c
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>Compiling it with a Makefile</p><hr><p>Filename: <code>Makefile</code></p><div class="highlight"><div class="chroma open"><div class="code-header language-makefile"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="CC = x86_64-w64-mingw32-gcc
RM = rm -vf

sources := examplebof.c
objs := $(sources:.c=.o)

.PHONY: all clean
all : examplebof.bof.o examplebof.exe
clean:
	$(RM) examplebof.bof.o examplebof.exe $(objs)

examplebof.o : examplebof.c beacon.h
examplebof.bof.o : examplebof.c beacon.h

%.bof.o : %.c
	$(CC) -DBOF $(CFLAGS) $(TARGET_ARCH) -c $(OUTPUT_OPTION) $<

% : %.o
%.exe : %.o
	$(LINK.o) $^ $(LDLIBS) -o $@
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nv">CC</span> <span class="o">=</span> x86_64-w64-mingw32-gcc
</span></span><span class="line"><span class="cl"><span class="nv">RM</span> <span class="o">=</span> rm -vf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">sources</span> <span class="o">:=</span> examplebof.c
</span></span><span class="line"><span class="cl"><span class="nv">objs</span> <span class="o">:=</span> <span class="k">$(</span>sources:.c<span class="o">=</span>.o<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span> <span class="n">clean</span>
</span></span><span class="line"><span class="cl"><span class="nf">all </span><span class="o">:</span> <span class="n">examplebof</span>.<span class="n">bof</span>.<span class="n">o</span> <span class="n">examplebof</span>.<span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="nf">clean</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>RM<span class="k">)</span> examplebof.bof.o examplebof.exe <span class="k">$(</span>objs<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">examplebof.o </span><span class="o">:</span> <span class="n">examplebof</span>.<span class="n">c</span> <span class="n">beacon</span>.<span class="n">h</span>
</span></span><span class="line"><span class="cl"><span class="nf">examplebof.bof.o </span><span class="o">:</span> <span class="n">examplebof</span>.<span class="n">c</span> <span class="n">beacon</span>.<span class="n">h</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">%.bof.o </span><span class="o">:</span> %.<span class="n">c</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>CC<span class="k">)</span> -DBOF <span class="k">$(</span>CFLAGS<span class="k">)</span> <span class="k">$(</span>TARGET_ARCH<span class="k">)</span> -c <span class="k">$(</span>OUTPUT_OPTION<span class="k">)</span> $&lt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">% </span><span class="o">:</span> %.<span class="n">o</span>
</span></span><span class="line"><span class="cl"><span class="nf">%.exe </span><span class="o">:</span> %.<span class="n">o</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>LINK.o<span class="k">)</span> $^ <span class="k">$(</span>LDLIBS<span class="k">)</span> -o <span class="nv">$@</span>
</span></span></code></pre></td></tr></tbody></table></div></div></div><hr><div class="highlight"><div class="chroma open"><div class="code-header language-bash"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example >> make
x86_64-w64-mingw32-gcc -DBOF   -c -o examplebof.bof.o examplebof.c
x86_64-w64-mingw32-gcc    -c -o examplebof.o examplebof.c
x86_64-w64-mingw32-gcc   examplebof.o  -o examplebof.exe
/usr/lib/gcc/x86_64-w64-mingw32/14.1.1/../../../../x86_64-w64-mingw32/bin/ld: examplebof.o:examplebof.c:(.text+0x3b): undefined reference to `__imp_BeaconPrintf'
/usr/lib/gcc/x86_64-w64-mingw32/14.1.1/../../../../x86_64-w64-mingw32/bin/ld: examplebof.o:examplebof.c:(.text+0x97): undefined reference to `__imp_BeaconPrintf'
collect2: error: ld returned 1 exit status
make: *** [Makefile:20: examplebof.exe] Error 1
matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example 2 >>
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example &gt;&gt; make
</span></span><span class="line"><span class="cl">x86_64-w64-mingw32-gcc -DBOF   -c -o examplebof.bof.o examplebof.c
</span></span><span class="line"><span class="cl">x86_64-w64-mingw32-gcc    -c -o examplebof.o examplebof.c
</span></span><span class="line"><span class="cl">x86_64-w64-mingw32-gcc   examplebof.o  -o examplebof.exe
</span></span><span class="line"><span class="cl">/usr/lib/gcc/x86_64-w64-mingw32/14.1.1/../../../../x86_64-w64-mingw32/bin/ld: examplebof.o:examplebof.c:<span class="o">(</span>.text+0x3b<span class="o">)</span>: undefined reference to <span class="sb">`</span>__imp_BeaconPrintf<span class="s1">'
</span></span></span><span class="line"><span class="cl"><span class="s1">/usr/lib/gcc/x86_64-w64-mingw32/14.1.1/../../../../x86_64-w64-mingw32/bin/ld: examplebof.o:examplebof.c:(.text+0x97): undefined reference to `__imp_BeaconPrintf'</span>
</span></span><span class="line"><span class="cl">collect2: error: ld returned <span class="m">1</span> <span class="nb">exit</span> status
</span></span><span class="line"><span class="cl">make: *** <span class="o">[</span>Makefile:20: examplebof.exe<span class="o">]</span> Error <span class="m">1</span>
</span></span><span class="line"><span class="cl">matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example <span class="m">2</span> &gt;&gt;
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>The BOF version compiles successfully; however, the executable version still yields a few <code>undefined reference</code> linking errors.</p><p>The linker is failing to find the Beacon API (BeaconPrintf) symbols. These symbols typically reside in a BOF loader and are resolved during the loading process so they do not live anywhere on the system for the linker to find.</p><p>A workaround for this issue is to create mock implementations of the Beacon API and link them in when compiling the executable version. The provided Visual Studio BOF template mentioned in the <a href="https://www.cobaltstrike.com/blog/simplifying-bof-development" target="_blank" rel="noopener noreffer">“Simplifying BOF Development: Debug, Test, and Save Your B(e)acon”</a> blog post uses this strategy (<a href="https://github.com/Cobalt-Strike/bof-vs/blob/855a33afacd6efad3eaceebe42c5ece4a435d91d/BOF-Template/base/mock.cpp#L391" target="_blank" rel="noopener noreffer">Cobalt-Strike/bof-vs/BOF-template/base/mock.cpp#L391</a>).</p><p>The mock Beacon API implementations can be ported over in a way that works with this BOF. Ideally, these would be implemented in a static library that can be reused across different projects but since <code>BeaconPrintf</code> is the only function needed for this project, it is fine to just include it along with the BOF.</p><hr><p>Filename: <code>beacon_mock.c</code></p><div class="highlight"><div class="chroma open"><div class="code-header language-c"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="#include &quot;beacon_mock.h&quot;

#include <assert.h>
#include <stdarg.h>
#include <stdio.h>

/// BeaconPrintf implementation for printing to stdout.
/// Based off of https://github.com/Cobalt-Strike/bof-vs/blob/855a33afacd6efad3eaceebe42c5ece4a435d91d/BOF-Template/base/mock.cpp#L391 but ported to C
void BeaconPrintf(int type, const char *fmt, ...) {
	printf(&quot;[Output Callback: (0x%02x)]: &quot;, type);
	va_list args;
	va_start(args, fmt);
	vprintf(fmt, args);
	puts(&quot;&quot;);
	assert(fflush(stdout) == 0);
	va_end(args);
}
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">"beacon_mock.h"</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdarg.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">/// BeaconPrintf implementation for printing to stdout.
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Based off of https://github.com/Cobalt-Strike/bof-vs/blob/855a33afacd6efad3eaceebe42c5ece4a435d91d/BOF-Template/base/mock.cpp#L391 but ported to C
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">BeaconPrintf</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">"[Output Callback: (0x%02x)]: "</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">va_list</span> <span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">vprintf</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">puts</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">assert</span><span class="p">(</span><span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div></div><hr><p>Filename: <code>beacon_mock.h</code></p><div class="highlight"><div class="chroma open"><div class="code-header language-c"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="#ifndef BEACON_MOCK_H
#define BEACON_MOCK_H

#define CALLBACK_OUTPUT      0x0
#define CALLBACK_OUTPUT_OEM  0x1e
#define CALLBACK_OUTPUT_UTF8 0x20
#define CALLBACK_ERROR       0x0d

void BeaconPrintf(int type, const char *fmt, ...);

#endif // BEACON_MOCK_H
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#ifndef BEACON_MOCK_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BEACON_MOCK_H
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define CALLBACK_OUTPUT      0x0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CALLBACK_OUTPUT_OEM  0x1e
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CALLBACK_OUTPUT_UTF8 0x20
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CALLBACK_ERROR       0x0d
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">BeaconPrintf</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">// BEACON_MOCK_H
</span></span></span></code></pre></td></tr></tbody></table></div></div></div><hr><p>Filename: <code>examplebof.c</code></p><div class="highlight"><div class="chroma open"><div class="code-header language-c"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="#include <windows.h>
#include <lmcons.h>

#ifdef BOF
// Include the regular beacon.h definitions when compiling as a BOF
#include &quot;beacon.h&quot;

DECLSPEC_IMPORT DWORD WINAPI KERNEL32$GetCurrentProcessId(void);
#define kernel32_GetCurrentProcessId KERNEL32$GetCurrentProcessId

DECLSPEC_IMPORT BOOL WINAPI ADVAPI32$GetUserNameA(LPSTR, LPDWORD);
#define advapi32_GetUserNameA ADVAPI32$GetUserNameA

#else // BOF
// Include the mock Beacon API definitions when compiling as a standalone executable
#include &quot;beacon_mock.h&quot;

#define kernel32_GetCurrentProcessId GetCurrentProcessId
#define advapi32_GetUserNameA GetUserNameA

#endif // BOF

void go(void) {
    DWORD pid = kernel32_GetCurrentProcessId();
    BeaconPrintf(CALLBACK_OUTPUT, &quot;Current process id: %lu&quot;, pid);

    char username[UNLEN + 1] = {0};
    if (advapi32_GetUserNameA(username, &amp;(DWORD){ sizeof(username) }) == TRUE) {
        BeaconPrintf(CALLBACK_OUTPUT, &quot;Username: %s&quot;, username);
    }
}

#ifndef BOF
// Create a main function to wrap the BOF entrypoint
int main() {
    go();
    return 0;
}
#endif // BOF
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;lmcons.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef BOF
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Include the regular beacon.h definitions when compiling as a BOF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">"beacon.h"</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">DECLSPEC_IMPORT</span> <span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="n">KERNEL32</span><span class="err">$</span><span class="nf">GetCurrentProcessId</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define kernel32_GetCurrentProcessId KERNEL32$GetCurrentProcessId
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">DECLSPEC_IMPORT</span> <span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">ADVAPI32</span><span class="err">$</span><span class="nf">GetUserNameA</span><span class="p">(</span><span class="n">LPSTR</span><span class="p">,</span> <span class="n">LPDWORD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define advapi32_GetUserNameA ADVAPI32$GetUserNameA
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#else </span><span class="c1">// BOF
</span></span></span><span class="line"><span class="cl"><span class="c1">// Include the mock Beacon API definitions when compiling as a standalone executable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">"beacon_mock.h"</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define kernel32_GetCurrentProcessId GetCurrentProcessId
</span></span></span><span class="line"><span class="cl"><span class="cp">#define advapi32_GetUserNameA GetUserNameA
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">// BOF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">go</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">pid</span> <span class="o">=</span> <span class="nf">kernel32_GetCurrentProcessId</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">BeaconPrintf</span><span class="p">(</span><span class="n">CALLBACK_OUTPUT</span><span class="p">,</span> <span class="s">"Current process id: %lu"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">username</span><span class="p">[</span><span class="n">UNLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">advapi32_GetUserNameA</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">DWORD</span><span class="p">){</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="p">})</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BeaconPrintf</span><span class="p">(</span><span class="n">CALLBACK_OUTPUT</span><span class="p">,</span> <span class="s">"Username: %s"</span><span class="p">,</span> <span class="n">username</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef BOF
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// Create a main function to wrap the BOF entrypoint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">go</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">// BOF
</span></span></span></code></pre></td></tr></tbody></table></div></div></div><hr><p>And adjusting the Makefile above to include the new mock Beacon API implementations</p><hr><p>Filename: <code>Makefile</code></p><div class="highlight"><div class="chroma open"><div class="code-header language-makefile"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="CC = x86_64-w64-mingw32-gcc
RM = rm -vf

sources := examplebof.c beacon_mock.c
objs := $(sources:.c=.o)

.PHONY: all clean
all : examplebof.bof.o examplebof.exe
clean:
	$(RM) examplebof.bof.o examplebof.exe $(objs)

examplebof.exe : examplebof.o beacon_mock.o
examplebof.bof.o : examplebof.c beacon.h

examplebof.o : examplebof.c beacon_mock.h
beacon_mock.o : beacon_mock.c beacon_mock.h

%.bof.o : %.c
	$(CC) -DBOF $(CFLAGS) $(TARGET_ARCH) -c $(OUTPUT_OPTION) $<

% : %.o
%.exe : %.o
	$(LINK.o) $^ $(LDLIBS) -o $@
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nv">CC</span> <span class="o">=</span> x86_64-w64-mingw32-gcc
</span></span><span class="line"><span class="cl"><span class="nv">RM</span> <span class="o">=</span> rm -vf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">sources</span> <span class="o">:=</span> examplebof.c beacon_mock.c
</span></span><span class="line"><span class="cl"><span class="nv">objs</span> <span class="o">:=</span> <span class="k">$(</span>sources:.c<span class="o">=</span>.o<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span> <span class="n">clean</span>
</span></span><span class="line"><span class="cl"><span class="nf">all </span><span class="o">:</span> <span class="n">examplebof</span>.<span class="n">bof</span>.<span class="n">o</span> <span class="n">examplebof</span>.<span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="nf">clean</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>RM<span class="k">)</span> examplebof.bof.o examplebof.exe <span class="k">$(</span>objs<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">examplebof.exe </span><span class="o">:</span> <span class="n">examplebof</span>.<span class="n">o</span> <span class="n">beacon_mock</span>.<span class="n">o</span>
</span></span><span class="line"><span class="cl"><span class="nf">examplebof.bof.o </span><span class="o">:</span> <span class="n">examplebof</span>.<span class="n">c</span> <span class="n">beacon</span>.<span class="n">h</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">examplebof.o </span><span class="o">:</span> <span class="n">examplebof</span>.<span class="n">c</span> <span class="n">beacon_mock</span>.<span class="n">h</span>
</span></span><span class="line"><span class="cl"><span class="nf">beacon_mock.o </span><span class="o">:</span> <span class="n">beacon_mock</span>.<span class="n">c</span> <span class="n">beacon_mock</span>.<span class="n">h</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">%.bof.o </span><span class="o">:</span> %.<span class="n">c</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>CC<span class="k">)</span> -DBOF <span class="k">$(</span>CFLAGS<span class="k">)</span> <span class="k">$(</span>TARGET_ARCH<span class="k">)</span> -c <span class="k">$(</span>OUTPUT_OPTION<span class="k">)</span> $&lt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">% </span><span class="o">:</span> %.<span class="n">o</span>
</span></span><span class="line"><span class="cl"><span class="nf">%.exe </span><span class="o">:</span> %.<span class="n">o</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>LINK.o<span class="k">)</span> $^ <span class="k">$(</span>LDLIBS<span class="k">)</span> -o <span class="nv">$@</span>
</span></span></code></pre></td></tr></tbody></table></div></div></div><hr><p>Compiling this as both a BOF and a standalone executable should work now since there is an implementation for <code>BeaconPrintf</code> present that the linker can find.</p><div class="highlight"><div class="chroma open"><div class="code-header language-bash"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example >> ls
beacon.h  beacon_mock.c  beacon_mock.h  examplebof.c  Makefile
matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example >> make
x86_64-w64-mingw32-gcc -DBOF   -c -o examplebof.bof.o examplebof.c
x86_64-w64-mingw32-gcc    -c -o examplebof.o examplebof.c
x86_64-w64-mingw32-gcc    -c -o beacon_mock.o beacon_mock.c
x86_64-w64-mingw32-gcc   examplebof.o beacon_mock.o  -o examplebof.exe
matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example >> ls
beacon.h  beacon_mock.c  beacon_mock.h  beacon_mock.o  examplebof.bof.o  examplebof.c  examplebof.exe  examplebof.o  Makefile
matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example >> wine ./examplebof.exe
002c:fixme:winediag:loader_init wine-staging 9.15 is a testing version containing experimental patches.
002c:fixme:winediag:loader_init Please mention your exact version when filing bug reports on winehq.org.
[Output Callback: (0x00)]: Current process id: 32
[Output Callback: (0x00)]: Username: matt
matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example >>
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example &gt;&gt; ls
</span></span><span class="line"><span class="cl">beacon.h  beacon_mock.c  beacon_mock.h  examplebof.c  Makefile
</span></span><span class="line"><span class="cl">matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example &gt;&gt; make
</span></span><span class="line"><span class="cl">x86_64-w64-mingw32-gcc -DBOF   -c -o examplebof.bof.o examplebof.c
</span></span><span class="line"><span class="cl">x86_64-w64-mingw32-gcc    -c -o examplebof.o examplebof.c
</span></span><span class="line"><span class="cl">x86_64-w64-mingw32-gcc    -c -o beacon_mock.o beacon_mock.c
</span></span><span class="line"><span class="cl">x86_64-w64-mingw32-gcc   examplebof.o beacon_mock.o  -o examplebof.exe
</span></span><span class="line"><span class="cl">matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example &gt;&gt; ls
</span></span><span class="line"><span class="cl">beacon.h  beacon_mock.c  beacon_mock.h  beacon_mock.o  examplebof.bof.o  examplebof.c  examplebof.exe  examplebof.o  Makefile
</span></span><span class="line"><span class="cl">matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example &gt;&gt; wine ./examplebof.exe
</span></span><span class="line"><span class="cl">002c:fixme:winediag:loader_init wine-staging 9.15 is a testing version containing experimental patches.
</span></span><span class="line"><span class="cl">002c:fixme:winediag:loader_init Please mention your exact version when filing bug reports on winehq.org.
</span></span><span class="line"><span class="cl"><span class="o">[</span>Output Callback: <span class="o">(</span>0x00<span class="o">)]</span>: Current process id: <span class="m">32</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Output Callback: <span class="o">(</span>0x00<span class="o">)]</span>: Username: matt
</span></span><span class="line"><span class="cl">matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example &gt;&gt;
</span></span></code></pre></td></tr></tbody></table></div></div></div><h2 id="symbol-redefining-with-objcopy" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#symbol-redefining-with-objcopy" class="header-mark"></a>Symbol Redefining With Objcopy</h2><p>As seen above, this method for managing DFR imports can be a little bit of a hassle. It requires various macros and other helpers in the source code causing a lot of clutter. It would be nice if there was a way to write a BOF like a normal C program but manage the DFR aspects separately outside of the source code.</p><p>This is possible using something like <a href="https://www.man7.org/linux/man-pages/man1/objcopy.1.html" target="_blank" rel="noopener noreffer">objcopy</a>.</p><p>Objcopy is a tool from the <a href="https://www.gnu.org/software/binutils/" target="_blank" rel="noopener noreffer">GNU Binutils</a> designed to manipulate object files. The Binutils have been around for over two decades and are pretty common on most Linux systems. Objcopy supports various different object file formats including COFFs.</p><p>One feature that objcopy includes is the ability to rename symbols using the <code>--redefine-sym</code> flag. This allows changing the name of a symbol in an existing object file.</p><p>Here is how this can be utilized with Beacon Object Files.</p><p>The example BOF code above can be rewritten to remove all of the DFR specifics.</p><hr><p>Filename: <code>examplebof.c</code></p><div class="highlight"><div class="chroma open"><div class="code-header language-c"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="#include <windows.h>
#include <lmcons.h>

#include &quot;beacon.h&quot;

void go(void) {
    DWORD pid = GetCurrentProcessId();
    BeaconPrintf(CALLBACK_OUTPUT, &quot;Current process id: %lu&quot;, pid);

    char username[UNLEN + 1] = {0};
    if (GetUserNameA(username, &amp;(DWORD){ sizeof(username) }) == TRUE) {
        BeaconPrintf(CALLBACK_OUTPUT, &quot;Username: %s&quot;, username);
    }
}
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;lmcons.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">"beacon.h"</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">go</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">pid</span> <span class="o">=</span> <span class="nf">GetCurrentProcessId</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">BeaconPrintf</span><span class="p">(</span><span class="n">CALLBACK_OUTPUT</span><span class="p">,</span> <span class="s">"Current process id: %lu"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">username</span><span class="p">[</span><span class="n">UNLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">GetUserNameA</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">DWORD</span><span class="p">){</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="p">})</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BeaconPrintf</span><span class="p">(</span><span class="n">CALLBACK_OUTPUT</span><span class="p">,</span> <span class="s">"Username: %s"</span><span class="p">,</span> <span class="n">username</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div></div><hr><p>Compiling this version of the example BOF and using it with <a href="https://github.com/trustedsec/COFFLoader" target="_blank" rel="noopener noreffer">TrustedSec’s COFFLoader</a> will fail.</p><div class="highlight"><div class="chroma open"><div class="code-header language-powershell"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="PS C:\Users\User\Documents\writing-bofs-without-dfr-example> .\COFFLoader.exe go .\examplebof.bof.o
Got contents of COFF file
Running/Parsing the COFF file
Machine 0x8664
Number of sections: 7
TimeDateStamp : 0
PointerToSymbolTable : 0x2C2
NumberOfSymbols: 21
OptionalHeaderSize: 0
Characteristics: 4
...
Doing Relocations of section: 0
        VirtualAddress: 0x14
        SymbolTableIndex: 0x12
        Type: 0x4
        SymPtr: 0x1A
        SymVal: __imp_GetCurrentProcessId
        SectionNumber: 0x0
Failed to resolve symbol
Returning
Failed to run/parse the COFF file
PS C:\Users\User\Documents\writing-bofs-without-dfr-example>
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">User</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="nb">writing-bofs</span><span class="n">-without-dfr-example</span><span class="p">&gt;</span> <span class="p">.\</span><span class="n">COFFLoader</span><span class="p">.</span><span class="py">exe</span> <span class="n">go</span> <span class="p">.\</span><span class="n">examplebof</span><span class="p">.</span><span class="py">bof</span><span class="p">.</span><span class="py">o</span>
</span></span><span class="line"><span class="cl"><span class="n">Got</span> <span class="n">contents</span> <span class="n">of</span> <span class="n">COFF</span> <span class="n">file</span>
</span></span><span class="line"><span class="cl"><span class="n">Running</span><span class="p">/</span><span class="n">Parsing</span> <span class="n">the</span> <span class="n">COFF</span> <span class="n">file</span>
</span></span><span class="line"><span class="cl"><span class="n">Machine</span> <span class="n">0x8664</span>
</span></span><span class="line"><span class="cl"><span class="n">Number</span> <span class="n">of</span> <span class="n">sections</span><span class="err">:</span> <span class="mf">7</span>
</span></span><span class="line"><span class="cl"><span class="n">TimeDateStamp</span> <span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl"><span class="n">PointerToSymbolTable</span> <span class="err">:</span> <span class="n">0x2C2</span>
</span></span><span class="line"><span class="cl"><span class="n">NumberOfSymbols</span><span class="err">:</span> <span class="mf">21</span>
</span></span><span class="line"><span class="cl"><span class="n">OptionalHeaderSize</span><span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Characteristics</span><span class="err">:</span> <span class="mf">4</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Doing</span> <span class="n">Relocations</span> <span class="n">of</span> <span class="n">section</span><span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">VirtualAddress</span><span class="err">:</span> <span class="n">0x14</span>
</span></span><span class="line"><span class="cl">        <span class="n">SymbolTableIndex</span><span class="err">:</span> <span class="n">0x12</span>
</span></span><span class="line"><span class="cl">        <span class="n">Type</span><span class="err">:</span> <span class="n">0x4</span>
</span></span><span class="line"><span class="cl">        <span class="n">SymPtr</span><span class="err">:</span> <span class="n">0x1A</span>
</span></span><span class="line"><span class="cl">        <span class="n">SymVal</span><span class="err">:</span> <span class="n">__imp_GetCurrentProcessId</span>
</span></span><span class="line"><span class="cl">        <span class="n">SectionNumber</span><span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl"><span class="n">Failed</span> <span class="n">to</span> <span class="n">resolve</span> <span class="n">symbol</span>
</span></span><span class="line"><span class="cl"><span class="n">Returning</span>
</span></span><span class="line"><span class="cl"><span class="n">Failed</span> <span class="n">to</span> <span class="n">run</span><span class="p">/</span><span class="n">parse</span> <span class="n">the</span> <span class="n">COFF</span> <span class="n">file</span>
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">User</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="nb">writing-bofs</span><span class="n">-without-dfr-example</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>COFFLoader throws an error during the processing of the <code>__imp_GetCurrentProcessId</code> symbol because it is unable to parse out the library name.</p><p>Using objcopy, the imported symbols in the example BOF can be rewritten to match the DFR format. This is what the BOF loader expects to see when resolving these imported symbols.</p><div class="highlight"><div class="chroma open"><div class="code-header language-bash"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="objcopy \
	--redefine-sym '__imp_GetCurrentProcessId=__imp_KERNEL32$GetCurrentProcessId' \
	--redefine-sym '__imp_GetUserNameA=__imp_ADVAPI32$GetUserNameA' \
	examplebof.bof.o examplebof-redefined.bof.o
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">objcopy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--redefine-sym <span class="s1">'__imp_GetCurrentProcessId=__imp_KERNEL32$GetCurrentProcessId'</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--redefine-sym <span class="s1">'__imp_GetUserNameA=__imp_ADVAPI32$GetUserNameA'</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	examplebof.bof.o examplebof-redefined.bof.o
</span></span></code></pre></td></tr></tbody></table></div></div></div><p><a href="https://book.rada.re/tools/rabin2/intro.html" target="_blank" rel="noopener noreffer">Rabin2</a> can be used to verify that the symbols were renamed properly.</p><hr><p>File: <code>examplebof.bof.o</code></p><div class="highlight"><div class="chroma open"><div class="code-header language-bash"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example >> rabin2 -s examplebof.bof.o
[Symbols]
nth paddr      vaddr      bind   type size lib name                          demangled
――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
0   0x00000000 0x00000000 LOCAL  FILE 4        .file
0   0x0000012c 0x00000000 GLOBAL FUNC 4        go
0   0x0000012c 0x00000000 LOCAL  SECT 4        .text
0   0x00000000 0x000000b0 LOCAL  SECT 4        .data
0   0x00000000 0x000000c0 LOCAL  SECT 4        .bss
0   0x000001dc 0x000000d0 LOCAL  SECT 4        .rdata
0   0x0000020c 0x00000100 LOCAL  SECT 4        .xdata
0   0x0000021c 0x00000110 LOCAL  SECT 4        .pdata
0   0x00000228 0x00000120 LOCAL  UNK  4        .rdata$zzz
0   ---------- ---------- NONE   UNK  4        imp.__imp_GetCurrentProcessId
0   ---------- ---------- NONE   UNK  4        imp.__imp_BeaconPrintf
0   ---------- ---------- NONE   UNK  4        imp.__imp_GetUserNameA
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example &gt;&gt; rabin2 -s examplebof.bof.o
</span></span><span class="line"><span class="cl"><span class="o">[</span>Symbols<span class="o">]</span>
</span></span><span class="line"><span class="cl">nth paddr      vaddr      <span class="nb">bind</span>   <span class="nb">type</span> size lib name                          demangled
</span></span><span class="line"><span class="cl">――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x00000000 0x00000000 LOCAL  FILE <span class="m">4</span>        .file
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x0000012c 0x00000000 GLOBAL FUNC <span class="m">4</span>        go
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x0000012c 0x00000000 LOCAL  SECT <span class="m">4</span>        .text
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x00000000 0x000000b0 LOCAL  SECT <span class="m">4</span>        .data
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x00000000 0x000000c0 LOCAL  SECT <span class="m">4</span>        .bss
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x000001dc 0x000000d0 LOCAL  SECT <span class="m">4</span>        .rdata
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x0000020c 0x00000100 LOCAL  SECT <span class="m">4</span>        .xdata
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x0000021c 0x00000110 LOCAL  SECT <span class="m">4</span>        .pdata
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x00000228 0x00000120 LOCAL  UNK  <span class="m">4</span>        .rdata<span class="nv">$zzz</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span>   ---------- ---------- NONE   UNK  <span class="m">4</span>        imp.__imp_GetCurrentProcessId
</span></span><span class="line"><span class="cl"><span class="m">0</span>   ---------- ---------- NONE   UNK  <span class="m">4</span>        imp.__imp_BeaconPrintf
</span></span><span class="line"><span class="cl"><span class="m">0</span>   ---------- ---------- NONE   UNK  <span class="m">4</span>        imp.__imp_GetUserNameA
</span></span></code></pre></td></tr></tbody></table></div></div></div><hr><p>File: <code>examplebof-redefined.bof.o</code></p><div class="highlight"><div class="chroma open"><div class="code-header language-bash"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example >> rabin2 -s example-redefined.bof.o
[Symbols]
nth paddr      vaddr      bind   type size lib name                                   demangled
―――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
0   0x00000000 0x00000000 LOCAL  FILE 4        .file
0   0x0000012c 0x00000000 GLOBAL FUNC 4        go
0   0x0000012c 0x00000000 LOCAL  SECT 4        .text
0   0x00000000 0x000000b0 LOCAL  SECT 4        .data
0   0x00000000 0x000000c0 LOCAL  SECT 4        .bss
0   0x000001dc 0x000000d0 LOCAL  SECT 4        .rdata
0   0x0000020c 0x00000100 LOCAL  SECT 4        .xdata
0   0x0000021c 0x00000110 LOCAL  SECT 4        .pdata
0   0x00000228 0x00000120 LOCAL  UNK  4        .rdata$zzz
0   ---------- ---------- NONE   UNK  4        imp.__imp_KERNEL32$GetCurrentProcessId
0   ---------- ---------- NONE   UNK  4        imp.__imp_BeaconPrintf
0   ---------- ---------- NONE   UNK  4        imp.__imp_ADVAPI32$GetUserNameA
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example &gt;&gt; rabin2 -s example-redefined.bof.o
</span></span><span class="line"><span class="cl"><span class="o">[</span>Symbols<span class="o">]</span>
</span></span><span class="line"><span class="cl">nth paddr      vaddr      <span class="nb">bind</span>   <span class="nb">type</span> size lib name                                   demangled
</span></span><span class="line"><span class="cl">―――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x00000000 0x00000000 LOCAL  FILE <span class="m">4</span>        .file
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x0000012c 0x00000000 GLOBAL FUNC <span class="m">4</span>        go
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x0000012c 0x00000000 LOCAL  SECT <span class="m">4</span>        .text
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x00000000 0x000000b0 LOCAL  SECT <span class="m">4</span>        .data
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x00000000 0x000000c0 LOCAL  SECT <span class="m">4</span>        .bss
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x000001dc 0x000000d0 LOCAL  SECT <span class="m">4</span>        .rdata
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x0000020c 0x00000100 LOCAL  SECT <span class="m">4</span>        .xdata
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x0000021c 0x00000110 LOCAL  SECT <span class="m">4</span>        .pdata
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x00000228 0x00000120 LOCAL  UNK  <span class="m">4</span>        .rdata<span class="nv">$zzz</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span>   ---------- ---------- NONE   UNK  <span class="m">4</span>        imp.__imp_KERNEL32<span class="nv">$GetCurrentProcessId</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span>   ---------- ---------- NONE   UNK  <span class="m">4</span>        imp.__imp_BeaconPrintf
</span></span><span class="line"><span class="cl"><span class="m">0</span>   ---------- ---------- NONE   UNK  <span class="m">4</span>        imp.__imp_ADVAPI32<span class="nv">$GetUserNameA</span>
</span></span></code></pre></td></tr></tbody></table></div></div></div><hr><p>Testing the newly generated BOF with the redefined symbols now works with COFFLoader</p><div class="highlight"><div class="chroma open"><div class="code-header language-powershell"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="PS C:\Users\User\Documents\writing-bofs-without-dfr-example> .\COFFLoader.exe go .\example-redefined.bof.o
Got contents of COFF file
Running/Parsing the COFF file
Machine 0x8664
Number of sections: 7
TimeDateStamp : 0
PointerToSymbolTable : 0x2C2
NumberOfSymbols: 21
OptionalHeaderSize: 0
Characteristics: 4
...
: Section: 0, Value: 0x0
        : Section: 7, Value: 0x0
        8: Section: 0, Value: 0x0
        : Section: 0, Value: 0x0
        : Section: 0, Value: 0x0
        : Section: 0, Value: 0x0
Back
Returning
Ran/parsed the coff
Outdata Below:

Current process id: 9028
Username: User

PS C:\Users\User\Documents\writing-bofs-without-dfr-example>
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">User</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="nb">writing-bofs</span><span class="n">-without-dfr-example</span><span class="p">&gt;</span> <span class="p">.\</span><span class="n">COFFLoader</span><span class="p">.</span><span class="py">exe</span> <span class="n">go</span> <span class="p">.\</span><span class="nb">example-redefined</span><span class="p">.</span><span class="py">bof</span><span class="p">.</span><span class="py">o</span>
</span></span><span class="line"><span class="cl"><span class="n">Got</span> <span class="n">contents</span> <span class="n">of</span> <span class="n">COFF</span> <span class="n">file</span>
</span></span><span class="line"><span class="cl"><span class="n">Running</span><span class="p">/</span><span class="n">Parsing</span> <span class="n">the</span> <span class="n">COFF</span> <span class="n">file</span>
</span></span><span class="line"><span class="cl"><span class="n">Machine</span> <span class="n">0x8664</span>
</span></span><span class="line"><span class="cl"><span class="n">Number</span> <span class="n">of</span> <span class="n">sections</span><span class="err">:</span> <span class="mf">7</span>
</span></span><span class="line"><span class="cl"><span class="n">TimeDateStamp</span> <span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl"><span class="n">PointerToSymbolTable</span> <span class="err">:</span> <span class="n">0x2C2</span>
</span></span><span class="line"><span class="cl"><span class="n">NumberOfSymbols</span><span class="err">:</span> <span class="mf">21</span>
</span></span><span class="line"><span class="cl"><span class="n">OptionalHeaderSize</span><span class="err">:</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Characteristics</span><span class="err">:</span> <span class="mf">4</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="err">:</span> <span class="n">Section</span><span class="err">:</span> <span class="mf">0</span><span class="p">,</span> <span class="n">Value</span><span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="err">:</span> <span class="n">Section</span><span class="err">:</span> <span class="mf">7</span><span class="p">,</span> <span class="n">Value</span><span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="mf">8</span><span class="err">:</span> <span class="n">Section</span><span class="err">:</span> <span class="mf">0</span><span class="p">,</span> <span class="n">Value</span><span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="err">:</span> <span class="n">Section</span><span class="err">:</span> <span class="mf">0</span><span class="p">,</span> <span class="n">Value</span><span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="err">:</span> <span class="n">Section</span><span class="err">:</span> <span class="mf">0</span><span class="p">,</span> <span class="n">Value</span><span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl">        <span class="err">:</span> <span class="n">Section</span><span class="err">:</span> <span class="mf">0</span><span class="p">,</span> <span class="n">Value</span><span class="err">:</span> <span class="n">0x0</span>
</span></span><span class="line"><span class="cl"><span class="n">Back</span>
</span></span><span class="line"><span class="cl"><span class="n">Returning</span>
</span></span><span class="line"><span class="cl"><span class="n">Ran</span><span class="p">/</span><span class="n">parsed</span> <span class="n">the</span> <span class="n">coff</span>
</span></span><span class="line"><span class="cl"><span class="n">Outdata</span> <span class="n">Below</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Current</span> <span class="k">process</span> <span class="n">id</span><span class="err">:</span> <span class="mf">9028</span>
</span></span><span class="line"><span class="cl"><span class="n">Username</span><span class="err">:</span> <span class="n">User</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">PS </span><span class="n">C:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">User</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="nb">writing-bofs</span><span class="n">-without-dfr-example</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>That command line flag is the only thing needed to get this BOF working. The source can stay how it is without needing the DFR declarations.</p><p>Having to specify the import renaming on the command line every time can become difficult to manage as more imports are added. This can be simplified by storing the name mappings inside a dedicated file.</p><h3 id="adding-an-importstxt" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#adding-an-importstxt" class="header-mark"></a>Adding An Imports.txt</h3><p>Objcopy has a <code>--redefine-syms</code> flag which allows specifying a file with the list of symbol redefinitions instead of needing to pass them on the command line each time. The format for this file is: the current symbol name, a space, and the new name for the symbol. These redefinitions can be listed multiple times in the file on separate lines.</p><p>Here is how to create an imports.txt file for the example BOF above.</p><hr><p>Filename: <code>imports.txt</code></p><div class="highlight"><div class="chroma open"><div class="code-header language-txt"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="__imp_GetCurrentProcessId __imp_KERNEL32$GetCurrentProcessId
__imp_GetUserNameA __imp_ADVAPI32$GetUserNameA
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">__imp_GetCurrentProcessId __imp_KERNEL32$GetCurrentProcessId
</span></span><span class="line"><span class="cl">__imp_GetUserNameA __imp_ADVAPI32$GetUserNameA
</span></span></code></pre></td></tr></tbody></table></div></div></div><hr><p>Rerunning objcopy with the symbols specified in the <code>imports.txt</code> file should redefine all of the needed BOF imports.</p><div class="highlight"><div class="chroma open"><div class="code-header language-bash"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="objcopy --redefine-syms=imports.txt example.bof.o example-redefined.bof.o
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">objcopy --redefine-syms<span class="o">=</span>imports.txt example.bof.o example-redefined.bof.o
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>Checking the symbol table with rabin2 confirms that the new symbol names were applied correctly.</p><div class="highlight"><div class="chroma open"><div class="code-header language-bash"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example >> rabin2 -s example-redefined.bof.o
[Symbols]
nth paddr      vaddr      bind   type size lib name                                   demangled
―――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
0   0x00000000 0x00000000 LOCAL  FILE 4        .file
0   0x0000012c 0x00000000 GLOBAL FUNC 4        go
0   0x0000012c 0x00000000 LOCAL  SECT 4        .text
0   0x00000000 0x000000b0 LOCAL  SECT 4        .data
0   0x00000000 0x000000c0 LOCAL  SECT 4        .bss
0   0x000001dc 0x000000d0 LOCAL  SECT 4        .rdata
0   0x0000020c 0x00000100 LOCAL  SECT 4        .xdata
0   0x0000021c 0x00000110 LOCAL  SECT 4        .pdata
0   0x00000228 0x00000120 LOCAL  UNK  4        .rdata$zzz
0   ---------- ---------- NONE   UNK  4        imp.__imp_KERNEL32$GetCurrentProcessId
0   ---------- ---------- NONE   UNK  4        imp.__imp_BeaconPrintf
0   ---------- ---------- NONE   UNK  4        imp.__imp_ADVAPI32$GetUserNameA
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">matt@laptop :: ~/Documents/dev/writing-bofs-without-dfr-example &gt;&gt; rabin2 -s example-redefined.bof.o
</span></span><span class="line"><span class="cl"><span class="o">[</span>Symbols<span class="o">]</span>
</span></span><span class="line"><span class="cl">nth paddr      vaddr      <span class="nb">bind</span>   <span class="nb">type</span> size lib name                                   demangled
</span></span><span class="line"><span class="cl">―――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x00000000 0x00000000 LOCAL  FILE <span class="m">4</span>        .file
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x0000012c 0x00000000 GLOBAL FUNC <span class="m">4</span>        go
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x0000012c 0x00000000 LOCAL  SECT <span class="m">4</span>        .text
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x00000000 0x000000b0 LOCAL  SECT <span class="m">4</span>        .data
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x00000000 0x000000c0 LOCAL  SECT <span class="m">4</span>        .bss
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x000001dc 0x000000d0 LOCAL  SECT <span class="m">4</span>        .rdata
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x0000020c 0x00000100 LOCAL  SECT <span class="m">4</span>        .xdata
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x0000021c 0x00000110 LOCAL  SECT <span class="m">4</span>        .pdata
</span></span><span class="line"><span class="cl"><span class="m">0</span>   0x00000228 0x00000120 LOCAL  UNK  <span class="m">4</span>        .rdata<span class="nv">$zzz</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span>   ---------- ---------- NONE   UNK  <span class="m">4</span>        imp.__imp_KERNEL32<span class="nv">$GetCurrentProcessId</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span>   ---------- ---------- NONE   UNK  <span class="m">4</span>        imp.__imp_BeaconPrintf
</span></span><span class="line"><span class="cl"><span class="m">0</span>   ---------- ---------- NONE   UNK  <span class="m">4</span>        imp.__imp_ADVAPI32<span class="nv">$GetUserNameA</span>
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>This provides a way of specifying the BOF imports in a separate file outside of the source code itself. The BOF can be written like any other normal C program without needing to make special BOF-specific adjustments for managing imports.</p><h2 id="so-how-does-this-work" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#so-how-does-this-work" class="header-mark"></a>So How Does This Work?</h2><p>This will do a deep dive into what <em>exactly</em> objcopy is doing under the hood to make this work. Objcopy is from the <strong>GNU</strong> Binutils, so that means it may not work well on non-free platforms *cough cough Windows*. LLVM has their own version of objcopy (<a href="https://llvm.org/docs/CommandGuide/llvm-objcopy.html" target="_blank" rel="noopener noreffer">llvm-objcopy</a>) which does work on Windows; however, it may be nice to have a standalone tool dedicated to this. A custom tool can add a lot of flexibility or other features that cater more towards BOF development.</p><p>Before diving in, it is good to get familiar with the raw file structure of a COFF. Not just what each of the components (file header, section headers, relocations, etc.) are but also where they are located inside the raw file. Taking a hex dump of a COFF and labeling each component would look like this.</p><hr><p>Hexdump output for <code>examplebof.bof.o</code></p><div class="highlight"><div class="chroma"><div class="code-header language-txt"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="───────────────────────────────────────────────────────────────────
00000000: 6486 0700 0000 0000 c202 0000 1500 0000  d............... COFF File Header
                   ┌───────────────────────────────────────────────
00000010: 0000 0400│2e74 6578 7400 0000 0000 0000  .....text....... COFF Section
───────────────────┘                                                Headers
00000020: 0000 0000 b000 0000 2c01 0000 6802 0000  ........,...h...
00000030: 0000 0000 0600 0000 2000 5060 2e64 6174  ........ .P`.dat
00000040: 6100 0000 0000 0000 0000 0000 0000 0000  a...............
00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000060: 4000 50c0 2e62 7373 0000 0000 0000 0000  @.P..bss........
00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000080: 0000 0000 0000 0000 8000 50c0 2e72 6461  ..........P..rda
00000090: 7461 0000 0000 0000 0000 0000 3000 0000  ta..........0...
000000a0: dc01 0000 0000 0000 0000 0000 0000 0000  ................
000000b0: 4000 5040 2e78 6461 7461 0000 0000 0000  @.P@.xdata......
000000c0: 0000 0000 1000 0000 0c02 0000 0000 0000  ................
000000d0: 0000 0000 0000 0000 4000 3040 2e70 6461  ........@.0@.pda
000000e0: 7461 0000 0000 0000 0000 0000 0c00 0000  ta..............
000000f0: 1c02 0000 a402 0000 0000 0000 0300 0000  ................
00000100: 4000 3040 2f34 0000 0000 0000 0000 0000  @.0@/4..........
00000110: 0000 0000 4000 0000 2802 0000 0000 0000  ....@...(.......
                             ┌─────────────────────────────────────
00000120: 0000 0000 0000 0000│4000 5040 5557 4881  ........@.P@UWH. Raw data for
─────────────────────────────┘                                      each section
00000130: ec48 0100 0048 8dac 2480 0000 0048 8b05  .H...H..$....H..
00000140: 0000 0000 ffd0 8985 bc00 0000 8b85 bc00  ................
00000150: 0000 4189 c048 8d05 0000 0000 4889 c2b9  ..A..H......H...
00000160: 0000 0000 488b 0500 0000 00ff d048 8d55  ....H........H.U
00000170: b0b8 0000 0000 b920 0000 0048 89d7 f348  ....... ...H...H
00000180: ab48 89fa 8802 4883 c201 c745 ac01 0100  .H....H....E....
00000190: 0048 8d55 ac48 8d45 b048 89c1 488b 0500  .H.U.H.E.H..H...
000001a0: 0000 00ff d083 f801 751f 488d 45b0 4989  ........u.H.E.I.
000001b0: c048 8d05 1800 0000 4889 c2b9 0000 0000  .H......H.......
000001c0: 488b 0500 0000 00ff d090 4881 c448 0100  H.........H..H..
000001d0: 005f 5dc3 9090 9090 9090 9090 4375 7272  ._].........Curr
000001e0: 656e 7420 7072 6f63 6573 7320 6964 3a20  ent process id: 
000001f0: 256c 7500 5573 6572 6e61 6d65 3a20 2573  %lu.Username: %s
00000200: 0000 0000 0000 0000 0000 0000 0111 0585  ................
00000210: 1103 0901 2900 0270 0150 0000 0000 0000  ....)..p.P......
00000220: a800 0000 0000 0000 4743 433a 2028 474e  ........GCC: (GN
00000230: 5529 2031 342e 312e 3120 3230 3234 3036  U) 14.1.1 202406
00000240: 3037 2028 4665 646f 7261 204d 696e 4757  07 (Fedora MinGW
00000250: 2031 342e 312e 312d 332e 6663 3430 2900   14.1.1-3.fc40).
                             ┌─────────────────────────────────────
00000260: 0000 0000 0000 0000│1400 0000 1200 0000  ................ Relocation data
─────────────────────────────┘
00000270: 0400 2c00 0000 0a00 0000 0400 3b00 0000  ..,.........;...
00000280: 1300 0000 0400 7300 0000 1400 0000 0400  ......s.........
00000290: 8800 0000 0a00 0000 0400 9700 0000 1300  ................
000002a0: 0000 0400 0000 0000 0400 0000 0300 0400  ................
000002b0: 0000 0400 0000 0300 0800 0000 0c00 0000  ................
              ┌────────────────────────────────────────────────────
000002c0: 0300│2e66 696c 6500 0000 0000 0000 feff  ...file......... Symbol Table
──────────────┘
000002d0: 0000 6701 6578 616d 706c 6562 6f66 2e63  ..g.examplebof.c
000002e0: 0000 0000 0000 676f 0000 0000 0000 0000  ......go........
000002f0: 0000 0100 2000 0201 0000 0000 0000 0000  .... ...........
00000300: 0000 0000 0000 0000 0000 2e74 6578 7400  ...........text.
00000310: 0000 0000 0000 0100 0000 0301 a800 0000  ................
00000320: 0600 0000 0000 0000 0000 0000 0000 2e64  ...............d
00000330: 6174 6100 0000 0000 0000 0200 0000 0301  ata.............
00000340: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000350: 0000 2e62 7373 0000 0000 0000 0000 0300  ...bss..........
00000360: 0000 0301 0000 0000 0000 0000 0000 0000  ................
00000370: 0000 0000 0000 2e72 6461 7461 0000 0000  .......rdata....
00000380: 0000 0400 0000 0301 2500 0000 0000 0000  ........%.......
00000390: 0000 0000 0000 0000 0000 2e78 6461 7461  ...........xdata
000003a0: 0000 0000 0000 0500 0000 0301 1000 0000  ................
000003b0: 0000 0000 0000 0000 0000 0000 0000 2e70  ...............p
000003c0: 6461 7461 0000 0000 0000 0600 0000 0301  data............
000003d0: 0c00 0000 0300 0000 0000 0000 0000 0000  ................
000003e0: 0000 0000 0000 0f00 0000 0000 0000 0700  ................
000003f0: 0000 0301 3800 0000 0000 0000 0000 0000  ....8...........
00000400: 0000 0000 0000 0000 0000 1a00 0000 0000  ................
00000410: 0000 0000 0000 0200 0000 0000 3400 0000  ............4...
00000420: 0000 0000 0000 0000 0200 0000 0000 4700  ..............G.
                                       ┌───────────────────────────
00000430: 0000 0000 0000 0000 0000 0200│5a00 0000  ............Z... String Table
───────────────────────────────────────┘
00000440: 2e72 6461 7461 247a 7a7a 002e 7264 6174  .rdata$zzz..rdat
00000450: 6124 7a7a 7a00 5f5f 696d 705f 4765 7443  a$zzz.__imp_GetC
00000460: 7572 7265 6e74 5072 6f63 6573 7349 6400  urrentProcessId.
00000470: 5f5f 696d 705f 4265 6163 6f6e 5072 696e  __imp_BeaconPrin
00000480: 7466 005f 5f69 6d70 5f47 6574 5573 6572  tf.__imp_GetUser
00000490: 4e61 6d65 4100                           NameA.
───────────────────────────────────────────────────────────────────
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">───────────────────────────────────────────────────────────────────
</span></span><span class="line"><span class="cl">00000000: 6486 0700 0000 0000 c202 0000 1500 0000  d............... COFF File Header
</span></span><span class="line"><span class="cl">                   ┌───────────────────────────────────────────────
</span></span><span class="line"><span class="cl">00000010: 0000 0400│2e74 6578 7400 0000 0000 0000  .....text....... COFF Section
</span></span><span class="line"><span class="cl">───────────────────┘                                                Headers
</span></span><span class="line"><span class="cl">00000020: 0000 0000 b000 0000 2c01 0000 6802 0000  ........,...h...
</span></span><span class="line"><span class="cl">00000030: 0000 0000 0600 0000 2000 5060 2e64 6174  ........ .P`.dat
</span></span><span class="line"><span class="cl">00000040: 6100 0000 0000 0000 0000 0000 0000 0000  a...............
</span></span><span class="line"><span class="cl">00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">00000060: 4000 50c0 2e62 7373 0000 0000 0000 0000  @.P..bss........
</span></span><span class="line"><span class="cl">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">00000080: 0000 0000 0000 0000 8000 50c0 2e72 6461  ..........P..rda
</span></span><span class="line"><span class="cl">00000090: 7461 0000 0000 0000 0000 0000 3000 0000  ta..........0...
</span></span><span class="line"><span class="cl">000000a0: dc01 0000 0000 0000 0000 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">000000b0: 4000 5040 2e78 6461 7461 0000 0000 0000  @.P@.xdata......
</span></span><span class="line"><span class="cl">000000c0: 0000 0000 1000 0000 0c02 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">000000d0: 0000 0000 0000 0000 4000 3040 2e70 6461  ........@.0@.pda
</span></span><span class="line"><span class="cl">000000e0: 7461 0000 0000 0000 0000 0000 0c00 0000  ta..............
</span></span><span class="line"><span class="cl">000000f0: 1c02 0000 a402 0000 0000 0000 0300 0000  ................
</span></span><span class="line"><span class="cl">00000100: 4000 3040 2f34 0000 0000 0000 0000 0000  @.0@/4..........
</span></span><span class="line"><span class="cl">00000110: 0000 0000 4000 0000 2802 0000 0000 0000  ....@...(.......
</span></span><span class="line"><span class="cl">                             ┌─────────────────────────────────────
</span></span><span class="line"><span class="cl">00000120: 0000 0000 0000 0000│4000 5040 5557 4881  ........@.P@UWH. Raw data for
</span></span><span class="line"><span class="cl">─────────────────────────────┘                                      each section
</span></span><span class="line"><span class="cl">00000130: ec48 0100 0048 8dac 2480 0000 0048 8b05  .H...H..$....H..
</span></span><span class="line"><span class="cl">00000140: 0000 0000 ffd0 8985 bc00 0000 8b85 bc00  ................
</span></span><span class="line"><span class="cl">00000150: 0000 4189 c048 8d05 0000 0000 4889 c2b9  ..A..H......H...
</span></span><span class="line"><span class="cl">00000160: 0000 0000 488b 0500 0000 00ff d048 8d55  ....H........H.U
</span></span><span class="line"><span class="cl">00000170: b0b8 0000 0000 b920 0000 0048 89d7 f348  ....... ...H...H
</span></span><span class="line"><span class="cl">00000180: ab48 89fa 8802 4883 c201 c745 ac01 0100  .H....H....E....
</span></span><span class="line"><span class="cl">00000190: 0048 8d55 ac48 8d45 b048 89c1 488b 0500  .H.U.H.E.H..H...
</span></span><span class="line"><span class="cl">000001a0: 0000 00ff d083 f801 751f 488d 45b0 4989  ........u.H.E.I.
</span></span><span class="line"><span class="cl">000001b0: c048 8d05 1800 0000 4889 c2b9 0000 0000  .H......H.......
</span></span><span class="line"><span class="cl">000001c0: 488b 0500 0000 00ff d090 4881 c448 0100  H.........H..H..
</span></span><span class="line"><span class="cl">000001d0: 005f 5dc3 9090 9090 9090 9090 4375 7272  ._].........Curr
</span></span><span class="line"><span class="cl">000001e0: 656e 7420 7072 6f63 6573 7320 6964 3a20  ent process id: 
</span></span><span class="line"><span class="cl">000001f0: 256c 7500 5573 6572 6e61 6d65 3a20 2573  %lu.Username: %s
</span></span><span class="line"><span class="cl">00000200: 0000 0000 0000 0000 0000 0000 0111 0585  ................
</span></span><span class="line"><span class="cl">00000210: 1103 0901 2900 0270 0150 0000 0000 0000  ....)..p.P......
</span></span><span class="line"><span class="cl">00000220: a800 0000 0000 0000 4743 433a 2028 474e  ........GCC: (GN
</span></span><span class="line"><span class="cl">00000230: 5529 2031 342e 312e 3120 3230 3234 3036  U) 14.1.1 202406
</span></span><span class="line"><span class="cl">00000240: 3037 2028 4665 646f 7261 204d 696e 4757  07 (Fedora MinGW
</span></span><span class="line"><span class="cl">00000250: 2031 342e 312e 312d 332e 6663 3430 2900   14.1.1-3.fc40).
</span></span><span class="line"><span class="cl">                             ┌─────────────────────────────────────
</span></span><span class="line"><span class="cl">00000260: 0000 0000 0000 0000│1400 0000 1200 0000  ................ Relocation data
</span></span><span class="line"><span class="cl">─────────────────────────────┘
</span></span><span class="line"><span class="cl">00000270: 0400 2c00 0000 0a00 0000 0400 3b00 0000  ..,.........;...
</span></span><span class="line"><span class="cl">00000280: 1300 0000 0400 7300 0000 1400 0000 0400  ......s.........
</span></span><span class="line"><span class="cl">00000290: 8800 0000 0a00 0000 0400 9700 0000 1300  ................
</span></span><span class="line"><span class="cl">000002a0: 0000 0400 0000 0000 0400 0000 0300 0400  ................
</span></span><span class="line"><span class="cl">000002b0: 0000 0400 0000 0300 0800 0000 0c00 0000  ................
</span></span><span class="line"><span class="cl">              ┌────────────────────────────────────────────────────
</span></span><span class="line"><span class="cl">000002c0: 0300│2e66 696c 6500 0000 0000 0000 feff  ...file......... Symbol Table
</span></span><span class="line"><span class="cl">──────────────┘
</span></span><span class="line"><span class="cl">000002d0: 0000 6701 6578 616d 706c 6562 6f66 2e63  ..g.examplebof.c
</span></span><span class="line"><span class="cl">000002e0: 0000 0000 0000 676f 0000 0000 0000 0000  ......go........
</span></span><span class="line"><span class="cl">000002f0: 0000 0100 2000 0201 0000 0000 0000 0000  .... ...........
</span></span><span class="line"><span class="cl">00000300: 0000 0000 0000 0000 0000 2e74 6578 7400  ...........text.
</span></span><span class="line"><span class="cl">00000310: 0000 0000 0000 0100 0000 0301 a800 0000  ................
</span></span><span class="line"><span class="cl">00000320: 0600 0000 0000 0000 0000 0000 0000 2e64  ...............d
</span></span><span class="line"><span class="cl">00000330: 6174 6100 0000 0000 0000 0200 0000 0301  ata.............
</span></span><span class="line"><span class="cl">00000340: 0000 0000 0000 0000 0000 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">00000350: 0000 2e62 7373 0000 0000 0000 0000 0300  ...bss..........
</span></span><span class="line"><span class="cl">00000360: 0000 0301 0000 0000 0000 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">00000370: 0000 0000 0000 2e72 6461 7461 0000 0000  .......rdata....
</span></span><span class="line"><span class="cl">00000380: 0000 0400 0000 0301 2500 0000 0000 0000  ........%.......
</span></span><span class="line"><span class="cl">00000390: 0000 0000 0000 0000 0000 2e78 6461 7461  ...........xdata
</span></span><span class="line"><span class="cl">000003a0: 0000 0000 0000 0500 0000 0301 1000 0000  ................
</span></span><span class="line"><span class="cl">000003b0: 0000 0000 0000 0000 0000 0000 0000 2e70  ...............p
</span></span><span class="line"><span class="cl">000003c0: 6461 7461 0000 0000 0000 0600 0000 0301  data............
</span></span><span class="line"><span class="cl">000003d0: 0c00 0000 0300 0000 0000 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">000003e0: 0000 0000 0000 0f00 0000 0000 0000 0700  ................
</span></span><span class="line"><span class="cl">000003f0: 0000 0301 3800 0000 0000 0000 0000 0000  ....8...........
</span></span><span class="line"><span class="cl">00000400: 0000 0000 0000 0000 0000 1a00 0000 0000  ................
</span></span><span class="line"><span class="cl">00000410: 0000 0000 0000 0200 0000 0000 3400 0000  ............4...
</span></span><span class="line"><span class="cl">00000420: 0000 0000 0000 0000 0200 0000 0000 4700  ..............G.
</span></span><span class="line"><span class="cl">                                       ┌───────────────────────────
</span></span><span class="line"><span class="cl">00000430: 0000 0000 0000 0000 0000 0200│5a00 0000  ............Z... String Table
</span></span><span class="line"><span class="cl">───────────────────────────────────────┘
</span></span><span class="line"><span class="cl">00000440: 2e72 6461 7461 247a 7a7a 002e 7264 6174  .rdata$zzz..rdat
</span></span><span class="line"><span class="cl">00000450: 6124 7a7a 7a00 5f5f 696d 705f 4765 7443  a$zzz.__imp_GetC
</span></span><span class="line"><span class="cl">00000460: 7572 7265 6e74 5072 6f63 6573 7349 6400  urrentProcessId.
</span></span><span class="line"><span class="cl">00000470: 5f5f 696d 705f 4265 6163 6f6e 5072 696e  __imp_BeaconPrin
</span></span><span class="line"><span class="cl">00000480: 7466 005f 5f69 6d70 5f47 6574 5573 6572  tf.__imp_GetUser
</span></span><span class="line"><span class="cl">00000490: 4e61 6d65 4100                           NameA.
</span></span><span class="line"><span class="cl">───────────────────────────────────────────────────────────────────
</span></span></code></pre></td></tr></tbody></table></div></div></div><hr><p>The important parts are the symbol table, section headers, and the string table. Conveniently, the string table is located at the end of the file.</p><p>How do these bits relate to each other? The symbol table and section headers contain string data which may reference the string table. Each structure will set aside 8 bytes in the name field for holding this string data.</p><p>The formats for the name fields are outlined in the <a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#section-table-section-headers" target="_blank" rel="noopener noreffer">Section Table (Section Headers)</a> and the <a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#coff-symbol-table" target="_blank" rel="noopener noreffer">COFF Symbol Table</a> PE format documentation.</p><p>This can be examined by looking at the entry for the <code>.text</code> section in the hex dump above.</p><div class="highlight"><div class="chroma open"><div class="code-header language-txt"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="                                               Name (8 bytes)
                                                 │
                   ╭───────────────────┬─────────┴────┬─────╮
00000010:          │2e74 6578 7400 0000│0000 0000     │.text│......
                   ╰───────────────────╯              ╰─────╯
00000020: 0000 0000 b000 0000 2c01 0000 6802 0000  ........,...h...
00000030: 0000 0000 0600 0000 2000 5060            ........ .P`    
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">                                               Name (8 bytes)
</span></span><span class="line"><span class="cl">                                                 │
</span></span><span class="line"><span class="cl">                   ╭───────────────────┬─────────┴────┬─────╮
</span></span><span class="line"><span class="cl">00000010:          │2e74 6578 7400 0000│0000 0000     │.text│......
</span></span><span class="line"><span class="cl">                   ╰───────────────────╯              ╰─────╯
</span></span><span class="line"><span class="cl">00000020: 0000 0000 b000 0000 2c01 0000 6802 0000  ........,...h...
</span></span><span class="line"><span class="cl">00000030: 0000 0000 0600 0000 2000 5060            ........ .P`    
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>Since the name for this section can fit in the 8 bytes set aside for the name field, it is embedded inline with the section metadata.</p><p>What happens if the section name is longer than 8 bytes?</p><p>That is where the string table comes into play. Instead of the name field containing the name of the section, it will contain a forward slash (/) at the start and then an ASCII number with the index into the string table where the name of the section lies.</p><p>This occurs with the last section header in the above hex dump example.</p><div class="highlight"><div class="chroma open"><div class="code-header language-txt"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="                The name field in this instance is &quot;/4&quot; meaning that the name
                of the section is really in the string table starting at the
                fourth index.
                                               Name (8 bytes)
                                                 │
                   ╭───────────────────┬─────────┴────┬────────╮
00000100:          │2f34 0000 0000 0000│0000 0000     │/4......│....
                   ╰───────────────────╯              ╰────────╯
00000110: 0000 0000 4000 0000 2802 0000 0000 0000  ....@...(.......
00000120: 0000 0000 0000 0000                      ........
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">                The name field in this instance is "/4" meaning that the name
</span></span><span class="line"><span class="cl">                of the section is really in the string table starting at the
</span></span><span class="line"><span class="cl">                fourth index.
</span></span><span class="line"><span class="cl">                                               Name (8 bytes)
</span></span><span class="line"><span class="cl">                                                 │
</span></span><span class="line"><span class="cl">                   ╭───────────────────┬─────────┴────┬────────╮
</span></span><span class="line"><span class="cl">00000100:          │2f34 0000 0000 0000│0000 0000     │/4......│....
</span></span><span class="line"><span class="cl">                   ╰───────────────────╯              ╰────────╯
</span></span><span class="line"><span class="cl">00000110: 0000 0000 4000 0000 2802 0000 0000 0000  ....@...(.......
</span></span><span class="line"><span class="cl">00000120: 0000 0000 0000 0000                      ........
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>And the value in the string table at that index is “.rdata$zzz”.</p><div class="highlight"><div class="chroma open"><div class="code-header language-txt"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="        Real name of the section
                 │
00000430:        │                      5a00 0000              Z...
         ╭───────┴───────────────────┬─────────────┬──────────╮
00000440:│2e72 6461 7461 247a 7a7a 00│2e 7264 6174 │.rdata$zzz│.rdat
         ╰───────────────────────────╯             ╰──────────╯
00000450: 6124 7a7a 7a00 5f5f 696d 705f 4765 7443  a$zzz.__imp_GetC
00000460: 7572 7265 6e74 5072 6f63 6573 7349 6400  urrentProcessId.
00000470: 5f5f 696d 705f 4265 6163 6f6e 5072 696e  __imp_BeaconPrin
00000480: 7466 005f 5f69 6d70 5f47 6574 5573 6572  tf.__imp_GetUser
00000490: 4e61 6d65 4100                           NameA.
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">        Real name of the section
</span></span><span class="line"><span class="cl">                 │
</span></span><span class="line"><span class="cl">00000430:        │                      5a00 0000              Z...
</span></span><span class="line"><span class="cl">         ╭───────┴───────────────────┬─────────────┬──────────╮
</span></span><span class="line"><span class="cl">00000440:│2e72 6461 7461 247a 7a7a 00│2e 7264 6174 │.rdata$zzz│.rdat
</span></span><span class="line"><span class="cl">         ╰───────────────────────────╯             ╰──────────╯
</span></span><span class="line"><span class="cl">00000450: 6124 7a7a 7a00 5f5f 696d 705f 4765 7443  a$zzz.__imp_GetC
</span></span><span class="line"><span class="cl">00000460: 7572 7265 6e74 5072 6f63 6573 7349 6400  urrentProcessId.
</span></span><span class="line"><span class="cl">00000470: 5f5f 696d 705f 4265 6163 6f6e 5072 696e  __imp_BeaconPrin
</span></span><span class="line"><span class="cl">00000480: 7466 005f 5f69 6d70 5f47 6574 5573 6572  tf.__imp_GetUser
</span></span><span class="line"><span class="cl">00000490: 4e61 6d65 4100                           NameA.
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>One important thing to note is where this index is based from in the string table. The first four bytes of the string table (0x43c – 0x43f) is the size field. This is a little-endian integer (0x5a) that contains the size of the string table including the size field itself. The data for the string table starts at 0x440 with the size of that data being the value in the size field minus the size of that field (0x5a - 4 = 0x56).</p><p>The index defined in the section header is not based from the start of the string table data but rather the start of the string table including the size field.</p><p>Symbol names follow the same pattern but with one difference. The difference is outlined in the <a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#symbol-name-representation" target="_blank" rel="noopener noreffer">Symbol Name Representation</a> PE format documentation.</p><p>Instead of the first byte of the name starting with a forward slash to signify that the name string is located in the string table, the first four bytes of the name field will be set to NULL and the next four bytes are the string table index. This index is a regular 4 byte, little-endian integer rather than an ASCII decimal number like in the section headers. The name index in the symbol table follows the same rule as the section header name where that index is based from the beginning of the string table starting at the size field instead of where the string data starts.</p><p>In the example hex dump, the last symbol in the symbol table contains a symbol name longer than 8 bytes.</p><div class="highlight"><div class="chroma open"><div class="code-header language-txt"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="           First four bytes are all 0
                                   │     The symbol name is in the string
                                   │     table at index 0x47
                                   │            │
                                  ╭┴────────┬───┴╮
00000420:                         │0000 0000│4700│           ....G.
                                  ╰─────────┤    │
         ╭──────────────────────────────────╯    │
         │    ╭──────────────────────────────────╯
00000430:│0000│0000 0000 0000 0000 0200            ............
         ╰────╯
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">           First four bytes are all 0
</span></span><span class="line"><span class="cl">                                   │     The symbol name is in the string
</span></span><span class="line"><span class="cl">                                   │     table at index 0x47
</span></span><span class="line"><span class="cl">                                   │            │
</span></span><span class="line"><span class="cl">                                  ╭┴────────┬───┴╮
</span></span><span class="line"><span class="cl">00000420:                         │0000 0000│4700│           ....G.
</span></span><span class="line"><span class="cl">                                  ╰─────────┤    │
</span></span><span class="line"><span class="cl">         ╭──────────────────────────────────╯    │
</span></span><span class="line"><span class="cl">         │    ╭──────────────────────────────────╯
</span></span><span class="line"><span class="cl">00000430:│0000│0000 0000 0000 0000 0200            ............
</span></span><span class="line"><span class="cl">         ╰────╯
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>The string table</p><div class="highlight"><div class="chroma open"><div class="code-header language-txt"><span class="code-title"><i class="arrow fas fa-chevron-right fa-fw" aria-hidden="true"></i></span><span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="copy" data-clipboard-text="00000430:                               5a00 0000               Z...
00000440: 2e72 6461 7461 247a 7a7a 002e 7264 6174   .rdata$zzz..rdat
00000450: 6124 7a7a 7a00 5f5f 696d 705f 4765 7443   a$zzz.__imp_GetC
00000460: 7572 7265 6e74 5072 6f63 6573 7349 6400   urrentProcessId.
00000470: 5f5f 696d 705f 4265 6163 6f6e 5072 696e   __imp_BeaconPrin
                 ╭────────────────────────────────╮   ┌─────────────╮
00000480: 7466 00│5f 5f69 6d70 5f47 6574 5573 6572│ tf│__imp_GetUser│
         ╭───────┘      ╭─────────┬───────────────┴┬──┘  ┌──────────┘
00000490:│4e61 6d65 4100│         │                │NameA│
         └──────────────┘         │                └─────┘
                                  │
               The name of this symbol is &quot;__imp_GetUserNameA&quot;
" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span></div><div class="table-wrapper"><table><tbody><tr><td><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">00000430:                               5a00 0000               Z...
</span></span><span class="line"><span class="cl">00000440: 2e72 6461 7461 247a 7a7a 002e 7264 6174   .rdata$zzz..rdat
</span></span><span class="line"><span class="cl">00000450: 6124 7a7a 7a00 5f5f 696d 705f 4765 7443   a$zzz.__imp_GetC
</span></span><span class="line"><span class="cl">00000460: 7572 7265 6e74 5072 6f63 6573 7349 6400   urrentProcessId.
</span></span><span class="line"><span class="cl">00000470: 5f5f 696d 705f 4265 6163 6f6e 5072 696e   __imp_BeaconPrin
</span></span><span class="line"><span class="cl">                 ╭────────────────────────────────╮   ┌─────────────╮
</span></span><span class="line"><span class="cl">00000480: 7466 00│5f 5f69 6d70 5f47 6574 5573 6572│ tf│__imp_GetUser│
</span></span><span class="line"><span class="cl">         ╭───────┘      ╭─────────┬───────────────┴┬──┘  ┌──────────┘
</span></span><span class="line"><span class="cl">00000490:│4e61 6d65 4100│         │                │NameA│
</span></span><span class="line"><span class="cl">         └──────────────┘         │                └─────┘
</span></span><span class="line"><span class="cl">                                  │
</span></span><span class="line"><span class="cl">               The name of this symbol is "__imp_GetUserNameA"
</span></span></code></pre></td></tr></tbody></table></div></div></div><p>This shows how the string table is connected to the section headers and the symbol table. Now, on to how the symbol renaming works.</p><h3 id="diy-symbol-renaming" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#diy-symbol-renaming" class="header-mark"></a>DIY Symbol Renaming</h3><p>Due to the nature of how the section headers and symbol table interact with the string table, the action of renaming a symbol is pretty straightforward.</p><p>The first thing to do is to find the symbol table entry of the symbol which needs to be renamed. The name field will either hold the symbol name as a byte string or an index into the string table depending on if the name is longer than 8 bytes. If the current symbol name and new name it needs to be renamed to are both 8 bytes in length or less, the new name can be inserted directly into the name field replacing the old value. Nothing else in the COFF needs to be modified.</p><p>It is a lot more common for symbol names to be longer than 8 bytes which requires a little bit more work. There are a few ways that a symbol can be renamed but this will go over the “naive” way and another way by directly replacing the old string with the new one in the string table.</p><h4 id="the-naive-way" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#the-naive-way" class="header-mark"></a>The Naive Way</h4><p>Remember earlier in this blog post during the section explaining the COFF file layout it was mentioned that the string table is “conveniently” located at the end of the file? The reason this is convenient is because arbitrary strings can be appended to it without needing to update other parts of the COFF!</p><p>COFF metadata will occasionally contain references to other parts of the file. Inserting or removing any data in the middle of the file will cause various components to shift around. This requires going back through the COFF to make sure any old file references are updated to account for this shift. Appending data does not cause this shift so the file references will stay valid.</p><p>To rename a symbol the naive way, the new symbol name can simply be appended to the end of the string table while updating the string table size field to account for the added string. All that is left to do is change the name field in the COFF symbol table entry to reference the newly added string. The rest of the COFF can stay as is since this method does not cause any other parts of the file to shift around. The old name string can be left where it is and it will simply exist as a couple extra bytes of unused data.</p><p>This approach may not be the most ideal when a lot of symbols need to be renamed since the old symbol names will take up space.</p><h4 id="replacing-the-current-string-table-entry-with-the-new-one" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#replacing-the-current-string-table-entry-with-the-new-one" class="header-mark"></a>Replacing the Current String Table Entry with the New One</h4><p>Another option for renaming a symbol is by replacing the current symbol name in the string table with the new name. The only difference here is that the other string table references in the section headers and symbol table will need to be adjusted to account for any shifts. If a symbol needs to be renamed with a new name 9 bytes longer than the original one, any section headers or symbol table entries that reference strings past this string will need their indexes increased by 9 due to the size change.</p><h2 id="wrapping-up" class="headerLink"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#wrapping-up" class="header-mark"></a>Wrapping Up</h2><p>The purpose of this blog post is to showcase a lesser known tool from the GNU Binutils that people may not be too familiar with. Its ability to redefine symbols inside an object file is something that can be utilized in Beacon Object File development. BOFs do not need their imports to be manually declared in DFR format inside the source code. They can be managed separately while the code focuses more on what the BOF is being developed to do. Keeping the source code more inline with how traditional C code is written allows it to better integrate with existing development tools.</p><p>Another takeaway is the concept of “decoupling” the constraints of software designed to run in atypical environments from the software itself. Keeping the software more generic makes it easier to work with when needing to test or debug it. Finding alternative ways of dealing with these constraints outside of the code, either through libraries or other tooling, means that the code can focus only on what it is being designed to do while the various environmental factors are handled elsewhere.</p><p>Using a dedicated tool for managing imported functions in Beacon Object Files is one example of how this decoupling concept can be applied.</p></div><div class="post-footer" id="post-footer"><div class="post-info"><div class="post-info-line"><div class="post-info-mod"><span>Updated on 2024-11-18</span></div></div><div class="post-info-line"><div class="post-info-md"></div><div class="post-info-share"><span><a title="Share on Twitter" data-sharer="twitter" data-url="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/" data-title="Writing Beacon Object Files Without DFR" data-via="M_alphaaa" data-hashtags="development,beacon-object-files"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a title="Share on Linkedin" data-sharer="linkedin" data-url="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a></span></div></div></div><div class="post-info-more"><section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="https://blog.cybershenanigans.space/tags/development/">Development</a>,&nbsp;<a href="https://blog.cybershenanigans.space/tags/beacon-object-files/">Beacon-Object-Files</a></section><section><span><a>Back</a></span>&nbsp;|&nbsp;<span><a href="https://blog.cybershenanigans.space/">Home</a></span></section></div><div class="post-nav"><a href="https://blog.cybershenanigans.space/posts/thanatos-agent-usage/" class="prev" rel="prev" title="Thanatos: Installation and Usage"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Thanatos: Installation and Usage</a>
<a href="https://blog.cybershenanigans.space/posts/embedding-files-in-c-cpp-programs/" class="next" rel="next" title="Embedding Files in C/C++ Programs">Embedding Files in C/C++ Programs<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div></div></article></div></main></div><div id="fixed-buttons"><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#" id="back-to-top" class="fixed-button" title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
</a><a href="https://blog.cybershenanigans.space/posts/writing-bofs-without-dfr/#" id="view-comments" class="fixed-button" title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden="true"></i></a></div><!-- Cloudflare Pages Analytics --><!-- Cloudflare Pages Analytics --></body></html>