# https://www.blackhillsinfosec.com/introducing-graphrunner/

<!DOCTYPE html><html lang="en-US" data-wp-dark-mode-preset="0" style="--tf_fixed_h: 1468px;">

<body class="wp-singular post-template-default single single-post postid-27068 single-format-standard wp-theme-themify-corporate tribe-js skin-default sidebar-none default_width no-home fixed-header-enabled tb_animation_on sidemenu-active" style="--wpdm-img-opacity: 1; --wpdm-vid-opacity: 1;"><div id="simple-banner" class="simple-banner"><div class="simple-banner-text"><span><a href="https://wildwesthackinfest.com/wild-west-hackin-fest-mile-high-2026/">Join us at Wild West Hackin' Fest @ Mile High in Denver for Training, Community, and Fun!</a></span></div></div>
<svg id="tf_svg" style="display:none"><defs><symbol id="tf-fab-youtube-square" viewBox="0 0 32 32"><path d="M11.69 12.63 17.63 16l-5.94 3.38v-6.75zM28 5v22q0 1.25-.88 2.13T25 30H3q-1.25 0-2.13-.88T0 27V5q0-1.25.88-2.13T3 2h22q1.25 0 2.13.88T28 5zm-2.63 11q0-3.69-.5-5.5-.37-1.63-2-2-.75-.25-2.96-.38T15.8 8H14q-7.13 0-8.88.5-1.62.38-2 2-.25.81-.37 2.19t-.13 2.37V16q0 3.75.5 5.5.38 1.63 2 2 .75.25 2.97.38t4.1.12H14q7.13 0 8.88-.5 1.62-.44 2-2 .25-.75.37-2.12t.13-2.38v-1z"></path></symbol><symbol id="tf-fab-linkedin-square" viewBox="0 0 32 32"><path d="M26 2q.81 0 1.4.6T28 4v24q0 .81-.6 1.4T26 30H2q-.81 0-1.4-.6T0 28V4q0-.81.6-1.4T2 2h24zM8.44 26h.06V12.62H4.31V26h4.13zM6.38 10.81q1 0 1.71-.72t.72-1.68-.72-1.7T6.37 6t-1.68.72-.7 1.69.7 1.68 1.68.72zM24 26v-7.31q0-1.5-.19-2.57t-.69-1.96-1.53-1.38-2.53-.47q-1.44 0-2.47.63t-1.47 1.5h-.06v-1.82h-4V26h4.19v-6.63q0-1.56.5-2.5t1.94-.93q.75 0 1.25.3t.65.95.22 1.09.07 1.22V26H24z"></path></symbol><symbol id="tf-fab-bluesky" viewBox="0 0 576 512"><path d="M123.6 34.5c66.4 50.1 137.9 151.5 164.2 206C314 186 385.5 84.5 452 34.5c48-36.1 125.6-64.1 125.6 24.9c0 17.8-10.1 149.2-16.1 170.5c-20.7 74.2-96.1 93.1-163.1 81.6c117.2 20 147 86.3 82.6 152.6C358.7 590 305.2 432.5 291.5 392.1c-2.5-7.5-3.7-10.9-3.7-7.9c0-3.1-1.2 .4-3.7 7.9C270.4 432.5 216.9 590 94.6 464.1C30.2 397.8 60 331.5 177.2 311.5C110.2 322.9 34.8 304 14.1 229.8C8.1 208.5-2 77.1-2 59.3c0-88.9 77.7-61 125.6-24.9z"></path></symbol><symbol id="tf-fab-discord" viewBox="0 0 32 32"><path d="M18.56 15.19q0 .75-.47 1.28t-1.15.53q-.44 0-.82-.25t-.59-.66-.22-.9q0-.38.13-.69t.34-.56.53-.38.63-.12q.68 0 1.15.5t.47 1.25zm-7.43-1.75q.68 0 1.15.5t.47 1.25-.47 1.28-1.15.53-1.16-.53-.47-1.28.47-1.25 1.15-.5zM28 3.3V32q-3.63-3.2-7.44-6.76l.88 3H3.24q-1.3 0-2.27-.97T0 24.94V3.3Q0 1.94.97.97T3.25 0h21.5q1.31 0 2.28.97T28 3.3zm-4.56 15.13q0-2.25-.57-4.6t-1.18-3.53l-.57-1.18q-.62-.5-1.34-.85t-1.25-.5-.97-.25-.69-.1h-.25l-.18.26q1.18.37 2.18.9t1.38.85l.37.31q-2.75-1.56-6-1.63T8.44 9.25l-.94.5q1.3-1.25 4.19-2.13l-.13-.18q-2.19 0-4.5 1.68-.25.5-.62 1.32T5.4 13.72t-.65 4.72q.12.31.47.69t1.6 1.06 2.8.69q.63-.7 1.07-1.32-.88-.25-1.6-.71T8.12 18l-.25-.31.29.15.28.16.12.06q2.13 1.2 4.72 1.4t5.28-.84q.94-.3 1.81-.93-.8 1.31-2.87 1.93l1.06 1.25q1 0 1.85-.28t1.37-.62.94-.69.53-.6z"></path></symbol><symbol id="tf-fab-x-twitter" viewBox="0 0 512 512"><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"></path></symbol><symbol id="tf-fas-podcast" viewBox="0 0 28 32"><path d="M16.69 30.56Q16.3 32 14 32t-2.69-1.44q-.44-1.56-.87-4.22T10 22.25q0-2.75 4-2.75t4 2.75q0 1.44-.44 4.1t-.87 4.21zM9.8 18.06q.32.32-.06.57-.88.62-1.31 1.56-.25.5-.57.12Q5 17.63 5 13.75q0-3.81 2.72-6.47t6.53-2.53q3.56.13 6.12 2.66T23 13.5q.12 4.05-2.88 6.8-.3.38-.56-.12-.44-.94-1.31-1.56-.38-.25-.06-.57 1.8-1.81 1.8-4.31 0-2.56-1.84-4.34t-4.4-1.66q-2.32.13-3.97 1.78T8 13.5q-.13 2.69 1.81 4.56zM14 0q5.81 0 9.9 4.1T28 14q0 4.13-2.19 7.5t-5.69 5.06q-.18.13-.37 0t-.13-.37q.25-1.69.32-2.94 2.31-1.5 3.69-3.94T25 14q0-1.81-.56-3.47t-1.6-3.03-2.37-2.38-3.03-1.56T14 3Q9.44 3 6.22 6.22T3 13.94q0 2.8 1.31 5.25t3.57 3.93q.18.13.18.32.07 1.18.32 2.75.06.25-.13.37t-.37 0Q4.3 24.87 2.16 21.5T0 14q0-5.81 4.1-9.9T14 0zm0 10q1.69 0 2.84 1.16T18 14t-1.16 2.84T14 18t-2.84-1.16T10 14t1.16-2.84T14 10z"></path></symbol></defs></svg><div id="pagewrap" class="hfeed site">

	<div id="headerwrap">

		
		
		<!-- /#header -->

        
	</div><div class="tf_hidden tf_w" style="height: 0px; contain: strict; content-visibility: hidden;"></div>
	<!-- /#headerwrap -->

	<div id="body" class="tf_clearfix">

		<!-- layout -->
<div id="layout" class="pagewidth tf_clearfix">
            <main id="content" class="tf_clearfix">
	    <article id="post-27068" class="post tf_clearfix post-27068 type-post status-publish format-standard has-post-thumbnail hentry category-beau-bullock category-how-to category-red-team category-tool-red-team category-steve-borosh tag-azure tag-cloud tag-microsoft365-2 has-post-title has-post-date has-post-category has-post-tag has-post-comment no-post-author ">
	
	
			<div class="post-date-wrap">
			<time datetime="2023-10-19" class="post-date entry-date updated">
				<span class="day">19</span>
				<span class="month">Oct</span>
				<span class="year">2023</span>
			</time>
		</div>
	
	<div class="post-content">

					<p class="post-meta entry-meta">

									
				<span class="post-category"><a href="https://www.blackhillsinfosec.com/category/author/beau-bullock/" rel="tag" class="term-beau-bullock">Beau Bullock</a>, <a href="https://www.blackhillsinfosec.com/category/how-to/" rel="tag" class="term-how-to">How-To</a>, <a href="https://www.blackhillsinfosec.com/category/red-team/" rel="tag" class="term-red-team">Red Team</a>, <a href="https://www.blackhillsinfosec.com/category/red-team/tool-red-team/" rel="tag" class="term-tool-red-team">Red Team Tools</a>, <a href="https://www.blackhillsinfosec.com/category/author/steve-borosh/" rel="tag" class="term-steve-borosh">Steve Borosh</a></span>
									 <span class="post-tag"><a href="https://www.blackhillsinfosec.com/tag/azure/" rel="tag">Azure</a>, <a href="https://www.blackhillsinfosec.com/tag/cloud/" rel="tag">cloud</a>, <a href="https://www.blackhillsinfosec.com/tag/microsoft365-2/" rel="tag">microsoft365</a></span>				
							</p>
		
		<h1 class="post-title entry-title"><a href="https://www.blackhillsinfosec.com/introducing-graphrunner/">Introducing GraphRunner: A Post-Exploitation Toolset for Microsoft 365</a></h1>
		        <div class="entry-content">

                                        
<p>By <a href="https://www.blackhillsinfosec.com/team/beau-bullock/" target="_blank" rel="noopener noreferrer">Beau Bullock</a> &amp; <a href="https://www.blackhillsinfosec.com/team/stephan-borosh/" target="_blank" rel="noopener noreferrer">Steve Borosh</a></p>



<figure class="wp-block-image aligncenter size-full"><img fetchpriority="high" decoding="async" width="1338" height="374" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled.jpeg" alt="" class="wp-image-27070"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<h2 class="wp-block-heading">TL;DR</h2>



<p>We built a post-compromise toolset called <a href="https://github.com/dafthack/GraphRunner/" target="_blank" rel="noopener noreferrer">GraphRunner</a> for interacting with the Microsoft Graph API. It provides various tools for performing reconnaissance, persistence, and pillaging of data from a Microsoft Entra ID (Azure AD) account. Below are some of the main features. At the end of the blog post, make sure to take a peek at the potential attack path scenarios we have laid out. There are a few in there we think may be quite interesting to both offensive and defensive security team members.</p>



<h3 class="wp-block-heading"><strong>Main Features:</strong></h3>



<ul class="wp-block-list">
<li>Search and export email</li>



<li>Search and export SharePoint and OneDrive files accessible to a user</li>



<li>Search all Teams chats and channels visible to the user and export full conversations</li>



<li>Deploy malicious apps</li>



<li>Discover misconfigured mailboxes that are exposed</li>



<li>Clone security groups to carry out watering hole attacks</li>



<li>Find groups that can be modified directly by your user or where membership rules can be abused to gain access</li>



<li>Search all user attributes for specific terms</li>



<li>Leverage a GUI built on the Graph API to pillage a user’s account</li>



<li>Dump conditional access policies</li>



<li>Dump app registrations and external apps including consent and scope to identify potentially malicious apps</li>



<li>Tools to complete OAuth flow during consent grant attacks</li>



<li>Continuously refresh your token package</li>



<li>GraphRunner doesn’t rely on any third-party libraries or modules</li>



<li>Works with Windows and Linux</li>
</ul>



<p>You can find GraphRunner here: <a href="https://github.com/dafthack/GraphRunner/" target="_blank" rel="noopener noreferrer">https://github.com/dafthack/GraphRunner/</a></p>



<h2 class="wp-block-heading">The Graph API</h2>



<p>The Microsoft Graph API is undeniably one of the most important pieces of infrastructure to enable Microsoft cloud services to function. Everything from Outlook to SharePoint to Teams to Entra ID rely on this API. Most of the time when you are interacting with Microsoft services, you never visually see the Graph API but, under the hood, it is constantly being utilized. There are PowerShell modules that use it, such as the MSOnline or AzureAD modules. The AZ command line tool (az cli) also uses it. As an administrator, the Graph API is a very powerful tool for carrying out tasks in Azure.</p>



<p>But what about as a normal user?</p>



<p>During penetration tests, red team engagements, cloud assessments, and other offensive security assessments, there are often times where we obtain access to an M365 user’s account. This could be due to various attacks such as password spraying or phishing being successful. Through a web browser, we may be able to access certain resources like email and file sharing services. But there are many other data points that can be collected from a Microsoft tenant besides email and files. The Azure (Entra) Portal is a good place to start, but it can easily be locked down so that only administrative users can utilize it.</p>



<p>Luckily, access to the Graph API is necessary for much of Microsoft 365 to function. Even when access to the Azure Portal is blocked, most of the same data can be accessed via the API and, in some cases, interacted with. Through performing offensive engagements, we have found ourselves in this situation many times. In exploring what the API has to offer, through real-world engagements as well as R&amp;D sessions, a toolset began to be developed internally at BHIS.</p>



<p>In this blog post, you will find a thorough description of each piece of the toolset we are releasing. Additionally, we present several attack path scenarios to demonstrate situations where you may find this toolset useful. Some of these attack paths may be familiar while others may not. Our goal in releasing this toolset is primarily to provide offensive operators the tools they need to quickly identify security issues in Microsoft cloud environments. But this tool can also be leveraged by defenders to preemptively identify security issues and mitigate them.</p>



<p>Now, let’s dive into what <strong>GraphRunner </strong>is all about.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="624" height="372" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Picture1.jpg" alt="" class="wp-image-27092"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>There are three main pieces to GraphRunner: </p>



<ul class="wp-block-list">
<li><strong>GraphRunner.ps1 – </strong>A PowerShell script containing a number of modules for post-compromise recon, persistence, and pillaging of an account. </li>



<li><strong>GraphRunnerGUI.html</strong> – An HTML graphic user interface to be used with an access token. Provides various modules around enumeration and pillaging data from services such as Outlook, SharePoint, OneDrive, and Teams. </li>



<li><strong>PHPRedirector </strong>-A basic PHP script that can be used to capture OAuth authorization codes during an OAuth consent flow and a Python script to automatically complete the flow to obtain access tokens.</li>
</ul>



<h2 class="wp-block-heading">GraphRunner PowerShell</h2>



<p>GraphRunner includes a PowerShell set of tools to assist with carrying out various attacks during post-exploitation of a Microsoft Entra ID (Azure AD) tenant. Most of the modules rely on having authenticated access tokens. To assist with this, there are multiple modules for obtaining and working with both user and application (service principal) tokens. The majority of modules don’t require a privileged account.</p>



<p>To get started, import GraphRunner into a new PowerShell session.</p>



<pre class="wp-block-code"><code><mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-vivid-red-color"><code>Import-Module .\GraphRunner.ps1</code></mark></code></pre>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="689" height="214" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-21.png" alt="" class="wp-image-27093"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Here’s a high-level summary of each module included in the PowerShell script:</p>



<p><strong>Authentication</strong></p>



<ul class="wp-block-list">
<li><strong>Get-GraphTokens </strong>– Authenticate as a user to Microsoft Graph</li>



<li><strong>Invoke-RefreshGraphTokens</strong> – Use a refresh token to obtain new access tokens</li>



<li><strong>Get-AzureAppTokens</strong> – Complete OAuth flow as an app to obtain access tokens</li>



<li><strong>Invoke-RefreshAzureAppTokens</strong> – Use a refresh token and app credentials to refresh a token</li>



<li>I<strong>nvoke-AutoTokenRefresh</strong> – Refresh tokens at an interval</li>
</ul>



<p><strong>Recon &amp; Enumeration Modules</strong></p>



<ul class="wp-block-list">
<li><strong>Invoke-GraphRecon</strong> – Performs general recon for org info, user settings, directory sync settings, etc.</li>



<li><strong>Invoke-DumpCAPS</strong> – Gets conditional access policies</li>



<li><strong>Invoke-DumpApps</strong> – Gets app registrations and external enterprise apps, along with consent and scope info</li>



<li><strong>Get-AzureADUsers</strong> – Gets user directory</li>



<li><strong>Get-SecurityGroups</strong> – Gets security groups and members</li>



<li><strong>Get-UpdatableGroups</strong> – Gets groups that may be able to be modified by the current user</li>



<li><strong>Get-DynamicGroups</strong> – Finds dynamic groups and displays membership rules</li>



<li><strong>Get-SharePointSiteURLs </strong>– Gets a list of SharePoint site URLs visible to the current user</li>



<li><strong>Invoke-GraphOpenInboxFinder</strong> – Checks each user’s inbox in a list to see if they are readable</li>



<li><strong>Get-TenantID</strong> – Retrieves the tenant GUID from the domain name</li>
</ul>



<p><strong>Persistence Modules</strong></p>



<ul class="wp-block-list">
<li><strong>Invoke-InjectOAuthApp</strong> – Injects an app registration into the tenant</li>



<li><strong>Invoke-SecurityGroupCloner</strong> – Clones a security group while using an identical name and member list but can inject another user as well</li>



<li><strong>Invoke-InviteGuest</strong> – Invites a guest user to the tenant</li>



<li><strong>Invoke-AddGroupMember</strong> – Adds a member to a group</li>
</ul>



<p><strong>Pillage Modules</strong></p>



<ul class="wp-block-list">
<li><strong>Invoke-SearchSharePointAndOneDrive</strong> – Search across all SharePoint sites and OneDrive drives visible to the user</li>



<li><strong>Invoke-ImmersiveFileReader </strong>– Open restricted files with the immersive reader</li>



<li><strong>Invoke-SearchMailbox</strong> – Has the ability to do deep searches across a user’s mailbox and can export messages</li>



<li><strong>Invoke-SearchTeams</strong> – Can search all Teams messages in all channels that are readable by the current user</li>



<li><strong>Invoke-SearchUserAttributes</strong> – Search for terms across all user attributes in a directory</li>



<li><strong>Get-Inbox</strong> – Gets the latest inbox items from a mailbox and can be used to read other user mailboxes (shared)</li>



<li><strong>Get-TeamsChat</strong> – Downloads full Teams chat conversations</li>
</ul>



<p><strong>Invoke-GraphRunner Module</strong></p>



<ul class="wp-block-list">
<li><strong>Invoke-GraphRunner</strong> – Runs Invoke-GraphRecon, Get-AzureADUsers, Get-SecurityGroups, Invoke-DumpCAPS, Invoke-DumpApps, and then uses the default_detectors.json file to search with Invoke-SearchMailbox, Invoke-SearchSharePointAndOneDrive, and Invoke-SearchTeams.</li>
</ul>



<p><strong>Supplemental Modules</strong></p>



<ul class="wp-block-list">
<li><strong>Invoke-AutoOAuthFlow </strong>– Automates the OAuth flow completion to obtain access and refresh keys when a user grants consent to an app registration</li>



<li><strong>Invoke-DeleteOAuthApp</strong> – Delete an OAuth App</li>



<li><strong>Invoke-DeleteGroup</strong> – Delete a group</li>



<li><strong>Invoke-RemoveGroupMember</strong> – Module for removing users/members from groups</li>



<li><strong>Invoke-DriveFileDownload</strong> – Has the ability to download single files from SharePoint and OneDrive as the current user</li>



<li><strong>Invoke-CheckAccess</strong> – Check if tokens are valid</li>



<li><strong>Invoke-HTTPServer</strong> – A basic web server to use for accessing the emailviewer that is output from Invoke-SearchMailbox</li>



<li><strong>Invoke-BruteClientIDAccess </strong>– Test different client_id’s against MSGraph to determine permissions</li>



<li><strong>Invoke-ImportTokens</strong> – Import tokens from other tools for use in GraphRunner</li>



<li><strong>Get-UserObjectID</strong> – Retrieves an Object ID for a user</li>
</ul>



<h3 class="wp-block-heading">Authentication</h3>



<p>A good place to start is to authenticate with the <strong>Get-GraphTokens</strong> module. This module will launch a device-code login, allowing you to authenticate the PowerShell session from a browser session. Access and refresh tokens will be written to the global $tokens variable and your tenant ID will be written to the $tenantid variable. To use them with other GraphRunner modules use the Tokens flag (Example: Invoke-DumpApps -Tokens $tokens).</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="883" height="113" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-1.png" alt="" class="wp-image-27090"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Enter the code at <a href="http://microsoft.com/devicelogin" target="_blank" rel="noopener noreferrer">microsoft.com/devicelogin</a> to authenticate your session.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="805" height="632" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-2.png" alt="" class="wp-image-27089"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="897" height="483" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-3.png" alt="" class="wp-image-27088"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Access tokens typically have an expiration time of one hour so it will be necessary to refresh them occasionally. If you have already run the Get-GraphTokens command, your refresh tokens will be utilized from the $tokens variable automatically when you run <strong>Invoke-RefreshGraphTokens</strong> to obtain a new set of tokens.</p>



<p>GraphRunner also includes modules for authenticating as a service principal. This can be useful for leveraging an app registration (as detailed later in the Persistence section in this blog post). The <strong>Get-AzureAppTokens</strong> module can assist with completing an OAuth flow to obtain access tokens for an Azure App Registration. After obtaining an authorization code, it can be utilized with a set of app registration credentials (client id and secret) to complete the flow.</p>



<h3 class="wp-block-heading">Recon &amp; Enumeration</h3>



<p>GraphRunner includes a number of reconnaissance modules to determine configuration settings, list objects, and identify attack paths in a tenant. The <strong>Invoke-GraphRecon</strong> module gathers general information about the tenant including the primary contact info, directory sync settings, and user settings such as if users have the ability to create apps, create groups, or consent to apps. The primary contact information for the tenant is displayed along with directory sync settings, and user settings.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="657" height="256" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-4.png" alt="" class="wp-image-27087"></figure>



<figure class="wp-block-image aligncenter size-full is-resized"><img decoding="async" width="646" height="284" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-5.png" alt="" class="wp-image-27086" style="aspect-ratio:2.2746478873239435;width:660px;height:auto"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The authorization policy section includes configuration settings such as if users can read their own Bitlocker keys, who can invite external users, if MSOL PowerShell is blocked, and more.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="813" height="271" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-6.png" alt="" class="wp-image-27085"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The Invoke-GraphRecon module also has a switch called “PermissionEnum”. If this switch is set, it will use an undocumented “Estimate Access” API to brute force a list of almost 400 actions (permissions reference: <a href="https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference</a>) to determine what actions the current user is allowed to do. This is useful for discovering what unique actions your user is able to perform in the tenant. Additionally, when we get into the group editing section later in the blog post, this method is useful for helping determine what access may have changed.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="901" height="512" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-7.png" alt="" class="wp-image-27084"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The <strong>Invoke-DumpCAPS </strong>module dumps conditional access policies from a tenant. This module uses the legacy Azure Active Directory Graph API (graph.windows.net) to pull the policies.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="817" height="675" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-8.png" alt="" class="wp-image-27083"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>A module detailed later in this blog post around injecting app registrations (Invoke-InjectOAuthApp) spurred the creation of the <strong>Invoke-DumpApps</strong> module. This module can assist in identifying malicious app registrations. It will dump a list of Azure app registrations from the tenant, including permission scopes and users that have consented to the apps. Additionally, it will list external apps that are not owned by the current tenant or by Microsoft’s main app tenant. This is a way to find third-party external apps that users may have consented to.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="644" height="622" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-9.png" alt="" class="wp-image-27082"></figure>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="644" height="553" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-10.png" alt="" class="wp-image-27081"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The <strong>Get-AzureADUsers</strong> and <strong>Get-SecurityGroups</strong> modules can be used to dump users and groups from the tenant.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="642" height="366" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-11.png" alt="" class="wp-image-27080"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Group-based attacks are one of the more interesting areas to highlight when it comes to GraphRunner’s capabilities. Our first use-case for attacking M365 groups involves changing group membership of certain groups, even as a non-administrative user. For example, GraphRunner has modules that help in exploiting the fact that <strong>the default behavior for Microsoft 365 groups is that anyone in the organization can join them</strong>. Whenever a team is created, so is a Microsoft 365 group. With that comes the automatic creation of a SharePoint site, a mailbox, Teams channel, and more.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="715" height="905" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-12.png" alt="" class="wp-image-27079"><figcaption class="wp-element-caption"><a href="https://learn.microsoft.com/en-us/azure/active-directory/enterprise-users/groups-self-service-management" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/azure/active-directory/enterprise-users/groups-self-service-management</a></figcaption></figure>



<p>As detailed in Microsoft’s documentation (screenshot below), the default behavior for Microsoft 365 groups makes them open for all to join. Also, note that in some scenarios, security groups can be configured to be joinable as well.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="736" height="468" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-13.png" alt="" class="wp-image-27078"><figcaption class="wp-element-caption"><a href="https://learn.microsoft.com/en-us/microsoftteams/office-365-groups">https://learn.microsoft.com/en-us/microsoftteams/office-365-groups</a></figcaption></figure>



<p>This is where the <strong>Get-UpdatableGroups</strong> module comes in. This module also leverages the “Estimate Access” API to determine if your current user has the ability to update groups in the tenant. It will gather all groups from the tenant and check them one by one to determine if they are modifiable.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="641" height="617" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-14.png" alt="" class="wp-image-27077"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>If you find modifiable groups, that means that your current user has the ability to add members to that group, including yourself, other tenant members, and even guests. This can lead to privilege escalation scenarios as we demonstrate in the attack paths section later in the post.</p>



<p>On a similar topic, “dynamic groups” are another interesting attack path in Microsoft 365. Dynamic groups are groups that are created with dynamic group membership rules. When created, dynamic groups are configured with a set of rules that automatically process objects into groups with certain attributes. These groups can include various parameters such as the user’s email, location, job title, device, and more. They can help to automatically add users to groups but when misconfigured can be abused by attackers.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="412" height="80" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-15.png" alt="" class="wp-image-27076"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>In the example above, this dynamic group is configured to add any users whose user principal name contains the word “admin”. This scenario can be exploited by simply inviting a guest user to the tenant with an email address that contains “admin” in it. Upon being added as a guest to the tenant, the account with “admin” in the name would automatically get added to the dynamic group.</p>



<p>GraphRunner helps in finding dynamic groups with the <strong>Get-DynamicGroups</strong> module. After listing out dynamic groups in a tenant, it would be necessary to analyze the membership rules to determine the potential for exploitability.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="645" height="560" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-16.png" alt="" class="wp-image-27075"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The <strong>Get-SharePointSiteURLs</strong> module goes hand-in-hand with the groups modules mentioned previously. It uses the Graph Search API to try to locate all unique sites the user has access to. It can be useful to run both prior to and after performing any group-based abuse to determine what new sites you have gained access to.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="787" height="408" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-17.png" alt="" class="wp-image-27074"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>In 2017, I (Beau) <a href="https://www.blackhillsinfosec.com/abusing-exchange-mailbox-permissions-mailsniper/" target="_blank" rel="noopener noreferrer">wrote a post</a> about abusing Exchange mailbox permissions. Back then, I wrote a module called Invoke-OpenInboxFinder for <a href="https://github.com/dafthack/MailSniper" target="_blank" rel="noopener noreferrer">MailSniper</a> that assisted in finding mailboxes that were configured so that other users in the organization could access them. That module leveraged Exchange Web Services and Outlook Web Access. It turns out that the same type of mailbox enumeration can be performed via the Microsoft Graph API. GraphRunner has the <strong>Invoke-GraphOpenInboxFinder</strong> module to carry out this task.</p>



<p>In order for this to work, you will need a token that is scoped to the Mail.Read.Shared permission or the Mail.ReadWrite.Shared permission. This can be accomplished by consenting to an application with this scoped permission. One quick and easy way to do this is to leverage the Graph Explorer. It is a well-known application for testing out Graph API calls and you can consent to specific permissions here: <a href="https://developer.microsoft.com/en-us/graph/graph-explorer" target="_blank" rel="noopener noreferrer">https://developer.microsoft.com/en-us/graph/graph-explorer</a>. After consenting, you can click the “Access token” tab to view your token and then set it to the $tokens.access_token variable in your GraphRunner session.</p>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="478" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-18-1024x478.png" alt="" class="wp-image-27073"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Now running the Invoke-GraphOpenInboxFinder module against a userlist will attempt to access each inbox from the provided list. If a user has set their inbox permissions too widely, it’s possible your current user may be able to read messages from their inbox.</p>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="912" height="340" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-19.png" alt="" class="wp-image-27072"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<h2 class="wp-block-heading">Persistence</h2>



<p>When it comes to maintaining access, GraphRunner has a few modules that can help to establish various levels of persistence in a tenant. Deploying an application to a tenant is interesting in multiple scenarios. By default, users can create applications. But, by default, they cannot add administrative privileges such as Directory.ReadWrite.All. They can, however, add a number of delegated privileges that do not require admin consent by default. Most of these privileges that do not require admin consent are for performing common tasks such as reading email (Mail.Read), listing users in the directory (User.ReadBasic.All), navigating SharePoint and OneDrive (Files.ReadWrite.All and Sites.ReadWrite.All), and many more.</p>



<p>By deploying an app with these permissions and then consenting to it as a user we have compromised, we can then leverage the service principal credentials tied to the application to access the user’s account. If the compromised user changes their password, the app still retains access to their account. If all sessions are killed for the compromised user, we still have access until the access token expires (default is 1 hour) to operate as the user.</p>



<p>The <strong>Invoke-InjectOAuthApp</strong> module is a tool for automating the deployment of an app registration to a Microsoft tenant. In the event that the Azure portal is locked down, this may provide an additional mechanism for app deployment, provided that users are allowed to register apps in the tenant.</p>



<p>This module has a few hardcoded scope settings for quick deployment of certain types of apps, but custom values can be entered as well. For example, when setting the -scope parameter to “op backdoor”, the tool will create an app and add a large number of common permissions to it, including access to Mail, Files, Teams, and more. None of these permissions require admin consent.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="911" height="1009" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-20.png" alt="" class="wp-image-27071"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>After the app is deployed, the consent URL is automatically generated and displayed in the terminal (in green above). This URL is custom and tied to the specific app registration, including all of the requested scope items. When a user visits this URL, they will be asked to consent to the permissions set for the app.</p>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="396" height="1024" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-22-396x1024.png" alt="" class="wp-image-27113"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>A few years ago, this was leveraged heavily by attackers carrying out illicit consent grant phishing attacks. Microsoft made some changes that effectively limited what an external, unverified app could request access to for users not in the same tenant. When an app is deployed in the same tenant as the victim being phished, this is not the case. Later in the attack paths section, an internal app-based phishing scenario is laid out. But in terms of persistence, we would be visiting this link as our compromised user and consenting to it ourselves.</p>



<p>When an application with delegated permissions is consented to, we need to catch the OAuth code that is sent to the specified redirect URI in order to complete the flow and obtain access tokens. GraphRunner has multiple ways built-in to catch and complete the OAuth flow once consent has been granted. In situations where the user is remote, you would most likely want to stand up a web server and use something like the basic PHP redirector included in the GraphRunner repo to capture the code and complete the flow.</p>



<p>If we are creating persistence within an account we control, it’s possible to complete this flow by directing the browser to localhost. The <strong>Invoke-AutoOAuthFlow </strong>module stands up a minimal web server to listen for this request and completes the OAuth flow with the provided app registration credentials. When a “localhost” URL such as “http://localhost:8000” is set as the ReplyURL with Invoke-InjectOAuthApp, it will automatically detect it and ouput the exact command needed to run in another terminal to catch and complete the flow.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="907" height="161" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-1-1.png" alt="" class="wp-image-27112"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Prior to navigating to the consent URL and clicking consent, run the command that was output in another terminal. It will listen for requests to it containing the OAuth code and automatically complete the flow using the service principal’s credentials. Upon successfully completing the flow, it will output a new set of access tokens, as well as write them to the global $apptokens variable in the terminal. Now when you run GraphRunner modules, you can specify the app tokens (-Tokens $apptokens) and it will run in the context of the application leveraging the delegated permissions consented to in the user account.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="962" height="399" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-2-1.png" alt="" class="wp-image-27111"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Another potentially interesting attack vector via groups would be to create groups in an attempt to exploit watering hole-style attacks. In this scenario, an attacker would create a group to resemble another group that already exists but include their own user within it. When applying permissions to a group via the Azure Portal, the Microsoft Admin portal, SharePoint sites, and other locations, it’s not always clear exactly what group a policy is being applied to. For example, when applying a role to a resource in the Azure Portal — such as when a user is granted permissions to read, contribute, or own a resource — only the name of the group or user is displayed. No other identifiable information about the group is provided here.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="566" height="402" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-3-1.png" alt="" class="wp-image-27110"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>GraphRunner has a module called <strong>Invoke-SecurityGroupCloner</strong> that automates the ability to clone a group while adding your user or another of your choosing.</p>



<p>Running this module will list out all the groups in the tenant along with their members.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="763" height="720" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-4-1.png" alt="" class="wp-image-27109"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The Invoke-SecurityGroupCloner module will then ask what group you want to clone, if you want to add your current user to the group, if you want to add a different user, and if you want to name it something else.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="561" height="228" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-5-1.png" alt="" class="wp-image-27108"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Upon cloning a group, it will create an identically named group, adding the current members of that group while including your own user. Now when someone goes to add the “Administrators” group to a role, they will be presented with two options. Which one will they select? Maybe both?</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="574" height="462" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-6-1.png" alt="" class="wp-image-27107"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>GraphRunner also includes modules for inviting guest users (<strong>Invoke-InviteGuest</strong>) as well as adding members to groups (<strong>Invoke-AddGroupMember</strong>).</p>



<p>In order to use the Invoke-AddGroupMember module, you will need both the group ID and the member ID of the user you want to add to the group. The group ID is output with each group via the Get-SecurityGroups module and the Get-UpdatableGroups module. The user ID for your current user can be found by running Invoke-CheckAccess or using the Get-UserObjectID module.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="482" height="135" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-7-1.png" alt="" class="wp-image-27106"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="756" height="37" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-8-1.png" alt="" class="wp-image-27105"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="628" height="65" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-9-1.png" alt="" class="wp-image-27104"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<h3 class="wp-block-heading">Pillage</h3>



<p>GraphRunner includes a number of pillage modules that assist in identifying interesting data post-compromise of a Microsoft 365 account. It contains modules for searching through and collecting data from email, SharePoint, OneDrive, and Teams. The<strong> Invoke-SearchMailbox</strong> module allows for the searching of terms through the current user’s mailbox. It allows for downloading messages including their attachments and even has a minimal HTML email viewer included for opening the downloaded messages in a web browser.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="700" height="385" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-10-1.png" alt="" class="wp-image-27103"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="764" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-11-1-1024x764.png" alt="" class="wp-image-27102"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The Invoke-SearchMailbox module uses the Graph Search API, so it doesn’t allow for searching of other user’s mailbox. Also, due to the use of the Search API, only items that match the search term will be returned. If you want to get the latest messages from an inbox of either the current user or a shared mailbox, then the <strong>Get-Inbox</strong> module is the one you will want to use. This module will pull the latest 25 messages from an inbox by default; more can be specified with the -TotalMessages parameter.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="701" height="302" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-12-1.png" alt="" class="wp-image-27101"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Microsoft Teams has become the primary chat app for many organizations. Occasionally, sensitive data tends to get sent through this medium. It may be of benefit to search through Teams chat messages the user is a part of. <strong>The Invoke-SearchTeams</strong> module provides search capabilities for messages sent via Teams Chat (Direct Messages).</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="909" height="139" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-13-1.png" alt="" class="wp-image-27100"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Similarly, the <strong>Get-TeamsChat</strong> module downloads full Teams chat conversations. It will prompt to either download all conversations for a particular user or to download individual conversations using a chat ID. This module requires that you have a token scoped to Chat.ReadBasic, Chat.Read, or Chat.ReadWrite.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="626" height="345" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-14-1.png" alt="" class="wp-image-27099"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="780" height="187" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-15-1.png" alt="" class="wp-image-27098"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Occasionally, sensitive data ends up in attributes tied to user accounts. Maybe the help desk set a password for an account and didn’t want to forget it, so they set the password as a comment in an attribute. We have seen similar cases to this on many pentests, and it can lead to gaining access to other accounts not previously accessible. GraphRunner has a module to search through every attribute field for every Entra ID user called <strong>Invoke-SearchUserAttributes</strong>. Using this module, you can pass it a search term to look for in Entra ID user attributes.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="775" height="113" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-16-1.png" alt="" class="wp-image-27097"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>SharePoint is one of the largest services for file sharing and collaboration. Many organizations are using it in a similar manner to the way that internal network file shares are used to store files, some of them including sensitive data such as credentials. Historically, we have used tools such as ShareFinder and FileFinder from <a href="https://github.com/SnaffCon/Snaffler" target="_blank" rel="noopener noreferrer">PowerView</a>, or <a href="https://github.com/SnaffCon/Snaffler">Snaffler</a> to help us look for interesting files on internal networks. There is <a href="https://github.com/nheiniger/SnaffPoint/tree/main" target="_blank" rel="noopener noreferrer">SnaffPoint </a>for searching SharePoint sites but it doesn’t appear to use the Graph API. The advantage of using the <a href="https://learn.microsoft.com/en-us/graph/api/resources/search-api-overview?view=graph-rest-1.0" target="_blank" rel="noopener noreferrer">Graph Search API</a> for searching for files is that it will automatically search all SharePoint sites AND OneDrive locations accessible to your user without needing to specify a certain site.</p>



<p>The Graph Search API uses <a href="https://learn.microsoft.com/en-us/sharepoint/dev/general-development/keyword-query-language-kql-syntax-reference" target="_blank" rel="noopener noreferrer">Keyword Query Language</a> (KQL), which lets users filter searches with terms like “filetype”, “filename”, and “author”. For example, if you wanted to find all Word document files that contain the term “password” in them, you can search for “filetype:docx password”. GraphRunner has a module called <strong>Invoke-SearchSharePointAndOneDrive</strong> that leverages this search functionality and allows you to also download any files that were discovered.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="700" height="611" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-17-1.png" alt="" class="wp-image-27096"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>If you want to simulate a similar type of assessment that Snaffler and Snaffpoint do, you can leverage the provided “default_detectors.json” file in the GraphRunner repo. This file contains much of the same search syntax the other tools use, with some modifications to make them work with KQL. The following script will use Invoke-SearchSharePointAndOneDrive while looping through all of the detectors and output a CSV file called interesting-files.csv into a folder that is titled with the current date and time. The output contains the detector name that triggered, the name of the file, the Drive ID and Item ID (needed for downloading files), the last modified date, a file preview, the size of the file, and the web location (URL) where the file can be found.</p>



<pre class="wp-block-code"><code><mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-vivid-red-color">$folderName = "SharePointSearch-" + (Get-Date -Format 'yyyyMMddHHmmss')
New-Item -Path $folderName -ItemType Directory | Out-Null
$spout = "$folderName\interesting-files.csv"$DetectorFile = ".\default_detectors.json"$detectors = Get-Content $DetectorFile
$detector = $detectors |ConvertFrom-Json
foreach($detect in $detector.Detectors){Invoke-SearchSharePointAndOneDrive  -Tokens $tokens -SearchTerm $detect.SearchQuery -DetectorName $detect.DetectorName -PageResults -ResultCount 500 -ReportOnly -OutFile $spout -GraphRun}</mark>
</code></pre>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="620" height="385" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-18-1.png" alt="" class="wp-image-27095"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>If you want to download one of the files from the CSV output, you can use the supplemental module called Invoke-DriveFileDownload and specify the combined Drive ID and Item ID from the spreadsheet.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="704" height="64" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-19-1.png" alt="" class="wp-image-27094"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<h3 class="wp-block-heading">Using Immersive File Reader to Bypass SharePoint File Block</h3>



<p>Microsoft’s SharePoint Online <a href="https://support.microsoft.com/en-us/office/get-started-with-sharepoint-909ec2f0-05c8-4e92-8ad3-3f8b0b6cf261" target="_blank" rel="noopener noreferrer">service</a> allows authenticated users to manage files in a cloud storage environment. Accessing SharePoint Online may be done via a web browser to https://companyname.sharepoint.com or with the SharePoint/OneDrive app.</p>



<p>From a security perspective, controlling who has access to what in SharePoint is critical to prevent data loss. Microsoft recommends enforcing a least-privilege administrative model described here: <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/implementing-least-privilege-administrative-models" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/implementing-least-privilege-administrative-models</a>. Meaning users should only have permissions to access what <em>they</em> need. I would add that users should only be able to authenticate to a company’s SharePoint instance from a company compliant device.</p>



<p>To help prevent data loss, Microsoft provides the option to restrict access to users accessing SharePoint from unmanaged devices that are not controlled by the organization operating the SharePoint instance. <a href="https://learn.microsoft.com/en-us/sharepoint/control-access-from-unmanaged-devices" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/sharepoint/control-access-from-unmanaged-devices</a>.</p>



<p>With the policy enabled, a user browses to SharePoint Online and attempts to open a file named death_star_plans.txt.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="859" height="298" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-23.png" alt="" class="wp-image-27130"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Note the warning that security policy doesn’t allow you to download or view the file since the user is browsing from an unmanaged device.</p>



<p>When a user on an unmanaged device clicks “Open”, the security policy will block the user from opening the file.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="828" height="229" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-1-2.png" alt="" class="wp-image-27129"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>However, the option to open the file in Immersive Reader may appear under the “Open” drop-down.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="527" height="191" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-2-2.png" alt="" class="wp-image-27128"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Clicking on “Open in Immersive Reader” results in the file opening for us!</p>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="253" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-3-2-1024x253.png" alt="" class="wp-image-27127"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Immersive Reader will even speak the text to you.</p>



<p><strong>What is Immersive Reader?</strong></p>



<p>At its core, Immersive Reader is an application that performs text-to-speech within certain Microsoft applications. For Microsoft SharePoint Online, that means we can visibly and audibly “read” text files from accessible SharePoint drives.</p>



<p>More info here: <a href="https://techcommunity.microsoft.com/t5/education-blog/immersive-reader-comes-to-powerpoint-for-the-web-onedrive/ba-p/2242568" target="_blank" rel="noopener noreferrer">https://techcommunity.microsoft.com/t5/education-blog/immersive-reader-comes-to-powerpoint-for-the-web-onedrive/ba-p/2242568</a></p>



<p>Back to the previous request for “death_star_plans.txt”, we take a look at the request which opens the file with Immersive Reader.</p>



<pre class="wp-block-code"><code><mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-vivid-red-color">GET /transform/imreader?provider=spo&amp;inputFormat=txt&amp;cs=fFNQTw&amp;docid=https%3A%2F%2Ftestbeau.sharepoint.com%3A443%2F_api%2Fv2.0%2Fdrives%2Fb!UZKcPDJOak6rlVu_8sqLHrL37OSkA7tNiIu6hH3cVmYli4rws4usRomUi9sy-cG4%2Fitems%2F01F276Q3X3SAZEE3ZISRBZ7UJRBMQRKWEB%3Fversion%3DPublished&amp;access_token=&lt;eyJ0&gt;&amp;nocache=true&amp;cTag=%22c%3A%7B423290FB-286F-4394-9FD1-310B21155881%7D%2C1%22 HTTP/1.1
Host: southcentralus1-mediap.svc.ms
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/117.0
Accept: /
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: https://testbeau.sharepoint.com/
Origin: https://testbeau.sharepoint.com
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: cross-site
Te: trailers
Connection: close</mark></code></pre>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>We can see that the access_token is in the GET request. Checking the JWT in jwt.io, we see that it is scoped to SharePoint Online’s principle ID.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="434" height="66" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-4-2.png" alt="" class="wp-image-27126"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>It’s also interesting to note that the request isn’t being directed to *.sharepoint.com. Rather, it’s directed at southcentralus1-mediap.svc.ms.</p>



<h4 class="wp-block-heading"><strong>GraphRunner Weaponization</strong></h4>



<p>Implementing Invoke-ImmersiveFileRead into GraphRunner was rather easy with the captured GET request. The cmdlet takes the target SharePoint domain, DriveID, and FileID as parameters.</p>



<p>We might find the DriveID and FileID by searching SharePoint for the filename* and the filetype with extension.</p>



<pre class="wp-block-code"><code><mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-vivid-red-color">Invoke-SearchSharePointAndOneDrive -Tokens $tokens -SearchTerm "death_star_plans* AND Filetype:txt"</mark></code></pre>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="377" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-5-2-1024x377.png" alt="" class="wp-image-27125"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The file was found in two places as our user shared it in Teams as well.</p>



<p>GraphRunner will prompt you with the option to download any files that were found.</p>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="319" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-7-2-1024x319.png" alt="" class="wp-image-27123"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Attempting to download both files, we see that the Teams file successfully downloaded, because it is on the user’s personal OneDrive/SharePoint. Unfortunately, the default block policy only applies to SharePoint, which doesn’t seem to include the “tenant-my.sharepoint” sites by default.</p>



<p>Further restrictions are needed to restrict downloads from unmanaged devices on other applications. <a href="https://learn.microsoft.com/en-us/microsoftteams/block-access-sharepoint" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/microsoftteams/block-access-sharepoint</a></p>



<p>Next, we’ll use Invoke-ImmersiveFileReader to attempt to open the file we couldn’t access.</p>



<pre class="wp-block-code"><code><mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-vivid-red-color">Invoke-ImmersiveFileReader -SharePointDomain testbeau.sharepoint.com -DriveID "b!U.." -FileID ")1.." -Tokens $Tokens</mark></code></pre>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="599" height="63" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-8-2.png" alt="" class="wp-image-27122"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p></p><div style="height:25px" aria-hidden="true" class="wp-block-spacer"><span style="font-size: revert; color: initial;">Success! We’ve successfully opened the file just like the Immersive Reader feature in the browser.</span></div><p></p>



<p>Some txt files may not show the Immersive Reader as an option. These may still be viewed by Immersive Reader in some cases.</p>



<figure class="wp-block-image aligncenter size-full is-resized"><img decoding="async" width="629" height="51" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-9-2.png" alt="" class="wp-image-27121" style="aspect-ratio:12.333333333333334;width:629px;height:auto"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Now, what about reading other types of files? Here is pyauth.py on the testbeau.sharepoint.com SharePoint site.</p>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="381" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-10-2-1024x381.png" alt="" class="wp-image-27120"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>We see that the file is restricted from being open or downloaded, and, most importantly, there is no immersive file reader option. We’ll try with the Invoke-ImmersiveFileReader cmdlet.</p>



<pre class="wp-block-code"><code><mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-vivid-red-color">Invoke-SearchSharePointAndOneDrive -Tokens $tokens -SearchTerm "pyauth* AND filetype:py”</mark></code></pre>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="325" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-11-2-1024x325.png" alt="" class="wp-image-27119"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>We found the file and attempted to download it without success.</p>



<p>Even though there’s no Immersive Reader option from the browser for this Python file, we’ll try Invoke-ImmersiveFileReader anyway.</p>



<pre class="wp-block-code"><code><mark style="background-color:rgba(0, 0, 0, 0)" class="has-inline-color has-vivid-red-color">Invoke-ImmersiveFileReader -SharePointDomain testbeau.sharepoint.com -DriveID "b!UZKcPDJOak6rlVu_8sqLHrL37OSkA7tNiIu6hH3cVmYli4rws4usRomUi9sy-cG4\" -FileID "01F276Q3TIC57IYFZK3BBIDB2JE4VHVWSY" -Tokens $Tokens</mark></code></pre>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="432" height="68" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-12-2.png" alt="" class="wp-image-27118"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Success! We have accessed the data in a Python file with Immersive Reader, where there was no option from the web portal. The file should not be readable with the Unrestricted Device policy in-place as well. What other files can we read using Immersive Reader?</p>



<h3 class="wp-block-heading"><strong>Defenses Against Immersive Reader Access</strong></h3>



<p>To enforce basic protections on SharePoint Online, Microsoft requires an “<a href="https://www.microsoft.com/en-US/security/business/solutions/identity-access" target="_blank" rel="noopener noreferrer">Enterprise Mobility + Security</a>” license.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="559" height="272" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-13-2.png" alt="" class="wp-image-27117"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Next, enforce Unmanaged Device blocking policy.</p>



<p>From the SharePoint Admin Center, SharePoint administrators may enforce the Unmanaged Devices policy to block unauthorized access to files from non-compliant devices.</p>



<p>📢</p>



<p>Access is allowed on apps that don’t use modern authentication. Users who use these apps will have full access to content in SharePoint and OneDrive, even on unmanaged devices.</p>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="487" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-14-2-1024x487.png" alt="" class="wp-image-27116"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Additionally, SharePoint administrators may further modify the conditional access policy created when enabling the unmanaged device block. Further restrict authenticated users from accessing SharePoint Online files from unmanaged devices by ensuring the device is compliant and/or Hybrid joined.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="789" height="489" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-15-2.png" alt="" class="wp-image-27115"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Microsoft SharePoint Online provides administrators with the ability to restrict file downloads for authenticated users accessing the service from an unmanaged device. Using the Immersive Reader feature, we’re able to bypass unmanaged device restrictions that aren’t backed by additional conditional policy.</p>



<h2 class="wp-block-heading">Invoke-GraphRunner</h2>



<p>GraphRunner includes a function that automates the running of multiple recon and pillage modules called Invoke-GraphRunner. This module will run the Invoke-GraphRecon, Get-AzureADUsers, Get-SecurityGroups, Invoke-DumpCAPS, Invoke-DumpApps recon modules. It then uses the default_detectors.json file to search with Invoke-SearchMailbox, Invoke-SearchSharePointAndOneDrive, and Invoke-SearchTeams. This may be of benefit when trying to quickly automate data collection from an account.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="620" height="546" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-16-2.png" alt="" class="wp-image-27114"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<h2 class="wp-block-heading">GraphRunner GUI</h2>



<p>While not as fully featured as the GraphRunner PowerShell script, the HTML GUI can be useful in times when you want to visually click through items such as email, Teams messages, SharePoint/OneDrive drives, and more. All it requires is that you have an authenticated access token to the Microsoft Graph API. Each of the functionalities require different permissions, so unless your token has been scoped correctly, some functions may not work.</p>



<p>Once the GraphRunnerGUI.html file has been opened in a web browser, input your authenticated access token into the “Access Token” field. After doing so, all functionality in the page will utilize this token during requests to the Microsoft Graph API. It’s important to understand that every action against the Microsoft Graph API relies on specific permissions being scoped to the token you have. When in doubt refer to this permissions reference guide: <a href="https://learn.microsoft.com/en-us/graph/permissions-reference">https://learn.microsoft.com/en-us/graph/permissions-reference</a></p>



<p>The GUI has a “Parse Token” function that will parse your token and display the permissions that are scoped to your token.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="1019" height="537" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-24.png" alt="" class="wp-image-27143"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>There is a Custom API Request section that gives you a place to make custom requests to the API if you wish. You can use the drop down to select other HTTP methods and can use the text box to insert POST data.</p>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="469" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-1-3-1024x469.png" alt="" class="wp-image-27142"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The directory sections provide the ability to gather users and groups from the directory. The “Export” button will create a text file of the results. Clicking on a group name will display the members of that group below.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="671" height="910" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-2-3.png" alt="" class="wp-image-27141"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The “Email Viewer (Current User)” section is where you can load recent messages from the current account as well as search for specific terms. Clicking on a message will load it in an HTML email viewer below the list of emails.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="1018" height="767" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-3-3.png" alt="" class="wp-image-27140"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="261" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-4-3-1024x261.png" alt="" class="wp-image-27139"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The “Email Viewer (Other Users)” section is where you can read mailboxes that have been shared by other users. Use this in collaboration with the Invoke-GraphOpenInboxFinder module from the GraphRunner.ps1 script to discover mailboxes that have been misconfigured in the tenant to allow other users to access them.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="1020" height="914" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-5-3.png" alt="" class="wp-image-27138"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The “Send Email” section allows you to send emails from the current account, including the ability to add attachments.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="1011" height="323" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-6-3.png" alt="" class="wp-image-27137"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The “Teams Chat Viewer (Direct Messages and Group Chat)” loads Teams chat conversations where the user is either DM’ing with someone or part of a group chat. Clicking on the conversation date box will load the recent messages from that chat. While a conversation is selected messages can be sent to that particular conversation through the “Send Message to Teams Chat” text box.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="1016" height="720" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-7-3.png" alt="" class="wp-image-27136"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The “OneDrive My Files” button will load files from the current user’s OneDrive file share. Folders can be navigated through and files can be downloaded here.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="511" height="310" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-8-3.png" alt="" class="wp-image-27135"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The “OneDrive Shared Files” button will load files that have been shared with the user. This is commonly where files sent through Teams messages are located.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="388" height="293" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-9-3.png" alt="" class="wp-image-27134"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Last but not least, the SharePoint section will load the user’s SharePoint documents and allow you to download them.</p>



<figure class="wp-block-image aligncenter size-large"><img decoding="async" width="1024" height="965" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-10-3-1024x965.png" alt="" class="wp-image-27133"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<h2 class="wp-block-heading">OAuth Flow Automation</h2>



<p>Whenever a user consents to an OAuth app, their browser sends a request to a specified redirect URI to provide an authorization code. The PHPRedirector folder contains code that can be hosted on a web server to capture an OAuth authorization code as well as complete the OAuth flow. In situations where the user that is consenting to an app is remote, you may want to automatically complete the OAuth flow and obtain access and refresh tokens. The AutoOAuthFlow.py script facilitates this ability while writing any access tokens to a file on disk called access_tokens.txt.</p>



<p>When you are ready to capture codes, you can run AutoOAuthFlow.py to watch for new OAuth codes and complete the flow using your App credentials. Whenever a web request is sent to the web server that contains an OAuth code, it will be written to codes-bak.txt and will be used to attempt OAuth flow completion to obtain access tokens. If successful, the access tokens will be written to access_tokens.txt in the same directory as the Python script.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="950" height="259" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-11-3.png" alt="" class="wp-image-27132"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<h2 class="wp-block-heading">Potential Attack Paths</h2>



<p>GraphRunner has a lot of different modules that do specific tasks, but combining them can lead to interesting attack paths in certain scenarios. Below are a few examples where GraphRunner may benefit you in identifying potential situations where it can be used for persistence, privilege escalation, data harvesting, and more within an M365 account.</p>



<h3 class="wp-block-heading">Group-Based PrivEsc (Adding user)</h3>



<ol class="wp-block-list" start="1" style="list-style-type:1">
<li>Identify groups that can be modified by current user (Get-UpdatableGroups)</li>



<li>Determine current access level (Get-SharePointSites, Invoke-DumpCAPS, Check for subscription access, Invoke-GraphRecon -PermissionEnum, etc.)</li>



<li>Inject your user into the group (Invoke-AddGroupMember)</li>



<li>Re-run enumeration modules to see if there is new access to sites/policies.</li>
</ol>



<p><strong>Bonus</strong></p>



<p>Guest users can be injected into groups too, but your current user (Entra ID user in the target tenant) needs to be injected first.</p>



<h3 class="wp-block-heading">Dynamic Group PrivEsc (Abusing membership rule)</h3>



<ol class="wp-block-list" start="1" style="list-style-type:1">
<li>Identify dynamic groups (Get-DynamicGroups) that have rules that can be abused, such as a rule that adds a user to a group if their email contains “admin”.</li>



<li>Analyze membership rules to determine if they can be abused.
<ul class="wp-block-list">
<li>Example: Invite guest user to tenant with an email that has “admin” in the email address to get added as a member of a group where UPN’s that contain “admin” get automatically added to it.</li>
</ul>
</li>
</ol>



<h3 class="wp-block-heading">Watering Hole Attack via Cloned Group</h3>



<ol class="wp-block-list" start="1" style="list-style-type:1">
<li>Identify an interesting group (SharePoint Admins, Dev groups, other IT groups, etc.)</li>



<li>Clone it and add your own user (Invoke-SecurityGroupCloner)</li>



<li>Wait for an admin to mistakenly add your cloned group to a policy somewhere OR come up with a ruse to get it added</li>



<li>Monitor access to various M365 pieces like SharePoint, Teams, CAPS policies, subscriptions, etc.</li>
</ol>



<h3 class="wp-block-heading">Persistence via OAuth App</h3>



<ol class="wp-block-list" start="1" style="list-style-type:1">
<li>Inject an OAuth App registration (Invoke-InjectOAuthApp) into the same tenant as the compromised user.</li>



<li>Set up a listener to complete the OAuth flow with either Invoke-AutoOAuthFlow to catch the redirect on your localhost, or the AutoOAuthFlow.py script to catch it on another server.</li>



<li>After consenting to the app, it will generate tokens associated with the app registration that can be leveraged for accessing M365 as the user.</li>



<li>If the user changes their password, you still have access as the app.</li>



<li>If all sessions get killed, the refresh token of the app is still valid until it expires (default is 1 hour from creation time)</li>
</ol>



<h3 class="wp-block-heading">Persistence to SharePoint/OneDrive Files via Guest User access</h3>



<p>If external sharing for a site is set to allow “Anyone” or “New and existing guests” access via external sharing, then it may be possible to leverage a guest account for long term access to specific files.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="857" height="498" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-12-3.png" alt="" class="wp-image-27131"></figure>



<ol class="wp-block-list" start="1" style="list-style-type:1">
<li>Invite guest user to tenant (Invoke-InviteGuest).</li>



<li>Gather SharePoint share links and maintain long term access to files until guest user is removed.</li>
</ol>



<h2 class="wp-block-heading">Internal Phishing via OAuth App</h2>



<ol class="wp-block-list" start="1" style="list-style-type:1">
<li>Inject an OAuth app (Invoke-InjectOAuthApp) that has limited permissions (Mail.Read) into the same tenant as the compromised user.</li>



<li>Use it to perform illicit consent grant phishing attacks internally for more access.</li>
</ol>



<h3 class="wp-block-heading">Find Other Mailboxes You Can Read</h3>



<ol class="wp-block-list" start="1" style="list-style-type:1">
<li>Deploy an app with the “Mail.Read.Shared” scope into the victim tenant and consent to it with your user, or consent to this permission on the Graph Explorer and leverage the app token with GraphRunner.</li>



<li>Use Invoke-GraphOpenInboxFinder to find other mailboxes that have been shared with you.</li>



<li>Use Get-Inbox to pull the latest messages from other inboxes you can read.</li>
</ol>



<h3 class="wp-block-heading">Pillage SharePoint, Teams, and Email</h3>



<ol class="wp-block-list" start="1" style="list-style-type:1">
<li>Leverage the pillage modules to identify sensitive data sent in email (Invoke-SearchMailbox, Get-Inbox), Teams chat (Invoke-SearchTeams, Get-TeamsChat), or SharePoint (Invoke-SearchSharePointAndOneDrive).</li>



<li>Use the following command to perform “Snaffler-like” scanning of a SharePoint site:
<ul class="wp-block-list">
<li>Invoke-GraphRunner -Tokens $tokens -DisableRecon -DisableUsers -DisableGroups -DisableCAPS -DisableApps -DisableEmail -DisableTeams</li>
</ul>
</li>
</ol>



<h3 class="wp-block-heading">Search User Attributes</h3>



<ol class="wp-block-list">
<li>Leverage the Invoke-SearchUserAttributes module to identify potentially sensitive information in Entra ID user attributes.</li>
</ol>



<h3 class="wp-block-heading">Immersive File Reader</h3>



<ol class="wp-block-list" start="1" style="list-style-type:1">
<li>Use Invoke-SearchSharePointAndOneDrive to identify interesting files</li>



<li>Use Invoke-ImmersiveFileReader to download them in some environments that block file downloads from SharePoint and OneDrive.</li>
</ol>



<h3 class="wp-block-heading">Find CAP Bypasses and Enumerate Permission Scopes Using Different Client IDs</h3>



<ol class="wp-block-list" start="1" style="list-style-type:1">
<li>Gather a refresh token from an authenticated session (Ex. intercept browser).</li>



<li>Use it with the Invoke-BruteClientIDAccess module to find applications that can authenticate or be refreshed to, along with their associated permission scopes.</li>



<li>In this instance, conditional access blocked access to MSGraph from FireFox.</li>
</ol>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="517" height="342" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/A911pn54y_dh5ttw_9r8.jpg" alt="" class="wp-image-27147"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>5. As seen below, there are some clientID’s that have rights where some do not.</p>



<figure class="wp-block-image alignleft size-large"><img decoding="async" width="1024" height="254" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/A9btqa3l_dh5ttz_9r8-1024x254.jpg" alt="" class="wp-image-27144"></figure>



<p></p>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<p>6. It may be possible to abuse this for initial access via Device Code phishing by changing the ClientID for the initial code request to something like Microsoft Edge.</p>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="500" height="258" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/A9m3df0z_dh5tu2_9r8.jpg" alt="" class="wp-image-27145"></figure>



<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image aligncenter size-full"><img decoding="async" width="539" height="228" src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/A91xs9c45_dh5tu5_9r8.jpg" alt="" class="wp-image-27146"></figure>



<p>7. Successful Device Code flow bypassing a Conditional Access Policy.</p>



<h2 class="wp-block-heading">Conclusion</h2>



<p>GraphRunner was created to help identify and exploit common security issues in Microsoft 365. It’s a tool that was made for the red team, but we think blue teamers will be able to leverage it as well to proactively identify security issues. The attack surface for cloud environments continues to grow, and with that, so will GraphRunner. For the user guide and information about individual modules, check out the wiki here: <a href="https://github.com/dafthack/GraphRunner/wiki" target="_blank" rel="noopener noreferrer">https://github.com/dafthack/GraphRunner/wiki</a></p>



<p>Download GraphRunner: <a href="https://github.com/dafthack/GraphRunner/" target="_blank" rel="noopener noreferrer">https://github.com/dafthack/GraphRunner/</a></p>



<div class="wp-block-group is-layout-constrained wp-block-group-is-layout-constrained">
<div style="height:25px" aria-hidden="true" class="wp-block-spacer"></div>



<div class="wp-block-group is-layout-constrained wp-block-group-is-layout-constrained">
<div class="wp-block-group is-layout-constrained wp-block-group-is-layout-constrained">
<div class="wp-block-group is-layout-constrained wp-block-group-is-layout-constrained">
<div class="wp-block-group is-layout-constrained wp-block-group-is-layout-constrained">
<hr class="wp-block-separator has-text-color has-alpha-channel-opacity has-background is-style-default" style="background-color:#6f7070;color:#6f7070">



<hr class="wp-block-separator has-text-color has-alpha-channel-opacity has-background is-style-default" style="background-color:#2a2a74;color:#2a2a74">
</div>



<p class="has-text-align-center has-medium-font-size">*Psst* If you liked this blog, we think you’d enjoy Beau’s class:</p>
</div>



<p class="has-text-align-center has-large-font-size"><a href="https://www.antisyphontraining.com/on-demand-courses/breaching-the-cloud-w-beau-bullock/" target="_blank" rel="noopener noreferrer">Breaching the Cloud</a>&nbsp;</p>
</div>



<div class="wp-block-group is-layout-constrained wp-block-group-is-layout-constrained">
<p class="has-text-align-center has-medium-font-size">Available live/virtual and on-demand!</p>



<div class="wp-block-group is-layout-constrained wp-block-group-is-layout-constrained">
<figure class="wp-block-image aligncenter size-thumbnail"><img decoding="async" width="150" height="150" src="https://www.blackhillsinfosec.com/wp-content/uploads/2022/11/AntiSyphon_3-1-150x150.png" alt="" class="wp-image-23396"></figure>



<div class="wp-block-group is-layout-constrained wp-block-group-is-layout-constrained">
<hr class="wp-block-separator has-text-color has-alpha-channel-opacity has-background is-style-default" style="background-color:#2a2a74;color:#2a2a74">



<hr class="wp-block-separator has-text-color has-alpha-channel-opacity has-background is-style-default" style="background-color:#6f7070;color:#6f7070">
</div>
</div>
</div>
</div>
</div>


<!-- wp:themify-builder/canvas /-->
            
        </div><!-- /.entry-content -->
        

	</div>
	<!-- /.post-content -->
	
</article>
<!-- /.post -->

		<div class="post-nav tf_clearfix">
			<span class="prev"><a href="https://www.blackhillsinfosec.com/abusing-active-directory-certificate-services-part-2/" rel="prev"><span class="arrow"></span> Abusing Active Directory Certificate Services (Part 2)</a></span><span class="next"><a href="https://www.blackhillsinfosec.com/opt-for-totp/" rel="next"><span class="arrow"></span> Opt for TOTP to Deal With MFA App Sprawl</a></span>		</div>
		<!-- /.post-nav -->

	                
                    </main>
	</div>
<!-- /#layout -->

	    </div>
	<!-- /body -->

	<div id="footerwrap">

		<div id="footer-inner">

						
			<!-- /#footer -->
			
		</div>
		<!-- /.footer-inner -->

	</div>
	<!-- /#footerwrap -->

</div>
<!-- /#pagewrap -->

<!-- wp_footer -->

<div class="simple-banner simple-banner-text" style="display:none !important"></div>
<div class="wp-dark-mode-floating-switch wp-dark-mode-ignore wp-dark-mode-animation wp-dark-mode-animation-bounce " style="right: 10px; bottom: 10px;">
	<!-- call to action  -->
	
	<div class="wp-dark-mode-switch wp-dark-mode-ignore " tabindex="0" data-style="1" data-size="1" data-text-light="" data-text-dark="" data-icon-light="" data-icon-dark=""><div class="wp-dark-mode-switch-styled wp-dark-mode-switch-1" style="--wpdm-switch-scale: 1"><div class="_track wp-dark-mode-ignore"><div class="_icon wp-dark-mode-ignore"><svg viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg" class="wp-dark-mode-ignore"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.8956 0.505198C11.2091 0.818744 11.3023 1.29057 11.1316 1.69979C10.4835 3.25296 10.125 4.95832 10.125 6.75018C10.125 13.9989 16.0013 19.8752 23.25 19.8752C25.0419 19.8752 26.7472 19.5167 28.3004 18.8686C28.7096 18.6979 29.1814 18.7911 29.495 19.1046C29.8085 19.4182 29.9017 19.89 29.731 20.2992C27.4235 25.8291 21.9642 29.7189 15.5938 29.7189C7.13689 29.7189 0.28125 22.8633 0.28125 14.4064C0.28125 8.036 4.17113 2.57666 9.70097 0.269199C10.1102 0.098441 10.582 0.191653 10.8956 0.505198Z" fill="currentColor"></path></svg></div><div class="_icon wp-dark-mode-ignore"><svg viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg" class="wp-dark-mode-ignore"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.8956 0.505198C11.2091 0.818744 11.3023 1.29057 11.1316 1.69979C10.4835 3.25296 10.125 4.95832 10.125 6.75018C10.125 13.9989 16.0013 19.8752 23.25 19.8752C25.0419 19.8752 26.7472 19.5167 28.3004 18.8686C28.7096 18.6979 29.1814 18.7911 29.495 19.1046C29.8085 19.4182 29.9017 19.89 29.731 20.2992C27.4235 25.8291 21.9642 29.7189 15.5938 29.7189C7.13689 29.7189 0.28125 22.8633 0.28125 14.4064C0.28125 8.036 4.17113 2.57666 9.70097 0.269199C10.1102 0.098441 10.582 0.191653 10.8956 0.505198Z" fill="currentColor"></path></svg></div></div></div></div></div>		
		            <!--googleoff:all-->
            <!--noindex-->
            <!--noptimize-->
            
            <!--/noptimize-->
            <!--/noindex-->
            <!--googleon:all-->
            



<!-- SCHEMA BEGIN --><!-- /SCHEMA END -->



<div class="body-overlay"></div></body></html>