Title:
An Operator’s Guide to Device-Joined Hosts and the PRT Cookie

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post distills operator-focused tradecraft for abusing Entra ID (Azure AD) device-joined Windows hosts to extract a user’s Primary Refresh Token (PRT)–derived refresh token cookie from the logon session.  
- It covers how to determine whether a compromised host is Entra ID joined or hybrid joined (vs. workplace joined), and how to enumerate which “work or school” (WAM) accounts are present in the user profile to understand which identities can yield tokens.  
- The workflow uses BOFs and supporting tooling (e.g., ROADtools/roadtx) to request a nonce, extract `x-ms-RefreshTokenCredential` cookies, and then either inject them into a browser session for SSO or exchange them for access tokens to Microsoft APIs/resources.  
- A key operational impact is that tokens obtained via the PRT cookie can inherit claims like MFA satisfaction and device ID, enabling access to MFA/CAP-protected resources when other conditions (e.g., trusted IP) are met.  
- It also provides practical integration examples with common Entra/Azure post-ex toolkits (ROADrecon, TeamFiltration, MicroBurst, etc.) and ends with detection ideas based on unusual DLL-load combinations in the implant process.  
- Useful primarily for red teams/pentesters operating in hybrid/cloud environments, and for defenders hunting token-theft tradecraft on device-joined endpoints.

Technical Focus:
- Entra ID/Azure AD device join & hybrid join enumeration (NetGetAadJoinInformation, dsreg artifacts)
- Web Account Manager (WAM) account enumeration via COM / WinRT alternatives
- PRT cookie / refresh token cookie extraction (`x-ms-RefreshTokenCredential`, `x-ms-DeviceCredential`)
- Token exchange and resource-specific access token requests (Graph/AzureRM) using ROADtools/roadtx
- Browser cookie injection for SSO session hijack (Chromium tooling)
- Detection via DLL load telemetry (dsreg.dll, aadWamExtension.dll, MicrosoftAccountTokenProvider.dll)

Use Cases:
- Enumerate join state and tenant context on newly compromised Windows hosts
- Identify multiple Entra “work/school” accounts tied to a single user profile for broader token access
- Obtain PRT-derived refresh token cookies and pivot into Azure Portal/Teams/SharePoint/SSO SaaS apps
- Mint access tokens for Graph/Azure Resource Manager to run Entra/Azure post-exploitation tooling
- Blue-team hunting: detect suspicious token-gathering by correlating uncommon DLL loads in userland processes

Keywords:
Entra ID, Azure AD, PRT, Primary Refresh Token, x-ms-RefreshTokenCredential, x-ms-DeviceCredential, WAM, Web Account Manager, NetGetAadJoinInformation, NetApi32.dll, dsregcmd, dsreg.dll, DsrCLI, aadWamExtension.dll, MicrosoftAccountTokenProvider.dll, ROADtools, roadtx, ROADrecon, TokenTactics, GraphRunner, TeamFiltration, MicroBurst, Azure Resource Manager, Microsoft Graph, Conditional Access, MFA claim, BOF, Cobalt Strike, Havoc C2, Chromium cookie injection