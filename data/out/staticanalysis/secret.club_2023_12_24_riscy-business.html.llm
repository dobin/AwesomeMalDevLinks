Title:
RISC-Y Business: Raging against the reduced machine

Type:
Blog Post

Short Summary (4–8 sentences max):
- This article describes the practical engineering of a small, embeddable RISC-V (rv64) virtual machine interpreter intended for low-footprint payload execution and obfuscation.  
- Instead of designing a custom VM ISA, it leverages RISC-V for LLVM support, enabling compilation of payloads into a freestanding binary blob with a minimal CRT, relocations handling, and optional C++ init-array support.  
- The VM shares guest/host memory to keep memory operations simple and exposes minimal “syscalls” (e.g., get PEB and a generic host-call) to resolve Windows exports and invoke host APIs without RWX memory.  
- It adds hardening features such as opcode shuffling, per-instruction XOR “encryption” keyed by bytecode offset, and a threaded-interpreter dispatch using tail calls to complicate static analysis and improve performance.  
- A major component is a Windows-friendly Whole Program LLVM pipeline: embedding/extracting LLVM bitcode from PE files, fixing LLD padding issues, and retargeting x64 Windows LLVM IR to RISC-V by generating import-resolution and host-call stubs.  
- Useful for red teamers, malware developers, and reverse engineers interested in VM-based obfuscation, payload portability, and LLVM/IR-level transformation workflows on Windows.

Technical Focus:
- RISC-V rv64 interpreter design (register model, instruction decoding, dispatch)
- Freestanding toolchain/CRT0 (linker scripts, relocations, init arrays)
- VM hardening/obfuscation (opcode shuffling, bytecode XOR transform, threaded code)
- Windows internals for import resolution (PEB/Ldr lists, PE export parsing, hashing)
- Whole Program LLVM on Windows (LTO, embedded bitcode extraction, IR rewriting/retargeting)
- PE/COFF tooling quirks (LLD alignment padding, .llvmbc extraction)

Use Cases:
- Build VM-obfuscated Windows payloads that execute via an embedded interpreter
- Execute “business logic”/shellcode-like code without allocating RWX memory
- Generate diverse payload variants via opcode shuffling + instruction-stream encryption
- IR-level instrumentation/obfuscation workflows using extracted embedded bitcode
- Retarget Windows x64 programs (limited subset) into RISC-V bytecode for the VM
- Research/detection development around VM-based obfuscation and threaded interpreters

Keywords:
RISC-V, rv64im, virtual machine interpreter, threaded interpreter, musttail, tail call dispatch, opcode shuffling, bytecode encryption, XOR transform, LLVM, LTO, embedded bitcode, .llvmbc, clang-cl, lld, PE FileAlignment, Windows PEB, Ldr InLoadOrderModuleList, PE exports, x65599 hash, import stubs, freestanding CRT0, relocations R_RISCV_64