# https://github.com/pygrum/gimmick

[Skip to content](https://github.com/pygrum/gimmick#start-of-content)

You signed in with another tab or window. [Reload](https://github.com/pygrum/gimmick) to refresh your session.You signed out in another tab or window. [Reload](https://github.com/pygrum/gimmick) to refresh your session.You switched accounts on another tab or window. [Reload](https://github.com/pygrum/gimmick) to refresh your session.Dismiss alert

{{ message }}

[pygrum](https://github.com/pygrum)/ **[gimmick](https://github.com/pygrum/gimmick)** Public

- [Notifications](https://github.com/login?return_to=%2Fpygrum%2Fgimmick) You must be signed in to change notification settings
- [Fork\\
8](https://github.com/login?return_to=%2Fpygrum%2Fgimmick)
- [Star\\
64](https://github.com/login?return_to=%2Fpygrum%2Fgimmick)


Section-based payload obfuscation technique for x64


[64\\
stars](https://github.com/pygrum/gimmick/stargazers) [8\\
forks](https://github.com/pygrum/gimmick/forks) [Branches](https://github.com/pygrum/gimmick/branches) [Tags](https://github.com/pygrum/gimmick/tags) [Activity](https://github.com/pygrum/gimmick/activity)

[Star](https://github.com/login?return_to=%2Fpygrum%2Fgimmick)

[Notifications](https://github.com/login?return_to=%2Fpygrum%2Fgimmick) You must be signed in to change notification settings

# pygrum/gimmick

main

[**1** Branch](https://github.com/pygrum/gimmick/branches) [**0** Tags](https://github.com/pygrum/gimmick/tags)

[Go to Branches page](https://github.com/pygrum/gimmick/branches)[Go to Tags page](https://github.com/pygrum/gimmick/tags)

Go to file

Code

Open more actions menu

## Folders and files

| Name | Name | Last commit message | Last commit date |
| --- | --- | --- | --- |
| ## Latest commit<br>[![pygrum](https://avatars.githubusercontent.com/u/119087231?v=4&size=40)](https://github.com/pygrum)[pygrum](https://github.com/pygrum/gimmick/commits?author=pygrum)<br>[prevent strlen insertion](https://github.com/pygrum/gimmick/commit/d05a6b1026dbb636757a8245b087c59e40e40720)<br>2 years agoAug 8, 2024<br>[d05a6b1](https://github.com/pygrum/gimmick/commit/d05a6b1026dbb636757a8245b087c59e40e40720) · 2 years agoAug 8, 2024<br>## History<br>[15 Commits](https://github.com/pygrum/gimmick/commits/main/) <br>Open commit details<br>[View commit history for this file.](https://github.com/pygrum/gimmick/commits/main/) 15 Commits |
| [example](https://github.com/pygrum/gimmick/tree/main/example "example") | [example](https://github.com/pygrum/gimmick/tree/main/example "example") | [nostdlib](https://github.com/pygrum/gimmick/commit/df85bcfdd5f51a95510826bfd20b302d80d3975e "nostdlib") | 2 years agoJun 19, 2024 |
| [.gitignore](https://github.com/pygrum/gimmick/blob/main/.gitignore ".gitignore") | [.gitignore](https://github.com/pygrum/gimmick/blob/main/.gitignore ".gitignore") | [Initial commit](https://github.com/pygrum/gimmick/commit/ad10dd4c1ecc2fbfa0730eb6f2d0d299efd4b0c7 "Initial commit") | 2 years agoJun 19, 2024 |
| [CMakeLists.txt](https://github.com/pygrum/gimmick/blob/main/CMakeLists.txt "CMakeLists.txt") | [CMakeLists.txt](https://github.com/pygrum/gimmick/blob/main/CMakeLists.txt "CMakeLists.txt") | [Initial commit](https://github.com/pygrum/gimmick/commit/ad10dd4c1ecc2fbfa0730eb6f2d0d299efd4b0c7 "Initial commit") | 2 years agoJun 19, 2024 |
| [Makefile](https://github.com/pygrum/gimmick/blob/main/Makefile "Makefile") | [Makefile](https://github.com/pygrum/gimmick/blob/main/Makefile "Makefile") | [nostdlib](https://github.com/pygrum/gimmick/commit/df85bcfdd5f51a95510826bfd20b302d80d3975e "nostdlib") | 2 years agoJun 19, 2024 |
| [README.md](https://github.com/pygrum/gimmick/blob/main/README.md "README.md") | [README.md](https://github.com/pygrum/gimmick/blob/main/README.md "README.md") | [Update README](https://github.com/pygrum/gimmick/commit/55d1955fb2bdde8bcb0871dc517144fc9482fbfe "Update README") | 2 years agoJun 20, 2024 |
| [crypt.py](https://github.com/pygrum/gimmick/blob/main/crypt.py "crypt.py") | [crypt.py](https://github.com/pygrum/gimmick/blob/main/crypt.py "crypt.py") | [Initial commit](https://github.com/pygrum/gimmick/commit/ad10dd4c1ecc2fbfa0730eb6f2d0d299efd4b0c7 "Initial commit") | 2 years agoJun 19, 2024 |
| [gimmick.c](https://github.com/pygrum/gimmick/blob/main/gimmick.c "gimmick.c") | [gimmick.c](https://github.com/pygrum/gimmick/blob/main/gimmick.c "gimmick.c") | [prevent strlen insertion](https://github.com/pygrum/gimmick/commit/d05a6b1026dbb636757a8245b087c59e40e40720 "prevent strlen insertion") | 2 years agoAug 8, 2024 |
| [gimmick.h](https://github.com/pygrum/gimmick/blob/main/gimmick.h "gimmick.h") | [gimmick.h](https://github.com/pygrum/gimmick/blob/main/gimmick.h "gimmick.h") | [comments](https://github.com/pygrum/gimmick/commit/0b7f84b7cd9b1fd02e0bf0163c3bcb86d92e2339 "comments") | 2 years agoJun 19, 2024 |
| [ntdll.h](https://github.com/pygrum/gimmick/blob/main/ntdll.h "ntdll.h") | [ntdll.h](https://github.com/pygrum/gimmick/blob/main/ntdll.h "ntdll.h") | [Initial commit](https://github.com/pygrum/gimmick/commit/ad10dd4c1ecc2fbfa0730eb6f2d0d299efd4b0c7 "Initial commit") | 2 years agoJun 19, 2024 |
| [requirements.txt](https://github.com/pygrum/gimmick/blob/main/requirements.txt "requirements.txt") | [requirements.txt](https://github.com/pygrum/gimmick/blob/main/requirements.txt "requirements.txt") | [Initial commit](https://github.com/pygrum/gimmick/commit/ad10dd4c1ecc2fbfa0730eb6f2d0d299efd4b0c7 "Initial commit") | 2 years agoJun 19, 2024 |
| View all files |

## Repository files navigation

# Gimmick

[Permalink: Gimmick](https://github.com/pygrum/gimmick#gimmick)

A thread-safe, section-based payload obfuscation technique.

## How it works

[Permalink: How it works](https://github.com/pygrum/gimmick#how-it-works)

This technique allows safe, on-demand access to compile-time encrypted global variables and functions.
How? Gimmick provides an API to allow sections to be dynamically decrypted and accessed at runtime in a thread-safe way.
It also re-encrypts sections when no threads are using them.
Depending on its usage, this technique introduces just a small window for your payload to exist fully decrypted in memory.

To **decrypt** a section, Gimmick checks for the following conditions:

1. There are no other threads currently encrypting or decrypting the section simultaneously

To **encrypt** a section, Gimmick checks for the following conditions:

1. There are no other threads currently encrypting or decrypting the section simultaneously
2. There are no 'references' to the section

## Extra features

[Permalink: Extra features](https://github.com/pygrum/gimmick#extra-features)

- PIC (Position Independent Code) friendly, with custom GetModuleHandle and GetProcAddress implementations
- Dynamically loaded functions and modules that can be passed to a global instance at runtime.
- Inbuilt RC4 implementation

## Limitations

[Permalink: Limitations](https://github.com/pygrum/gimmick#limitations)

- 64-bit only (for now)
- If the executable is to be loaded by the OS, only sections that are untouched by Windows loader can be used to store data.
This technique is best used with an rDLL or Shellcode.
- All sections are marked as encrypted on initialisation, as Gimmick has no awareness of section states before they have been accessed.
It will attempt to encrypt / decrypt any section referenced by the API. Only functions and variables designated a section with the `SEC`
macro should be called, provided that the section will also be encrypted with `crypt.py` after. This really shouldn't be an issue
**provided that you only target the sections that you want to encrypt.**
- Section page protections are flipped to RW briefly during encryption and decryption.

## Run

[Permalink: Run](https://github.com/pygrum/gimmick#run)

An example multithreaded application is set up for POC purposes. It is compiled with MinGW gcc.

1. `make build` or `make release`
2. `./gimmick.exe`

### Output

[Permalink: Output](https://github.com/pygrum/gimmick#output)

```
--- Starting threads
[*][.xdata] attempting to decrypt section
[*][.xdata] decrypting section
[+][.xdata] done! releasing mutex and restoring protection.
[+][.xdata] data is now available for use.
[*][00007FF6EAE64000] -- executing callee function
[*][.rodata] attempting to decrypt section
[*][.rodata] decrypting section
[*][.xdata] attempting to decrypt section
[!][.xdata] section is already decrypted
[*][00007FF6EAE64000] -- executing callee function
[+][.rodata] done! releasing mutex and restoring protection.
[+][.rodata] data is now available for use.
[*][.rodata] attempting to decrypt section
[!][.rodata] section is already decrypted
[*][.rodata] attempting to decrypt section
[!][.rodata] section is already decrypted
[*][.rodata] attempting to decrypt section
[!][.rodata] section is already decrypted
[*][.rodata] attempting to re-encrypt section
[!][.rodata] section is in use - no re-encryption was performed
[*][.rodata] attempting to re-encrypt section
[!][.rodata] section is in use - no re-encryption was performed
[*][00007FF6EAE64000] -- exited with code 0xdead
[*][.xdata] attempting to re-encrypt section
[!][.xdata] section is in use - no re-encryption was performed
[*][.rodata] attempting to re-encrypt section
[!][.rodata] section is in use - no re-encryption was performed
[*][.rodata] attempting to re-encrypt section
[*][.rodata] re-encrypting section
[+][.rodata] successfully re-encrypted section
[*][00007FF6EAE64000] -- exited with code 0xdead
[*][.xdata] attempting to re-encrypt section
[*][.xdata] re-encrypting section
[+][.xdata] successfully re-encrypted section
```

## Usage

[Permalink: Usage](https://github.com/pygrum/gimmick#usage)

NOTE: This project is a Proof of Concept. It will likely be buggy, and I do NOT recommend using it as-is in production.
You may open a PR to fix existing issues, or simply fix these yourself privately.

1. Add `gimmick.c`, `gimmick.h` and `ntdll.h` to your project
2. Assign objects to desired sections with the `SEC` macro, separating different types (e.g. functions and variables)
3. Initialise Gimmick context with `GkInitContext`, and free with `GkFreeSectionContext`
4. Use `GkGet` (+`GkRelease`), `GkRun`, or `GkRunEx` to run functions or access variables assigned to encrypted sections
5. Compile the file with -Os and other desired flags
6. Choose sections that contain data accessed with Gimmick to encrypt (`crypt.py`) and encrypt them with the same key used
for Gimmick's context (edit in script)
7. Run your executable

## Disclaimer

[Permalink: Disclaimer](https://github.com/pygrum/gimmick#disclaimer)

This code is provided for educational and ethical
purposes only. The authors and contributors are not responsible for any
misuse of the code, including but not limited to the unlawful creation or
distribution of malware. Use this code responsibly and in accordance
with all applicable laws and regulations.

## About

Section-based payload obfuscation technique for x64


### Resources

[Readme](https://github.com/pygrum/gimmick#readme-ov-file)

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/pygrum/gimmick).

[Activity](https://github.com/pygrum/gimmick/activity)

### Stars

[**64**\\
stars](https://github.com/pygrum/gimmick/stargazers)

### Watchers

[**1**\\
watching](https://github.com/pygrum/gimmick/watchers)

### Forks

[**8**\\
forks](https://github.com/pygrum/gimmick/forks)

[Report repository](https://github.com/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fpygrum%2Fgimmick&report=pygrum+%28user%29)

## [Releases](https://github.com/pygrum/gimmick/releases)

No releases published

## [Packages\  0](https://github.com/users/pygrum/packages?repo_name=gimmick)

No packages published

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/pygrum/gimmick).

## Languages

- [C98.8%](https://github.com/pygrum/gimmick/search?l=c)
- Other1.2%

You can’t perform that action at this time.