Title:
A dive into the PE file format – PE file structure (Part 2): DOS Header, DOS Stub and Rich Header

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post breaks down the earliest parts of a Windows Portable Executable (PE): the MS-DOS header, the DOS stub, and the (undocumented) Rich Header region before the NT headers.  
- It explains why the DOS header exists for backward compatibility, and highlights the key fields Windows still relies on—especially `e_magic` (`MZ`) and `e_lfanew` (offset to NT headers).  
- The author disassembles the DOS stub as a 16-bit 8086 program, showing it prints “This program cannot be run in DOS mode.” via DOS `int 21h` and then exits.  
- It then covers the Rich Header: XOR-obfuscated metadata added by the MSVC toolchain that can reveal build tools/versions and can be modified/zeroed without breaking execution.  
- The post demonstrates manually parsing the Rich Header (XOR decode, endian handling, entry interpretation) and notes its relevance in malware attribution/false-flagging (e.g., Olympic Destroyer).  
- Useful for reverse engineers, malware analysts, and red teamers who need to parse/triage PE provenance and understand loader-relevant offsets.

Technical Focus:
- `IMAGE_DOS_HEADER` structure (`e_magic`, `e_lfanew`) and PE layout
- DOS stub 16-bit disassembly (8086) and DOS API `int 21h` usage
- Rich Header format (`DanS`/`Rich`), XOR key/checksum mechanics
- Toolchain/build metadata extraction from Rich Header entries
- Endianness considerations when parsing PE/Rich data

Use Cases:
- Rapid PE triage: locating NT headers via `e_lfanew` and validating `MZ`
- Reverse engineering the DOS stub for tampering/oddities in samples
- Extracting compiler/toolchain fingerprints from Rich Header for clustering
- Detecting or performing Rich Header manipulation for attribution deception
- Building custom PE/Rich parsers for malware analysis pipelines

Keywords:
PE file format, Portable Executable, IMAGE_DOS_HEADER, MZ, e_lfanew, DOS stub, 8086, IDA, int 21h, DOS API, Rich Header, DanS, Rich signature, XOR obfuscation, MSVC toolchain, build metadata, PE-bear, bearparser, Olympic Destroyer, malware attribution