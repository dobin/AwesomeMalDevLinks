Title:
A dive into the PE file format – LAB 1: Writing a PE Parser

Type:
Blog Post

Short Summary (4–8 sentences max):
This post walks through building a proof-of-concept PE (Portable Executable) parser in C++ to reinforce understanding of Windows PE internals. It focuses on parsing PE32 and PE32+ files and extracting key structures: DOS header, Rich header, NT headers (file/optional headers + data directories), section headers, import table, and base relocation table. The author shows how to validate a PE via the MZ signature and determine 32/64-bit type using the Optional Header magic, then implements RVA-to-file-offset translation by mapping RVAs into section ranges. It includes a practical Rich Header locator/decryptor (searching for “Rich”, XOR key extraction, decrypting back to “DanS”) and demonstrates import parsing via ILT/IAT traversal and ordinal vs name resolution. Base relocations are parsed by iterating variable-sized relocation blocks and decoding type/offset bitfields. Useful for reverse engineers, malware analysts, and red teamers who need to understand or implement low-level PE inspection logic.

Technical Focus:
- PE32 vs PE32+ identification via Optional Header magic (0x10B/0x20B)
- Parsing IMAGE_DOS_HEADER, IMAGE_NT_HEADERS, IMAGE_SECTION_HEADER, IMAGE_DATA_DIRECTORY
- RVA-to-file-offset resolution using section VA/VirtualSize and PointerToRawData
- Rich Header discovery and XOR decryption (“Rich”/“DanS”)
- Import table parsing (IMAGE_IMPORT_DESCRIPTOR, ILT/IAT, IMAGE_IMPORT_BY_NAME, ordinal flag)
- Base relocation parsing (IMAGE_BASE_RELOCATION blocks, TYPE/OFFSET bitfields)

Use Cases:
- Build a lightweight PE metadata extractor for triage and reverse engineering
- Enumerate imported DLLs/APIs to infer functionality or detect suspicious dependencies
- Inspect relocation entries to understand ASLR/relocation behavior and packing artifacts
- Extract/decode Rich Header to fingerprint toolchain/build environment hints
- Learn PE structure offsets and implement custom loaders/parsers

Keywords:
PE, Portable Executable, PE32, PE32+, IMAGE_DOS_HEADER, e_lfanew, IMAGE_NT_HEADERS, IMAGE_OPTIONAL_HEADER32, IMAGE_OPTIONAL_HEADER64, IMAGE_DATA_DIRECTORY, IMAGE_SECTION_HEADER, RVA, file offset, Rich Header, DanS, XOR key, IMAGE_IMPORT_DESCRIPTOR, ILT, IAT, IMAGE_IMPORT_BY_NAME, base relocations, IMAGE_BASE_RELOCATION, relocation type, section alignment, file alignment