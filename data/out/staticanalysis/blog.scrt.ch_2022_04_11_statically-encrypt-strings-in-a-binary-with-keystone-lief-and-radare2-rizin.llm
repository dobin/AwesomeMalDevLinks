Title:
Statically encrypt strings in a binary with Keystone, LIEF and radare2/rizin

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes a proof-of-concept pipeline to statically encrypt strings inside existing binaries (PE/ELF) and patch call sites so strings are decrypted at runtime right before use.  
- It aims to reduce static string-based detections without requiring source code, by combining binary analysis (radare2/rizin), binary rewriting (LIEF), and assembly/codegen (Keystone).  
- The workflow enumerates strings, finds xrefs, encrypts the string bytes in-place, injects a decryption routine as a new executable section, and patches the original `lea`-based string loads to call a trampoline/jump-table entry that decrypts then resumes execution.  
- The implementation focuses on 64-bit PE and ELF and uses a simple Vigenère-style cipher for demonstration, plus PIC decryption stub carving/injection.  
- Limitations include incomplete string/xref recovery, inability to handle multiple xrefs per string, and edge cases like string arrays; in testing, encrypting ~2000 mimikatz strings still didn’t evade Defender due to missed trigger strings.  
- Useful for red teamers, malware/tool developers, and reverse engineers interested in practical binary patching and instrumentation rather than a turnkey AV bypass.

Technical Focus:
- Static string discovery and xref analysis with radare2/rizin (`iz`, `axtj`, `aoj`)
- Binary rewriting and section injection with LIEF (PE/ELF)
- Trampoline/jump-table design and control-flow hijacking (call/ret patching)
- Runtime decryption stub generation (PIC) and function carving
- Keystone-based assembly generation and instruction-size/offset handling
- PE vs ELF addressing/base relocation considerations

Use Cases:
- Obfuscate high-signal strings in third-party/off-the-shelf binaries without source
- Prototype string-decryption trampolines for custom packers/loaders
- Research static detection triggers by selectively encrypting candidate strings
- Learn/teach practical binary instrumentation with r2 + LIEF + Keystone
- Build preprocessing steps for more advanced evasion pipelines (paired with other techniques)

Keywords:
radare2, rizin, r2pipe, LIEF, Keystone, PE, ELF, xref, iz, axtj, aoj, trampoline, jump table, code injection, section injection, PIC, string encryption, static analysis, binary patching, mimikatz, Windows Defender