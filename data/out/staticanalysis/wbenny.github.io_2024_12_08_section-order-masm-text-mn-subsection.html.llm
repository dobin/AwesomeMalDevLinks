Title:
Section Order, MASM, and the .text$mn Subsection

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post investigates why code/data ordering via COFF/PE section “subsections” (e.g., `.text$aa`, `.text$bb`) behaves unexpectedly when mixing MASM and MSVC for position-independent shellcode layout.  
- The author wanted a deterministic `.text` layout (small ASM stub at offset 0, aligned global data at 0x10, then C++ entrypoint) using alphabetical subsection merging during linking.  
- The surprise was that MASM’s `_TEXT` segment does not map to `.text` directly; it becomes `.text$mn`, so MASM-emitted subsections effectively become `.text$mn$aa`, altering link-time ordering relative to MSVC-emitted `.text$bb` / `.text$zz`.  
- Reverse engineering `ml64.exe` shows this translation is hardcoded in MASM’s section mapping logic; later updates note an `ALIAS('.text$aa')` workaround (avoid `_TEXT`) to force exact subsection names.  
- A second update clarifies MSVC itself defaults to `.text$mn`, implying `.text$mn` is a conventional “middle” bucket used to order CRT and other code within `.text`.  
- Useful for red teamers, exploit/shellcode authors, and low-level Windows developers who need deterministic in-memory layout and precise control over PE/COFF section ordering.

Technical Focus:
- COFF/PE section subsections and link-time alphabetical merging (`.text$*`)
- MASM segment name translation (`_TEXT` → `.text$mn`) and its impact on ordering
- MSVC pragmas for section placement (`#pragma code_seg`, `__declspec(allocate)`)
- Deterministic shellcode layout (fixed-offset embedded data + entry stub)
- Tooling/analysis of object files and assemblers (IDA, dumpbin-style inspection)
- MASM `SEGMENT ... ALIAS()` workaround for custom section naming

Use Cases:
- Building position-independent shellcode with a fixed header/data region at known offsets
- Mixing MASM stubs with C/C++ payloads while preserving deterministic layout
- Debugging unexpected PE section ordering issues in mixed-language builds
- Forcing specific code/data placement for loaders, packers, or in-memory modules
- Understanding/replicating CRT-style initialization ordering mechanisms

Keywords:
MASM, ml64.exe, MSVC, COFF, PE, section subsections, .text$mn, .text$aa, #pragma code_seg, __declspec(allocate), SEGMENT ALIAS, linker ordering, CRT initialization, .CRT$XCU, position-independent code, shellcode layout, IMAGE_SECTION_HEADER, IDA Pro, object file analysis