# https://tmpest.dev/enc_pic_str.html

<!DOCTYPE html><html>
<body>
    <article class="container">
        <article class="main article">
            <div class="index-nav">
                <a class="index-link" href="https://tmpest.dev/">index</a>
            </div>
            <h1 class="title">Build-time String Encryption for Position-Independent Code</h1>
            <section class="info">
                <span class="date">2026-01-30</span>
            </section>
            <article class="content"><blockquote>
<p>TLDR:</p>

<p>We turn this:</p>
<div class="ansi-wrapper"><pre class="ansi2html-content"><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span><span class="ansi28 ansi38-065167252 ansi48-000000000">puts</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-065167252 ansi48-000000000">pic_str</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"Hello, World!"</span><span class="ansi28 ansi38-108125156 ansi48-000000000">));</span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span></pre></div>
<p>Into this:</p>
<div class="ansi-wrapper"><pre class="ansi2html-content"><span class="ansi28"></span><span class="ansi28 ansi38-065167252 ansi48-000000000">puts</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(((</span><span class="ansi28 ansi38-199090232 ansi48-000000000">const</span><span class="ansi28 ansi38-239189093 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-239189093 ansi48-000000000"> </span><span class="ansi28 ansi38-255255255 ansi48-000000000">*</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)(({</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">struct</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-239189093 ansi48-000000000">_str_struct_1</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">{</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">   </span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-052191208 ansi48-000000000">buf</span><span class="ansi28 ansi38-108125156 ansi48-000000000">[</span><span class="ansi28 ansi38-221144070 ansi48-000000000">14</span><span class="ansi28 ansi38-108125156 ansi48-000000000">];</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">}</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _str_inst_1</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">unsigned</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> *_data_ptr</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">volatile</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">unsigned</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">long</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">long</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _key_val</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">volatile</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">unsigned</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">long</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _len = </span><span class="ansi28 ansi38-221144070 ansi48-000000000">13</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">__asm__</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">volatile</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">     </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"jmp skip_str_%=</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">     </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"str_data_%=:</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">     </span><span class="ansi28 ansi38-139205091 ansi48-000000000">".byte 0x9c, 0xc5, 0xc6, 0xef, 0xf5, 0x27, 0xe5, 0xbd, 0xbb, 0xd2, 0xc6, 0xe7, 0xbb</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">     </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"str_key_%=:</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">     </span><span class="ansi28 ansi38-139205091 ansi48-000000000">".quad 0xeac50b9a83aaa0d4</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">     </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"skip_str_%=:</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">     </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"lea str_data_%=(%%rip), %0</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">     </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"movq str_key_%=(%%rip), %1</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">     </span><span class="ansi28 ansi38-108125156 ansi48-000000000">:</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"=r"</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-255255255 ansi48-000000000">_data_ptr</span><span class="ansi28 ansi38-108125156 ansi48-000000000">),</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"=r"</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-255255255 ansi48-000000000">_key_val</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">     </span><span class="ansi28 ansi38-108125156 ansi48-000000000">:</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">     </span><span class="ansi28 ansi38-108125156 ansi48-000000000">:);</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">for</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-199090232 ansi48-000000000">volatile</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">unsigned</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">long</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _i = </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _i &lt; _len</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _i++</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">{</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">   </span><span class="ansi28 ansi38-199090232 ansi48-000000000">volatile</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">unsigned</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _key_byte = </span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-255255255 ansi48-000000000">_key_val &gt;&gt; </span><span class="ansi28 ansi38-108125156 ansi48-000000000">((</span><span class="ansi28 ansi38-255255255 ansi48-000000000">_i % </span><span class="ansi28 ansi38-221144070 ansi48-000000000">8</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> * </span><span class="ansi28 ansi38-221144070 ansi48-000000000">8</span><span class="ansi28 ansi38-108125156 ansi48-000000000">))</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> &amp; </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0xFF</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">   _str_inst_1</span><span class="ansi28 ansi38-108125156 ansi48-000000000">.</span><span class="ansi28 ansi38-052191208 ansi48-000000000">buf</span><span class="ansi28 ansi38-108125156 ansi48-000000000">[</span><span class="ansi28 ansi38-255255255 ansi48-000000000">_i</span><span class="ansi28 ansi38-108125156 ansi48-000000000">]</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> = _data_ptr</span><span class="ansi28 ansi38-108125156 ansi48-000000000">[</span><span class="ansi28 ansi38-255255255 ansi48-000000000">_i</span><span class="ansi28 ansi38-108125156 ansi48-000000000">]</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> ^ _key_byte</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">}</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _str_inst_1</span><span class="ansi28 ansi38-108125156 ansi48-000000000">.</span><span class="ansi28 ansi38-052191208 ansi48-000000000">buf</span><span class="ansi28 ansi38-108125156 ansi48-000000000">[</span><span class="ansi28 ansi38-221144070 ansi48-000000000">13</span><span class="ansi28 ansi38-108125156 ansi48-000000000">]</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> = </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _str_inst_1</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-108125156 ansi48-000000000">}).</span><span class="ansi28 ansi38-052191208 ansi48-000000000">buf</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)));</span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span></pre></div>
<p>and no longer have any string worries in our PIC payloads!</p>

<p>shellcode <a href="https://github.com/tmpest127/enc_pic_str/tree/main/examples/04-advanced-peb">example</a></p>
</blockquote>

<h1>Why?</h1>

<p>OK let’s start with PIC, which is position-independent code - sometimes also called shellcode. The main feature of this type of program is that it is just a snippet of machine instructions that can be directly executed and will JUST WORK™ (assuming the OS and architecture are correct).</p>

<p>To get a REAL PIC we can use really underrated program: <code>msfvenom</code>.</p>

<p>Shellcodes generated by msfvenom are truly PIC.</p>

<p>Let’s make one now:</p>
<div class="ansi-wrapper"><pre class="ansi2html-content">» <span class="ansi28 ansi32">msfvenom</span><span class="ansi28"> -p windows/x64/messagebox TEXT=</span><span class="ansi28 ansi33">"world"</span><span class="ansi28"> TITLE=hello -f raw -v SHELLCODE </span><span class="ansi28 ansi33">&gt;</span><span class="ansi28"> </span><span class="ansi4 ansi28">msgbox.bin</span><span class="ansi28">                  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span><span class="ansi28">[-] No arch selected, selecting arch: x64 from the payload
</span><span class="ansi28">No encoder specified, outputting raw payload
</span><span class="ansi28">Payload size: 297 bytes

» </span><span class="ansi28 ansi32">xxd</span><span class="ansi28"> </span><span class="ansi4 ansi28">msgbox.bin</span><span class="ansi28">                                                                                                
00000000: </span><span class="ansi1 ansi28 ansi31">fc</span><span class="ansi1 ansi28 ansi32">48</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">81e4</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">f0</span><span class="ansi1 ansi28 ansi34">ff</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi34">ffff</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">e8cc</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi37">0000</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi37">00</span><span class="ansi1 ansi28 ansi32">41</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">5141</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">H</span><span class="ansi1 ansi28 ansi31">...</span><span class="ansi1 ansi28 ansi34">...</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi37">...</span><span class="ansi1 ansi28 ansi32">AQA
</span><span class="ansi28">00000010: </span><span class="ansi1 ansi28 ansi32">5052</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">5156</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">4831</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">d2</span><span class="ansi1 ansi28 ansi32">65</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">48</span><span class="ansi1 ansi28 ansi31">8b</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">5260</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">48</span><span class="ansi1 ansi28 ansi31">8b</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">52</span><span class="ansi1 ansi28 ansi31">18</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi32">PRQVH1</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">eH</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">R`H</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">R</span><span class="ansi1 ansi28 ansi31">.
</span><span class="ansi28">00000020: </span><span class="ansi1 ansi28 ansi32">48</span><span class="ansi1 ansi28 ansi31">8b</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">5220</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">48</span><span class="ansi1 ansi28 ansi31">8b</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">7250</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">4d31</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">c9</span><span class="ansi1 ansi28 ansi32">48</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">0fb7</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">4a4a</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi32">H</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">R H</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">rPM1</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">H</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi32">JJ
</span><span class="ansi28">00000030: </span><span class="ansi1 ansi28 ansi32">4831</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">c0ac</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">3c61</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">7c</span><span class="ansi1 ansi28 ansi31">02</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">2c20</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">41</span><span class="ansi1 ansi28 ansi31">c1</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">c9</span><span class="ansi1 ansi28 ansi33">0d</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">41</span><span class="ansi1 ansi28 ansi31">01</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi32">H1</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi32">&lt;a|</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">, A</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi33">.</span><span class="ansi1 ansi28 ansi32">A</span><span class="ansi1 ansi28 ansi31">.
</span><span class="ansi28">00000040: </span><span class="ansi1 ansi28 ansi31">c1e2</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">ed</span><span class="ansi1 ansi28 ansi32">52</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">48</span><span class="ansi1 ansi28 ansi31">8b</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">5220</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">4151</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">8b</span><span class="ansi1 ansi28 ansi32">42</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">3c48</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">01d0</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi31">...</span><span class="ansi1 ansi28 ansi32">RH</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">R AQ</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">B&lt;H</span><span class="ansi1 ansi28 ansi31">..
</span><span class="ansi28">00000050: </span><span class="ansi1 ansi28 ansi32">66</span><span class="ansi1 ansi28 ansi31">81</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">78</span><span class="ansi1 ansi28 ansi31">18</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">0b02</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">0f85</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">72</span><span class="ansi1 ansi28 ansi37">00</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi37">0000</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">8b80</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">88</span><span class="ansi1 ansi28 ansi37">00</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi32">f</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">x</span><span class="ansi1 ansi28 ansi31">.....</span><span class="ansi1 ansi28 ansi32">r</span><span class="ansi1 ansi28 ansi37">...</span><span class="ansi1 ansi28 ansi31">...</span><span class="ansi1 ansi28 ansi37">.
</span><span class="ansi28">00000060: </span><span class="ansi1 ansi28 ansi37">0000</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">48</span><span class="ansi1 ansi28 ansi31">85</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">c0</span><span class="ansi1 ansi28 ansi32">74</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">6748</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">01d0</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">44</span><span class="ansi1 ansi28 ansi31">8b</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">4020</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">5049</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi37">..</span><span class="ansi1 ansi28 ansi32">H</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi32">tgH</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi32">D</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">@ PI
</span><span class="ansi28">00000070: </span><span class="ansi1 ansi28 ansi31">01d0</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">8b</span><span class="ansi1 ansi28 ansi32">48</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">18e3</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">564d</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">31</span><span class="ansi1 ansi28 ansi31">c9</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">48</span><span class="ansi1 ansi28 ansi34">ff</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">c9</span><span class="ansi1 ansi28 ansi32">41</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">8b</span><span class="ansi1 ansi28 ansi32">34</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi31">...</span><span class="ansi1 ansi28 ansi32">H</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi32">VM1</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">H</span><span class="ansi1 ansi28 ansi34">.</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">A</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">4
</span><span class="ansi28">00000080: </span><span class="ansi1 ansi28 ansi31">88</span><span class="ansi1 ansi28 ansi32">48</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">01d6</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">4831</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">c0</span><span class="ansi1 ansi28 ansi32">41</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">c1c9</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi33">0d</span><span class="ansi1 ansi28 ansi31">ac</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">41</span><span class="ansi1 ansi28 ansi31">01</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">c1</span><span class="ansi1 ansi28 ansi32">38</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">H</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi32">H1</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">A</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi33">.</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">A</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi32">8
</span><span class="ansi28">00000090: </span><span class="ansi1 ansi28 ansi31">e0</span><span class="ansi1 ansi28 ansi32">75</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">f1</span><span class="ansi1 ansi28 ansi32">4c</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">03</span><span class="ansi1 ansi28 ansi32">4c</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">24</span><span class="ansi1 ansi28 ansi31">08</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">4539</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">d1</span><span class="ansi1 ansi28 ansi32">75</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">d8</span><span class="ansi1 ansi28 ansi32">58</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">44</span><span class="ansi1 ansi28 ansi31">8b</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">u</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">L</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">L$</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">E9</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">u</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">XD</span><span class="ansi1 ansi28 ansi31">.
</span><span class="ansi28">000000a0: </span><span class="ansi1 ansi28 ansi32">4024</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">49</span><span class="ansi1 ansi28 ansi31">01</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">d0</span><span class="ansi1 ansi28 ansi32">66</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">41</span><span class="ansi1 ansi28 ansi31">8b</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">0c</span><span class="ansi1 ansi28 ansi32">48</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">44</span><span class="ansi1 ansi28 ansi31">8b</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">40</span><span class="ansi1 ansi28 ansi31">1c</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">49</span><span class="ansi1 ansi28 ansi31">01</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi32">@$I</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi32">fA</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi32">HD</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">@</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">I</span><span class="ansi1 ansi28 ansi31">.
</span><span class="ansi28">000000b0: </span><span class="ansi1 ansi28 ansi31">d0</span><span class="ansi1 ansi28 ansi32">41</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">8b04</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">88</span><span class="ansi1 ansi28 ansi32">48</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">01d0</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">4158</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">4158</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">5e59</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">5a41</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">A</span><span class="ansi1 ansi28 ansi31">...</span><span class="ansi1 ansi28 ansi32">H</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi32">AXAX^YZA
</span><span class="ansi28">000000c0: </span><span class="ansi1 ansi28 ansi32">5841</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">5941</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">5a48</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">83ec</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">2041</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">52</span><span class="ansi1 ansi28 ansi34">ff</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">e0</span><span class="ansi1 ansi28 ansi32">58</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">4159</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi32">XAYAZH</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi32"> AR</span><span class="ansi1 ansi28 ansi34">.</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">XAY
</span><span class="ansi28">000000d0: </span><span class="ansi1 ansi28 ansi32">5a48</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">8b12</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">e9</span><span class="ansi1 ansi28 ansi32">4b</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi34">ffff</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi34">ff</span><span class="ansi1 ansi28 ansi32">5d</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">e80b</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi37">0000</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi37">00</span><span class="ansi1 ansi28 ansi32">75</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi32">ZH</span><span class="ansi1 ansi28 ansi31">...</span><span class="ansi1 ansi28 ansi32">K</span><span class="ansi1 ansi28 ansi34">...</span><span class="ansi1 ansi28 ansi32">]</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi37">...</span><span class="ansi1 ansi28 ansi32">u
</span><span class="ansi28">000000e0: </span><span class="ansi1 ansi28 ansi32">7365</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">7233</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">322e</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">646c</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">6c</span><span class="ansi1 ansi28 ansi37">00</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">5941</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">ba</span><span class="ansi1 ansi28 ansi32">4c</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">7726</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi32">ser32.dll</span><span class="ansi1 ansi28 ansi37">.</span><span class="ansi1 ansi28 ansi32">YA</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">Lw&amp;
</span><span class="ansi28">000000f0: </span><span class="ansi1 ansi28 ansi31">07</span><span class="ansi1 ansi28 ansi34">ff</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">d5</span><span class="ansi1 ansi28 ansi32">49</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">c7c1</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi37">0000</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi37">0000</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">e806</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi37">0000</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi37">00</span><span class="ansi1 ansi28 ansi32">77</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi34">.</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">I</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi37">....</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi37">...</span><span class="ansi1 ansi28 ansi32">w
</span><span class="ansi28">00000100: </span><span class="ansi1 ansi28 ansi32">6f72</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">6c64</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi37">00</span><span class="ansi1 ansi28 ansi32">5a</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">e806</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi37">0000</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi37">00</span><span class="ansi1 ansi28 ansi32">68</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">656c</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">6c6f</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi32">orld</span><span class="ansi1 ansi28 ansi37">.</span><span class="ansi1 ansi28 ansi32">Z</span><span class="ansi1 ansi28 ansi31">..</span><span class="ansi1 ansi28 ansi37">...</span><span class="ansi1 ansi28 ansi32">hello
</span><span class="ansi28">00000110: </span><span class="ansi1 ansi28 ansi37">00</span><span class="ansi1 ansi28 ansi32">41</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">5848</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">31</span><span class="ansi1 ansi28 ansi31">c9</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">41</span><span class="ansi1 ansi28 ansi31">ba</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">45</span><span class="ansi1 ansi28 ansi31">83</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">56</span><span class="ansi1 ansi28 ansi31">07</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi34">ff</span><span class="ansi1 ansi28 ansi31">d5</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">4831</span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi37">.</span><span class="ansi1 ansi28 ansi32">AXH1</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">A</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">E</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">V</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi34">.</span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">H1
</span><span class="ansi28">00000120: </span><span class="ansi1 ansi28 ansi31">c9</span><span class="ansi1 ansi28 ansi32">41</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">baf0</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">b5a2</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi32">56</span><span class="ansi1 ansi28 ansi34">ff</span><span class="ansi28"> </span><span class="ansi1 ansi28 ansi31">d5</span><span class="ansi28">          </span><span class="ansi1 ansi28 ansi31">       </span><span class="ansi28">  </span><span class="ansi1 ansi28 ansi31">.</span><span class="ansi1 ansi28 ansi32">A</span><span class="ansi1 ansi28 ansi31">....</span><span class="ansi1 ansi28 ansi32">V</span><span class="ansi1 ansi28 ansi34">.</span><span class="ansi1 ansi28 ansi31">.</span></pre></div>
<p>The bytes generated by this msfvenom are a completely independent program to pop a messagebox. No DLLs are needed, no installers, nothing written to disk, no online downloads.
Makes you wonder why we’re shipping 1GB Electron apps when this is all it takes. But that is besides the point.</p>

<p>Here we see the topic of our discussion: STRINGS. If you look closely at the output you can see strings <code>hello</code> and <code>world</code> directly embedded into the shellcode.</p>

<p>The main goal of this shellcode is just to call this WinAPI function:</p>
<div class="ansi-wrapper"><pre class="ansi2html-content"><span class="ansi28"></span><span class="ansi28 ansi38-221144070 ansi48-000000000">int</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-065167252 ansi48-000000000">MessageBoxA</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">    </span><span class="ansi28 ansi38-239189093 ansi48-000000000">HWND</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-246088102 ansi48-000000000">hWnd</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000">        </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Handle to owner window (we can just pass 0 here)</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">    </span><span class="ansi28 ansi38-239189093 ansi48-000000000">LPCSTR</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-246088102 ansi48-000000000">lpText</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000">    </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Pointer to message text</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">    </span><span class="ansi28 ansi38-239189093 ansi48-000000000">LPCSTR</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-246088102 ansi48-000000000">lpCaption</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Pointer to title/caption text</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">    </span><span class="ansi28 ansi38-239189093 ansi48-000000000">UINT</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-246088102 ansi48-000000000">uType</span><span class="ansi28 ansi38-255255255 ansi48-000000000">        </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Dialog box style</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-108125156 ansi48-000000000">);</span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span></pre></div>
<p>But shellcode should be just ASM - how are strings encoded/stored into assembly?</p>

<p><img src="https://tmpest.dev/images/use-the-source.jpg" alt="Demo" style="width: 60%;"></p>

<p>Fortunately the Metasploit Framework is open <a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/payloads/singles/windows/x64/messagebox.rb">source</a>:</p>

<p>Per the Windows x64 <a href="https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170">calling convention</a>
we shove values into registers and call the <a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-messageboxa">function</a>.</p>

<table>
<thead>
<tr>
<th>Register</th>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>RCX</td>
<td>1st - hWnd</td>
<td>Window handle</td>
</tr>

<tr>
<td>RDX</td>
<td>2nd - lpText</td>
<td>Message text</td>
</tr>

<tr>
<td>R8</td>
<td>3rd - lpCaption</td>
<td>Title text</td>
</tr>

<tr>
<td>R9</td>
<td>4th - uType</td>
<td>Style flags</td>
</tr>
</tbody>
</table>
<p>And that’s exactly what the shellcode does:</p>
<div class="ansi-wrapper"><pre class="ansi2html-content"><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">payload_asm = </span><span class="ansi28 ansi38-139205091 ansi48-000000000">%(</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  cld</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  and rsp,0xfffffffffffffff0</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  call start_main</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  </span><span class="ansi28 ansi38-246088102 ansi48-000000000">#{</span><span class="ansi28 ansi38-255255255 ansi48-000000000">asm_block_api</span><span class="ansi28 ansi38-246088102 ansi48-000000000">}</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">start_main:</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  pop rbp</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  call get_user32</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  db "user32.dll", 0x00</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">get_user32:</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  pop rcx</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  mov r10d, </span><span class="ansi28 ansi38-246088102 ansi48-000000000">#{</span><span class="ansi28 ansi38-239189093 ansi48-000000000">Rex</span><span class="ansi28 ansi38-108125156 ansi48-000000000">::</span><span class="ansi28 ansi38-239189093 ansi48-000000000">Text</span><span class="ansi28 ansi38-108125156 ansi48-000000000">.</span><span class="ansi28 ansi38-065167252 ansi48-000000000">block_api_hash</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-139205091 ansi48-000000000">'kernel32.dll'</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-139205091 ansi48-000000000">'LoadLibraryA'</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)</span><span class="ansi28 ansi38-246088102 ansi48-000000000">}</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  call rbp</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  mov r9, </span><span class="ansi28 ansi38-246088102 ansi48-000000000">#{</span><span class="ansi28 ansi38-255255255 ansi48-000000000">style</span><span class="ansi28 ansi38-246088102 ansi48-000000000">}</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  call get_text</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  </span><span class="ansi28 ansi38-000000000 ansi48-242204129">db "#{datastore['TEXT']}", 0x00</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">get_text:</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  pop rdx</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  call get_title</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  </span><span class="ansi28 ansi38-000000000 ansi48-242204129">db "#{datastore['TITLE']}", 0x00</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">get_title:</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  pop r8</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  xor rcx,rcx</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  mov r10d, </span><span class="ansi28 ansi38-246088102 ansi48-000000000">#{</span><span class="ansi28 ansi38-239189093 ansi48-000000000">Rex</span><span class="ansi28 ansi38-108125156 ansi48-000000000">::</span><span class="ansi28 ansi38-239189093 ansi48-000000000">Text</span><span class="ansi28 ansi38-108125156 ansi48-000000000">.</span><span class="ansi28 ansi38-065167252 ansi48-000000000">block_api_hash</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-139205091 ansi48-000000000">'user32.dll'</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-139205091 ansi48-000000000">'MessageBoxA'</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)</span><span class="ansi28 ansi38-246088102 ansi48-000000000">}</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  call rbp</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">exitfunk:</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">  </span><span class="ansi28 ansi38-246088102 ansi48-000000000">#{</span><span class="ansi28 ansi38-255255255 ansi48-000000000">exitfunc_asm</span><span class="ansi28 ansi38-246088102 ansi48-000000000">}</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-139205091 ansi48-000000000">)</span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span></pre></div>
<p>In the assembly above we observe a few things:</p>

<ol>
<li><p>Strings are just stored as <code>db</code> blocks</p></li>

<li><p>Their addresses are pushed on the stack using the <code>call</code> instruction and popped into registers with <code>pop rdx</code>, <code>pop r8</code> and <code>pop r9</code></p></li>

<li><p><code>rcx</code> is set to zero using <code>xor rcx, rcx</code>.</p></li>
</ol>

<p>Using the <code>call</code> instruction this way may seem odd (like it did to me) but it’s pretty clever and efficient.</p>

<blockquote>
<p>So how is this different from normal programs?</p>
</blockquote>

<p>Let’s compile a basic hello world:</p>
<div class="ansi-wrapper"><pre class="ansi2html-content">» <span class="ansi28 ansi32">cat</span><span class="ansi28"> </span><span class="ansi28 ansi33">&gt;</span><span class="ansi28"> </span><span class="ansi4 ansi28">main.c</span><span class="ansi28"> </span><span class="ansi28 ansi33">&lt;&lt;</span><span class="ansi28"> </span><span class="ansi28 ansi33">'EOF'
</span><span class="ansi28"></span><span class="ansi1 ansi28 ansi31">#include</span><span class="ansi28"> </span><span class="ansi28 ansi33">&lt;</span><span class="ansi28">stdio.h</span><span class="ansi28 ansi33">&gt;

</span><span class="ansi28"></span><span class="ansi1 ansi28 ansi31">int</span><span class="ansi28"> main</span><span class="ansi28 ansi33">()</span><span class="ansi28"> </span><span class="ansi28 ansi33">{
</span><span class="ansi28">    </span><span class="ansi1 ansi28 ansi31">printf("Hello, World!\n")</span><span class="ansi28">;
</span><span class="ansi28">    </span><span class="ansi28 ansi32">return</span><span class="ansi28"> 0;
</span><span class="ansi28"></span><span class="ansi28 ansi33">}
</span><span class="ansi28"></span><span class="ansi1 ansi28 ansi31">EOF
</span><span class="ansi28">
» </span><span class="ansi28 ansi32">x86_64-w64-mingw32-gcc</span><span class="ansi28"> </span><span class="ansi4 ansi28">main.c</span><span class="ansi28"> -ggdb -o </span><span class="ansi4 ansi28">main.exe
</span><span class="ansi28">
» </span><span class="ansi28 ansi32">x86_64-w64-mingw32-objdump</span><span class="ansi28"> -DrS -M intel --disassembler-color=on --disassemble=main </span><span class="ansi4 ansi28">main.exe
</span><span class="ansi28">main.exe:     file format pei-x86-64
</span><span class="ansi28">Disassembly of section .text:
</span><span class="ansi28">0000000140001540 &lt;main&gt;:
</span><span class="ansi28">#include &lt;stdio.h&gt;

</span><span class="ansi28">int main() {
</span><span class="ansi28">   140001540:	55                   	</span><span class="ansi28 ansi33">push   </span><span class="ansi28 ansi34">rbp
</span><span class="ansi28">   140001541:	48 89 e5             	</span><span class="ansi28 ansi33">mov    </span><span class="ansi28 ansi34">rbp</span><span class="ansi28">,</span><span class="ansi28 ansi34">rsp
</span><span class="ansi28">   140001544:	48 83 ec 20          	</span><span class="ansi28 ansi33">sub    </span><span class="ansi28 ansi34">rsp</span><span class="ansi28">,</span><span class="ansi28 ansi35">0x20
</span><span class="ansi28">   140001548:	e8 f3 00 00 00       	</span><span class="ansi28 ansi33">call   </span><span class="ansi28 ansi35">140001640</span><span class="ansi28"> &lt;</span><span class="ansi28 ansi32">__main</span><span class="ansi28">&gt;
</span><span class="ansi28">    printf("Hello, World!\n");
</span><span class="ansi28">   14000154d:	48 8d 05 fc 2a 00 00 	</span><span class="ansi28 ansi33">lea    </span><span class="ansi28 ansi34">rax</span><span class="ansi28">,[</span><span class="ansi28 ansi34">rip</span><span class="ansi28">+</span><span class="ansi28 ansi35">0x2afc</span><span class="ansi28">]        # 140004050 &lt;.rdata&gt;
</span><span class="ansi28">   140001554:	48 89 c1             	</span><span class="ansi28 ansi33">mov    </span><span class="ansi28 ansi34">rcx</span><span class="ansi28">,</span><span class="ansi28 ansi34">rax
</span><span class="ansi28">   140001557:	e8 94 12 00 00       	</span><span class="ansi28 ansi33">call   </span><span class="ansi28 ansi35">1400027f0</span><span class="ansi28"> &lt;</span><span class="ansi28 ansi32">puts</span><span class="ansi28">&gt;
</span><span class="ansi28">    return 0;
</span><span class="ansi28">   14000155c:	b8 00 00 00 00       	</span><span class="ansi28 ansi33">mov    </span><span class="ansi28 ansi34">eax</span><span class="ansi28">,</span><span class="ansi28 ansi35">0x0
</span><span class="ansi28">}
</span><span class="ansi28">   140001561:	48 83 c4 20          	</span><span class="ansi28 ansi33">add    </span><span class="ansi28 ansi34">rsp</span><span class="ansi28">,</span><span class="ansi28 ansi35">0x20
</span><span class="ansi28">   140001565:	5d                   	</span><span class="ansi28 ansi33">pop    </span><span class="ansi28 ansi34">rbp
</span><span class="ansi28">   140001566:	c3                   	</span><span class="ansi28 ansi33">ret

» </span><span class="ansi28 ansi32">x86_64-w64-mingw32-objdump</span><span class="ansi28"> -s </span><span class="ansi4 ansi28">main.exe</span><span class="ansi28"> | </span><span class="ansi28 ansi32">grep</span><span class="ansi28"> .rdata -A 7
</span><span class="ansi28">Contents of section .rdata:
</span><span class="ansi28"> 140004000 6c696267 63635f73 5f647732 2d312e64  libgcc_s_dw2-1.d
</span><span class="ansi28"> 140004010 6c6c005f 5f726567 69737465 725f6672  ll.__register_fr
</span><span class="ansi28"> 140004020 616d655f 696e666f 005f5f64 65726567  ame_info.__dereg
</span><span class="ansi28"> 140004030 69737465 725f6672 616d655f 696e666f  ister_frame_info
</span><span class="ansi28"> 140004040 00000000 00000000 00000000 00000000  ................
</span><span class="ansi28"> 140004050 48656c6c 6f2c2057 6f726c64 21000000  Hello, World!...
</span><span class="ansi28"> 140004060 90160040 01000000 00000000 00000000  ...@............</span></pre></div>
<p>The string is nowhere to be seen in the <code>.text</code> section. The compiler stashed it in <code>.rdata</code> and referenced it by offset. Now our program’s split in two - steal just <code>.text</code> and it breaks. To make this shellcode-ready, you’d need to drag <code>.rdata</code> along and fix up offsets yourself. I won’t bore you with relocation mechanics; Raphael Mudge covered that beautifully in his Crystal Palace <a href="https://tradecraftgarden.org/videos.html">series</a>.</p>

<p>So… yeah normal programs are quite different from msfvenom shellcodes.</p>

<blockquote>
<p>This has to be a solved problem right? Surely others have already tackled and solved this.</p>
</blockquote>

<p>I had whole sections breaking down each of these methods - history, implementation details, my personal opinions on all of them. Then I realized: nobody’s going to read that. So here’s the tl;dr in table form instead.</p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Notes</th>
</tr>
</thead>

<tbody>
<tr>
<td>Stack Strings</td>
<td>Manual character-by-character construction on stack. Bad DX, gets <a href="https://code.ornl.gov/llvm-doe/llvm-project/-/blob/2a78c6d45d4965df35e8cb766f557e7ae52477a8/clang/lib/CodeGen/CGDecl.cpp#L1276">promoted to .rdata</a> by compiler. Good <a href="https://github.com/codewhitesec/Lastenzug/blob/5b9a1a37307e4dc7b03d74a931492e838efb9208/LastenPIC/src/WS.c#L11">enough</a> for <a href="https://cloud.google.com/blog/topics/threat-intelligence/suspected-iranian-unc1549-targets-israel-middle-east#:~:text=once%2E-,LIGHTRAIL,as%20Lastenzug">APTs</a> lol</td>
</tr>

<tr>
<td><a href="https://github.com/TheWover/donut">Donut</a><a href="https://www.youtube.com/watch?v=crZF0YNORIY">s</a></td>
<td>Wraps payloads with custom loader. Solves PIC (<a href="https://github.com/MythicAgents/Apollo/blob/64946d938bd7328e80807e264081407d6b7f9185/Payload_Type/apollo/apollo/mythic/agent_functions/builder.py#L272-L277">Mythic</a>, <a href="https://github.com/BishopFox/sliver/blob/a3a98858fd088111cb4842fd510573994045330b/server/generate/binaries.go#L186">Sliver</a>) but heavily <a href="https://bazaar.abuse.ch/browse/yara/malware_donut_shellcode/">signatured</a></td>
</tr>

<tr>
<td><a href="https://5pider.net/blog/2024/01/27/modern-shellcode-implant-design/">Stardust</a></td>
<td>Forces .rdata into .text via linker <a href="https://github.com/Cracked5pider/Stardust/blob/main/scripts/linker.ld">script</a>. Fundamental post, elegant, not encrypted, C++</td>
</tr>

<tr>
<td><a href="https://tradecraftgarden.org/crystalpalace.html">Crystal Palace</a></td>
<td>Custom linker for building PICs. Groundbreaking, supports whole pic/blob encrypiton but no auto string enc, probably future of redteam tradecraft</td>
</tr>

<tr>
<td><a href="https://geekembly.com/posts/obfuscation/">Geekembly</a></td>
<td>Compile-time encryption via C++ templates/constexpr. Very original, still C++</td>
</tr>

<tr>
<td><a href="https://github.com/winterknife/SILVERPICK/blob/master/Inc/StackString.h">SILVERPICK</a></td>
<td>Shellcode framework with template-based strings. Great repo, interesting C++ method, still C++</td>
</tr>

<tr>
<td><a href="https://github.com/nbaertsch/zig-bof-template/blob/main/src/stack_string.zig">Zig BOF</a></td>
<td>Zig metaprogramming for stack strings. I don’t know Zig</td>
</tr>

<tr>
<td>JAI</td>
<td>Metaprogramming-first language. Probably <a href="https://youtu.be/OpoxlJ9e3Qg?si=kcD0UTG-BWaBhASt">best</a> fit, not released, <a href="https://www.youtube.com/watch?v=CgdKYBqe6QA">Jonathan Blow will get angry</a> when he finds out his language is used for maldev</td>
</tr>

<tr>
<td>Rust</td>
<td>Will <a href="https://news.ycombinator.com/item?id=44885398">probably</a> work with macros, but I don’t know Rust, will probably take half an hour to compile</td>
</tr>
</tbody>
</table>
<p>As you might have gathered from reading the notes column, these aren’t serious/professional complaints about these projects - all of them are solid choices for certain situations. I just decided to build my own solution.</p>

<h1>enc_pic_str:</h1>

<p>Let’s start with the design and aesthetic goals I had when designing this method of string obfuscation:</p>

<ol>
<li>C. Not C++.</li>
<li>Easy to understand and reason about: final C code should have locality of behaviour and not affect other code sections or introduce dependency on compiler features which may silently change other parts too.</li>
<li>Transparent DX experience: it should be debuggable and single step-able. Obfuscation itself should be as dumb/simple as possible.</li>
<li>Easy to extend or modify: encryption scheme should be easy to swap out, maybe with one which is less signatured or bypasses <a href="https://github.com/mandiant/flare-floss">FLOSS</a>.</li>
</ol>

<p>At a really high level we just need to parse the source code, grab all the strings, replace them with encoded data and their decryption routine:</p>
<div class="ansi-wrapper"><pre class="ansi2html-content"><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// we want to turn this</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span><span class="ansi28 ansi38-065167252 ansi48-000000000">puts</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"Hello World!"</span><span class="ansi28 ansi38-108125156 ansi48-000000000">);</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// into this</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span><span class="ansi28 ansi38-221144070 ansi48-000000000">unsigned</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> encrypted</span><span class="ansi28 ansi38-108125156 ansi48-000000000">[]</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> = </span><span class="ansi28 ansi38-108125156 ansi48-000000000">{</span><span class="ansi28 ansi38-221144070 ansi48-000000000">0x0a</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0x27</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0x2e</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0x2e</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0x2d</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">    </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0x62</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0x15</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0x2d</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0x30</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0x2e</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0x26</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0x63</span><span class="ansi28 ansi38-108125156 ansi48-000000000">};</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> decrypted</span><span class="ansi28 ansi38-108125156 ansi48-000000000">[</span><span class="ansi28 ansi38-221144070 ansi48-000000000">13</span><span class="ansi28 ansi38-108125156 ansi48-000000000">];</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span><span class="ansi28 ansi38-199090232 ansi48-000000000">for</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-221144070 ansi48-000000000">int</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> i = </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> i &lt; </span><span class="ansi28 ansi38-221144070 ansi48-000000000">12</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> i++</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">{</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">  decrypted</span><span class="ansi28 ansi38-108125156 ansi48-000000000">[</span><span class="ansi28 ansi38-255255255 ansi48-000000000">i</span><span class="ansi28 ansi38-108125156 ansi48-000000000">]</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> = encrypted</span><span class="ansi28 ansi38-108125156 ansi48-000000000">[</span><span class="ansi28 ansi38-255255255 ansi48-000000000">i</span><span class="ansi28 ansi38-108125156 ansi48-000000000">]</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> ^ </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0x42</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span><span class="ansi28 ansi38-108125156 ansi48-000000000">}</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">decrypted</span><span class="ansi28 ansi38-108125156 ansi48-000000000">[</span><span class="ansi28 ansi38-221144070 ansi48-000000000">12</span><span class="ansi28 ansi38-108125156 ansi48-000000000">]</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> = </span><span class="ansi28 ansi38-221144070 ansi48-000000000">'</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\0</span><span class="ansi28 ansi38-221144070 ansi48-000000000">'</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span><span class="ansi28 ansi38-065167252 ansi48-000000000">puts</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-255255255 ansi48-000000000">decrypted</span><span class="ansi28 ansi38-108125156 ansi48-000000000">);</span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span></pre></div>
<p>If you actually write code like this, the compiler might just delete all the decryption and put <code>hello world</code> back into your <code>puts</code> again lol.</p>

<p>If we go back to the code snippet above, you should be able to see some similarities. I’ll annotate it with comments right now.</p>
<div class="ansi-wrapper"><pre class="ansi2html-content"><span class="ansi28"></span><span class="ansi28 ansi38-065167252 ansi48-000000000">puts</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(((</span><span class="ansi28 ansi38-199090232 ansi48-000000000">const</span><span class="ansi28 ansi38-239189093 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-239189093 ansi48-000000000"> </span><span class="ansi28 ansi38-255255255 ansi48-000000000">*</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)(({</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Define a struct to hold our decrypted string buffer</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// This will be passed by VALUE (not pointer) to avoid UB</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">struct</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-239189093 ansi48-000000000">_str_struct_1</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">{</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">   </span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-052191208 ansi48-000000000">buf</span><span class="ansi28 ansi38-108125156 ansi48-000000000">[</span><span class="ansi28 ansi38-221144070 ansi48-000000000">14</span><span class="ansi28 ansi38-108125156 ansi48-000000000">];</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">}</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _str_inst_1</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">unsigned</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> *_data_ptr</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Store the 8-byte XOR key as a single 64-bit integer</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// volatile prevents compiler from optimizing away the key</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">volatile</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">unsigned</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">long</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">long</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _key_val</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// volatile prevents compiler from optimizing away the length</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">volatile</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">unsigned</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">long</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _len = </span><span class="ansi28 ansi38-221144070 ansi48-000000000">13</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Inline assembly to control exact ASM</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">__asm__</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">volatile</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"jmp skip_str_%=</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Jump over the data bytes</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">                  </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"str_data_%=:</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">    </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Label for our encrypted data</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">                  </span><span class="ansi28 ansi38-139205091 ansi48-000000000">".byte 0x9c, 0xc5, 0xc6, 0xef, 0xf5, 0x27, 0xe5, 0xbd, 0xbb, 0xd2, 0xc6, "</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">                  </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"0xe7, 0xbb</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">                    </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Encrypted bytes embedded in code</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">                  </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"str_key_%=:</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">                   </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Label for our 8-byte key</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">                  </span><span class="ansi28 ansi38-139205091 ansi48-000000000">".quad 0xeac50b9a83aaa0d4</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">      </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// 64-bit XOR key embedded in code</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">                  </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"skip_str_%=:</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">                  </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Label after data</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">                  </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"lea str_data_%=(%%rip), %0</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">    </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Load address of encrypted data into</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">                                                    </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// _data_ptr (RIP-relative addressing)</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">                  </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"movq str_key_%=(%%rip), %1</span><span class="ansi28 ansi38-246088102 ansi48-000000000">\n</span><span class="ansi28 ansi38-139205091 ansi48-000000000">"</span><span class="ansi28 ansi38-255255255 ansi48-000000000">    </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Load 64-bit key value into _key_val</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">                                                    </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// (RIP-relative addressing)</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">                  </span><span class="ansi28 ansi38-108125156 ansi48-000000000">:</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"=r"</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-255255255 ansi48-000000000">_data_ptr</span><span class="ansi28 ansi38-108125156 ansi48-000000000">),</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-139205091 ansi48-000000000">"=r"</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-255255255 ansi48-000000000">_key_val</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// OUTPUTS: both values loaded from code</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">                  </span><span class="ansi28 ansi38-108125156 ansi48-000000000">:</span><span class="ansi28 ansi38-255255255 ansi48-000000000">                                 </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// INPUTS: none</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">                  </span><span class="ansi28 ansi38-108125156 ansi48-000000000">:);</span><span class="ansi28 ansi38-255255255 ansi48-000000000">                               </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// CLOBBERS: none</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// XOR decryption scheme: each byte XORed with corresponding byte from 64-bit key</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// volatile prevents loop from being optimized out</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">for</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-199090232 ansi48-000000000">volatile</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">unsigned</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">long</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _i = </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _i &lt; _len</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _i++</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">{</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">   </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Extract the appropriate key byte from the 64-bit key value</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">   </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Uses bit shifting and masking to get byte at position (_i % 8)</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">   </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Example: for _i=0, gets lowest 8 bits; for _i=1, gets bits 8-15, etc.</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">   </span><span class="ansi28 ansi38-199090232 ansi48-000000000">volatile</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">unsigned</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _key_byte = </span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-255255255 ansi48-000000000">_key_val &gt;&gt; </span><span class="ansi28 ansi38-108125156 ansi48-000000000">((</span><span class="ansi28 ansi38-255255255 ansi48-000000000">_i % </span><span class="ansi28 ansi38-221144070 ansi48-000000000">8</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> * </span><span class="ansi28 ansi38-221144070 ansi48-000000000">8</span><span class="ansi28 ansi38-108125156 ansi48-000000000">))</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> &amp; </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0xFF</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">   </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Decrypt using extracted key byte</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">   _str_inst_1</span><span class="ansi28 ansi38-108125156 ansi48-000000000">.</span><span class="ansi28 ansi38-052191208 ansi48-000000000">buf</span><span class="ansi28 ansi38-108125156 ansi48-000000000">[</span><span class="ansi28 ansi38-255255255 ansi48-000000000">_i</span><span class="ansi28 ansi38-108125156 ansi48-000000000">]</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> = _data_ptr</span><span class="ansi28 ansi38-108125156 ansi48-000000000">[</span><span class="ansi28 ansi38-255255255 ansi48-000000000">_i</span><span class="ansi28 ansi38-108125156 ansi48-000000000">]</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> ^ _key_byte</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">}</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _str_inst_1</span><span class="ansi28 ansi38-108125156 ansi48-000000000">.</span><span class="ansi28 ansi38-052191208 ansi48-000000000">buf</span><span class="ansi28 ansi38-108125156 ansi48-000000000">[</span><span class="ansi28 ansi38-221144070 ansi48-000000000">13</span><span class="ansi28 ansi38-108125156 ansi48-000000000">]</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> = </span><span class="ansi28 ansi38-221144070 ansi48-000000000">0</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Null terminator</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000"> _str_inst_1</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// GNU statement expression: return struct BY VALUE</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-108125156 ansi48-000000000">}).</span><span class="ansi28 ansi38-052191208 ansi48-000000000">buf</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)));</span><span class="ansi28 ansi38-255255255 ansi48-000000000">     </span><span class="ansi3 ansi28 ansi38-069085116 ansi48-000000000">// Access .buf member from the returned struct VALUE</span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span></pre></div>
<p>The keen-eyed among you might have noticed that random bytes mid-instruction stream could produce invalid assembly. Yep - that’s why we wrap <code>db</code> blocks in jumps. (msfvenom used <code>call</code> instead.)</p>

<p>Detectable? Maybe. But plenty of “valid” binaries probably have garbage in their ‘.text’ sections.</p>

<p>But at which point in compilation are these strings replaced with this monstrosity? What will we use to create such code?</p>

<p><img src="https://tmpest.dev/images/chipmunk.png" alt="Demo" style="width: 60%;"></p>
<div class="ansi-wrapper"><pre class="ansi2html-content"><span class="ansi28">             --------------       -------------------------
</span><span class="ansi28"> -------     |enc_pic_str |       |.c file with encrypted |    ----------
</span><span class="ansi28">|.c file|--&gt; |preprocessor| ----&gt; | string blocks         |---&gt;|compiler|
</span><span class="ansi28"> -------     --------------       -------------------------    ----------
</span><span class="ansi28">                                                                    |
</span><span class="ansi28">                                                                    |
</span><span class="ansi28">                                                                    v
</span><span class="ansi28">                                                         ---------------------
</span><span class="ansi28">                                                         | PIC ready program |
</span><span class="ansi28">                                                         | (assuming only    |
</span><span class="ansi28">                                                         | strings were the  |
</span><span class="ansi28">                                                         | problem)          |
</span><span class="ansi28">                                                         ---------------------</span></pre></div>
<p>I know, I know - I had the same reaction. This is a total hack. We’re completely sidestepping language limitations and just generating the code ourselves… But it works.</p>

<p>for the preprocessor I Initially tried Clang <a href="https://clang.llvm.org/docs/LibTooling.html">libtooling</a> - find const strings by signature, replace selectively. Lots of misfires. Bad idea. libtooling runs C/C++ through LLVM’s frontend; once parsed, you can mutate the AST with full semantic info. 👀👀👀👀 Source-to-source obfuscators become possible. Someone’s gonna get nerdsniped and build this; not me, not today.</p>

<p>Anyway, libtooling is overkill:</p>

<p><img src="https://tmpest.dev/images/libtooling.png" alt="Demo" style="width: 60%;"></p>

<p>Instead, I decided to create a macro that passes strings through transparently if not replaced:</p>
<div class="ansi-wrapper"><pre class="ansi2html-content"><span class="ansi28"></span><span class="ansi28 ansi38-199090232 ansi48-000000000">static</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">inline</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">const</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> *</span><span class="ansi28 ansi38-065167252 ansi48-000000000">pic_str_impl</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-199090232 ansi48-000000000">const</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> *</span><span class="ansi28 ansi38-246088102 ansi48-000000000">s</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">{</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">return</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> s</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">}</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-199090232 ansi48-000000000">static</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">inline</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">const</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-239189093 ansi48-000000000">wchar_t</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> *</span><span class="ansi28 ansi38-065167252 ansi48-000000000">pic_str_impl_w</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-199090232 ansi48-000000000">const</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-239189093 ansi48-000000000">wchar_t</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> *</span><span class="ansi28 ansi38-246088102 ansi48-000000000">s</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">{</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-199090232 ansi48-000000000">return</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> s</span><span class="ansi28 ansi38-108125156 ansi48-000000000">;</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-108125156 ansi48-000000000">}</span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">
</span><span class="ansi28"></span><span class="ansi28 ansi38-199090232 ansi48-000000000">#define</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> </span><span class="ansi28 ansi38-052191208 ansi48-000000000">pic_str</span><span class="ansi28 ansi38-108125156 ansi48-000000000">(</span><span class="ansi28 ansi38-246088102 ansi48-000000000">x</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)</span><span class="ansi28 ansi38-255255255 ansi48-000000000">                       \
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">  _Generic</span><span class="ansi28 ansi38-108125156 ansi48-000000000">((</span><span class="ansi28 ansi38-255255255 ansi48-000000000">x</span><span class="ansi28 ansi38-108125156 ansi48-000000000">),</span><span class="ansi28 ansi38-255255255 ansi48-000000000">                          \
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">      </span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-239189093 ansi48-000000000"> </span><span class="ansi28 ansi38-255255255 ansi48-000000000">*</span><span class="ansi28 ansi38-108125156 ansi48-000000000">:</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> pic_str_impl</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000">              \
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">      </span><span class="ansi28 ansi38-199090232 ansi48-000000000">const</span><span class="ansi28 ansi38-239189093 ansi48-000000000"> </span><span class="ansi28 ansi38-221144070 ansi48-000000000">char</span><span class="ansi28 ansi38-239189093 ansi48-000000000"> </span><span class="ansi28 ansi38-255255255 ansi48-000000000">*</span><span class="ansi28 ansi38-108125156 ansi48-000000000">:</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> pic_str_impl</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000">        \
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">      </span><span class="ansi28 ansi38-239189093 ansi48-000000000">wchar_t </span><span class="ansi28 ansi38-255255255 ansi48-000000000">*</span><span class="ansi28 ansi38-108125156 ansi48-000000000">:</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> pic_str_impl_w</span><span class="ansi28 ansi38-108125156 ansi48-000000000">,</span><span class="ansi28 ansi38-255255255 ansi48-000000000">         \
</span><span class="ansi28"></span><span class="ansi28 ansi38-255255255 ansi48-000000000">      </span><span class="ansi28 ansi38-199090232 ansi48-000000000">const</span><span class="ansi28 ansi38-239189093 ansi48-000000000"> wchar_t </span><span class="ansi28 ansi38-255255255 ansi48-000000000">*</span><span class="ansi28 ansi38-108125156 ansi48-000000000">:</span><span class="ansi28 ansi38-255255255 ansi48-000000000"> pic_str_impl_w</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)(</span><span class="ansi28 ansi38-255255255 ansi48-000000000">x</span><span class="ansi28 ansi38-108125156 ansi48-000000000">)</span><span class="ansi28 ansi38-255255255 ansi48-000000000"></span></pre></div>
<p>And the replacing and xor value generation happens using every programmer’s real best friends: regex and <code>snprintf</code>.</p>

<p>Match <code>pic_str</code>, replace with encrypted blobs. Dumb, simple, no templates, no metaprogramming, no recursion. Ugly preprocessor step? Sure. Could be worse.</p>

<p>Bonus: fresh keys every build. #POLYMORPHISM, wow (feigned excitement).</p>

<p><code>enc_pic_str</code> works on single files. While it does have a batch mode and can process multiple .c files simultaneously, it still requires some scaffolding using a build system. But if you’ve come this far that shouldn’t be too hard.</p>

<p>My recommendation is to build new PIC projects in <a href="https://en.wikipedia.org/wiki/Unity_build">unity build</a> style as single compilation units and include independent logic sections as header-only <a href="https://github.com/nothings/stb">stb libs</a> with <code>#define</code> guarding implementations in the main section only. Trust me, the C compiler will thank you for placing everything in a single compilation unit.
After producing the single C file, single pass can be made to process it with <code>enc_pic_str</code>.</p>

<p>You can find the repo <a href="https://github.com/tmpest127/enc_pic_str/tree/main">here</a>.</p>
</article>
        </article>
    </article>
    



</body></html>