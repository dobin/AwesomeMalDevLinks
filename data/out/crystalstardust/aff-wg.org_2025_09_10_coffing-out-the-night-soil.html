# https://aff-wg.org/2025/09/10/coffing-out-the-night-soil/

<!DOCTYPE html><html lang="en" class="wf-loading wf-karla-n4-loading wf-karla-i4-loading wf-karla-n7-loading wf-karla-i7-loading">

<body class="wp-singular post-template-default single single-post postid-838 single-format-standard wp-custom-logo wp-embed-responsive wp-theme-pubpenscratch-2 customizer-styles-applied no-sidebar jetpack-reblog-enabled categories-hidden tags-hidden author-hidden">
<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="https://aff-wg.org/2025/09/10/coffing-out-the-night-soil/#content">Skip to content</a>
	<!-- #masthead -->

	<div id="content" class="site-content">
		
	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			
<article id="post-838" class="post-838 post type-post status-publish format-standard hentry category-research">
	<!-- .entry-header -->

	<div class="entry-content">
		
<p class="wp-block-paragraph">I’m back with another update to the <a href="https://tradecraftgarden.org/">Tradecraft Garden</a> project. Again, this release is focused on the Crystal Palace linker. My priority in this young project is to build the foundation first, then the rest can move in earnest.</p>



<h3 class="wp-block-heading">What’s New?</h3>



<p class="wp-block-paragraph">The major focus of this release was the re-development of Crystal Palace’s COFF parser and intermediate COFF representation. I’ve also added COFF normalization (e.g., collapsing multiple related sections) into Crystal Palace’s internals too.</p>



<p class="wp-block-paragraph">This work paved the way for some standard linker features in Crystal Palace:</p>



<p class="wp-block-paragraph">(1) This release also adds COFF merging via the Crystal Palace ‘<strong>merge</strong>’ command.</p>



<p class="wp-block-paragraph">(2) Crystal Palace can now export a COFF file as output. This is done with the ‘<strong>make coff</strong>’ command.</p>



<p class="wp-block-paragraph">And, with these new features comes complexity and a lot of room for regressions. So, on my end, I’ve put together a local unit testing regimen consisting of open source BOFs, personal code from Raffi stash, and specifically crafted test cases to help defend the quality of this project going forward. This part of the project is not released, but I wanted to mark that this is part of the development process now.</p>



<h3 class="wp-block-heading">Why these features?</h3>



<p class="wp-block-paragraph">Inspired by Daniel Duggan’s <a href="https://rastamouse.me/modular-pic-c2-agents/">Modular PIC C2 agents</a> blog post, I spent some time asking myself, what would it look like to use Crystal Palace to assemble a capability and later, as a separate step, apply tradecraft to it? I didn’t like <a href="https://bsky.app/profile/raphaelmudge.bsky.social/post/3lui7opzzjk2t">my answer</a> and developed the above features to help.</p>



<p class="wp-block-paragraph">Here’s the concept:</p>



<p class="wp-block-paragraph">If you’d like to use Crystal Palace to assemble a capability, now you can. Create a specification file to build your capability. It’s fair to think of your .spec file as a linker script, because that’s exactly what it is. And, within that .spec file, do whatever you want to assemble your capability. At its simplest, you can do something like this:</p>


<div><div id="highlighter_393074" class="syntaxhighlighter  bash"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">x64:</code></div><div class="line number2 index1 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;</code><code class="bash plain">load </code><code class="bash string">"bin/kernel.x64.o"</code></div><div class="line number3 index2 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">make</code> <code class="bash plain">coff</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">load </code><code class="bash string">"bin/http_c2.x64.o"</code></div><div class="line number6 index5 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">merge</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">load </code><code class="bash string">"bin/utils.x64.o"</code></div><div class="line number9 index8 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">merge</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">export</code></div></div></td></tr></tbody></table></div></div>



<p class="wp-block-paragraph">The above is a hypothetical specification file for a simple agent with a kernel, http_c2, and utils modules. <strong>make coff</strong> directs Crystal Palace to export a normalized COFF file. The <strong>merge</strong> command acts on the content at the top of the Crystal Palace program stack and merges it into the object (COFF export, PICO, PIC/PIC64) that’s next on the program stack.</p>



<p class="wp-block-paragraph">There’s nothing special about the above. Merging and normalizing to a target convention is what every linker ever does. But, the above option now co-exists with Crystal Palace’s <a href="https://tradecraftgarden.org/docs.html">other tools</a> specialized to this PIC problem set.</p>



<p class="wp-block-paragraph">Exporting COFF via a .spec file is convenient, because Crystal Palace can pair COFF with tradecraft implemented as a <a href="https://tradecraftgarden.org/simpleobj.html">position-independent PICO runner</a>. PICOs are Crystal Palace’s <a href="https://tradecraftgarden.org/docs.html#picos">executable COFF convention</a>.</p>



<p class="wp-block-paragraph">The technical benefits of PICOs, as a capability container:</p>



<ul class="wp-block-list">
<li>Projects are smaller than DLLs</li>



<li>You can split your code and data in memory!</li>



<li>It’s mutate-able (Crystal Palace has a built-in <a href="https://aff-wg.org/2025/07/09/tradecraft-garden-tilling-the-soil/">binary transformation framework</a> to mutate, removed unused functions, and  shuffle functions in your compiled code)</li>



<li>A PICO paired with a loader is easier to develop than <a href="https://vimeo.com/1100089433">straight PIC</a>.</li>



<li>The PICO loader is <a href="https://tradecraftgarden.org/simplefree.html?file=picorun.h">very simple</a>, because so much merging and processing happens within the linker itself</li>



<li>And, you get that tradecraft and capability separation <a href="https://vimeo.com/1074106659?share=copy#t=4556">ground truth thing</a> I’m going on about!</li>
</ul>



<h3 class="wp-block-heading">Migration Notes</h3>



<p class="wp-block-paragraph">If you’re already starting to experiment with Crystal Palace, I have a few notes for you:</p>



<p class="wp-block-paragraph">Crystal Palace will no longer auto-resolve x86 PIC relocations with a partial function pointer. Use <strong>reladdr “_symbol”</strong> to give Crystal Palace permission to apply this non-conventional strategy. This will come up most often, where a reference to the entry point <strong>_go</strong> is used to <a href="https://tradecraftgarden.org/simplefree.html?file=loader.c#:~:text=%C2%A0*/-,char%20*%20getStart(),-%7B">determine the beginning of</a> the position-independent code.</p>



<p class="wp-block-paragraph">I’ve updated picorun.h to support relocations in your PICO’s data. In theory, the old picorun.h is still compatible (with previously working projects). But, if you have troubles on update, grab the new <a href="https://tradecraftgarden.org/simplefree.html?file=picorun.h">picorun.h</a> from Tradecraft Garden and recompile your project. There’s no API change.</p>



<p class="wp-block-paragraph">To see what’s new, check out the <a href="https://tradecraftgarden.org/releasenotes.txt">release notes</a>.</p>
			</div><!-- .entry-content -->

	<!-- .entry-footer -->

	</article><!-- #post-## -->

			
	
			
		
		</main><!-- #main -->
	</div><!-- #primary -->


	</div><!-- #content -->

	<!-- #colophon -->
</div><!-- #page -->

<!--  -->





	

		<div style="display:none">
	</div>
		<div id="actionbar" dir="ltr" class="actnbr-pub-penscratch-2 actnbr-has-follow actnbr-has-actions">
		<ul>
								<li class="actnbr-btn actnbr-hidden">
								<a class="actnbr-action actnbr-actn-follow " href="https://aff-wg.org/2025/09/10/coffing-out-the-night-soil/">
			<svg class="gridicon" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path clip-rule="evenodd" d="m4 4.5h12v6.5h1.5v-6.5-1.5h-1.5-12-1.5v1.5 10.5c0 1.1046.89543 2 2 2h7v-1.5h-7c-.27614 0-.5-.2239-.5-.5zm10.5 2h-9v1.5h9zm-5 3h-4v1.5h4zm3.5 1.5h-1v1h1zm-1-1.5h-1.5v1.5 1 1.5h1.5 1 1.5v-1.5-1-1.5h-1.5zm-2.5 2.5h-4v1.5h4zm6.5 1.25h1.5v2.25h2.25v1.5h-2.25v2.25h-1.5v-2.25h-2.25v-1.5h2.25z" fill-rule="evenodd"></path></svg>
			<span>Subscribe</span>
		</a>
		<a class="actnbr-action actnbr-actn-following  no-display" href="https://aff-wg.org/2025/09/10/coffing-out-the-night-soil/">
			<svg class="gridicon" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 4.5H4V15C4 15.2761 4.22386 15.5 4.5 15.5H11.5V17H4.5C3.39543 17 2.5 16.1046 2.5 15V4.5V3H4H16H17.5V4.5V12.5H16V4.5ZM5.5 6.5H14.5V8H5.5V6.5ZM5.5 9.5H9.5V11H5.5V9.5ZM12 11H13V12H12V11ZM10.5 9.5H12H13H14.5V11V12V13.5H13H12H10.5V12V11V9.5ZM5.5 12H9.5V13.5H5.5V12Z" fill="#008A20"></path><path class="following-icon-tick" d="M13.5 16L15.5 18L19 14.5" stroke="#008A20" stroke-width="1.5"></path></svg>
			<span>Subscribed</span>
		</a>
							<div class="actnbr-popover tip tip-top-left actnbr-notice" id="follow-bubble">
							<div class="tip-arrow"></div>
							<div class="tip-inner actnbr-follow-bubble">
															<ul>
											<li class="actnbr-sitename">
			<a href="https://aff-wg.org/">
				<img loading="lazy" alt="" src="https://aff-wg.org/wp-content/uploads/2024/08/cropped-affwgsiteimage_nowreath.png?w=50" class="avatar avatar-50" height="50" width="50">				Adversary Fan Fiction Writers Guild			</a>
		</li>
										<div class="actnbr-message no-display"></div>
									<form method="post" action="https://subscribe.wordpress.com/" accept-charset="utf-8" style="display: none;">
																						<div class="actnbr-follow-count">Join 97 other subscribers</div>
																					<div>
										<input type="email" name="email" placeholder="Enter your email address" class="actnbr-email-field" aria-label="Enter your email address">
										</div>
										
										
										
										
																				<div class="actnbr-button-wrap">
											<button type="submit" value="Sign me up">
												Sign me up											</button>
										</div>
									</form>
									<li class="actnbr-login-nudge">
										<div>
											Already have a WordPress.com account? <a href="https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Faff-wg.org%252F2025%252F09%252F10%252Fcoffing-out-the-night-soil%252F">Log in now.</a>										</div>
									</li>
								</ul>
															</div>
						</div>
					</li>
							<li class="actnbr-ellipsis actnbr-hidden">
				<svg class="gridicon gridicons-ellipsis" height="24" width="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path d="M7 12c0 1.104-.896 2-2 2s-2-.896-2-2 .896-2 2-2 2 .896 2 2zm12-2c-1.104 0-2 .896-2 2s.896 2 2 2 2-.896 2-2-.896-2-2-2zm-7 0c-1.104 0-2 .896-2 2s.896 2 2 2 2-.896 2-2-.896-2-2-2z"></path></g></svg>				<div class="actnbr-popover tip tip-top-left actnbr-more">
					<div class="tip-arrow"></div>
					<div class="tip-inner">
						<ul>
								<li class="actnbr-sitename">
			<a href="https://aff-wg.org/">
				<img loading="lazy" alt="" src="https://aff-wg.org/wp-content/uploads/2024/08/cropped-affwgsiteimage_nowreath.png?w=50" class="avatar avatar-50" height="50" width="50">				Adversary Fan Fiction Writers Guild			</a>
		</li>
								<li class="actnbr-folded-follow">
										<a class="actnbr-action actnbr-actn-follow " href="https://aff-wg.org/2025/09/10/coffing-out-the-night-soil/">
			<svg class="gridicon" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path clip-rule="evenodd" d="m4 4.5h12v6.5h1.5v-6.5-1.5h-1.5-12-1.5v1.5 10.5c0 1.1046.89543 2 2 2h7v-1.5h-7c-.27614 0-.5-.2239-.5-.5zm10.5 2h-9v1.5h9zm-5 3h-4v1.5h4zm3.5 1.5h-1v1h1zm-1-1.5h-1.5v1.5 1 1.5h1.5 1 1.5v-1.5-1-1.5h-1.5zm-2.5 2.5h-4v1.5h4zm6.5 1.25h1.5v2.25h2.25v1.5h-2.25v2.25h-1.5v-2.25h-2.25v-1.5h2.25z" fill-rule="evenodd"></path></svg>
			<span>Subscribe</span>
		</a>
		<a class="actnbr-action actnbr-actn-following  no-display" href="https://aff-wg.org/2025/09/10/coffing-out-the-night-soil/">
			<svg class="gridicon" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 4.5H4V15C4 15.2761 4.22386 15.5 4.5 15.5H11.5V17H4.5C3.39543 17 2.5 16.1046 2.5 15V4.5V3H4H16H17.5V4.5V12.5H16V4.5ZM5.5 6.5H14.5V8H5.5V6.5ZM5.5 9.5H9.5V11H5.5V9.5ZM12 11H13V12H12V11ZM10.5 9.5H12H13H14.5V11V12V13.5H13H12H10.5V12V11V9.5ZM5.5 12H9.5V13.5H5.5V12Z" fill="#008A20"></path><path class="following-icon-tick" d="M13.5 16L15.5 18L19 14.5" stroke="#008A20" stroke-width="1.5"></path></svg>
			<span>Subscribed</span>
		</a>
								</li>
														<li class="actnbr-signup"><a href="https://wordpress.com/start/">Sign up</a></li>
							<li class="actnbr-login"><a href="https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Faff-wg.org%252F2025%252F09%252F10%252Fcoffing-out-the-night-soil%252F">Log in</a></li>
																<li class="actnbr-shortlink">
										<a href="https://wp.me/pfXSCG-dw">
											<span class="actnbr-shortlink__text">Copy shortlink</span>
											<span class="actnbr-shortlink__icon"><svg class="gridicon gridicons-checkmark" height="16" width="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path d="M9 19.414l-6.707-6.707 1.414-1.414L9 16.586 20.293 5.293l1.414 1.414"></path></g></svg></span>
										</a>
									</li>
																<li class="flb-report">
									<a href="https://wordpress.com/abuse/?report_url=https://aff-wg.org/2025/09/10/coffing-out-the-night-soil/" target="_blank" rel="noopener noreferrer">
										Report this content									</a>
								</li>
															<li class="actnbr-reader">
									<a href="https://wordpress.com/reader/blogs/235916366/posts/838">
										View post in Reader									</a>
								</li>
															<li class="actnbr-subs">
									<a href="https://subscribe.wordpress.com/">Manage subscriptions</a>
								</li>
																<li class="actnbr-fold"><a href="https://aff-wg.org/2025/09/10/coffing-out-the-night-soil/">Collapse this bar</a></li>
														</ul>
					</div>
				</div>
			</li>
		</ul>
	</div>
	


	


	








 


		 	


<div class="comment-likes-overlay" style="display: none;"></div></body></html>