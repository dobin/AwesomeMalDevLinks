# https://github.com/SAERXCIT/LibTP_Gadget

[Skip to content](https://github.com/SAERXCIT/LibTP_Gadget#start-of-content)

You signed in with another tab or window. [Reload](https://github.com/SAERXCIT/LibTP_Gadget) to refresh your session.You signed out in another tab or window. [Reload](https://github.com/SAERXCIT/LibTP_Gadget) to refresh your session.You switched accounts on another tab or window. [Reload](https://github.com/SAERXCIT/LibTP_Gadget) to refresh your session.Dismiss alert

{{ message }}

[SAERXCIT](https://github.com/SAERXCIT)/ **[LibTP\_Gadget](https://github.com/SAERXCIT/LibTP_Gadget)** Public

forked from [rasta-mouse/LibTP](https://github.com/rasta-mouse/LibTP)

- [Notifications](https://github.com/login?return_to=%2FSAERXCIT%2FLibTP_Gadget) You must be signed in to change notification settings
- [Fork\\
3](https://github.com/login?return_to=%2FSAERXCIT%2FLibTP_Gadget)
- [Star\\
17](https://github.com/login?return_to=%2FSAERXCIT%2FLibTP_Gadget)


Crystal Palace library for proxying Nt API calls via the Threadpool. Updated for call gadgets.


### License

[MIT license](https://github.com/SAERXCIT/LibTP_Gadget/blob/main/LICENSE)

[17\\
stars](https://github.com/SAERXCIT/LibTP_Gadget/stargazers) [12\\
forks](https://github.com/SAERXCIT/LibTP_Gadget/forks) [Branches](https://github.com/SAERXCIT/LibTP_Gadget/branches) [Tags](https://github.com/SAERXCIT/LibTP_Gadget/tags) [Activity](https://github.com/SAERXCIT/LibTP_Gadget/activity)

[Star](https://github.com/login?return_to=%2FSAERXCIT%2FLibTP_Gadget)

[Notifications](https://github.com/login?return_to=%2FSAERXCIT%2FLibTP_Gadget) You must be signed in to change notification settings

# SAERXCIT/LibTP\_Gadget

main

[**1** Branch](https://github.com/SAERXCIT/LibTP_Gadget/branches) [**0** Tags](https://github.com/SAERXCIT/LibTP_Gadget/tags)

[Go to Branches page](https://github.com/SAERXCIT/LibTP_Gadget/branches)[Go to Tags page](https://github.com/SAERXCIT/LibTP_Gadget/tags)

Go to file

Code

Open more actions menu

This branch is [1 commit ahead of](https://github.com/SAERXCIT/LibTP_Gadget/compare/rasta-mouse%3ALibTP%3Amain...main) rasta-mouse/LibTP:main.

## Folders and files

| Name | Name | Last commit message | Last commit date |
| --- | --- | --- | --- |
| ## Latest commit<br>[![SAERXCIT](https://avatars.githubusercontent.com/u/78735647?v=4&size=40)](https://github.com/SAERXCIT)[SAERXCIT](https://github.com/SAERXCIT/LibTP_Gadget/commits?author=SAERXCIT)<br>[Update LibTP to LibTP\_Gadget](https://github.com/SAERXCIT/LibTP_Gadget/commit/c481fae9fe203686a0241012375036b2bbb0bdfa)<br>3 months agoNov 11, 2025<br>[c481fae](https://github.com/SAERXCIT/LibTP_Gadget/commit/c481fae9fe203686a0241012375036b2bbb0bdfa)¬†¬∑¬†3 months agoNov 11, 2025<br>## History<br>[5 Commits](https://github.com/SAERXCIT/LibTP_Gadget/commits/main/) <br>Open commit details<br>[View commit history for this file.](https://github.com/SAERXCIT/LibTP_Gadget/commits/main/) 5 Commits |
| [example\_print](https://github.com/SAERXCIT/LibTP_Gadget/tree/main/example_print "example_print") | [example\_print](https://github.com/SAERXCIT/LibTP_Gadget/tree/main/example_print "example_print") | [Update LibTP to LibTP\_Gadget](https://github.com/SAERXCIT/LibTP_Gadget/commit/c481fae9fe203686a0241012375036b2bbb0bdfa "Update LibTP to LibTP_Gadget") | 3 months agoNov 11, 2025 |
| [src](https://github.com/SAERXCIT/LibTP_Gadget/tree/main/src "src") | [src](https://github.com/SAERXCIT/LibTP_Gadget/tree/main/src "src") | [Update LibTP to LibTP\_Gadget](https://github.com/SAERXCIT/LibTP_Gadget/commit/c481fae9fe203686a0241012375036b2bbb0bdfa "Update LibTP to LibTP_Gadget") | 3 months agoNov 11, 2025 |
| [.gitattributes](https://github.com/SAERXCIT/LibTP_Gadget/blob/main/.gitattributes ".gitattributes") | [.gitattributes](https://github.com/SAERXCIT/LibTP_Gadget/blob/main/.gitattributes ".gitattributes") | [Initial commit](https://github.com/SAERXCIT/LibTP_Gadget/commit/b3839d3afe7beff853c2e55246210c176f2c60db "Initial commit") | 4 months agoOct 14, 2025 |
| [.gitignore](https://github.com/SAERXCIT/LibTP_Gadget/blob/main/.gitignore ".gitignore") | [.gitignore](https://github.com/SAERXCIT/LibTP_Gadget/blob/main/.gitignore ".gitignore") | [Initial commit](https://github.com/SAERXCIT/LibTP_Gadget/commit/b3839d3afe7beff853c2e55246210c176f2c60db "Initial commit") | 4 months agoOct 14, 2025 |
| [LICENSE](https://github.com/SAERXCIT/LibTP_Gadget/blob/main/LICENSE "LICENSE") | [LICENSE](https://github.com/SAERXCIT/LibTP_Gadget/blob/main/LICENSE "LICENSE") | [Initial commit](https://github.com/SAERXCIT/LibTP_Gadget/commit/b3839d3afe7beff853c2e55246210c176f2c60db "Initial commit") | 4 months agoOct 14, 2025 |
| [Makefile](https://github.com/SAERXCIT/LibTP_Gadget/blob/main/Makefile "Makefile") | [Makefile](https://github.com/SAERXCIT/LibTP_Gadget/blob/main/Makefile "Makefile") | [Update LibTP to LibTP\_Gadget](https://github.com/SAERXCIT/LibTP_Gadget/commit/c481fae9fe203686a0241012375036b2bbb0bdfa "Update LibTP to LibTP_Gadget") | 3 months agoNov 11, 2025 |
| [README.md](https://github.com/SAERXCIT/LibTP_Gadget/blob/main/README.md "README.md") | [README.md](https://github.com/SAERXCIT/LibTP_Gadget/blob/main/README.md "README.md") | [Update LibTP to LibTP\_Gadget](https://github.com/SAERXCIT/LibTP_Gadget/commit/c481fae9fe203686a0241012375036b2bbb0bdfa "Update LibTP to LibTP_Gadget") | 3 months agoNov 11, 2025 |
| View all files |

## Repository files navigation

# LibTP\_Gadget

[Permalink: LibTP_Gadget](https://github.com/SAERXCIT/LibTP_Gadget#libtp_gadget)

This is a generalisation of [https://github.com/AlmondOffSec/LibTPLoadLib](https://github.com/AlmondOffSec/LibTPLoadLib) to proxy APIs with an arbitrary number (11 max actually, but good enough) of arguments. Provided as a [Crystal Palace](https://tradecraftgarden.org/crystalpalace.html) shared library. API made compatible with @rasta-mouse's [LibTP](https://github.com/rasta-mouse/LibTP) for easy switch using spec files. Hooks are provided to show off the [newest Crystal Palace features](https://aff-wg.org/2025/11/10/tradecraft-engineering-with-aspect-oriented-programming/).

**WARNING ‚ö†Ô∏è** : This project is not usable as-is. I am not providing a module in which to find a `call` gadget. You'll have to find your own. [Read the blogpost for more info](https://offsec.almond.consulting/evading-elastic-callstack-signatures.html).

**Note** : Due to the ability to pass 11 arguments (7 of which will be put on the stack), the call gadget must reside within a function with a large enough stack frame. Look for an `add rsp` of at least `0x68`.

**WARNING ‚ö†Ô∏è** : Due to the inner workings of this technique, it is not possible to retrieve the return value of the proxied function. Proxying NTAPIs is generally more usable, since their return value is "only" the `NTSTATUS`. It does make it difficult to know whether the function actually succeeded üôÉ.

## How

[Permalink: How](https://github.com/SAERXCIT/LibTP_Gadget#how)

1. Find a working gadget in a module available on the target. In `src/tp_gadget.c`, patch its name in the `LoadLibraryA` call and the function `GetCallGadgetAddress` to make it retrieve its address. Patch the assembly stub if necessary (`sub rsp` value, register that the gadget will call).

2. Compile the project: `make`. The output is the Crystal Palace shared library `libtp_gadget.x64.zip`.

3. Compile the example COFF (that will just load `wininet.dll` then locally alloc and execute shellcode): `make -C example_print`. The output will be a COFF file `example_print.x64.o`.

4. Create a Crystal Palace spec file instructing the linker to use our hooks on DFR: Use the Tradecraft Garden's Simple PIC spec file, and add the following lines between `mergelib "../libtcg.x64.zip"` and `export`:


```
        mergelib "../libtp_gadget.x64.zip"

        attach "KERNEL32$LoadLibraryA"          "H_LoadLibraryA"
        optout "ProxyNtApi"                     "H_LoadLibraryA"
        attach "NTDLL$NtOpenProcess"            "H_NtOpenProcess"
        attach "NTDLL$NtAllocateVirtualMemory"  "H_NtAllocateVirtualMemory"
        attach "NTDLL$NtWriteVirtualMemory"     "H_NtWriteVirtualMemory"
        attach "NTDLL$NtProtectVirtualMemory"   "H_NtProtectVirtualMemory"
        attach "NTDLL$NtFreeVirtualMemory"      "H_NtFreeVirtualMemory"
        attach "NTDLL$NtClose"                  "H_NtClose"
        attach "NTDLL$NtCreateThreadEx"         "H_NtCreateThreadEx"
        attach "NTDLL$NtOpenThread"             "H_NtOpenThread"
        attach "NTDLL$NtSuspendThread"          "H_NtSuspendThread"
        attach "NTDLL$NtResumeThread"           "H_NtResumeThread"
        attach "NTDLL$NtGetContextThread"       "H_NtGetContextThread"
        attach "NTDLL$NtSetContextThread"       "H_NtSetContextThread"
        attach "NTDLL$NtWaitForSingleObject"    "H_NtWaitForSingleObject"
```

5. Link the whole thing using Crystal Palace to make PIC shellcode: `path/to/crystalpalace/link simplepic_modified/loader.spec example_print/example_print.x64.o out.bin`.

6. Run the shellcode using any loader.


## Credits

[Permalink: Credits](https://github.com/SAERXCIT/LibTP_Gadget#credits)

- Raphael Mudge, [Adversary Fan Fiction Writers Guild](https://aff-wg.org/)
- Chetan Nayak, [Dark Vortex](https://0xdarkvortex.dev/hiding-in-plainsight/)
- Daniel Duggan, [Rasta Mouse](https://rastamouse.me/)

## About

Crystal Palace library for proxying Nt API calls via the Threadpool. Updated for call gadgets.


### Resources

[Readme](https://github.com/SAERXCIT/LibTP_Gadget#readme-ov-file)

### License

[MIT license](https://github.com/SAERXCIT/LibTP_Gadget#MIT-1-ov-file)

### Uh oh!

There was an error while loading. [Please reload this page](https://github.com/SAERXCIT/LibTP_Gadget).

[Activity](https://github.com/SAERXCIT/LibTP_Gadget/activity)

### Stars

[**17**\\
stars](https://github.com/SAERXCIT/LibTP_Gadget/stargazers)

### Watchers

[**0**\\
watching](https://github.com/SAERXCIT/LibTP_Gadget/watchers)

### Forks

[**3**\\
forks](https://github.com/SAERXCIT/LibTP_Gadget/forks)

[Report repository](https://github.com/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2FSAERXCIT%2FLibTP_Gadget&report=SAERXCIT+%28user%29)

## [Releases](https://github.com/SAERXCIT/LibTP_Gadget/releases)

No releases published

## [Packages\  0](https://github.com/users/SAERXCIT/packages?repo_name=LibTP_Gadget)

No packages published

## Languages

- C96.0%
- Makefile4.0%

You can‚Äôt perform that action at this time.