Title:
Keeping bin2bin out of the bin

Type:
Blog Post

Short Summary (4–8 sentences max):
- This post describes a robustness-focused update to Crystal Palace’s “bin2bin” binary transformation framework, used to rewrite x86/x64 COFF/object code into a functionally equivalent binary.  
- It explains why bin2bin rewriting is fragile (branches, relocations, flags, compiler idiosyncrasies) and how Crystal Palace mitigates this with a structured lift/transform/lower pipeline built on the Iced x86 decoder/assembler.  
- New transformation passes include **+regdance** (non-volatile register permutation within a function), **+blockparty** (basic-block shuffling per function), and **+shatter** (basic-block shuffling program-wide) aimed at structural variance and signature resilience.  
- The post details key safety mechanisms: label-based branch rewriting, strict handling of RIP-relative references, “danger zones” to avoid RFLAGS corruption, and relocation relinking/patching during lowering.  
- A major engineering driver is added compatibility with **MinGW -O1**, including analysis for “dirty leaf” functions where stack alignment assumptions break once transformations insert calls.  
- Useful for red team/tooling engineers and malware developers building late-stage, post-compilation tradecraft integration (PIC conversion, attach/redirect weaving) and for defenders/researchers studying practical constraints of binary rewriting.

Technical Focus:
- Bin2bin rewriting pipeline (disassemble → lift/IR → transform → lower) over COFF
- x86/x64 control-flow repair via labels (branch/jump healing, block reordering)
- Relocation-aware rewriting and COFF symbol/relocation table regeneration
- RFLAGS safety analysis (“danger zones”) during instruction mutation
- Register allocation randomization using non-volatile register sets (+regdance)
- Compiler optimization interactions (MinGW -O1), stack alignment, “dirty leaf” detection

Use Cases:
- Generate “just works” position-independent code (PIC) from existing x86/x64 objects
- Apply post-build metamorphic/structural variance (register shuffles, block shuffles) to reduce byte-signature stability
- Link-time removal of unused functions (reachability-based LTO at the object level)
- Aspect-style weaving of tradecraft into capability using attach/redirect join points
- Safely rewrite binaries while preserving relocations, symbols, and control flow under -O1 builds

Keywords:
Crystal Palace, Tradecraft Garden, bin2bin, binary rewriting, COFF, x86, x64, Iced x86, disassembly, CodeAssembler, intermediate representation, relocations, symbols, RIP-relative addressing, basic blocks, leaders algorithm, control-flow graph, RFLAGS, stack alignment, SysV/Windows x64 ABI, MinGW, -O1, leaf functions, PIC, metamorphism, obfuscation, link-time optimization, attach, redirect