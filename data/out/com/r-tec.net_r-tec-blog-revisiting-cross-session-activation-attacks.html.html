# https://www.r-tec.net/r-tec-blog-revisiting-cross-session-activation-attacks.html

<!DOCTYPE html><html lang="de">
<body id="top" class="r-tec-blog-revisiting-cross-session-activation-attacks   " itemscope="" itemtype="http://schema.org/WebPage">
<div class="emergency soforthilfe"> <div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="INCIDENT RESPONSE SERVICE" href="https://www.r-tec.net/#" data-hash="#" class="hyperlink_txt sprungmarke "><span>INCIDENT RESPONSE SERVICE</span></a>
</div><div class="ce_text Kein Abstand - 0px bg-  block">
<div class="ce_text__content">
<h3>Garantierte Reaktionszeiten.<br>Umfassende Vorbereitung.</h3>
<p>Mit unserem Incident Response Service stellen wir sicher, dass Ihrem Unternehmen im Ernstfall die richtigen Ressourcen und Kompetenzen zur Verfügung stehen. Sie zahlen eine feste monatliche Pauschale und wir bieten Ihnen dafür einen Bereitschaftsdienst mit garantierten Annahme- und Reaktionszeiten. Durch einen im Vorfeld von uns erarbeiteten Maßnahmenplan sparen Sie im Ernstfall wertvolle Zeit.</p>
<p><a href="https://www.r-tec.net/incident-response-service.html">weiterlesen</a></p>            </div>
<a class="close">zurück</a></div>
</div>
<div id="wrapper">

<div id="container">
<div class="dz_stage">
<div class="dz_stage__background dz_stage__withtext dz_stage__gradient" style="background-image: url('files/content/img/Buehne_schmal/arif-wahid-266541-unsplash.jpg');">
<div class="c-image-container__copyright-layer js-copyright-close">
<div class="c-image-container__copyright-layer-close">
<svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17">
<path fill="#ffffff" fill-rule="evenodd" d="M16.6892426,0.311014057 C16.2748994,-0.103671352 15.6099753,-0.103671352 15.195241,0.311014057 L8.49995112,7.00551465 L1.8051501,0.311014057 C1.39031804,-0.103671352 0.725491718,-0.103671352 0.311050725,0.311014057 C-0.103683575,0.725406195 -0.103683575,1.39015414 0.311050725,1.80493731 L7.00634058,8.49894911 L0.311050725,15.1934497 C-0.103683575,15.6081351 -0.103683575,16.2729808 0.311050725,16.6872752 C0.514213826,16.8908054 0.788063607,17 1.05428744,17 C1.3201202,17 1.59387221,16.8984304 1.79713308,16.6872752 L8.49232517,9.99287236 L15.187615,16.6872752 C15.3907781,16.8908054 15.6646279,17 15.9303629,17 C16.2042127,17 16.4704365,16.8984304 16.6735996,16.6872752 C17.0883339,16.2729808 17.0883339,15.6081351 16.6735996,15.1934497 L9.99405049,8.49894911 L16.6892426,1.80493731 C17.1035858,1.39015414 17.1035858,0.725406195 16.6892426,0.311014057"></path>
</svg>
</div>© Arif Wahid 266541 - Unsplash                                    </div>
<a href="https://www.r-tec.net/#" class="c-image-container__copyright-link js-copyright-open" title="Copyright Informationen anzeigen" tabindex="0"><i class="icon-Copyright"></i></a>
</div>
<div class="container">
<div class="row">
<div class="col-lg-12">
<div class="dz_stage__content">
<h1 class="dz_stage__headline">Revisiting Cross Session Activation Attacks</h1>
<p>This blog post revisits Cross Session Activation attacks</p>                                                    </div>
</div>
</div>
</div>
</div>
<main id="main">
<div class="inside">
<!-- indexer::stop -->

<!-- indexer::continue -->
<div class="mod_article color- Kein Abstand - 0px bg- block" id="article-4091">
<div class="container container__article">
<div class="row">
<div class="ce_ContentDate Gering - 30px bg-  block">
<div class="date">
<p>July 8nd 2025 Author: <span style="font-size: 11.0pt; font-family: 'Arial',sans-serif;">Fabian Mosch, <a href="https://x.com/ShitSecure" target="_blank" rel="noopener"><span style="color: #0000ee;">@</span><span class="spelle"><span style="color: #0000ee;">ShitSecure</span></span></a></span></p></div>
</div>
<div class="ce_colsetStart subcolumns ce_bs_gridStart ">
<div class="c66l col_1">
<div class="subcl" style="padding-right:0;">
<div class="ce_text Gering - 30px bg-  block">
<h2>Introduction</h2>
<div class="ce_text__content">
<p>The number of Lateral Movement techniques that an attacker can use in an Active Directory environment is limited. The most well-known techniques for executing code on a remote system with administrative privileges are as follows:</p>
<ul>
<li><a href="https://attack.mitre.org/techniques/T1047/" target="_blank" rel="noopener">WMI</a>, e.G. <a href="https://github.com/fortra/impacket/blob/master/examples/wmiexec.py" target="_blank" rel="noopener">wmiexec.py</a></li>
<li><a href="https://attack.mitre.org/techniques/T1543/003/" target="_blank" rel="noopener">Remote Service Creation or Modification</a>, e.G. <a href="https://github.com/fortra/impacket/blob/master/examples/smbexec.py" target="_blank" rel="noopener">smbexec.py</a></li>
<li><a href="https://attack.mitre.org/techniques/T1021/006/" target="_blank" rel="noopener">WinRM</a>, e.G. <a href="https://github.com/Hackplayers/evil-winrm" target="_blank" rel="noopener">EvilWinRM</a></li>
<li><a href="https://attack.mitre.org/techniques/T1053/" target="_blank" rel="noopener">Remote Scheduled Task Creation</a>, e.G. <a href="https://github.com/fortra/impacket/blob/master/examples/atexec.py" target="_blank" rel="noopener">atexec.py</a></li>
</ul>
<p>These techniques are well documented in terms of both network-based and endpoint-based indicators of compromise (IoCs). Therefore, if <code>cmd.exe /C</code> is called via any of these techniques, or if an unsigned executable is run remotely, the attacker will likely already trigger an alert in monitored environments. Of course, these IoCs can be removed, and we can ensure that only signed binaries are executed using a <a href="https://www.r-tec.net/r-tec-blog-dll-sideloading.html" target="_blank" rel="noopener"><span style="color: #0000ee;">Sideloading DLL</span> for example</a>, but having stealthier alternatives is always a good option.</p>
<p>There are also some well-known Lateral Movement techniques that use DCOM such as <code>MMC20.Application</code> or <code>ShellWindows</code> implemented in <a href="https://github.com/fortra/impacket/blob/master/examples/dcomexec.py" target="_blank" rel="noopener">dcomexec.py</a>. However, these usually only work on client systems or older Windows Server versions, as can be seen in the comments already:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22539">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-01-Lateral_Movement_20250403083456.png" width="1025" height="290" alt="Figure-01 Lateral_Movement">
</button>
</div>
</figure>

</div><div class="ce_text Kein Abstand - 0px bg-  block" id="tools">
<div class="ce_text__content">
<p>In terms of IoCs, these techniques are also more likely to be detected as it is well known that processes spawn new ones, which is uncommon and relatively easy to spot as an anomaly from the defender's perspective.</p>            </div>
</div>        </div>
</div>
<div class="c33r">
<div class="subcr" style="padding-left:0px;">
<div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="1. The classic way to find DCOM code execution vectors" href="https://www.r-tec.net/#sprung1" data-hash="#sprung1" class="hyperlink_txt sprungmarke "><span>1. The classic way to find DCOM code execution vectors</span></a>
</div><div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="2. Introduction in Cross Session Activation attacks" href="https://www.r-tec.net/#sprung2" data-hash="#sprung2" class="hyperlink_txt sprungmarke "><span>2. Introduction in Cross Session Activation attacks</span></a>
</div><div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="3. Introducing Cross Session Activation DCOM Lateral Movement" href="https://www.r-tec.net/#sprung3" data-hash="#sprung3" class="hyperlink_txt sprungmarke "><span>3. Introducing Cross Session Activation DCOM Lateral Movement</span></a>
</div><div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="4. Detection" href="https://www.r-tec.net/#sprung4" data-hash="#sprung4" class="hyperlink_txt sprungmarke "><span>4. Detection</span></a>
</div><div class="ce_hyperlink Kein Abstand - 0px bg-  block">
<a title="5. Conclusion" href="https://www.r-tec.net/#sprung5" data-hash="#sprung5" class="hyperlink_txt sprungmarke "><span>5. Conclusion</span></a>
</div>        </div>
</div>
</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung1">
<div class="container container__article">
<div class="row">
<div class="ce_text Kein Abstand - 0px bg-  block" id="lab">
<h2>1. The classic way to find DCOM code execution vectors</h2>
<div class="ce_text__content">
<p>On the protocol level, the options for code execution are limited. But when the execution primitive is changed to DCOM, the IoCs and behaviour for code execution will differ a lot when different classes are used. So this is a good field to search for new execution primitives. Each version of Windows uses several default COM Objects, which are uniquely identified by their CLSID. Tools such as <a href="https://github.com/tyranid/oleviewdotnet" target="_blank" rel="noopener">oleviewdotnet</a> provide a convenient way to get an overview of the CLSIDs used on a given system:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22540">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-02-CLSID_20250403092023.png" width="726" height="575" alt="Figure-02 CLSID">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>In this example, there is <strong>11676</strong> different CLSIDs are registered. Expanding the view on one of these CLSIDs, in this case the <code>MSTSWebProxy Class</code>, we can see the exposed <em>Interface Identifiers</em> - IID, and their names:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22541">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-03-IID_20250403092317.png" width="451" height="236" alt="Figure-03 IID">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>In some cases, you can create an instance of this CLSID directly from within OleView.NET. However, this is often not possible, and you need to invoke them manually with the corresponding code:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22542">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-04-create_instance_20250403092611.png" width="457" height="399" alt="Figure-04 create_instance">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>If the <code>Viewer</code> displays <code>Yes</code>, the functions can also be invoked from this instance directly within OleView.NET:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22545">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-05-OleView_20250403092728.png" width="605" height="434" alt="Figure-05 OleView">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>To view and modify the input parameters, simply double-click on the function of your choice:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22546">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-06-OleView_2_20250403092934.png" width="830" height="522" alt="Figure-06 OleView2">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>After entering your chosen arguments, click Invoke to execute the function with the provided input arguments. Did we just open an <code>.RDP</code> file in an <code>mstsc.exe</code> process?</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22547">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-07-RDP_file_20250403093214.png" width="998" height="498" alt="Figure-07 RDP_file">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>If this interface can be activated remotely and you have the necessary permissions, this could be considered a new DCOM code execution vector. An attacker could replace <code>C:\Windows\System32\mstsc.exe</code> with an arbitrary executable via <code>C$</code> from a remote location and launch it using this function. However, I would not recommend doing this in a real-world project, as removing or replacing built-in Windows binaries can always lead to disruption! Usually, all CLSIDs either spawn an executable on the remote system where the code is hosted, or load a DLL into existing processes such as for example <code>svchost.exe</code>. Therefore, replacement of executables is possible with many of them. The MSTSWebProxy class was just chosen here to demonstrate the overall process for an analysis.</p>
<p>But this approach looks simple in general, right? You should think again.</p>
<ol>
<li>There are more than 11,000 CLSIDs, and most of them have multiple IIDs. Taking this approach for all of them would take months.</li>
<li>In many cases, it is not possible to create an instance via the GUI; you need to invoke each CLSID/IID and their functions with custom code.</li>
<li>Often, the IIDs and their functions are not officially documented or visible at all. However, using the <code>View Proxy Definition</code> option when right-clicking on an IID will at least provide skeleton code showing how to call the function in many cases.</li>
</ol>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22552">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-08-View_Proxy_Definition_20250403094110.png" width="541" height="227" alt="Figure-08 View_Proxy_Definition">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<ol start="4">
<li>However, as each IID has a different definition, automating this approach to fuzz interfaces is complex.</li>
<li>Permissions are also important. In the best case, you might be able to spawn a process or control what is spawned with input parameters. However, if you cannot create an instance or invoke a function remotely, this cannot be used for Lateral Movement.</li>
<li>The blackbox/fuzzing approach is not sufficient. At some point you need to start reversing the code to find out what happens under the hood and to find code execution vectors.</li>
</ol>
<p>However, multiple companies have published research in recent years on upcoming DCOM lateral movement techniques, such as the following:</p>
<ul>
<li><a href="https://posts.specterops.io/lateral-movement-abuse-the-power-of-dcom-excel-application-3c016d0d9922" target="_blank" rel="noopener">https://posts.specterops.io/lateral-movement-abuse-the-power-of-dcom-excel-application-3c016d0d9922</a></li>
<li><a href="https://www.ibm.com/think/news/fileless-lateral-movement-trapped-com-objects" target="_blank" rel="noopener">https://www.ibm.com/think/news/fileless-lateral-movement-trapped-com-objects</a></li>
<li><a href="https://www.deepinstinct.com/blog/forget-psexec-dcom-upload-execute-backdoor" target="_blank" rel="noopener">https://www.deepinstinct.com/blog/forget-psexec-dcom-upload-execute-backdoor</a></li>
</ul>
<p>The complexity of these publications and the research behind it shows, that there is not many "low hanging fruits" in the field of DCOM Lateral Movement anymore, and that it is necessary to dig deeper into the exposed functions and consider what they are capable of and how they could be abused.</p>
<p>An alternative to exploiting COM object functionalities is to plant DLLs on the remote system so that they are loaded by the COM object hosting executable, as discussed in this <a href="https://www.mdsec.co.uk/2020/10/i-live-to-move-it-windows-lateral-movement-part-3-dll-hijacking/" target="_blank" rel="noopener">MDSec Blog Post</a>. Further executable/DLL combinations were later published <a href="https://github.com/WKL-Sec/dcomhijack" target="_blank" rel="noopener">here</a>. Finding new executable/DLL combinations is not a that complex task here and would lead to stealthier execution, especially if they had not been published before. However, execution using these public techniques will be done in the context of the user connecting to the remote system.</p>            </div>
</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung2">
<div class="container container__article">
<div class="row">
<div class="ce_text Kein Abstand - 0px bg-  block" id="lab">
<h2>2. Introduction in Cross Session Activation attacks</h2>
<div class="ce_text__content">
<p>When you search for <em>Cross Session Activation</em>, you'll find the official <a href="https://learn.microsoft.com/en-us/windows/win32/termserv/session-to-session-activation-with-a-session-moniker" target="_blank" rel="noopener">Microsoft documentation</a> about <em>Session-to-SessionA ctivation with a Session Moniker</em>. But even if you are allowed to create an instance in the session of another user, attacks are restricted to the exposed functionalities from the COM Class. So this is not what we are talking about here. Instead, most of the tools published and described later use the following Windows API combination to launch COM instances in the context of another user:</p>
<ol>
<li>Use <code>CoCreateInstance</code> to create a COM Object for the target class</li>
<li>Call <code>QueryInterface (ISpecialSystemProperties)</code> on the retrieved interface pointer</li>
<li>Set Session ID via <code>SetSessionId</code> on the retrieved <code>SpecialSystemProperties</code><br>(not documented by Microsoft anymore)</li>
<li>Call <code>StandardGetInstanceFromIStorage</code> on the interface pointer<br>(not documented by Microsoft anymore)</li>
</ol>
<p>The prerequisites for this technique to work are the following:</p>
<ol>
<li>The COM Class needs to be run as the <code>INTERACTIVE USER</code></li>
<li>Access and launch permissions need to be there for the launching user</li>
</ol>
<p>The last step can trigger NTLM/Kerberos authentication to an attacker defined host in the context of another user, which can be abused via cracking the <code>NetNTLMv2</code>/<code>NetNTLMv1</code> hash or for relaying purposes.</p>
<p>The NTLM reflection for local Privilege Escalation was originally found by James Forshaw in 2014 <a href="https://project-zero.issues.chromium.org/issues/42451808" target="_blank" rel="noopener">here</a>. Antonio Cocomazzi and Andrea Pierini created the first Proof of Concept tool Remotepotat0 and published their blog post <a href="https://www.sentinelone.com/labs/relaying-potatoes-another-unexpected-privilege-escalation-vulnerability-in-windows-rpc-protocol/" target="_blank" rel="noopener">Relaying Potatoes: Another Unexpected Privilege Escalation Vulnerability in Windows RPC Protocll</a> in 2021, which explains the abuse for scenarios where multiple users are logged on a system. James Forshaw one day later descibed in his Blogpost <a href="https://www.tiraniddo.dev/2021/04/standard-activating-yourself-to.html" target="_blank" rel="noopener">Standard Activating Yourself to Greatness</a> how to do the same for DCOM. For an more in depth explanation it's recommended to read these publications.</p>            </div>
</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung3">
<div class="container container__article">
<div class="row">
<div class="ce_text Gering - 30px bg-  block" id="lab">
<h2>3. Introducing Cross Session Activation DCOM Lateral Movement</h2>
<div class="ce_text__content">
<p>Until now, Cross-Session Activation attacks were mainly used for privilege escalation purposes, with publications and tools such as:</p>
<ul>
<li><a href="https://github.com/antonioCoco/RemotePotato0" target="_blank" rel="noopener">RemotePotat0</a></li>
<li><a href="https://blog.compass-security.com/2024/10/com-cross-session-activation/" target="_blank" rel="noopener">Chrome Updater EoP</a></li>
<li><a href="https://decoder.cloud/2024/08/02/the-fake-potato/" target="_blank" rel="noopener">Explorer EoP</a></li>
<li><a href="https://github.com/cube0x0/KrbRelay" target="_blank" rel="noopener">KrbRelay</a></li>
<li><a href="https://i.blackhat.com/Asia-24/Presentations/Asia-24-Ding-CertifiedDCOM-The-Privilege-Escalation-Journey-to-Domain-Admin.pdf" target="_blank" rel="noopener">CertifiedDCOM</a></li>
<li><a href="https://github.com/decoder-it/ADCSCoercePotato" target="_blank" rel="noopener">ADCSCoercePotato</a></li>
<li><a href="https://decoder.cloud/2024/04/24/hello-im-your-domain-admin-and-i-want-to-authenticate-against-you/" target="_blank" rel="noopener">Silverpotato</a></li>
<li><a href="https://github.com/CICADA8-Research/RemoteKrbRelay" target="_blank" rel="noopener">RemoteKrbRelay</a></li>
</ul>
<p>Whereas the first publications were all focussed on abusing Interactive authentication COM objects locally after authentication, the last four publications introduced the remote attack surface of Cross Session Activation attacks. A really good blogpost by my colleage Nico Viakowski describes which of these publications are still exploitable today:</p>
<p><a href="https://www.r-tec.net/r-tec-blog-windows-is-and-always-will-be-a-potatoland.html" target="_blank" rel="noopener">https://www.r-tec.net/r-tec-blog-windows-is-and-always-will-be-a-potatoland.html</a></p>
<p>My initial objective in this area of research was to identify a new CLSID that could be launched by a low-privileged user for privilege escalation purposes. Rather than manually checking all the COM object permissions, I took a brute-force approach using different Windows systems to see whether any incoming authentication could be triggered remotely with this simple Powershell script:</p>
<div style="color: #dadada; background-color: #1e1e1e; font-family: Droid Sans Mono for Powerline, Menlo, Monaco, 'Courier New', monospace, Menlo, Monaco, 'Courier New', monospace; font-weight: normal; font-size: 12px; line-height: 18px; white-space: pre; max-width: 800px; inline-size=800px; padding-left: 8px; overflow-wrap: break-word;"><br><span style="color: #57a64a;"># Get all CLSIDs from the system registry</span><br><span style="color: #b4b4b4;">$</span><span style="color: #9cdcfe;">clsidPath</span><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">=</span><span style="color: #d4d4d4;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">Registry::HKEY_CLASSES_ROOT\CLSID</span><span style="color: #e8c9bb;">"</span><br><span style="color: #b4b4b4;">$</span><span style="color: #9cdcfe;">clsids</span><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">=</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">Get-Childitem</span><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">-</span><span style="color: #d4d4d4;">Path </span><span style="color: #b4b4b4;">$</span><span style="color: #9cdcfe;">clsidPath</span><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">|</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">Select-Object</span><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">-</span><span style="color: #d4d4d4;">ExpandProperty PSChildName</span><br><br><span style="color: #57a64a;"># Loop through all of them</span><br><span style="color: #d8a0df;">foreach</span><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">($</span><span style="color: #9cdcfe;">clsid</span><span style="color: #d4d4d4;"> </span><span style="color: #d8a0df;">in</span><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">$</span><span style="color: #9cdcfe;">clsids</span><span style="color: #b4b4b4;">)</span><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">{</span><br><span style="color: #d4d4d4;"> </span><span style="color: #57a64a;"># Remove curly braces</span><br><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">$</span><span style="color: #9cdcfe;">cleanClsid</span><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">=</span><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">$</span><span style="color: #9cdcfe;">clsid</span><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">-replace</span><span style="color: #d4d4d4;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">[{}]</span><span style="color: #e8c9bb;">"</span><span style="color: #b4b4b4;">,</span><span style="color: #d4d4d4;"> </span><span style="color: #e8c9bb;">""</span><br><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">$</span><span style="color: #9cdcfe;">comand</span><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">=</span><span style="color: #d4d4d4;"> </span><span style="color: #e8c9bb;">"</span><span style="color: #ce9178;">RemoteKrbRelay.exe -victim srv01.domain -target srv02.domain -clsid <br></span><span style="color: #d4d4d4;"> </span><span style="color: #d4d4d4;"> </span><span style="color: #d4d4d4;"> </span><span style="color: #d4d4d4;"> </span><span style="color: #d4d4d4;"> </span><span style="color: #b4b4b4;">$</span><span style="color: #9cdcfe;">cleanClsid</span><span style="color: #ce9178;"> -session 1 -smb -console -v --smbkeyword interactive</span><span style="color: #e8c9bb;">"</span></div>
<div style="color: #dadada; background-color: #1e1e1e; font-family: Droid Sans Mono for Powerline, Menlo, Monaco, 'Courier New', monospace, Menlo, Monaco, 'Courier New', monospace; font-weight: normal; font-size: 12px; line-height: 18px; white-space: pre; max-width: 800px; inline-size=800px; padding-left: 8px; overflow-wrap: break-word;"><span style="color: #e8c9bb;"> iex($command)</span></div>
<div style="color: #dadada; background-color: #1e1e1e; font-family: Droid Sans Mono for Powerline, Menlo, Monaco, 'Courier New', monospace, Menlo, Monaco, 'Courier New', monospace; font-weight: normal; font-size: 12px; line-height: 18px; white-space: pre; max-width: 800px; inline-size=800px; padding-left: 8px; overflow-wrap: break-word;"><span style="color: #5c5c5c; font-family: '??', '??', ui-monospace, SFMono-Regular, 'Cascadia Mono', 'Roboto Mono', 'DejaVu Sans Mono', 'Liberation Mono', Menlo, Monaco, Consolas, 'Source Code Pro', monospace; font-size: 11.375px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; caret-color: #222222; white-space: pre-wrap; background-color: #fafafa; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">}</span><br><br></div>
<p>RemoteKrbRelay was the best tool of choice here, because it can trigger authentications from a remote systems session and also directly relay those to for example SMB if possible. But it turned out, that not a single CLSID could be abused here to trigger authentications from a low privileged users perspective.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22567">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Ehh_No.gif" width="220" height="220" alt="">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>I was wondering - what could an attacker with administrative privileges and Cross Session Activation do instead? In our projects, we often target specific systems with active sessions for Lateral Movement or Credential Theft. Imagine we have the following scenario and are one step ahead from getting domain administrator privileges:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22554">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-09-scenario_20250702095929.png" width="1214" height="765" alt="Figure-09 scenario">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>After executing code on that system, we typically run as SYSTEM or in the context of our own user account. This means that we usually need to dump credentials, impersonate the other user session, inject into one of its processes, or do whatever else is necessary to take over the targeted account. What if we had a lateral movement technique that allowed us to execute code in the context of an already-established interactive user session? Even better, what if we could do that via a lesser-known DCOM RPC call instead of using WMI, WinRM, or similar? These were the next goals of the research here!</p>
<p>Inspired by the tool <a href="https://github.com/CICADA8-Research/COMThanasia/tree/main/PermissionHunter/PermissionHunter" target="_blank" rel="noopener">PermissionHunter</a>, which has useful filter options, this was first used for the initial enumeration of potentially interesting target CLSIDs. We can easily filter the more than 11.000 CLSIDs to get a smaller list for this specific use case. We filter RunAs <em>Interactive User</em>, LaunchPrincipal <em>Everyone or Administrator or Empty</em>, RemoteActivation and Launch or empty, and obtain the following result:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22556">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-10-Interactive_User_20250403115133.png" width="1838" height="705" alt="Figure-10 Interactive_User">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>The result here was 86 unique CLSIDs - that's something we can work with! Why adding empty in the filter? If the LaunchPrincipal or other settings are not explicitly defined, COM will adhere to the default permissions, whereby Administrators can remotely launch or invoke the objects by default.</p>
<p>Instead of searching for code execution vectors directly, I tried getting the <code>NetNTLMv2</code> hashes from remotely logged in users first with the CLSIDs found. It turned out that this is indeed possible with administrative privileges, but public tools don't yet fully support this attack vector. I therefore slightly modified <em>potato.py</em> and <code>RemoteKrbRelay</code> via pull requests:</p>
<ul>
<li><a href="https://github.com/sploutchy/impacket/pull/3" target="_blank" rel="noopener">https://github.com/sploutchy/impacket/pull/3</a></li>
<li><a href="https://github.com/rtecCyberSec/RemoteKrbRelay/tree/ntlm" target="_blank" rel="noopener">https://github.com/rtecCyberSec/RemoteKrbRelay/tree/ntlm</a></li>
</ul>
<p>As IBM [published](https://www.ibm.com/think/x-force/remotemonologue-weaponizing-dcom-ntlm-authentication-coercions) a very similar technique in April - but had a <u>much cooler</u> implementation which also allows relaying and <code>NetNTLMv1</code> downgrade - those information were spontaneously published on Twitter before this blog post:</p>
<p><a href="https://x.com/ShitSecure/status/1909865929472639357" target="_blank" rel="noopener">https://x.com/ShitSecure/status/1909865929472639357</a></p>
<p><strong><u>Checking for code Execution instead</u></strong></p>
<p>In order to test for new CLSID/COM objects that can be invoked remotely for code execution, we need to prepare some tools. The tools I used were:</p>
<ul>
<li>OLEView .NET / <a href="https://github.com/tyranid/oleviewdotnet" target="_blank" rel="noopener">https://github.com/tyranid/oleviewdotnet</a></li>
<li>IDA Free / Ghidra</li>
<li>ProcessMonitor / <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/procmon" target="_blank" rel="noopener">https://learn.microsoft.com/en-us/sysinternals/downloads/procmon</a></li>
</ul>
<p>What was the initial approach for finding execution primitives?</p>
<ol>
<li>Finding the hosting binary or DLL for each CLSID.</li>
<li>Check the exposed IID's via OleViet.NET.</li>
<li>Throw the DLLs/Executables into IDA to check what the functions are doing.
<ol>
<li>Look for low hanging fruits such as <code>ShellExecuteW</code> or similar.</li>
</ol>
</li>
</ol>
<p>After many hours, lots of interesting functions had been found, but no direct code execution primitive. One CLSID stood out as the perfect candidate at first glance: <code>AB93B6F1-BE76-4185-A488-A9001B105B94</code>, the <code>BDEUILauncher class</code>. The code-hosting executable is <code>BdeUISrv.exe</code>, and when we checked the available functions, one stood out:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22558">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-11-Functions_20250403121747.png" width="410" height="144" alt="Figure-11 Functions">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>ProcessStart with <code>ushort</code> * as input argument?</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22569">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Exciting.gif" width="220" height="141" alt="">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>Upon examining what the function was doing, it appeared that this function was indeed spawning a new process:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22560">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-12-spawning_new_process_20250403122015.png" width="434" height="440" alt="Figure-12 spawning_new_process">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>At this point I reached out to my colleage <a href="https://x.com/eversinc33" target="_blank" rel="noopener">eversinc33</a>, as he had way more experience in reversing than myself to verify if this can be abused for code execution.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22571">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/MoreExciting.gif" width="220" height="159" alt="">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>When he joined the analysis, it quickly became clear that the first input parameter — an integer — determines which executable is spawned by <code>ShellExecuteW</code>. Unfortunately for us, this was not user-controlled, but one of four hardcoded executables.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22562">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-13-hardcoded_executables_20250403122440.png" width="788" height="496" alt="Figure-13 hardcoded_executables">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>As many hours of reversing different classes without success had passed we decided to step back and to think about alternatives to abusing existing functionalties from the COM classes.</p>
<h3>COM Hijacking for the win</h3>
<p>We already know, that when a COM object is invoked, it's <strong>executable is getting spawned</strong>, because it in the very end provides the code for our function. When using Cross Session Activation, we can spawn that process <strong>in the context of an already logged on user</strong>, right? And we can even specify the exact Session by ourself via Cross Session Activation.</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22573">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Thinking.gif" width="220" height="152" alt="">
</button>
</div>
</figure>

</div><div class="ce_text Gering - 30px bg-  block" id="tools">
<div class="ce_text__content">
<p>A recent read about <a href="https://www.blackhillsinfosec.com/a-different-take-on-dll-hijacking/" target="_blank" rel="noopener">COM Hijacking by Matthew Eidelberg</a> brought us the idea - we can COM hijack the remote registry of our target user, so that our newly spawned process will load a DLL of our choice. If you are not familiar with COM Hijacking already, this blog post is highly recommended to read!</p>
<p>After starting ProcessMonitor and setting up filters for our process, it was clear that this is indeed exploitable for the previously mentioned <code>BDEUILauncher Class</code>:</p>            </div>
</div><div class="ce_image Gering - 30px bg-  block">
<figure class="image_container">
<div style="position:relative;overflow:hidden;">
<button type="button" class="btn btn-link image-lightbox__show" data-toggle="modal" data-target="#image-modal-22564">
<img src="https://www.r-tec.net/files/content/img/News%2BEvents/Blog_Revisiting-Cross-Session-Activation-attacks/Figure-14-indeed_exploitable_20250403123338.png" width="1064" height="340" alt="Figure-14 indeed_exploitable">
</button>
</div>
</figure>

</div><div class="ce_text Kein Abstand - 0px bg-  block" id="tools">
<div class="ce_text__content">
<p>In this case if <code>BaaUpdate.exe</code> is spawned with two input parameters (and we can influence the input parameters via the <code>ushort </code>input parameter), it tries to load non existant CLSID entries from <code>HKCU</code>.</p>
<p>Weaponization from this point on was relatively straight forward:</p>
<ol>
<li>Plant a DLL on the target system via <code>C$</code> or <code>admin$</code></li>
<li>COM Hijack the target user via the Remote Registry</li>
<li>Execute <code>BaaUpdate.exe</code> via <code>BDEUILauncher Class</code> in the context of our target user</li>
<li>Remove the COM Hijack</li>
<li>Cleanup the DLL</li>
</ol>
<p>The PoC for this technique is published on our Github page <a href="https://github.com/rtecCyberSec/BitlockMove/" target="_blank" rel="noopener">BitlockMove</a>. This PoC has a few drawbacks:</p>
<ul>
<li><code>BDEUILauncher Class</code> is in the very end related to Bitlocker. BItlocker is mainly available on Clients. You can therefore only use this PoC to execute code on systems with Bitlocker available.</li>
<li>The DLL which will get dropped on the target system is hardcoded to execute user defined commands. This enables the Operator to define which exact process is getting spawned, but it OPSec wise not the best idea and easier to detect. Living in the newly spawned process would be stealthier from our perspective, so you need to bring your own DLL in the best case.</li>
</ul>
<p>It also turned out, that we did not need to use Cross Session Authentication by using <code>SetSessoinID</code> on <code>ISpecialSystemProperties</code>, as client systems usually always have only one active session. And even without explicitely specifying the target users session, the process will always be spawned in the context of the <code>Interactive User</code>, which is always the logged on user.</p>
<p>However, we found multiple more abusable CLSIDs in a short amount of time here, which also work on server systems and where setting the target users session is needed. Shortly after the BitlockMove publication AlmondOffsec published one alternative already with their tool release <a href="https://github.com/AlmondOffSec/DCOMRunAs" target="_blank" rel="noopener">DCOMRunas</a>.</p>
<p>Initially we wanted to leave the excercise to the reader to find more alternative CLSIDs. However to demonstrate how easy this technique can be adapted to many other CLSIDs which are configured to be run as <code>INTERACTIVE USER</code>, we are also releasing another PoC with this blog post, which also works on common Windows Server versions:</p>
<p><a href="https://github.com/rtecCyberSec/SpeechRuntimeMove" target="_blank" rel="noopener">https://github.com/rtecCyberSec/SpeechRuntimeMove</a></p>
<p>Whenever an instance of <code>38FE8DFE-B129-452B-A215-119382B89E3D - Speech Named Pipe COM</code> is created, <code>SpeechRuntimeBroker.exe</code> is spawned within the context of an active session defined by the attacker. As this is also vulnerable to COM Hijacking, we can load our malicious DLL into this process for Lateral Movement.</p>            </div>
</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung4">
<div class="container container__article">
<div class="row">
<div class="ce_text Kein Abstand - 0px bg-  block" id="lab">
<h2>4. Detection</h2>
<div class="ce_text__content">
<p>The following events can be seen when any of the released PoC's is executed:</p>
<ul>
<li>SMB Logon &amp; Share Access (Security 4624, Type 3 Logon &amp; Security 5140 Network Share Access)</li>
<li>COM Hijack (Security 4663 An attempt was made to access an object, Security 4657 A registry value was modified)</li>
<li>Process Creation (Security 4688 A new process has been created)</li>
</ul>
<p><u>Registry Key modifications:</u></p>
<ul>
<li>HKCU\SOFTWARE\Classes\CLSID\{896C2B1D-3586-4FA5-B419-41F4A6D38CF1}\InProcServer32 (BitLockMove)</li>
<li>HKCU\SOFTWARE\Classes\CLSID\{655D9BF9-3876-43D0-B6E8-C83C1224154C}\InProcServer32 (SpeechRuntimeMove)</li>
</ul>
<p><u>Suspicious child process is getting spawned + unexpected DLL load events:</u></p>
<ul>
<li><code>BaaUpdate.exe</code></li>
<li><code>SpeechRuntimeBroker.exe</code></li>
</ul>            </div>
</div>
</div>
</div>
</div>
<div class="mod_article color-Schwarz Kein Abstand - 0px bg- block" id="sprung5">
<div class="container container__article">
<div class="row">
<div class="ce_text Kein Abstand - 0px bg-  block" id="lab">
<h2>5. Conclusion</h2>
<div class="ce_text__content">
<p>Code can be executed on remote systems with administrative privileges via various techniques. However, many of the most well-known techniques and tools lead to alerts in monitored environments because of their IoCs, so they should not be used if detection is to be avoided.</p>
<p>Although DCOM Lateral Movement techniques have been well researched, new vectors are regularly published, as the attack surface here is huge and it is possible to dig deep.</p>
<p>Cross-Session Activation has mainly been used for privilege escalation purposes so far. However, with administrative privileges, it is also possible to execute code on a remote system in the context of an actively logged-in user. From an attacker's perspective, this also has the advantage that we can leave out IoCs for injection, impersonation or credential dumping, as we can directly execute code in the context of our target user.</p>
<p>COM Hijacking makes this new Lateral Movement vector easy to find and abuse, but can also get detected accurately with targeted rule sets.</p>            </div>
</div>
</div>
</div>
</div>
</div>
</main>
</div>

</div>






</body></html>