Title:
Abusing IDispatch for Trapped COM Object Access and Injecting into PPL Processes

Type:
Blog Post

Short Summary (4–8 sentences max):
- This write-up presents a C++ proof-of-concept that abuses a COM “bug class” (per James Forshaw’s Project Zero research) where IDispatch-enabled COM servers can be coerced into creating unintended/arbitrary objects across COM remoting boundaries.  
- The PoC targets the Windows Update Medic Service COM server (WaaSRemediationAgent) running inside a PPL-protected svchost.exe (PsProtectedSignerWindows-Light) to execute attacker-controlled .NET code.  
- It uses registry-based COM redirection (TreatAs) plus enabling .NET DCOM reflection to make a legacy COM class (StdFont) instantiate as a managed System.Object, bridging native COM activation into the CLR.  
- The payload is loaded via mscorlib reflection (Assembly.Load(byte[])) to achieve in-memory execution, bypassing PPL’s SEC_IMAGE signature enforcement because no image section is created.  
- The post also includes a lightweight memory forensics workflow (WinDbg/CLR extensions) to spot the injected assembly in AppDomains and memory regions, plus example detection ideas (registry change + clr.dll load in WaaSMedicSvc svchost).  
- Useful for red teamers and security researchers studying PPL bypasses, COM/CLR interop abuse, and defenders building telemetry around COM registry hijacks and unexpected CLR hosting in protected services.

Technical Focus:
- COM Automation abuse via IDispatch / ITypeInfo / type libraries (stdole32.tlb)
- COM registry hijacking (TreatAs), DCOM reflection, OnlyUseLatestCLR
- COM-to-.NET interop using mscorlib (System.Object, System.Type, System.Reflection)
- In-memory .NET assembly loading (Assembly.Load(byte[]), SAFEARRAY/VARIANT marshaling)
- PPL / Code Integrity bypass mechanics (SEC_IMAGE, NtCreateSection implications)
- Memory analysis & debugging of CLR in PPL processes (WinDbg, !dumpdomain, !clrstack)

Use Cases:
- Execute unsigned managed payloads inside PsProtectedSignerWindows-Light PPL processes (e.g., WaaSMedicSvc svchost)
- Post-exploitation access to protected targets (e.g., LSASS with LSA protection) from a higher-signer PPL context
- Research and validation of COM “trapped object” / IDispatch bug class exploitation paths
- Build detections for COM TreatAs abuse and unexpected CLR loading in protected Windows services
- Incident response triage of fileless .NET payloads resident in memory/AppDomains

Keywords:
COM, IDispatch, ITypeInfo, ITypeLib, stdole32.tlb, StdFont, TreatAs, DCOM Reflection, AllowDCOMReflection, OnlyUseLatestCLR, mscorlib, CLR, System.Reflection, Assembly.Load, SAFEARRAY, VARIANT, WaaSRemediationAgent, WaaSMedicSvc, svchost.exe, Protected Process Light, PsProtectedSignerWindows-Light, LSASS, SEC_IMAGE, NtCreateSection, WinDbg, !dumpdomain, !clrstack